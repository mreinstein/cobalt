var fn=Object.defineProperty;var be=(e,t)=>{for(var a in t)fn(e,a,{get:t[a],enumerable:!0})};function zt(e,t,a,p,v,d,M){let A=e.createTexture({label:t,size:{width:a,height:p},format:d,usage:M,mipLevelCount:v,sampleCount:1,dimension:"2d"}),G=A.createView(),P=[];for(let O=0;O<v;O++)P.push(A.createView({label:t,format:d,dimension:"2d",aspect:"all",baseMipLevel:O,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let E=e.createSampler({label:`${t} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:a,height:p},texture:A,view:G,mip_view:P,sampler:E}}async function Vt(e,t,a,p="rgba8unorm"){let d=await(await fetch(a)).blob(),M=await createImageBitmap(d),A=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,P=zt(e.device,t,M.width,M.height,1,p,A);e.device.queue.copyExternalImageToTexture({source:M},{texture:P.texture},{width:M.width,height:M.height});let E={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return P.sampler=e.device.createSampler(E),P}function Wt(e,t,a,p="rgba8unorm"){let v=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,M=zt(e.device,t,a.width,a.height,1,p,v);e.device.queue.writeTexture({texture:M.texture},a.data,{bytesPerRow:4*a.width},{width:a.width,height:a.height});let A={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return M.sampler=e.device.createSampler(A),M}var _e="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var Ot=7,pn=0,Me=1,dn=2,Se=3,Te={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(e,t={}){return mn(e,t)},onRun:function(e,t,a){vn(e,t.data,a)},onDestroy:function(e,t){Ge(t)},onResize:function(e,t){xn(e,t)},onViewportPosition:function(e,t){}};function mn(e,t){let{device:a}=e,p=e.viewport.width,v=e.viewport.height,d={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},M=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});d.bind_group_layout.push(M),d.bind_groups_textures.push(zt(a,"bloom downsampler image 0",p/2,v/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),d.bind_groups_textures.push(zt(a,"bloom downsampler image 1",p/2,v/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),d.bind_groups_textures.push(t.refs.bloom.data);let A=a.createPipelineLayout({bindGroupLayouts:d.bind_group_layout}),G=a.createComputePipeline({layout:A,compute:{module:a.createShaderModule({code:_e}),entryPoint:"cs_main"}});return De(e,d,t),d.compute_pipeline=G,d}function De(e,t,a){let{refs:p}=a,{device:v}=e,d=a.options.bloom_threshold??.1,M=a.options.bloom_knee??.2,A=a.options.bloom_combine_constant??.68,G=new Float32Array([d,d-M,M*2,.25/M,A,0,0,0]),P=v.createBuffer({label:"bloom static parameters buffer",size:G.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(P.getMappedRange()).set(G),P.unmap(),t.bind_group.length=0,t.params_buf=P,t.bind_group.push(Yt(v,t,t.bind_groups_textures[0].mip_view[0],p.emissive.data.view,p.hdr.data.view,p.hdr.data.sampler,P,pn<<16|0));for(let O=1;O<Ot;O++)t.bind_group.push(Yt(v,t,t.bind_groups_textures[1].mip_view[O],t.bind_groups_textures[0].view,p.hdr.data.view,p.hdr.data.sampler,P,Me<<16|O-1)),t.bind_group.push(Yt(v,t,t.bind_groups_textures[0].mip_view[O],t.bind_groups_textures[1].view,p.hdr.data.view,p.hdr.data.sampler,P,Me<<16|O));t.bind_group.push(Yt(v,t,t.bind_groups_textures[2].mip_view[Ot-1],t.bind_groups_textures[0].view,p.hdr.data.view,p.hdr.data.sampler,P,dn<<16|Ot-2));let E=!0;for(let O=Ot-2;O>=0;O--)E?(t.bind_group.push(Yt(v,t,t.bind_groups_textures[1].mip_view[O],t.bind_groups_textures[0].view,t.bind_groups_textures[2].view,p.hdr.data.sampler,P,Se<<16|O)),E=!1):(t.bind_group.push(Yt(v,t,t.bind_groups_textures[2].mip_view[O],t.bind_groups_textures[0].view,t.bind_groups_textures[1].view,p.hdr.data.sampler,P,Se<<16|O)),E=!0)}function Yt(e,t,a,p,v,d,M,A){let G=new Uint32Array([A]),P=e.createBuffer({label:"bloom static mode_lod buffer",size:G.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(P.getMappedRange()).set(G),P.unmap(),e.createBindGroup({label:"bloom bind group layout",layout:t.bind_group_layout[0],entries:[{binding:0,resource:a},{binding:1,resource:p},{binding:2,resource:v},{binding:3,resource:d},{binding:4,resource:{buffer:M}},{binding:5,resource:{buffer:P}}]})}function vn(e,t,a){let A=0,G=a.beginComputePass({label:"bloom Compute Pass"});G.setPipeline(t.compute_pipeline),G.setBindGroup(0,t.bind_group[A]),A+=1;let P=ne(0,t.bind_groups_textures[0]);G.dispatchWorkgroups(P.width/8+1,P.height/4+1,1);for(let E=1;E<Ot;E++)P=ne(E,t.bind_groups_textures[0]),G.setBindGroup(0,t.bind_group[A]),A+=1,G.dispatchWorkgroups(P.width/8+1,P.height/4+1,1),G.setBindGroup(0,t.bind_group[A]),A+=1,G.dispatchWorkgroups(P.width/8+1,P.height/4+1,1);G.setBindGroup(0,t.bind_group[A]),A+=1,P=ne(Ot-1,t.bind_groups_textures[2]),G.dispatchWorkgroups(P.width/8+1,P.height/4+1,1);for(let E=Ot-2;E>=0;E--)P=ne(E,t.bind_groups_textures[2]),G.setBindGroup(0,t.bind_group[A]),A+=1,G.dispatchWorkgroups(P.width/8+1,P.height/4+1,1);G.end()}function ne(e,t){let a=t.size.width,p=t.size.height;for(let v=0;v<e;v++)a/=2,p/=2;return{width:a,height:p,depthOrArrayLayers:1}}function xn(e,t){let{device:a}=e,p=t.data;Ge(p),p.bind_groups_textures.push(zt(a,"bloom downsampler image 0",e.viewport.width/2,e.viewport.height/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),p.bind_groups_textures.push(zt(a,"bloom downsampler image 1",e.viewport.width/2,e.viewport.height/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),p.bind_groups_textures.push(t.refs.bloom.data),De(e,p,t)}function Ge(e){for(let t of e.bind_groups_textures)t.texture.destroy();e.bind_groups_textures.length=0}var re="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Ee={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return gn(e,t)},onRun:function(e,t,a){yn(e,t,a)},onDestroy:function(e,t){},onResize:function(e,t){hn(e,t)},onViewportPosition:function(e,t){}};function gn(e,t){let{options:a,refs:p}=t,{device:v}=e,d=Be(e),M=a.bloom_intensity??40,A=a.bloom_combine_constant??.68,G=new Float32Array([M,A]),P=v.createBuffer({label:"scene composite params buffer",size:G.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(P.getMappedRange()).set(G),P.unmap();let E=v.createRenderPipeline({layout:"auto",vertex:{module:v.createShaderModule({code:re}),entryPoint:"vert_main"},fragment:{module:v.createShaderModule({code:re}),entryPoint:"frag_main",targets:[{format:d}]},primitive:{topology:"triangle-list"}});return{bindGroup:v.createBindGroup({layout:E.getBindGroupLayout(0),entries:[{binding:0,resource:p.hdr.data.sampler},{binding:1,resource:p.hdr.data.view},{binding:2,resource:p.bloom.data.mip_view[0]},{binding:3,resource:{buffer:P}}]}),pipeline:E,params_buf:P}}function yn(e,t,a){let p=a.beginRenderPass({colorAttachments:[{view:t.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:v,bindGroup:d}=t.data;p.setPipeline(v),p.setBindGroup(0,d),p.draw(3),p.end()}function hn(e,t){let{pipeline:a,params_buf:p}=t.data,{device:v}=e;t.data.bindGroup=v.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:t.refs.hdr.data.sampler},{binding:1,resource:t.refs.hdr.data.view},{binding:2,resource:t.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:p}}]})}var Ht={};be(Ht,{addSprite:()=>_n,clear:()=>Sn,removeSprite:()=>Mn,setSprite:()=>zn,setSpriteName:()=>Tn,setSpriteOpacity:()=>En,setSpritePosition:()=>Dn,setSpriteRotation:()=>Bn,setSpriteTint:()=>Gn});function se(e,t,a){if(a.spriteCount===0)return 0;let p=0,v=a.spriteCount-1,d=e<<16&16711680|t&65535;for(;p<=v;){let M=a.spriteData[p*12+11];if(d<=M)return p;let A=a.spriteData[v*12+11];if(d>=A)return v+1;let G=Math.floor((p+v)/2),P=a.spriteData[G*12+11];if(d===P)return G+1;d>P?p=G+1:v=G-1}return p}function Ct(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function _n(e,t,a,p,v,d,M,A,G){let P=t.refs.spritesheet.data.spritesheet;t=t.data;let E=P.locations.indexOf(a),O=se(G,E,t),Z=(O+1)*12;t.spriteData.set(t.spriteData.subarray(O*12,t.spriteCount*12),Z),ze(t,P,O,a,p,v,d,M,A,G);for(let[$,R]of t.spriteIndices)R>=O&&t.spriteIndices.set($,R+1);let W=Ct();return t.spriteIndices.set(W,O),t.spriteCount++,t.dirty=!0,W}function Mn(e,t,a){t=t.data;let p=t.spriteIndices.get(a);for(let[d,M]of t.spriteIndices)M>p&&t.spriteIndices.set(d,M-1);let v=p*12;t.spriteData.set(t.spriteData.subarray((p+1)*12,t.spriteCount*12),v),t.spriteIndices.delete(a),t.spriteCount--,t.dirty=!0}function Sn(e,t){t=t.data,t.spriteIndices.clear(),t.spriteCount=0,t.instancedDrawCallCount=0,t.dirty=!0}function Tn(e,t,a,p,v){let d=t.refs.spritesheet.data.spritesheet;t=t.data;let M=d.locations.indexOf(p),A=d.spriteMeta[p].w,G=d.spriteMeta[p].h,E=t.spriteIndices.get(a)*12;t.spriteData[E+2]=A*v[0],t.spriteData[E+3]=G*v[1];let Z=(t.spriteData[E+11]>>16&255)<<16&16711680|M&65535;t.spriteData[E+11]=Z,t.dirty=!0}function Dn(e,t,a,p){t=t.data;let d=t.spriteIndices.get(a)*12;t.spriteData[d]=p[0],t.spriteData[d+1]=p[1],t.dirty=!0}function Gn(e,t,a,p){t=t.data;let d=t.spriteIndices.get(a)*12;t.spriteData[d+4]=p[0],t.spriteData[d+5]=p[1],t.spriteData[d+6]=p[2],t.spriteData[d+7]=p[3],t.dirty=!0}function En(e,t,a,p){t=t.data;let d=t.spriteIndices.get(a)*12;t.spriteData[d+8]=p,t.dirty=!0}function Bn(e,t,a,p){t=t.data;let d=t.spriteIndices.get(a)*12;t.spriteData[d+9]=p,t.dirty=!0}function zn(e,t,a,p,v,d,M,A,G,P){let E=t.refs.spritesheet.data.spritesheet;t=t.data;let O=t.spriteIndices.get(a);ze(t,E,O,p,v,d,M,A,G,P),t.dirty=!0}function ze(e,t,a,p,v,d,M,A,G,P){if(!t.spriteMeta[p])throw new Error(`Sprite name ${p} could not be found in the spritesheet metaData`);let E=a*12,O=t.spriteMeta[p].w,Z=t.spriteMeta[p].h,W=t.locations.indexOf(p),$=P<<16&16711680|W&65535;e.spriteData[E]=v[0],e.spriteData[E+1]=v[1],e.spriteData[E+2]=O*d[0],e.spriteData[E+3]=Z*d[1],e.spriteData[E+4]=M[0],e.spriteData[E+5]=M[1],e.spriteData[E+6]=M[2],e.spriteData[E+7]=M[3],e.spriteData[E+8]=A,e.spriteData[E+9]=G,e.spriteData[E+11]=$}var Ue={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return Un(e,t)},onRun:function(e,t,a){Fn(e,t,a)},onDestroy:function(e,t){An(t)},onResize:function(e,t){},onViewportPosition:function(e,t){},customFunctions:{...Ht}};async function Un(e,t){let{device:a}=e,p=16192,v=p,M=Float32Array.BYTES_PER_ELEMENT*2,G=Float32Array.BYTES_PER_ELEMENT*2,E=Float32Array.BYTES_PER_ELEMENT*4,Z=Float32Array.BYTES_PER_ELEMENT*4,W=a.createBuffer({size:(M+G+E+Z)*v,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),$=t.refs.spritesheet.data,R=a.createBindGroup({layout:t.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:$.uniformBuffer}},{binding:1,resource:$.colorTexture.view},{binding:2,resource:$.colorTexture.sampler},{binding:3,resource:{buffer:W}},{binding:4,resource:$.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(p*2),instancedDrawCallCount:0,bindGroup:R,spriteBuffer:W,spriteData:new Float32Array(p*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Fn(e,t,a){let{device:p}=e,v=t.options.loadOp||"load";t.data.dirty&&(Pn(t.data),t.data.dirty=!1),p.queue.writeBuffer(t.data.spriteBuffer,0,t.data.spriteData.buffer);let d=a.beginRenderPass({colorAttachments:[{view:t.refs.hdr.data.view,clearValue:e.clearValue,loadOp:v,storeOp:"store"},{view:t.refs.emissive.data.view,clearValue:e.clearValue,loadOp:"clear",storeOp:"store"}]});d.setPipeline(t.refs.spritesheet.data.pipeline),d.setBindGroup(0,t.data.bindGroup),d.setVertexBuffer(0,t.refs.spritesheet.data.quads.buffer);let M=6,A=0;for(let G=0;G<t.data.instancedDrawCallCount;G++){let P=t.data.instancedDrawCalls[G*2]*M,E=t.data.instancedDrawCalls[G*2+1];d.draw(M,E,P,A),A+=E}d.end()}function Pn(e){let t=-1,a=0;e.instancedDrawCallCount=0;for(let p=0;p<e.spriteCount;p++){let v=e.spriteData[p*12+11]&65535;v!==t&&(a>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=a,e.instancedDrawCallCount++),t=v,a=0),a++}a>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=a,e.instancedDrawCallCount++)}function An(e){e.data.instancedDrawCalls=null,e.data.bindGroup=null,e.data.spriteBuffer.destroy(),e.data.spriteBuffer=null,e.data.spriteData=null,e.data.spriteIndices.clear(),e.data.spriteIndices=null}var Pe={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return In(e,t)},onRun:function(e,t,a){Rn(e,t,a)},onDestroy:function(e,t){Fe(t)},onResize:function(e,t){},onViewportPosition:function(e,t){},customFunctions:{setTexture:async function(e,t,a){let{device:p}=e;Fe(t),t.options.textureUrl=a;let v=await Vt(e,"tile map",t.options.textureUrl),d=p.createBindGroup({layout:t.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:t.data.uniformBuffer}},{binding:1,resource:v.view},{binding:2,resource:v.sampler}]});t.data.bindGroup=d,t.data.material=v}}};async function In(e,t){let{device:a}=e,p=await Vt(e,"tile map",t.options.textureUrl),v=new Float32Array([t.options.scrollScale,t.options.scrollScale]),d=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,M={size:v.byteLength,usage:d,mappedAtCreation:!0},A=a.createBuffer(M);return new Float32Array(A.getMappedRange()).set(v),A.unmap(),{bindGroup:a.createBindGroup({layout:t.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:A}},{binding:1,resource:p.view},{binding:2,resource:p.sampler}]}),material:p,uniformBuffer:A,scrollScale:t.options.scrollScale}}function Rn(e,t,a){let{device:p}=e,v=t.options.loadOp||"load",d=a.beginRenderPass({colorAttachments:[{view:t.refs.hdr.data.view,clearValue:e.clearValue,loadOp:v,storeOp:"store"}]}),M=t.refs.tileAtlas.data;d.setPipeline(M.pipeline),d.setBindGroup(0,t.data.bindGroup),d.setBindGroup(1,M.atlasBindGroup),d.draw(3),d.end()}function Fe(e){e.data.material.texture.destroy(),e.data.material.texture=void 0}var ie="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct displacement_param{offset:vec2<f32>,scale:f32,noop:f32};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:displacement_param;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const sx:f32=1.0;const sy:f32=1.0;const sz:f32=1.0;const tx:f32=1.0;const ty:f32=1.0;const tz:f32=0;const rot:f32=0.0;const s=sin(rot);const c=cos(rot);const scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);const modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";function Vn(e,t){return class extends e{constructor(...a){super(...a),t(this)}}}var Nn=Vn(Array,e=>e.fill(0)),K=1e-6;function qn(e){function t(n=0,i=0){let o=new e(2);return n!==void 0&&(o[0]=n,i!==void 0&&(o[1]=i)),o}let a=t;function p(n,i,o){let r=o??new e(2);return r[0]=n,r[1]=i,r}function v(n,i){let o=i??new e(2);return o[0]=Math.ceil(n[0]),o[1]=Math.ceil(n[1]),o}function d(n,i){let o=i??new e(2);return o[0]=Math.floor(n[0]),o[1]=Math.floor(n[1]),o}function M(n,i){let o=i??new e(2);return o[0]=Math.round(n[0]),o[1]=Math.round(n[1]),o}function A(n,i=0,o=1,r){let l=r??new e(2);return l[0]=Math.min(o,Math.max(i,n[0])),l[1]=Math.min(o,Math.max(i,n[1])),l}function G(n,i,o){let r=o??new e(2);return r[0]=n[0]+i[0],r[1]=n[1]+i[1],r}function P(n,i,o,r){let l=r??new e(2);return l[0]=n[0]+i[0]*o,l[1]=n[1]+i[1]*o,l}function E(n,i){let o=n[0],r=n[1],l=i[0],h=i[1],D=Math.sqrt(o*o+r*r),s=Math.sqrt(l*l+h*h),f=D*s,w=f&&Ut(n,i)/f;return Math.acos(w)}function O(n,i,o){let r=o??new e(2);return r[0]=n[0]-i[0],r[1]=n[1]-i[1],r}let Z=O;function W(n,i){return Math.abs(n[0]-i[0])<K&&Math.abs(n[1]-i[1])<K}function $(n,i){return n[0]===i[0]&&n[1]===i[1]}function R(n,i,o,r){let l=r??new e(2);return l[0]=n[0]+o*(i[0]-n[0]),l[1]=n[1]+o*(i[1]-n[1]),l}function it(n,i,o,r){let l=r??new e(2);return l[0]=n[0]+o[0]*(i[0]-n[0]),l[1]=n[1]+o[1]*(i[1]-n[1]),l}function k(n,i,o){let r=o??new e(2);return r[0]=Math.max(n[0],i[0]),r[1]=Math.max(n[1],i[1]),r}function ct(n,i,o){let r=o??new e(2);return r[0]=Math.min(n[0],i[0]),r[1]=Math.min(n[1],i[1]),r}function ut(n,i,o){let r=o??new e(2);return r[0]=n[0]*i,r[1]=n[1]*i,r}let wt=ut;function dt(n,i,o){let r=o??new e(2);return r[0]=n[0]/i,r[1]=n[1]/i,r}function mt(n,i){let o=i??new e(2);return o[0]=1/n[0],o[1]=1/n[1],o}let St=mt;function Tt(n,i,o){let r=o??new e(3),l=n[0]*i[1]-n[1]*i[0];return r[0]=0,r[1]=0,r[2]=l,r}function Ut(n,i){return n[0]*i[0]+n[1]*i[1]}function vt(n){let i=n[0],o=n[1];return Math.sqrt(i*i+o*o)}let Lt=vt;function ot(n){let i=n[0],o=n[1];return i*i+o*o}let st=ot;function tt(n,i){let o=n[0]-i[0],r=n[1]-i[1];return Math.sqrt(o*o+r*r)}let x=tt;function F(n,i){let o=n[0]-i[0],r=n[1]-i[1];return o*o+r*r}let _=F;function z(n,i){let o=i??new e(2),r=n[0],l=n[1],h=Math.sqrt(r*r+l*l);return h>1e-5?(o[0]=r/h,o[1]=l/h):(o[0]=0,o[1]=0),o}function q(n,i){let o=i??new e(2);return o[0]=-n[0],o[1]=-n[1],o}function L(n,i){let o=i??new e(2);return o[0]=n[0],o[1]=n[1],o}let j=L;function Q(n,i,o){let r=o??new e(2);return r[0]=n[0]*i[0],r[1]=n[1]*i[1],r}let et=Q;function Y(n,i,o){let r=o??new e(2);return r[0]=n[0]/i[0],r[1]=n[1]/i[1],r}let X=Y;function rt(n=1,i){let o=i??new e(2),r=Math.random()*2*Math.PI;return o[0]=Math.cos(r)*n,o[1]=Math.sin(r)*n,o}function b(n){let i=n??new e(2);return i[0]=0,i[1]=0,i}function U(n,i,o){let r=o??new e(2),l=n[0],h=n[1];return r[0]=l*i[0]+h*i[4]+i[12],r[1]=l*i[1]+h*i[5]+i[13],r}function c(n,i,o){let r=o??new e(2),l=n[0],h=n[1];return r[0]=i[0]*l+i[4]*h+i[8],r[1]=i[1]*l+i[5]*h+i[9],r}function u(n,i,o,r){let l=r??new e(2),h=n[0]-i[0],D=n[1]-i[1],s=Math.sin(o),f=Math.cos(o);return l[0]=h*f-D*s+i[0],l[1]=h*s+D*f+i[1],l}function m(n,i,o){let r=o??new e(2);return z(n,r),ut(r,i,r)}function y(n,i,o){let r=o??new e(2);return vt(n)>i?m(n,i,r):L(n,r)}function I(n,i,o){let r=o??new e(2);return R(n,i,.5,r)}return{create:t,fromValues:a,set:p,ceil:v,floor:d,round:M,clamp:A,add:G,addScaled:P,angle:E,subtract:O,sub:Z,equalsApproximately:W,equals:$,lerp:R,lerpV:it,max:k,min:ct,mulScalar:ut,scale:wt,divScalar:dt,inverse:mt,invert:St,cross:Tt,dot:Ut,length:vt,len:Lt,lengthSq:ot,lenSq:st,distance:tt,dist:x,distanceSq:F,distSq:_,normalize:z,negate:q,copy:L,clone:j,multiply:Q,mul:et,divide:Y,div:X,random:rt,zero:b,transformMat4:U,transformMat3:c,rotate:u,setLength:m,truncate:y,midpoint:I}}var Ae=new Map;function Ne(e){let t=Ae.get(e);return t||(t=qn(e),Ae.set(e,t)),t}function Cn(e){let t=Ne(e);function a(x,F,_,z,q,L,j,Q,et){let Y=new e(12);return Y[3]=0,Y[7]=0,Y[11]=0,x!==void 0&&(Y[0]=x,F!==void 0&&(Y[1]=F,_!==void 0&&(Y[2]=_,z!==void 0&&(Y[4]=z,q!==void 0&&(Y[5]=q,L!==void 0&&(Y[6]=L,j!==void 0&&(Y[8]=j,Q!==void 0&&(Y[9]=Q,et!==void 0&&(Y[10]=et))))))))),Y}function p(x,F,_,z,q,L,j,Q,et,Y){let X=Y??new e(12);return X[0]=x,X[1]=F,X[2]=_,X[3]=0,X[4]=z,X[5]=q,X[6]=L,X[7]=0,X[8]=j,X[9]=Q,X[10]=et,X[11]=0,X}function v(x,F){let _=F??new e(12);return _[0]=x[0],_[1]=x[1],_[2]=x[2],_[3]=0,_[4]=x[4],_[5]=x[5],_[6]=x[6],_[7]=0,_[8]=x[8],_[9]=x[9],_[10]=x[10],_[11]=0,_}function d(x,F){let _=F??new e(12),z=x[0],q=x[1],L=x[2],j=x[3],Q=z+z,et=q+q,Y=L+L,X=z*Q,rt=q*Q,b=q*et,U=L*Q,c=L*et,u=L*Y,m=j*Q,y=j*et,I=j*Y;return _[0]=1-b-u,_[1]=rt+I,_[2]=U-y,_[3]=0,_[4]=rt-I,_[5]=1-X-u,_[6]=c+m,_[7]=0,_[8]=U+y,_[9]=c-m,_[10]=1-X-b,_[11]=0,_}function M(x,F){let _=F??new e(12);return _[0]=-x[0],_[1]=-x[1],_[2]=-x[2],_[4]=-x[4],_[5]=-x[5],_[6]=-x[6],_[8]=-x[8],_[9]=-x[9],_[10]=-x[10],_}function A(x,F){let _=F??new e(12);return _[0]=x[0],_[1]=x[1],_[2]=x[2],_[4]=x[4],_[5]=x[5],_[6]=x[6],_[8]=x[8],_[9]=x[9],_[10]=x[10],_}let G=A;function P(x,F){return Math.abs(x[0]-F[0])<K&&Math.abs(x[1]-F[1])<K&&Math.abs(x[2]-F[2])<K&&Math.abs(x[4]-F[4])<K&&Math.abs(x[5]-F[5])<K&&Math.abs(x[6]-F[6])<K&&Math.abs(x[8]-F[8])<K&&Math.abs(x[9]-F[9])<K&&Math.abs(x[10]-F[10])<K}function E(x,F){return x[0]===F[0]&&x[1]===F[1]&&x[2]===F[2]&&x[4]===F[4]&&x[5]===F[5]&&x[6]===F[6]&&x[8]===F[8]&&x[9]===F[9]&&x[10]===F[10]}function O(x){let F=x??new e(12);return F[0]=1,F[1]=0,F[2]=0,F[4]=0,F[5]=1,F[6]=0,F[8]=0,F[9]=0,F[10]=1,F}function Z(x,F){let _=F??new e(12);if(_===x){let b;return b=x[1],x[1]=x[4],x[4]=b,b=x[2],x[2]=x[8],x[8]=b,b=x[6],x[6]=x[9],x[9]=b,_}let z=x[0*4+0],q=x[0*4+1],L=x[0*4+2],j=x[1*4+0],Q=x[1*4+1],et=x[1*4+2],Y=x[2*4+0],X=x[2*4+1],rt=x[2*4+2];return _[0]=z,_[1]=j,_[2]=Y,_[4]=q,_[5]=Q,_[6]=X,_[8]=L,_[9]=et,_[10]=rt,_}function W(x,F){let _=F??new e(12),z=x[0*4+0],q=x[0*4+1],L=x[0*4+2],j=x[1*4+0],Q=x[1*4+1],et=x[1*4+2],Y=x[2*4+0],X=x[2*4+1],rt=x[2*4+2],b=rt*Q-et*X,U=-rt*j+et*Y,c=X*j-Q*Y,u=1/(z*b+q*U+L*c);return _[0]=b*u,_[1]=(-rt*q+L*X)*u,_[2]=(et*q-L*Q)*u,_[4]=U*u,_[5]=(rt*z-L*Y)*u,_[6]=(-et*z+L*j)*u,_[8]=c*u,_[9]=(-X*z+q*Y)*u,_[10]=(Q*z-q*j)*u,_}function $(x){let F=x[0],_=x[0*4+1],z=x[0*4+2],q=x[1*4+0],L=x[1*4+1],j=x[1*4+2],Q=x[2*4+0],et=x[2*4+1],Y=x[2*4+2];return F*(L*Y-et*j)-q*(_*Y-et*z)+Q*(_*j-L*z)}let R=W;function it(x,F,_){let z=_??new e(12),q=x[0],L=x[1],j=x[2],Q=x[4],et=x[5],Y=x[6],X=x[8],rt=x[9],b=x[10],U=F[0],c=F[1],u=F[2],m=F[4],y=F[5],I=F[6],n=F[8],i=F[9],o=F[10];return z[0]=q*U+Q*c+X*u,z[1]=L*U+et*c+rt*u,z[2]=j*U+Y*c+b*u,z[4]=q*m+Q*y+X*I,z[5]=L*m+et*y+rt*I,z[6]=j*m+Y*y+b*I,z[8]=q*n+Q*i+X*o,z[9]=L*n+et*i+rt*o,z[10]=j*n+Y*i+b*o,z}let k=it;function ct(x,F,_){let z=_??O();return x!==z&&(z[0]=x[0],z[1]=x[1],z[2]=x[2],z[4]=x[4],z[5]=x[5],z[6]=x[6]),z[8]=F[0],z[9]=F[1],z[10]=1,z}function ut(x,F){let _=F??t.create();return _[0]=x[8],_[1]=x[9],_}function wt(x,F,_){let z=_??t.create(),q=F*4;return z[0]=x[q+0],z[1]=x[q+1],z}function dt(x,F,_,z){let q=z===x?x:A(x,z),L=_*4;return q[L+0]=F[0],q[L+1]=F[1],q}function mt(x,F){let _=F??t.create(),z=x[0],q=x[1],L=x[4],j=x[5];return _[0]=Math.sqrt(z*z+q*q),_[1]=Math.sqrt(L*L+j*j),_}function St(x,F){let _=F??new e(12);return _[0]=1,_[1]=0,_[2]=0,_[4]=0,_[5]=1,_[6]=0,_[8]=x[0],_[9]=x[1],_[10]=1,_}function Tt(x,F,_){let z=_??new e(12),q=F[0],L=F[1],j=x[0],Q=x[1],et=x[2],Y=x[1*4+0],X=x[1*4+1],rt=x[1*4+2],b=x[2*4+0],U=x[2*4+1],c=x[2*4+2];return x!==z&&(z[0]=j,z[1]=Q,z[2]=et,z[4]=Y,z[5]=X,z[6]=rt),z[8]=j*q+Y*L+b,z[9]=Q*q+X*L+U,z[10]=et*q+rt*L+c,z}function Ut(x,F){let _=F??new e(12),z=Math.cos(x),q=Math.sin(x);return _[0]=z,_[1]=q,_[2]=0,_[4]=-q,_[5]=z,_[6]=0,_[8]=0,_[9]=0,_[10]=1,_}function vt(x,F,_){let z=_??new e(12),q=x[0*4+0],L=x[0*4+1],j=x[0*4+2],Q=x[1*4+0],et=x[1*4+1],Y=x[1*4+2],X=Math.cos(F),rt=Math.sin(F);return z[0]=X*q+rt*Q,z[1]=X*L+rt*et,z[2]=X*j+rt*Y,z[4]=X*Q-rt*q,z[5]=X*et-rt*L,z[6]=X*Y-rt*j,x!==z&&(z[8]=x[8],z[9]=x[9],z[10]=x[10]),z}function Lt(x,F){let _=F??new e(12);return _[0]=x[0],_[1]=0,_[2]=0,_[4]=0,_[5]=x[1],_[6]=0,_[8]=0,_[9]=0,_[10]=1,_}function ot(x,F,_){let z=_??new e(12),q=F[0],L=F[1];return z[0]=q*x[0*4+0],z[1]=q*x[0*4+1],z[2]=q*x[0*4+2],z[4]=L*x[1*4+0],z[5]=L*x[1*4+1],z[6]=L*x[1*4+2],x!==z&&(z[8]=x[8],z[9]=x[9],z[10]=x[10]),z}function st(x,F){let _=F??new e(12);return _[0]=x,_[1]=0,_[2]=0,_[4]=0,_[5]=x,_[6]=0,_[8]=0,_[9]=0,_[10]=1,_}function tt(x,F,_){let z=_??new e(12);return z[0]=F*x[0*4+0],z[1]=F*x[0*4+1],z[2]=F*x[0*4+2],z[4]=F*x[1*4+0],z[5]=F*x[1*4+1],z[6]=F*x[1*4+2],x!==z&&(z[8]=x[8],z[9]=x[9],z[10]=x[10]),z}return{clone:G,create:a,set:p,fromMat4:v,fromQuat:d,negate:M,copy:A,equalsApproximately:P,equals:E,identity:O,transpose:Z,inverse:W,invert:R,determinant:$,mul:k,multiply:it,setTranslation:ct,getTranslation:ut,getAxis:wt,setAxis:dt,getScaling:mt,translation:St,translate:Tt,rotation:Ut,rotate:vt,scaling:Lt,scale:ot,uniformScaling:st,uniformScale:tt}}var Ie=new Map;function Yn(e){let t=Ie.get(e);return t||(t=Cn(e),Ie.set(e,t)),t}function Xn(e){function t(s,f,w){let g=new e(3);return s!==void 0&&(g[0]=s,f!==void 0&&(g[1]=f,w!==void 0&&(g[2]=w))),g}let a=t;function p(s,f,w,g){let S=g??new e(3);return S[0]=s,S[1]=f,S[2]=w,S}function v(s,f){let w=f??new e(3);return w[0]=Math.ceil(s[0]),w[1]=Math.ceil(s[1]),w[2]=Math.ceil(s[2]),w}function d(s,f){let w=f??new e(3);return w[0]=Math.floor(s[0]),w[1]=Math.floor(s[1]),w[2]=Math.floor(s[2]),w}function M(s,f){let w=f??new e(3);return w[0]=Math.round(s[0]),w[1]=Math.round(s[1]),w[2]=Math.round(s[2]),w}function A(s,f=0,w=1,g){let S=g??new e(3);return S[0]=Math.min(w,Math.max(f,s[0])),S[1]=Math.min(w,Math.max(f,s[1])),S[2]=Math.min(w,Math.max(f,s[2])),S}function G(s,f,w){let g=w??new e(3);return g[0]=s[0]+f[0],g[1]=s[1]+f[1],g[2]=s[2]+f[2],g}function P(s,f,w,g){let S=g??new e(3);return S[0]=s[0]+f[0]*w,S[1]=s[1]+f[1]*w,S[2]=s[2]+f[2]*w,S}function E(s,f){let w=s[0],g=s[1],S=s[2],T=f[0],B=f[1],C=f[2],H=Math.sqrt(w*w+g*g+S*S),V=Math.sqrt(T*T+B*B+C*C),N=H*V,J=N&&Ut(s,f)/N;return Math.acos(J)}function O(s,f,w){let g=w??new e(3);return g[0]=s[0]-f[0],g[1]=s[1]-f[1],g[2]=s[2]-f[2],g}let Z=O;function W(s,f){return Math.abs(s[0]-f[0])<K&&Math.abs(s[1]-f[1])<K&&Math.abs(s[2]-f[2])<K}function $(s,f){return s[0]===f[0]&&s[1]===f[1]&&s[2]===f[2]}function R(s,f,w,g){let S=g??new e(3);return S[0]=s[0]+w*(f[0]-s[0]),S[1]=s[1]+w*(f[1]-s[1]),S[2]=s[2]+w*(f[2]-s[2]),S}function it(s,f,w,g){let S=g??new e(3);return S[0]=s[0]+w[0]*(f[0]-s[0]),S[1]=s[1]+w[1]*(f[1]-s[1]),S[2]=s[2]+w[2]*(f[2]-s[2]),S}function k(s,f,w){let g=w??new e(3);return g[0]=Math.max(s[0],f[0]),g[1]=Math.max(s[1],f[1]),g[2]=Math.max(s[2],f[2]),g}function ct(s,f,w){let g=w??new e(3);return g[0]=Math.min(s[0],f[0]),g[1]=Math.min(s[1],f[1]),g[2]=Math.min(s[2],f[2]),g}function ut(s,f,w){let g=w??new e(3);return g[0]=s[0]*f,g[1]=s[1]*f,g[2]=s[2]*f,g}let wt=ut;function dt(s,f,w){let g=w??new e(3);return g[0]=s[0]/f,g[1]=s[1]/f,g[2]=s[2]/f,g}function mt(s,f){let w=f??new e(3);return w[0]=1/s[0],w[1]=1/s[1],w[2]=1/s[2],w}let St=mt;function Tt(s,f,w){let g=w??new e(3),S=s[2]*f[0]-s[0]*f[2],T=s[0]*f[1]-s[1]*f[0];return g[0]=s[1]*f[2]-s[2]*f[1],g[1]=S,g[2]=T,g}function Ut(s,f){return s[0]*f[0]+s[1]*f[1]+s[2]*f[2]}function vt(s){let f=s[0],w=s[1],g=s[2];return Math.sqrt(f*f+w*w+g*g)}let Lt=vt;function ot(s){let f=s[0],w=s[1],g=s[2];return f*f+w*w+g*g}let st=ot;function tt(s,f){let w=s[0]-f[0],g=s[1]-f[1],S=s[2]-f[2];return Math.sqrt(w*w+g*g+S*S)}let x=tt;function F(s,f){let w=s[0]-f[0],g=s[1]-f[1],S=s[2]-f[2];return w*w+g*g+S*S}let _=F;function z(s,f){let w=f??new e(3),g=s[0],S=s[1],T=s[2],B=Math.sqrt(g*g+S*S+T*T);return B>1e-5?(w[0]=g/B,w[1]=S/B,w[2]=T/B):(w[0]=0,w[1]=0,w[2]=0),w}function q(s,f){let w=f??new e(3);return w[0]=-s[0],w[1]=-s[1],w[2]=-s[2],w}function L(s,f){let w=f??new e(3);return w[0]=s[0],w[1]=s[1],w[2]=s[2],w}let j=L;function Q(s,f,w){let g=w??new e(3);return g[0]=s[0]*f[0],g[1]=s[1]*f[1],g[2]=s[2]*f[2],g}let et=Q;function Y(s,f,w){let g=w??new e(3);return g[0]=s[0]/f[0],g[1]=s[1]/f[1],g[2]=s[2]/f[2],g}let X=Y;function rt(s=1,f){let w=f??new e(3),g=Math.random()*2*Math.PI,S=Math.random()*2-1,T=Math.sqrt(1-S*S)*s;return w[0]=Math.cos(g)*T,w[1]=Math.sin(g)*T,w[2]=S*s,w}function b(s){let f=s??new e(3);return f[0]=0,f[1]=0,f[2]=0,f}function U(s,f,w){let g=w??new e(3),S=s[0],T=s[1],B=s[2],C=f[3]*S+f[7]*T+f[11]*B+f[15]||1;return g[0]=(f[0]*S+f[4]*T+f[8]*B+f[12])/C,g[1]=(f[1]*S+f[5]*T+f[9]*B+f[13])/C,g[2]=(f[2]*S+f[6]*T+f[10]*B+f[14])/C,g}function c(s,f,w){let g=w??new e(3),S=s[0],T=s[1],B=s[2];return g[0]=S*f[0*4+0]+T*f[1*4+0]+B*f[2*4+0],g[1]=S*f[0*4+1]+T*f[1*4+1]+B*f[2*4+1],g[2]=S*f[0*4+2]+T*f[1*4+2]+B*f[2*4+2],g}function u(s,f,w){let g=w??new e(3),S=s[0],T=s[1],B=s[2];return g[0]=S*f[0]+T*f[4]+B*f[8],g[1]=S*f[1]+T*f[5]+B*f[9],g[2]=S*f[2]+T*f[6]+B*f[10],g}function m(s,f,w){let g=w??new e(3),S=f[0],T=f[1],B=f[2],C=f[3]*2,H=s[0],V=s[1],N=s[2],J=T*N-B*V,nt=B*H-S*N,at=S*V-T*H;return g[0]=H+J*C+(T*at-B*nt)*2,g[1]=V+nt*C+(B*J-S*at)*2,g[2]=N+at*C+(S*nt-T*J)*2,g}function y(s,f){let w=f??new e(3);return w[0]=s[12],w[1]=s[13],w[2]=s[14],w}function I(s,f,w){let g=w??new e(3),S=f*4;return g[0]=s[S+0],g[1]=s[S+1],g[2]=s[S+2],g}function n(s,f){let w=f??new e(3),g=s[0],S=s[1],T=s[2],B=s[4],C=s[5],H=s[6],V=s[8],N=s[9],J=s[10];return w[0]=Math.sqrt(g*g+S*S+T*T),w[1]=Math.sqrt(B*B+C*C+H*H),w[2]=Math.sqrt(V*V+N*N+J*J),w}function i(s,f,w,g){let S=g??new e(3),T=[],B=[];return T[0]=s[0]-f[0],T[1]=s[1]-f[1],T[2]=s[2]-f[2],B[0]=T[0],B[1]=T[1]*Math.cos(w)-T[2]*Math.sin(w),B[2]=T[1]*Math.sin(w)+T[2]*Math.cos(w),S[0]=B[0]+f[0],S[1]=B[1]+f[1],S[2]=B[2]+f[2],S}function o(s,f,w,g){let S=g??new e(3),T=[],B=[];return T[0]=s[0]-f[0],T[1]=s[1]-f[1],T[2]=s[2]-f[2],B[0]=T[2]*Math.sin(w)+T[0]*Math.cos(w),B[1]=T[1],B[2]=T[2]*Math.cos(w)-T[0]*Math.sin(w),S[0]=B[0]+f[0],S[1]=B[1]+f[1],S[2]=B[2]+f[2],S}function r(s,f,w,g){let S=g??new e(3),T=[],B=[];return T[0]=s[0]-f[0],T[1]=s[1]-f[1],T[2]=s[2]-f[2],B[0]=T[0]*Math.cos(w)-T[1]*Math.sin(w),B[1]=T[0]*Math.sin(w)+T[1]*Math.cos(w),B[2]=T[2],S[0]=B[0]+f[0],S[1]=B[1]+f[1],S[2]=B[2]+f[2],S}function l(s,f,w){let g=w??new e(3);return z(s,g),ut(g,f,g)}function h(s,f,w){let g=w??new e(3);return vt(s)>f?l(s,f,g):L(s,g)}function D(s,f,w){let g=w??new e(3);return R(s,f,.5,g)}return{create:t,fromValues:a,set:p,ceil:v,floor:d,round:M,clamp:A,add:G,addScaled:P,angle:E,subtract:O,sub:Z,equalsApproximately:W,equals:$,lerp:R,lerpV:it,max:k,min:ct,mulScalar:ut,scale:wt,divScalar:dt,inverse:mt,invert:St,cross:Tt,dot:Ut,length:vt,len:Lt,lengthSq:ot,lenSq:st,distance:tt,dist:x,distanceSq:F,distSq:_,normalize:z,negate:q,copy:L,clone:j,multiply:Q,mul:et,divide:Y,div:X,random:rt,zero:b,transformMat4:U,transformMat4Upper3x3:c,transformMat3:u,transformQuat:m,getTranslation:y,getAxis:I,getScaling:n,rotateX:i,rotateY:o,rotateZ:r,setLength:l,truncate:h,midpoint:D}}var Re=new Map;function ae(e){let t=Re.get(e);return t||(t=Xn(e),Re.set(e,t)),t}function Wn(e){let t=ae(e);function a(n,i,o,r,l,h,D,s,f,w,g,S,T,B,C,H){let V=new e(16);return n!==void 0&&(V[0]=n,i!==void 0&&(V[1]=i,o!==void 0&&(V[2]=o,r!==void 0&&(V[3]=r,l!==void 0&&(V[4]=l,h!==void 0&&(V[5]=h,D!==void 0&&(V[6]=D,s!==void 0&&(V[7]=s,f!==void 0&&(V[8]=f,w!==void 0&&(V[9]=w,g!==void 0&&(V[10]=g,S!==void 0&&(V[11]=S,T!==void 0&&(V[12]=T,B!==void 0&&(V[13]=B,C!==void 0&&(V[14]=C,H!==void 0&&(V[15]=H)))))))))))))))),V}function p(n,i,o,r,l,h,D,s,f,w,g,S,T,B,C,H,V){let N=V??new e(16);return N[0]=n,N[1]=i,N[2]=o,N[3]=r,N[4]=l,N[5]=h,N[6]=D,N[7]=s,N[8]=f,N[9]=w,N[10]=g,N[11]=S,N[12]=T,N[13]=B,N[14]=C,N[15]=H,N}function v(n,i){let o=i??new e(16);return o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=0,o[4]=n[4],o[5]=n[5],o[6]=n[6],o[7]=0,o[8]=n[8],o[9]=n[9],o[10]=n[10],o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function d(n,i){let o=i??new e(16),r=n[0],l=n[1],h=n[2],D=n[3],s=r+r,f=l+l,w=h+h,g=r*s,S=l*s,T=l*f,B=h*s,C=h*f,H=h*w,V=D*s,N=D*f,J=D*w;return o[0]=1-T-H,o[1]=S+J,o[2]=B-N,o[3]=0,o[4]=S-J,o[5]=1-g-H,o[6]=C+V,o[7]=0,o[8]=B+N,o[9]=C-V,o[10]=1-g-T,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function M(n,i){let o=i??new e(16);return o[0]=-n[0],o[1]=-n[1],o[2]=-n[2],o[3]=-n[3],o[4]=-n[4],o[5]=-n[5],o[6]=-n[6],o[7]=-n[7],o[8]=-n[8],o[9]=-n[9],o[10]=-n[10],o[11]=-n[11],o[12]=-n[12],o[13]=-n[13],o[14]=-n[14],o[15]=-n[15],o}function A(n,i){let o=i??new e(16);return o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],o[4]=n[4],o[5]=n[5],o[6]=n[6],o[7]=n[7],o[8]=n[8],o[9]=n[9],o[10]=n[10],o[11]=n[11],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15],o}let G=A;function P(n,i){return Math.abs(n[0]-i[0])<K&&Math.abs(n[1]-i[1])<K&&Math.abs(n[2]-i[2])<K&&Math.abs(n[3]-i[3])<K&&Math.abs(n[4]-i[4])<K&&Math.abs(n[5]-i[5])<K&&Math.abs(n[6]-i[6])<K&&Math.abs(n[7]-i[7])<K&&Math.abs(n[8]-i[8])<K&&Math.abs(n[9]-i[9])<K&&Math.abs(n[10]-i[10])<K&&Math.abs(n[11]-i[11])<K&&Math.abs(n[12]-i[12])<K&&Math.abs(n[13]-i[13])<K&&Math.abs(n[14]-i[14])<K&&Math.abs(n[15]-i[15])<K}function E(n,i){return n[0]===i[0]&&n[1]===i[1]&&n[2]===i[2]&&n[3]===i[3]&&n[4]===i[4]&&n[5]===i[5]&&n[6]===i[6]&&n[7]===i[7]&&n[8]===i[8]&&n[9]===i[9]&&n[10]===i[10]&&n[11]===i[11]&&n[12]===i[12]&&n[13]===i[13]&&n[14]===i[14]&&n[15]===i[15]}function O(n){let i=n??new e(16);return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function Z(n,i){let o=i??new e(16);if(o===n){let nt;return nt=n[1],n[1]=n[4],n[4]=nt,nt=n[2],n[2]=n[8],n[8]=nt,nt=n[3],n[3]=n[12],n[12]=nt,nt=n[6],n[6]=n[9],n[9]=nt,nt=n[7],n[7]=n[13],n[13]=nt,nt=n[11],n[11]=n[14],n[14]=nt,o}let r=n[0*4+0],l=n[0*4+1],h=n[0*4+2],D=n[0*4+3],s=n[1*4+0],f=n[1*4+1],w=n[1*4+2],g=n[1*4+3],S=n[2*4+0],T=n[2*4+1],B=n[2*4+2],C=n[2*4+3],H=n[3*4+0],V=n[3*4+1],N=n[3*4+2],J=n[3*4+3];return o[0]=r,o[1]=s,o[2]=S,o[3]=H,o[4]=l,o[5]=f,o[6]=T,o[7]=V,o[8]=h,o[9]=w,o[10]=B,o[11]=N,o[12]=D,o[13]=g,o[14]=C,o[15]=J,o}function W(n,i){let o=i??new e(16),r=n[0*4+0],l=n[0*4+1],h=n[0*4+2],D=n[0*4+3],s=n[1*4+0],f=n[1*4+1],w=n[1*4+2],g=n[1*4+3],S=n[2*4+0],T=n[2*4+1],B=n[2*4+2],C=n[2*4+3],H=n[3*4+0],V=n[3*4+1],N=n[3*4+2],J=n[3*4+3],nt=B*J,at=N*C,ft=w*J,lt=N*g,xt=w*C,gt=B*g,yt=h*J,ht=N*D,bt=h*C,_t=B*D,Dt=h*g,Gt=w*D,Et=S*V,Bt=H*T,Ft=s*V,Pt=H*f,At=s*T,Qt=S*f,Zt=r*V,Kt=H*l,kt=r*T,Jt=S*l,te=r*f,ee=s*l,we=nt*f+lt*T+xt*V-(at*f+ft*T+gt*V),ge=at*l+yt*T+_t*V-(nt*l+ht*T+bt*V),ye=ft*l+ht*f+Dt*V-(lt*l+yt*f+Gt*V),he=gt*l+bt*f+Gt*T-(xt*l+_t*f+Dt*T),Mt=1/(r*we+s*ge+S*ye+H*he);return o[0]=Mt*we,o[1]=Mt*ge,o[2]=Mt*ye,o[3]=Mt*he,o[4]=Mt*(at*s+ft*S+gt*H-(nt*s+lt*S+xt*H)),o[5]=Mt*(nt*r+ht*S+bt*H-(at*r+yt*S+_t*H)),o[6]=Mt*(lt*r+yt*s+Gt*H-(ft*r+ht*s+Dt*H)),o[7]=Mt*(xt*r+_t*s+Dt*S-(gt*r+bt*s+Gt*S)),o[8]=Mt*(Et*g+Pt*C+At*J-(Bt*g+Ft*C+Qt*J)),o[9]=Mt*(Bt*D+Zt*C+Jt*J-(Et*D+Kt*C+kt*J)),o[10]=Mt*(Ft*D+Kt*g+te*J-(Pt*D+Zt*g+ee*J)),o[11]=Mt*(Qt*D+kt*g+ee*C-(At*D+Jt*g+te*C)),o[12]=Mt*(Ft*B+Qt*N+Bt*w-(At*N+Et*w+Pt*B)),o[13]=Mt*(kt*N+Et*h+Kt*B-(Zt*B+Jt*N+Bt*h)),o[14]=Mt*(Zt*w+ee*N+Pt*h-(te*N+Ft*h+Kt*w)),o[15]=Mt*(te*B+At*h+Jt*w-(kt*w+ee*B+Qt*h)),o}function $(n){let i=n[0],o=n[0*4+1],r=n[0*4+2],l=n[0*4+3],h=n[1*4+0],D=n[1*4+1],s=n[1*4+2],f=n[1*4+3],w=n[2*4+0],g=n[2*4+1],S=n[2*4+2],T=n[2*4+3],B=n[3*4+0],C=n[3*4+1],H=n[3*4+2],V=n[3*4+3],N=S*V,J=H*T,nt=s*V,at=H*f,ft=s*T,lt=S*f,xt=r*V,gt=H*l,yt=r*T,ht=S*l,bt=r*f,_t=s*l,Dt=N*D+at*g+ft*C-(J*D+nt*g+lt*C),Gt=J*o+xt*g+ht*C-(N*o+gt*g+yt*C),Et=nt*o+gt*D+bt*C-(at*o+xt*D+_t*C),Bt=lt*o+yt*D+_t*g-(ft*o+ht*D+bt*g);return i*Dt+h*Gt+w*Et+B*Bt}let R=W;function it(n,i,o){let r=o??new e(16),l=n[0],h=n[1],D=n[2],s=n[3],f=n[4],w=n[5],g=n[6],S=n[7],T=n[8],B=n[9],C=n[10],H=n[11],V=n[12],N=n[13],J=n[14],nt=n[15],at=i[0],ft=i[1],lt=i[2],xt=i[3],gt=i[4],yt=i[5],ht=i[6],bt=i[7],_t=i[8],Dt=i[9],Gt=i[10],Et=i[11],Bt=i[12],Ft=i[13],Pt=i[14],At=i[15];return r[0]=l*at+f*ft+T*lt+V*xt,r[1]=h*at+w*ft+B*lt+N*xt,r[2]=D*at+g*ft+C*lt+J*xt,r[3]=s*at+S*ft+H*lt+nt*xt,r[4]=l*gt+f*yt+T*ht+V*bt,r[5]=h*gt+w*yt+B*ht+N*bt,r[6]=D*gt+g*yt+C*ht+J*bt,r[7]=s*gt+S*yt+H*ht+nt*bt,r[8]=l*_t+f*Dt+T*Gt+V*Et,r[9]=h*_t+w*Dt+B*Gt+N*Et,r[10]=D*_t+g*Dt+C*Gt+J*Et,r[11]=s*_t+S*Dt+H*Gt+nt*Et,r[12]=l*Bt+f*Ft+T*Pt+V*At,r[13]=h*Bt+w*Ft+B*Pt+N*At,r[14]=D*Bt+g*Ft+C*Pt+J*At,r[15]=s*Bt+S*Ft+H*Pt+nt*At,r}let k=it;function ct(n,i,o){let r=o??O();return n!==r&&(r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11]),r[12]=i[0],r[13]=i[1],r[14]=i[2],r[15]=1,r}function ut(n,i){let o=i??t.create();return o[0]=n[12],o[1]=n[13],o[2]=n[14],o}function wt(n,i,o){let r=o??t.create(),l=i*4;return r[0]=n[l+0],r[1]=n[l+1],r[2]=n[l+2],r}function dt(n,i,o,r){let l=r===n?r:A(n,r),h=o*4;return l[h+0]=i[0],l[h+1]=i[1],l[h+2]=i[2],l}function mt(n,i){let o=i??t.create(),r=n[0],l=n[1],h=n[2],D=n[4],s=n[5],f=n[6],w=n[8],g=n[9],S=n[10];return o[0]=Math.sqrt(r*r+l*l+h*h),o[1]=Math.sqrt(D*D+s*s+f*f),o[2]=Math.sqrt(w*w+g*g+S*S),o}function St(n,i,o,r,l){let h=l??new e(16),D=Math.tan(Math.PI*.5-.5*n);if(h[0]=D/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=D,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,Number.isFinite(r)){let s=1/(o-r);h[10]=r*s,h[14]=r*o*s}else h[10]=-1,h[14]=-o;return h}function Tt(n,i,o,r=1/0,l){let h=l??new e(16),D=1/Math.tan(n*.5);if(h[0]=D/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=D,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,r===1/0)h[10]=0,h[14]=o;else{let s=1/(r-o);h[10]=o*s,h[14]=r*o*s}return h}function Ut(n,i,o,r,l,h,D){let s=D??new e(16);return s[0]=2/(i-n),s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/(r-o),s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1/(l-h),s[11]=0,s[12]=(i+n)/(n-i),s[13]=(r+o)/(o-r),s[14]=l/(l-h),s[15]=1,s}function vt(n,i,o,r,l,h,D){let s=D??new e(16),f=i-n,w=r-o,g=l-h;return s[0]=2*l/f,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*l/w,s[6]=0,s[7]=0,s[8]=(n+i)/f,s[9]=(r+o)/w,s[10]=h/g,s[11]=-1,s[12]=0,s[13]=0,s[14]=l*h/g,s[15]=0,s}function Lt(n,i,o,r,l,h=1/0,D){let s=D??new e(16),f=i-n,w=r-o;if(s[0]=2*l/f,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*l/w,s[6]=0,s[7]=0,s[8]=(n+i)/f,s[9]=(r+o)/w,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,h===1/0)s[10]=0,s[14]=l;else{let g=1/(h-l);s[10]=l*g,s[14]=h*l*g}return s}let ot=t.create(),st=t.create(),tt=t.create();function x(n,i,o,r){let l=r??new e(16);return t.normalize(t.subtract(i,n,tt),tt),t.normalize(t.cross(o,tt,ot),ot),t.normalize(t.cross(tt,ot,st),st),l[0]=ot[0],l[1]=ot[1],l[2]=ot[2],l[3]=0,l[4]=st[0],l[5]=st[1],l[6]=st[2],l[7]=0,l[8]=tt[0],l[9]=tt[1],l[10]=tt[2],l[11]=0,l[12]=n[0],l[13]=n[1],l[14]=n[2],l[15]=1,l}function F(n,i,o,r){let l=r??new e(16);return t.normalize(t.subtract(n,i,tt),tt),t.normalize(t.cross(o,tt,ot),ot),t.normalize(t.cross(tt,ot,st),st),l[0]=ot[0],l[1]=ot[1],l[2]=ot[2],l[3]=0,l[4]=st[0],l[5]=st[1],l[6]=st[2],l[7]=0,l[8]=tt[0],l[9]=tt[1],l[10]=tt[2],l[11]=0,l[12]=n[0],l[13]=n[1],l[14]=n[2],l[15]=1,l}function _(n,i,o,r){let l=r??new e(16);return t.normalize(t.subtract(n,i,tt),tt),t.normalize(t.cross(o,tt,ot),ot),t.normalize(t.cross(tt,ot,st),st),l[0]=ot[0],l[1]=st[0],l[2]=tt[0],l[3]=0,l[4]=ot[1],l[5]=st[1],l[6]=tt[1],l[7]=0,l[8]=ot[2],l[9]=st[2],l[10]=tt[2],l[11]=0,l[12]=-(ot[0]*n[0]+ot[1]*n[1]+ot[2]*n[2]),l[13]=-(st[0]*n[0]+st[1]*n[1]+st[2]*n[2]),l[14]=-(tt[0]*n[0]+tt[1]*n[1]+tt[2]*n[2]),l[15]=1,l}function z(n,i){let o=i??new e(16);return o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=n[0],o[13]=n[1],o[14]=n[2],o[15]=1,o}function q(n,i,o){let r=o??new e(16),l=i[0],h=i[1],D=i[2],s=n[0],f=n[1],w=n[2],g=n[3],S=n[1*4+0],T=n[1*4+1],B=n[1*4+2],C=n[1*4+3],H=n[2*4+0],V=n[2*4+1],N=n[2*4+2],J=n[2*4+3],nt=n[3*4+0],at=n[3*4+1],ft=n[3*4+2],lt=n[3*4+3];return n!==r&&(r[0]=s,r[1]=f,r[2]=w,r[3]=g,r[4]=S,r[5]=T,r[6]=B,r[7]=C,r[8]=H,r[9]=V,r[10]=N,r[11]=J),r[12]=s*l+S*h+H*D+nt,r[13]=f*l+T*h+V*D+at,r[14]=w*l+B*h+N*D+ft,r[15]=g*l+C*h+J*D+lt,r}function L(n,i){let o=i??new e(16),r=Math.cos(n),l=Math.sin(n);return o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=r,o[6]=l,o[7]=0,o[8]=0,o[9]=-l,o[10]=r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function j(n,i,o){let r=o??new e(16),l=n[4],h=n[5],D=n[6],s=n[7],f=n[8],w=n[9],g=n[10],S=n[11],T=Math.cos(i),B=Math.sin(i);return r[4]=T*l+B*f,r[5]=T*h+B*w,r[6]=T*D+B*g,r[7]=T*s+B*S,r[8]=T*f-B*l,r[9]=T*w-B*h,r[10]=T*g-B*D,r[11]=T*S-B*s,n!==r&&(r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),r}function Q(n,i){let o=i??new e(16),r=Math.cos(n),l=Math.sin(n);return o[0]=r,o[1]=0,o[2]=-l,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=l,o[9]=0,o[10]=r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function et(n,i,o){let r=o??new e(16),l=n[0*4+0],h=n[0*4+1],D=n[0*4+2],s=n[0*4+3],f=n[2*4+0],w=n[2*4+1],g=n[2*4+2],S=n[2*4+3],T=Math.cos(i),B=Math.sin(i);return r[0]=T*l-B*f,r[1]=T*h-B*w,r[2]=T*D-B*g,r[3]=T*s-B*S,r[8]=T*f+B*l,r[9]=T*w+B*h,r[10]=T*g+B*D,r[11]=T*S+B*s,n!==r&&(r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),r}function Y(n,i){let o=i??new e(16),r=Math.cos(n),l=Math.sin(n);return o[0]=r,o[1]=l,o[2]=0,o[3]=0,o[4]=-l,o[5]=r,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function X(n,i,o){let r=o??new e(16),l=n[0*4+0],h=n[0*4+1],D=n[0*4+2],s=n[0*4+3],f=n[1*4+0],w=n[1*4+1],g=n[1*4+2],S=n[1*4+3],T=Math.cos(i),B=Math.sin(i);return r[0]=T*l+B*f,r[1]=T*h+B*w,r[2]=T*D+B*g,r[3]=T*s+B*S,r[4]=T*f-B*l,r[5]=T*w-B*h,r[6]=T*g-B*D,r[7]=T*S-B*s,n!==r&&(r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),r}function rt(n,i,o){let r=o??new e(16),l=n[0],h=n[1],D=n[2],s=Math.sqrt(l*l+h*h+D*D);l/=s,h/=s,D/=s;let f=l*l,w=h*h,g=D*D,S=Math.cos(i),T=Math.sin(i),B=1-S;return r[0]=f+(1-f)*S,r[1]=l*h*B+D*T,r[2]=l*D*B-h*T,r[3]=0,r[4]=l*h*B-D*T,r[5]=w+(1-w)*S,r[6]=h*D*B+l*T,r[7]=0,r[8]=l*D*B+h*T,r[9]=h*D*B-l*T,r[10]=g+(1-g)*S,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}let b=rt;function U(n,i,o,r){let l=r??new e(16),h=i[0],D=i[1],s=i[2],f=Math.sqrt(h*h+D*D+s*s);h/=f,D/=f,s/=f;let w=h*h,g=D*D,S=s*s,T=Math.cos(o),B=Math.sin(o),C=1-T,H=w+(1-w)*T,V=h*D*C+s*B,N=h*s*C-D*B,J=h*D*C-s*B,nt=g+(1-g)*T,at=D*s*C+h*B,ft=h*s*C+D*B,lt=D*s*C-h*B,xt=S+(1-S)*T,gt=n[0],yt=n[1],ht=n[2],bt=n[3],_t=n[4],Dt=n[5],Gt=n[6],Et=n[7],Bt=n[8],Ft=n[9],Pt=n[10],At=n[11];return l[0]=H*gt+V*_t+N*Bt,l[1]=H*yt+V*Dt+N*Ft,l[2]=H*ht+V*Gt+N*Pt,l[3]=H*bt+V*Et+N*At,l[4]=J*gt+nt*_t+at*Bt,l[5]=J*yt+nt*Dt+at*Ft,l[6]=J*ht+nt*Gt+at*Pt,l[7]=J*bt+nt*Et+at*At,l[8]=ft*gt+lt*_t+xt*Bt,l[9]=ft*yt+lt*Dt+xt*Ft,l[10]=ft*ht+lt*Gt+xt*Pt,l[11]=ft*bt+lt*Et+xt*At,n!==l&&(l[12]=n[12],l[13]=n[13],l[14]=n[14],l[15]=n[15]),l}let c=U;function u(n,i){let o=i??new e(16);return o[0]=n[0],o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=n[1],o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=n[2],o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function m(n,i,o){let r=o??new e(16),l=i[0],h=i[1],D=i[2];return r[0]=l*n[0*4+0],r[1]=l*n[0*4+1],r[2]=l*n[0*4+2],r[3]=l*n[0*4+3],r[4]=h*n[1*4+0],r[5]=h*n[1*4+1],r[6]=h*n[1*4+2],r[7]=h*n[1*4+3],r[8]=D*n[2*4+0],r[9]=D*n[2*4+1],r[10]=D*n[2*4+2],r[11]=D*n[2*4+3],n!==r&&(r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),r}function y(n,i){let o=i??new e(16);return o[0]=n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=n,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=n,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function I(n,i,o){let r=o??new e(16);return r[0]=i*n[0*4+0],r[1]=i*n[0*4+1],r[2]=i*n[0*4+2],r[3]=i*n[0*4+3],r[4]=i*n[1*4+0],r[5]=i*n[1*4+1],r[6]=i*n[1*4+2],r[7]=i*n[1*4+3],r[8]=i*n[2*4+0],r[9]=i*n[2*4+1],r[10]=i*n[2*4+2],r[11]=i*n[2*4+3],n!==r&&(r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),r}return{create:a,set:p,fromMat3:v,fromQuat:d,negate:M,copy:A,clone:G,equalsApproximately:P,equals:E,identity:O,transpose:Z,inverse:W,determinant:$,invert:R,multiply:it,mul:k,setTranslation:ct,getTranslation:ut,getAxis:wt,setAxis:dt,getScaling:mt,perspective:St,perspectiveReverseZ:Tt,ortho:Ut,frustum:vt,frustumReverseZ:Lt,aim:x,cameraAim:F,lookAt:_,translation:z,translate:q,rotationX:L,rotateX:j,rotationY:Q,rotateY:et,rotationZ:Y,rotateZ:X,axisRotation:rt,rotation:b,axisRotate:U,rotate:c,scaling:u,scale:m,uniformScaling:y,uniformScale:I}}var Le=new Map;function Hn(e){let t=Le.get(e);return t||(t=Wn(e),Le.set(e,t)),t}function $n(e){let t=ae(e);function a(b,U,c,u){let m=new e(4);return b!==void 0&&(m[0]=b,U!==void 0&&(m[1]=U,c!==void 0&&(m[2]=c,u!==void 0&&(m[3]=u)))),m}let p=a;function v(b,U,c,u,m){let y=m??new e(4);return y[0]=b,y[1]=U,y[2]=c,y[3]=u,y}function d(b,U,c){let u=c??new e(4),m=U*.5,y=Math.sin(m);return u[0]=y*b[0],u[1]=y*b[1],u[2]=y*b[2],u[3]=Math.cos(m),u}function M(b,U){let c=U??t.create(3),u=Math.acos(b[3])*2,m=Math.sin(u*.5);return m>K?(c[0]=b[0]/m,c[1]=b[1]/m,c[2]=b[2]/m):(c[0]=1,c[1]=0,c[2]=0),{angle:u,axis:c}}function A(b,U){let c=vt(b,U);return Math.acos(2*c*c-1)}function G(b,U,c){let u=c??new e(4),m=b[0],y=b[1],I=b[2],n=b[3],i=U[0],o=U[1],r=U[2],l=U[3];return u[0]=m*l+n*i+y*r-I*o,u[1]=y*l+n*o+I*i-m*r,u[2]=I*l+n*r+m*o-y*i,u[3]=n*l-m*i-y*o-I*r,u}let P=G;function E(b,U,c){let u=c??new e(4),m=U*.5,y=b[0],I=b[1],n=b[2],i=b[3],o=Math.sin(m),r=Math.cos(m);return u[0]=y*r+i*o,u[1]=I*r+n*o,u[2]=n*r-I*o,u[3]=i*r-y*o,u}function O(b,U,c){let u=c??new e(4),m=U*.5,y=b[0],I=b[1],n=b[2],i=b[3],o=Math.sin(m),r=Math.cos(m);return u[0]=y*r-n*o,u[1]=I*r+i*o,u[2]=n*r+y*o,u[3]=i*r-I*o,u}function Z(b,U,c){let u=c??new e(4),m=U*.5,y=b[0],I=b[1],n=b[2],i=b[3],o=Math.sin(m),r=Math.cos(m);return u[0]=y*r+I*o,u[1]=I*r-y*o,u[2]=n*r+i*o,u[3]=i*r-n*o,u}function W(b,U,c,u){let m=u??new e(4),y=b[0],I=b[1],n=b[2],i=b[3],o=U[0],r=U[1],l=U[2],h=U[3],D=y*o+I*r+n*l+i*h;D<0&&(D=-D,o=-o,r=-r,l=-l,h=-h);let s,f;if(1-D>K){let w=Math.acos(D),g=Math.sin(w);s=Math.sin((1-c)*w)/g,f=Math.sin(c*w)/g}else s=1-c,f=c;return m[0]=s*y+f*o,m[1]=s*I+f*r,m[2]=s*n+f*l,m[3]=s*i+f*h,m}function $(b,U){let c=U??new e(4),u=b[0],m=b[1],y=b[2],I=b[3],n=u*u+m*m+y*y+I*I,i=n?1/n:0;return c[0]=-u*i,c[1]=-m*i,c[2]=-y*i,c[3]=I*i,c}function R(b,U){let c=U??new e(4);return c[0]=-b[0],c[1]=-b[1],c[2]=-b[2],c[3]=b[3],c}function it(b,U){let c=U??new e(4),u=b[0]+b[5]+b[10];if(u>0){let m=Math.sqrt(u+1);c[3]=.5*m;let y=.5/m;c[0]=(b[6]-b[9])*y,c[1]=(b[8]-b[2])*y,c[2]=(b[1]-b[4])*y}else{let m=0;b[5]>b[0]&&(m=1),b[10]>b[m*4+m]&&(m=2);let y=(m+1)%3,I=(m+2)%3,n=Math.sqrt(b[m*4+m]-b[y*4+y]-b[I*4+I]+1);c[m]=.5*n;let i=.5/n;c[3]=(b[y*4+I]-b[I*4+y])*i,c[y]=(b[y*4+m]+b[m*4+y])*i,c[I]=(b[I*4+m]+b[m*4+I])*i}return c}function k(b,U,c,u,m){let y=m??new e(4),I=b*.5,n=U*.5,i=c*.5,o=Math.sin(I),r=Math.cos(I),l=Math.sin(n),h=Math.cos(n),D=Math.sin(i),s=Math.cos(i);switch(u){case"xyz":y[0]=o*h*s+r*l*D,y[1]=r*l*s-o*h*D,y[2]=r*h*D+o*l*s,y[3]=r*h*s-o*l*D;break;case"xzy":y[0]=o*h*s-r*l*D,y[1]=r*l*s-o*h*D,y[2]=r*h*D+o*l*s,y[3]=r*h*s+o*l*D;break;case"yxz":y[0]=o*h*s+r*l*D,y[1]=r*l*s-o*h*D,y[2]=r*h*D-o*l*s,y[3]=r*h*s+o*l*D;break;case"yzx":y[0]=o*h*s+r*l*D,y[1]=r*l*s+o*h*D,y[2]=r*h*D-o*l*s,y[3]=r*h*s-o*l*D;break;case"zxy":y[0]=o*h*s-r*l*D,y[1]=r*l*s+o*h*D,y[2]=r*h*D+o*l*s,y[3]=r*h*s-o*l*D;break;case"zyx":y[0]=o*h*s-r*l*D,y[1]=r*l*s+o*h*D,y[2]=r*h*D-o*l*s,y[3]=r*h*s+o*l*D;break;default:throw new Error(`Unknown rotation order: ${u}`)}return y}function ct(b,U){let c=U??new e(4);return c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c}let ut=ct;function wt(b,U,c){let u=c??new e(4);return u[0]=b[0]+U[0],u[1]=b[1]+U[1],u[2]=b[2]+U[2],u[3]=b[3]+U[3],u}function dt(b,U,c){let u=c??new e(4);return u[0]=b[0]-U[0],u[1]=b[1]-U[1],u[2]=b[2]-U[2],u[3]=b[3]-U[3],u}let mt=dt;function St(b,U,c){let u=c??new e(4);return u[0]=b[0]*U,u[1]=b[1]*U,u[2]=b[2]*U,u[3]=b[3]*U,u}let Tt=St;function Ut(b,U,c){let u=c??new e(4);return u[0]=b[0]/U,u[1]=b[1]/U,u[2]=b[2]/U,u[3]=b[3]/U,u}function vt(b,U){return b[0]*U[0]+b[1]*U[1]+b[2]*U[2]+b[3]*U[3]}function Lt(b,U,c,u){let m=u??new e(4);return m[0]=b[0]+c*(U[0]-b[0]),m[1]=b[1]+c*(U[1]-b[1]),m[2]=b[2]+c*(U[2]-b[2]),m[3]=b[3]+c*(U[3]-b[3]),m}function ot(b){let U=b[0],c=b[1],u=b[2],m=b[3];return Math.sqrt(U*U+c*c+u*u+m*m)}let st=ot;function tt(b){let U=b[0],c=b[1],u=b[2],m=b[3];return U*U+c*c+u*u+m*m}let x=tt;function F(b,U){let c=U??new e(4),u=b[0],m=b[1],y=b[2],I=b[3],n=Math.sqrt(u*u+m*m+y*y+I*I);return n>1e-5?(c[0]=u/n,c[1]=m/n,c[2]=y/n,c[3]=I/n):(c[0]=0,c[1]=0,c[2]=0,c[3]=1),c}function _(b,U){return Math.abs(b[0]-U[0])<K&&Math.abs(b[1]-U[1])<K&&Math.abs(b[2]-U[2])<K&&Math.abs(b[3]-U[3])<K}function z(b,U){return b[0]===U[0]&&b[1]===U[1]&&b[2]===U[2]&&b[3]===U[3]}function q(b){let U=b??new e(4);return U[0]=0,U[1]=0,U[2]=0,U[3]=1,U}let L=t.create(),j=t.create(),Q=t.create();function et(b,U,c){let u=c??new e(4),m=t.dot(b,U);return m<-.999999?(t.cross(j,b,L),t.len(L)<1e-6&&t.cross(Q,b,L),t.normalize(L,L),d(L,Math.PI,u),u):m>.999999?(u[0]=0,u[1]=0,u[2]=0,u[3]=1,u):(t.cross(b,U,L),u[0]=L[0],u[1]=L[1],u[2]=L[2],u[3]=1+m,F(u,u))}let Y=new e(4),X=new e(4);function rt(b,U,c,u,m,y){let I=y??new e(4);return W(b,u,m,Y),W(U,c,m,X),W(Y,X,2*m*(1-m),I),I}return{create:a,fromValues:p,set:v,fromAxisAngle:d,toAxisAngle:M,angle:A,multiply:G,mul:P,rotateX:E,rotateY:O,rotateZ:Z,slerp:W,inverse:$,conjugate:R,fromMat:it,fromEuler:k,copy:ct,clone:ut,add:wt,subtract:dt,sub:mt,mulScalar:St,scale:Tt,divScalar:Ut,dot:vt,lerp:Lt,length:ot,len:st,lengthSq:tt,lenSq:x,normalize:F,equalsApproximately:_,equals:z,identity:q,rotationTo:et,sqlerp:rt}}var Oe=new Map;function jn(e){let t=Oe.get(e);return t||(t=$n(e),Oe.set(e,t)),t}function Qn(e){function t(c,u,m,y){let I=new e(4);return c!==void 0&&(I[0]=c,u!==void 0&&(I[1]=u,m!==void 0&&(I[2]=m,y!==void 0&&(I[3]=y)))),I}let a=t;function p(c,u,m,y,I){let n=I??new e(4);return n[0]=c,n[1]=u,n[2]=m,n[3]=y,n}function v(c,u){let m=u??new e(4);return m[0]=Math.ceil(c[0]),m[1]=Math.ceil(c[1]),m[2]=Math.ceil(c[2]),m[3]=Math.ceil(c[3]),m}function d(c,u){let m=u??new e(4);return m[0]=Math.floor(c[0]),m[1]=Math.floor(c[1]),m[2]=Math.floor(c[2]),m[3]=Math.floor(c[3]),m}function M(c,u){let m=u??new e(4);return m[0]=Math.round(c[0]),m[1]=Math.round(c[1]),m[2]=Math.round(c[2]),m[3]=Math.round(c[3]),m}function A(c,u=0,m=1,y){let I=y??new e(4);return I[0]=Math.min(m,Math.max(u,c[0])),I[1]=Math.min(m,Math.max(u,c[1])),I[2]=Math.min(m,Math.max(u,c[2])),I[3]=Math.min(m,Math.max(u,c[3])),I}function G(c,u,m){let y=m??new e(4);return y[0]=c[0]+u[0],y[1]=c[1]+u[1],y[2]=c[2]+u[2],y[3]=c[3]+u[3],y}function P(c,u,m,y){let I=y??new e(4);return I[0]=c[0]+u[0]*m,I[1]=c[1]+u[1]*m,I[2]=c[2]+u[2]*m,I[3]=c[3]+u[3]*m,I}function E(c,u,m){let y=m??new e(4);return y[0]=c[0]-u[0],y[1]=c[1]-u[1],y[2]=c[2]-u[2],y[3]=c[3]-u[3],y}let O=E;function Z(c,u){return Math.abs(c[0]-u[0])<K&&Math.abs(c[1]-u[1])<K&&Math.abs(c[2]-u[2])<K&&Math.abs(c[3]-u[3])<K}function W(c,u){return c[0]===u[0]&&c[1]===u[1]&&c[2]===u[2]&&c[3]===u[3]}function $(c,u,m,y){let I=y??new e(4);return I[0]=c[0]+m*(u[0]-c[0]),I[1]=c[1]+m*(u[1]-c[1]),I[2]=c[2]+m*(u[2]-c[2]),I[3]=c[3]+m*(u[3]-c[3]),I}function R(c,u,m,y){let I=y??new e(4);return I[0]=c[0]+m[0]*(u[0]-c[0]),I[1]=c[1]+m[1]*(u[1]-c[1]),I[2]=c[2]+m[2]*(u[2]-c[2]),I[3]=c[3]+m[3]*(u[3]-c[3]),I}function it(c,u,m){let y=m??new e(4);return y[0]=Math.max(c[0],u[0]),y[1]=Math.max(c[1],u[1]),y[2]=Math.max(c[2],u[2]),y[3]=Math.max(c[3],u[3]),y}function k(c,u,m){let y=m??new e(4);return y[0]=Math.min(c[0],u[0]),y[1]=Math.min(c[1],u[1]),y[2]=Math.min(c[2],u[2]),y[3]=Math.min(c[3],u[3]),y}function ct(c,u,m){let y=m??new e(4);return y[0]=c[0]*u,y[1]=c[1]*u,y[2]=c[2]*u,y[3]=c[3]*u,y}let ut=ct;function wt(c,u,m){let y=m??new e(4);return y[0]=c[0]/u,y[1]=c[1]/u,y[2]=c[2]/u,y[3]=c[3]/u,y}function dt(c,u){let m=u??new e(4);return m[0]=1/c[0],m[1]=1/c[1],m[2]=1/c[2],m[3]=1/c[3],m}let mt=dt;function St(c,u){return c[0]*u[0]+c[1]*u[1]+c[2]*u[2]+c[3]*u[3]}function Tt(c){let u=c[0],m=c[1],y=c[2],I=c[3];return Math.sqrt(u*u+m*m+y*y+I*I)}let Ut=Tt;function vt(c){let u=c[0],m=c[1],y=c[2],I=c[3];return u*u+m*m+y*y+I*I}let Lt=vt;function ot(c,u){let m=c[0]-u[0],y=c[1]-u[1],I=c[2]-u[2],n=c[3]-u[3];return Math.sqrt(m*m+y*y+I*I+n*n)}let st=ot;function tt(c,u){let m=c[0]-u[0],y=c[1]-u[1],I=c[2]-u[2],n=c[3]-u[3];return m*m+y*y+I*I+n*n}let x=tt;function F(c,u){let m=u??new e(4),y=c[0],I=c[1],n=c[2],i=c[3],o=Math.sqrt(y*y+I*I+n*n+i*i);return o>1e-5?(m[0]=y/o,m[1]=I/o,m[2]=n/o,m[3]=i/o):(m[0]=0,m[1]=0,m[2]=0,m[3]=0),m}function _(c,u){let m=u??new e(4);return m[0]=-c[0],m[1]=-c[1],m[2]=-c[2],m[3]=-c[3],m}function z(c,u){let m=u??new e(4);return m[0]=c[0],m[1]=c[1],m[2]=c[2],m[3]=c[3],m}let q=z;function L(c,u,m){let y=m??new e(4);return y[0]=c[0]*u[0],y[1]=c[1]*u[1],y[2]=c[2]*u[2],y[3]=c[3]*u[3],y}let j=L;function Q(c,u,m){let y=m??new e(4);return y[0]=c[0]/u[0],y[1]=c[1]/u[1],y[2]=c[2]/u[2],y[3]=c[3]/u[3],y}let et=Q;function Y(c){let u=c??new e(4);return u[0]=0,u[1]=0,u[2]=0,u[3]=0,u}function X(c,u,m){let y=m??new e(4),I=c[0],n=c[1],i=c[2],o=c[3];return y[0]=u[0]*I+u[4]*n+u[8]*i+u[12]*o,y[1]=u[1]*I+u[5]*n+u[9]*i+u[13]*o,y[2]=u[2]*I+u[6]*n+u[10]*i+u[14]*o,y[3]=u[3]*I+u[7]*n+u[11]*i+u[15]*o,y}function rt(c,u,m){let y=m??new e(4);return F(c,y),ct(y,u,y)}function b(c,u,m){let y=m??new e(4);return Tt(c)>u?rt(c,u,y):z(c,y)}function U(c,u,m){let y=m??new e(4);return $(c,u,.5,y)}return{create:t,fromValues:a,set:p,ceil:v,floor:d,round:M,clamp:A,add:G,addScaled:P,subtract:E,sub:O,equalsApproximately:Z,equals:W,lerp:$,lerpV:R,max:it,min:k,mulScalar:ct,scale:ut,divScalar:wt,inverse:dt,invert:mt,dot:St,length:Tt,len:Ut,lengthSq:vt,lenSq:Lt,distance:ot,dist:st,distanceSq:tt,distSq:x,normalize:F,negate:_,copy:z,clone:q,multiply:L,mul:j,divide:Q,div:et,zero:Y,transformMat4:X,setLength:rt,truncate:b,midpoint:U}}var Ve=new Map;function Zn(e){let t=Ve.get(e);return t||(t=Qn(e),Ve.set(e,t)),t}function ce(e,t,a,p,v,d){return{mat4:Hn(e),mat3:Yn(t),quat:jn(a),vec2:Ne(p),vec3:ae(v),vec4:Zn(d)}}var{mat4:It,mat3:cr,quat:ur,vec2:Xt,vec3:Rt,vec4:ue}=ce(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat4:fr,mat3:lr,quat:pr,vec2:dr,vec3:mr,vec4:vr}=ce(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat4:xr,mat3:wr,quat:gr,vec2:yr,vec3:hr,vec4:br}=ce(Nn,Array,Array,Array,Array,Array);var qe=Rt.create(0,0,0),$t=6,Ce={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(e,t={}){return Kn(e,t)},onRun:function(e,t,a){kn(e,t,a)},onDestroy:function(e,t){Jn(t)},onResize:function(e,t){to(e,t)},onViewportPosition:function(e,t){eo(e,t)},customFunctions:{addTriangle:function(e,t,a){let p=Ct(),v=t.data.spriteCount;t.data.spriteIndices.set(p,v);let d=v*$t;return t.data.spriteData[d]=a[0][0],t.data.spriteData[d+1]=a[0][1],t.data.spriteData[d+2]=a[1][0],t.data.spriteData[d+3]=a[1][1],t.data.spriteData[d+4]=a[2][0],t.data.spriteData[d+5]=a[2][1],t.data.spriteCount++,p},removeTriangle:function(e,t,a){t.data.spriteIndices.delete(a),t.data.spriteCount--},setPosition:function(e,t,a,p){let d=t.data.spriteIndices.get(a)*$t;t.data.spriteData[d]=p[0][0],t.data.spriteData[d+1]=p[0][1],t.data.spriteData[d+2]=p[1][0],t.data.spriteData[d+3]=p[1][1],t.data.spriteData[d+4]=p[2][0],t.data.spriteData[d+5]=p[2][1]}}};async function Kn(e,t){let{device:a}=e,p=new Float32Array([t.options.offseyX??0,t.options.offseyY??0,t.options.scale??20,0]),v=a.createBuffer({label:"displacement options buffer",size:p.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(v.getMappedRange()).set(p),v.unmap();let d=256,M=d,G=Float32Array.BYTES_PER_ELEMENT*2,E=Float32Array.BYTES_PER_ELEMENT*2,Z=Float32Array.BYTES_PER_ELEMENT*2,W=a.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),$=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),R=a.createPipelineLayout({bindGroupLayouts:[$]}),it="repeat",k="linear",ct=a.createSampler({label:"displacement ampler",addressModeU:it,addressModeV:it,addressModeW:it,magFilter:k,minFilter:k,mipmapFilter:k}),ut=a.createBindGroup({layout:$,entries:[{binding:0,resource:{buffer:W}},{binding:1,resource:t.refs.color.data.view},{binding:2,resource:ct},{binding:3,resource:t.refs.map.view},{binding:4,resource:{buffer:v}}]}),wt=a.createBuffer({size:d*$t,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),dt={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},mt=a.createRenderPipeline({label:"displacement",vertex:{module:a.createShaderModule({code:ie}),entryPoint:"vs_main",buffers:[dt]},fragment:{module:a.createShaderModule({code:ie}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:R});return{bindGroup:ut,bindGroupLayout:$,uniformBuffer:W,sampler:ct,pipeline:mt,params_buf:v,buffer:wt,spriteData:new Float32Array(d*$t),spriteCount:0,spriteIndices:new Map}}function kn(e,t,a){if(t.data.spriteCount===0)return;let{device:p}=e,v=$t*t.data.spriteCount*Float32Array.BYTES_PER_ELEMENT;p.queue.writeBuffer(t.data.buffer,0,t.data.spriteData.buffer,0,v);let d=a.beginRenderPass({colorAttachments:[{view:t.refs.out,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});d.setPipeline(t.data.pipeline),d.setBindGroup(0,t.data.bindGroup),d.setVertexBuffer(0,t.data.buffer);let M=t.data.spriteCount*3;d.draw(M,1,0,0),d.end()}function Jn(e){e.data.bindGroup=null,e.data.buffer.destroy(),e.data.buffer=null,e.data.uniformBuffer.destroy(),e.data.uniformBuffer=null,e.data.spriteData=null,e.data.spriteIndices.clear(),e.data.spriteIndices=null,e.data.params_buf.destroy(),e.data.params_buf=null}function to(e,t){let{device:a}=e;t.data.bindGroup=a.createBindGroup({layout:t.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:t.data.uniformBuffer}},{binding:1,resource:t.refs.color.data.view},{binding:2,resource:t.data.sampler},{binding:3,resource:t.refs.map.view},{binding:4,resource:{buffer:t.data.params_buf}}]})}function eo(e,t){let{device:a}=e,p=e.viewport.width/e.viewport.zoom,v=e.viewport.height/e.viewport.zoom,d=It.ortho(0,p,v,0,-10,10);Rt.set(-e.viewport.position[0],-e.viewport.position[1],0,qe);let M=It.translation(qe);a.queue.writeBuffer(t.data.uniformBuffer,0,M.buffer),a.queue.writeBuffer(t.data.uniformBuffer,64,d.buffer)}function fe(e,t){let a=t.vertices,p=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,v={size:a.byteLength,usage:p,mappedAtCreation:!0},d=e.createBuffer(v);return new Float32Array(d.getMappedRange()).set(a),d.unmap(),{buffer:d,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var le="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var jr=ue.create(),Ye=Rt.create(),He={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return oo(e,t)},onRun:function(e,t,a){ro(e,t,a)},onDestroy:function(e,t){io(t)},onResize:function(e,t){Xe(e,t)},onViewportPosition:function(e,t){Xe(e,t)},customFunctions:{...Ht}};async function oo(e,t){let{device:a}=e,p=16192,v=p,M=Float32Array.BYTES_PER_ELEMENT*2,G=Float32Array.BYTES_PER_ELEMENT*2,E=Float32Array.BYTES_PER_ELEMENT*4,Z=Float32Array.BYTES_PER_ELEMENT*4,W=a.createBuffer({size:(M+G+E+Z)*v,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),$=a.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),R=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),it=a.createBindGroup({layout:R,entries:[{binding:0,resource:{buffer:$}},{binding:1,resource:t.refs.spritesheet.data.colorTexture.view},{binding:2,resource:t.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:W}}]}),k=a.createPipelineLayout({bindGroupLayouts:[R]}),ct=a.createRenderPipeline({label:"overlay",vertex:{module:a.createShaderModule({code:le}),entryPoint:"vs_main",buffers:[t.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:a.createShaderModule({code:le}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:k});return{instancedDrawCalls:new Uint32Array(p*2),instancedDrawCallCount:0,spriteBuffer:W,uniformBuffer:$,pipeline:ct,bindGroupLayout:R,bindGroup:it,spriteData:new Float32Array(p*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function ro(e,t,a){let{device:p}=e,v=t.options.loadOp||"load";t.data.dirty&&(so(t.data),t.data.dirty=!1),p.queue.writeBuffer(t.data.spriteBuffer,0,t.data.spriteData.buffer);let d=a.beginRenderPass({colorAttachments:[{view:t.refs.color,clearValue:e.clearValue,loadOp:v,storeOp:"store"}]});d.setPipeline(t.data.pipeline),d.setBindGroup(0,t.data.bindGroup),d.setVertexBuffer(0,t.refs.spritesheet.data.quads.buffer);let M=6,A=0;for(let G=0;G<t.data.instancedDrawCallCount;G++){let P=t.data.instancedDrawCalls[G*2]*M,E=t.data.instancedDrawCalls[G*2+1];d.draw(M,E,P,A),A+=E}d.end()}function so(e){let t=-1,a=0;e.instancedDrawCallCount=0;for(let p=0;p<e.spriteCount;p++){let v=e.spriteData[p*12+11]&65535;v!==t&&(a>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=a,e.instancedDrawCallCount++),t=v,a=0),a++}a>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=a,e.instancedDrawCallCount++)}function Xe(e,t){let p=Math.round(e.viewport.width/1),v=Math.round(e.viewport.height/1),d=It.ortho(0,p,v,0,-10,10);Rt.set(0,0,0,Ye);let M=It.translation(Ye);e.device.queue.writeBuffer(t.data.uniformBuffer,0,M.buffer),e.device.queue.writeBuffer(t.data.uniformBuffer,64,d.buffer)}function io(e){e.data.instancedDrawCalls=null,e.data.bindGroup=null,e.data.spriteBuffer.destroy(),e.data.spriteBuffer=null,e.data.uniformBuffer.destroy(),e.data.uniformBuffer=null,e.data.spriteData=null,e.data.spriteIndices.clear(),e.data.spriteIndices=null}var pe="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var $e={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(e,t={}){return co(e,t)},onRun:function(e,t,a){uo(e,t,a)},onDestroy:function(e,t){},onResize:function(e,t){fo(e,t)},onViewportPosition:function(e,t){}};async function co(e,t){let{device:a}=e,p=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),v=a.createBindGroup({layout:p,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]}),d=a.createPipelineLayout({bindGroupLayouts:[p]}),M=a.createRenderPipeline({label:"fb-blit",vertex:{module:a.createShaderModule({code:pe}),entryPoint:"vs_main",buffers:[]},fragment:{module:a.createShaderModule({code:pe}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:d});return{bindGroupLayout:p,bindGroup:v,pipeline:M}}function uo(e,t,a){let{device:p}=e,v=a.beginRenderPass({colorAttachments:[{view:t.refs.out,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});v.setPipeline(t.data.pipeline),v.setBindGroup(0,t.data.bindGroup),v.draw(3),v.end()}function fo(e,t){let{device:a}=e;t.data.bindGroup=a.createBindGroup({layout:t.data.bindGroupLayout,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]})}var je="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function jt(e,t,a,p,v,d=1){let M=Xt.sub(p,a),A=Xt.normalize(M),G=po(A),P=d/2,E=t.data.vertexCount*6;t.data.vertices[E+0]=a[0]+G[0]*P,t.data.vertices[E+1]=a[1]+G[1]*P,t.data.vertices[E+2]=v[0],t.data.vertices[E+3]=v[1],t.data.vertices[E+4]=v[2],t.data.vertices[E+5]=v[3],t.data.vertices[E+6]=a[0]-G[0]*P,t.data.vertices[E+7]=a[1]-G[1]*P,t.data.vertices[E+8]=v[0],t.data.vertices[E+9]=v[1],t.data.vertices[E+10]=v[2],t.data.vertices[E+11]=v[3],t.data.vertices[E+12]=p[0]+G[0]*P,t.data.vertices[E+13]=p[1]+G[1]*P,t.data.vertices[E+14]=v[0],t.data.vertices[E+15]=v[1],t.data.vertices[E+16]=v[2],t.data.vertices[E+17]=v[3],t.data.vertices[E+18]=a[0]-G[0]*P,t.data.vertices[E+19]=a[1]-G[1]*P,t.data.vertices[E+20]=v[0],t.data.vertices[E+21]=v[1],t.data.vertices[E+22]=v[2],t.data.vertices[E+23]=v[3],t.data.vertices[E+24]=p[0]+G[0]*P,t.data.vertices[E+25]=p[1]+G[1]*P,t.data.vertices[E+26]=v[0],t.data.vertices[E+27]=v[1],t.data.vertices[E+28]=v[2],t.data.vertices[E+29]=v[3],t.data.vertices[E+30]=p[0]-G[0]*P,t.data.vertices[E+31]=p[1]-G[1]*P,t.data.vertices[E+32]=v[0],t.data.vertices[E+33]=v[1],t.data.vertices[E+34]=v[2],t.data.vertices[E+35]=v[3],t.data.vertexCount+=6,e.device.queue.writeBuffer(t.data.vertexBuffer,0,t.data.vertices.buffer)}function po(e){return[-e[1],e[0]]}var Qe={line:jt,filledEllipse:function(e,t,a,p,v,d,M){let[A,G]=a,P=2*Math.PI/d;for(let E=0;E<d;E++){let O=E*P,Z=(E+1)*P,W=A+p*Math.cos(O),$=G+v*Math.sin(O),R=A+p*Math.cos(Z),it=G+v*Math.sin(Z),k=t.data.vertexCount*6+E*18;t.data.vertices[k+0]=A,t.data.vertices[k+1]=G,t.data.vertices[k+2]=M[0],t.data.vertices[k+3]=M[1],t.data.vertices[k+4]=M[2],t.data.vertices[k+5]=M[3],t.data.vertices[k+6]=W,t.data.vertices[k+7]=$,t.data.vertices[k+8]=M[0],t.data.vertices[k+9]=M[1],t.data.vertices[k+10]=M[2],t.data.vertices[k+11]=M[3],t.data.vertices[k+12]=R,t.data.vertices[k+13]=it,t.data.vertices[k+14]=M[0],t.data.vertices[k+15]=M[1],t.data.vertices[k+16]=M[2],t.data.vertices[k+17]=M[3]}t.data.vertexCount+=3*d,e.device.queue.writeBuffer(t.data.vertexBuffer,0,t.data.vertices.buffer)},box:function(e,t,a,p,v,d,M=0,A=1){let[G,P]=a,E=p/2,O=v/2,Z=[G-E,P-O],W=[G+E,P-O],$=[G-E,P+O],R=[G+E,P+O];M!==0&&(qt(Z,a,M,Z),qt(W,a,M,W),qt($,a,M,$),qt(R,a,M,R)),jt(e,t,Z,W,d,A),jt(e,t,$,R,d,A),jt(e,t,Z,$,d,A),jt(e,t,W,R,d,A)},filledBox:function(e,t,a,p,v,d,M=0){let[A,G]=a,P=p/2,E=v/2,O=[A-P,G-E],Z=[A+P,G-E],W=[A-P,G+E],$=[A+P,G+E];M!==0&&(qt(O,a,M,O),qt(Z,a,M,Z),qt(W,a,M,W),qt($,a,M,$));let R=t.data.vertexCount*6;t.data.vertices[R+0]=O[0],t.data.vertices[R+1]=O[1],t.data.vertices[R+2]=d[0],t.data.vertices[R+3]=d[1],t.data.vertices[R+4]=d[2],t.data.vertices[R+5]=d[3],t.data.vertices[R+6]=W[0],t.data.vertices[R+7]=W[1],t.data.vertices[R+8]=d[0],t.data.vertices[R+9]=d[1],t.data.vertices[R+10]=d[2],t.data.vertices[R+11]=d[3],t.data.vertices[R+12]=Z[0],t.data.vertices[R+13]=Z[1],t.data.vertices[R+14]=d[0],t.data.vertices[R+15]=d[1],t.data.vertices[R+16]=d[2],t.data.vertices[R+17]=d[3],t.data.vertices[R+18]=W[0],t.data.vertices[R+19]=W[1],t.data.vertices[R+20]=d[0],t.data.vertices[R+21]=d[1],t.data.vertices[R+22]=d[2],t.data.vertices[R+23]=d[3],t.data.vertices[R+24]=$[0],t.data.vertices[R+25]=$[1],t.data.vertices[R+26]=d[0],t.data.vertices[R+27]=d[1],t.data.vertices[R+28]=d[2],t.data.vertices[R+29]=d[3],t.data.vertices[R+30]=Z[0],t.data.vertices[R+31]=Z[1],t.data.vertices[R+32]=d[0],t.data.vertices[R+33]=d[1],t.data.vertices[R+34]=d[2],t.data.vertices[R+35]=d[3],t.data.vertexCount+=6,e.device.queue.writeBuffer(t.data.vertexBuffer,0,t.data.vertices.buffer)},clear:function(e,t){t.data.vertexCount=0}};function qt(e,t,a,p){let v=e[0]-t[0],d=e[1]-t[1],M=Math.sin(a),A=Math.cos(a);return p[0]=v*A-d*M+t[0],p[1]=v*M+d*A+t[1],p}var Ze=Rt.create(0,0,0),ke={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return mo(e,t)},onRun:function(e,t,a){vo(e,t,a)},onDestroy:function(e,t){xo(t)},onResize:function(e,t){Ke(e,t)},onViewportPosition:function(e,t){Ke(e,t)},customFunctions:Qe};async function mo(e,t){let{device:a}=e,p=new Float32Array(1e4),v=a.createBuffer({size:p.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),d=a.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),M=a.createShaderModule({code:je}),A=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),G=a.createPipelineLayout({bindGroupLayouts:[A]}),P=a.createBindGroup({layout:A,entries:[{binding:0,resource:{buffer:d}}]}),E=a.createRenderPipeline({layout:G,vertex:{module:M,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:M,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:d,vertexBuffer:v,pipeline:E,bindGroup:P,vertexCount:0,vertices:p}}function vo(e,t,a){if(t.data.vertexCount===0)return;let{device:p}=e,v=t.options.loadOp||"load",d=a.beginRenderPass({colorAttachments:[{view:t.refs.color,clearValue:e.clearValue,loadOp:v,storeOp:"store"}]});d.setPipeline(t.data.pipeline),d.setBindGroup(0,t.data.bindGroup),d.setVertexBuffer(0,t.data.vertexBuffer),d.draw(t.data.vertexCount),d.end()}function xo(e){e.data.vertexBuffer.destroy(),e.data.vertexBuffer=null,e.data.uniformBuffer.destroy(),e.data.uniformBuffer=null}function Ke(e,t){let{device:a}=e,p=e.viewport.width/e.viewport.zoom,v=e.viewport.height/e.viewport.zoom,d=It.ortho(0,p,v,0,-10,10);Rt.set(-e.viewport.position[0],-e.viewport.position[1],0,Ze);let M=It.translation(Ze);a.queue.writeBuffer(t.data.uniformBuffer,0,M.buffer),a.queue.writeBuffer(t.data.uniformBuffer,64,d.buffer)}var de="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.r*0.5,col.g*0.5,col.b*2.0,1.0);}";function Je(e){return`foo: ${e}`}var me={};be(me,{addLight:()=>go,removeLight:()=>yo});function go(e,t,a){t.data.lights.push({id:Ct(),position:Xt.clone(a)})}function yo(e,t,a){let p=t.data.lights.find(d=>d.id===a),v=t.data.lights.indexOf(p);v<0||t.data.lights.removeItem(v)}var tn={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return ho(e,t)},onRun:function(e,t,a){bo(e,t,a)},onDestroy:function(e,t){},onResize:function(e,t){_o(e,t)},onViewportPosition:function(e,t){},customFunctions:{...me}};async function ho(e,t){let{device:a}=e;console.log("test:",Je(Math.random()));let p=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),v=a.createBindGroup({layout:p,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]}),d=a.createPipelineLayout({bindGroupLayouts:[p]}),M=a.createRenderPipeline({label:"lights-shadows",vertex:{module:a.createShaderModule({code:de}),entryPoint:"vs_main"},fragment:{module:a.createShaderModule({code:de}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:d});return{bindGroupLayout:p,bindGroup:v,pipeline:M,lights:[]}}function bo(e,t,a){let{device:p}=e,v=a.beginRenderPass({colorAttachments:[{view:t.refs.out.data.view,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});v.setPipeline(t.data.pipeline),v.setBindGroup(0,t.data.bindGroup),v.draw(3),v.end()}function _o(e,t){let{device:a}=e;t.data.bindGroup=a.createBindGroup({layout:t.data.bindGroupLayout,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]})}var ve="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var Nt=new Float32Array(8),nn={type:"cobalt:tileAtlas",refs:[],onInit:async function(e,t={}){return So(e,t)},onRun:function(e,t,a){},onDestroy:function(e,t){To(data)},onResize:function(e,t){en(e,t)},onViewportPosition:function(e,t){en(e,t)}};async function So(e,t){let{device:a}=e,p=await Vt(e,"tile atlas",t.options.textureUrl),v=a.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),d=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),M=a.createBindGroup({layout:d,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:p.view},{binding:2,resource:p.sampler}]}),A=a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),G=a.createPipelineLayout({bindGroupLayouts:[A,d]});return{pipeline:a.createRenderPipeline({label:"tile",vertex:{module:a.createShaderModule({code:ve}),entryPoint:"vs_main",buffers:[]},fragment:{module:a.createShaderModule({code:ve}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:G}),uniformBuffer:v,atlasBindGroup:M,atlasMaterial:p,tileBindGroupLayout:A,tileSize:t.options.tileSize,tileScale:t.options.tileScale}}function To(e){e.atlasMaterial.texture.destroy(),e.atlasMaterial.texture=void 0}function en(e,t){Nt[0]=e.viewport.position[0],Nt[1]=e.viewport.position[1];let a=t.data,{tileScale:p,tileSize:v}=a,d=e.viewport.width/e.viewport.zoom,M=e.viewport.height/e.viewport.zoom;Nt[2]=d/p,Nt[3]=M/p,Nt[4]=1/a.atlasMaterial.texture.width,Nt[5]=1/a.atlasMaterial.texture.height,Nt[6]=v,Nt[7]=1/v,e.device.queue.writeBuffer(a.uniformBuffer,0,Nt,0,8)}function oe(e){let a=Object.keys(e.frames).length,p=new Float32Array(a*30),v=[],d={},M=0;for(let A in e.frames){let G=e.frames[A];v.push(A),d[A]=G.sourceSize;let P=-.5+G.spriteSourceSize.x/G.sourceSize.w,E=-.5+G.spriteSourceSize.y/G.sourceSize.h,O=-.5+(G.spriteSourceSize.x+G.spriteSourceSize.w)/G.sourceSize.w,Z=-.5+(G.spriteSourceSize.y+G.spriteSourceSize.h)/G.sourceSize.h,W=[P,E,0],$=[P,Z,0],R=[O,Z,0],it=[O,E,0],k=0+G.frame.x/e.meta.size.w,ct=0+G.frame.y/e.meta.size.h,ut=0+(G.frame.x+G.frame.w)/e.meta.size.w,wt=0+(G.frame.y+G.frame.h)/e.meta.size.h,dt=[k,ct],mt=[k,wt],St=[ut,wt],Tt=[ut,ct];p.set(W,M),p.set(dt,M+3),p.set($,M+5),p.set(mt,M+8),p.set(R,M+10),p.set(St,M+13),p.set(W,M+15),p.set(dt,M+18),p.set(R,M+20),p.set(St,M+23),p.set(it,M+25),p.set(Tt,M+28),M+=30}return{spriteMeta:d,locations:v,vertices:p}}var xe="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var on=Rt.create(0,0,0),sn={type:"cobalt:spritesheet",refs:[],onInit:async function(e,t={}){return Go(e,t)},onRun:function(e,t,a){},onDestroy:function(e,t){Eo(t)},onResize:function(e,t){rn(e,t)},onViewportPosition:function(e,t){rn(e,t)}};async function Go(e,t){let{canvas:a,device:p}=e,v,d,M;a?(v=await Bo(t.options.spriteSheetJsonUrl),v=oe(v),d=await Vt(e,"sprite",t.options.colorTextureUrl,"rgba8unorm"),M=await Vt(e,"emissive sprite",t.options.emissiveTextureUrl,"rgba8unorm"),a.style.imageRendering="pixelated"):(v=oe(t.options.spriteSheetJson),d=await Wt(e,"sprite",t.options.colorTexture,"rgba8unorm"),M=await Wt(e,"emissive sprite",t.options.emissiveTexture,"rgba8unorm"));let A=fe(p,v),G=p.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),P=p.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),E=p.createPipelineLayout({bindGroupLayouts:[P]});return{pipeline:p.createRenderPipeline({label:"sprite",vertex:{module:p.createShaderModule({code:xe}),entryPoint:"vs_main",buffers:[A.bufferLayout]},fragment:{module:p.createShaderModule({code:xe}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:E}),uniformBuffer:G,quads:A,colorTexture:d,emissiveTexture:M,bindGroupLayout:P,spritesheet:v}}function Eo(e){e.data.quads.buffer.destroy(),e.data.colorTexture.buffer.destroy(),e.data.uniformBuffer.destroy(),e.data.emissiveTexture.texture.destroy()}async function Bo(e){return(await fetch(e)).json()}function rn(e,t){let{device:a,viewport:p}=e,v=p.width/p.zoom,d=p.height/p.zoom,M=It.ortho(0,v,d,0,-10,10);Rt.set(-p.position[0],-p.position[1],0,on);let A=It.translation(on);a.queue.writeBuffer(t.data.uniformBuffer,0,A.buffer),a.queue.writeBuffer(t.data.uniformBuffer,64,M.buffer)}var an={type:"fbTexture",refs:[],onInit:async function(e,t={}){return zo(e,t)},onRun:function(e,t,a){},onDestroy:function(e,t){cn(data)},onResize:function(e,t){Uo(e,t)},onViewportPosition:function(e,t){}};async function zo(e,t){let{device:a}=e,{label:p,mip_count:v,format:d,usage:M,viewportScale:A}=t.options;return zt(a,p,e.viewport.width*A,e.viewport.height*A,v,d,M)}function cn(e){e.data.texture.destroy()}function Uo(e,t){let{device:a}=e;cn(t);let{width:p,height:v}=e.viewport,{options:d}=t,M=t.options.viewportScale;t.data=zt(a,d.label,p*M,v*M,d.mip_count,d.format,d.usage)}async function Hs(e,t,a){let p,v,d,M;return e.sdlWindow&&e.gpu?(v=e.gpu,p=await(await v.create(["verbose=1"]).requestAdapter()).requestDevice(),d=v.renderGPUDeviceToWindow({device:p,window:e.sdlWindow}),global.GPUBufferUsage=v.GPUBufferUsage,global.GPUShaderStage=v.GPUShaderStage,global.GPUTextureUsage=v.GPUTextureUsage):(M=e,p=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),v=navigator.gpu,d=M.getContext("webgpu"),d.configure({device:p,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":nn,"cobalt:spritesheet":sn,"cobalt:fbTexture":an,"cobalt:bloom":Te,"cobalt:composite":Ee,"cobalt:sprite":Ue,"cobalt:tile":Pe,"cobalt:displacement":Ce,"cobalt:overlay":He,"cobalt:fbBlit":$e,"cobalt:primitives":ke,"cobalt:light":tn},nodes:[],defaultTextureViewRefs:[],canvas:M,device:p,context:d,gpu:v,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:t,height:a,zoom:1,position:[0,0]}}}function $s(e,t){if(!t?.type)throw new Error("Can't define a new node missing a type.");e.nodeDefs[t.type]=t}async function js(e,t){let a=e.nodeDefs[t?.type];if(!a)throw new Error("Can't initialize a new node missing a type.");let p={type:t.type,refs:t.refs||{},options:t.options||{},data:{},enabled:!0};for(let d in p.refs)p.refs[d]==="FRAME_TEXTURE_VIEW"&&(e.defaultTextureViewRefs.push({node:p,refName:d}),p.refs[d]=un(e));p.data=await a.onInit(e,p);let v=a.customFunctions||{};for(let d in v)p[d]=function(...M){return v[d](e,p,...M)};return e.nodes.push(p),p}function Qs(e){let{device:t,context:a}=e,p=t.createCommandEncoder(),v=un(e);for(let d of e.defaultTextureViewRefs)d.node.refs[d.refName]=v;for(let d of e.nodes){if(!d.enabled)continue;e.nodeDefs[d.type].onRun(e,d,p)}t.queue.submit([p.finish()]),e.canvas||e.context.swap()}function Zs(e){for(let t of e.nodes)e.nodeDefs[t.type].onDestroy(e,t);e.nodes.length=0,e.defaultTextureViewRefs.length=0}function Ks(e,t,a){e.viewport.width=t,e.viewport.height=a;for(let p of e.nodes)e.nodeDefs[p.type].onResize(e,p)}function ks(e,t){e.viewport.position[0]=t[0]-e.viewport.width/2/e.viewport.zoom,e.viewport.position[1]=t[1]-e.viewport.height/2/e.viewport.zoom;for(let a of e.nodes)e.nodeDefs[a.type].onViewportPosition(e,a)}function Be(e){return e.canvas?navigator.gpu.getPreferredCanvasFormat():e.context.getPreferredFormat()}function un(e){return e.canvas?e.context.getCurrentTexture().createView():e.context.getCurrentTextureView()}export{zt as createTexture,Wt as createTextureFromBuffer,Vt as createTextureFromUrl,$s as defineNode,Qs as draw,un as getCurrentTextureView,Be as getPreferredFormat,Hs as init,js as initNode,Zs as reset,Ks as setViewportDimensions,ks as setViewportPosition};

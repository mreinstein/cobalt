var Tn=Object.defineProperty;var Ge=(r,s)=>{for(var v in s)Tn(r,v,{get:s[v],enumerable:!0})};function Rt(r,s,v,m,_,T,P){let G=r.createTexture({label:s,size:{width:v,height:m},format:T,usage:P,mipLevelCount:_,sampleCount:1,dimension:"2d"}),z=G.createView(),U=[];for(let R=0;R<_;R++)U.push(G.createView({label:s,format:T,dimension:"2d",aspect:"all",baseMipLevel:R,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let B=r.createSampler({label:`${s} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:v,height:m},texture:G,view:z,mip_view:U,sampler:B}}async function $t(r,s,v,m="rgba8unorm"){let T=await(await fetch(v)).blob(),P=await createImageBitmap(T),G=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,U=Rt(r.device,s,P.width,P.height,1,m,G);r.device.queue.copyExternalImageToTexture({source:P},{texture:U.texture},{width:P.width,height:P.height});let B={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return U.sampler=r.device.createSampler(B),U}function oe(r,s,v,m="rgba8unorm"){let _=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,P=Rt(r.device,s,v.width,v.height,1,m,_);r.device.queue.writeTexture({texture:P.texture},v.data,{bytesPerRow:4*v.width},{width:v.width,height:v.height});let G={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return P.sampler=r.device.createSampler(G),P}var Ue="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var qt=7,Pn=0,Le=1,Bn=2,Ee=3,Ae={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(r,s={}){return zn(r,s)},onRun:function(r,s,v){Gn(r,s.data,v)},onDestroy:function(r,s){Fe(s)},onResize:function(r,s){Un(r,s)},onViewportPosition:function(r,s){}};function zn(r,s){let{device:v}=r,m=r.viewport.width,_=r.viewport.height,T={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},P=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});T.bind_group_layout.push(P),T.bind_groups_textures.push(Rt(v,"bloom downsampler image 0",m/2,_/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),T.bind_groups_textures.push(Rt(v,"bloom downsampler image 1",m/2,_/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),T.bind_groups_textures.push(s.refs.bloom.data);let G=v.createPipelineLayout({bindGroupLayouts:T.bind_group_layout}),z=v.createComputePipeline({layout:G,compute:{module:v.createShaderModule({code:Ue}),entryPoint:"cs_main"}});return Ie(r,T,s),T.compute_pipeline=z,T}function Ie(r,s,v){let{refs:m}=v,{device:_}=r,T=v.options.bloom_threshold??.1,P=v.options.bloom_knee??.2,G=v.options.bloom_combine_constant??.68,z=new Float32Array([T,T-P,P*2,.25/P,G,0,0,0]),U=_.createBuffer({label:"bloom static parameters buffer",size:z.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(U.getMappedRange()).set(z),U.unmap(),s.bind_group.length=0,s.params_buf=U,s.bind_group.push(Jt(_,s,s.bind_groups_textures[0].mip_view[0],m.emissive.data.view,m.hdr.data.view,m.hdr.data.sampler,U,Pn<<16|0));for(let R=1;R<qt;R++)s.bind_group.push(Jt(_,s,s.bind_groups_textures[1].mip_view[R],s.bind_groups_textures[0].view,m.hdr.data.view,m.hdr.data.sampler,U,Le<<16|R-1)),s.bind_group.push(Jt(_,s,s.bind_groups_textures[0].mip_view[R],s.bind_groups_textures[1].view,m.hdr.data.view,m.hdr.data.sampler,U,Le<<16|R));s.bind_group.push(Jt(_,s,s.bind_groups_textures[2].mip_view[qt-1],s.bind_groups_textures[0].view,m.hdr.data.view,m.hdr.data.sampler,U,Bn<<16|qt-2));let B=!0;for(let R=qt-2;R>=0;R--)B?(s.bind_group.push(Jt(_,s,s.bind_groups_textures[1].mip_view[R],s.bind_groups_textures[0].view,s.bind_groups_textures[2].view,m.hdr.data.sampler,U,Ee<<16|R)),B=!1):(s.bind_group.push(Jt(_,s,s.bind_groups_textures[2].mip_view[R],s.bind_groups_textures[0].view,s.bind_groups_textures[1].view,m.hdr.data.sampler,U,Ee<<16|R)),B=!0)}function Jt(r,s,v,m,_,T,P,G){let z=new Uint32Array([G]),U=r.createBuffer({label:"bloom static mode_lod buffer",size:z.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(U.getMappedRange()).set(z),U.unmap(),r.createBindGroup({label:"bloom bind group layout",layout:s.bind_group_layout[0],entries:[{binding:0,resource:v},{binding:1,resource:m},{binding:2,resource:_},{binding:3,resource:T},{binding:4,resource:{buffer:P}},{binding:5,resource:{buffer:U}}]})}function Gn(r,s,v){let G=0,z=v.beginComputePass({label:"bloom Compute Pass"});z.setPipeline(s.compute_pipeline),z.setBindGroup(0,s.bind_group[G]),G+=1;let U=ce(0,s.bind_groups_textures[0]);z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);for(let B=1;B<qt;B++)U=ce(B,s.bind_groups_textures[0]),z.setBindGroup(0,s.bind_group[G]),G+=1,z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1),z.setBindGroup(0,s.bind_group[G]),G+=1,z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);z.setBindGroup(0,s.bind_group[G]),G+=1,U=ce(qt-1,s.bind_groups_textures[2]),z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);for(let B=qt-2;B>=0;B--)U=ce(B,s.bind_groups_textures[2]),z.setBindGroup(0,s.bind_group[G]),G+=1,z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);z.end()}function ce(r,s){let v=s.size.width,m=s.size.height;for(let _=0;_<r;_++)v/=2,m/=2;return{width:v,height:m,depthOrArrayLayers:1}}function Un(r,s){let{device:v}=r,m=s.data;Fe(m),m.bind_groups_textures.push(Rt(v,"bloom downsampler image 0",r.viewport.width/2,r.viewport.height/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),m.bind_groups_textures.push(Rt(v,"bloom downsampler image 1",r.viewport.width/2,r.viewport.height/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),m.bind_groups_textures.push(s.refs.bloom.data),Ie(r,m,s)}function Fe(r){for(let s of r.bind_groups_textures)s.texture.destroy();r.bind_groups_textures.length=0}var ve="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Re={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(r,s={}){return En(r,s)},onRun:function(r,s,v){An(r,s,v)},onDestroy:function(r,s){},onResize:function(r,s){In(r,s)},onViewportPosition:function(r,s){}};function En(r,s){let{options:v,refs:m}=s,{device:_}=r,T=Oe(r),P=v.bloom_intensity??40,G=v.bloom_combine_constant??.68,z=new Float32Array([P,G]),U=_.createBuffer({label:"scene composite params buffer",size:z.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(U.getMappedRange()).set(z),U.unmap();let B=_.createRenderPipeline({layout:"auto",vertex:{module:_.createShaderModule({code:ve}),entryPoint:"vert_main"},fragment:{module:_.createShaderModule({code:ve}),entryPoint:"frag_main",targets:[{format:T}]},primitive:{topology:"triangle-list"}});return{bindGroup:_.createBindGroup({layout:B.getBindGroupLayout(0),entries:[{binding:0,resource:m.hdr.data.sampler},{binding:1,resource:m.hdr.data.view},{binding:2,resource:m.bloom.data.mip_view[0]},{binding:3,resource:{buffer:U}}]}),pipeline:B,params_buf:U}}function An(r,s,v){let m=v.beginRenderPass({colorAttachments:[{view:s.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:_,bindGroup:T}=s.data;m.setPipeline(_),m.setBindGroup(0,T),m.draw(3),m.end()}function In(r,s){let{pipeline:v,params_buf:m}=s.data,{device:_}=r;s.data.bindGroup=_.createBindGroup({layout:v.getBindGroupLayout(0),entries:[{binding:0,resource:s.refs.hdr.data.sampler},{binding:1,resource:s.refs.hdr.data.view},{binding:2,resource:s.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:m}}]})}var re={};Ge(re,{addSprite:()=>Rn,clear:()=>Vn,removeSprite:()=>On,setSprite:()=>Hn,setSpriteName:()=>qn,setSpriteOpacity:()=>Yn,setSpritePosition:()=>Nn,setSpriteRotation:()=>Xn,setSpriteTint:()=>$n});function me(r,s,v){if(v.spriteCount===0)return 0;let m=0,_=v.spriteCount-1,T=r<<16&16711680|s&65535;for(;m<=_;){let P=v.spriteData[m*12+11];if(T<=P)return m;let G=v.spriteData[_*12+11];if(T>=G)return _+1;let z=Math.floor((m+_)/2),U=v.spriteData[z*12+11];if(T===U)return z+1;T>U?m=z+1:_=z-1}return m}function se(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function Rn(r,s,v,m,_,T,P,G,z){let U=s.refs.spritesheet.data.spritesheet;s=s.data;let B=U.locations.indexOf(v),R=me(z,B,s),H=(R+1)*12;s.spriteData.set(s.spriteData.subarray(R*12,s.spriteCount*12),H),Ve(s,U,R,v,m,_,T,P,G,z);for(let[Y,F]of s.spriteIndices)F>=R&&s.spriteIndices.set(Y,F+1);let $=se();return s.spriteIndices.set($,R),s.spriteCount++,s.dirty=!0,$}function On(r,s,v){s=s.data;let m=s.spriteIndices.get(v);for(let[T,P]of s.spriteIndices)P>m&&s.spriteIndices.set(T,P-1);let _=m*12;s.spriteData.set(s.spriteData.subarray((m+1)*12,s.spriteCount*12),_),s.spriteIndices.delete(v),s.spriteCount--,s.dirty=!0}function Vn(r,s){s=s.data,s.spriteIndices.clear(),s.spriteCount=0,s.instancedDrawCallCount=0,s.dirty=!0}function qn(r,s,v,m,_){let T=s.refs.spritesheet.data.spritesheet;s=s.data;let P=T.locations.indexOf(m),G=T.spriteMeta[m].w,z=T.spriteMeta[m].h,B=s.spriteIndices.get(v)*12;s.spriteData[B+2]=G*_[0],s.spriteData[B+3]=z*_[1];let H=(s.spriteData[B+11]>>16&255)<<16&16711680|P&65535;s.spriteData[B+11]=H,s.dirty=!0}function Nn(r,s,v,m){s=s.data;let T=s.spriteIndices.get(v)*12;s.spriteData[T]=m[0],s.spriteData[T+1]=m[1],s.dirty=!0}function $n(r,s,v,m){s=s.data;let T=s.spriteIndices.get(v)*12;s.spriteData[T+4]=m[0],s.spriteData[T+5]=m[1],s.spriteData[T+6]=m[2],s.spriteData[T+7]=m[3],s.dirty=!0}function Yn(r,s,v,m){s=s.data;let T=s.spriteIndices.get(v)*12;s.spriteData[T+8]=m,s.dirty=!0}function Xn(r,s,v,m){s=s.data;let T=s.spriteIndices.get(v)*12;s.spriteData[T+9]=m,s.dirty=!0}function Hn(r,s,v,m,_,T,P,G,z,U){let B=s.refs.spritesheet.data.spritesheet;s=s.data;let R=s.spriteIndices.get(v);Ve(s,B,R,m,_,T,P,G,z,U),s.dirty=!0}function Ve(r,s,v,m,_,T,P,G,z,U){if(!s.spriteMeta[m])throw new Error(`Sprite name ${m} could not be found in the spritesheet metaData`);let B=v*12,R=s.spriteMeta[m].w,H=s.spriteMeta[m].h,$=s.locations.indexOf(m),Y=U<<16&16711680|$&65535;r.spriteData[B]=_[0],r.spriteData[B+1]=_[1],r.spriteData[B+2]=R*T[0],r.spriteData[B+3]=H*T[1],r.spriteData[B+4]=P[0],r.spriteData[B+5]=P[1],r.spriteData[B+6]=P[2],r.spriteData[B+7]=P[3],r.spriteData[B+8]=G,r.spriteData[B+9]=z,r.spriteData[B+11]=Y}var qe={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(r,s={}){return jn(r,s)},onRun:function(r,s,v){Wn(r,s,v)},onDestroy:function(r,s){Qn(s)},onResize:function(r,s){},onViewportPosition:function(r,s){},customFunctions:{...re}};async function jn(r,s){let{device:v}=r,m=16192,_=m,P=Float32Array.BYTES_PER_ELEMENT*2,z=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*4,H=Float32Array.BYTES_PER_ELEMENT*4,$=v.createBuffer({size:(P+z+B+H)*_,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Y=s.refs.spritesheet.data,F=v.createBindGroup({layout:s.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:Y.uniformBuffer}},{binding:1,resource:Y.colorTexture.view},{binding:2,resource:Y.colorTexture.sampler},{binding:3,resource:{buffer:$}},{binding:4,resource:Y.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(m*2),instancedDrawCallCount:0,bindGroup:F,spriteBuffer:$,spriteData:new Float32Array(m*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Wn(r,s,v){let{device:m}=r,_=s.options.loadOp||"load";s.data.dirty&&(Zn(s.data),s.data.dirty=!1),m.queue.writeBuffer(s.data.spriteBuffer,0,s.data.spriteData.buffer);let T=v.beginRenderPass({colorAttachments:[{view:s.refs.hdr.data.view,clearValue:r.clearValue,loadOp:_,storeOp:"store"},{view:s.refs.emissive.data.view,clearValue:r.clearValue,loadOp:"clear",storeOp:"store"}]});T.setPipeline(s.refs.spritesheet.data.pipeline),T.setBindGroup(0,s.data.bindGroup),T.setVertexBuffer(0,s.refs.spritesheet.data.quads.buffer);let P=6,G=0;for(let z=0;z<s.data.instancedDrawCallCount;z++){let U=s.data.instancedDrawCalls[z*2]*P,B=s.data.instancedDrawCalls[z*2+1];T.draw(P,B,U,G),G+=B}T.end()}function Zn(r){let s=-1,v=0;r.instancedDrawCallCount=0;for(let m=0;m<r.spriteCount;m++){let _=r.spriteData[m*12+11]&65535;_!==s&&(v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=s,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++),s=_,v=0),v++}v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=s,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++)}function Qn(r){r.data.instancedDrawCalls=null,r.data.bindGroup=null,r.data.spriteBuffer.destroy(),r.data.spriteBuffer=null,r.data.spriteData=null,r.data.spriteIndices.clear(),r.data.spriteIndices=null}var $e={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(r,s={}){return kn(r,s)},onRun:function(r,s,v){Kn(r,s,v)},onDestroy:function(r,s){Ne(s)},onResize:function(r,s){},onViewportPosition:function(r,s){},customFunctions:{setTexture:async function(r,s,v){let{device:m}=r;Ne(s),s.options.textureUrl=v;let _=await $t(r,"tile map",s.options.textureUrl),T=m.createBindGroup({layout:s.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:s.data.uniformBuffer}},{binding:1,resource:_.view},{binding:2,resource:_.sampler}]});s.data.bindGroup=T,s.data.material=_}}};async function kn(r,s){let{device:v}=r,m=await $t(r,"tile map",s.options.textureUrl),_=new Float32Array([s.options.scrollScale,s.options.scrollScale]),T=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,P={size:_.byteLength,usage:T,mappedAtCreation:!0},G=v.createBuffer(P);return new Float32Array(G.getMappedRange()).set(_),G.unmap(),{bindGroup:v.createBindGroup({layout:s.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:G}},{binding:1,resource:m.view},{binding:2,resource:m.sampler}]}),material:m,uniformBuffer:G,scrollScale:s.options.scrollScale}}function Kn(r,s,v){let{device:m}=r,_=s.options.loadOp||"load",T=v.beginRenderPass({colorAttachments:[{view:s.refs.hdr.data.view,clearValue:r.clearValue,loadOp:_,storeOp:"store"}]}),P=s.refs.tileAtlas.data;T.setPipeline(P.pipeline),T.setBindGroup(0,s.data.bindGroup),T.setBindGroup(1,P.atlasBindGroup),T.draw(3),T.end()}function Ne(r){r.data.material.texture.destroy(),r.data.material.texture=void 0}var ye="struct TransformData{model:mat4x4<f32>,view:mat4x4<f32>,projection:mat4x4<f32>,};struct displacement_param{offset:vec2<f32>,scale:f32,noop:f32,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:displacement_param;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*transformUBO.model*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";function to(r,s){return class extends r{constructor(...v){super(...v),s(this)}}}var eo=to(Array,r=>r.fill(0)),Q=1e-6;function no(r){function s(t=0,a=0){let e=new r(2);return t!==void 0&&(e[0]=t,a!==void 0&&(e[1]=a)),e}let v=s;function m(t,a,e){let o=e??new r(2);return o[0]=t,o[1]=a,o}function _(t,a){let e=a??new r(2);return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function T(t,a){let e=a??new r(2);return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function P(t,a){let e=a??new r(2);return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function G(t,a=0,e=1,o){let f=o??new r(2);return f[0]=Math.min(e,Math.max(a,t[0])),f[1]=Math.min(e,Math.max(a,t[1])),f}function z(t,a,e){let o=e??new r(2);return o[0]=t[0]+a[0],o[1]=t[1]+a[1],o}function U(t,a,e,o){let f=o??new r(2);return f[0]=t[0]+a[0]*e,f[1]=t[1]+a[1]*e,f}function B(t,a){let e=t[0],o=t[1],f=a[0],g=a[1],D=Math.sqrt(e*e+o*o),u=Math.sqrt(f*f+g*g),l=D*u,w=l&&bt(t,a)/l;return Math.acos(w)}function R(t,a,e){let o=e??new r(2);return o[0]=t[0]-a[0],o[1]=t[1]-a[1],o}let H=R;function $(t,a){return Math.abs(t[0]-a[0])<Q&&Math.abs(t[1]-a[1])<Q}function Y(t,a){return t[0]===a[0]&&t[1]===a[1]}function F(t,a,e,o){let f=o??new r(2);return f[0]=t[0]+e*(a[0]-t[0]),f[1]=t[1]+e*(a[1]-t[1]),f}function et(t,a,e,o){let f=o??new r(2);return f[0]=t[0]+e[0]*(a[0]-t[0]),f[1]=t[1]+e[1]*(a[1]-t[1]),f}function j(t,a,e){let o=e??new r(2);return o[0]=Math.max(t[0],a[0]),o[1]=Math.max(t[1],a[1]),o}function C(t,a,e){let o=e??new r(2);return o[0]=Math.min(t[0],a[0]),o[1]=Math.min(t[1],a[1]),o}function tt(t,a,e){let o=e??new r(2);return o[0]=t[0]*a,o[1]=t[1]*a,o}let Mt=tt;function ft(t,a,e){let o=e??new r(2);return o[0]=t[0]/a,o[1]=t[1]/a,o}function lt(t,a){let e=a??new r(2);return e[0]=1/t[0],e[1]=1/t[1],e}let Dt=lt;function vt(t,a,e){let o=e??new r(3),f=t[0]*a[1]-t[1]*a[0];return o[0]=0,o[1]=0,o[2]=f,o}function bt(t,a){return t[0]*a[0]+t[1]*a[1]}function nt(t){let a=t[0],e=t[1];return Math.sqrt(a*a+e*e)}let Bt=nt;function q(t){let a=t[0],e=t[1];return a*a+e*e}let X=q;function V(t,a){let e=t[0]-a[0],o=t[1]-a[1];return Math.sqrt(e*e+o*o)}let Gt=V;function dt(t,a){let e=t[0]-a[0],o=t[1]-a[1];return e*e+o*o}let Ut=dt;function pt(t,a){let e=a??new r(2),o=t[0],f=t[1],g=Math.sqrt(o*o+f*f);return g>1e-5?(e[0]=o/g,e[1]=f/g):(e[0]=0,e[1]=0),e}function Lt(t,a){let e=a??new r(2);return e[0]=-t[0],e[1]=-t[1],e}function W(t,a){let e=a??new r(2);return e[0]=t[0],e[1]=t[1],e}let Et=W;function mt(t,a,e){let o=e??new r(2);return o[0]=t[0]*a[0],o[1]=t[1]*a[1],o}let At=mt;function yt(t,a,e){let o=e??new r(2);return o[0]=t[0]/a[0],o[1]=t[1]/a[1],o}let zt=yt;function St(t=1,a){let e=a??new r(2),o=Math.random()*2*Math.PI;return e[0]=Math.cos(o)*t,e[1]=Math.sin(o)*t,e}function i(t){let a=t??new r(2);return a[0]=0,a[1]=0,a}function p(t,a,e){let o=e??new r(2),f=t[0],g=t[1];return o[0]=f*a[0]+g*a[4]+a[12],o[1]=f*a[1]+g*a[5]+a[13],o}function n(t,a,e){let o=e??new r(2),f=t[0],g=t[1];return o[0]=a[0]*f+a[4]*g+a[8],o[1]=a[1]*f+a[5]*g+a[9],o}function c(t,a,e,o){let f=o??new r(2),g=t[0]-a[0],D=t[1]-a[1],u=Math.sin(e),l=Math.cos(e);return f[0]=g*l-D*u+a[0],f[1]=g*u+D*l+a[1],f}function d(t,a,e){let o=e??new r(2);return pt(t,o),tt(o,a,o)}function h(t,a,e){let o=e??new r(2);return nt(t)>a?d(t,a,o):W(t,o)}function M(t,a,e){let o=e??new r(2);return F(t,a,.5,o)}return{create:s,fromValues:v,set:m,ceil:_,floor:T,round:P,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:H,equalsApproximately:$,equals:Y,lerp:F,lerpV:et,max:j,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:lt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:X,distance:V,dist:Gt,distanceSq:dt,distSq:Ut,normalize:pt,negate:Lt,copy:W,clone:Et,multiply:mt,mul:At,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat3:n,rotate:c,setLength:d,truncate:h,midpoint:M}}var Ye=new Map;function Qe(r){let s=Ye.get(r);return s||(s=no(r),Ye.set(r,s)),s}function oo(r){function s(u,l,w){let x=new r(3);return u!==void 0&&(x[0]=u,l!==void 0&&(x[1]=l,w!==void 0&&(x[2]=w))),x}let v=s;function m(u,l,w,x){let y=x??new r(3);return y[0]=u,y[1]=l,y[2]=w,y}function _(u,l){let w=l??new r(3);return w[0]=Math.ceil(u[0]),w[1]=Math.ceil(u[1]),w[2]=Math.ceil(u[2]),w}function T(u,l){let w=l??new r(3);return w[0]=Math.floor(u[0]),w[1]=Math.floor(u[1]),w[2]=Math.floor(u[2]),w}function P(u,l){let w=l??new r(3);return w[0]=Math.round(u[0]),w[1]=Math.round(u[1]),w[2]=Math.round(u[2]),w}function G(u,l=0,w=1,x){let y=x??new r(3);return y[0]=Math.min(w,Math.max(l,u[0])),y[1]=Math.min(w,Math.max(l,u[1])),y[2]=Math.min(w,Math.max(l,u[2])),y}function z(u,l,w){let x=w??new r(3);return x[0]=u[0]+l[0],x[1]=u[1]+l[1],x[2]=u[2]+l[2],x}function U(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+l[0]*w,y[1]=u[1]+l[1]*w,y[2]=u[2]+l[2]*w,y}function B(u,l){let w=u[0],x=u[1],y=u[2],b=l[0],S=l[1],E=l[2],I=Math.sqrt(w*w+x*x+y*y),L=Math.sqrt(b*b+S*S+E*E),A=I*L,O=A&&bt(u,l)/A;return Math.acos(O)}function R(u,l,w){let x=w??new r(3);return x[0]=u[0]-l[0],x[1]=u[1]-l[1],x[2]=u[2]-l[2],x}let H=R;function $(u,l){return Math.abs(u[0]-l[0])<Q&&Math.abs(u[1]-l[1])<Q&&Math.abs(u[2]-l[2])<Q}function Y(u,l){return u[0]===l[0]&&u[1]===l[1]&&u[2]===l[2]}function F(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w*(l[0]-u[0]),y[1]=u[1]+w*(l[1]-u[1]),y[2]=u[2]+w*(l[2]-u[2]),y}function et(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w[0]*(l[0]-u[0]),y[1]=u[1]+w[1]*(l[1]-u[1]),y[2]=u[2]+w[2]*(l[2]-u[2]),y}function j(u,l,w){let x=w??new r(3);return x[0]=Math.max(u[0],l[0]),x[1]=Math.max(u[1],l[1]),x[2]=Math.max(u[2],l[2]),x}function C(u,l,w){let x=w??new r(3);return x[0]=Math.min(u[0],l[0]),x[1]=Math.min(u[1],l[1]),x[2]=Math.min(u[2],l[2]),x}function tt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l,x[1]=u[1]*l,x[2]=u[2]*l,x}let Mt=tt;function ft(u,l,w){let x=w??new r(3);return x[0]=u[0]/l,x[1]=u[1]/l,x[2]=u[2]/l,x}function lt(u,l){let w=l??new r(3);return w[0]=1/u[0],w[1]=1/u[1],w[2]=1/u[2],w}let Dt=lt;function vt(u,l,w){let x=w??new r(3),y=u[2]*l[0]-u[0]*l[2],b=u[0]*l[1]-u[1]*l[0];return x[0]=u[1]*l[2]-u[2]*l[1],x[1]=y,x[2]=b,x}function bt(u,l){return u[0]*l[0]+u[1]*l[1]+u[2]*l[2]}function nt(u){let l=u[0],w=u[1],x=u[2];return Math.sqrt(l*l+w*w+x*x)}let Bt=nt;function q(u){let l=u[0],w=u[1],x=u[2];return l*l+w*w+x*x}let X=q;function V(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return Math.sqrt(w*w+x*x+y*y)}let Gt=V;function dt(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return w*w+x*x+y*y}let Ut=dt;function pt(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=Math.sqrt(x*x+y*y+b*b);return S>1e-5?(w[0]=x/S,w[1]=y/S,w[2]=b/S):(w[0]=0,w[1]=0,w[2]=0),w}function Lt(u,l){let w=l??new r(3);return w[0]=-u[0],w[1]=-u[1],w[2]=-u[2],w}function W(u,l){let w=l??new r(3);return w[0]=u[0],w[1]=u[1],w[2]=u[2],w}let Et=W;function mt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l[0],x[1]=u[1]*l[1],x[2]=u[2]*l[2],x}let At=mt;function yt(u,l,w){let x=w??new r(3);return x[0]=u[0]/l[0],x[1]=u[1]/l[1],x[2]=u[2]/l[2],x}let zt=yt;function St(u=1,l){let w=l??new r(3),x=Math.random()*2*Math.PI,y=Math.random()*2-1,b=Math.sqrt(1-y*y)*u;return w[0]=Math.cos(x)*b,w[1]=Math.sin(x)*b,w[2]=y*u,w}function i(u){let l=u??new r(3);return l[0]=0,l[1]=0,l[2]=0,l}function p(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2],E=l[3]*y+l[7]*b+l[11]*S+l[15]||1;return x[0]=(l[0]*y+l[4]*b+l[8]*S+l[12])/E,x[1]=(l[1]*y+l[5]*b+l[9]*S+l[13])/E,x[2]=(l[2]*y+l[6]*b+l[10]*S+l[14])/E,x}function n(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0*4+0]+b*l[1*4+0]+S*l[2*4+0],x[1]=y*l[0*4+1]+b*l[1*4+1]+S*l[2*4+1],x[2]=y*l[0*4+2]+b*l[1*4+2]+S*l[2*4+2],x}function c(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0]+b*l[4]+S*l[8],x[1]=y*l[1]+b*l[5]+S*l[9],x[2]=y*l[2]+b*l[6]+S*l[10],x}function d(u,l,w){let x=w??new r(3),y=l[0],b=l[1],S=l[2],E=l[3]*2,I=u[0],L=u[1],A=u[2],O=b*A-S*L,N=S*I-y*A,Z=y*L-b*I;return x[0]=I+O*E+(b*Z-S*N)*2,x[1]=L+N*E+(S*O-y*Z)*2,x[2]=A+Z*E+(y*N-b*O)*2,x}function h(u,l){let w=l??new r(3);return w[0]=u[12],w[1]=u[13],w[2]=u[14],w}function M(u,l,w){let x=w??new r(3),y=l*4;return x[0]=u[y+0],x[1]=u[y+1],x[2]=u[y+2],x}function t(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=u[4],E=u[5],I=u[6],L=u[8],A=u[9],O=u[10];return w[0]=Math.sqrt(x*x+y*y+b*b),w[1]=Math.sqrt(S*S+E*E+I*I),w[2]=Math.sqrt(L*L+A*A+O*O),w}function a(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0],S[1]=b[1]*Math.cos(w)-b[2]*Math.sin(w),S[2]=b[1]*Math.sin(w)+b[2]*Math.cos(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function e(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[2]*Math.sin(w)+b[0]*Math.cos(w),S[1]=b[1],S[2]=b[2]*Math.cos(w)-b[0]*Math.sin(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function o(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0]*Math.cos(w)-b[1]*Math.sin(w),S[1]=b[0]*Math.sin(w)+b[1]*Math.cos(w),S[2]=b[2],y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function f(u,l,w){let x=w??new r(3);return pt(u,x),tt(x,l,x)}function g(u,l,w){let x=w??new r(3);return nt(u)>l?f(u,l,x):W(u,x)}function D(u,l,w){let x=w??new r(3);return F(u,l,.5,x)}return{create:s,fromValues:v,set:m,ceil:_,floor:T,round:P,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:H,equalsApproximately:$,equals:Y,lerp:F,lerpV:et,max:j,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:lt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:X,distance:V,dist:Gt,distanceSq:dt,distSq:Ut,normalize:pt,negate:Lt,copy:W,clone:Et,multiply:mt,mul:At,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat4Upper3x3:n,transformMat3:c,transformQuat:d,getTranslation:h,getAxis:M,getScaling:t,rotateX:a,rotateY:e,rotateZ:o,setLength:f,truncate:g,midpoint:D}}var Xe=new Map;function ae(r){let s=Xe.get(r);return s||(s=oo(r),Xe.set(r,s)),s}function so(r){let s=Qe(r),v=ae(r);function m(i,p,n,c,d,h,M,t,a){let e=new r(12);return e[3]=0,e[7]=0,e[11]=0,i!==void 0&&(e[0]=i,p!==void 0&&(e[1]=p,n!==void 0&&(e[2]=n,c!==void 0&&(e[4]=c,d!==void 0&&(e[5]=d,h!==void 0&&(e[6]=h,M!==void 0&&(e[8]=M,t!==void 0&&(e[9]=t,a!==void 0&&(e[10]=a))))))))),e}function _(i,p,n,c,d,h,M,t,a,e){let o=e??new r(12);return o[0]=i,o[1]=p,o[2]=n,o[3]=0,o[4]=c,o[5]=d,o[6]=h,o[7]=0,o[8]=M,o[9]=t,o[10]=a,o[11]=0,o}function T(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=0,n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=0,n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=0,n}function P(i,p){let n=p??new r(12),c=i[0],d=i[1],h=i[2],M=i[3],t=c+c,a=d+d,e=h+h,o=c*t,f=d*t,g=d*a,D=h*t,u=h*a,l=h*e,w=M*t,x=M*a,y=M*e;return n[0]=1-g-l,n[1]=f+y,n[2]=D-x,n[3]=0,n[4]=f-y,n[5]=1-o-l,n[6]=u+w,n[7]=0,n[8]=D+x,n[9]=u-w,n[10]=1-o-g,n[11]=0,n}function G(i,p){let n=p??new r(12);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[4]=-i[4],n[5]=-i[5],n[6]=-i[6],n[8]=-i[8],n[9]=-i[9],n[10]=-i[10],n}function z(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[8]=i[8],n[9]=i[9],n[10]=i[10],n}let U=z;function B(i,p){return Math.abs(i[0]-p[0])<Q&&Math.abs(i[1]-p[1])<Q&&Math.abs(i[2]-p[2])<Q&&Math.abs(i[4]-p[4])<Q&&Math.abs(i[5]-p[5])<Q&&Math.abs(i[6]-p[6])<Q&&Math.abs(i[8]-p[8])<Q&&Math.abs(i[9]-p[9])<Q&&Math.abs(i[10]-p[10])<Q}function R(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[4]===p[4]&&i[5]===p[5]&&i[6]===p[6]&&i[8]===p[8]&&i[9]===p[9]&&i[10]===p[10]}function H(i){let p=i??new r(12);return p[0]=1,p[1]=0,p[2]=0,p[4]=0,p[5]=1,p[6]=0,p[8]=0,p[9]=0,p[10]=1,p}function $(i,p){let n=p??new r(12);if(n===i){let g;return g=i[1],i[1]=i[4],i[4]=g,g=i[2],i[2]=i[8],i[8]=g,g=i[6],i[6]=i[9],i[9]=g,n}let c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],o=i[2*4+1],f=i[2*4+2];return n[0]=c,n[1]=M,n[2]=e,n[4]=d,n[5]=t,n[6]=o,n[8]=h,n[9]=a,n[10]=f,n}function Y(i,p){let n=p??new r(12),c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],o=i[2*4+1],f=i[2*4+2],g=f*t-a*o,D=-f*M+a*e,u=o*M-t*e,l=1/(c*g+d*D+h*u);return n[0]=g*l,n[1]=(-f*d+h*o)*l,n[2]=(a*d-h*t)*l,n[4]=D*l,n[5]=(f*c-h*e)*l,n[6]=(-a*c+h*M)*l,n[8]=u*l,n[9]=(-o*c+d*e)*l,n[10]=(t*c-d*M)*l,n}function F(i){let p=i[0],n=i[0*4+1],c=i[0*4+2],d=i[1*4+0],h=i[1*4+1],M=i[1*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2];return p*(h*e-a*M)-d*(n*e-a*c)+t*(n*M-h*c)}let et=Y;function j(i,p,n){let c=n??new r(12),d=i[0],h=i[1],M=i[2],t=i[4],a=i[5],e=i[6],o=i[8],f=i[9],g=i[10],D=p[0],u=p[1],l=p[2],w=p[4],x=p[5],y=p[6],b=p[8],S=p[9],E=p[10];return c[0]=d*D+t*u+o*l,c[1]=h*D+a*u+f*l,c[2]=M*D+e*u+g*l,c[4]=d*w+t*x+o*y,c[5]=h*w+a*x+f*y,c[6]=M*w+e*x+g*y,c[8]=d*b+t*S+o*E,c[9]=h*b+a*S+f*E,c[10]=M*b+e*S+g*E,c}let C=j;function tt(i,p,n){let c=n??H();return i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2],c[4]=i[4],c[5]=i[5],c[6]=i[6]),c[8]=p[0],c[9]=p[1],c[10]=1,c}function Mt(i,p){let n=p??s.create();return n[0]=i[8],n[1]=i[9],n}function ft(i,p,n){let c=n??s.create(),d=p*4;return c[0]=i[d+0],c[1]=i[d+1],c}function lt(i,p,n,c){let d=c===i?i:z(i,c),h=n*4;return d[h+0]=p[0],d[h+1]=p[1],d}function Dt(i,p){let n=p??s.create(),c=i[0],d=i[1],h=i[4],M=i[5];return n[0]=Math.sqrt(c*c+d*d),n[1]=Math.sqrt(h*h+M*M),n}function vt(i,p){let n=p??v.create(),c=i[0],d=i[1],h=i[2],M=i[4],t=i[5],a=i[6],e=i[8],o=i[9],f=i[10];return n[0]=Math.sqrt(c*c+d*d+h*h),n[1]=Math.sqrt(M*M+t*t+a*a),n[2]=Math.sqrt(e*e+o*o+f*f),n}function bt(i,p){let n=p??new r(12);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=1,n[6]=0,n[8]=i[0],n[9]=i[1],n[10]=1,n}function nt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=i[0],t=i[1],a=i[2],e=i[1*4+0],o=i[1*4+1],f=i[1*4+2],g=i[2*4+0],D=i[2*4+1],u=i[2*4+2];return i!==c&&(c[0]=M,c[1]=t,c[2]=a,c[4]=e,c[5]=o,c[6]=f),c[8]=M*d+e*h+g,c[9]=t*d+o*h+D,c[10]=a*d+f*h+u,c}function Bt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=d,n[2]=0,n[4]=-d,n[5]=c,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function q(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[1*4+0],a=i[1*4+1],e=i[1*4+2],o=Math.cos(p),f=Math.sin(p);return c[0]=o*d+f*t,c[1]=o*h+f*a,c[2]=o*M+f*e,c[4]=o*t-f*d,c[5]=o*a-f*h,c[6]=o*e-f*M,i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function X(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=c,n[6]=d,n[8]=0,n[9]=-d,n[10]=c,n}function V(i,p,n){let c=n??new r(12),d=i[4],h=i[5],M=i[6],t=i[8],a=i[9],e=i[10],o=Math.cos(p),f=Math.sin(p);return c[4]=o*d+f*t,c[5]=o*h+f*a,c[6]=o*M+f*e,c[8]=o*t-f*d,c[9]=o*a-f*h,c[10]=o*e-f*M,i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2]),c}function Gt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=0,n[2]=-d,n[4]=0,n[5]=1,n[6]=0,n[8]=d,n[9]=0,n[10]=c,n}function dt(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2],o=Math.cos(p),f=Math.sin(p);return c[0]=o*d-f*t,c[1]=o*h-f*a,c[2]=o*M-f*e,c[8]=o*t+f*d,c[9]=o*a+f*h,c[10]=o*e+f*M,i!==c&&(c[4]=i[4],c[5]=i[5],c[6]=i[6]),c}let Ut=Bt,pt=q;function Lt(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function W(i,p,n){let c=n??new r(12),d=p[0],h=p[1];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function Et(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=i[2],n}function mt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=p[2];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],c[8]=M*i[2*4+0],c[9]=M*i[2*4+1],c[10]=M*i[2*4+2],c}function At(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function yt(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function zt(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=i,n}function St(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],c[8]=p*i[2*4+0],c[9]=p*i[2*4+1],c[10]=p*i[2*4+2],c}return{clone:U,create:m,set:_,fromMat4:T,fromQuat:P,negate:G,copy:z,equalsApproximately:B,equals:R,identity:H,transpose:$,inverse:Y,invert:et,determinant:F,mul:C,multiply:j,setTranslation:tt,getTranslation:Mt,getAxis:ft,setAxis:lt,getScaling:Dt,get3DScaling:vt,translation:bt,translate:nt,rotation:Bt,rotate:q,rotationX:X,rotateX:V,rotationY:Gt,rotateY:dt,rotationZ:Ut,rotateZ:pt,scaling:Lt,scale:W,uniformScaling:At,uniformScale:yt,scaling3D:Et,scale3D:mt,uniformScaling3D:zt,uniformScale3D:St}}var He=new Map;function ro(r){let s=He.get(r);return s||(s=so(r),He.set(r,s)),s}function io(r){let s=ae(r);function v(t,a,e,o,f,g,D,u,l,w,x,y,b,S,E,I){let L=new r(16);return t!==void 0&&(L[0]=t,a!==void 0&&(L[1]=a,e!==void 0&&(L[2]=e,o!==void 0&&(L[3]=o,f!==void 0&&(L[4]=f,g!==void 0&&(L[5]=g,D!==void 0&&(L[6]=D,u!==void 0&&(L[7]=u,l!==void 0&&(L[8]=l,w!==void 0&&(L[9]=w,x!==void 0&&(L[10]=x,y!==void 0&&(L[11]=y,b!==void 0&&(L[12]=b,S!==void 0&&(L[13]=S,E!==void 0&&(L[14]=E,I!==void 0&&(L[15]=I)))))))))))))))),L}function m(t,a,e,o,f,g,D,u,l,w,x,y,b,S,E,I,L){let A=L??new r(16);return A[0]=t,A[1]=a,A[2]=e,A[3]=o,A[4]=f,A[5]=g,A[6]=D,A[7]=u,A[8]=l,A[9]=w,A[10]=x,A[11]=y,A[12]=b,A[13]=S,A[14]=E,A[15]=I,A}function _(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function T(t,a){let e=a??new r(16),o=t[0],f=t[1],g=t[2],D=t[3],u=o+o,l=f+f,w=g+g,x=o*u,y=f*u,b=f*l,S=g*u,E=g*l,I=g*w,L=D*u,A=D*l,O=D*w;return e[0]=1-b-I,e[1]=y+O,e[2]=S-A,e[3]=0,e[4]=y-O,e[5]=1-x-I,e[6]=E+L,e[7]=0,e[8]=S+A,e[9]=E-L,e[10]=1-x-b,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function P(t,a){let e=a??new r(16);return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function G(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}let z=G;function U(t,a){return Math.abs(t[0]-a[0])<Q&&Math.abs(t[1]-a[1])<Q&&Math.abs(t[2]-a[2])<Q&&Math.abs(t[3]-a[3])<Q&&Math.abs(t[4]-a[4])<Q&&Math.abs(t[5]-a[5])<Q&&Math.abs(t[6]-a[6])<Q&&Math.abs(t[7]-a[7])<Q&&Math.abs(t[8]-a[8])<Q&&Math.abs(t[9]-a[9])<Q&&Math.abs(t[10]-a[10])<Q&&Math.abs(t[11]-a[11])<Q&&Math.abs(t[12]-a[12])<Q&&Math.abs(t[13]-a[13])<Q&&Math.abs(t[14]-a[14])<Q&&Math.abs(t[15]-a[15])<Q}function B(t,a){return t[0]===a[0]&&t[1]===a[1]&&t[2]===a[2]&&t[3]===a[3]&&t[4]===a[4]&&t[5]===a[5]&&t[6]===a[6]&&t[7]===a[7]&&t[8]===a[8]&&t[9]===a[9]&&t[10]===a[10]&&t[11]===a[11]&&t[12]===a[12]&&t[13]===a[13]&&t[14]===a[14]&&t[15]===a[15]}function R(t){let a=t??new r(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function H(t,a){let e=a??new r(16);if(e===t){let N;return N=t[1],t[1]=t[4],t[4]=N,N=t[2],t[2]=t[8],t[8]=N,N=t[3],t[3]=t[12],t[12]=N,N=t[6],t[6]=t[9],t[9]=N,N=t[7],t[7]=t[13],t[13]=N,N=t[11],t[11]=t[14],t[14]=N,e}let o=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],I=t[3*4+0],L=t[3*4+1],A=t[3*4+2],O=t[3*4+3];return e[0]=o,e[1]=u,e[2]=y,e[3]=I,e[4]=f,e[5]=l,e[6]=b,e[7]=L,e[8]=g,e[9]=w,e[10]=S,e[11]=A,e[12]=D,e[13]=x,e[14]=E,e[15]=O,e}function $(t,a){let e=a??new r(16),o=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],I=t[3*4+0],L=t[3*4+1],A=t[3*4+2],O=t[3*4+3],N=S*O,Z=A*E,K=w*O,J=A*x,ot=w*E,st=S*x,rt=g*O,it=A*D,ct=g*E,at=S*D,ht=g*x,wt=w*D,gt=y*L,xt=I*b,Tt=u*L,_t=I*l,Pt=u*b,Yt=y*l,Xt=o*L,Ht=I*f,jt=o*b,Wt=y*f,Zt=o*l,Qt=u*f,Ct=N*l+J*b+ot*L-(Z*l+K*b+st*L),te=Z*f+rt*b+at*L-(N*f+it*b+ct*L),ee=K*f+it*l+ht*L-(J*f+rt*l+wt*L),ne=st*f+ct*l+wt*b-(ot*f+at*l+ht*b),ut=1/(o*Ct+u*te+y*ee+I*ne);return e[0]=ut*Ct,e[1]=ut*te,e[2]=ut*ee,e[3]=ut*ne,e[4]=ut*(Z*u+K*y+st*I-(N*u+J*y+ot*I)),e[5]=ut*(N*o+it*y+ct*I-(Z*o+rt*y+at*I)),e[6]=ut*(J*o+rt*u+wt*I-(K*o+it*u+ht*I)),e[7]=ut*(ot*o+at*u+ht*y-(st*o+ct*u+wt*y)),e[8]=ut*(gt*x+_t*E+Pt*O-(xt*x+Tt*E+Yt*O)),e[9]=ut*(xt*D+Xt*E+Wt*O-(gt*D+Ht*E+jt*O)),e[10]=ut*(Tt*D+Ht*x+Zt*O-(_t*D+Xt*x+Qt*O)),e[11]=ut*(Yt*D+jt*x+Qt*E-(Pt*D+Wt*x+Zt*E)),e[12]=ut*(Tt*S+Yt*A+xt*w-(Pt*A+gt*w+_t*S)),e[13]=ut*(jt*A+gt*g+Ht*S-(Xt*S+Wt*A+xt*g)),e[14]=ut*(Xt*w+Qt*A+_t*g-(Zt*A+Tt*g+Ht*w)),e[15]=ut*(Zt*S+Pt*g+Wt*w-(jt*w+Qt*S+Yt*g)),e}function Y(t){let a=t[0],e=t[0*4+1],o=t[0*4+2],f=t[0*4+3],g=t[1*4+0],D=t[1*4+1],u=t[1*4+2],l=t[1*4+3],w=t[2*4+0],x=t[2*4+1],y=t[2*4+2],b=t[2*4+3],S=t[3*4+0],E=t[3*4+1],I=t[3*4+2],L=t[3*4+3],A=y*L,O=I*b,N=u*L,Z=I*l,K=u*b,J=y*l,ot=o*L,st=I*f,rt=o*b,it=y*f,ct=o*l,at=u*f,ht=A*D+Z*x+K*E-(O*D+N*x+J*E),wt=O*e+ot*x+it*E-(A*e+st*x+rt*E),gt=N*e+st*D+ct*E-(Z*e+ot*D+at*E),xt=J*e+rt*D+at*x-(K*e+it*D+ct*x);return a*ht+g*wt+w*gt+S*xt}let F=$;function et(t,a,e){let o=e??new r(16),f=t[0],g=t[1],D=t[2],u=t[3],l=t[4],w=t[5],x=t[6],y=t[7],b=t[8],S=t[9],E=t[10],I=t[11],L=t[12],A=t[13],O=t[14],N=t[15],Z=a[0],K=a[1],J=a[2],ot=a[3],st=a[4],rt=a[5],it=a[6],ct=a[7],at=a[8],ht=a[9],wt=a[10],gt=a[11],xt=a[12],Tt=a[13],_t=a[14],Pt=a[15];return o[0]=f*Z+l*K+b*J+L*ot,o[1]=g*Z+w*K+S*J+A*ot,o[2]=D*Z+x*K+E*J+O*ot,o[3]=u*Z+y*K+I*J+N*ot,o[4]=f*st+l*rt+b*it+L*ct,o[5]=g*st+w*rt+S*it+A*ct,o[6]=D*st+x*rt+E*it+O*ct,o[7]=u*st+y*rt+I*it+N*ct,o[8]=f*at+l*ht+b*wt+L*gt,o[9]=g*at+w*ht+S*wt+A*gt,o[10]=D*at+x*ht+E*wt+O*gt,o[11]=u*at+y*ht+I*wt+N*gt,o[12]=f*xt+l*Tt+b*_t+L*Pt,o[13]=g*xt+w*Tt+S*_t+A*Pt,o[14]=D*xt+x*Tt+E*_t+O*Pt,o[15]=u*xt+y*Tt+I*_t+N*Pt,o}let j=et;function C(t,a,e){let o=e??R();return t!==o&&(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11]),o[12]=a[0],o[13]=a[1],o[14]=a[2],o[15]=1,o}function tt(t,a){let e=a??s.create();return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Mt(t,a,e){let o=e??s.create(),f=a*4;return o[0]=t[f+0],o[1]=t[f+1],o[2]=t[f+2],o}function ft(t,a,e,o){let f=o===t?o:G(t,o),g=e*4;return f[g+0]=a[0],f[g+1]=a[1],f[g+2]=a[2],f}function lt(t,a){let e=a??s.create(),o=t[0],f=t[1],g=t[2],D=t[4],u=t[5],l=t[6],w=t[8],x=t[9],y=t[10];return e[0]=Math.sqrt(o*o+f*f+g*g),e[1]=Math.sqrt(D*D+u*u+l*l),e[2]=Math.sqrt(w*w+x*x+y*y),e}function Dt(t,a,e,o,f){let g=f??new r(16),D=Math.tan(Math.PI*.5-.5*t);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(o)){let u=1/(e-o);g[10]=o*u,g[14]=o*e*u}else g[10]=-1,g[14]=-e;return g}function vt(t,a,e,o=1/0,f){let g=f??new r(16),D=1/Math.tan(t*.5);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,o===1/0)g[10]=0,g[14]=e;else{let u=1/(o-e);g[10]=e*u,g[14]=o*e*u}return g}function bt(t,a,e,o,f,g,D){let u=D??new r(16);return u[0]=2/(a-t),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(o-e),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1/(f-g),u[11]=0,u[12]=(a+t)/(t-a),u[13]=(o+e)/(e-o),u[14]=f/(f-g),u[15]=1,u}function nt(t,a,e,o,f,g,D){let u=D??new r(16),l=a-t,w=o-e,x=f-g;return u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(o+e)/w,u[10]=g/x,u[11]=-1,u[12]=0,u[13]=0,u[14]=f*g/x,u[15]=0,u}function Bt(t,a,e,o,f,g=1/0,D){let u=D??new r(16),l=a-t,w=o-e;if(u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(o+e)/w,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,g===1/0)u[10]=0,u[14]=f;else{let x=1/(g-f);u[10]=f*x,u[14]=g*f*x}return u}let q=s.create(),X=s.create(),V=s.create();function Gt(t,a,e,o){let f=o??new r(16);return s.normalize(s.subtract(a,t,V),V),s.normalize(s.cross(e,V,q),q),s.normalize(s.cross(V,q,X),X),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=X[0],f[5]=X[1],f[6]=X[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function dt(t,a,e,o){let f=o??new r(16);return s.normalize(s.subtract(t,a,V),V),s.normalize(s.cross(e,V,q),q),s.normalize(s.cross(V,q,X),X),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=X[0],f[5]=X[1],f[6]=X[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function Ut(t,a,e,o){let f=o??new r(16);return s.normalize(s.subtract(t,a,V),V),s.normalize(s.cross(e,V,q),q),s.normalize(s.cross(V,q,X),X),f[0]=q[0],f[1]=X[0],f[2]=V[0],f[3]=0,f[4]=q[1],f[5]=X[1],f[6]=V[1],f[7]=0,f[8]=q[2],f[9]=X[2],f[10]=V[2],f[11]=0,f[12]=-(q[0]*t[0]+q[1]*t[1]+q[2]*t[2]),f[13]=-(X[0]*t[0]+X[1]*t[1]+X[2]*t[2]),f[14]=-(V[0]*t[0]+V[1]*t[1]+V[2]*t[2]),f[15]=1,f}function pt(t,a){let e=a??new r(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Lt(t,a,e){let o=e??new r(16),f=a[0],g=a[1],D=a[2],u=t[0],l=t[1],w=t[2],x=t[3],y=t[1*4+0],b=t[1*4+1],S=t[1*4+2],E=t[1*4+3],I=t[2*4+0],L=t[2*4+1],A=t[2*4+2],O=t[2*4+3],N=t[3*4+0],Z=t[3*4+1],K=t[3*4+2],J=t[3*4+3];return t!==o&&(o[0]=u,o[1]=l,o[2]=w,o[3]=x,o[4]=y,o[5]=b,o[6]=S,o[7]=E,o[8]=I,o[9]=L,o[10]=A,o[11]=O),o[12]=u*f+y*g+I*D+N,o[13]=l*f+b*g+L*D+Z,o[14]=w*f+S*g+A*D+K,o[15]=x*f+E*g+O*D+J,o}function W(t,a){let e=a??new r(16),o=Math.cos(t),f=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=f,e[7]=0,e[8]=0,e[9]=-f,e[10]=o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Et(t,a,e){let o=e??new r(16),f=t[4],g=t[5],D=t[6],u=t[7],l=t[8],w=t[9],x=t[10],y=t[11],b=Math.cos(a),S=Math.sin(a);return o[4]=b*f+S*l,o[5]=b*g+S*w,o[6]=b*D+S*x,o[7]=b*u+S*y,o[8]=b*l-S*f,o[9]=b*w-S*g,o[10]=b*x-S*D,o[11]=b*y-S*u,t!==o&&(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function mt(t,a){let e=a??new r(16),o=Math.cos(t),f=Math.sin(t);return e[0]=o,e[1]=0,e[2]=-f,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=f,e[9]=0,e[10]=o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function At(t,a,e){let o=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[2*4+0],w=t[2*4+1],x=t[2*4+2],y=t[2*4+3],b=Math.cos(a),S=Math.sin(a);return o[0]=b*f-S*l,o[1]=b*g-S*w,o[2]=b*D-S*x,o[3]=b*u-S*y,o[8]=b*l+S*f,o[9]=b*w+S*g,o[10]=b*x+S*D,o[11]=b*y+S*u,t!==o&&(o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function yt(t,a){let e=a??new r(16),o=Math.cos(t),f=Math.sin(t);return e[0]=o,e[1]=f,e[2]=0,e[3]=0,e[4]=-f,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function zt(t,a,e){let o=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[1*4+0],w=t[1*4+1],x=t[1*4+2],y=t[1*4+3],b=Math.cos(a),S=Math.sin(a);return o[0]=b*f+S*l,o[1]=b*g+S*w,o[2]=b*D+S*x,o[3]=b*u+S*y,o[4]=b*l-S*f,o[5]=b*w-S*g,o[6]=b*x-S*D,o[7]=b*y-S*u,t!==o&&(o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function St(t,a,e){let o=e??new r(16),f=t[0],g=t[1],D=t[2],u=Math.sqrt(f*f+g*g+D*D);f/=u,g/=u,D/=u;let l=f*f,w=g*g,x=D*D,y=Math.cos(a),b=Math.sin(a),S=1-y;return o[0]=l+(1-l)*y,o[1]=f*g*S+D*b,o[2]=f*D*S-g*b,o[3]=0,o[4]=f*g*S-D*b,o[5]=w+(1-w)*y,o[6]=g*D*S+f*b,o[7]=0,o[8]=f*D*S+g*b,o[9]=g*D*S-f*b,o[10]=x+(1-x)*y,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}let i=St;function p(t,a,e,o){let f=o??new r(16),g=a[0],D=a[1],u=a[2],l=Math.sqrt(g*g+D*D+u*u);g/=l,D/=l,u/=l;let w=g*g,x=D*D,y=u*u,b=Math.cos(e),S=Math.sin(e),E=1-b,I=w+(1-w)*b,L=g*D*E+u*S,A=g*u*E-D*S,O=g*D*E-u*S,N=x+(1-x)*b,Z=D*u*E+g*S,K=g*u*E+D*S,J=D*u*E-g*S,ot=y+(1-y)*b,st=t[0],rt=t[1],it=t[2],ct=t[3],at=t[4],ht=t[5],wt=t[6],gt=t[7],xt=t[8],Tt=t[9],_t=t[10],Pt=t[11];return f[0]=I*st+L*at+A*xt,f[1]=I*rt+L*ht+A*Tt,f[2]=I*it+L*wt+A*_t,f[3]=I*ct+L*gt+A*Pt,f[4]=O*st+N*at+Z*xt,f[5]=O*rt+N*ht+Z*Tt,f[6]=O*it+N*wt+Z*_t,f[7]=O*ct+N*gt+Z*Pt,f[8]=K*st+J*at+ot*xt,f[9]=K*rt+J*ht+ot*Tt,f[10]=K*it+J*wt+ot*_t,f[11]=K*ct+J*gt+ot*Pt,t!==f&&(f[12]=t[12],f[13]=t[13],f[14]=t[14],f[15]=t[15]),f}let n=p;function c(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function d(t,a,e){let o=e??new r(16),f=a[0],g=a[1],D=a[2];return o[0]=f*t[0*4+0],o[1]=f*t[0*4+1],o[2]=f*t[0*4+2],o[3]=f*t[0*4+3],o[4]=g*t[1*4+0],o[5]=g*t[1*4+1],o[6]=g*t[1*4+2],o[7]=g*t[1*4+3],o[8]=D*t[2*4+0],o[9]=D*t[2*4+1],o[10]=D*t[2*4+2],o[11]=D*t[2*4+3],t!==o&&(o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function h(t,a){let e=a??new r(16);return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function M(t,a,e){let o=e??new r(16);return o[0]=a*t[0*4+0],o[1]=a*t[0*4+1],o[2]=a*t[0*4+2],o[3]=a*t[0*4+3],o[4]=a*t[1*4+0],o[5]=a*t[1*4+1],o[6]=a*t[1*4+2],o[7]=a*t[1*4+3],o[8]=a*t[2*4+0],o[9]=a*t[2*4+1],o[10]=a*t[2*4+2],o[11]=a*t[2*4+3],t!==o&&(o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}return{create:v,set:m,fromMat3:_,fromQuat:T,negate:P,copy:G,clone:z,equalsApproximately:U,equals:B,identity:R,transpose:H,inverse:$,determinant:Y,invert:F,multiply:et,mul:j,setTranslation:C,getTranslation:tt,getAxis:Mt,setAxis:ft,getScaling:lt,perspective:Dt,perspectiveReverseZ:vt,ortho:bt,frustum:nt,frustumReverseZ:Bt,aim:Gt,cameraAim:dt,lookAt:Ut,translation:pt,translate:Lt,rotationX:W,rotateX:Et,rotationY:mt,rotateY:At,rotationZ:yt,rotateZ:zt,axisRotation:St,rotation:i,axisRotate:p,rotate:n,scaling:c,scale:d,uniformScaling:h,uniformScale:M}}var je=new Map;function co(r){let s=je.get(r);return s||(s=io(r),je.set(r,s)),s}function ao(r){let s=ae(r);function v(i,p,n,c){let d=new r(4);return i!==void 0&&(d[0]=i,p!==void 0&&(d[1]=p,n!==void 0&&(d[2]=n,c!==void 0&&(d[3]=c)))),d}let m=v;function _(i,p,n,c,d){let h=d??new r(4);return h[0]=i,h[1]=p,h[2]=n,h[3]=c,h}function T(i,p,n){let c=n??new r(4),d=p*.5,h=Math.sin(d);return c[0]=h*i[0],c[1]=h*i[1],c[2]=h*i[2],c[3]=Math.cos(d),c}function P(i,p){let n=p??s.create(3),c=Math.acos(i[3])*2,d=Math.sin(c*.5);return d>Q?(n[0]=i[0]/d,n[1]=i[1]/d,n[2]=i[2]/d):(n[0]=1,n[1]=0,n[2]=0),{angle:c,axis:n}}function G(i,p){let n=nt(i,p);return Math.acos(2*n*n-1)}function z(i,p,n){let c=n??new r(4),d=i[0],h=i[1],M=i[2],t=i[3],a=p[0],e=p[1],o=p[2],f=p[3];return c[0]=d*f+t*a+h*o-M*e,c[1]=h*f+t*e+M*a-d*o,c[2]=M*f+t*o+d*e-h*a,c[3]=t*f-d*a-h*e-M*o,c}let U=z;function B(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),o=Math.cos(d);return c[0]=h*o+a*e,c[1]=M*o+t*e,c[2]=t*o-M*e,c[3]=a*o-h*e,c}function R(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),o=Math.cos(d);return c[0]=h*o-t*e,c[1]=M*o+a*e,c[2]=t*o+h*e,c[3]=a*o-M*e,c}function H(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),o=Math.cos(d);return c[0]=h*o+M*e,c[1]=M*o-h*e,c[2]=t*o+a*e,c[3]=a*o-t*e,c}function $(i,p,n,c){let d=c??new r(4),h=i[0],M=i[1],t=i[2],a=i[3],e=p[0],o=p[1],f=p[2],g=p[3],D=h*e+M*o+t*f+a*g;D<0&&(D=-D,e=-e,o=-o,f=-f,g=-g);let u,l;if(1-D>Q){let w=Math.acos(D),x=Math.sin(w);u=Math.sin((1-n)*w)/x,l=Math.sin(n*w)/x}else u=1-n,l=n;return d[0]=u*h+l*e,d[1]=u*M+l*o,d[2]=u*t+l*f,d[3]=u*a+l*g,d}function Y(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=c*c+d*d+h*h+M*M,a=t?1/t:0;return n[0]=-c*a,n[1]=-d*a,n[2]=-h*a,n[3]=M*a,n}function F(i,p){let n=p??new r(4);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[3]=i[3],n}function et(i,p){let n=p??new r(4),c=i[0]+i[5]+i[10];if(c>0){let d=Math.sqrt(c+1);n[3]=.5*d;let h=.5/d;n[0]=(i[6]-i[9])*h,n[1]=(i[8]-i[2])*h,n[2]=(i[1]-i[4])*h}else{let d=0;i[5]>i[0]&&(d=1),i[10]>i[d*4+d]&&(d=2);let h=(d+1)%3,M=(d+2)%3,t=Math.sqrt(i[d*4+d]-i[h*4+h]-i[M*4+M]+1);n[d]=.5*t;let a=.5/t;n[3]=(i[h*4+M]-i[M*4+h])*a,n[h]=(i[h*4+d]+i[d*4+h])*a,n[M]=(i[M*4+d]+i[d*4+M])*a}return n}function j(i,p,n,c,d){let h=d??new r(4),M=i*.5,t=p*.5,a=n*.5,e=Math.sin(M),o=Math.cos(M),f=Math.sin(t),g=Math.cos(t),D=Math.sin(a),u=Math.cos(a);switch(c){case"xyz":h[0]=e*g*u+o*f*D,h[1]=o*f*u-e*g*D,h[2]=o*g*D+e*f*u,h[3]=o*g*u-e*f*D;break;case"xzy":h[0]=e*g*u-o*f*D,h[1]=o*f*u-e*g*D,h[2]=o*g*D+e*f*u,h[3]=o*g*u+e*f*D;break;case"yxz":h[0]=e*g*u+o*f*D,h[1]=o*f*u-e*g*D,h[2]=o*g*D-e*f*u,h[3]=o*g*u+e*f*D;break;case"yzx":h[0]=e*g*u+o*f*D,h[1]=o*f*u+e*g*D,h[2]=o*g*D-e*f*u,h[3]=o*g*u-e*f*D;break;case"zxy":h[0]=e*g*u-o*f*D,h[1]=o*f*u+e*g*D,h[2]=o*g*D+e*f*u,h[3]=o*g*u-e*f*D;break;case"zyx":h[0]=e*g*u-o*f*D,h[1]=o*f*u+e*g*D,h[2]=o*g*D-e*f*u,h[3]=o*g*u+e*f*D;break;default:throw new Error(`Unknown rotation order: ${c}`)}return h}function C(i,p){let n=p??new r(4);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n}let tt=C;function Mt(i,p,n){let c=n??new r(4);return c[0]=i[0]+p[0],c[1]=i[1]+p[1],c[2]=i[2]+p[2],c[3]=i[3]+p[3],c}function ft(i,p,n){let c=n??new r(4);return c[0]=i[0]-p[0],c[1]=i[1]-p[1],c[2]=i[2]-p[2],c[3]=i[3]-p[3],c}let lt=ft;function Dt(i,p,n){let c=n??new r(4);return c[0]=i[0]*p,c[1]=i[1]*p,c[2]=i[2]*p,c[3]=i[3]*p,c}let vt=Dt;function bt(i,p,n){let c=n??new r(4);return c[0]=i[0]/p,c[1]=i[1]/p,c[2]=i[2]/p,c[3]=i[3]/p,c}function nt(i,p){return i[0]*p[0]+i[1]*p[1]+i[2]*p[2]+i[3]*p[3]}function Bt(i,p,n,c){let d=c??new r(4);return d[0]=i[0]+n*(p[0]-i[0]),d[1]=i[1]+n*(p[1]-i[1]),d[2]=i[2]+n*(p[2]-i[2]),d[3]=i[3]+n*(p[3]-i[3]),d}function q(i){let p=i[0],n=i[1],c=i[2],d=i[3];return Math.sqrt(p*p+n*n+c*c+d*d)}let X=q;function V(i){let p=i[0],n=i[1],c=i[2],d=i[3];return p*p+n*n+c*c+d*d}let Gt=V;function dt(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=Math.sqrt(c*c+d*d+h*h+M*M);return t>1e-5?(n[0]=c/t,n[1]=d/t,n[2]=h/t,n[3]=M/t):(n[0]=0,n[1]=0,n[2]=0,n[3]=1),n}function Ut(i,p){return Math.abs(i[0]-p[0])<Q&&Math.abs(i[1]-p[1])<Q&&Math.abs(i[2]-p[2])<Q&&Math.abs(i[3]-p[3])<Q}function pt(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[3]===p[3]}function Lt(i){let p=i??new r(4);return p[0]=0,p[1]=0,p[2]=0,p[3]=1,p}let W=s.create(),Et=s.create(),mt=s.create();function At(i,p,n){let c=n??new r(4),d=s.dot(i,p);return d<-.999999?(s.cross(Et,i,W),s.len(W)<1e-6&&s.cross(mt,i,W),s.normalize(W,W),T(W,Math.PI,c),c):d>.999999?(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c):(s.cross(i,p,W),c[0]=W[0],c[1]=W[1],c[2]=W[2],c[3]=1+d,dt(c,c))}let yt=new r(4),zt=new r(4);function St(i,p,n,c,d,h){let M=h??new r(4);return $(i,c,d,yt),$(p,n,d,zt),$(yt,zt,2*d*(1-d),M),M}return{create:v,fromValues:m,set:_,fromAxisAngle:T,toAxisAngle:P,angle:G,multiply:z,mul:U,rotateX:B,rotateY:R,rotateZ:H,slerp:$,inverse:Y,conjugate:F,fromMat:et,fromEuler:j,copy:C,clone:tt,add:Mt,subtract:ft,sub:lt,mulScalar:Dt,scale:vt,divScalar:bt,dot:nt,lerp:Bt,length:q,len:X,lengthSq:V,lenSq:Gt,normalize:dt,equalsApproximately:Ut,equals:pt,identity:Lt,rotationTo:At,sqlerp:St}}var We=new Map;function uo(r){let s=We.get(r);return s||(s=ao(r),We.set(r,s)),s}function fo(r){function s(n,c,d,h){let M=new r(4);return n!==void 0&&(M[0]=n,c!==void 0&&(M[1]=c,d!==void 0&&(M[2]=d,h!==void 0&&(M[3]=h)))),M}let v=s;function m(n,c,d,h,M){let t=M??new r(4);return t[0]=n,t[1]=c,t[2]=d,t[3]=h,t}function _(n,c){let d=c??new r(4);return d[0]=Math.ceil(n[0]),d[1]=Math.ceil(n[1]),d[2]=Math.ceil(n[2]),d[3]=Math.ceil(n[3]),d}function T(n,c){let d=c??new r(4);return d[0]=Math.floor(n[0]),d[1]=Math.floor(n[1]),d[2]=Math.floor(n[2]),d[3]=Math.floor(n[3]),d}function P(n,c){let d=c??new r(4);return d[0]=Math.round(n[0]),d[1]=Math.round(n[1]),d[2]=Math.round(n[2]),d[3]=Math.round(n[3]),d}function G(n,c=0,d=1,h){let M=h??new r(4);return M[0]=Math.min(d,Math.max(c,n[0])),M[1]=Math.min(d,Math.max(c,n[1])),M[2]=Math.min(d,Math.max(c,n[2])),M[3]=Math.min(d,Math.max(c,n[3])),M}function z(n,c,d){let h=d??new r(4);return h[0]=n[0]+c[0],h[1]=n[1]+c[1],h[2]=n[2]+c[2],h[3]=n[3]+c[3],h}function U(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+c[0]*d,M[1]=n[1]+c[1]*d,M[2]=n[2]+c[2]*d,M[3]=n[3]+c[3]*d,M}function B(n,c,d){let h=d??new r(4);return h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2],h[3]=n[3]-c[3],h}let R=B;function H(n,c){return Math.abs(n[0]-c[0])<Q&&Math.abs(n[1]-c[1])<Q&&Math.abs(n[2]-c[2])<Q&&Math.abs(n[3]-c[3])<Q}function $(n,c){return n[0]===c[0]&&n[1]===c[1]&&n[2]===c[2]&&n[3]===c[3]}function Y(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d*(c[0]-n[0]),M[1]=n[1]+d*(c[1]-n[1]),M[2]=n[2]+d*(c[2]-n[2]),M[3]=n[3]+d*(c[3]-n[3]),M}function F(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d[0]*(c[0]-n[0]),M[1]=n[1]+d[1]*(c[1]-n[1]),M[2]=n[2]+d[2]*(c[2]-n[2]),M[3]=n[3]+d[3]*(c[3]-n[3]),M}function et(n,c,d){let h=d??new r(4);return h[0]=Math.max(n[0],c[0]),h[1]=Math.max(n[1],c[1]),h[2]=Math.max(n[2],c[2]),h[3]=Math.max(n[3],c[3]),h}function j(n,c,d){let h=d??new r(4);return h[0]=Math.min(n[0],c[0]),h[1]=Math.min(n[1],c[1]),h[2]=Math.min(n[2],c[2]),h[3]=Math.min(n[3],c[3]),h}function C(n,c,d){let h=d??new r(4);return h[0]=n[0]*c,h[1]=n[1]*c,h[2]=n[2]*c,h[3]=n[3]*c,h}let tt=C;function Mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c,h[1]=n[1]/c,h[2]=n[2]/c,h[3]=n[3]/c,h}function ft(n,c){let d=c??new r(4);return d[0]=1/n[0],d[1]=1/n[1],d[2]=1/n[2],d[3]=1/n[3],d}let lt=ft;function Dt(n,c){return n[0]*c[0]+n[1]*c[1]+n[2]*c[2]+n[3]*c[3]}function vt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return Math.sqrt(c*c+d*d+h*h+M*M)}let bt=vt;function nt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return c*c+d*d+h*h+M*M}let Bt=nt;function q(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return Math.sqrt(d*d+h*h+M*M+t*t)}let X=q;function V(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return d*d+h*h+M*M+t*t}let Gt=V;function dt(n,c){let d=c??new r(4),h=n[0],M=n[1],t=n[2],a=n[3],e=Math.sqrt(h*h+M*M+t*t+a*a);return e>1e-5?(d[0]=h/e,d[1]=M/e,d[2]=t/e,d[3]=a/e):(d[0]=0,d[1]=0,d[2]=0,d[3]=0),d}function Ut(n,c){let d=c??new r(4);return d[0]=-n[0],d[1]=-n[1],d[2]=-n[2],d[3]=-n[3],d}function pt(n,c){let d=c??new r(4);return d[0]=n[0],d[1]=n[1],d[2]=n[2],d[3]=n[3],d}let Lt=pt;function W(n,c,d){let h=d??new r(4);return h[0]=n[0]*c[0],h[1]=n[1]*c[1],h[2]=n[2]*c[2],h[3]=n[3]*c[3],h}let Et=W;function mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c[0],h[1]=n[1]/c[1],h[2]=n[2]/c[2],h[3]=n[3]/c[3],h}let At=mt;function yt(n){let c=n??new r(4);return c[0]=0,c[1]=0,c[2]=0,c[3]=0,c}function zt(n,c,d){let h=d??new r(4),M=n[0],t=n[1],a=n[2],e=n[3];return h[0]=c[0]*M+c[4]*t+c[8]*a+c[12]*e,h[1]=c[1]*M+c[5]*t+c[9]*a+c[13]*e,h[2]=c[2]*M+c[6]*t+c[10]*a+c[14]*e,h[3]=c[3]*M+c[7]*t+c[11]*a+c[15]*e,h}function St(n,c,d){let h=d??new r(4);return dt(n,h),C(h,c,h)}function i(n,c,d){let h=d??new r(4);return vt(n)>c?St(n,c,h):pt(n,h)}function p(n,c,d){let h=d??new r(4);return Y(n,c,.5,h)}return{create:s,fromValues:v,set:m,ceil:_,floor:T,round:P,clamp:G,add:z,addScaled:U,subtract:B,sub:R,equalsApproximately:H,equals:$,lerp:Y,lerpV:F,max:et,min:j,mulScalar:C,scale:tt,divScalar:Mt,inverse:ft,invert:lt,dot:Dt,length:vt,len:bt,lengthSq:nt,lenSq:Bt,distance:q,dist:X,distanceSq:V,distSq:Gt,normalize:dt,negate:Ut,copy:pt,clone:Lt,multiply:W,mul:Et,divide:mt,div:At,zero:yt,transformMat4:zt,setLength:St,truncate:i,midpoint:p}}var Ze=new Map;function lo(r){let s=Ze.get(r);return s||(s=fo(r),Ze.set(r,s)),s}function Me(r,s,v,m,_,T){return{mat3:ro(r),mat4:co(s),quat:uo(v),vec2:Qe(m),vec3:ae(_),vec4:lo(T)}}var{mat3:Rs,mat4:It,quat:Os,vec2:ue,vec3:Ot,vec4:De}=Me(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:Vs,mat4:qs,quat:Ns,vec2:$s,vec3:Ys,vec4:Xs}=Me(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:Hs,mat4:js,quat:Ws,vec2:Zs,vec3:Qs,vec4:ks}=Me(eo,Array,Array,Array,Array,Array);var fe=class{device;floatsPerSprite=6;bufferGpu;bufferNeedsUpdate=!1;sprites=new Map;get spriteCount(){return this.sprites.size}constructor(s){this.device=s.device,this.bufferGpu=this.device.createBuffer({size:s.maxSpriteCount*this.floatsPerSprite*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})}destroy(){this.bufferGpu.destroy}update(){if(this.bufferNeedsUpdate){let s=[];for(let m of this.sprites.values())s.push(...m);let v=new Float32Array(s);this.device.queue.writeBuffer(this.bufferGpu,0,v)}}addTriangle(s){let v=se();if(this.sprites.has(v))throw new Error(`Duplicate triangle "${v}".`);let m=this.buildTriangleData(s);return this.sprites.set(v,m),this.bufferNeedsUpdate=!0,v}removeTriangle(s){if(!this.sprites.has(s))throw new Error(`Unknown triangle "${s}".`);this.sprites.delete(s),this.bufferNeedsUpdate=!0}setTriangle(s,v){if(!this.sprites.has(s))throw new Error(`Unknown triangle "${s}".`);let m=this.buildTriangleData(v);this.sprites.set(s,m),this.bufferNeedsUpdate=!0}buildTriangleData(s){return[s[0][0],s[0][1],s[1][0],s[1][1],s[2][0],s[2][1]]}};var ke=Ot.create(0,0,0),Ke={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(r,s={}){return po(r,s)},onRun:function(r,s,v){ho(r,s,v)},onDestroy:function(r,s){wo(s)},onResize:function(r,s){go(r,s)},onViewportPosition:function(r,s){xo(r,s)},customFunctions:{addTriangle:function(r,s,v){return s.data.trianglesBuffer.addTriangle(v)},removeTriangle:function(r,s,v){s.data.trianglesBuffer.removeTriangle(v)},setPosition:function(r,s,v,m){s.data.trianglesBuffer.setTriangle(v,m)}}};async function po(r,s){let{device:v}=r,m=new Float32Array([s.options.offseyX??0,s.options.offseyY??0,s.options.scale??20,0]),_=v.createBuffer({label:"displacement options buffer",size:m.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(_.getMappedRange()).set(m),_.unmap();let T=256,P=T,z=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*2,H=Float32Array.BYTES_PER_ELEMENT*2,$=v.createBuffer({size:64*3,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),F=v.createPipelineLayout({bindGroupLayouts:[Y]}),et="repeat",j="linear",C=v.createSampler({label:"displacement ampler",addressModeU:et,addressModeV:et,addressModeW:et,magFilter:j,minFilter:j,mipmapFilter:j}),tt=v.createBindGroup({layout:Y,entries:[{binding:0,resource:{buffer:$}},{binding:1,resource:s.refs.color.data.view},{binding:2,resource:C},{binding:3,resource:s.refs.map.view},{binding:4,resource:{buffer:_}}]}),Mt={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},ft=v.createRenderPipeline({label:"displacement",vertex:{module:v.createShaderModule({code:ye}),entryPoint:"vs_main",buffers:[Mt]},fragment:{module:v.createShaderModule({code:ye}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:F}),lt=new fe({device:v,maxSpriteCount:T});return{bindGroup:tt,bindGroupLayout:Y,uniformBuffer:$,sampler:C,pipeline:ft,params_buf:_,trianglesBuffer:lt}}function ho(r,s,v){let m=s.data.trianglesBuffer.spriteCount;if(m===0)return;s.data.trianglesBuffer.update();let _=v.beginRenderPass({colorAttachments:[{view:s.refs.out,clearValue:r.clearValue,loadOp:"load",storeOp:"store"}]});_.setPipeline(s.data.pipeline),_.setBindGroup(0,s.data.bindGroup),_.setVertexBuffer(0,s.data.trianglesBuffer.bufferGpu),_.draw(3*m),_.end()}function wo(r){r.data.bindGroup=null,r.data.trianglesBuffer.destroy(),r.data.trianglesBuffer=null,r.data.uniformBuffer.destroy(),r.data.uniformBuffer=null,r.data.params_buf.destroy(),r.data.params_buf=null}function go(r,s){let{device:v}=r;s.data.bindGroup=v.createBindGroup({layout:s.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:s.data.uniformBuffer}},{binding:1,resource:s.refs.color.data.view},{binding:2,resource:s.data.sampler},{binding:3,resource:s.refs.map.view},{binding:4,resource:{buffer:s.data.params_buf}}]})}function xo(r,s){let{device:v}=r,m=r.viewport.width/r.viewport.zoom,_=r.viewport.height/r.viewport.zoom,T=It.ortho(0,m,_,0,-10,10);Ot.set(-r.viewport.position[0],-r.viewport.position[1],0,ke);let P=It.translation(ke),G=[1,1,1],z=0,U=[1,1,0],B=It.identity();It.multiply(It.scaling(G),B,B),It.multiply(It.rotationZ(z),B,B),It.multiply(It.translation(U),B,B),v.queue.writeBuffer(s.data.uniformBuffer,0,B.buffer),v.queue.writeBuffer(s.data.uniformBuffer,64,P.buffer),v.queue.writeBuffer(s.data.uniformBuffer,128,T.buffer)}function be(r,s){let v=s.vertices,m=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,_={size:v.byteLength,usage:m,mappedAtCreation:!0},T=r.createBuffer(_);return new Float32Array(T.getMappedRange()).set(v),T.unmap(),{buffer:T,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var Se="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var Pr=De.create(),Je=Ot.create(),en={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(r,s={}){return mo(r,s)},onRun:function(r,s,v){yo(r,s,v)},onDestroy:function(r,s){Do(s)},onResize:function(r,s){Ce(r,s)},onViewportPosition:function(r,s){Ce(r,s)},customFunctions:{...re}};async function mo(r,s){let{device:v}=r,m=16192,_=m,P=Float32Array.BYTES_PER_ELEMENT*2,z=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*4,H=Float32Array.BYTES_PER_ELEMENT*4,$=v.createBuffer({size:(P+z+B+H)*_,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Y=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),F=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),et=v.createBindGroup({layout:F,entries:[{binding:0,resource:{buffer:Y}},{binding:1,resource:s.refs.spritesheet.data.colorTexture.view},{binding:2,resource:s.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:$}}]}),j=v.createPipelineLayout({bindGroupLayouts:[F]}),C=v.createRenderPipeline({label:"overlay",vertex:{module:v.createShaderModule({code:Se}),entryPoint:"vs_main",buffers:[s.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:v.createShaderModule({code:Se}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:j});return{instancedDrawCalls:new Uint32Array(m*2),instancedDrawCallCount:0,spriteBuffer:$,uniformBuffer:Y,pipeline:C,bindGroupLayout:F,bindGroup:et,spriteData:new Float32Array(m*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function yo(r,s,v){let{device:m}=r,_=s.options.loadOp||"load";s.data.dirty&&(Mo(s.data),s.data.dirty=!1),m.queue.writeBuffer(s.data.spriteBuffer,0,s.data.spriteData.buffer);let T=v.beginRenderPass({colorAttachments:[{view:s.refs.color,clearValue:r.clearValue,loadOp:_,storeOp:"store"}]});T.setPipeline(s.data.pipeline),T.setBindGroup(0,s.data.bindGroup),T.setVertexBuffer(0,s.refs.spritesheet.data.quads.buffer);let P=6,G=0;for(let z=0;z<s.data.instancedDrawCallCount;z++){let U=s.data.instancedDrawCalls[z*2]*P,B=s.data.instancedDrawCalls[z*2+1];T.draw(P,B,U,G),G+=B}T.end()}function Mo(r){let s=-1,v=0;r.instancedDrawCallCount=0;for(let m=0;m<r.spriteCount;m++){let _=r.spriteData[m*12+11]&65535;_!==s&&(v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=s,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++),s=_,v=0),v++}v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=s,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++)}function Ce(r,s){let m=Math.round(r.viewport.width/1),_=Math.round(r.viewport.height/1),T=It.ortho(0,m,_,0,-10,10);Ot.set(0,0,0,Je);let P=It.translation(Je);r.device.queue.writeBuffer(s.data.uniformBuffer,0,P.buffer),r.device.queue.writeBuffer(s.data.uniformBuffer,64,T.buffer)}function Do(r){r.data.instancedDrawCalls=null,r.data.bindGroup=null,r.data.spriteBuffer.destroy(),r.data.spriteBuffer=null,r.data.uniformBuffer.destroy(),r.data.uniformBuffer=null,r.data.spriteData=null,r.data.spriteIndices.clear(),r.data.spriteIndices=null}var Te="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var nn={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(r,s={}){return So(r,s)},onRun:function(r,s,v){To(r,s,v)},onDestroy:function(r,s){},onResize:function(r,s){_o(r,s)},onViewportPosition:function(r,s){}};async function So(r,s){let{device:v}=r,m=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),_=v.createBindGroup({layout:m,entries:[{binding:0,resource:s.refs.in.data.view},{binding:1,resource:s.refs.in.data.sampler}]}),T=v.createPipelineLayout({bindGroupLayouts:[m]}),P=v.createRenderPipeline({label:"fb-blit",vertex:{module:v.createShaderModule({code:Te}),entryPoint:"vs_main",buffers:[]},fragment:{module:v.createShaderModule({code:Te}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:T});return{bindGroupLayout:m,bindGroup:_,pipeline:P}}function To(r,s,v){let{device:m}=r,_=v.beginRenderPass({colorAttachments:[{view:s.refs.out,clearValue:r.clearValue,loadOp:"load",storeOp:"store"}]});_.setPipeline(s.data.pipeline),_.setBindGroup(0,s.data.bindGroup),_.draw(3),_.end()}function _o(r,s){let{device:v}=r;s.data.bindGroup=v.createBindGroup({layout:s.data.bindGroupLayout,entries:[{binding:0,resource:s.refs.in.data.view},{binding:1,resource:s.refs.in.data.sampler}]})}var on="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function ie(r,s,v,m,_,T=1){let P=ue.sub(m,v),G=ue.normalize(P),z=Bo(G),U=T/2,B=s.data.vertexCount*6;s.data.vertices[B+0]=v[0]+z[0]*U,s.data.vertices[B+1]=v[1]+z[1]*U,s.data.vertices[B+2]=_[0],s.data.vertices[B+3]=_[1],s.data.vertices[B+4]=_[2],s.data.vertices[B+5]=_[3],s.data.vertices[B+6]=v[0]-z[0]*U,s.data.vertices[B+7]=v[1]-z[1]*U,s.data.vertices[B+8]=_[0],s.data.vertices[B+9]=_[1],s.data.vertices[B+10]=_[2],s.data.vertices[B+11]=_[3],s.data.vertices[B+12]=m[0]+z[0]*U,s.data.vertices[B+13]=m[1]+z[1]*U,s.data.vertices[B+14]=_[0],s.data.vertices[B+15]=_[1],s.data.vertices[B+16]=_[2],s.data.vertices[B+17]=_[3],s.data.vertices[B+18]=v[0]-z[0]*U,s.data.vertices[B+19]=v[1]-z[1]*U,s.data.vertices[B+20]=_[0],s.data.vertices[B+21]=_[1],s.data.vertices[B+22]=_[2],s.data.vertices[B+23]=_[3],s.data.vertices[B+24]=m[0]+z[0]*U,s.data.vertices[B+25]=m[1]+z[1]*U,s.data.vertices[B+26]=_[0],s.data.vertices[B+27]=_[1],s.data.vertices[B+28]=_[2],s.data.vertices[B+29]=_[3],s.data.vertices[B+30]=m[0]-z[0]*U,s.data.vertices[B+31]=m[1]-z[1]*U,s.data.vertices[B+32]=_[0],s.data.vertices[B+33]=_[1],s.data.vertices[B+34]=_[2],s.data.vertices[B+35]=_[3],s.data.vertexCount+=6,r.device.queue.writeBuffer(s.data.vertexBuffer,0,s.data.vertices.buffer)}function Bo(r){return[-r[1],r[0]]}var sn={line:ie,filledEllipse:function(r,s,v,m,_,T,P){let[G,z]=v,U=2*Math.PI/T;for(let B=0;B<T;B++){let R=B*U,H=(B+1)*U,$=G+m*Math.cos(R),Y=z+_*Math.sin(R),F=G+m*Math.cos(H),et=z+_*Math.sin(H),j=s.data.vertexCount*6+B*18;s.data.vertices[j+0]=G,s.data.vertices[j+1]=z,s.data.vertices[j+2]=P[0],s.data.vertices[j+3]=P[1],s.data.vertices[j+4]=P[2],s.data.vertices[j+5]=P[3],s.data.vertices[j+6]=$,s.data.vertices[j+7]=Y,s.data.vertices[j+8]=P[0],s.data.vertices[j+9]=P[1],s.data.vertices[j+10]=P[2],s.data.vertices[j+11]=P[3],s.data.vertices[j+12]=F,s.data.vertices[j+13]=et,s.data.vertices[j+14]=P[0],s.data.vertices[j+15]=P[1],s.data.vertices[j+16]=P[2],s.data.vertices[j+17]=P[3]}s.data.vertexCount+=3*T,r.device.queue.writeBuffer(s.data.vertexBuffer,0,s.data.vertices.buffer)},box:function(r,s,v,m,_,T,P=0,G=1){let[z,U]=v,B=m/2,R=_/2,H=[z-B,U-R],$=[z+B,U-R],Y=[z-B,U+R],F=[z+B,U+R];P!==0&&(Kt(H,v,P,H),Kt($,v,P,$),Kt(Y,v,P,Y),Kt(F,v,P,F)),ie(r,s,H,$,T,G),ie(r,s,Y,F,T,G),ie(r,s,H,Y,T,G),ie(r,s,$,F,T,G)},filledBox:function(r,s,v,m,_,T,P=0){let[G,z]=v,U=m/2,B=_/2,R=[G-U,z-B],H=[G+U,z-B],$=[G-U,z+B],Y=[G+U,z+B];P!==0&&(Kt(R,v,P,R),Kt(H,v,P,H),Kt($,v,P,$),Kt(Y,v,P,Y));let F=s.data.vertexCount*6;s.data.vertices[F+0]=R[0],s.data.vertices[F+1]=R[1],s.data.vertices[F+2]=T[0],s.data.vertices[F+3]=T[1],s.data.vertices[F+4]=T[2],s.data.vertices[F+5]=T[3],s.data.vertices[F+6]=$[0],s.data.vertices[F+7]=$[1],s.data.vertices[F+8]=T[0],s.data.vertices[F+9]=T[1],s.data.vertices[F+10]=T[2],s.data.vertices[F+11]=T[3],s.data.vertices[F+12]=H[0],s.data.vertices[F+13]=H[1],s.data.vertices[F+14]=T[0],s.data.vertices[F+15]=T[1],s.data.vertices[F+16]=T[2],s.data.vertices[F+17]=T[3],s.data.vertices[F+18]=$[0],s.data.vertices[F+19]=$[1],s.data.vertices[F+20]=T[0],s.data.vertices[F+21]=T[1],s.data.vertices[F+22]=T[2],s.data.vertices[F+23]=T[3],s.data.vertices[F+24]=Y[0],s.data.vertices[F+25]=Y[1],s.data.vertices[F+26]=T[0],s.data.vertices[F+27]=T[1],s.data.vertices[F+28]=T[2],s.data.vertices[F+29]=T[3],s.data.vertices[F+30]=H[0],s.data.vertices[F+31]=H[1],s.data.vertices[F+32]=T[0],s.data.vertices[F+33]=T[1],s.data.vertices[F+34]=T[2],s.data.vertices[F+35]=T[3],s.data.vertexCount+=6,r.device.queue.writeBuffer(s.data.vertexBuffer,0,s.data.vertices.buffer)},clear:function(r,s){s.data.vertexCount=0}};function Kt(r,s,v,m){let _=r[0]-s[0],T=r[1]-s[1],P=Math.sin(v),G=Math.cos(v);return m[0]=_*G-T*P+s[0],m[1]=_*P+T*G+s[1],m}var rn=Ot.create(0,0,0),an={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(r,s={}){return zo(r,s)},onRun:function(r,s,v){Go(r,s,v)},onDestroy:function(r,s){Uo(s)},onResize:function(r,s){cn(r,s)},onViewportPosition:function(r,s){cn(r,s)},customFunctions:sn};async function zo(r,s){let{device:v}=r,m=new Float32Array(1e4),_=v.createBuffer({size:m.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),T=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),P=v.createShaderModule({code:on}),G=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),z=v.createPipelineLayout({bindGroupLayouts:[G]}),U=v.createBindGroup({layout:G,entries:[{binding:0,resource:{buffer:T}}]}),B=v.createRenderPipeline({layout:z,vertex:{module:P,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:P,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:T,vertexBuffer:_,pipeline:B,bindGroup:U,vertexCount:0,vertices:m}}function Go(r,s,v){if(s.data.vertexCount===0)return;let{device:m}=r,_=s.options.loadOp||"load",T=v.beginRenderPass({colorAttachments:[{view:s.refs.color,clearValue:r.clearValue,loadOp:_,storeOp:"store"}]});T.setPipeline(s.data.pipeline),T.setBindGroup(0,s.data.bindGroup),T.setVertexBuffer(0,s.data.vertexBuffer),T.draw(s.data.vertexCount),T.end()}function Uo(r){r.data.vertexBuffer.destroy(),r.data.vertexBuffer=null,r.data.uniformBuffer.destroy(),r.data.uniformBuffer=null}function cn(r,s){let{device:v}=r,m=r.viewport.width/r.viewport.zoom,_=r.viewport.height/r.viewport.zoom,T=It.ortho(0,m,_,0,-10,10);Ot.set(-r.viewport.position[0],-r.viewport.position[1],0,rn);let P=It.translation(rn);v.queue.writeBuffer(s.data.uniformBuffer,0,P.buffer),v.queue.writeBuffer(s.data.uniformBuffer,64,T.buffer)}var _e={};Ge(_e,{setAmbientLight:()=>Eo,setLights:()=>Lo,setOccluders:()=>Ao});function Lo(r,s,v){s.data.lights=v,s.data.lightsBufferNeedsUpdate=!0}function Eo(r,s,v){s.data.lightsRenderer.setAmbientLight(v)}function Ao(r,s,v){s.data.lightsRenderer.setObstacles(v),s.data.lightsTextureNeedsUpdate=!0}function Io(r,s){return class extends r{constructor(...v){super(...v),s(this)}}}var Fo=Io(Array,r=>r.fill(0)),k=1e-6;function Ro(r){function s(t=0,a=0){let e=new r(2);return t!==void 0&&(e[0]=t,a!==void 0&&(e[1]=a)),e}let v=s;function m(t,a,e){let o=e??new r(2);return o[0]=t,o[1]=a,o}function _(t,a){let e=a??new r(2);return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function T(t,a){let e=a??new r(2);return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function P(t,a){let e=a??new r(2);return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function G(t,a=0,e=1,o){let f=o??new r(2);return f[0]=Math.min(e,Math.max(a,t[0])),f[1]=Math.min(e,Math.max(a,t[1])),f}function z(t,a,e){let o=e??new r(2);return o[0]=t[0]+a[0],o[1]=t[1]+a[1],o}function U(t,a,e,o){let f=o??new r(2);return f[0]=t[0]+a[0]*e,f[1]=t[1]+a[1]*e,f}function B(t,a){let e=t[0],o=t[1],f=a[0],g=a[1],D=Math.sqrt(e*e+o*o),u=Math.sqrt(f*f+g*g),l=D*u,w=l&&bt(t,a)/l;return Math.acos(w)}function R(t,a,e){let o=e??new r(2);return o[0]=t[0]-a[0],o[1]=t[1]-a[1],o}let H=R;function $(t,a){return Math.abs(t[0]-a[0])<k&&Math.abs(t[1]-a[1])<k}function Y(t,a){return t[0]===a[0]&&t[1]===a[1]}function F(t,a,e,o){let f=o??new r(2);return f[0]=t[0]+e*(a[0]-t[0]),f[1]=t[1]+e*(a[1]-t[1]),f}function et(t,a,e,o){let f=o??new r(2);return f[0]=t[0]+e[0]*(a[0]-t[0]),f[1]=t[1]+e[1]*(a[1]-t[1]),f}function j(t,a,e){let o=e??new r(2);return o[0]=Math.max(t[0],a[0]),o[1]=Math.max(t[1],a[1]),o}function C(t,a,e){let o=e??new r(2);return o[0]=Math.min(t[0],a[0]),o[1]=Math.min(t[1],a[1]),o}function tt(t,a,e){let o=e??new r(2);return o[0]=t[0]*a,o[1]=t[1]*a,o}let Mt=tt;function ft(t,a,e){let o=e??new r(2);return o[0]=t[0]/a,o[1]=t[1]/a,o}function lt(t,a){let e=a??new r(2);return e[0]=1/t[0],e[1]=1/t[1],e}let Dt=lt;function vt(t,a,e){let o=e??new r(3),f=t[0]*a[1]-t[1]*a[0];return o[0]=0,o[1]=0,o[2]=f,o}function bt(t,a){return t[0]*a[0]+t[1]*a[1]}function nt(t){let a=t[0],e=t[1];return Math.sqrt(a*a+e*e)}let Bt=nt;function q(t){let a=t[0],e=t[1];return a*a+e*e}let X=q;function V(t,a){let e=t[0]-a[0],o=t[1]-a[1];return Math.sqrt(e*e+o*o)}let Gt=V;function dt(t,a){let e=t[0]-a[0],o=t[1]-a[1];return e*e+o*o}let Ut=dt;function pt(t,a){let e=a??new r(2),o=t[0],f=t[1],g=Math.sqrt(o*o+f*f);return g>1e-5?(e[0]=o/g,e[1]=f/g):(e[0]=0,e[1]=0),e}function Lt(t,a){let e=a??new r(2);return e[0]=-t[0],e[1]=-t[1],e}function W(t,a){let e=a??new r(2);return e[0]=t[0],e[1]=t[1],e}let Et=W;function mt(t,a,e){let o=e??new r(2);return o[0]=t[0]*a[0],o[1]=t[1]*a[1],o}let At=mt;function yt(t,a,e){let o=e??new r(2);return o[0]=t[0]/a[0],o[1]=t[1]/a[1],o}let zt=yt;function St(t=1,a){let e=a??new r(2),o=Math.random()*2*Math.PI;return e[0]=Math.cos(o)*t,e[1]=Math.sin(o)*t,e}function i(t){let a=t??new r(2);return a[0]=0,a[1]=0,a}function p(t,a,e){let o=e??new r(2),f=t[0],g=t[1];return o[0]=f*a[0]+g*a[4]+a[12],o[1]=f*a[1]+g*a[5]+a[13],o}function n(t,a,e){let o=e??new r(2),f=t[0],g=t[1];return o[0]=a[0]*f+a[4]*g+a[8],o[1]=a[1]*f+a[5]*g+a[9],o}function c(t,a,e,o){let f=o??new r(2),g=t[0]-a[0],D=t[1]-a[1],u=Math.sin(e),l=Math.cos(e);return f[0]=g*l-D*u+a[0],f[1]=g*u+D*l+a[1],f}function d(t,a,e){let o=e??new r(2);return pt(t,o),tt(o,a,o)}function h(t,a,e){let o=e??new r(2);return nt(t)>a?d(t,a,o):W(t,o)}function M(t,a,e){let o=e??new r(2);return F(t,a,.5,o)}return{create:s,fromValues:v,set:m,ceil:_,floor:T,round:P,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:H,equalsApproximately:$,equals:Y,lerp:F,lerpV:et,max:j,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:lt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:X,distance:V,dist:Gt,distanceSq:dt,distSq:Ut,normalize:pt,negate:Lt,copy:W,clone:Et,multiply:mt,mul:At,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat3:n,rotate:c,setLength:d,truncate:h,midpoint:M}}var un=new Map;function wn(r){let s=un.get(r);return s||(s=Ro(r),un.set(r,s)),s}function Oo(r){function s(u,l,w){let x=new r(3);return u!==void 0&&(x[0]=u,l!==void 0&&(x[1]=l,w!==void 0&&(x[2]=w))),x}let v=s;function m(u,l,w,x){let y=x??new r(3);return y[0]=u,y[1]=l,y[2]=w,y}function _(u,l){let w=l??new r(3);return w[0]=Math.ceil(u[0]),w[1]=Math.ceil(u[1]),w[2]=Math.ceil(u[2]),w}function T(u,l){let w=l??new r(3);return w[0]=Math.floor(u[0]),w[1]=Math.floor(u[1]),w[2]=Math.floor(u[2]),w}function P(u,l){let w=l??new r(3);return w[0]=Math.round(u[0]),w[1]=Math.round(u[1]),w[2]=Math.round(u[2]),w}function G(u,l=0,w=1,x){let y=x??new r(3);return y[0]=Math.min(w,Math.max(l,u[0])),y[1]=Math.min(w,Math.max(l,u[1])),y[2]=Math.min(w,Math.max(l,u[2])),y}function z(u,l,w){let x=w??new r(3);return x[0]=u[0]+l[0],x[1]=u[1]+l[1],x[2]=u[2]+l[2],x}function U(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+l[0]*w,y[1]=u[1]+l[1]*w,y[2]=u[2]+l[2]*w,y}function B(u,l){let w=u[0],x=u[1],y=u[2],b=l[0],S=l[1],E=l[2],I=Math.sqrt(w*w+x*x+y*y),L=Math.sqrt(b*b+S*S+E*E),A=I*L,O=A&&bt(u,l)/A;return Math.acos(O)}function R(u,l,w){let x=w??new r(3);return x[0]=u[0]-l[0],x[1]=u[1]-l[1],x[2]=u[2]-l[2],x}let H=R;function $(u,l){return Math.abs(u[0]-l[0])<k&&Math.abs(u[1]-l[1])<k&&Math.abs(u[2]-l[2])<k}function Y(u,l){return u[0]===l[0]&&u[1]===l[1]&&u[2]===l[2]}function F(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w*(l[0]-u[0]),y[1]=u[1]+w*(l[1]-u[1]),y[2]=u[2]+w*(l[2]-u[2]),y}function et(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w[0]*(l[0]-u[0]),y[1]=u[1]+w[1]*(l[1]-u[1]),y[2]=u[2]+w[2]*(l[2]-u[2]),y}function j(u,l,w){let x=w??new r(3);return x[0]=Math.max(u[0],l[0]),x[1]=Math.max(u[1],l[1]),x[2]=Math.max(u[2],l[2]),x}function C(u,l,w){let x=w??new r(3);return x[0]=Math.min(u[0],l[0]),x[1]=Math.min(u[1],l[1]),x[2]=Math.min(u[2],l[2]),x}function tt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l,x[1]=u[1]*l,x[2]=u[2]*l,x}let Mt=tt;function ft(u,l,w){let x=w??new r(3);return x[0]=u[0]/l,x[1]=u[1]/l,x[2]=u[2]/l,x}function lt(u,l){let w=l??new r(3);return w[0]=1/u[0],w[1]=1/u[1],w[2]=1/u[2],w}let Dt=lt;function vt(u,l,w){let x=w??new r(3),y=u[2]*l[0]-u[0]*l[2],b=u[0]*l[1]-u[1]*l[0];return x[0]=u[1]*l[2]-u[2]*l[1],x[1]=y,x[2]=b,x}function bt(u,l){return u[0]*l[0]+u[1]*l[1]+u[2]*l[2]}function nt(u){let l=u[0],w=u[1],x=u[2];return Math.sqrt(l*l+w*w+x*x)}let Bt=nt;function q(u){let l=u[0],w=u[1],x=u[2];return l*l+w*w+x*x}let X=q;function V(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return Math.sqrt(w*w+x*x+y*y)}let Gt=V;function dt(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return w*w+x*x+y*y}let Ut=dt;function pt(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=Math.sqrt(x*x+y*y+b*b);return S>1e-5?(w[0]=x/S,w[1]=y/S,w[2]=b/S):(w[0]=0,w[1]=0,w[2]=0),w}function Lt(u,l){let w=l??new r(3);return w[0]=-u[0],w[1]=-u[1],w[2]=-u[2],w}function W(u,l){let w=l??new r(3);return w[0]=u[0],w[1]=u[1],w[2]=u[2],w}let Et=W;function mt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l[0],x[1]=u[1]*l[1],x[2]=u[2]*l[2],x}let At=mt;function yt(u,l,w){let x=w??new r(3);return x[0]=u[0]/l[0],x[1]=u[1]/l[1],x[2]=u[2]/l[2],x}let zt=yt;function St(u=1,l){let w=l??new r(3),x=Math.random()*2*Math.PI,y=Math.random()*2-1,b=Math.sqrt(1-y*y)*u;return w[0]=Math.cos(x)*b,w[1]=Math.sin(x)*b,w[2]=y*u,w}function i(u){let l=u??new r(3);return l[0]=0,l[1]=0,l[2]=0,l}function p(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2],E=l[3]*y+l[7]*b+l[11]*S+l[15]||1;return x[0]=(l[0]*y+l[4]*b+l[8]*S+l[12])/E,x[1]=(l[1]*y+l[5]*b+l[9]*S+l[13])/E,x[2]=(l[2]*y+l[6]*b+l[10]*S+l[14])/E,x}function n(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0*4+0]+b*l[1*4+0]+S*l[2*4+0],x[1]=y*l[0*4+1]+b*l[1*4+1]+S*l[2*4+1],x[2]=y*l[0*4+2]+b*l[1*4+2]+S*l[2*4+2],x}function c(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0]+b*l[4]+S*l[8],x[1]=y*l[1]+b*l[5]+S*l[9],x[2]=y*l[2]+b*l[6]+S*l[10],x}function d(u,l,w){let x=w??new r(3),y=l[0],b=l[1],S=l[2],E=l[3]*2,I=u[0],L=u[1],A=u[2],O=b*A-S*L,N=S*I-y*A,Z=y*L-b*I;return x[0]=I+O*E+(b*Z-S*N)*2,x[1]=L+N*E+(S*O-y*Z)*2,x[2]=A+Z*E+(y*N-b*O)*2,x}function h(u,l){let w=l??new r(3);return w[0]=u[12],w[1]=u[13],w[2]=u[14],w}function M(u,l,w){let x=w??new r(3),y=l*4;return x[0]=u[y+0],x[1]=u[y+1],x[2]=u[y+2],x}function t(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=u[4],E=u[5],I=u[6],L=u[8],A=u[9],O=u[10];return w[0]=Math.sqrt(x*x+y*y+b*b),w[1]=Math.sqrt(S*S+E*E+I*I),w[2]=Math.sqrt(L*L+A*A+O*O),w}function a(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0],S[1]=b[1]*Math.cos(w)-b[2]*Math.sin(w),S[2]=b[1]*Math.sin(w)+b[2]*Math.cos(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function e(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[2]*Math.sin(w)+b[0]*Math.cos(w),S[1]=b[1],S[2]=b[2]*Math.cos(w)-b[0]*Math.sin(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function o(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0]*Math.cos(w)-b[1]*Math.sin(w),S[1]=b[0]*Math.sin(w)+b[1]*Math.cos(w),S[2]=b[2],y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function f(u,l,w){let x=w??new r(3);return pt(u,x),tt(x,l,x)}function g(u,l,w){let x=w??new r(3);return nt(u)>l?f(u,l,x):W(u,x)}function D(u,l,w){let x=w??new r(3);return F(u,l,.5,x)}return{create:s,fromValues:v,set:m,ceil:_,floor:T,round:P,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:H,equalsApproximately:$,equals:Y,lerp:F,lerpV:et,max:j,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:lt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:X,distance:V,dist:Gt,distanceSq:dt,distSq:Ut,normalize:pt,negate:Lt,copy:W,clone:Et,multiply:mt,mul:At,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat4Upper3x3:n,transformMat3:c,transformQuat:d,getTranslation:h,getAxis:M,getScaling:t,rotateX:a,rotateY:e,rotateZ:o,setLength:f,truncate:g,midpoint:D}}var fn=new Map;function le(r){let s=fn.get(r);return s||(s=Oo(r),fn.set(r,s)),s}function Vo(r){let s=wn(r),v=le(r);function m(i,p,n,c,d,h,M,t,a){let e=new r(12);return e[3]=0,e[7]=0,e[11]=0,i!==void 0&&(e[0]=i,p!==void 0&&(e[1]=p,n!==void 0&&(e[2]=n,c!==void 0&&(e[4]=c,d!==void 0&&(e[5]=d,h!==void 0&&(e[6]=h,M!==void 0&&(e[8]=M,t!==void 0&&(e[9]=t,a!==void 0&&(e[10]=a))))))))),e}function _(i,p,n,c,d,h,M,t,a,e){let o=e??new r(12);return o[0]=i,o[1]=p,o[2]=n,o[3]=0,o[4]=c,o[5]=d,o[6]=h,o[7]=0,o[8]=M,o[9]=t,o[10]=a,o[11]=0,o}function T(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=0,n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=0,n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=0,n}function P(i,p){let n=p??new r(12),c=i[0],d=i[1],h=i[2],M=i[3],t=c+c,a=d+d,e=h+h,o=c*t,f=d*t,g=d*a,D=h*t,u=h*a,l=h*e,w=M*t,x=M*a,y=M*e;return n[0]=1-g-l,n[1]=f+y,n[2]=D-x,n[3]=0,n[4]=f-y,n[5]=1-o-l,n[6]=u+w,n[7]=0,n[8]=D+x,n[9]=u-w,n[10]=1-o-g,n[11]=0,n}function G(i,p){let n=p??new r(12);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[4]=-i[4],n[5]=-i[5],n[6]=-i[6],n[8]=-i[8],n[9]=-i[9],n[10]=-i[10],n}function z(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[8]=i[8],n[9]=i[9],n[10]=i[10],n}let U=z;function B(i,p){return Math.abs(i[0]-p[0])<k&&Math.abs(i[1]-p[1])<k&&Math.abs(i[2]-p[2])<k&&Math.abs(i[4]-p[4])<k&&Math.abs(i[5]-p[5])<k&&Math.abs(i[6]-p[6])<k&&Math.abs(i[8]-p[8])<k&&Math.abs(i[9]-p[9])<k&&Math.abs(i[10]-p[10])<k}function R(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[4]===p[4]&&i[5]===p[5]&&i[6]===p[6]&&i[8]===p[8]&&i[9]===p[9]&&i[10]===p[10]}function H(i){let p=i??new r(12);return p[0]=1,p[1]=0,p[2]=0,p[4]=0,p[5]=1,p[6]=0,p[8]=0,p[9]=0,p[10]=1,p}function $(i,p){let n=p??new r(12);if(n===i){let g;return g=i[1],i[1]=i[4],i[4]=g,g=i[2],i[2]=i[8],i[8]=g,g=i[6],i[6]=i[9],i[9]=g,n}let c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],o=i[2*4+1],f=i[2*4+2];return n[0]=c,n[1]=M,n[2]=e,n[4]=d,n[5]=t,n[6]=o,n[8]=h,n[9]=a,n[10]=f,n}function Y(i,p){let n=p??new r(12),c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],o=i[2*4+1],f=i[2*4+2],g=f*t-a*o,D=-f*M+a*e,u=o*M-t*e,l=1/(c*g+d*D+h*u);return n[0]=g*l,n[1]=(-f*d+h*o)*l,n[2]=(a*d-h*t)*l,n[4]=D*l,n[5]=(f*c-h*e)*l,n[6]=(-a*c+h*M)*l,n[8]=u*l,n[9]=(-o*c+d*e)*l,n[10]=(t*c-d*M)*l,n}function F(i){let p=i[0],n=i[0*4+1],c=i[0*4+2],d=i[1*4+0],h=i[1*4+1],M=i[1*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2];return p*(h*e-a*M)-d*(n*e-a*c)+t*(n*M-h*c)}let et=Y;function j(i,p,n){let c=n??new r(12),d=i[0],h=i[1],M=i[2],t=i[4],a=i[5],e=i[6],o=i[8],f=i[9],g=i[10],D=p[0],u=p[1],l=p[2],w=p[4],x=p[5],y=p[6],b=p[8],S=p[9],E=p[10];return c[0]=d*D+t*u+o*l,c[1]=h*D+a*u+f*l,c[2]=M*D+e*u+g*l,c[4]=d*w+t*x+o*y,c[5]=h*w+a*x+f*y,c[6]=M*w+e*x+g*y,c[8]=d*b+t*S+o*E,c[9]=h*b+a*S+f*E,c[10]=M*b+e*S+g*E,c}let C=j;function tt(i,p,n){let c=n??H();return i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2],c[4]=i[4],c[5]=i[5],c[6]=i[6]),c[8]=p[0],c[9]=p[1],c[10]=1,c}function Mt(i,p){let n=p??s.create();return n[0]=i[8],n[1]=i[9],n}function ft(i,p,n){let c=n??s.create(),d=p*4;return c[0]=i[d+0],c[1]=i[d+1],c}function lt(i,p,n,c){let d=c===i?i:z(i,c),h=n*4;return d[h+0]=p[0],d[h+1]=p[1],d}function Dt(i,p){let n=p??s.create(),c=i[0],d=i[1],h=i[4],M=i[5];return n[0]=Math.sqrt(c*c+d*d),n[1]=Math.sqrt(h*h+M*M),n}function vt(i,p){let n=p??v.create(),c=i[0],d=i[1],h=i[2],M=i[4],t=i[5],a=i[6],e=i[8],o=i[9],f=i[10];return n[0]=Math.sqrt(c*c+d*d+h*h),n[1]=Math.sqrt(M*M+t*t+a*a),n[2]=Math.sqrt(e*e+o*o+f*f),n}function bt(i,p){let n=p??new r(12);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=1,n[6]=0,n[8]=i[0],n[9]=i[1],n[10]=1,n}function nt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=i[0],t=i[1],a=i[2],e=i[1*4+0],o=i[1*4+1],f=i[1*4+2],g=i[2*4+0],D=i[2*4+1],u=i[2*4+2];return i!==c&&(c[0]=M,c[1]=t,c[2]=a,c[4]=e,c[5]=o,c[6]=f),c[8]=M*d+e*h+g,c[9]=t*d+o*h+D,c[10]=a*d+f*h+u,c}function Bt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=d,n[2]=0,n[4]=-d,n[5]=c,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function q(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[1*4+0],a=i[1*4+1],e=i[1*4+2],o=Math.cos(p),f=Math.sin(p);return c[0]=o*d+f*t,c[1]=o*h+f*a,c[2]=o*M+f*e,c[4]=o*t-f*d,c[5]=o*a-f*h,c[6]=o*e-f*M,i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function X(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=c,n[6]=d,n[8]=0,n[9]=-d,n[10]=c,n}function V(i,p,n){let c=n??new r(12),d=i[4],h=i[5],M=i[6],t=i[8],a=i[9],e=i[10],o=Math.cos(p),f=Math.sin(p);return c[4]=o*d+f*t,c[5]=o*h+f*a,c[6]=o*M+f*e,c[8]=o*t-f*d,c[9]=o*a-f*h,c[10]=o*e-f*M,i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2]),c}function Gt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=0,n[2]=-d,n[4]=0,n[5]=1,n[6]=0,n[8]=d,n[9]=0,n[10]=c,n}function dt(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2],o=Math.cos(p),f=Math.sin(p);return c[0]=o*d-f*t,c[1]=o*h-f*a,c[2]=o*M-f*e,c[8]=o*t+f*d,c[9]=o*a+f*h,c[10]=o*e+f*M,i!==c&&(c[4]=i[4],c[5]=i[5],c[6]=i[6]),c}let Ut=Bt,pt=q;function Lt(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function W(i,p,n){let c=n??new r(12),d=p[0],h=p[1];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function Et(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=i[2],n}function mt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=p[2];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],c[8]=M*i[2*4+0],c[9]=M*i[2*4+1],c[10]=M*i[2*4+2],c}function At(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function yt(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function zt(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=i,n}function St(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],c[8]=p*i[2*4+0],c[9]=p*i[2*4+1],c[10]=p*i[2*4+2],c}return{clone:U,create:m,set:_,fromMat4:T,fromQuat:P,negate:G,copy:z,equalsApproximately:B,equals:R,identity:H,transpose:$,inverse:Y,invert:et,determinant:F,mul:C,multiply:j,setTranslation:tt,getTranslation:Mt,getAxis:ft,setAxis:lt,getScaling:Dt,get3DScaling:vt,translation:bt,translate:nt,rotation:Bt,rotate:q,rotationX:X,rotateX:V,rotationY:Gt,rotateY:dt,rotationZ:Ut,rotateZ:pt,scaling:Lt,scale:W,uniformScaling:At,uniformScale:yt,scaling3D:Et,scale3D:mt,uniformScaling3D:zt,uniformScale3D:St}}var ln=new Map;function qo(r){let s=ln.get(r);return s||(s=Vo(r),ln.set(r,s)),s}function No(r){let s=le(r);function v(t,a,e,o,f,g,D,u,l,w,x,y,b,S,E,I){let L=new r(16);return t!==void 0&&(L[0]=t,a!==void 0&&(L[1]=a,e!==void 0&&(L[2]=e,o!==void 0&&(L[3]=o,f!==void 0&&(L[4]=f,g!==void 0&&(L[5]=g,D!==void 0&&(L[6]=D,u!==void 0&&(L[7]=u,l!==void 0&&(L[8]=l,w!==void 0&&(L[9]=w,x!==void 0&&(L[10]=x,y!==void 0&&(L[11]=y,b!==void 0&&(L[12]=b,S!==void 0&&(L[13]=S,E!==void 0&&(L[14]=E,I!==void 0&&(L[15]=I)))))))))))))))),L}function m(t,a,e,o,f,g,D,u,l,w,x,y,b,S,E,I,L){let A=L??new r(16);return A[0]=t,A[1]=a,A[2]=e,A[3]=o,A[4]=f,A[5]=g,A[6]=D,A[7]=u,A[8]=l,A[9]=w,A[10]=x,A[11]=y,A[12]=b,A[13]=S,A[14]=E,A[15]=I,A}function _(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function T(t,a){let e=a??new r(16),o=t[0],f=t[1],g=t[2],D=t[3],u=o+o,l=f+f,w=g+g,x=o*u,y=f*u,b=f*l,S=g*u,E=g*l,I=g*w,L=D*u,A=D*l,O=D*w;return e[0]=1-b-I,e[1]=y+O,e[2]=S-A,e[3]=0,e[4]=y-O,e[5]=1-x-I,e[6]=E+L,e[7]=0,e[8]=S+A,e[9]=E-L,e[10]=1-x-b,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function P(t,a){let e=a??new r(16);return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function G(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}let z=G;function U(t,a){return Math.abs(t[0]-a[0])<k&&Math.abs(t[1]-a[1])<k&&Math.abs(t[2]-a[2])<k&&Math.abs(t[3]-a[3])<k&&Math.abs(t[4]-a[4])<k&&Math.abs(t[5]-a[5])<k&&Math.abs(t[6]-a[6])<k&&Math.abs(t[7]-a[7])<k&&Math.abs(t[8]-a[8])<k&&Math.abs(t[9]-a[9])<k&&Math.abs(t[10]-a[10])<k&&Math.abs(t[11]-a[11])<k&&Math.abs(t[12]-a[12])<k&&Math.abs(t[13]-a[13])<k&&Math.abs(t[14]-a[14])<k&&Math.abs(t[15]-a[15])<k}function B(t,a){return t[0]===a[0]&&t[1]===a[1]&&t[2]===a[2]&&t[3]===a[3]&&t[4]===a[4]&&t[5]===a[5]&&t[6]===a[6]&&t[7]===a[7]&&t[8]===a[8]&&t[9]===a[9]&&t[10]===a[10]&&t[11]===a[11]&&t[12]===a[12]&&t[13]===a[13]&&t[14]===a[14]&&t[15]===a[15]}function R(t){let a=t??new r(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function H(t,a){let e=a??new r(16);if(e===t){let N;return N=t[1],t[1]=t[4],t[4]=N,N=t[2],t[2]=t[8],t[8]=N,N=t[3],t[3]=t[12],t[12]=N,N=t[6],t[6]=t[9],t[9]=N,N=t[7],t[7]=t[13],t[13]=N,N=t[11],t[11]=t[14],t[14]=N,e}let o=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],I=t[3*4+0],L=t[3*4+1],A=t[3*4+2],O=t[3*4+3];return e[0]=o,e[1]=u,e[2]=y,e[3]=I,e[4]=f,e[5]=l,e[6]=b,e[7]=L,e[8]=g,e[9]=w,e[10]=S,e[11]=A,e[12]=D,e[13]=x,e[14]=E,e[15]=O,e}function $(t,a){let e=a??new r(16),o=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],I=t[3*4+0],L=t[3*4+1],A=t[3*4+2],O=t[3*4+3],N=S*O,Z=A*E,K=w*O,J=A*x,ot=w*E,st=S*x,rt=g*O,it=A*D,ct=g*E,at=S*D,ht=g*x,wt=w*D,gt=y*L,xt=I*b,Tt=u*L,_t=I*l,Pt=u*b,Yt=y*l,Xt=o*L,Ht=I*f,jt=o*b,Wt=y*f,Zt=o*l,Qt=u*f,Ct=N*l+J*b+ot*L-(Z*l+K*b+st*L),te=Z*f+rt*b+at*L-(N*f+it*b+ct*L),ee=K*f+it*l+ht*L-(J*f+rt*l+wt*L),ne=st*f+ct*l+wt*b-(ot*f+at*l+ht*b),ut=1/(o*Ct+u*te+y*ee+I*ne);return e[0]=ut*Ct,e[1]=ut*te,e[2]=ut*ee,e[3]=ut*ne,e[4]=ut*(Z*u+K*y+st*I-(N*u+J*y+ot*I)),e[5]=ut*(N*o+it*y+ct*I-(Z*o+rt*y+at*I)),e[6]=ut*(J*o+rt*u+wt*I-(K*o+it*u+ht*I)),e[7]=ut*(ot*o+at*u+ht*y-(st*o+ct*u+wt*y)),e[8]=ut*(gt*x+_t*E+Pt*O-(xt*x+Tt*E+Yt*O)),e[9]=ut*(xt*D+Xt*E+Wt*O-(gt*D+Ht*E+jt*O)),e[10]=ut*(Tt*D+Ht*x+Zt*O-(_t*D+Xt*x+Qt*O)),e[11]=ut*(Yt*D+jt*x+Qt*E-(Pt*D+Wt*x+Zt*E)),e[12]=ut*(Tt*S+Yt*A+xt*w-(Pt*A+gt*w+_t*S)),e[13]=ut*(jt*A+gt*g+Ht*S-(Xt*S+Wt*A+xt*g)),e[14]=ut*(Xt*w+Qt*A+_t*g-(Zt*A+Tt*g+Ht*w)),e[15]=ut*(Zt*S+Pt*g+Wt*w-(jt*w+Qt*S+Yt*g)),e}function Y(t){let a=t[0],e=t[0*4+1],o=t[0*4+2],f=t[0*4+3],g=t[1*4+0],D=t[1*4+1],u=t[1*4+2],l=t[1*4+3],w=t[2*4+0],x=t[2*4+1],y=t[2*4+2],b=t[2*4+3],S=t[3*4+0],E=t[3*4+1],I=t[3*4+2],L=t[3*4+3],A=y*L,O=I*b,N=u*L,Z=I*l,K=u*b,J=y*l,ot=o*L,st=I*f,rt=o*b,it=y*f,ct=o*l,at=u*f,ht=A*D+Z*x+K*E-(O*D+N*x+J*E),wt=O*e+ot*x+it*E-(A*e+st*x+rt*E),gt=N*e+st*D+ct*E-(Z*e+ot*D+at*E),xt=J*e+rt*D+at*x-(K*e+it*D+ct*x);return a*ht+g*wt+w*gt+S*xt}let F=$;function et(t,a,e){let o=e??new r(16),f=t[0],g=t[1],D=t[2],u=t[3],l=t[4],w=t[5],x=t[6],y=t[7],b=t[8],S=t[9],E=t[10],I=t[11],L=t[12],A=t[13],O=t[14],N=t[15],Z=a[0],K=a[1],J=a[2],ot=a[3],st=a[4],rt=a[5],it=a[6],ct=a[7],at=a[8],ht=a[9],wt=a[10],gt=a[11],xt=a[12],Tt=a[13],_t=a[14],Pt=a[15];return o[0]=f*Z+l*K+b*J+L*ot,o[1]=g*Z+w*K+S*J+A*ot,o[2]=D*Z+x*K+E*J+O*ot,o[3]=u*Z+y*K+I*J+N*ot,o[4]=f*st+l*rt+b*it+L*ct,o[5]=g*st+w*rt+S*it+A*ct,o[6]=D*st+x*rt+E*it+O*ct,o[7]=u*st+y*rt+I*it+N*ct,o[8]=f*at+l*ht+b*wt+L*gt,o[9]=g*at+w*ht+S*wt+A*gt,o[10]=D*at+x*ht+E*wt+O*gt,o[11]=u*at+y*ht+I*wt+N*gt,o[12]=f*xt+l*Tt+b*_t+L*Pt,o[13]=g*xt+w*Tt+S*_t+A*Pt,o[14]=D*xt+x*Tt+E*_t+O*Pt,o[15]=u*xt+y*Tt+I*_t+N*Pt,o}let j=et;function C(t,a,e){let o=e??R();return t!==o&&(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11]),o[12]=a[0],o[13]=a[1],o[14]=a[2],o[15]=1,o}function tt(t,a){let e=a??s.create();return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Mt(t,a,e){let o=e??s.create(),f=a*4;return o[0]=t[f+0],o[1]=t[f+1],o[2]=t[f+2],o}function ft(t,a,e,o){let f=o===t?o:G(t,o),g=e*4;return f[g+0]=a[0],f[g+1]=a[1],f[g+2]=a[2],f}function lt(t,a){let e=a??s.create(),o=t[0],f=t[1],g=t[2],D=t[4],u=t[5],l=t[6],w=t[8],x=t[9],y=t[10];return e[0]=Math.sqrt(o*o+f*f+g*g),e[1]=Math.sqrt(D*D+u*u+l*l),e[2]=Math.sqrt(w*w+x*x+y*y),e}function Dt(t,a,e,o,f){let g=f??new r(16),D=Math.tan(Math.PI*.5-.5*t);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(o)){let u=1/(e-o);g[10]=o*u,g[14]=o*e*u}else g[10]=-1,g[14]=-e;return g}function vt(t,a,e,o=1/0,f){let g=f??new r(16),D=1/Math.tan(t*.5);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,o===1/0)g[10]=0,g[14]=e;else{let u=1/(o-e);g[10]=e*u,g[14]=o*e*u}return g}function bt(t,a,e,o,f,g,D){let u=D??new r(16);return u[0]=2/(a-t),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(o-e),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1/(f-g),u[11]=0,u[12]=(a+t)/(t-a),u[13]=(o+e)/(e-o),u[14]=f/(f-g),u[15]=1,u}function nt(t,a,e,o,f,g,D){let u=D??new r(16),l=a-t,w=o-e,x=f-g;return u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(o+e)/w,u[10]=g/x,u[11]=-1,u[12]=0,u[13]=0,u[14]=f*g/x,u[15]=0,u}function Bt(t,a,e,o,f,g=1/0,D){let u=D??new r(16),l=a-t,w=o-e;if(u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(o+e)/w,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,g===1/0)u[10]=0,u[14]=f;else{let x=1/(g-f);u[10]=f*x,u[14]=g*f*x}return u}let q=s.create(),X=s.create(),V=s.create();function Gt(t,a,e,o){let f=o??new r(16);return s.normalize(s.subtract(a,t,V),V),s.normalize(s.cross(e,V,q),q),s.normalize(s.cross(V,q,X),X),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=X[0],f[5]=X[1],f[6]=X[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function dt(t,a,e,o){let f=o??new r(16);return s.normalize(s.subtract(t,a,V),V),s.normalize(s.cross(e,V,q),q),s.normalize(s.cross(V,q,X),X),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=X[0],f[5]=X[1],f[6]=X[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function Ut(t,a,e,o){let f=o??new r(16);return s.normalize(s.subtract(t,a,V),V),s.normalize(s.cross(e,V,q),q),s.normalize(s.cross(V,q,X),X),f[0]=q[0],f[1]=X[0],f[2]=V[0],f[3]=0,f[4]=q[1],f[5]=X[1],f[6]=V[1],f[7]=0,f[8]=q[2],f[9]=X[2],f[10]=V[2],f[11]=0,f[12]=-(q[0]*t[0]+q[1]*t[1]+q[2]*t[2]),f[13]=-(X[0]*t[0]+X[1]*t[1]+X[2]*t[2]),f[14]=-(V[0]*t[0]+V[1]*t[1]+V[2]*t[2]),f[15]=1,f}function pt(t,a){let e=a??new r(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Lt(t,a,e){let o=e??new r(16),f=a[0],g=a[1],D=a[2],u=t[0],l=t[1],w=t[2],x=t[3],y=t[1*4+0],b=t[1*4+1],S=t[1*4+2],E=t[1*4+3],I=t[2*4+0],L=t[2*4+1],A=t[2*4+2],O=t[2*4+3],N=t[3*4+0],Z=t[3*4+1],K=t[3*4+2],J=t[3*4+3];return t!==o&&(o[0]=u,o[1]=l,o[2]=w,o[3]=x,o[4]=y,o[5]=b,o[6]=S,o[7]=E,o[8]=I,o[9]=L,o[10]=A,o[11]=O),o[12]=u*f+y*g+I*D+N,o[13]=l*f+b*g+L*D+Z,o[14]=w*f+S*g+A*D+K,o[15]=x*f+E*g+O*D+J,o}function W(t,a){let e=a??new r(16),o=Math.cos(t),f=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=f,e[7]=0,e[8]=0,e[9]=-f,e[10]=o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Et(t,a,e){let o=e??new r(16),f=t[4],g=t[5],D=t[6],u=t[7],l=t[8],w=t[9],x=t[10],y=t[11],b=Math.cos(a),S=Math.sin(a);return o[4]=b*f+S*l,o[5]=b*g+S*w,o[6]=b*D+S*x,o[7]=b*u+S*y,o[8]=b*l-S*f,o[9]=b*w-S*g,o[10]=b*x-S*D,o[11]=b*y-S*u,t!==o&&(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function mt(t,a){let e=a??new r(16),o=Math.cos(t),f=Math.sin(t);return e[0]=o,e[1]=0,e[2]=-f,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=f,e[9]=0,e[10]=o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function At(t,a,e){let o=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[2*4+0],w=t[2*4+1],x=t[2*4+2],y=t[2*4+3],b=Math.cos(a),S=Math.sin(a);return o[0]=b*f-S*l,o[1]=b*g-S*w,o[2]=b*D-S*x,o[3]=b*u-S*y,o[8]=b*l+S*f,o[9]=b*w+S*g,o[10]=b*x+S*D,o[11]=b*y+S*u,t!==o&&(o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function yt(t,a){let e=a??new r(16),o=Math.cos(t),f=Math.sin(t);return e[0]=o,e[1]=f,e[2]=0,e[3]=0,e[4]=-f,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function zt(t,a,e){let o=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[1*4+0],w=t[1*4+1],x=t[1*4+2],y=t[1*4+3],b=Math.cos(a),S=Math.sin(a);return o[0]=b*f+S*l,o[1]=b*g+S*w,o[2]=b*D+S*x,o[3]=b*u+S*y,o[4]=b*l-S*f,o[5]=b*w-S*g,o[6]=b*x-S*D,o[7]=b*y-S*u,t!==o&&(o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function St(t,a,e){let o=e??new r(16),f=t[0],g=t[1],D=t[2],u=Math.sqrt(f*f+g*g+D*D);f/=u,g/=u,D/=u;let l=f*f,w=g*g,x=D*D,y=Math.cos(a),b=Math.sin(a),S=1-y;return o[0]=l+(1-l)*y,o[1]=f*g*S+D*b,o[2]=f*D*S-g*b,o[3]=0,o[4]=f*g*S-D*b,o[5]=w+(1-w)*y,o[6]=g*D*S+f*b,o[7]=0,o[8]=f*D*S+g*b,o[9]=g*D*S-f*b,o[10]=x+(1-x)*y,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}let i=St;function p(t,a,e,o){let f=o??new r(16),g=a[0],D=a[1],u=a[2],l=Math.sqrt(g*g+D*D+u*u);g/=l,D/=l,u/=l;let w=g*g,x=D*D,y=u*u,b=Math.cos(e),S=Math.sin(e),E=1-b,I=w+(1-w)*b,L=g*D*E+u*S,A=g*u*E-D*S,O=g*D*E-u*S,N=x+(1-x)*b,Z=D*u*E+g*S,K=g*u*E+D*S,J=D*u*E-g*S,ot=y+(1-y)*b,st=t[0],rt=t[1],it=t[2],ct=t[3],at=t[4],ht=t[5],wt=t[6],gt=t[7],xt=t[8],Tt=t[9],_t=t[10],Pt=t[11];return f[0]=I*st+L*at+A*xt,f[1]=I*rt+L*ht+A*Tt,f[2]=I*it+L*wt+A*_t,f[3]=I*ct+L*gt+A*Pt,f[4]=O*st+N*at+Z*xt,f[5]=O*rt+N*ht+Z*Tt,f[6]=O*it+N*wt+Z*_t,f[7]=O*ct+N*gt+Z*Pt,f[8]=K*st+J*at+ot*xt,f[9]=K*rt+J*ht+ot*Tt,f[10]=K*it+J*wt+ot*_t,f[11]=K*ct+J*gt+ot*Pt,t!==f&&(f[12]=t[12],f[13]=t[13],f[14]=t[14],f[15]=t[15]),f}let n=p;function c(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function d(t,a,e){let o=e??new r(16),f=a[0],g=a[1],D=a[2];return o[0]=f*t[0*4+0],o[1]=f*t[0*4+1],o[2]=f*t[0*4+2],o[3]=f*t[0*4+3],o[4]=g*t[1*4+0],o[5]=g*t[1*4+1],o[6]=g*t[1*4+2],o[7]=g*t[1*4+3],o[8]=D*t[2*4+0],o[9]=D*t[2*4+1],o[10]=D*t[2*4+2],o[11]=D*t[2*4+3],t!==o&&(o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}function h(t,a){let e=a??new r(16);return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function M(t,a,e){let o=e??new r(16);return o[0]=a*t[0*4+0],o[1]=a*t[0*4+1],o[2]=a*t[0*4+2],o[3]=a*t[0*4+3],o[4]=a*t[1*4+0],o[5]=a*t[1*4+1],o[6]=a*t[1*4+2],o[7]=a*t[1*4+3],o[8]=a*t[2*4+0],o[9]=a*t[2*4+1],o[10]=a*t[2*4+2],o[11]=a*t[2*4+3],t!==o&&(o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15]),o}return{create:v,set:m,fromMat3:_,fromQuat:T,negate:P,copy:G,clone:z,equalsApproximately:U,equals:B,identity:R,transpose:H,inverse:$,determinant:Y,invert:F,multiply:et,mul:j,setTranslation:C,getTranslation:tt,getAxis:Mt,setAxis:ft,getScaling:lt,perspective:Dt,perspectiveReverseZ:vt,ortho:bt,frustum:nt,frustumReverseZ:Bt,aim:Gt,cameraAim:dt,lookAt:Ut,translation:pt,translate:Lt,rotationX:W,rotateX:Et,rotationY:mt,rotateY:At,rotationZ:yt,rotateZ:zt,axisRotation:St,rotation:i,axisRotate:p,rotate:n,scaling:c,scale:d,uniformScaling:h,uniformScale:M}}var dn=new Map;function $o(r){let s=dn.get(r);return s||(s=No(r),dn.set(r,s)),s}function Yo(r){let s=le(r);function v(i,p,n,c){let d=new r(4);return i!==void 0&&(d[0]=i,p!==void 0&&(d[1]=p,n!==void 0&&(d[2]=n,c!==void 0&&(d[3]=c)))),d}let m=v;function _(i,p,n,c,d){let h=d??new r(4);return h[0]=i,h[1]=p,h[2]=n,h[3]=c,h}function T(i,p,n){let c=n??new r(4),d=p*.5,h=Math.sin(d);return c[0]=h*i[0],c[1]=h*i[1],c[2]=h*i[2],c[3]=Math.cos(d),c}function P(i,p){let n=p??s.create(3),c=Math.acos(i[3])*2,d=Math.sin(c*.5);return d>k?(n[0]=i[0]/d,n[1]=i[1]/d,n[2]=i[2]/d):(n[0]=1,n[1]=0,n[2]=0),{angle:c,axis:n}}function G(i,p){let n=nt(i,p);return Math.acos(2*n*n-1)}function z(i,p,n){let c=n??new r(4),d=i[0],h=i[1],M=i[2],t=i[3],a=p[0],e=p[1],o=p[2],f=p[3];return c[0]=d*f+t*a+h*o-M*e,c[1]=h*f+t*e+M*a-d*o,c[2]=M*f+t*o+d*e-h*a,c[3]=t*f-d*a-h*e-M*o,c}let U=z;function B(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),o=Math.cos(d);return c[0]=h*o+a*e,c[1]=M*o+t*e,c[2]=t*o-M*e,c[3]=a*o-h*e,c}function R(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),o=Math.cos(d);return c[0]=h*o-t*e,c[1]=M*o+a*e,c[2]=t*o+h*e,c[3]=a*o-M*e,c}function H(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),o=Math.cos(d);return c[0]=h*o+M*e,c[1]=M*o-h*e,c[2]=t*o+a*e,c[3]=a*o-t*e,c}function $(i,p,n,c){let d=c??new r(4),h=i[0],M=i[1],t=i[2],a=i[3],e=p[0],o=p[1],f=p[2],g=p[3],D=h*e+M*o+t*f+a*g;D<0&&(D=-D,e=-e,o=-o,f=-f,g=-g);let u,l;if(1-D>k){let w=Math.acos(D),x=Math.sin(w);u=Math.sin((1-n)*w)/x,l=Math.sin(n*w)/x}else u=1-n,l=n;return d[0]=u*h+l*e,d[1]=u*M+l*o,d[2]=u*t+l*f,d[3]=u*a+l*g,d}function Y(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=c*c+d*d+h*h+M*M,a=t?1/t:0;return n[0]=-c*a,n[1]=-d*a,n[2]=-h*a,n[3]=M*a,n}function F(i,p){let n=p??new r(4);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[3]=i[3],n}function et(i,p){let n=p??new r(4),c=i[0]+i[5]+i[10];if(c>0){let d=Math.sqrt(c+1);n[3]=.5*d;let h=.5/d;n[0]=(i[6]-i[9])*h,n[1]=(i[8]-i[2])*h,n[2]=(i[1]-i[4])*h}else{let d=0;i[5]>i[0]&&(d=1),i[10]>i[d*4+d]&&(d=2);let h=(d+1)%3,M=(d+2)%3,t=Math.sqrt(i[d*4+d]-i[h*4+h]-i[M*4+M]+1);n[d]=.5*t;let a=.5/t;n[3]=(i[h*4+M]-i[M*4+h])*a,n[h]=(i[h*4+d]+i[d*4+h])*a,n[M]=(i[M*4+d]+i[d*4+M])*a}return n}function j(i,p,n,c,d){let h=d??new r(4),M=i*.5,t=p*.5,a=n*.5,e=Math.sin(M),o=Math.cos(M),f=Math.sin(t),g=Math.cos(t),D=Math.sin(a),u=Math.cos(a);switch(c){case"xyz":h[0]=e*g*u+o*f*D,h[1]=o*f*u-e*g*D,h[2]=o*g*D+e*f*u,h[3]=o*g*u-e*f*D;break;case"xzy":h[0]=e*g*u-o*f*D,h[1]=o*f*u-e*g*D,h[2]=o*g*D+e*f*u,h[3]=o*g*u+e*f*D;break;case"yxz":h[0]=e*g*u+o*f*D,h[1]=o*f*u-e*g*D,h[2]=o*g*D-e*f*u,h[3]=o*g*u+e*f*D;break;case"yzx":h[0]=e*g*u+o*f*D,h[1]=o*f*u+e*g*D,h[2]=o*g*D-e*f*u,h[3]=o*g*u-e*f*D;break;case"zxy":h[0]=e*g*u-o*f*D,h[1]=o*f*u+e*g*D,h[2]=o*g*D+e*f*u,h[3]=o*g*u-e*f*D;break;case"zyx":h[0]=e*g*u-o*f*D,h[1]=o*f*u+e*g*D,h[2]=o*g*D-e*f*u,h[3]=o*g*u+e*f*D;break;default:throw new Error(`Unknown rotation order: ${c}`)}return h}function C(i,p){let n=p??new r(4);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n}let tt=C;function Mt(i,p,n){let c=n??new r(4);return c[0]=i[0]+p[0],c[1]=i[1]+p[1],c[2]=i[2]+p[2],c[3]=i[3]+p[3],c}function ft(i,p,n){let c=n??new r(4);return c[0]=i[0]-p[0],c[1]=i[1]-p[1],c[2]=i[2]-p[2],c[3]=i[3]-p[3],c}let lt=ft;function Dt(i,p,n){let c=n??new r(4);return c[0]=i[0]*p,c[1]=i[1]*p,c[2]=i[2]*p,c[3]=i[3]*p,c}let vt=Dt;function bt(i,p,n){let c=n??new r(4);return c[0]=i[0]/p,c[1]=i[1]/p,c[2]=i[2]/p,c[3]=i[3]/p,c}function nt(i,p){return i[0]*p[0]+i[1]*p[1]+i[2]*p[2]+i[3]*p[3]}function Bt(i,p,n,c){let d=c??new r(4);return d[0]=i[0]+n*(p[0]-i[0]),d[1]=i[1]+n*(p[1]-i[1]),d[2]=i[2]+n*(p[2]-i[2]),d[3]=i[3]+n*(p[3]-i[3]),d}function q(i){let p=i[0],n=i[1],c=i[2],d=i[3];return Math.sqrt(p*p+n*n+c*c+d*d)}let X=q;function V(i){let p=i[0],n=i[1],c=i[2],d=i[3];return p*p+n*n+c*c+d*d}let Gt=V;function dt(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=Math.sqrt(c*c+d*d+h*h+M*M);return t>1e-5?(n[0]=c/t,n[1]=d/t,n[2]=h/t,n[3]=M/t):(n[0]=0,n[1]=0,n[2]=0,n[3]=1),n}function Ut(i,p){return Math.abs(i[0]-p[0])<k&&Math.abs(i[1]-p[1])<k&&Math.abs(i[2]-p[2])<k&&Math.abs(i[3]-p[3])<k}function pt(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[3]===p[3]}function Lt(i){let p=i??new r(4);return p[0]=0,p[1]=0,p[2]=0,p[3]=1,p}let W=s.create(),Et=s.create(),mt=s.create();function At(i,p,n){let c=n??new r(4),d=s.dot(i,p);return d<-.999999?(s.cross(Et,i,W),s.len(W)<1e-6&&s.cross(mt,i,W),s.normalize(W,W),T(W,Math.PI,c),c):d>.999999?(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c):(s.cross(i,p,W),c[0]=W[0],c[1]=W[1],c[2]=W[2],c[3]=1+d,dt(c,c))}let yt=new r(4),zt=new r(4);function St(i,p,n,c,d,h){let M=h??new r(4);return $(i,c,d,yt),$(p,n,d,zt),$(yt,zt,2*d*(1-d),M),M}return{create:v,fromValues:m,set:_,fromAxisAngle:T,toAxisAngle:P,angle:G,multiply:z,mul:U,rotateX:B,rotateY:R,rotateZ:H,slerp:$,inverse:Y,conjugate:F,fromMat:et,fromEuler:j,copy:C,clone:tt,add:Mt,subtract:ft,sub:lt,mulScalar:Dt,scale:vt,divScalar:bt,dot:nt,lerp:Bt,length:q,len:X,lengthSq:V,lenSq:Gt,normalize:dt,equalsApproximately:Ut,equals:pt,identity:Lt,rotationTo:At,sqlerp:St}}var pn=new Map;function Xo(r){let s=pn.get(r);return s||(s=Yo(r),pn.set(r,s)),s}function Ho(r){function s(n,c,d,h){let M=new r(4);return n!==void 0&&(M[0]=n,c!==void 0&&(M[1]=c,d!==void 0&&(M[2]=d,h!==void 0&&(M[3]=h)))),M}let v=s;function m(n,c,d,h,M){let t=M??new r(4);return t[0]=n,t[1]=c,t[2]=d,t[3]=h,t}function _(n,c){let d=c??new r(4);return d[0]=Math.ceil(n[0]),d[1]=Math.ceil(n[1]),d[2]=Math.ceil(n[2]),d[3]=Math.ceil(n[3]),d}function T(n,c){let d=c??new r(4);return d[0]=Math.floor(n[0]),d[1]=Math.floor(n[1]),d[2]=Math.floor(n[2]),d[3]=Math.floor(n[3]),d}function P(n,c){let d=c??new r(4);return d[0]=Math.round(n[0]),d[1]=Math.round(n[1]),d[2]=Math.round(n[2]),d[3]=Math.round(n[3]),d}function G(n,c=0,d=1,h){let M=h??new r(4);return M[0]=Math.min(d,Math.max(c,n[0])),M[1]=Math.min(d,Math.max(c,n[1])),M[2]=Math.min(d,Math.max(c,n[2])),M[3]=Math.min(d,Math.max(c,n[3])),M}function z(n,c,d){let h=d??new r(4);return h[0]=n[0]+c[0],h[1]=n[1]+c[1],h[2]=n[2]+c[2],h[3]=n[3]+c[3],h}function U(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+c[0]*d,M[1]=n[1]+c[1]*d,M[2]=n[2]+c[2]*d,M[3]=n[3]+c[3]*d,M}function B(n,c,d){let h=d??new r(4);return h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2],h[3]=n[3]-c[3],h}let R=B;function H(n,c){return Math.abs(n[0]-c[0])<k&&Math.abs(n[1]-c[1])<k&&Math.abs(n[2]-c[2])<k&&Math.abs(n[3]-c[3])<k}function $(n,c){return n[0]===c[0]&&n[1]===c[1]&&n[2]===c[2]&&n[3]===c[3]}function Y(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d*(c[0]-n[0]),M[1]=n[1]+d*(c[1]-n[1]),M[2]=n[2]+d*(c[2]-n[2]),M[3]=n[3]+d*(c[3]-n[3]),M}function F(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d[0]*(c[0]-n[0]),M[1]=n[1]+d[1]*(c[1]-n[1]),M[2]=n[2]+d[2]*(c[2]-n[2]),M[3]=n[3]+d[3]*(c[3]-n[3]),M}function et(n,c,d){let h=d??new r(4);return h[0]=Math.max(n[0],c[0]),h[1]=Math.max(n[1],c[1]),h[2]=Math.max(n[2],c[2]),h[3]=Math.max(n[3],c[3]),h}function j(n,c,d){let h=d??new r(4);return h[0]=Math.min(n[0],c[0]),h[1]=Math.min(n[1],c[1]),h[2]=Math.min(n[2],c[2]),h[3]=Math.min(n[3],c[3]),h}function C(n,c,d){let h=d??new r(4);return h[0]=n[0]*c,h[1]=n[1]*c,h[2]=n[2]*c,h[3]=n[3]*c,h}let tt=C;function Mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c,h[1]=n[1]/c,h[2]=n[2]/c,h[3]=n[3]/c,h}function ft(n,c){let d=c??new r(4);return d[0]=1/n[0],d[1]=1/n[1],d[2]=1/n[2],d[3]=1/n[3],d}let lt=ft;function Dt(n,c){return n[0]*c[0]+n[1]*c[1]+n[2]*c[2]+n[3]*c[3]}function vt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return Math.sqrt(c*c+d*d+h*h+M*M)}let bt=vt;function nt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return c*c+d*d+h*h+M*M}let Bt=nt;function q(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return Math.sqrt(d*d+h*h+M*M+t*t)}let X=q;function V(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return d*d+h*h+M*M+t*t}let Gt=V;function dt(n,c){let d=c??new r(4),h=n[0],M=n[1],t=n[2],a=n[3],e=Math.sqrt(h*h+M*M+t*t+a*a);return e>1e-5?(d[0]=h/e,d[1]=M/e,d[2]=t/e,d[3]=a/e):(d[0]=0,d[1]=0,d[2]=0,d[3]=0),d}function Ut(n,c){let d=c??new r(4);return d[0]=-n[0],d[1]=-n[1],d[2]=-n[2],d[3]=-n[3],d}function pt(n,c){let d=c??new r(4);return d[0]=n[0],d[1]=n[1],d[2]=n[2],d[3]=n[3],d}let Lt=pt;function W(n,c,d){let h=d??new r(4);return h[0]=n[0]*c[0],h[1]=n[1]*c[1],h[2]=n[2]*c[2],h[3]=n[3]*c[3],h}let Et=W;function mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c[0],h[1]=n[1]/c[1],h[2]=n[2]/c[2],h[3]=n[3]/c[3],h}let At=mt;function yt(n){let c=n??new r(4);return c[0]=0,c[1]=0,c[2]=0,c[3]=0,c}function zt(n,c,d){let h=d??new r(4),M=n[0],t=n[1],a=n[2],e=n[3];return h[0]=c[0]*M+c[4]*t+c[8]*a+c[12]*e,h[1]=c[1]*M+c[5]*t+c[9]*a+c[13]*e,h[2]=c[2]*M+c[6]*t+c[10]*a+c[14]*e,h[3]=c[3]*M+c[7]*t+c[11]*a+c[15]*e,h}function St(n,c,d){let h=d??new r(4);return dt(n,h),C(h,c,h)}function i(n,c,d){let h=d??new r(4);return vt(n)>c?St(n,c,h):pt(n,h)}function p(n,c,d){let h=d??new r(4);return Y(n,c,.5,h)}return{create:s,fromValues:v,set:m,ceil:_,floor:T,round:P,clamp:G,add:z,addScaled:U,subtract:B,sub:R,equalsApproximately:H,equals:$,lerp:Y,lerpV:F,max:et,min:j,mulScalar:C,scale:tt,divScalar:Mt,inverse:ft,invert:lt,dot:Dt,length:vt,len:bt,lengthSq:nt,lenSq:Bt,distance:q,dist:X,distanceSq:V,distSq:Gt,normalize:dt,negate:Ut,copy:pt,clone:Lt,multiply:W,mul:Et,divide:mt,div:At,zero:yt,transformMat4:zt,setLength:St,truncate:i,midpoint:p}}var hn=new Map;function jo(r){let s=hn.get(r);return s||(s=Ho(r),hn.set(r,s)),s}function Pe(r,s,v,m,_,T){return{mat3:qo(r),mat4:$o(s),quat:Xo(v),vec2:wn(m),vec3:le(_),vec4:jo(T)}}var{mat3:Zr,mat4:Nt,quat:Qr,vec2:kr,vec3:Kr,vec4:Jr}=Pe(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:Cr,mat4:ti,quat:ei,vec2:ni,vec3:oi,vec4:si}=Pe(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:ri,mat4:ii,quat:ci,vec2:ai,vec3:ui,vec4:fi}=Pe(Fo,Array,Array,Array,Array,Array);var de=class{invViewProjectionMatrix=Nt.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(s){this.setViewportSize(s.viewportSize.width,s.viewportSize.height);let v=s.center??this.topLeft;this.setTopLeft(...v);let m=s.zoom??1;this.setZoom(m)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(s,v){this.viewportSize.width=s,this.viewportSize.height=v,this.updateMatrices()}setTopLeft(s,v){this.topLeft[0]=s,this.topLeft[1]=v,this.updateMatrices()}setZoom(s){this.zoom=s,this.updateMatrices()}updateMatrices(){Nt.identity(this.invViewProjectionMatrix),Nt.multiply(Nt.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var Vt=class r{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(s,v){this.device=s,this.maxLightsCount=v;let m=new ArrayBuffer(r.computeBufferBytesLength(v)),_=s.createBuffer({label:"LightsBuffer buffer",size:m.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:m,bufferGpu:_},this.setLights([])}setLights(s){if(s.length>this.maxLightsCount)throw new Error(`Too many lights "${s.length}", max is "${this.maxLightsCount}".`);let v=r.computeBufferBytesLength(s.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([s.length]),s.forEach((m,_)=>{new Float32Array(this.buffer.bufferCpu,r.structs.lightsBuffer.lights.offset+r.structs.lightsBuffer.lights.stride*_,9).set([...m.color,m.radius,...m.position,m.intensity,m.attenuationLinear,m.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,v),this.currentLightsCount=s.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(s){return r.structs.lightsBuffer.lights.offset+r.structs.lightsBuffer.lights.stride*s}};var pe=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(s,v,m,_){this.lightsBuffer=v;let T=s.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${Vt.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${m.gridSize.x}, ${m.gridSize.y});
const cellsGridSizeF = vec2<f32>(${m.gridSize.x}, ${m.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${_}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=s.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:T,entryPoint:"main_vertex"},fragment:{module:T,entryPoint:"main_fragment",targets:[{format:m.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:m.sampleCount}}),this.bindgroup=s.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let P=s.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[m.format],sampleCount:m.sampleCount});P.setPipeline(this.renderPipeline),P.setBindGroup(0,this.bindgroup),P.draw(4),this.renderBundle=P.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var he=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(s,v,m,_){this.device=s,this.lightsBuffer=v;let T=!0,P=s.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${m.gridSize.x}, ${m.gridSize.y});
const cellsGridSizeF = vec2<f32>(${m.gridSize.x}, ${m.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${_});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=s.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:P,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:Vt.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:Vt.structs.light.position.offset,format:"float32x2"}],arrayStride:Vt.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:P,entryPoint:"main_fragment",targets:[{format:m.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:T?"none":"back",topology:"triangle-list"},multisample:{count:m.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:s.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[m.format],sampleCount:m.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(s){let v=[],m=[];for(let U of s){let B=v.length/3;v.push(...U[0],0,...U[1],0,...U[0],1,...U[1],1),m.push(B+0,B+1,B+3,B+0,B+3,B+2)}let _=!1,T=new Float32Array(v),P=this.obstacles?.positionsBufferGpu;(!P||P.size<T.byteLength)&&(P?.destroy(),P=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:T.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),_=!0),this.device.queue.writeBuffer(P,0,T);let G=new Uint16Array(m),z=this.obstacles?.indexBufferGpu;(!z||z.size<G.byteLength)&&(z?.destroy(),z=this.device.createBuffer({label:"LightsTextureMask index buffer",size:G.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),_=!0),this.device.queue.writeBuffer(z,0,G),this.obstacles={positionsBufferGpu:P,indexBufferGpu:z},this.setIndirectIndexCount(m.length),_&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(s){this.setIndirectInstanceCount(s)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(s){let v=new Uint32Array(this.indirectDrawing.bufferCpu);v[0]!==s&&(v[0]=s,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(s){let v=new Uint32Array(this.indirectDrawing.bufferCpu);v[1]!==s&&(v[1]=s,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let s=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(s.setPipeline(this.renderPipeline),s.setVertexBuffer(0,this.obstacles.positionsBufferGpu),s.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,Vt.structs.lightsBuffer.lights.offset),s.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),s.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),s.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var we=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(s,v,m){this.lightsBuffer=v;let _=this.lightsBuffer.maxLightsCount/4,T={x:Math.ceil(Math.sqrt(_)),y:0};T.y=Math.ceil(_/T.x),this.gridSize=T;let P={width:T.x*m.resolutionPerLight,height:T.y*m.resolutionPerLight},G="rgba8unorm";this.texture=s.createTexture({label:"LightsTextureMask texture",size:[P.width,P.height],format:G,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),m.antialiased&&(this.textureMultisampled=s.createTexture({label:"LightsTextureMask texture multisampled",size:[P.width,P.height],format:G,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let U={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};m.antialiased&&(U.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[U]};let B={gridSize:T,format:G,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new pe(s,v,B,m.maxLightSize),this.textureMask=new he(s,v,B,m.maxLightSize)}update(s){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let v=s.beginRenderPass(this.textureRenderpassDescriptor),[m,_]=[this.texture.width,this.texture.height];v.setViewport(0,0,m,_,0,1),v.setScissorRect(0,0,m,_),v.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),v.end()}setObstacles(s){this.textureMask.setObstacles(s)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var ge=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(s){this.device=s.device,this.targetTexture=s.targetTexture,this.lightsBuffer=s.lightsBuffer,this.lightsTexture=new we(s.device,s.lightsBuffer,s.lightsTextureProperties),this.uniformsBufferGpu=s.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let v=s.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${Vt.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/s.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${s.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=s.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:v,entryPoint:"main_vertex"},fragment:{module:v,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let m=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=s.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:m,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:s.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:s.lightsTextureProperties.filtering,minFilter:s.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(s.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(s){this.lightsTexture.update(s)}render(s,v){let m=new ArrayBuffer(80);new Float32Array(m,0,16).set(v),new Float32Array(m,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,m),s.executeBundles([this.renderBundle])}setAlbedo(s){this.bindgroup1=this.buildBindgroup1(s),this.renderBundle=this.buildRenderBundle()}setAmbientLight(s){this.ambientLight=[...s]}setObstacles(s){this.lightsTexture.setObstacles(s)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(s){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:s.view},{binding:1,resource:s.sampler}]})}buildRenderBundle(){let s=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return s.setPipeline(this.renderPipeline),s.setBindGroup(0,this.bindgroup0),s.setBindGroup(1,this.bindgroup1),s.draw(4),s.finish({label:"LightsRenderer renderbundle"})}};var gn={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(r,s={}){return Zo(r,s)},onRun:function(r,s,v){Qo(r,s,v)},onDestroy:function(r,s){ko(s)},onResize:function(r,s){Ko(r,s)},onViewportPosition:function(r,s){s.data.viewport.setTopLeft(...r.viewport.position)},customFunctions:{..._e}};async function Zo(r,s){let{device:v}=r,m=256,_=256,T=new Vt(v,m),P=new de({viewportSize:{width:r.viewport.width,height:r.viewport.height},center:r.viewport.position,zoom:r.viewport.zoom}),G=new ge({device:v,albedo:{view:s.refs.in.data.view,sampler:s.refs.in.data.sampler},targetTexture:s.refs.out.data.texture,lightsBuffer:T,lightsTextureProperties:{resolutionPerLight:_,maxLightSize:_,antialiased:!1,filtering:"nearest"}});return{lightsBuffer:T,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:G,viewport:P,lights:[]}}function Qo(r,s,v){s.data.lightsBufferNeedsUpdate&&(s.data.lightsBuffer.setLights(s.data.lights),s.data.lightsBufferNeedsUpdate=!1,s.data.lightsTextureNeedsUpdate=!0);let m=s.data.lightsRenderer;s.data.lightsTextureNeedsUpdate&&(m.computeLightsTexture(v),s.data.lightsTextureNeedsUpdate=!1);let _=v.beginRenderPass({colorAttachments:[{view:s.refs.out.data.view,clearValue:r.clearValue,loadOp:"load",storeOp:"store"}]});s.data.viewport.setZoom(r.viewport.zoom);let T=s.data.viewport.invertViewProjectionMatrix;m.render(_,T),_.end()}function ko(r){r.data.lightsBuffer.destroy(),r.data.lightsRenderer.destroy()}function Ko(r,s){s.data.lightsRenderer.setAlbedo({view:s.refs.in.data.view,sampler:s.refs.in.data.sampler}),s.data.viewport.setViewportSize(r.viewport.width,r.viewport.height)}var Be="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var kt=new Float32Array(8),vn={type:"cobalt:tileAtlas",refs:[],onInit:async function(r,s={}){return Co(r,s)},onRun:function(r,s,v){},onDestroy:function(r,s){ts(data)},onResize:function(r,s){xn(r,s)},onViewportPosition:function(r,s){xn(r,s)}};async function Co(r,s){let{device:v}=r,m=await $t(r,"tile atlas",s.options.textureUrl),_=v.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),T=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),P=v.createBindGroup({layout:T,entries:[{binding:0,resource:{buffer:_}},{binding:1,resource:m.view},{binding:2,resource:m.sampler}]}),G=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),z=v.createPipelineLayout({bindGroupLayouts:[G,T]});return{pipeline:v.createRenderPipeline({label:"tile",vertex:{module:v.createShaderModule({code:Be}),entryPoint:"vs_main",buffers:[]},fragment:{module:v.createShaderModule({code:Be}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:z}),uniformBuffer:_,atlasBindGroup:P,atlasMaterial:m,tileBindGroupLayout:G,tileSize:s.options.tileSize,tileScale:s.options.tileScale}}function ts(r){r.atlasMaterial.texture.destroy(),r.atlasMaterial.texture=void 0}function xn(r,s){kt[0]=r.viewport.position[0],kt[1]=r.viewport.position[1];let v=s.data,{tileScale:m,tileSize:_}=v,T=r.viewport.width/r.viewport.zoom,P=r.viewport.height/r.viewport.zoom;kt[2]=T/m,kt[3]=P/m,kt[4]=1/v.atlasMaterial.texture.width,kt[5]=1/v.atlasMaterial.texture.height,kt[6]=_,kt[7]=1/_,r.device.queue.writeBuffer(v.uniformBuffer,0,kt,0,8)}function xe(r){let v=Object.keys(r.frames).length,m=new Float32Array(v*30),_=[],T={},P=0;for(let G in r.frames){let z=r.frames[G];_.push(G),T[G]=z.sourceSize;let U=-.5+z.spriteSourceSize.x/z.sourceSize.w,B=-.5+z.spriteSourceSize.y/z.sourceSize.h,R=-.5+(z.spriteSourceSize.x+z.spriteSourceSize.w)/z.sourceSize.w,H=-.5+(z.spriteSourceSize.y+z.spriteSourceSize.h)/z.sourceSize.h,$=[U,B,0],Y=[U,H,0],F=[R,H,0],et=[R,B,0],j=0+z.frame.x/r.meta.size.w,C=0+z.frame.y/r.meta.size.h,tt=0+(z.frame.x+z.frame.w)/r.meta.size.w,Mt=0+(z.frame.y+z.frame.h)/r.meta.size.h,ft=[j,C],lt=[j,Mt],Dt=[tt,Mt],vt=[tt,C];m.set($,P),m.set(ft,P+3),m.set(Y,P+5),m.set(lt,P+8),m.set(F,P+10),m.set(Dt,P+13),m.set($,P+15),m.set(ft,P+18),m.set(F,P+20),m.set(Dt,P+23),m.set(et,P+25),m.set(vt,P+28),P+=30}return{spriteMeta:T,locations:_,vertices:m}}var ze="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var mn=Ot.create(0,0,0),Mn={type:"cobalt:spritesheet",refs:[],onInit:async function(r,s={}){return ns(r,s)},onRun:function(r,s,v){},onDestroy:function(r,s){os(s)},onResize:function(r,s){yn(r,s)},onViewportPosition:function(r,s){yn(r,s)}};async function ns(r,s){let{canvas:v,device:m}=r,_,T,P;v?(_=await ss(s.options.spriteSheetJsonUrl),_=xe(_),T=await $t(r,"sprite",s.options.colorTextureUrl,"rgba8unorm"),P=await $t(r,"emissive sprite",s.options.emissiveTextureUrl,"rgba8unorm"),v.style.imageRendering="pixelated"):(_=xe(s.options.spriteSheetJson),T=await oe(r,"sprite",s.options.colorTexture,"rgba8unorm"),P=await oe(r,"emissive sprite",s.options.emissiveTexture,"rgba8unorm"));let G=be(m,_),z=m.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),U=m.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),B=m.createPipelineLayout({bindGroupLayouts:[U]});return{pipeline:m.createRenderPipeline({label:"sprite",vertex:{module:m.createShaderModule({code:ze}),entryPoint:"vs_main",buffers:[G.bufferLayout]},fragment:{module:m.createShaderModule({code:ze}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:B}),uniformBuffer:z,quads:G,colorTexture:T,emissiveTexture:P,bindGroupLayout:U,spritesheet:_}}function os(r){r.data.quads.buffer.destroy(),r.data.colorTexture.buffer.destroy(),r.data.uniformBuffer.destroy(),r.data.emissiveTexture.texture.destroy()}async function ss(r){return(await fetch(r)).json()}function yn(r,s){let{device:v,viewport:m}=r,_=m.width/m.zoom,T=m.height/m.zoom,P=It.ortho(0,_,T,0,-10,10);Ot.set(-m.position[0],-m.position[1],0,mn);let G=It.translation(mn);v.queue.writeBuffer(s.data.uniformBuffer,0,G.buffer),v.queue.writeBuffer(s.data.uniformBuffer,64,P.buffer)}var Dn={type:"fbTexture",refs:[],onInit:async function(r,s={}){return rs(r,s)},onRun:function(r,s,v){},onDestroy:function(r,s){bn(data)},onResize:function(r,s){is(r,s)},onViewportPosition:function(r,s){}};async function rs(r,s){let{device:v}=r,{label:m,mip_count:_,format:T,usage:P,viewportScale:G}=s.options;return Rt(v,m,r.viewport.width*G,r.viewport.height*G,_,T,P)}function bn(r){r.data.texture.destroy()}function is(r,s){let{device:v}=r;bn(s);let{width:m,height:_}=r.viewport,{options:T}=s,P=s.options.viewportScale;s.data=Rt(v,T.label,m*P,_*P,T.mip_count,T.format,T.usage)}async function nc(r,s,v){let m,_,T,P;return r.sdlWindow&&r.gpu?(_=r.gpu,m=await(await _.create(["verbose=1"]).requestAdapter()).requestDevice(),T=_.renderGPUDeviceToWindow({device:m,window:r.sdlWindow}),global.GPUBufferUsage=_.GPUBufferUsage,global.GPUShaderStage=_.GPUShaderStage,global.GPUTextureUsage=_.GPUTextureUsage):(P=r,m=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),_=navigator.gpu,T=P.getContext("webgpu"),T.configure({device:m,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":vn,"cobalt:spritesheet":Mn,"cobalt:fbTexture":Dn,"cobalt:bloom":Ae,"cobalt:composite":Re,"cobalt:sprite":qe,"cobalt:tile":$e,"cobalt:displacement":Ke,"cobalt:overlay":en,"cobalt:fbBlit":nn,"cobalt:primitives":an,"cobalt:light":gn},nodes:[],defaultTextureViewRefs:[],canvas:P,device:m,context:T,gpu:_,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:s,height:v,zoom:1,position:[0,0]}}}function oc(r,s){if(!s?.type)throw new Error("Can't define a new node missing a type.");r.nodeDefs[s.type]=s}async function sc(r,s){let v=r.nodeDefs[s?.type];if(!v)throw new Error("Can't initialize a new node missing a type.");let m={type:s.type,refs:s.refs||{},options:s.options||{},data:{},enabled:!0};for(let T in m.refs)m.refs[T]==="FRAME_TEXTURE_VIEW"&&(r.defaultTextureViewRefs.push({node:m,refName:T}),m.refs[T]=Sn(r));m.data=await v.onInit(r,m);let _=v.customFunctions||{};for(let T in _)m[T]=function(...P){return _[T](r,m,...P)};return r.nodes.push(m),m}function rc(r){let{device:s,context:v}=r,m=s.createCommandEncoder(),_=Sn(r);for(let T of r.defaultTextureViewRefs)T.node.refs[T.refName]=_;for(let T of r.nodes){if(!T.enabled)continue;r.nodeDefs[T.type].onRun(r,T,m)}s.queue.submit([m.finish()]),r.canvas||r.context.swap()}function ic(r){for(let s of r.nodes)r.nodeDefs[s.type].onDestroy(r,s);r.nodes.length=0,r.defaultTextureViewRefs.length=0}function cc(r,s,v){r.viewport.width=s,r.viewport.height=v;for(let m of r.nodes)r.nodeDefs[m.type].onResize(r,m)}function ac(r,s){r.viewport.position[0]=s[0]-r.viewport.width/2/r.viewport.zoom,r.viewport.position[1]=s[1]-r.viewport.height/2/r.viewport.zoom;for(let v of r.nodes)r.nodeDefs[v.type].onViewportPosition(r,v)}function Oe(r){return r.canvas?navigator.gpu.getPreferredCanvasFormat():r.context.getPreferredFormat()}function Sn(r){return r.canvas?r.context.getCurrentTexture().createView():r.context.getCurrentTextureView()}export{Rt as createTexture,oe as createTextureFromBuffer,$t as createTextureFromUrl,oc as defineNode,rc as draw,Sn as getCurrentTextureView,Oe as getPreferredFormat,nc as init,sc as initNode,ic as reset,cc as setViewportDimensions,ac as setViewportPosition};

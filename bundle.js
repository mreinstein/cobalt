var cn=Object.defineProperty;var Ye=(t,e)=>{for(var n in e)cn(t,n,{get:e[n],enumerable:!0})};function Y(t,e,n,r,o,i,a){let f=t.createTexture({label:e,size:{width:n,height:r},format:i,usage:a,mipLevelCount:o,sampleCount:1,dimension:"2d"}),c=f.createView(),l=[];for(let s=0;s<o;s++)l.push(f.createView({label:e,format:i,dimension:"2d",aspect:"all",baseMipLevel:s,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let u=t.createSampler({label:`${e} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:n,height:r},texture:f,view:c,mip_view:l,sampler:u}}async function k(t,e,n,r="rgba8unorm"){let i=await(await fetch(n)).blob(),a=await createImageBitmap(i),f=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,l=Y(t.device,e,a.width,a.height,1,r,f);t.device.queue.copyExternalImageToTexture({source:a},{texture:l.texture},{width:a.width,height:a.height});let u={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return l.sampler=t.device.createSampler(u),l}function oe(t,e,n,r="rgba8unorm"){let o=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,a=Y(t.device,e,n.width,n.height,1,r,o);t.device.queue.writeTexture({texture:a.texture},n.data,{bytesPerRow:4*n.width},{width:n.width,height:n.height});let f={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return a.sampler=t.device.createSampler(f),a}var Xe="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var Z=7,fn=0,He=1,ln=2,We=3,je={type:"bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(t,e={}){return sn(t,e)},onRun:function(t,e,n){pn(t,e.data,n)},onDestroy:function(t,e){Ze(e)},onResize:function(t,e){mn(t,e)},onViewportPosition:function(t,e){}};function sn(t,e){let{device:n}=t,r=t.viewport.width,o=t.viewport.height,i={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},a=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});i.bind_group_layout.push(a),i.bind_groups_textures.push(Y(n,"bloom downsampler image 0",r/2,o/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),i.bind_groups_textures.push(Y(n,"bloom downsampler image 1",r/2,o/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),i.bind_groups_textures.push(e.refs.bloom.data);let f=n.createPipelineLayout({bindGroupLayouts:i.bind_group_layout}),c=n.createComputePipeline({layout:f,compute:{module:n.createShaderModule({code:Xe}),entryPoint:"cs_main"}});return Qe(t,i,e),i.compute_pipeline=c,i}function Qe(t,e,n){let{refs:r}=n,{device:o}=t,i=n.options.bloom_threshold??.1,a=n.options.bloom_knee??.2,f=n.options.bloom_combine_constant??.68,c=new Float32Array([i,i-a,a*2,.25/a,f,0,0,0]),l=o.createBuffer({label:"bloom static parameters buffer",size:c.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(l.getMappedRange()).set(c),l.unmap(),e.bind_group.length=0,e.params_buf=l,e.bind_group.push(ne(o,e,e.bind_groups_textures[0].mip_view[0],r.emissive.data.view,r.hdr.data.view,r.hdr.data.sampler,l,fn<<16|0));for(let s=1;s<Z;s++)e.bind_group.push(ne(o,e,e.bind_groups_textures[1].mip_view[s],e.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,l,He<<16|s-1)),e.bind_group.push(ne(o,e,e.bind_groups_textures[0].mip_view[s],e.bind_groups_textures[1].view,r.hdr.data.view,r.hdr.data.sampler,l,He<<16|s));e.bind_group.push(ne(o,e,e.bind_groups_textures[2].mip_view[Z-1],e.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,l,ln<<16|Z-2));let u=!0;for(let s=Z-2;s>=0;s--)u?(e.bind_group.push(ne(o,e,e.bind_groups_textures[1].mip_view[s],e.bind_groups_textures[0].view,e.bind_groups_textures[2].view,r.hdr.data.sampler,l,We<<16|s)),u=!1):(e.bind_group.push(ne(o,e,e.bind_groups_textures[2].mip_view[s],e.bind_groups_textures[0].view,e.bind_groups_textures[1].view,r.hdr.data.sampler,l,We<<16|s)),u=!0)}function ne(t,e,n,r,o,i,a,f){let c=new Uint32Array([f]),l=t.createBuffer({label:"bloom static mode_lod buffer",size:c.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(l.getMappedRange()).set(c),l.unmap(),t.createBindGroup({label:"bloom bind group layout",layout:e.bind_group_layout[0],entries:[{binding:0,resource:n},{binding:1,resource:r},{binding:2,resource:o},{binding:3,resource:i},{binding:4,resource:{buffer:a}},{binding:5,resource:{buffer:l}}]})}function pn(t,e,n){let f=0,c=n.beginComputePass({label:"bloom Compute Pass"});c.setPipeline(e.compute_pipeline),c.setBindGroup(0,e.bind_group[f]),f+=1;let l=ge(0,e.bind_groups_textures[0]);c.dispatchWorkgroups(l.width/8+1,l.height/4+1,1);for(let u=1;u<Z;u++)l=ge(u,e.bind_groups_textures[0]),c.setBindGroup(0,e.bind_group[f]),f+=1,c.dispatchWorkgroups(l.width/8+1,l.height/4+1,1),c.setBindGroup(0,e.bind_group[f]),f+=1,c.dispatchWorkgroups(l.width/8+1,l.height/4+1,1);c.setBindGroup(0,e.bind_group[f]),f+=1,l=ge(Z-1,e.bind_groups_textures[2]),c.dispatchWorkgroups(l.width/8+1,l.height/4+1,1);for(let u=Z-2;u>=0;u--)l=ge(u,e.bind_groups_textures[2]),c.setBindGroup(0,e.bind_group[f]),f+=1,c.dispatchWorkgroups(l.width/8+1,l.height/4+1,1);c.end()}function ge(t,e){let n=e.size.width,r=e.size.height;for(let o=0;o<t;o++)n/=2,r/=2;return{width:n,height:r,depthOrArrayLayers:1}}function mn(t,e){let{device:n}=t,r=e.data;Ze(r),r.bind_groups_textures.push(Y(n,"bloom downsampler image 0",t.viewport.width/2,t.viewport.height/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(Y(n,"bloom downsampler image 1",t.viewport.width/2,t.viewport.height/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(e.refs.bloom.data),Qe(t,r,e)}function Ze(t){for(let e of t.bind_groups_textures)e.texture.destroy();t.bind_groups_textures.length=0}var he="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{const pos=array(vec2(1.0,1.0),vec2(1.0,-1.0),vec2(-1.0,-1.0),vec2(1.0,1.0),vec2(-1.0,-1.0),vec2(-1.0,1.0),);const uv=array(vec2(1.0,0.0),vec2(1.0,1.0),vec2(0.0,1.0),vec2(1.0,0.0),vec2(0.0,1.0),vec2(0.0,0.0),);var output:VertexOutput;output.Position=vec4(pos[VertexIndex],0.0,1.0);output.fragUV=uv[VertexIndex];return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Ke={type:"bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return vn(t,e)},onRun:function(t,e,n){gn(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){yn(t,e)},onViewportPosition:function(t,e){}};function vn(t,e){let{options:n,refs:r}=e,{device:o}=t,i=ke(t),a=n.bloom_intensity??40,f=n.bloom_combine_constant??.68,c=new Float32Array([a,f]),l=o.createBuffer({label:"scene composite params buffer",size:c.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(l.getMappedRange()).set(c),l.unmap();let u=o.createRenderPipeline({layout:"auto",vertex:{module:o.createShaderModule({code:he}),entryPoint:"vert_main"},fragment:{module:o.createShaderModule({code:he}),entryPoint:"frag_main",targets:[{format:i}]},primitive:{topology:"triangle-list"}});return{bindGroup:o.createBindGroup({layout:u.getBindGroupLayout(0),entries:[{binding:0,resource:r.hdr.data.sampler},{binding:1,resource:r.hdr.data.view},{binding:2,resource:r.bloom.data.mip_view[0]},{binding:3,resource:{buffer:l}}]}),pipeline:u,params_buf:l}}function gn(t,e,n){let r=n.beginRenderPass({colorAttachments:[{view:e.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:o,bindGroup:i}=e.data;r.setPipeline(o),r.setBindGroup(0,i),r.draw(6,1,0,0),r.end()}function yn(t,e){let{pipeline:n,params_buf:r}=e.data,{device:o}=t;e.data.bindGroup=o.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:e.refs.hdr.data.sampler},{binding:1,resource:e.refs.hdr.data.view},{binding:2,resource:e.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:r}}]})}var ie={};Ye(ie,{addSprite:()=>wn,clear:()=>Sn,removeSprite:()=>_n,setSprite:()=>Gn,setSpriteName:()=>bn,setSpriteOpacity:()=>Cn,setSpritePosition:()=>Mn,setSpriteRotation:()=>En,setSpriteTint:()=>Tn});function we(t,e,n){if(n.spriteCount===0)return 0;let r=0,o=n.spriteCount-1,i=t<<16&16711680|e&65535;for(;r<=o;){let a=n.spriteData[r*12+11];if(i<=a)return r;let f=n.spriteData[o*12+11];if(i>=f)return o+1;let c=Math.floor((r+o)/2),l=n.spriteData[c*12+11];if(i===l)return c+1;i>l?r=c+1:o=c-1}return r}function ee(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function wn(t,e,n,r,o,i,a,f,c){let l=e.refs.spritesheet.data.spritesheet;e=e.data;let u=l.locations.indexOf(n),s=we(c,u,e),p=(s+1)*12;e.spriteData.set(e.spriteData.subarray(s*12,e.spriteCount*12),p),Je(e,l,s,n,r,o,i,a,f,c);for(let[v,m]of e.spriteIndices)m>=s&&e.spriteIndices.set(v,m+1);let g=ee();return e.spriteIndices.set(g,s),e.spriteCount++,e.dirty=!0,g}function _n(t,e,n){e=e.data;let r=e.spriteIndices.get(n);for(let[i,a]of e.spriteIndices)a>r&&e.spriteIndices.set(i,a-1);let o=r*12;e.spriteData.set(e.spriteData.subarray((r+1)*12,e.spriteCount*12),o),e.spriteIndices.delete(n),e.spriteCount--,e.dirty=!0}function Sn(t,e){e=e.data,e.spriteIndices.clear(),e.spriteCount=0,e.instancedDrawCallCount=0,e.dirty=!0}function bn(t,e,n,r,o){let i=e.refs.spritesheet.data.spritesheet;e=e.data;let a=i.locations.indexOf(r),f=i.spriteMeta[r].w,c=i.spriteMeta[r].h,u=e.spriteIndices.get(n)*12;e.spriteData[u+2]=f*o[0],e.spriteData[u+3]=c*o[1];let p=(e.spriteData[u+11]>>16&255)<<16&16711680|a&65535;e.spriteData[u+11]=p,e.dirty=!0}function Mn(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i]=r[0],e.spriteData[i+1]=r[1],e.dirty=!0}function Tn(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i+4]=r[0],e.spriteData[i+5]=r[1],e.spriteData[i+6]=r[2],e.spriteData[i+7]=r[3],e.dirty=!0}function Cn(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i+8]=r,e.dirty=!0}function En(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i+9]=r,e.dirty=!0}function Gn(t,e,n,r,o,i,a,f,c,l){let u=e.refs.spritesheet.data.spritesheet;e=e.data;let s=e.spriteIndices.get(n);Je(e,u,s,r,o,i,a,f,c,l),e.dirty=!0}function Je(t,e,n,r,o,i,a,f,c,l){if(!e.spriteMeta[r])throw new Error(`Sprite name ${r} could not be found in the spritesheet metaData`);let u=n*12,s=e.spriteMeta[r].w,p=e.spriteMeta[r].h,g=e.locations.indexOf(r),v=l<<16&16711680|g&65535;t.spriteData[u]=o[0],t.spriteData[u+1]=o[1],t.spriteData[u+2]=s*i[0],t.spriteData[u+3]=p*i[1],t.spriteData[u+4]=a[0],t.spriteData[u+5]=a[1],t.spriteData[u+6]=a[2],t.spriteData[u+7]=a[3],t.spriteData[u+8]=f,t.spriteData[u+9]=c,t.spriteData[u+11]=v}var de={type:"sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return Bn(t,e)},onRun:function(t,e,n){Un(t,e,n)},onDestroy:function(t,e){Fn(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{...ie}};async function Bn(t,e){let{device:n}=t,r=16192,o=r,a=Float32Array.BYTES_PER_ELEMENT*2,c=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*4,p=Float32Array.BYTES_PER_ELEMENT*4,g=n.createBuffer({size:(a+c+u+p)*o,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),v=e.refs.spritesheet.data,m=n.createBindGroup({layout:e.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:v.uniformBuffer}},{binding:1,resource:v.colorTexture.view},{binding:2,resource:v.colorTexture.sampler},{binding:3,resource:{buffer:g}},{binding:4,resource:v.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(r*2),instancedDrawCallCount:0,bindGroup:m,spriteBuffer:g,spriteData:new Float32Array(r*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Un(t,e,n){let{device:r}=t,o=e.options.loadOp||"load";e.data.dirty&&(zn(e.data),e.data.dirty=!1),r.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:o,storeOp:"store"},{view:e.refs.emissive.data.view,clearValue:t.clearValue,loadOp:"clear",storeOp:"store"}]});i.setPipeline(e.refs.spritesheet.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let a=6,f=0;for(let c=0;c<e.data.instancedDrawCallCount;c++){let l=e.data.instancedDrawCalls[c*2]*a,u=e.data.instancedDrawCalls[c*2+1];i.draw(a,u,l,f),f+=u}i.end()}function zn(t){let e=-1,n=0;t.instancedDrawCallCount=0;for(let r=0;r<t.spriteCount;r++){let o=t.spriteData[r*12+11]&65535;o!==e&&(n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++),e=o,n=0),n++}n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++)}function Fn(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var tt={type:"tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Dn(t,e)},onRun:function(t,e,n){Pn(t,e,n)},onDestroy:function(t,e){et(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{setTexture:async function(t,e,n){let{device:r}=t;et(e),e.options.textureUrl=n;let o=await k(t,"tile map",e.options.textureUrl),i=r.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]});e.data.bindGroup=i,e.data.material=o}}};async function Dn(t,e){let{device:n}=t,r=await k(t,"tile map",e.options.textureUrl),o=new Float32Array([e.options.scrollScale,e.options.scrollScale]),i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,a={size:o.byteLength,usage:i,mappedAtCreation:!0},f=n.createBuffer(a);return new Float32Array(f.getMappedRange()).set(o),f.unmap(),{bindGroup:n.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:f}},{binding:1,resource:r.view},{binding:2,resource:r.sampler}]}),material:r,uniformBuffer:f,scrollScale:e.options.scrollScale}}function Pn(t,e,n){let{device:r}=t,o=e.options.loadOp||"load",i=n.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]}),a=e.refs.tileAtlas.data;i.setPipeline(a.pipeline),i.setVertexBuffer(0,a.quad.buffer),i.setBindGroup(0,e.data.bindGroup),i.setBindGroup(1,a.atlasBindGroup),i.draw(6,1,0,0),i.end()}function et(t){t.data.material.texture.destroy(),t.data.material.texture=void 0}var _e="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct displacement_param{offset:vec2<f32>,scale:f32,noop:f32};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:displacement_param;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const sx:f32=1.0;const sy:f32=1.0;const sz:f32=1.0;const tx:f32=1.0;const ty:f32=1.0;const tz:f32=0;const rot:f32=0.0;const s=sin(rot);const c=cos(rot);const scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);const modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";var C=1e-6;var S=Float32Array;function $n(t){let e=S;return S=t,e}function nt(t=0,e=0){let n=new S(2);return t!==void 0&&(n[0]=t,e!==void 0&&(n[1]=e)),n}var w=Float32Array;function Rn(t){let e=w;return w=t,e}function X(t,e,n){let r=new w(3);return t!==void 0&&(r[0]=t,e!==void 0&&(r[1]=e,n!==void 0&&(r[2]=n))),r}var Ln=nt;function On(t,e,n){return n=n||new S(2),n[0]=t,n[1]=e,n}function Vn(t,e){return e=e||new S(2),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function qn(t,e){return e=e||new S(2),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function Nn(t,e){return e=e||new S(2),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function Yn(t,e=0,n=1,r){return r=r||new S(2),r[0]=Math.min(n,Math.max(e,t[0])),r[1]=Math.min(n,Math.max(e,t[1])),r}function Xn(t,e,n){return n=n||new S(2),n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function Hn(t,e,n,r){return r=r||new S(2),r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r}function Wn(t,e){let n=t[0],r=t[1],o=e[0],i=e[1],a=Math.sqrt(n*n+r*r),f=Math.sqrt(o*o+i*i),c=a*f,l=c&&at(t,e)/c;return Math.acos(l)}function rt(t,e,n){return n=n||new S(2),n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}var jn=rt;function Qn(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C}function Zn(t,e){return t[0]===e[0]&&t[1]===e[1]}function ot(t,e,n,r){return r=r||new S(2),r[0]=t[0]+n*(e[0]-t[0]),r[1]=t[1]+n*(e[1]-t[1]),r}function Kn(t,e,n,r){return r=r||new S(2),r[0]=t[0]+n[0]*(e[0]-t[0]),r[1]=t[1]+n[1]*(e[1]-t[1]),r}function kn(t,e,n){return n=n||new S(2),n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n}function Jn(t,e,n){return n=n||new S(2),n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n}function Se(t,e,n){return n=n||new S(2),n[0]=t[0]*e,n[1]=t[1]*e,n}var dn=Se;function er(t,e,n){return n=n||new S(2),n[0]=t[0]/e,n[1]=t[1]/e,n}function it(t,e){return e=e||new S(2),e[0]=1/t[0],e[1]=1/t[1],e}var tr=it;function nr(t,e,n){n=n||new w(3);let r=t[0]*e[1]-t[1]*e[0];return n[0]=0,n[1]=0,n[2]=r,n}function at(t,e){return t[0]*e[0]+t[1]*e[1]}function be(t){let e=t[0],n=t[1];return Math.sqrt(e*e+n*n)}var rr=be;function ct(t){let e=t[0],n=t[1];return e*e+n*n}var or=ct;function ut(t,e){let n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)}var ir=ut;function ft(t,e){let n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}var ar=ft;function lt(t,e){e=e||new S(2);let n=t[0],r=t[1],o=Math.sqrt(n*n+r*r);return o>1e-5?(e[0]=n/o,e[1]=r/o):(e[0]=0,e[1]=0),e}function cr(t,e){return e=e||new S(2),e[0]=-t[0],e[1]=-t[1],e}function Me(t,e){return e=e||new S(2),e[0]=t[0],e[1]=t[1],e}var ur=Me;function st(t,e,n){return n=n||new S(2),n[0]=t[0]*e[0],n[1]=t[1]*e[1],n}var fr=st;function pt(t,e,n){return n=n||new S(2),n[0]=t[0]/e[0],n[1]=t[1]/e[1],n}var lr=pt;function sr(t=1,e){e=e||new S(2);let n=Math.random()*2*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e}function pr(t){return t=t||new S(2),t[0]=0,t[1]=0,t}function mr(t,e,n){n=n||new S(2);let r=t[0],o=t[1];return n[0]=r*e[0]+o*e[4]+e[12],n[1]=r*e[1]+o*e[5]+e[13],n}function xr(t,e,n){n=n||new S(2);let r=t[0],o=t[1];return n[0]=e[0]*r+e[4]*o+e[8],n[1]=e[1]*r+e[5]*o+e[9],n}function vr(t,e,n,r){r=r||new S(2);let o=t[0]-e[0],i=t[1]-e[1],a=Math.sin(n),f=Math.cos(n);return r[0]=o*f-i*a+e[0],r[1]=o*a+i*f+e[1],r}function mt(t,e,n){return n=n||new S(2),lt(t,n),Se(n,e,n)}function gr(t,e,n){return n=n||new S(2),be(t)>e?mt(t,e,n):Me(t,n)}function yr(t,e,n){return n=n||new S(2),ot(t,e,.5,n)}var re={__proto__:null,add:Xn,addScaled:Hn,angle:Wn,ceil:Vn,clamp:Yn,clone:ur,copy:Me,create:nt,cross:nr,dist:ir,distSq:ar,distance:ut,distanceSq:ft,div:lr,divScalar:er,divide:pt,dot:at,equals:Zn,equalsApproximately:Qn,floor:qn,fromValues:Ln,inverse:it,invert:tr,len:rr,lenSq:or,length:be,lengthSq:ct,lerp:ot,lerpV:Kn,max:kn,midpoint:yr,min:Jn,mul:fr,mulScalar:Se,multiply:st,negate:cr,normalize:lt,random:sr,rotate:vr,round:Nn,scale:dn,set:On,setDefaultType:$n,setLength:mt,sub:jn,subtract:rt,transformMat3:xr,transformMat4:mr,truncate:gr,zero:pr};var hr=new Map([[Float32Array,()=>new Float32Array(12)],[Float64Array,()=>new Float64Array(12)],[Array,()=>new Array(12).fill(0)]]),Fa=hr.get(Float32Array);var wr=X;function _r(t,e,n,r){return r=r||new w(3),r[0]=t,r[1]=e,r[2]=n,r}function Sr(t,e){return e=e||new w(3),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function br(t,e){return e=e||new w(3),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function Mr(t,e){return e=e||new w(3),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function Tr(t,e=0,n=1,r){return r=r||new w(3),r[0]=Math.min(n,Math.max(e,t[0])),r[1]=Math.min(n,Math.max(e,t[1])),r[2]=Math.min(n,Math.max(e,t[2])),r}function Cr(t,e,n){return n=n||new w(3),n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function Er(t,e,n,r){return r=r||new w(3),r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r}function Gr(t,e){let n=t[0],r=t[1],o=t[2],i=e[0],a=e[1],f=e[2],c=Math.sqrt(n*n+r*r+o*o),l=Math.sqrt(i*i+a*a+f*f),u=c*l,s=u&&gt(t,e)/u;return Math.acos(s)}function ae(t,e,n){return n=n||new w(3),n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}var Br=ae;function Ur(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C}function zr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function xt(t,e,n,r){return r=r||new w(3),r[0]=t[0]+n*(e[0]-t[0]),r[1]=t[1]+n*(e[1]-t[1]),r[2]=t[2]+n*(e[2]-t[2]),r}function Fr(t,e,n,r){return r=r||new w(3),r[0]=t[0]+n[0]*(e[0]-t[0]),r[1]=t[1]+n[1]*(e[1]-t[1]),r[2]=t[2]+n[2]*(e[2]-t[2]),r}function Dr(t,e,n){return n=n||new w(3),n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n[2]=Math.max(t[2],e[2]),n}function Pr(t,e,n){return n=n||new w(3),n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n[2]=Math.min(t[2],e[2]),n}function Te(t,e,n){return n=n||new w(3),n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n}var Ar=Te;function Ir(t,e,n){return n=n||new w(3),n[0]=t[0]/e,n[1]=t[1]/e,n[2]=t[2]/e,n}function vt(t,e){return e=e||new w(3),e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}var $r=vt;function te(t,e,n){n=n||new w(3);let r=t[2]*e[0]-t[0]*e[2],o=t[0]*e[1]-t[1]*e[0];return n[0]=t[1]*e[2]-t[2]*e[1],n[1]=r,n[2]=o,n}function gt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Ce(t){let e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}var Rr=Ce;function yt(t){let e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}var Lr=yt;function ht(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2];return Math.sqrt(n*n+r*r+o*o)}var Or=ht;function wt(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2];return n*n+r*r+o*o}var Vr=wt;function K(t,e){e=e||new w(3);let n=t[0],r=t[1],o=t[2],i=Math.sqrt(n*n+r*r+o*o);return i>1e-5?(e[0]=n/i,e[1]=r/i,e[2]=o/i):(e[0]=0,e[1]=0,e[2]=0),e}function qr(t,e){return e=e||new w(3),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function Ee(t,e){return e=e||new w(3),e[0]=t[0],e[1]=t[1],e[2]=t[2],e}var Nr=Ee;function _t(t,e,n){return n=n||new w(3),n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n}var Yr=_t;function St(t,e,n){return n=n||new w(3),n[0]=t[0]/e[0],n[1]=t[1]/e[1],n[2]=t[2]/e[2],n}var Xr=St;function Hr(t=1,e){e=e||new w(3);let n=Math.random()*2*Math.PI,r=Math.random()*2-1,o=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(n)*o,e[1]=Math.sin(n)*o,e[2]=r*t,e}function Wr(t){return t=t||new w(3),t[0]=0,t[1]=0,t[2]=0,t}function jr(t,e,n){n=n||new w(3);let r=t[0],o=t[1],i=t[2],a=e[3]*r+e[7]*o+e[11]*i+e[15]||1;return n[0]=(e[0]*r+e[4]*o+e[8]*i+e[12])/a,n[1]=(e[1]*r+e[5]*o+e[9]*i+e[13])/a,n[2]=(e[2]*r+e[6]*o+e[10]*i+e[14])/a,n}function Qr(t,e,n){n=n||new w(3);let r=t[0],o=t[1],i=t[2];return n[0]=r*e[0*4+0]+o*e[1*4+0]+i*e[2*4+0],n[1]=r*e[0*4+1]+o*e[1*4+1]+i*e[2*4+1],n[2]=r*e[0*4+2]+o*e[1*4+2]+i*e[2*4+2],n}function Zr(t,e,n){n=n||new w(3);let r=t[0],o=t[1],i=t[2];return n[0]=r*e[0]+o*e[4]+i*e[8],n[1]=r*e[1]+o*e[5]+i*e[9],n[2]=r*e[2]+o*e[6]+i*e[10],n}function Kr(t,e,n){n=n||new w(3);let r=e[0],o=e[1],i=e[2],a=e[3]*2,f=t[0],c=t[1],l=t[2],u=o*l-i*c,s=i*f-r*l,p=r*c-o*f;return n[0]=f+u*a+(o*p-i*s)*2,n[1]=c+s*a+(i*u-r*p)*2,n[2]=l+p*a+(r*s-o*u)*2,n}function kr(t,e){return e=e||new w(3),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Jr(t,e,n){n=n||new w(3);let r=e*4;return n[0]=t[r+0],n[1]=t[r+1],n[2]=t[r+2],n}function dr(t,e){e=e||new w(3);let n=t[0],r=t[1],o=t[2],i=t[4],a=t[5],f=t[6],c=t[8],l=t[9],u=t[10];return e[0]=Math.sqrt(n*n+r*r+o*o),e[1]=Math.sqrt(i*i+a*a+f*f),e[2]=Math.sqrt(c*c+l*l+u*u),e}function eo(t,e,n,r){r=r||new w(3);let o=[],i=[];return o[0]=t[0]-e[0],o[1]=t[1]-e[1],o[2]=t[2]-e[2],i[0]=o[0],i[1]=o[1]*Math.cos(n)-o[2]*Math.sin(n),i[2]=o[1]*Math.sin(n)+o[2]*Math.cos(n),r[0]=i[0]+e[0],r[1]=i[1]+e[1],r[2]=i[2]+e[2],r}function to(t,e,n,r){r=r||new w(3);let o=[],i=[];return o[0]=t[0]-e[0],o[1]=t[1]-e[1],o[2]=t[2]-e[2],i[0]=o[2]*Math.sin(n)+o[0]*Math.cos(n),i[1]=o[1],i[2]=o[2]*Math.cos(n)-o[0]*Math.sin(n),r[0]=i[0]+e[0],r[1]=i[1]+e[1],r[2]=i[2]+e[2],r}function no(t,e,n,r){r=r||new w(3);let o=[],i=[];return o[0]=t[0]-e[0],o[1]=t[1]-e[1],o[2]=t[2]-e[2],i[0]=o[0]*Math.cos(n)-o[1]*Math.sin(n),i[1]=o[0]*Math.sin(n)+o[1]*Math.cos(n),i[2]=o[2],r[0]=i[0]+e[0],r[1]=i[1]+e[1],r[2]=i[2]+e[2],r}function bt(t,e,n){return n=n||new w(3),K(t,n),Te(n,e,n)}function ro(t,e,n){return n=n||new w(3),Ce(t)>e?bt(t,e,n):Ee(t,n)}function oo(t,e,n){return n=n||new w(3),xt(t,e,.5,n)}var j={__proto__:null,add:Cr,addScaled:Er,angle:Gr,ceil:Sr,clamp:Tr,clone:Nr,copy:Ee,create:X,cross:te,dist:Or,distSq:Vr,distance:ht,distanceSq:wt,div:Xr,divScalar:Ir,divide:St,dot:gt,equals:zr,equalsApproximately:Ur,floor:br,fromValues:wr,getAxis:Jr,getScaling:dr,getTranslation:kr,inverse:vt,invert:$r,len:Rr,lenSq:Lr,length:Ce,lengthSq:yt,lerp:xt,lerpV:Fr,max:Dr,midpoint:oo,min:Pr,mul:Yr,mulScalar:Te,multiply:_t,negate:qr,normalize:K,random:Hr,rotateX:eo,rotateY:to,rotateZ:no,round:Mr,scale:Ar,set:_r,setDefaultType:Rn,setLength:bt,sub:Br,subtract:ae,transformMat3:Zr,transformMat4:jr,transformMat4Upper3x3:Qr,transformQuat:Kr,truncate:ro,zero:Wr},_=Float32Array;function io(t){let e=_;return _=t,e}function ao(t,e,n,r,o,i,a,f,c,l,u,s,p,g,v,m){let x=new _(16);return t!==void 0&&(x[0]=t,e!==void 0&&(x[1]=e,n!==void 0&&(x[2]=n,r!==void 0&&(x[3]=r,o!==void 0&&(x[4]=o,i!==void 0&&(x[5]=i,a!==void 0&&(x[6]=a,f!==void 0&&(x[7]=f,c!==void 0&&(x[8]=c,l!==void 0&&(x[9]=l,u!==void 0&&(x[10]=u,s!==void 0&&(x[11]=s,p!==void 0&&(x[12]=p,g!==void 0&&(x[13]=g,v!==void 0&&(x[14]=v,m!==void 0&&(x[15]=m)))))))))))))))),x}function co(t,e,n,r,o,i,a,f,c,l,u,s,p,g,v,m,x){return x=x||new _(16),x[0]=t,x[1]=e,x[2]=n,x[3]=r,x[4]=o,x[5]=i,x[6]=a,x[7]=f,x[8]=c,x[9]=l,x[10]=u,x[11]=s,x[12]=p,x[13]=g,x[14]=v,x[15]=m,x}function uo(t,e){return e=e||new _(16),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function fo(t,e){e=e||new _(16);let n=t[0],r=t[1],o=t[2],i=t[3],a=n+n,f=r+r,c=o+o,l=n*a,u=r*a,s=r*f,p=o*a,g=o*f,v=o*c,m=i*a,x=i*f,y=i*c;return e[0]=1-s-v,e[1]=u+y,e[2]=p-x,e[3]=0,e[4]=u-y,e[5]=1-l-v,e[6]=g+m,e[7]=0,e[8]=p+x,e[9]=g-m,e[10]=1-l-s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function lo(t,e){return e=e||new _(16),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function Ge(t,e){return e=e||new _(16),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}var so=Ge;function po(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C&&Math.abs(t[3]-e[3])<C&&Math.abs(t[4]-e[4])<C&&Math.abs(t[5]-e[5])<C&&Math.abs(t[6]-e[6])<C&&Math.abs(t[7]-e[7])<C&&Math.abs(t[8]-e[8])<C&&Math.abs(t[9]-e[9])<C&&Math.abs(t[10]-e[10])<C&&Math.abs(t[11]-e[11])<C&&Math.abs(t[12]-e[12])<C&&Math.abs(t[13]-e[13])<C&&Math.abs(t[14]-e[14])<C&&Math.abs(t[15]-e[15])<C}function mo(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function Mt(t){return t=t||new _(16),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function xo(t,e){if(e=e||new _(16),e===t){let h;return h=t[1],t[1]=t[4],t[4]=h,h=t[2],t[2]=t[8],t[8]=h,h=t[3],t[3]=t[12],t[12]=h,h=t[6],t[6]=t[9],t[9]=h,h=t[7],t[7]=t[13],t[13]=h,h=t[11],t[11]=t[14],t[14]=h,e}let n=t[0*4+0],r=t[0*4+1],o=t[0*4+2],i=t[0*4+3],a=t[1*4+0],f=t[1*4+1],c=t[1*4+2],l=t[1*4+3],u=t[2*4+0],s=t[2*4+1],p=t[2*4+2],g=t[2*4+3],v=t[3*4+0],m=t[3*4+1],x=t[3*4+2],y=t[3*4+3];return e[0]=n,e[1]=a,e[2]=u,e[3]=v,e[4]=r,e[5]=f,e[6]=s,e[7]=m,e[8]=o,e[9]=c,e[10]=p,e[11]=x,e[12]=i,e[13]=l,e[14]=g,e[15]=y,e}function Tt(t,e){e=e||new _(16);let n=t[0*4+0],r=t[0*4+1],o=t[0*4+2],i=t[0*4+3],a=t[1*4+0],f=t[1*4+1],c=t[1*4+2],l=t[1*4+3],u=t[2*4+0],s=t[2*4+1],p=t[2*4+2],g=t[2*4+3],v=t[3*4+0],m=t[3*4+1],x=t[3*4+2],y=t[3*4+3],h=p*y,E=x*g,G=c*y,B=x*l,z=c*g,F=p*l,P=o*y,A=x*i,I=o*g,$=p*i,R=o*l,O=c*i,V=u*m,q=v*s,N=a*m,H=v*f,W=a*s,fe=u*f,le=n*m,se=v*r,pe=n*s,me=u*r,xe=n*f,ve=a*r,Oe=h*f+B*s+z*m-(E*f+G*s+F*m),Ve=E*r+P*s+$*m-(h*r+A*s+I*m),qe=G*r+A*f+R*m-(B*r+P*f+O*m),Ne=F*r+I*f+O*s-(z*r+$*f+R*s),L=1/(n*Oe+a*Ve+u*qe+v*Ne);return e[0]=L*Oe,e[1]=L*Ve,e[2]=L*qe,e[3]=L*Ne,e[4]=L*(E*a+G*u+F*v-(h*a+B*u+z*v)),e[5]=L*(h*n+A*u+I*v-(E*n+P*u+$*v)),e[6]=L*(B*n+P*a+O*v-(G*n+A*a+R*v)),e[7]=L*(z*n+$*a+R*u-(F*n+I*a+O*u)),e[8]=L*(V*l+H*g+W*y-(q*l+N*g+fe*y)),e[9]=L*(q*i+le*g+me*y-(V*i+se*g+pe*y)),e[10]=L*(N*i+se*l+xe*y-(H*i+le*l+ve*y)),e[11]=L*(fe*i+pe*l+ve*g-(W*i+me*l+xe*g)),e[12]=L*(N*p+fe*x+q*c-(W*x+V*c+H*p)),e[13]=L*(pe*x+V*o+se*p-(le*p+me*x+q*o)),e[14]=L*(le*c+ve*x+H*o-(xe*x+N*o+se*c)),e[15]=L*(xe*p+W*o+me*c-(pe*c+ve*p+fe*o)),e}function vo(t){let e=t[0],n=t[0*4+1],r=t[0*4+2],o=t[0*4+3],i=t[1*4+0],a=t[1*4+1],f=t[1*4+2],c=t[1*4+3],l=t[2*4+0],u=t[2*4+1],s=t[2*4+2],p=t[2*4+3],g=t[3*4+0],v=t[3*4+1],m=t[3*4+2],x=t[3*4+3],y=s*x,h=m*p,E=f*x,G=m*c,B=f*p,z=s*c,F=r*x,P=m*o,A=r*p,I=s*o,$=r*c,R=f*o,O=y*a+G*u+B*v-(h*a+E*u+z*v),V=h*n+F*u+I*v-(y*n+P*u+A*v),q=E*n+P*a+$*v-(G*n+F*a+R*v),N=z*n+A*a+R*u-(B*n+I*a+$*u);return e*O+i*V+l*q+g*N}var go=Tt;function Ct(t,e,n){n=n||new _(16);let r=t[0],o=t[1],i=t[2],a=t[3],f=t[4],c=t[5],l=t[6],u=t[7],s=t[8],p=t[9],g=t[10],v=t[11],m=t[12],x=t[13],y=t[14],h=t[15],E=e[0],G=e[1],B=e[2],z=e[3],F=e[4],P=e[5],A=e[6],I=e[7],$=e[8],R=e[9],O=e[10],V=e[11],q=e[12],N=e[13],H=e[14],W=e[15];return n[0]=r*E+f*G+s*B+m*z,n[1]=o*E+c*G+p*B+x*z,n[2]=i*E+l*G+g*B+y*z,n[3]=a*E+u*G+v*B+h*z,n[4]=r*F+f*P+s*A+m*I,n[5]=o*F+c*P+p*A+x*I,n[6]=i*F+l*P+g*A+y*I,n[7]=a*F+u*P+v*A+h*I,n[8]=r*$+f*R+s*O+m*V,n[9]=o*$+c*R+p*O+x*V,n[10]=i*$+l*R+g*O+y*V,n[11]=a*$+u*R+v*O+h*V,n[12]=r*q+f*N+s*H+m*W,n[13]=o*q+c*N+p*H+x*W,n[14]=i*q+l*N+g*H+y*W,n[15]=a*q+u*N+v*H+h*W,n}var yo=Ct;function ho(t,e,n){return n=n||Mt(),t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11]),n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function wo(t,e){return e=e||X(),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function _o(t,e,n){n=n||X();let r=e*4;return n[0]=t[r+0],n[1]=t[r+1],n[2]=t[r+2],n}function So(t,e,n,r){r!==t&&(r=Ge(t,r));let o=n*4;return r[o+0]=e[0],r[o+1]=e[1],r[o+2]=e[2],r}function bo(t,e){e=e||X();let n=t[0],r=t[1],o=t[2],i=t[4],a=t[5],f=t[6],c=t[8],l=t[9],u=t[10];return e[0]=Math.sqrt(n*n+r*r+o*o),e[1]=Math.sqrt(i*i+a*a+f*f),e[2]=Math.sqrt(c*c+l*l+u*u),e}function Mo(t,e,n,r,o){o=o||new _(16);let i=Math.tan(Math.PI*.5-.5*t);if(o[0]=i/e,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,Number.isFinite(r)){let a=1/(n-r);o[10]=r*a,o[14]=r*n*a}else o[10]=-1,o[14]=-n;return o}function To(t,e,n,r=1/0,o){o=o||new _(16);let i=1/Math.tan(t*.5);if(o[0]=i/e,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,r===1/0)o[10]=0,o[14]=n;else{let a=1/(r-n);o[10]=n*a,o[14]=r*n*a}return o}function Co(t,e,n,r,o,i,a){return a=a||new _(16),a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(r-n),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1/(o-i),a[11]=0,a[12]=(e+t)/(t-e),a[13]=(r+n)/(n-r),a[14]=o/(o-i),a[15]=1,a}function Eo(t,e,n,r,o,i,a){a=a||new _(16);let f=e-t,c=r-n,l=o-i;return a[0]=2*o/f,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o/c,a[6]=0,a[7]=0,a[8]=(t+e)/f,a[9]=(r+n)/c,a[10]=i/l,a[11]=-1,a[12]=0,a[13]=0,a[14]=o*i/l,a[15]=0,a}function Go(t,e,n,r,o,i=1/0,a){a=a||new _(16);let f=e-t,c=r-n;if(a[0]=2*o/f,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o/c,a[6]=0,a[7]=0,a[8]=(t+e)/f,a[9]=(r+n)/c,a[11]=-1,a[12]=0,a[13]=0,a[15]=0,i===1/0)a[10]=0,a[14]=o;else{let l=1/(i-o);a[10]=o*l,a[14]=i*o*l}return a}var T,U,b;function Bo(t,e,n,r){return r=r||new _(16),T=T||X(),U=U||X(),b=b||X(),K(ae(e,t,b),b),K(te(n,b,T),T),K(te(b,T,U),U),r[0]=T[0],r[1]=T[1],r[2]=T[2],r[3]=0,r[4]=U[0],r[5]=U[1],r[6]=U[2],r[7]=0,r[8]=b[0],r[9]=b[1],r[10]=b[2],r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function Uo(t,e,n,r){return r=r||new _(16),T=T||X(),U=U||X(),b=b||X(),K(ae(t,e,b),b),K(te(n,b,T),T),K(te(b,T,U),U),r[0]=T[0],r[1]=T[1],r[2]=T[2],r[3]=0,r[4]=U[0],r[5]=U[1],r[6]=U[2],r[7]=0,r[8]=b[0],r[9]=b[1],r[10]=b[2],r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function zo(t,e,n,r){return r=r||new _(16),T=T||X(),U=U||X(),b=b||X(),K(ae(t,e,b),b),K(te(n,b,T),T),K(te(b,T,U),U),r[0]=T[0],r[1]=U[0],r[2]=b[0],r[3]=0,r[4]=T[1],r[5]=U[1],r[6]=b[1],r[7]=0,r[8]=T[2],r[9]=U[2],r[10]=b[2],r[11]=0,r[12]=-(T[0]*t[0]+T[1]*t[1]+T[2]*t[2]),r[13]=-(U[0]*t[0]+U[1]*t[1]+U[2]*t[2]),r[14]=-(b[0]*t[0]+b[1]*t[1]+b[2]*t[2]),r[15]=1,r}function Fo(t,e){return e=e||new _(16),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Do(t,e,n){n=n||new _(16);let r=e[0],o=e[1],i=e[2],a=t[0],f=t[1],c=t[2],l=t[3],u=t[1*4+0],s=t[1*4+1],p=t[1*4+2],g=t[1*4+3],v=t[2*4+0],m=t[2*4+1],x=t[2*4+2],y=t[2*4+3],h=t[3*4+0],E=t[3*4+1],G=t[3*4+2],B=t[3*4+3];return t!==n&&(n[0]=a,n[1]=f,n[2]=c,n[3]=l,n[4]=u,n[5]=s,n[6]=p,n[7]=g,n[8]=v,n[9]=m,n[10]=x,n[11]=y),n[12]=a*r+u*o+v*i+h,n[13]=f*r+s*o+m*i+E,n[14]=c*r+p*o+x*i+G,n[15]=l*r+g*o+y*i+B,n}function Po(t,e){e=e||new _(16);let n=Math.cos(t),r=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ao(t,e,n){n=n||new _(16);let r=t[4],o=t[5],i=t[6],a=t[7],f=t[8],c=t[9],l=t[10],u=t[11],s=Math.cos(e),p=Math.sin(e);return n[4]=s*r+p*f,n[5]=s*o+p*c,n[6]=s*i+p*l,n[7]=s*a+p*u,n[8]=s*f-p*r,n[9]=s*c-p*o,n[10]=s*l-p*i,n[11]=s*u-p*a,t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function Io(t,e){e=e||new _(16);let n=Math.cos(t),r=Math.sin(t);return e[0]=n,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function $o(t,e,n){n=n||new _(16);let r=t[0*4+0],o=t[0*4+1],i=t[0*4+2],a=t[0*4+3],f=t[2*4+0],c=t[2*4+1],l=t[2*4+2],u=t[2*4+3],s=Math.cos(e),p=Math.sin(e);return n[0]=s*r-p*f,n[1]=s*o-p*c,n[2]=s*i-p*l,n[3]=s*a-p*u,n[8]=s*f+p*r,n[9]=s*c+p*o,n[10]=s*l+p*i,n[11]=s*u+p*a,t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function Ro(t,e){e=e||new _(16);let n=Math.cos(t),r=Math.sin(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Lo(t,e,n){n=n||new _(16);let r=t[0*4+0],o=t[0*4+1],i=t[0*4+2],a=t[0*4+3],f=t[1*4+0],c=t[1*4+1],l=t[1*4+2],u=t[1*4+3],s=Math.cos(e),p=Math.sin(e);return n[0]=s*r+p*f,n[1]=s*o+p*c,n[2]=s*i+p*l,n[3]=s*a+p*u,n[4]=s*f-p*r,n[5]=s*c-p*o,n[6]=s*l-p*i,n[7]=s*u-p*a,t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function Et(t,e,n){n=n||new _(16);let r=t[0],o=t[1],i=t[2],a=Math.sqrt(r*r+o*o+i*i);r/=a,o/=a,i/=a;let f=r*r,c=o*o,l=i*i,u=Math.cos(e),s=Math.sin(e),p=1-u;return n[0]=f+(1-f)*u,n[1]=r*o*p+i*s,n[2]=r*i*p-o*s,n[3]=0,n[4]=r*o*p-i*s,n[5]=c+(1-c)*u,n[6]=o*i*p+r*s,n[7]=0,n[8]=r*i*p+o*s,n[9]=o*i*p-r*s,n[10]=l+(1-l)*u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}var Oo=Et;function Gt(t,e,n,r){r=r||new _(16);let o=e[0],i=e[1],a=e[2],f=Math.sqrt(o*o+i*i+a*a);o/=f,i/=f,a/=f;let c=o*o,l=i*i,u=a*a,s=Math.cos(n),p=Math.sin(n),g=1-s,v=c+(1-c)*s,m=o*i*g+a*p,x=o*a*g-i*p,y=o*i*g-a*p,h=l+(1-l)*s,E=i*a*g+o*p,G=o*a*g+i*p,B=i*a*g-o*p,z=u+(1-u)*s,F=t[0],P=t[1],A=t[2],I=t[3],$=t[4],R=t[5],O=t[6],V=t[7],q=t[8],N=t[9],H=t[10],W=t[11];return r[0]=v*F+m*$+x*q,r[1]=v*P+m*R+x*N,r[2]=v*A+m*O+x*H,r[3]=v*I+m*V+x*W,r[4]=y*F+h*$+E*q,r[5]=y*P+h*R+E*N,r[6]=y*A+h*O+E*H,r[7]=y*I+h*V+E*W,r[8]=G*F+B*$+z*q,r[9]=G*P+B*R+z*N,r[10]=G*A+B*O+z*H,r[11]=G*I+B*V+z*W,t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}var Vo=Gt;function qo(t,e){return e=e||new _(16),e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function No(t,e,n){n=n||new _(16);let r=e[0],o=e[1],i=e[2];return n[0]=r*t[0*4+0],n[1]=r*t[0*4+1],n[2]=r*t[0*4+2],n[3]=r*t[0*4+3],n[4]=o*t[1*4+0],n[5]=o*t[1*4+1],n[6]=o*t[1*4+2],n[7]=o*t[1*4+3],n[8]=i*t[2*4+0],n[9]=i*t[2*4+1],n[10]=i*t[2*4+2],n[11]=i*t[2*4+3],t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function Yo(t,e){return e=e||new _(16),e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Xo(t,e,n){return n=n||new _(16),n[0]=e*t[0*4+0],n[1]=e*t[0*4+1],n[2]=e*t[0*4+2],n[3]=e*t[0*4+3],n[4]=e*t[1*4+0],n[5]=e*t[1*4+1],n[6]=e*t[1*4+2],n[7]=e*t[1*4+3],n[8]=e*t[2*4+0],n[9]=e*t[2*4+1],n[10]=e*t[2*4+2],n[11]=e*t[2*4+3],t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}var Q={__proto__:null,aim:Bo,axisRotate:Gt,axisRotation:Et,cameraAim:Uo,clone:so,copy:Ge,create:ao,determinant:vo,equals:mo,equalsApproximately:po,fromMat3:uo,fromQuat:fo,frustum:Eo,frustumReverseZ:Go,getAxis:_o,getScaling:bo,getTranslation:wo,identity:Mt,inverse:Tt,invert:go,lookAt:zo,mul:yo,multiply:Ct,negate:lo,ortho:Co,perspective:Mo,perspectiveReverseZ:To,rotate:Vo,rotateX:Ao,rotateY:$o,rotateZ:Lo,rotation:Oo,rotationX:Po,rotationY:Io,rotationZ:Ro,scale:No,scaling:qo,set:co,setAxis:So,setDefaultType:io,setTranslation:ho,translate:Do,translation:Fo,transpose:xo,uniformScale:Xo,uniformScaling:Yo};var M=Float32Array;function Ho(t){let e=M;return M=t,e}function Bt(t,e,n,r){let o=new M(4);return t!==void 0&&(o[0]=t,e!==void 0&&(o[1]=e,n!==void 0&&(o[2]=n,r!==void 0&&(o[3]=r)))),o}var Wo=Bt;function jo(t,e,n,r,o){return o=o||new M(4),o[0]=t,o[1]=e,o[2]=n,o[3]=r,o}function Qo(t,e){return e=e||new M(4),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function Zo(t,e){return e=e||new M(4),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function Ko(t,e){return e=e||new M(4),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function ko(t,e=0,n=1,r){return r=r||new M(4),r[0]=Math.min(n,Math.max(e,t[0])),r[1]=Math.min(n,Math.max(e,t[1])),r[2]=Math.min(n,Math.max(e,t[2])),r[3]=Math.min(n,Math.max(e,t[3])),r}function Jo(t,e,n){return n=n||new M(4),n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n[3]=t[3]+e[3],n}function ei(t,e,n,r){return r=r||new M(4),r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r[3]=t[3]+e[3]*n,r}function Ut(t,e,n){return n=n||new M(4),n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n[3]=t[3]-e[3],n}var ti=Ut;function ni(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C&&Math.abs(t[3]-e[3])<C}function ri(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function zt(t,e,n,r){return r=r||new M(4),r[0]=t[0]+n*(e[0]-t[0]),r[1]=t[1]+n*(e[1]-t[1]),r[2]=t[2]+n*(e[2]-t[2]),r[3]=t[3]+n*(e[3]-t[3]),r}function oi(t,e,n,r){return r=r||new M(4),r[0]=t[0]+n[0]*(e[0]-t[0]),r[1]=t[1]+n[1]*(e[1]-t[1]),r[2]=t[2]+n[2]*(e[2]-t[2]),r[3]=t[3]+n[3]*(e[3]-t[3]),r}function ii(t,e,n){return n=n||new M(4),n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n[2]=Math.max(t[2],e[2]),n[3]=Math.max(t[3],e[3]),n}function ai(t,e,n){return n=n||new M(4),n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n[2]=Math.min(t[2],e[2]),n[3]=Math.min(t[3],e[3]),n}function Be(t,e,n){return n=n||new M(4),n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}var ci=Be;function ui(t,e,n){return n=n||new M(4),n[0]=t[0]/e,n[1]=t[1]/e,n[2]=t[2]/e,n[3]=t[3]/e,n}function Ft(t,e){return e=e||new M(4),e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}var fi=Ft;function li(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Ue(t){let e=t[0],n=t[1],r=t[2],o=t[3];return Math.sqrt(e*e+n*n+r*r+o*o)}var si=Ue;function Dt(t){let e=t[0],n=t[1],r=t[2],o=t[3];return e*e+n*n+r*r+o*o}var pi=Dt;function Pt(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2],i=t[3]-e[3];return Math.sqrt(n*n+r*r+o*o+i*i)}var mi=Pt;function At(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2],i=t[3]-e[3];return n*n+r*r+o*o+i*i}var xi=At;function It(t,e){e=e||new M(4);let n=t[0],r=t[1],o=t[2],i=t[3],a=Math.sqrt(n*n+r*r+o*o+i*i);return a>1e-5?(e[0]=n/a,e[1]=r/a,e[2]=o/a,e[3]=i/a):(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function vi(t,e){return e=e||new M(4),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function ze(t,e){return e=e||new M(4),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}var gi=ze;function $t(t,e,n){return n=n||new M(4),n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n[3]=t[3]*e[3],n}var yi=$t;function Rt(t,e,n){return n=n||new M(4),n[0]=t[0]/e[0],n[1]=t[1]/e[1],n[2]=t[2]/e[2],n[3]=t[3]/e[3],n}var hi=Rt;function wi(t){return t=t||new M(4),t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function _i(t,e,n){n=n||new M(4);let r=t[0],o=t[1],i=t[2],a=t[3];return n[0]=e[0]*r+e[4]*o+e[8]*i+e[12]*a,n[1]=e[1]*r+e[5]*o+e[9]*i+e[13]*a,n[2]=e[2]*r+e[6]*o+e[10]*i+e[14]*a,n[3]=e[3]*r+e[7]*o+e[11]*i+e[15]*a,n}function Lt(t,e,n){return n=n||new M(4),It(t,n),Be(n,e,n)}function Si(t,e,n){return n=n||new M(4),Ue(t)>e?Lt(t,e,n):ze(t,n)}function bi(t,e,n){return n=n||new M(4),zt(t,e,.5,n)}var Fe={__proto__:null,add:Jo,addScaled:ei,ceil:Qo,clamp:ko,clone:gi,copy:ze,create:Bt,dist:mi,distSq:xi,distance:Pt,distanceSq:At,div:hi,divScalar:ui,divide:Rt,dot:li,equals:ri,equalsApproximately:ni,floor:Zo,fromValues:Wo,inverse:Ft,invert:fi,len:si,lenSq:pi,length:Ue,lengthSq:Dt,lerp:zt,lerpV:oi,max:ii,midpoint:bi,min:ai,mul:yi,mulScalar:Be,multiply:$t,negate:vi,normalize:It,round:Ko,scale:ci,set:jo,setDefaultType:Ho,setLength:Lt,sub:ti,subtract:Ut,transformMat4:_i,truncate:Si,zero:wi};var Ot=j.create(0,0,0),ce=6,Vt={type:"displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return Mi(t,e)},onRun:function(t,e,n){Ti(t,e,n)},onDestroy:function(t,e){Ci(e)},onResize:function(t,e){Ei(t,e)},onViewportPosition:function(t,e){Gi(t,e)},customFunctions:{addTriangle:function(t,e,n){let r=ee(),o=e.data.spriteCount;e.data.spriteIndices.set(r,o);let i=o*ce;return e.data.spriteData[i]=n[0][0],e.data.spriteData[i+1]=n[0][1],e.data.spriteData[i+2]=n[1][0],e.data.spriteData[i+3]=n[1][1],e.data.spriteData[i+4]=n[2][0],e.data.spriteData[i+5]=n[2][1],e.data.spriteCount++,r},removeTriangle:function(t,e,n){e.data.spriteIndices.delete(n),e.data.spriteCount--},setPosition:function(t,e,n,r){let i=e.data.spriteIndices.get(n)*ce;e.data.spriteData[i]=r[0][0],e.data.spriteData[i+1]=r[0][1],e.data.spriteData[i+2]=r[1][0],e.data.spriteData[i+3]=r[1][1],e.data.spriteData[i+4]=r[2][0],e.data.spriteData[i+5]=r[2][1]}}};async function Mi(t,e){let{device:n}=t,r=new Float32Array([e.options.offseyX??0,e.options.offseyY??0,e.options.scale??20,0]),o=n.createBuffer({label:"displacement options buffer",size:r.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(o.getMappedRange()).set(r),o.unmap();let i=256,a=i,c=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*2,p=Float32Array.BYTES_PER_ELEMENT*2,g=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),v=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),m=n.createPipelineLayout({bindGroupLayouts:[v]}),x="repeat",y="linear",h=n.createSampler({label:"displacement ampler",addressModeU:x,addressModeV:x,addressModeW:x,magFilter:y,minFilter:y,mipmapFilter:y}),E=n.createBindGroup({layout:v,entries:[{binding:0,resource:{buffer:g}},{binding:1,resource:e.refs.color.data.view},{binding:2,resource:h},{binding:3,resource:e.refs.map.view},{binding:4,resource:{buffer:o}}]}),G=n.createBuffer({size:i*ce,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),B={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},z=n.createRenderPipeline({label:"displacement",vertex:{module:n.createShaderModule({code:_e}),entryPoint:"vs_main",buffers:[B]},fragment:{module:n.createShaderModule({code:_e}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:m});return{bindGroup:E,bindGroupLayout:v,uniformBuffer:g,sampler:h,pipeline:z,params_buf:o,buffer:G,spriteData:new Float32Array(i*ce),spriteCount:0,spriteIndices:new Map}}function Ti(t,e,n){if(e.data.spriteCount===0)return;let{device:r}=t,o=ce*e.data.spriteCount*Float32Array.BYTES_PER_ELEMENT;r.queue.writeBuffer(e.data.buffer,0,e.data.spriteData.buffer,0,o);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.data.buffer);let a=e.data.spriteCount*3;i.draw(a,1,0,0),i.end()}function Ci(t){t.data.bindGroup=null,t.data.buffer.destroy(),t.data.buffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null,t.data.params_buf.destroy(),t.data.params_buf=null}function Ei(t,e){let{device:n}=t;e.data.bindGroup=n.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:e.refs.color.data.view},{binding:2,resource:e.data.sampler},{binding:3,resource:e.refs.map.view},{binding:4,resource:{buffer:e.data.params_buf}}]})}function Gi(t,e){let{device:n}=t,r=t.viewport.width/t.viewport.zoom,o=t.viewport.height/t.viewport.zoom,i=Q.ortho(0,r,o,0,-10,10);j.set(-t.viewport.position[0],-t.viewport.position[1],0,Ot);let a=Q.translation(Ot);n.queue.writeBuffer(e.data.uniformBuffer,0,a.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,i.buffer)}function De(t,e){let n=e.vertices,r=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,o={size:n.byteLength,usage:r,mappedAtCreation:!0},i=t.createBuffer(o);return new Float32Array(i.getMappedRange()).set(n),i.unmap(),{buffer:i,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var Pe="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var rc=Fe.create(),qt=j.create(),Xt={type:"overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Ui(t,e)},onRun:function(t,e,n){zi(t,e,n)},onDestroy:function(t,e){Di(e)},onResize:function(t,e){Nt(t,e)},onViewportPosition:function(t,e){Nt(t,e)},customFunctions:{...ie}};async function Ui(t,e){let{device:n}=t,r=16192,o=r,a=Float32Array.BYTES_PER_ELEMENT*2,c=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*4,p=Float32Array.BYTES_PER_ELEMENT*4,g=n.createBuffer({size:(a+c+u+p)*o,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),v=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),m=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),x=n.createBindGroup({layout:m,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:e.refs.spritesheet.data.colorTexture.view},{binding:2,resource:e.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:g}}]}),y=n.createPipelineLayout({bindGroupLayouts:[m]}),h=n.createRenderPipeline({label:"overlay",vertex:{module:n.createShaderModule({code:Pe}),entryPoint:"vs_main",buffers:[e.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:n.createShaderModule({code:Pe}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:y});return{instancedDrawCalls:new Uint32Array(r*2),instancedDrawCallCount:0,spriteBuffer:g,uniformBuffer:v,pipeline:h,bindGroupLayout:m,bindGroup:x,spriteData:new Float32Array(r*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function zi(t,e,n){let{device:r}=t,o=e.options.loadOp||"load";e.data.dirty&&(Fi(e.data),e.data.dirty=!1),r.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let a=6,f=0;for(let c=0;c<e.data.instancedDrawCallCount;c++){let l=e.data.instancedDrawCalls[c*2]*a,u=e.data.instancedDrawCalls[c*2+1];i.draw(a,u,l,f),f+=u}i.end()}function Fi(t){let e=-1,n=0;t.instancedDrawCallCount=0;for(let r=0;r<t.spriteCount;r++){let o=t.spriteData[r*12+11]&65535;o!==e&&(n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++),e=o,n=0),n++}n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++)}function Nt(t,e){let r=Math.round(t.viewport.width/1),o=Math.round(t.viewport.height/1),i=Q.ortho(0,r,o,0,-10,10);j.set(0,0,0,qt);let a=Q.translation(qt);t.device.queue.writeBuffer(e.data.uniformBuffer,0,a.buffer),t.device.queue.writeBuffer(e.data.uniformBuffer,64,i.buffer)}function Di(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var Ae="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var Ht={type:"fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return Ai(t,e)},onRun:function(t,e,n){Ii(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){$i(t,e)},onViewportPosition:function(t,e){}};async function Ai(t,e){let{device:n}=t,r=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),o=n.createBindGroup({layout:r,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]}),i=n.createPipelineLayout({bindGroupLayouts:[r]}),a=n.createRenderPipeline({label:"fb-blit",vertex:{module:n.createShaderModule({code:Ae}),entryPoint:"vs_main",buffers:[]},fragment:{module:n.createShaderModule({code:Ae}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:i});return{bindGroupLayout:r,bindGroup:o,pipeline:a}}function Ii(t,e,n){let{device:r}=t,o=n.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});o.setPipeline(e.data.pipeline),o.setBindGroup(0,e.data.bindGroup),o.draw(3),o.end()}function $i(t,e){let{device:n}=t;e.data.bindGroup=n.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]})}var Wt="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function ue(t,e,n,r,o,i=1){let a=re.sub(r,n),f=re.normalize(a),c=Li(f),l=i/2,u=e.data.vertexCount*6;e.data.vertices[u+0]=n[0]+c[0]*l,e.data.vertices[u+1]=n[1]+c[1]*l,e.data.vertices[u+2]=o[0],e.data.vertices[u+3]=o[1],e.data.vertices[u+4]=o[2],e.data.vertices[u+5]=o[3],e.data.vertices[u+6]=n[0]-c[0]*l,e.data.vertices[u+7]=n[1]-c[1]*l,e.data.vertices[u+8]=o[0],e.data.vertices[u+9]=o[1],e.data.vertices[u+10]=o[2],e.data.vertices[u+11]=o[3],e.data.vertices[u+12]=r[0]+c[0]*l,e.data.vertices[u+13]=r[1]+c[1]*l,e.data.vertices[u+14]=o[0],e.data.vertices[u+15]=o[1],e.data.vertices[u+16]=o[2],e.data.vertices[u+17]=o[3],e.data.vertices[u+18]=n[0]-c[0]*l,e.data.vertices[u+19]=n[1]-c[1]*l,e.data.vertices[u+20]=o[0],e.data.vertices[u+21]=o[1],e.data.vertices[u+22]=o[2],e.data.vertices[u+23]=o[3],e.data.vertices[u+24]=r[0]+c[0]*l,e.data.vertices[u+25]=r[1]+c[1]*l,e.data.vertices[u+26]=o[0],e.data.vertices[u+27]=o[1],e.data.vertices[u+28]=o[2],e.data.vertices[u+29]=o[3],e.data.vertices[u+30]=r[0]-c[0]*l,e.data.vertices[u+31]=r[1]-c[1]*l,e.data.vertices[u+32]=o[0],e.data.vertices[u+33]=o[1],e.data.vertices[u+34]=o[2],e.data.vertices[u+35]=o[3],e.data.vertexCount+=6,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)}function Li(t){return[-t[1],t[0]]}var jt={line:ue,filledEllipse:function(t,e,n,r,o,i,a){let[f,c]=n,l=2*Math.PI/i;for(let u=0;u<i;u++){let s=u*l,p=(u+1)*l,g=f+r*Math.cos(s),v=c+o*Math.sin(s),m=f+r*Math.cos(p),x=c+o*Math.sin(p),y=e.data.vertexCount*6+u*18;e.data.vertices[y+0]=f,e.data.vertices[y+1]=c,e.data.vertices[y+2]=a[0],e.data.vertices[y+3]=a[1],e.data.vertices[y+4]=a[2],e.data.vertices[y+5]=a[3],e.data.vertices[y+6]=g,e.data.vertices[y+7]=v,e.data.vertices[y+8]=a[0],e.data.vertices[y+9]=a[1],e.data.vertices[y+10]=a[2],e.data.vertices[y+11]=a[3],e.data.vertices[y+12]=m,e.data.vertices[y+13]=x,e.data.vertices[y+14]=a[0],e.data.vertices[y+15]=a[1],e.data.vertices[y+16]=a[2],e.data.vertices[y+17]=a[3]}e.data.vertexCount+=3*i,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)},box:function(t,e,n,r,o,i,a=0,f=1){let[c,l]=n,u=r/2,s=o/2,p=[c-u,l-s],g=[c+u,l-s],v=[c-u,l+s],m=[c+u,l+s];a!==0&&(d(p,n,a,p),d(g,n,a,g),d(v,n,a,v),d(m,n,a,m)),ue(t,e,p,g,i,f),ue(t,e,v,m,i,f),ue(t,e,p,v,i,f),ue(t,e,g,m,i,f)},filledBox:function(t,e,n,r,o,i,a=0){let[f,c]=n,l=r/2,u=o/2,s=[f-l,c-u],p=[f+l,c-u],g=[f-l,c+u],v=[f+l,c+u];a!==0&&(d(s,n,a,s),d(p,n,a,p),d(g,n,a,g),d(v,n,a,v));let m=e.data.vertexCount*6;e.data.vertices[m+0]=s[0],e.data.vertices[m+1]=s[1],e.data.vertices[m+2]=i[0],e.data.vertices[m+3]=i[1],e.data.vertices[m+4]=i[2],e.data.vertices[m+5]=i[3],e.data.vertices[m+6]=g[0],e.data.vertices[m+7]=g[1],e.data.vertices[m+8]=i[0],e.data.vertices[m+9]=i[1],e.data.vertices[m+10]=i[2],e.data.vertices[m+11]=i[3],e.data.vertices[m+12]=p[0],e.data.vertices[m+13]=p[1],e.data.vertices[m+14]=i[0],e.data.vertices[m+15]=i[1],e.data.vertices[m+16]=i[2],e.data.vertices[m+17]=i[3],e.data.vertices[m+18]=g[0],e.data.vertices[m+19]=g[1],e.data.vertices[m+20]=i[0],e.data.vertices[m+21]=i[1],e.data.vertices[m+22]=i[2],e.data.vertices[m+23]=i[3],e.data.vertices[m+24]=v[0],e.data.vertices[m+25]=v[1],e.data.vertices[m+26]=i[0],e.data.vertices[m+27]=i[1],e.data.vertices[m+28]=i[2],e.data.vertices[m+29]=i[3],e.data.vertices[m+30]=p[0],e.data.vertices[m+31]=p[1],e.data.vertices[m+32]=i[0],e.data.vertices[m+33]=i[1],e.data.vertices[m+34]=i[2],e.data.vertices[m+35]=i[3],e.data.vertexCount+=6,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)},clear:function(t,e){e.data.vertexCount=0}};function d(t,e,n,r){let o=t[0]-e[0],i=t[1]-e[1],a=Math.sin(n),f=Math.cos(n);return r[0]=o*f-i*a+e[0],r[1]=o*a+i*f+e[1],r}var Qt=j.create(0,0,0),Kt={type:"primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Oi(t,e)},onRun:function(t,e,n){Vi(t,e,n)},onDestroy:function(t,e){qi(e)},onResize:function(t,e){Zt(t,e)},onViewportPosition:function(t,e){Zt(t,e)},customFunctions:jt};async function Oi(t,e){let{device:n}=t,r=new Float32Array(1e4),o=n.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),i=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=n.createShaderModule({code:Wt}),f=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),c=n.createPipelineLayout({bindGroupLayouts:[f]}),l=n.createBindGroup({layout:f,entries:[{binding:0,resource:{buffer:i}}]}),u=n.createRenderPipeline({layout:c,vertex:{module:a,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:a,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:i,vertexBuffer:o,pipeline:u,bindGroup:l,vertexCount:0,vertices:r}}function Vi(t,e,n){if(e.data.vertexCount===0)return;let{device:r}=t,o=e.options.loadOp||"load",i=n.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.data.vertexBuffer),i.draw(e.data.vertexCount),i.end()}function qi(t){t.data.vertexBuffer.destroy(),t.data.vertexBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null}function Zt(t,e){let{device:n}=t,r=t.viewport.width/t.viewport.zoom,o=t.viewport.height/t.viewport.zoom,i=Q.ortho(0,r,o,0,-10,10);j.set(-t.viewport.position[0],-t.viewport.position[1],0,Qt);let a=Q.translation(Qt);n.queue.writeBuffer(e.data.uniformBuffer,0,a.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,i.buffer)}var Ie={};Ye(Ie,{addLight:()=>Ni,removeLight:()=>Yi});function Ni(t,e,n){e.data.lights.push({id:ee(),position:re.clone(n)})}function Yi(t,e,n){let r=e.data.lights.find(i=>i.id===n),o=e.data.lights.indexOf(r);o<0||e.data.lights.removeItem(o)}var kt={type:"cobalt:light",refs:[{name:"output",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Xi(t,e)},onRun:function(t,e,n){Hi(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{...Ie}};async function Xi(t,e){let{device:n}=t,r=256;return{occluders:[],lights:[]}}function Hi(t,e,n){let{device:r}=t}function $e(t){let e=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]),n=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:e.byteLength,usage:n,mappedAtCreation:!0},o=t.createBuffer(r);return new Float32Array(o.getMappedRange()).set(e),o.unmap(),{buffer:o,bufferLayout:{arrayStride:16,attributes:[{shaderLocation:0,format:"float32x2",offset:0},{shaderLocation:1,format:"float32x2",offset:8}]}}}var Re="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec2<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var J=new Float32Array(8),dt={type:"tileAtlas",refs:[],onInit:async function(t,e={}){return ji(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){Qi(data)},onResize:function(t,e){Jt(t,e)},onViewportPosition:function(t,e){Jt(t,e)}};async function ji(t,e){let{device:n}=t,r=$e(n),o=await k(t,"tile atlas",e.options.textureUrl),i=n.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),f=n.createBindGroup({layout:a,entries:[{binding:0,resource:{buffer:i}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]}),c=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),l=n.createPipelineLayout({bindGroupLayouts:[c,a]});return{pipeline:n.createRenderPipeline({label:"tile",vertex:{module:n.createShaderModule({code:Re}),entryPoint:"vs_main",buffers:[r.bufferLayout]},fragment:{module:n.createShaderModule({code:Re}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:l}),uniformBuffer:i,atlasBindGroup:f,atlasMaterial:o,tileBindGroupLayout:c,quad:r,tileSize:e.options.tileSize,tileScale:e.options.tileScale}}function Qi(t){t.atlasMaterial.texture.destroy(),t.atlasMaterial.texture=void 0}function Jt(t,e){J[0]=t.viewport.position[0],J[1]=t.viewport.position[1];let n=e.data,{tileScale:r,tileSize:o}=n,i=t.viewport.width/t.viewport.zoom,a=t.viewport.height/t.viewport.zoom;J[2]=i/r,J[3]=a/r,J[4]=1/n.atlasMaterial.texture.width,J[5]=1/n.atlasMaterial.texture.height,J[6]=o,J[7]=1/o,t.device.queue.writeBuffer(n.uniformBuffer,0,J,0,8)}function ye(t){let n=Object.keys(t.frames).length,r=new Float32Array(n*30),o=[],i={},a=0;for(let f in t.frames){let c=t.frames[f];o.push(f),i[f]=c.sourceSize;let l=-.5+c.spriteSourceSize.x/c.sourceSize.w,u=-.5+c.spriteSourceSize.y/c.sourceSize.h,s=-.5+(c.spriteSourceSize.x+c.spriteSourceSize.w)/c.sourceSize.w,p=-.5+(c.spriteSourceSize.y+c.spriteSourceSize.h)/c.sourceSize.h,g=[l,u,0],v=[l,p,0],m=[s,p,0],x=[s,u,0],y=0+c.frame.x/t.meta.size.w,h=0+c.frame.y/t.meta.size.h,E=0+(c.frame.x+c.frame.w)/t.meta.size.w,G=0+(c.frame.y+c.frame.h)/t.meta.size.h,B=[y,h],z=[y,G],F=[E,G],P=[E,h];r.set(g,a),r.set(B,a+3),r.set(v,a+5),r.set(z,a+8),r.set(m,a+10),r.set(F,a+13),r.set(g,a+15),r.set(B,a+18),r.set(m,a+20),r.set(F,a+23),r.set(x,a+25),r.set(P,a+28),a+=30}return{spriteMeta:i,locations:o,vertices:r}}var Le="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var en=j.create(0,0,0),nn={type:"spritesheet",refs:[],onInit:async function(t,e={}){return Ki(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){ki(e)},onResize:function(t,e){tn(t,e)},onViewportPosition:function(t,e){tn(t,e)}};async function Ki(t,e){let{canvas:n,device:r}=t,o,i,a;n?(o=await Ji(e.options.spriteSheetJsonUrl),o=ye(o),i=await k(t,"sprite",e.options.colorTextureUrl,"rgba8unorm"),a=await k(t,"emissive sprite",e.options.emissiveTextureUrl,"rgba8unorm"),n.style.imageRendering="pixelated"):(o=ye(e.options.spriteSheetJson),i=await oe(t,"sprite",e.options.colorTexture,"rgba8unorm"),a=await oe(t,"emissive sprite",e.options.emissiveTexture,"rgba8unorm"));let f=De(r,o),c=r.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),l=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),u=r.createPipelineLayout({bindGroupLayouts:[l]});return{pipeline:r.createRenderPipeline({label:"sprite",vertex:{module:r.createShaderModule({code:Le}),entryPoint:"vs_main",buffers:[f.bufferLayout]},fragment:{module:r.createShaderModule({code:Le}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:u}),uniformBuffer:c,quads:f,colorTexture:i,emissiveTexture:a,bindGroupLayout:l,spritesheet:o}}function ki(t){t.data.quads.buffer.destroy(),t.data.colorTexture.buffer.destroy(),t.data.uniformBuffer.destroy(),t.data.emissiveTexture.texture.destroy()}async function Ji(t){return(await fetch(t)).json()}function tn(t,e){let{device:n,viewport:r}=t,o=r.width/r.zoom,i=r.height/r.zoom,a=Q.ortho(0,o,i,0,-10,10);j.set(-r.position[0],-r.position[1],0,en);let f=Q.translation(en);n.queue.writeBuffer(e.data.uniformBuffer,0,f.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,a.buffer)}var rn={type:"fbTexture",refs:[],onInit:async function(t,e={}){return di(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){on(data)},onResize:function(t,e){ea(t,e)},onViewportPosition:function(t,e){}};async function di(t,e){let{device:n}=t,{label:r,mip_count:o,format:i,usage:a,viewportScale:f}=e.options;return Y(n,r,t.viewport.width*f,t.viewport.height*f,o,i,a)}function on(t){t.data.texture.destroy()}function ea(t,e){let{device:n}=t;on(e);let{width:r,height:o}=t.viewport,{options:i}=e,a=e.options.viewportScale;e.data=Y(n,i.label,r*a,o*a,i.mip_count,i.format,i.usage)}async function dc(t,e,n){let r,o,i,a;return t.sdlWindow&&t.gpu?(o=t.gpu,r=await(await o.create(["verbose=1"]).requestAdapter()).requestDevice(),i=o.renderGPUDeviceToWindow({device:r,window:t.sdlWindow}),global.GPUBufferUsage=o.GPUBufferUsage,global.GPUShaderStage=o.GPUShaderStage,global.GPUTextureUsage=o.GPUTextureUsage):(a=t,r=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),o=navigator.gpu,i=a.getContext("webgpu"),i.configure({device:r,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{tileAtlas:dt,spritesheet:nn,fbTexture:rn,bloom:je,composite:Ke,sprite:de,tile:tt,displacement:Vt,overlay:Xt,fbBlit:Ht,primitives:Kt,"cobalt:light":kt},nodes:[],defaultTextureViewRefs:[],canvas:a,device:r,context:i,gpu:o,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:e,height:n,zoom:1,position:[0,0]}}}function eu(t,e){if(!e?.type)throw new Error("Can't define a new node missing a type.");t.nodeDefs[e.type]=e}async function tu(t,e){let n=t.nodeDefs[e?.type];if(!n)throw new Error("Can't initialize a new node missing a type.");let r={type:e.type,refs:e.refs||{},options:e.options||{},data:{},enabled:!0};for(let i in r.refs)r.refs[i]==="FRAME_TEXTURE_VIEW"&&(t.defaultTextureViewRefs.push({node:r,refName:i}),r.refs[i]=an(t));r.data=await n.onInit(t,r);let o=n.customFunctions||{};for(let i in o)r[i]=function(...a){return o[i](t,r,...a)};return t.nodes.push(r),r}function nu(t){let{device:e,context:n}=t,r=e.createCommandEncoder(),o=an(t);for(let i of t.defaultTextureViewRefs)i.node.refs[i.refName]=o;for(let i of t.nodes){if(!i.enabled)continue;t.nodeDefs[i.type].onRun(t,i,r)}e.queue.submit([r.finish()]),t.canvas||t.context.swap()}function ru(t){for(let e of t.nodes)t.nodeDefs[e.type].onDestroy(t,e);t.nodes.length=0,t.defaultTextureViewRefs.length=0}function ou(t,e,n){t.viewport.width=e,t.viewport.height=n;for(let r of t.nodes)t.nodeDefs[r.type].onResize(t,r)}function iu(t,e){t.viewport.position[0]=e[0]-t.viewport.width/2/t.viewport.zoom,t.viewport.position[1]=e[1]-t.viewport.height/2/t.viewport.zoom;for(let n of t.nodes)t.nodeDefs[n.type].onViewportPosition(t,n)}function ke(t){return t.canvas?navigator.gpu.getPreferredCanvasFormat():t.context.getPreferredFormat()}function an(t){return t.canvas?t.context.getCurrentTexture().createView():t.context.getCurrentTextureView()}export{Y as createTexture,oe as createTextureFromBuffer,k as createTextureFromUrl,eu as defineNode,nu as draw,an as getCurrentTextureView,ke as getPreferredFormat,dc as init,tu as initNode,ru as reset,ou as setViewportDimensions,iu as setViewportPosition};

var _s=Object.create;var on=Object.defineProperty;var Ss=Object.getOwnPropertyDescriptor;var Bs=Object.getOwnPropertyNames;var Ps=Object.getPrototypeOf,Ds=Object.prototype.hasOwnProperty;var xt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ei=(t,e)=>{for(var n in e)on(t,n,{get:e[n],enumerable:!0})},Us=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Bs(e))!Ds.call(t,i)&&i!==n&&on(t,i,{get:()=>e[i],enumerable:!(r=Ss(e,i))||r.enumerable});return t};var ri=(t,e,n)=>(n=t!=null?_s(Ps(t)):{},Us(e||!t||!t.__esModule?on(n,"default",{value:t,enumerable:!0}):n,t));var Qe=xt((o1,Ai)=>{"use strict";function Tu(t,e,n,r,i){for(var o=i+1;r<=i;){var s=r+i>>>1,c=t[s],f=n!==void 0?n(c,e):c-e;f>=0?(o=s,i=s-1):r=s+1}return o}function _u(t,e,n,r,i){for(var o=i+1;r<=i;){var s=r+i>>>1,c=t[s],f=n!==void 0?n(c,e):c-e;f>0?(o=s,i=s-1):r=s+1}return o}function Su(t,e,n,r,i){for(var o=r-1;r<=i;){var s=r+i>>>1,c=t[s],f=n!==void 0?n(c,e):c-e;f<0?(o=s,r=s+1):i=s-1}return o}function Bu(t,e,n,r,i){for(var o=r-1;r<=i;){var s=r+i>>>1,c=t[s],f=n!==void 0?n(c,e):c-e;f<=0?(o=s,r=s+1):i=s-1}return o}function Pu(t,e,n,r,i){for(;r<=i;){var o=r+i>>>1,s=t[o],c=n!==void 0?n(s,e):s-e;if(c===0)return o;c<=0?r=o+1:i=o-1}return-1}function We(t,e,n,r,i,o){return typeof n=="function"?o(t,e,n,r===void 0?0:r|0,i===void 0?t.length-1:i|0):o(t,e,void 0,n===void 0?0:n|0,r===void 0?t.length-1:r|0)}Ai.exports={ge:function(t,e,n,r,i){return We(t,e,n,r,i,Tu)},gt:function(t,e,n,r,i){return We(t,e,n,r,i,_u)},lt:function(t,e,n,r,i){return We(t,e,n,r,i,Su)},le:function(t,e,n,r,i){return We(t,e,n,r,i,Bu)},eq:function(t,e,n,r,i){return We(t,e,n,r,i,Pu)}}});var hr=xt((a1,Li)=>{"use strict";Li.exports=Du;var Ei=+(Math.pow(2,27)+1);function Du(t,e,n){var r=t*e,i=Ei*t,o=i-t,s=i-o,c=t-s,f=Ei*e,p=f-e,g=f-p,F=e-g,C=r-s*g,N=C-c*g,m=N-s*F,V=c*F-m;return n?(n[0]=V,n[1]=r,n):[V,r]}});var pn=xt((s1,zi)=>{"use strict";zi.exports=Gu;function Uu(t,e){var n=t+e,r=n-t,i=n-r,o=e-r,s=t-i,c=s+o;return c?[c,n]:[n]}function Gu(t,e){var n=t.length|0,r=e.length|0;if(n===1&&r===1)return Uu(t[0],e[0]);var i=n+r,o=new Array(i),s=0,c=0,f=0,p=Math.abs,g=t[c],F=p(g),C=e[f],N=p(C),m,V;F<N?(V=g,c+=1,c<n&&(g=t[c],F=p(g))):(V=C,f+=1,f<r&&(C=e[f],N=p(C))),c<n&&F<N||f>=r?(m=g,c+=1,c<n&&(g=t[c],F=p(g))):(m=C,f+=1,f<r&&(C=e[f],N=p(C)));for(var Y=m+V,et=Y-m,W=V-et,H=W,j=Y,K,tt,ut,J,rt;c<n&&f<r;)F<N?(m=g,c+=1,c<n&&(g=t[c],F=p(g))):(m=C,f+=1,f<r&&(C=e[f],N=p(C))),V=H,Y=m+V,et=Y-m,W=V-et,W&&(o[s++]=W),K=j+Y,tt=K-j,ut=K-tt,J=Y-tt,rt=j-ut,H=rt+J,j=K;for(;c<n;)m=g,V=H,Y=m+V,et=Y-m,W=V-et,W&&(o[s++]=W),K=j+Y,tt=K-j,ut=K-tt,J=Y-tt,rt=j-ut,H=rt+J,j=K,c+=1,c<n&&(g=t[c]);for(;f<r;)m=C,V=H,Y=m+V,et=Y-m,W=V-et,W&&(o[s++]=W),K=j+Y,tt=K-j,ut=K-tt,J=Y-tt,rt=j-ut,H=rt+J,j=K,f+=1,f<r&&(C=e[f]);return H&&(o[s++]=H),j&&(o[s++]=j),s||(o[s++]=0),o.length=s,o}});var mi=xt((u1,Ri)=>{"use strict";Ri.exports=Fu;function Fu(t,e,n){var r=t+e,i=r-t,o=r-i,s=e-i,c=t-o;return n?(n[0]=c+s,n[1]=r,n):[c+s,r]}});var dn=xt((c1,Oi)=>{"use strict";var vn=hr(),Iu=mi();Oi.exports=Au;function Au(t,e){var n=t.length;if(n===1){var r=vn(t[0],e);return r[0]?r:[r[1]]}var i=new Array(2*n),o=[.1,.1],s=[.1,.1],c=0;vn(t[0],e,o),o[0]&&(i[c++]=o[0]);for(var f=1;f<n;++f){vn(t[f],e,s);var p=o[1];Iu(p,s[0],o),o[0]&&(i[c++]=o[0]);var g=s[1],F=o[1],C=g+F,N=C-g,m=F-N;o[1]=C,m&&(i[c++]=m)}return o[1]&&(i[c++]=o[1]),c===0&&(i[c++]=0),i.length=c,i}});var gn=xt((f1,Vi)=>{"use strict";Vi.exports=Lu;function Eu(t,e){var n=t+e,r=n-t,i=n-r,o=e-r,s=t-i,c=s+o;return c?[c,n]:[n]}function Lu(t,e){var n=t.length|0,r=e.length|0;if(n===1&&r===1)return Eu(t[0],-e[0]);var i=n+r,o=new Array(i),s=0,c=0,f=0,p=Math.abs,g=t[c],F=p(g),C=-e[f],N=p(C),m,V;F<N?(V=g,c+=1,c<n&&(g=t[c],F=p(g))):(V=C,f+=1,f<r&&(C=-e[f],N=p(C))),c<n&&F<N||f>=r?(m=g,c+=1,c<n&&(g=t[c],F=p(g))):(m=C,f+=1,f<r&&(C=-e[f],N=p(C)));for(var Y=m+V,et=Y-m,W=V-et,H=W,j=Y,K,tt,ut,J,rt;c<n&&f<r;)F<N?(m=g,c+=1,c<n&&(g=t[c],F=p(g))):(m=C,f+=1,f<r&&(C=-e[f],N=p(C))),V=H,Y=m+V,et=Y-m,W=V-et,W&&(o[s++]=W),K=j+Y,tt=K-j,ut=K-tt,J=Y-tt,rt=j-ut,H=rt+J,j=K;for(;c<n;)m=g,V=H,Y=m+V,et=Y-m,W=V-et,W&&(o[s++]=W),K=j+Y,tt=K-j,ut=K-tt,J=Y-tt,rt=j-ut,H=rt+J,j=K,c+=1,c<n&&(g=t[c]);for(;f<r;)m=C,V=H,Y=m+V,et=Y-m,W=V-et,W&&(o[s++]=W),K=j+Y,tt=K-j,ut=K-tt,J=Y-tt,rt=j-ut,H=rt+J,j=K,f+=1,f<r&&(C=-e[f]);return H&&(o[s++]=H),j&&(o[s++]=j),s||(o[s++]=0),o.length=s,o}});var xn=xt((l1,wn)=>{"use strict";var zu=hr(),Ru=pn(),mu=dn(),Ou=gn(),qi=5,pr=11102230246251565e-32,Vu=(3+16*pr)*pr,qu=(7+56*pr)*pr;function Nu(t,e,n,r){return function(o,s,c){var f=t(t(e(s[1],c[0]),e(-c[1],s[0])),t(e(o[1],s[0]),e(-s[1],o[0]))),p=t(e(o[1],c[0]),e(-c[1],o[0])),g=r(f,p);return g[g.length-1]}}function Cu(t,e,n,r){return function(o,s,c,f){var p=t(t(n(t(e(c[1],f[0]),e(-f[1],c[0])),s[2]),t(n(t(e(s[1],f[0]),e(-f[1],s[0])),-c[2]),n(t(e(s[1],c[0]),e(-c[1],s[0])),f[2]))),t(n(t(e(s[1],f[0]),e(-f[1],s[0])),o[2]),t(n(t(e(o[1],f[0]),e(-f[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),f[2])))),g=t(t(n(t(e(c[1],f[0]),e(-f[1],c[0])),o[2]),t(n(t(e(o[1],f[0]),e(-f[1],o[0])),-c[2]),n(t(e(o[1],c[0]),e(-c[1],o[0])),f[2]))),t(n(t(e(s[1],c[0]),e(-c[1],s[0])),o[2]),t(n(t(e(o[1],c[0]),e(-c[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),c[2])))),F=r(p,g);return F[F.length-1]}}function ku(t,e,n,r){return function(o,s,c,f,p){var g=t(t(t(n(t(n(t(e(f[1],p[0]),e(-p[1],f[0])),c[2]),t(n(t(e(c[1],p[0]),e(-p[1],c[0])),-f[2]),n(t(e(c[1],f[0]),e(-f[1],c[0])),p[2]))),s[3]),t(n(t(n(t(e(f[1],p[0]),e(-p[1],f[0])),s[2]),t(n(t(e(s[1],p[0]),e(-p[1],s[0])),-f[2]),n(t(e(s[1],f[0]),e(-f[1],s[0])),p[2]))),-c[3]),n(t(n(t(e(c[1],p[0]),e(-p[1],c[0])),s[2]),t(n(t(e(s[1],p[0]),e(-p[1],s[0])),-c[2]),n(t(e(s[1],c[0]),e(-c[1],s[0])),p[2]))),f[3]))),t(n(t(n(t(e(c[1],f[0]),e(-f[1],c[0])),s[2]),t(n(t(e(s[1],f[0]),e(-f[1],s[0])),-c[2]),n(t(e(s[1],c[0]),e(-c[1],s[0])),f[2]))),-p[3]),t(n(t(n(t(e(f[1],p[0]),e(-p[1],f[0])),s[2]),t(n(t(e(s[1],p[0]),e(-p[1],s[0])),-f[2]),n(t(e(s[1],f[0]),e(-f[1],s[0])),p[2]))),o[3]),n(t(n(t(e(f[1],p[0]),e(-p[1],f[0])),o[2]),t(n(t(e(o[1],p[0]),e(-p[1],o[0])),-f[2]),n(t(e(o[1],f[0]),e(-f[1],o[0])),p[2]))),-s[3])))),t(t(n(t(n(t(e(s[1],p[0]),e(-p[1],s[0])),o[2]),t(n(t(e(o[1],p[0]),e(-p[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),p[2]))),f[3]),t(n(t(n(t(e(s[1],f[0]),e(-f[1],s[0])),o[2]),t(n(t(e(o[1],f[0]),e(-f[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),f[2]))),-p[3]),n(t(n(t(e(c[1],f[0]),e(-f[1],c[0])),s[2]),t(n(t(e(s[1],f[0]),e(-f[1],s[0])),-c[2]),n(t(e(s[1],c[0]),e(-c[1],s[0])),f[2]))),o[3]))),t(n(t(n(t(e(c[1],f[0]),e(-f[1],c[0])),o[2]),t(n(t(e(o[1],f[0]),e(-f[1],o[0])),-c[2]),n(t(e(o[1],c[0]),e(-c[1],o[0])),f[2]))),-s[3]),t(n(t(n(t(e(s[1],f[0]),e(-f[1],s[0])),o[2]),t(n(t(e(o[1],f[0]),e(-f[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),f[2]))),c[3]),n(t(n(t(e(s[1],c[0]),e(-c[1],s[0])),o[2]),t(n(t(e(o[1],c[0]),e(-c[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),c[2]))),-f[3]))))),F=t(t(t(n(t(n(t(e(f[1],p[0]),e(-p[1],f[0])),c[2]),t(n(t(e(c[1],p[0]),e(-p[1],c[0])),-f[2]),n(t(e(c[1],f[0]),e(-f[1],c[0])),p[2]))),o[3]),n(t(n(t(e(f[1],p[0]),e(-p[1],f[0])),o[2]),t(n(t(e(o[1],p[0]),e(-p[1],o[0])),-f[2]),n(t(e(o[1],f[0]),e(-f[1],o[0])),p[2]))),-c[3])),t(n(t(n(t(e(c[1],p[0]),e(-p[1],c[0])),o[2]),t(n(t(e(o[1],p[0]),e(-p[1],o[0])),-c[2]),n(t(e(o[1],c[0]),e(-c[1],o[0])),p[2]))),f[3]),n(t(n(t(e(c[1],f[0]),e(-f[1],c[0])),o[2]),t(n(t(e(o[1],f[0]),e(-f[1],o[0])),-c[2]),n(t(e(o[1],c[0]),e(-c[1],o[0])),f[2]))),-p[3]))),t(t(n(t(n(t(e(c[1],p[0]),e(-p[1],c[0])),s[2]),t(n(t(e(s[1],p[0]),e(-p[1],s[0])),-c[2]),n(t(e(s[1],c[0]),e(-c[1],s[0])),p[2]))),o[3]),n(t(n(t(e(c[1],p[0]),e(-p[1],c[0])),o[2]),t(n(t(e(o[1],p[0]),e(-p[1],o[0])),-c[2]),n(t(e(o[1],c[0]),e(-c[1],o[0])),p[2]))),-s[3])),t(n(t(n(t(e(s[1],p[0]),e(-p[1],s[0])),o[2]),t(n(t(e(o[1],p[0]),e(-p[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),p[2]))),c[3]),n(t(n(t(e(s[1],c[0]),e(-c[1],s[0])),o[2]),t(n(t(e(o[1],c[0]),e(-c[1],o[0])),-s[2]),n(t(e(o[1],s[0]),e(-s[1],o[0])),c[2]))),-p[3])))),C=r(g,F);return C[C.length-1]}}function vr(t){var e=t===3?Nu:t===4?Cu:ku;return e(Ru,zu,mu,Ou)}var Yu=vr(3),Xu=vr(4),Se=[function(){return 0},function(){return 0},function(e,n){return n[0]-e[0]},function(e,n,r){var i=(e[1]-r[1])*(n[0]-r[0]),o=(e[0]-r[0])*(n[1]-r[1]),s=i-o,c;if(i>0){if(o<=0)return s;c=i+o}else if(i<0){if(o>=0)return s;c=-(i+o)}else return s;var f=Vu*c;return s>=f||s<=-f?s:Yu(e,n,r)},function(e,n,r,i){var o=e[0]-i[0],s=n[0]-i[0],c=r[0]-i[0],f=e[1]-i[1],p=n[1]-i[1],g=r[1]-i[1],F=e[2]-i[2],C=n[2]-i[2],N=r[2]-i[2],m=s*g,V=c*p,Y=c*f,et=o*g,W=o*p,H=s*f,j=F*(m-V)+C*(Y-et)+N*(W-H),K=(Math.abs(m)+Math.abs(V))*Math.abs(F)+(Math.abs(Y)+Math.abs(et))*Math.abs(C)+(Math.abs(W)+Math.abs(H))*Math.abs(N),tt=qu*K;return j>tt||-j>tt?j:Xu(e,n,r,i)}];function Hu(t){var e=Se[t.length];return e||(e=Se[t.length]=vr(t.length)),e.apply(void 0,t)}function Zu(t,e,n,r,i,o,s){return function(f,p,g,F,C){switch(arguments.length){case 0:case 1:return 0;case 2:return r(f,p);case 3:return i(f,p,g);case 4:return o(f,p,g,F);case 5:return s(f,p,g,F,C)}for(var N=new Array(arguments.length),m=0;m<arguments.length;++m)N[m]=arguments[m];return t(N)}}function $u(){for(;Se.length<=qi;)Se.push(vr(Se.length));wn.exports=Zu.apply(void 0,[Hu].concat(Se));for(var t=0;t<=qi;++t)wn.exports[t]=Se[t]}$u()});var Hi=xt((h1,Xi)=>{"use strict";var dr=Qe(),ye=xn()[3],Mn=0,Ni=1,yn=2;Xi.exports=ju;function ki(t,e,n,r,i){this.a=t,this.b=e,this.idx=n,this.lowerIds=r,this.upperIds=i}function Ke(t,e,n,r){this.a=t,this.b=e,this.type=n,this.idx=r}function Wu(t,e){var n=t.a[0]-e.a[0]||t.a[1]-e.a[1]||t.type-e.type;return n||t.type!==Mn&&(n=ye(t.a,t.b,e.b),n)?n:t.idx-e.idx}function Ci(t,e){return ye(t.a,t.b,e)}function Qu(t,e,n,r,i){for(var o=dr.lt(e,r,Ci),s=dr.gt(e,r,Ci),c=o;c<s;++c){for(var f=e[c],p=f.lowerIds,F=p.length;F>1&&ye(n[p[F-2]],n[p[F-1]],r)>0;)t.push([p[F-1],p[F-2],i]),F-=1;p.length=F,p.push(i);for(var g=f.upperIds,F=g.length;F>1&&ye(n[g[F-2]],n[g[F-1]],r)<0;)t.push([g[F-2],g[F-1],i]),F-=1;g.length=F,g.push(i)}}function Yi(t,e){var n;return t.a[0]<e.a[0]?n=ye(t.a,t.b,e.a):n=ye(e.b,e.a,t.a),n||(e.b[0]<t.b[0]?n=ye(t.a,t.b,e.b):n=ye(e.b,e.a,t.b),n||t.idx-e.idx)}function Ku(t,e,n){var r=dr.le(t,n,Yi),i=t[r],o=i.upperIds,s=o[o.length-1];i.upperIds=[s],t.splice(r+1,0,new ki(n.a,n.b,n.idx,[s],o))}function Ju(t,e,n){var r=n.a;n.a=n.b,n.b=r;var i=dr.eq(t,n,Yi),o=t[i],s=t[i-1];s.upperIds=o.upperIds,t.splice(i,1)}function ju(t,e){for(var n=t.length,r=e.length,i=[],o=0;o<n;++o)i.push(new Ke(t[o],null,Mn,o));for(var o=0;o<r;++o){var s=e[o],c=t[s[0]],f=t[s[1]];c[0]<f[0]?i.push(new Ke(c,f,yn,o),new Ke(f,c,Ni,o)):c[0]>f[0]&&i.push(new Ke(f,c,yn,o),new Ke(c,f,Ni,o))}i.sort(Wu);for(var p=i[0].a[0]-(1+Math.abs(i[0].a[0]))*Math.pow(2,-52),g=[new ki([p,1],[p,0],-1,[],[],[],[])],F=[],o=0,C=i.length;o<C;++o){var N=i[o],m=N.type;m===Mn?Qu(F,g,t,N.a,N.idx):m===yn?Ku(g,t,N):Ju(g,t,N)}return F}});var Wi=xt((p1,$i)=>{"use strict";var t0=Qe();$i.exports=e0;function Zi(t,e){this.stars=t,this.edges=e}var Be=Zi.prototype;function bn(t,e,n){for(var r=1,i=t.length;r<i;r+=2)if(t[r-1]===e&&t[r]===n){t[r-1]=t[i-2],t[r]=t[i-1],t.length=i-2;return}}Be.isConstraint=function(){var t=[0,0];function e(n,r){return n[0]-r[0]||n[1]-r[1]}return function(n,r){return t[0]=Math.min(n,r),t[1]=Math.max(n,r),t0.eq(this.edges,t,e)>=0}}();Be.removeTriangle=function(t,e,n){var r=this.stars;bn(r[t],e,n),bn(r[e],n,t),bn(r[n],t,e)};Be.addTriangle=function(t,e,n){var r=this.stars;r[t].push(e,n),r[e].push(n,t),r[n].push(t,e)};Be.opposite=function(t,e){for(var n=this.stars[e],r=1,i=n.length;r<i;r+=2)if(n[r]===t)return n[r-1];return-1};Be.flip=function(t,e){var n=this.opposite(t,e),r=this.opposite(e,t);this.removeTriangle(t,e,n),this.removeTriangle(e,t,r),this.addTriangle(t,r,n),this.addTriangle(e,n,r)};Be.edges=function(){for(var t=this.stars,e=[],n=0,r=t.length;n<r;++n)for(var i=t[n],o=0,s=i.length;o<s;o+=2)e.push([i[o],i[o+1]]);return e};Be.cells=function(){for(var t=this.stars,e=[],n=0,r=t.length;n<r;++n)for(var i=t[n],o=0,s=i.length;o<s;o+=2){var c=i[o],f=i[o+1];n<Math.min(c,f)&&e.push([n,c,f])}return e};function e0(t,e){for(var n=new Array(t),r=0;r<t;++r)n[r]=[];return new Zi(n,e)}});var Ji=xt((v1,Tn)=>{"use strict";var r0=hr(),n0=pn(),i0=gn(),o0=dn(),Qi=6;function Ki(t){var e=t===3?c0:t===4?f0:t===5?l0:h0;return e(n0,i0,r0,o0)}function a0(){return 0}function s0(){return 0}function u0(){return 0}function c0(t,e,n,r){function i(o,s,c){var f=n(o[0],o[0]),p=r(f,s[0]),g=r(f,c[0]),F=n(s[0],s[0]),C=r(F,o[0]),N=r(F,c[0]),m=n(c[0],c[0]),V=r(m,o[0]),Y=r(m,s[0]),et=t(e(Y,N),e(C,p)),W=e(V,g),H=e(et,W);return H[H.length-1]}return i}function f0(t,e,n,r){function i(o,s,c,f){var p=t(n(o[0],o[0]),n(o[1],o[1])),g=r(p,s[0]),F=r(p,c[0]),C=r(p,f[0]),N=t(n(s[0],s[0]),n(s[1],s[1])),m=r(N,o[0]),V=r(N,c[0]),Y=r(N,f[0]),et=t(n(c[0],c[0]),n(c[1],c[1])),W=r(et,o[0]),H=r(et,s[0]),j=r(et,f[0]),K=t(n(f[0],f[0]),n(f[1],f[1])),tt=r(K,o[0]),ut=r(K,s[0]),J=r(K,c[0]),rt=t(t(r(e(J,j),s[1]),t(r(e(ut,Y),-c[1]),r(e(H,V),f[1]))),t(r(e(ut,Y),o[1]),t(r(e(tt,C),-s[1]),r(e(m,g),f[1])))),D=t(t(r(e(J,j),o[1]),t(r(e(tt,C),-c[1]),r(e(W,F),f[1]))),t(r(e(H,V),o[1]),t(r(e(W,F),-s[1]),r(e(m,g),c[1])))),a=e(rt,D);return a[a.length-1]}return i}function l0(t,e,n,r){function i(o,s,c,f,p){var g=t(n(o[0],o[0]),t(n(o[1],o[1]),n(o[2],o[2]))),F=r(g,s[0]),C=r(g,c[0]),N=r(g,f[0]),m=r(g,p[0]),V=t(n(s[0],s[0]),t(n(s[1],s[1]),n(s[2],s[2]))),Y=r(V,o[0]),et=r(V,c[0]),W=r(V,f[0]),H=r(V,p[0]),j=t(n(c[0],c[0]),t(n(c[1],c[1]),n(c[2],c[2]))),K=r(j,o[0]),tt=r(j,s[0]),ut=r(j,f[0]),J=r(j,p[0]),rt=t(n(f[0],f[0]),t(n(f[1],f[1]),n(f[2],f[2]))),D=r(rt,o[0]),a=r(rt,s[0]),v=r(rt,c[0]),T=r(rt,p[0]),M=t(n(p[0],p[0]),t(n(p[1],p[1]),n(p[2],p[2]))),S=r(M,o[0]),E=r(M,s[0]),R=r(M,c[0]),P=r(M,f[0]),h=t(t(t(r(t(r(e(P,T),c[1]),t(r(e(R,J),-f[1]),r(e(v,ut),p[1]))),s[2]),t(r(t(r(e(P,T),s[1]),t(r(e(E,H),-f[1]),r(e(a,W),p[1]))),-c[2]),r(t(r(e(R,J),s[1]),t(r(e(E,H),-c[1]),r(e(tt,et),p[1]))),f[2]))),t(r(t(r(e(v,ut),s[1]),t(r(e(a,W),-c[1]),r(e(tt,et),f[1]))),-p[2]),t(r(t(r(e(P,T),s[1]),t(r(e(E,H),-f[1]),r(e(a,W),p[1]))),o[2]),r(t(r(e(P,T),o[1]),t(r(e(S,m),-f[1]),r(e(D,N),p[1]))),-s[2])))),t(t(r(t(r(e(E,H),o[1]),t(r(e(S,m),-s[1]),r(e(Y,F),p[1]))),f[2]),t(r(t(r(e(a,W),o[1]),t(r(e(D,N),-s[1]),r(e(Y,F),f[1]))),-p[2]),r(t(r(e(v,ut),s[1]),t(r(e(a,W),-c[1]),r(e(tt,et),f[1]))),o[2]))),t(r(t(r(e(v,ut),o[1]),t(r(e(D,N),-c[1]),r(e(K,C),f[1]))),-s[2]),t(r(t(r(e(a,W),o[1]),t(r(e(D,N),-s[1]),r(e(Y,F),f[1]))),c[2]),r(t(r(e(tt,et),o[1]),t(r(e(K,C),-s[1]),r(e(Y,F),c[1]))),-f[2]))))),G=t(t(t(r(t(r(e(P,T),c[1]),t(r(e(R,J),-f[1]),r(e(v,ut),p[1]))),o[2]),r(t(r(e(P,T),o[1]),t(r(e(S,m),-f[1]),r(e(D,N),p[1]))),-c[2])),t(r(t(r(e(R,J),o[1]),t(r(e(S,m),-c[1]),r(e(K,C),p[1]))),f[2]),r(t(r(e(v,ut),o[1]),t(r(e(D,N),-c[1]),r(e(K,C),f[1]))),-p[2]))),t(t(r(t(r(e(R,J),s[1]),t(r(e(E,H),-c[1]),r(e(tt,et),p[1]))),o[2]),r(t(r(e(R,J),o[1]),t(r(e(S,m),-c[1]),r(e(K,C),p[1]))),-s[2])),t(r(t(r(e(E,H),o[1]),t(r(e(S,m),-s[1]),r(e(Y,F),p[1]))),c[2]),r(t(r(e(tt,et),o[1]),t(r(e(K,C),-s[1]),r(e(Y,F),c[1]))),-p[2])))),ot=e(h,G);return ot[ot.length-1]}return i}function h0(t,e,n,r){function i(o,s,c,f,p,g){var F=t(t(n(o[0],o[0]),n(o[1],o[1])),t(n(o[2],o[2]),n(o[3],o[3]))),C=r(F,s[0]),N=r(F,c[0]),m=r(F,f[0]),V=r(F,p[0]),Y=r(F,g[0]),et=t(t(n(s[0],s[0]),n(s[1],s[1])),t(n(s[2],s[2]),n(s[3],s[3]))),W=r(et,o[0]),H=r(et,c[0]),j=r(et,f[0]),K=r(et,p[0]),tt=r(et,g[0]),ut=t(t(n(c[0],c[0]),n(c[1],c[1])),t(n(c[2],c[2]),n(c[3],c[3]))),J=r(ut,o[0]),rt=r(ut,s[0]),D=r(ut,f[0]),a=r(ut,p[0]),v=r(ut,g[0]),T=t(t(n(f[0],f[0]),n(f[1],f[1])),t(n(f[2],f[2]),n(f[3],f[3]))),M=r(T,o[0]),S=r(T,s[0]),E=r(T,c[0]),R=r(T,p[0]),P=r(T,g[0]),h=t(t(n(p[0],p[0]),n(p[1],p[1])),t(n(p[2],p[2]),n(p[3],p[3]))),G=r(h,o[0]),ot=r(h,s[0]),at=r(h,c[0]),st=r(h,f[0]),ct=r(h,g[0]),yt=t(t(n(g[0],g[0]),n(g[1],g[1])),t(n(g[2],g[2]),n(g[3],g[3]))),pt=r(yt,o[0]),k=r(yt,s[0]),Z=r(yt,c[0]),U=r(yt,f[0]),l=r(yt,p[0]),b=t(t(t(r(t(t(r(t(r(e(l,ct),f[1]),t(r(e(U,P),-p[1]),r(e(st,R),g[1]))),c[2]),r(t(r(e(l,ct),c[1]),t(r(e(Z,v),-p[1]),r(e(at,a),g[1]))),-f[2])),t(r(t(r(e(U,P),c[1]),t(r(e(Z,v),-f[1]),r(e(E,D),g[1]))),p[2]),r(t(r(e(st,R),c[1]),t(r(e(at,a),-f[1]),r(e(E,D),p[1]))),-g[2]))),s[3]),t(r(t(t(r(t(r(e(l,ct),f[1]),t(r(e(U,P),-p[1]),r(e(st,R),g[1]))),s[2]),r(t(r(e(l,ct),s[1]),t(r(e(k,tt),-p[1]),r(e(ot,K),g[1]))),-f[2])),t(r(t(r(e(U,P),s[1]),t(r(e(k,tt),-f[1]),r(e(S,j),g[1]))),p[2]),r(t(r(e(st,R),s[1]),t(r(e(ot,K),-f[1]),r(e(S,j),p[1]))),-g[2]))),-c[3]),r(t(t(r(t(r(e(l,ct),c[1]),t(r(e(Z,v),-p[1]),r(e(at,a),g[1]))),s[2]),r(t(r(e(l,ct),s[1]),t(r(e(k,tt),-p[1]),r(e(ot,K),g[1]))),-c[2])),t(r(t(r(e(Z,v),s[1]),t(r(e(k,tt),-c[1]),r(e(rt,H),g[1]))),p[2]),r(t(r(e(at,a),s[1]),t(r(e(ot,K),-c[1]),r(e(rt,H),p[1]))),-g[2]))),f[3]))),t(t(r(t(t(r(t(r(e(U,P),c[1]),t(r(e(Z,v),-f[1]),r(e(E,D),g[1]))),s[2]),r(t(r(e(U,P),s[1]),t(r(e(k,tt),-f[1]),r(e(S,j),g[1]))),-c[2])),t(r(t(r(e(Z,v),s[1]),t(r(e(k,tt),-c[1]),r(e(rt,H),g[1]))),f[2]),r(t(r(e(E,D),s[1]),t(r(e(S,j),-c[1]),r(e(rt,H),f[1]))),-g[2]))),-p[3]),r(t(t(r(t(r(e(st,R),c[1]),t(r(e(at,a),-f[1]),r(e(E,D),p[1]))),s[2]),r(t(r(e(st,R),s[1]),t(r(e(ot,K),-f[1]),r(e(S,j),p[1]))),-c[2])),t(r(t(r(e(at,a),s[1]),t(r(e(ot,K),-c[1]),r(e(rt,H),p[1]))),f[2]),r(t(r(e(E,D),s[1]),t(r(e(S,j),-c[1]),r(e(rt,H),f[1]))),-p[2]))),g[3])),t(r(t(t(r(t(r(e(l,ct),f[1]),t(r(e(U,P),-p[1]),r(e(st,R),g[1]))),s[2]),r(t(r(e(l,ct),s[1]),t(r(e(k,tt),-p[1]),r(e(ot,K),g[1]))),-f[2])),t(r(t(r(e(U,P),s[1]),t(r(e(k,tt),-f[1]),r(e(S,j),g[1]))),p[2]),r(t(r(e(st,R),s[1]),t(r(e(ot,K),-f[1]),r(e(S,j),p[1]))),-g[2]))),o[3]),r(t(t(r(t(r(e(l,ct),f[1]),t(r(e(U,P),-p[1]),r(e(st,R),g[1]))),o[2]),r(t(r(e(l,ct),o[1]),t(r(e(pt,Y),-p[1]),r(e(G,V),g[1]))),-f[2])),t(r(t(r(e(U,P),o[1]),t(r(e(pt,Y),-f[1]),r(e(M,m),g[1]))),p[2]),r(t(r(e(st,R),o[1]),t(r(e(G,V),-f[1]),r(e(M,m),p[1]))),-g[2]))),-s[3])))),t(t(t(r(t(t(r(t(r(e(l,ct),s[1]),t(r(e(k,tt),-p[1]),r(e(ot,K),g[1]))),o[2]),r(t(r(e(l,ct),o[1]),t(r(e(pt,Y),-p[1]),r(e(G,V),g[1]))),-s[2])),t(r(t(r(e(k,tt),o[1]),t(r(e(pt,Y),-s[1]),r(e(W,C),g[1]))),p[2]),r(t(r(e(ot,K),o[1]),t(r(e(G,V),-s[1]),r(e(W,C),p[1]))),-g[2]))),f[3]),r(t(t(r(t(r(e(U,P),s[1]),t(r(e(k,tt),-f[1]),r(e(S,j),g[1]))),o[2]),r(t(r(e(U,P),o[1]),t(r(e(pt,Y),-f[1]),r(e(M,m),g[1]))),-s[2])),t(r(t(r(e(k,tt),o[1]),t(r(e(pt,Y),-s[1]),r(e(W,C),g[1]))),f[2]),r(t(r(e(S,j),o[1]),t(r(e(M,m),-s[1]),r(e(W,C),f[1]))),-g[2]))),-p[3])),t(r(t(t(r(t(r(e(st,R),s[1]),t(r(e(ot,K),-f[1]),r(e(S,j),p[1]))),o[2]),r(t(r(e(st,R),o[1]),t(r(e(G,V),-f[1]),r(e(M,m),p[1]))),-s[2])),t(r(t(r(e(ot,K),o[1]),t(r(e(G,V),-s[1]),r(e(W,C),p[1]))),f[2]),r(t(r(e(S,j),o[1]),t(r(e(M,m),-s[1]),r(e(W,C),f[1]))),-p[2]))),g[3]),r(t(t(r(t(r(e(U,P),c[1]),t(r(e(Z,v),-f[1]),r(e(E,D),g[1]))),s[2]),r(t(r(e(U,P),s[1]),t(r(e(k,tt),-f[1]),r(e(S,j),g[1]))),-c[2])),t(r(t(r(e(Z,v),s[1]),t(r(e(k,tt),-c[1]),r(e(rt,H),g[1]))),f[2]),r(t(r(e(E,D),s[1]),t(r(e(S,j),-c[1]),r(e(rt,H),f[1]))),-g[2]))),o[3]))),t(t(r(t(t(r(t(r(e(U,P),c[1]),t(r(e(Z,v),-f[1]),r(e(E,D),g[1]))),o[2]),r(t(r(e(U,P),o[1]),t(r(e(pt,Y),-f[1]),r(e(M,m),g[1]))),-c[2])),t(r(t(r(e(Z,v),o[1]),t(r(e(pt,Y),-c[1]),r(e(J,N),g[1]))),f[2]),r(t(r(e(E,D),o[1]),t(r(e(M,m),-c[1]),r(e(J,N),f[1]))),-g[2]))),-s[3]),r(t(t(r(t(r(e(U,P),s[1]),t(r(e(k,tt),-f[1]),r(e(S,j),g[1]))),o[2]),r(t(r(e(U,P),o[1]),t(r(e(pt,Y),-f[1]),r(e(M,m),g[1]))),-s[2])),t(r(t(r(e(k,tt),o[1]),t(r(e(pt,Y),-s[1]),r(e(W,C),g[1]))),f[2]),r(t(r(e(S,j),o[1]),t(r(e(M,m),-s[1]),r(e(W,C),f[1]))),-g[2]))),c[3])),t(r(t(t(r(t(r(e(Z,v),s[1]),t(r(e(k,tt),-c[1]),r(e(rt,H),g[1]))),o[2]),r(t(r(e(Z,v),o[1]),t(r(e(pt,Y),-c[1]),r(e(J,N),g[1]))),-s[2])),t(r(t(r(e(k,tt),o[1]),t(r(e(pt,Y),-s[1]),r(e(W,C),g[1]))),c[2]),r(t(r(e(rt,H),o[1]),t(r(e(J,N),-s[1]),r(e(W,C),c[1]))),-g[2]))),-f[3]),r(t(t(r(t(r(e(E,D),s[1]),t(r(e(S,j),-c[1]),r(e(rt,H),f[1]))),o[2]),r(t(r(e(E,D),o[1]),t(r(e(M,m),-c[1]),r(e(J,N),f[1]))),-s[2])),t(r(t(r(e(S,j),o[1]),t(r(e(M,m),-s[1]),r(e(W,C),f[1]))),c[2]),r(t(r(e(rt,H),o[1]),t(r(e(J,N),-s[1]),r(e(W,C),c[1]))),-f[2]))),g[3]))))),w=t(t(t(r(t(t(r(t(r(e(l,ct),f[1]),t(r(e(U,P),-p[1]),r(e(st,R),g[1]))),c[2]),r(t(r(e(l,ct),c[1]),t(r(e(Z,v),-p[1]),r(e(at,a),g[1]))),-f[2])),t(r(t(r(e(U,P),c[1]),t(r(e(Z,v),-f[1]),r(e(E,D),g[1]))),p[2]),r(t(r(e(st,R),c[1]),t(r(e(at,a),-f[1]),r(e(E,D),p[1]))),-g[2]))),o[3]),t(r(t(t(r(t(r(e(l,ct),f[1]),t(r(e(U,P),-p[1]),r(e(st,R),g[1]))),o[2]),r(t(r(e(l,ct),o[1]),t(r(e(pt,Y),-p[1]),r(e(G,V),g[1]))),-f[2])),t(r(t(r(e(U,P),o[1]),t(r(e(pt,Y),-f[1]),r(e(M,m),g[1]))),p[2]),r(t(r(e(st,R),o[1]),t(r(e(G,V),-f[1]),r(e(M,m),p[1]))),-g[2]))),-c[3]),r(t(t(r(t(r(e(l,ct),c[1]),t(r(e(Z,v),-p[1]),r(e(at,a),g[1]))),o[2]),r(t(r(e(l,ct),o[1]),t(r(e(pt,Y),-p[1]),r(e(G,V),g[1]))),-c[2])),t(r(t(r(e(Z,v),o[1]),t(r(e(pt,Y),-c[1]),r(e(J,N),g[1]))),p[2]),r(t(r(e(at,a),o[1]),t(r(e(G,V),-c[1]),r(e(J,N),p[1]))),-g[2]))),f[3]))),t(t(r(t(t(r(t(r(e(U,P),c[1]),t(r(e(Z,v),-f[1]),r(e(E,D),g[1]))),o[2]),r(t(r(e(U,P),o[1]),t(r(e(pt,Y),-f[1]),r(e(M,m),g[1]))),-c[2])),t(r(t(r(e(Z,v),o[1]),t(r(e(pt,Y),-c[1]),r(e(J,N),g[1]))),f[2]),r(t(r(e(E,D),o[1]),t(r(e(M,m),-c[1]),r(e(J,N),f[1]))),-g[2]))),-p[3]),r(t(t(r(t(r(e(st,R),c[1]),t(r(e(at,a),-f[1]),r(e(E,D),p[1]))),o[2]),r(t(r(e(st,R),o[1]),t(r(e(G,V),-f[1]),r(e(M,m),p[1]))),-c[2])),t(r(t(r(e(at,a),o[1]),t(r(e(G,V),-c[1]),r(e(J,N),p[1]))),f[2]),r(t(r(e(E,D),o[1]),t(r(e(M,m),-c[1]),r(e(J,N),f[1]))),-p[2]))),g[3])),t(r(t(t(r(t(r(e(l,ct),c[1]),t(r(e(Z,v),-p[1]),r(e(at,a),g[1]))),s[2]),r(t(r(e(l,ct),s[1]),t(r(e(k,tt),-p[1]),r(e(ot,K),g[1]))),-c[2])),t(r(t(r(e(Z,v),s[1]),t(r(e(k,tt),-c[1]),r(e(rt,H),g[1]))),p[2]),r(t(r(e(at,a),s[1]),t(r(e(ot,K),-c[1]),r(e(rt,H),p[1]))),-g[2]))),o[3]),r(t(t(r(t(r(e(l,ct),c[1]),t(r(e(Z,v),-p[1]),r(e(at,a),g[1]))),o[2]),r(t(r(e(l,ct),o[1]),t(r(e(pt,Y),-p[1]),r(e(G,V),g[1]))),-c[2])),t(r(t(r(e(Z,v),o[1]),t(r(e(pt,Y),-c[1]),r(e(J,N),g[1]))),p[2]),r(t(r(e(at,a),o[1]),t(r(e(G,V),-c[1]),r(e(J,N),p[1]))),-g[2]))),-s[3])))),t(t(t(r(t(t(r(t(r(e(l,ct),s[1]),t(r(e(k,tt),-p[1]),r(e(ot,K),g[1]))),o[2]),r(t(r(e(l,ct),o[1]),t(r(e(pt,Y),-p[1]),r(e(G,V),g[1]))),-s[2])),t(r(t(r(e(k,tt),o[1]),t(r(e(pt,Y),-s[1]),r(e(W,C),g[1]))),p[2]),r(t(r(e(ot,K),o[1]),t(r(e(G,V),-s[1]),r(e(W,C),p[1]))),-g[2]))),c[3]),r(t(t(r(t(r(e(Z,v),s[1]),t(r(e(k,tt),-c[1]),r(e(rt,H),g[1]))),o[2]),r(t(r(e(Z,v),o[1]),t(r(e(pt,Y),-c[1]),r(e(J,N),g[1]))),-s[2])),t(r(t(r(e(k,tt),o[1]),t(r(e(pt,Y),-s[1]),r(e(W,C),g[1]))),c[2]),r(t(r(e(rt,H),o[1]),t(r(e(J,N),-s[1]),r(e(W,C),c[1]))),-g[2]))),-p[3])),t(r(t(t(r(t(r(e(at,a),s[1]),t(r(e(ot,K),-c[1]),r(e(rt,H),p[1]))),o[2]),r(t(r(e(at,a),o[1]),t(r(e(G,V),-c[1]),r(e(J,N),p[1]))),-s[2])),t(r(t(r(e(ot,K),o[1]),t(r(e(G,V),-s[1]),r(e(W,C),p[1]))),c[2]),r(t(r(e(rt,H),o[1]),t(r(e(J,N),-s[1]),r(e(W,C),c[1]))),-p[2]))),g[3]),r(t(t(r(t(r(e(st,R),c[1]),t(r(e(at,a),-f[1]),r(e(E,D),p[1]))),s[2]),r(t(r(e(st,R),s[1]),t(r(e(ot,K),-f[1]),r(e(S,j),p[1]))),-c[2])),t(r(t(r(e(at,a),s[1]),t(r(e(ot,K),-c[1]),r(e(rt,H),p[1]))),f[2]),r(t(r(e(E,D),s[1]),t(r(e(S,j),-c[1]),r(e(rt,H),f[1]))),-p[2]))),o[3]))),t(t(r(t(t(r(t(r(e(st,R),c[1]),t(r(e(at,a),-f[1]),r(e(E,D),p[1]))),o[2]),r(t(r(e(st,R),o[1]),t(r(e(G,V),-f[1]),r(e(M,m),p[1]))),-c[2])),t(r(t(r(e(at,a),o[1]),t(r(e(G,V),-c[1]),r(e(J,N),p[1]))),f[2]),r(t(r(e(E,D),o[1]),t(r(e(M,m),-c[1]),r(e(J,N),f[1]))),-p[2]))),-s[3]),r(t(t(r(t(r(e(st,R),s[1]),t(r(e(ot,K),-f[1]),r(e(S,j),p[1]))),o[2]),r(t(r(e(st,R),o[1]),t(r(e(G,V),-f[1]),r(e(M,m),p[1]))),-s[2])),t(r(t(r(e(ot,K),o[1]),t(r(e(G,V),-s[1]),r(e(W,C),p[1]))),f[2]),r(t(r(e(S,j),o[1]),t(r(e(M,m),-s[1]),r(e(W,C),f[1]))),-p[2]))),c[3])),t(r(t(t(r(t(r(e(at,a),s[1]),t(r(e(ot,K),-c[1]),r(e(rt,H),p[1]))),o[2]),r(t(r(e(at,a),o[1]),t(r(e(G,V),-c[1]),r(e(J,N),p[1]))),-s[2])),t(r(t(r(e(ot,K),o[1]),t(r(e(G,V),-s[1]),r(e(W,C),p[1]))),c[2]),r(t(r(e(rt,H),o[1]),t(r(e(J,N),-s[1]),r(e(W,C),c[1]))),-p[2]))),-f[3]),r(t(t(r(t(r(e(E,D),s[1]),t(r(e(S,j),-c[1]),r(e(rt,H),f[1]))),o[2]),r(t(r(e(E,D),o[1]),t(r(e(M,m),-c[1]),r(e(J,N),f[1]))),-s[2])),t(r(t(r(e(S,j),o[1]),t(r(e(M,m),-s[1]),r(e(W,C),f[1]))),c[2]),r(t(r(e(rt,H),o[1]),t(r(e(J,N),-s[1]),r(e(W,C),c[1]))),-f[2]))),p[3]))))),A=e(b,w);return A[A.length-1]}return i}var Pe=[a0,s0,u0];function p0(t){var e=Pe[t.length];return e||(e=Pe[t.length]=Ki(t.length)),e.apply(void 0,t)}function v0(t,e,n,r,i,o,s,c){function f(p,g,F,C,N,m){switch(arguments.length){case 0:case 1:return 0;case 2:return r(p,g);case 3:return i(p,g,F);case 4:return o(p,g,F,C);case 5:return s(p,g,F,C,N);case 6:return c(p,g,F,C,N,m)}for(var V=new Array(arguments.length),Y=0;Y<arguments.length;++Y)V[Y]=arguments[Y];return t(V)}return f}function d0(){for(;Pe.length<=Qi;)Pe.push(Ki(Pe.length));Tn.exports=v0.apply(void 0,[p0].concat(Pe));for(var t=0;t<=Qi;++t)Tn.exports[t]=Pe[t]}d0()});var to=xt((g1,ji)=>{"use strict";var _n=Ji()[4],d1=Qe();ji.exports=g0;function gr(t,e,n,r,i,o){var s=e.opposite(r,i);if(!(s<0)){if(i<r){var c=r;r=i,i=c,c=o,o=s,s=c}e.isConstraint(r,i)||_n(t[r],t[i],t[o],t[s])<0&&n.push(r,i)}}function g0(t,e){for(var n=[],r=t.length,i=e.stars,o=0;o<r;++o)for(var s=i[o],c=1;c<s.length;c+=2){var f=s[c];if(!(f<o)&&!e.isConstraint(o,f)){for(var p=s[c-1],g=-1,F=1;F<s.length;F+=2)if(s[F-1]===f){g=s[F];break}g<0||_n(t[o],t[f],t[p],t[g])<0&&n.push(o,f)}}for(;n.length>0;){for(var f=n.pop(),o=n.pop(),p=-1,g=-1,s=i[o],C=1;C<s.length;C+=2){var N=s[C-1],m=s[C];N===f?g=m:m===f&&(p=N)}p<0||g<0||_n(t[o],t[f],t[p],t[g])>=0||(e.flip(o,f),gr(t,e,n,p,o,g),gr(t,e,n,o,g,p),gr(t,e,n,g,f,p),gr(t,e,n,f,p,g))}}});var io=xt((w1,no)=>{"use strict";var w0=Qe();no.exports=b0;function eo(t,e,n,r,i,o,s){this.cells=t,this.neighbor=e,this.flags=r,this.constraint=n,this.active=i,this.next=o,this.boundary=s}var x0=eo.prototype;function ro(t,e){return t[0]-e[0]||t[1]-e[1]||t[2]-e[2]}x0.locate=function(){var t=[0,0,0];return function(e,n,r){var i=e,o=n,s=r;return n<r?n<e&&(i=n,o=r,s=e):r<e&&(i=r,o=e,s=n),i<0?-1:(t[0]=i,t[1]=o,t[2]=s,w0.eq(this.cells,t,ro))}}();function y0(t,e){for(var n=t.cells(),r=n.length,i=0;i<r;++i){var o=n[i],s=o[0],c=o[1],f=o[2];c<f?c<s&&(o[0]=c,o[1]=f,o[2]=s):f<s&&(o[0]=f,o[1]=s,o[2]=c)}n.sort(ro);for(var p=new Array(r),i=0;i<p.length;++i)p[i]=0;var g=[],F=[],C=new Array(3*r),N=new Array(3*r),m=null;e&&(m=[]);for(var V=new eo(n,C,N,p,g,F,m),i=0;i<r;++i)for(var o=n[i],Y=0;Y<3;++Y){var s=o[Y],c=o[(Y+1)%3],et=C[3*i+Y]=V.locate(c,s,t.opposite(c,s)),W=N[3*i+Y]=t.isConstraint(s,c);et<0&&(W?F.push(i):(g.push(i),p[i]=1),e&&m.push([c,s,-1]))}return V}function M0(t,e,n){for(var r=0,i=0;i<t.length;++i)e[i]===n&&(t[r++]=t[i]);return t.length=r,t}function b0(t,e,n){var r=y0(t,n);if(e===0)return n?r.cells.concat(r.boundary):r.cells;for(var i=1,o=r.active,s=r.next,c=r.flags,f=r.cells,p=r.constraint,g=r.neighbor;o.length>0||s.length>0;){for(;o.length>0;){var F=o.pop();if(c[F]!==-i){c[F]=i;for(var C=f[F],N=0;N<3;++N){var m=g[3*F+N];m>=0&&c[m]===0&&(p[3*F+N]?s.push(m):(o.push(m),c[m]=i))}}}var V=s;s=o,o=V,s.length=0,i=-i}var Y=M0(f,c,e);return n?Y.concat(r.boundary):Y}});var ao=xt((x1,oo)=>{"use strict";var T0=Hi(),_0=Wi(),S0=to(),Sn=io();oo.exports=U0;function B0(t){return[Math.min(t[0],t[1]),Math.max(t[0],t[1])]}function P0(t,e){return t[0]-e[0]||t[1]-e[1]}function D0(t){return t.map(B0).sort(P0)}function wr(t,e,n){return e in t?t[e]:n}function U0(t,e,n){Array.isArray(e)?(n=n||{},e=e||[]):(n=e||{},e=[]);var r=!!wr(n,"delaunay",!0),i=!!wr(n,"interior",!0),o=!!wr(n,"exterior",!0),s=!!wr(n,"infinity",!1);if(!i&&!o||t.length===0)return[];var c=T0(t,e);if(r||i!==o||s){for(var f=_0(t.length,D0(e)),p=0;p<c.length;++p){var g=c[p];f.addTriangle(g[0],g[1],g[2])}return r&&S0(t,f),o?i?s?Sn(f,0,s):f.cells():Sn(f,1,s):Sn(f,-1)}else return c}});var co=xt((y1,uo)=>{"use strict";"use restrict";uo.exports=so;function so(t){this.roots=new Array(t),this.ranks=new Array(t);for(var e=0;e<t;++e)this.roots[e]=e,this.ranks[e]=0}var xr=so.prototype;Object.defineProperty(xr,"length",{get:function(){return this.roots.length}});xr.makeSet=function(){var t=this.roots.length;return this.roots.push(t),this.ranks.push(0),t};xr.find=function(t){for(var e=t,n=this.roots;n[t]!==t;)t=n[t];for(;n[e]!==t;){var r=n[e];n[e]=t,e=r}return t};xr.link=function(t,e){var n=this.find(t),r=this.find(e);if(n!==r){var i=this.ranks,o=this.roots,s=i[n],c=i[r];s<c?o[n]=r:c<s?o[r]=n:(o[r]=n,++i[n])}}});var je=xt(Nt=>{"use strict";"use restrict";var Bn=32;Nt.INT_BITS=Bn;Nt.INT_MAX=2147483647;Nt.INT_MIN=-1<<Bn-1;Nt.sign=function(t){return(t>0)-(t<0)};Nt.abs=function(t){var e=t>>Bn-1;return(t^e)-e};Nt.min=function(t,e){return e^(t^e)&-(t<e)};Nt.max=function(t,e){return t^(t^e)&-(t<e)};Nt.isPow2=function(t){return!(t&t-1)&&!!t};Nt.log2=function(t){var e,n;return e=(t>65535)<<4,t>>>=e,n=(t>255)<<3,t>>>=n,e|=n,n=(t>15)<<2,t>>>=n,e|=n,n=(t>3)<<1,t>>>=n,e|=n,e|t>>1};Nt.log10=function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0};Nt.popCount=function(t){return t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),(t+(t>>>4)&252645135)*16843009>>>24};function fo(t){var e=32;return t&=-t,t&&e--,t&65535&&(e-=16),t&16711935&&(e-=8),t&252645135&&(e-=4),t&858993459&&(e-=2),t&1431655765&&(e-=1),e}Nt.countTrailingZeros=fo;Nt.nextPow2=function(t){return t+=t===0,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1};Nt.prevPow2=function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)};Nt.parity=function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,t&=15,27030>>>t&1};var Je=new Array(256);(function(t){for(var e=0;e<256;++e){var n=e,r=e,i=7;for(n>>>=1;n;n>>>=1)r<<=1,r|=n&1,--i;t[e]=r<<i&255}})(Je);Nt.reverse=function(t){return Je[t&255]<<24|Je[t>>>8&255]<<16|Je[t>>>16&255]<<8|Je[t>>>24&255]};Nt.interleave2=function(t,e){return t&=65535,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t|e<<1};Nt.deinterleave2=function(t,e){return t=t>>>e&1431655765,t=(t|t>>>1)&858993459,t=(t|t>>>2)&252645135,t=(t|t>>>4)&16711935,t=(t|t>>>16)&65535,t<<16>>16};Nt.interleave3=function(t,e,n){return t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,t|=e<<1,n&=1023,n=(n|n<<16)&4278190335,n=(n|n<<8)&251719695,n=(n|n<<4)&3272356035,n=(n|n<<2)&1227133513,t|n<<2};Nt.deinterleave3=function(t,e){return t=t>>>e&1227133513,t=(t|t>>>2)&3272356035,t=(t|t>>>4)&251719695,t=(t|t>>>8)&4278190335,t=(t|t>>>16)&1023,t<<22>>22};Nt.nextCombination=function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>fo(t)+1}});var po=xt((b1,ho)=>{"use strict";function lo(t,e,n){var r=t[n]|0;if(r<=0)return[];var i=new Array(r),o;if(n===t.length-1)for(o=0;o<r;++o)i[o]=e;else for(o=0;o<r;++o)i[o]=lo(t,e,n+1);return i}function G0(t,e){var n,r;for(n=new Array(t),r=0;r<t;++r)n[r]=e;return n}function F0(t,e){switch(typeof e>"u"&&(e=0),typeof t){case"number":if(t>0)return G0(t|0,e);break;case"object":if(typeof t.length=="number")return lo(t,e,0);break}return[]}ho.exports=F0});var br=xt(At=>{"use strict";var yr=je(),te=po();globalThis.__TYPEDARRAY_POOL||(globalThis.__TYPEDARRAY_POOL={UINT8:te([32,0]),UINT16:te([32,0]),UINT32:te([32,0]),BIGUINT64:te([32,0]),INT8:te([32,0]),INT16:te([32,0]),INT32:te([32,0]),BIGINT64:te([32,0]),FLOAT:te([32,0]),DOUBLE:te([32,0]),DATA:te([32,0]),UINT8C:te([32,0])});var I0=typeof Uint8ClampedArray<"u",A0=typeof BigUint64Array<"u",E0=typeof BigInt64Array<"u",Qt=globalThis.__TYPEDARRAY_POOL;Qt.UINT8C||(Qt.UINT8C=te([32,0]));Qt.BIGUINT64||(Qt.BIGUINT64=te([32,0]));Qt.BIGINT64||(Qt.BIGINT64=te([32,0]));var Mr=Qt.DATA;At.free=function(e){if(Object.prototype.toString.call(e)!=="[object ArrayBuffer]"&&(e=e.buffer),!!e){var n=e.length||e.byteLength,r=yr.log2(n)|0;Mr[r].push(e)}};function vo(t){if(t){var e=t.length||t.byteLength,n=yr.log2(e);Mr[n].push(t)}}function L0(t){vo(t.buffer)}At.freeUint8=At.freeUint16=At.freeUint32=At.freeBigUint64=At.freeInt8=At.freeInt16=At.freeInt32=At.freeBigInt64=At.freeFloat32=At.freeFloat=At.freeFloat64=At.freeDouble=At.freeUint8Clamped=At.freeDataView=L0;At.freeArrayBuffer=vo;At.malloc=function(e,n){if(n===void 0||n==="arraybuffer")return ie(e);switch(n){case"uint8":return Pn(e);case"uint16":return go(e);case"uint32":return wo(e);case"int8":return xo(e);case"int16":return yo(e);case"int32":return Mo(e);case"float":case"float32":return bo(e);case"double":case"float64":return To(e);case"uint8_clamped":return _o(e);case"bigint64":return Bo(e);case"biguint64":return So(e);case"data":case"dataview":return Po(e);default:return null}return null};function ie(e){var e=yr.nextPow2(e),n=yr.log2(e),r=Mr[n];return r.length>0?r.pop():new ArrayBuffer(e)}At.mallocArrayBuffer=ie;function Pn(t){return new Uint8Array(ie(t),0,t)}At.mallocUint8=Pn;function go(t){return new Uint16Array(ie(2*t),0,t)}At.mallocUint16=go;function wo(t){return new Uint32Array(ie(4*t),0,t)}At.mallocUint32=wo;function xo(t){return new Int8Array(ie(t),0,t)}At.mallocInt8=xo;function yo(t){return new Int16Array(ie(2*t),0,t)}At.mallocInt16=yo;function Mo(t){return new Int32Array(ie(4*t),0,t)}At.mallocInt32=Mo;function bo(t){return new Float32Array(ie(4*t),0,t)}At.mallocFloat32=At.mallocFloat=bo;function To(t){return new Float64Array(ie(8*t),0,t)}At.mallocFloat64=At.mallocDouble=To;function _o(t){return I0?new Uint8ClampedArray(ie(t),0,t):Pn(t)}At.mallocUint8Clamped=_o;function So(t){return A0?new BigUint64Array(ie(8*t),0,t):null}At.mallocBigUint64=So;function Bo(t){return E0?new BigInt64Array(ie(8*t),0,t):null}At.mallocBigInt64=Bo;function Po(t){return new DataView(ie(t),0,t)}At.mallocDataView=Po;At.clearCache=function(){for(var e=0;e<32;++e)Qt.UINT8[e].length=0,Qt.UINT16[e].length=0,Qt.UINT32[e].length=0,Qt.INT8[e].length=0,Qt.INT16[e].length=0,Qt.INT32[e].length=0,Qt.FLOAT[e].length=0,Qt.DOUBLE[e].length=0,Qt.BIGUINT64[e].length=0,Qt.BIGINT64[e].length=0,Qt.UINT8C[e].length=0,Mr[e].length=0}});var Io=xt((_1,Fo)=>{"use strict";Fo.exports=z0;var _r=32;function z0(t,e){e<=4*_r?Sr(0,e-1,t):Br(0,e-1,t)}function Sr(t,e,n){for(var r=2*(t+1),i=t+1;i<=e;++i){for(var o=n[r++],s=n[r++],c=i,f=r-2;c-- >t;){var p=n[f-2],g=n[f-1];if(p<o)break;if(p===o&&g<s)break;n[f]=p,n[f+1]=g,f-=2}n[f]=o,n[f+1]=s}}function Do(t,e,n){t*=2,e*=2;var r=n[t],i=n[t+1];n[t]=n[e],n[t+1]=n[e+1],n[e]=r,n[e+1]=i}function Uo(t,e,n){t*=2,e*=2,n[t]=n[e],n[t+1]=n[e+1]}function R0(t,e,n,r){t*=2,e*=2,n*=2;var i=r[t],o=r[t+1];r[t]=r[e],r[t+1]=r[e+1],r[e]=r[n],r[e+1]=r[n+1],r[n]=i,r[n+1]=o}function Go(t,e,n,r,i){t*=2,e*=2,i[t]=i[e],i[e]=n,i[t+1]=i[e+1],i[e+1]=r}function ve(t,e,n){t*=2,e*=2;var r=n[t],i=n[e];return r<i?!1:r===i?n[t+1]>n[e+1]:!0}function Tr(t,e,n,r){t*=2;var i=r[t];return i<e?!0:i===e?r[t+1]<n:!1}function Br(t,e,n){var r=(e-t+1)/6|0,i=t+r,o=e-r,s=t+e>>1,c=s-r,f=s+r,p=i,g=c,F=s,C=f,N=o,m=t+1,V=e-1,Y=0;ve(p,g,n)&&(Y=p,p=g,g=Y),ve(C,N,n)&&(Y=C,C=N,N=Y),ve(p,F,n)&&(Y=p,p=F,F=Y),ve(g,F,n)&&(Y=g,g=F,F=Y),ve(p,C,n)&&(Y=p,p=C,C=Y),ve(F,C,n)&&(Y=F,F=C,C=Y),ve(g,N,n)&&(Y=g,g=N,N=Y),ve(g,F,n)&&(Y=g,g=F,F=Y),ve(C,N,n)&&(Y=C,C=N,N=Y);for(var et=n[2*g],W=n[2*g+1],H=n[2*C],j=n[2*C+1],K=2*p,tt=2*F,ut=2*N,J=2*i,rt=2*s,D=2*o,a=0;a<2;++a){var v=n[K+a],T=n[tt+a],M=n[ut+a];n[J+a]=v,n[rt+a]=T,n[D+a]=M}Uo(c,t,n),Uo(f,e,n);for(var S=m;S<=V;++S)if(Tr(S,et,W,n))S!==m&&Do(S,m,n),++m;else if(!Tr(S,H,j,n))for(;;)if(Tr(V,H,j,n)){Tr(V,et,W,n)?(R0(S,m,V,n),++m,--V):(Do(S,V,n),--V);break}else{if(--V<S)break;continue}Go(t,m-1,et,W,n),Go(e,V+1,H,j,n),m-2-t<=_r?Sr(t,m-2,n):Br(t,m-2,n),e-(V+2)<=_r?Sr(V+2,e,n):Br(V+2,e,n),V-m<=_r?Sr(m,V,n):Br(m,V,n)}});var Dn=xt((S1,Ao)=>{"use strict";Ao.exports={init:O0,sweepBipartite:V0,sweepComplete:q0,scanBipartite:N0,scanComplete:C0};var Yt=br(),m0=je(),Pr=Io(),ae=1<<28,Ue=1024,Kt=Yt.mallocInt32(Ue),de=Yt.mallocInt32(Ue),ge=Yt.mallocInt32(Ue),De=Yt.mallocInt32(Ue),me=Yt.mallocInt32(Ue),tr=Yt.mallocInt32(Ue),_t=Yt.mallocDouble(Ue*8);function O0(t){var e=m0.nextPow2(t);Kt.length<e&&(Yt.free(Kt),Kt=Yt.mallocInt32(e)),de.length<e&&(Yt.free(de),de=Yt.mallocInt32(e)),ge.length<e&&(Yt.free(ge),ge=Yt.mallocInt32(e)),De.length<e&&(Yt.free(De),De=Yt.mallocInt32(e)),me.length<e&&(Yt.free(me),me=Yt.mallocInt32(e)),tr.length<e&&(Yt.free(tr),tr=Yt.mallocInt32(e));var n=8*e;_t.length<n&&(Yt.free(_t),_t=Yt.mallocDouble(n))}function Oe(t,e,n,r){var i=e[r],o=t[n-1];t[i]=o,e[o]=i}function Ve(t,e,n,r){t[n]=r,e[r]=n}function V0(t,e,n,r,i,o,s,c,f,p){for(var g=0,F=2*t,C=t-1,N=F-1,m=n;m<r;++m){var V=o[m],Y=F*m;_t[g++]=i[Y+C],_t[g++]=-(V+1),_t[g++]=i[Y+N],_t[g++]=V}for(var m=s;m<c;++m){var V=p[m]+ae,et=F*m;_t[g++]=f[et+C],_t[g++]=-V,_t[g++]=f[et+N],_t[g++]=V}var W=g>>>1;Pr(_t,W);for(var H=0,j=0,m=0;m<W;++m){var K=_t[2*m+1]|0;if(K>=ae)K=K-ae|0,Oe(ge,De,j--,K);else if(K>=0)Oe(Kt,de,H--,K);else if(K<=-ae){K=-K-ae|0;for(var tt=0;tt<H;++tt){var ut=e(Kt[tt],K);if(ut!==void 0)return ut}Ve(ge,De,j++,K)}else{K=-K-1|0;for(var tt=0;tt<j;++tt){var ut=e(K,ge[tt]);if(ut!==void 0)return ut}Ve(Kt,de,H++,K)}}}function q0(t,e,n,r,i,o,s,c,f,p){for(var g=0,F=2*t,C=t-1,N=F-1,m=n;m<r;++m){var V=o[m]+1<<1,Y=F*m;_t[g++]=i[Y+C],_t[g++]=-V,_t[g++]=i[Y+N],_t[g++]=V}for(var m=s;m<c;++m){var V=p[m]+1<<1,et=F*m;_t[g++]=f[et+C],_t[g++]=-V|1,_t[g++]=f[et+N],_t[g++]=V|1}var W=g>>>1;Pr(_t,W);for(var H=0,j=0,K=0,m=0;m<W;++m){var tt=_t[2*m+1]|0,ut=tt&1;if(m<W-1&&tt>>1===_t[2*m+3]>>1&&(ut=2,m+=1),tt<0){for(var J=-(tt>>1)-1,rt=0;rt<K;++rt){var D=e(me[rt],J);if(D!==void 0)return D}if(ut!==0)for(var rt=0;rt<H;++rt){var D=e(Kt[rt],J);if(D!==void 0)return D}if(ut!==1)for(var rt=0;rt<j;++rt){var D=e(ge[rt],J);if(D!==void 0)return D}ut===0?Ve(Kt,de,H++,J):ut===1?Ve(ge,De,j++,J):ut===2&&Ve(me,tr,K++,J)}else{var J=(tt>>1)-1;ut===0?Oe(Kt,de,H--,J):ut===1?Oe(ge,De,j--,J):ut===2&&Oe(me,tr,K--,J)}}}function N0(t,e,n,r,i,o,s,c,f,p,g,F){var C=0,N=2*t,m=e,V=e+t,Y=1,et=1;r?et=ae:Y=ae;for(var W=i;W<o;++W){var H=W+Y,j=N*W;_t[C++]=s[j+m],_t[C++]=-H,_t[C++]=s[j+V],_t[C++]=H}for(var W=f;W<p;++W){var H=W+et,K=N*W;_t[C++]=g[K+m],_t[C++]=-H}var tt=C>>>1;Pr(_t,tt);for(var ut=0,W=0;W<tt;++W){var J=_t[2*W+1]|0;if(J<0){var H=-J,rt=!1;if(H>=ae?(rt=!r,H-=ae):(rt=!!r,H-=1),rt)Ve(Kt,de,ut++,H);else{var D=F[H],a=N*H,v=g[a+e+1],T=g[a+e+1+t];t:for(var M=0;M<ut;++M){var S=Kt[M],E=N*S;if(!(T<s[E+e+1]||s[E+e+1+t]<v)){for(var R=e+2;R<t;++R)if(g[a+R+t]<s[E+R]||s[E+R+t]<g[a+R])continue t;var P=c[S],h;if(r?h=n(D,P):h=n(P,D),h!==void 0)return h}}}}else Oe(Kt,de,ut--,J-Y)}}function C0(t,e,n,r,i,o,s,c,f,p,g){for(var F=0,C=2*t,N=e,m=e+t,V=r;V<i;++V){var Y=V+ae,et=C*V;_t[F++]=o[et+N],_t[F++]=-Y,_t[F++]=o[et+m],_t[F++]=Y}for(var V=c;V<f;++V){var Y=V+1,W=C*V;_t[F++]=p[W+N],_t[F++]=-Y}var H=F>>>1;Pr(_t,H);for(var j=0,V=0;V<H;++V){var K=_t[2*V+1]|0;if(K<0){var Y=-K;if(Y>=ae)Kt[j++]=Y-ae;else{Y-=1;var tt=g[Y],ut=C*Y,J=p[ut+e+1],rt=p[ut+e+1+t];t:for(var D=0;D<j;++D){var a=Kt[D],v=s[a];if(v===tt)break;var T=C*a;if(!(rt<o[T+e+1]||o[T+e+1+t]<J)){for(var M=e+2;M<t;++M)if(p[ut+M+t]<o[T+M]||o[T+M+t]<p[ut+M])continue t;var S=n(v,tt);if(S!==void 0)return S}}}}else{for(var Y=K-ae,D=j-1;D>=0;--D)if(Kt[D]===Y){for(var M=D+1;M<j;++M)Kt[M-1]=Kt[M];break}--j}}}});var mo=xt(Ln=>{"use strict";var Ge="d",Ce="ax",Eo="vv",Un="fp",er="es",Dr="rs",An="re",rr="rb",Lo="ri",qe="rp",Ur="bs",En="be",nr="bb",zo="bi",Ne="bp",Gn="rv",Fn="Q",In=[Ge,Ce,Eo,Dr,An,rr,Lo,Ur,En,nr,zo];function k0(t,e,n){var r="bruteForce"+(t?"Red":"Blue")+(e?"Flip":"")+(n?"Full":""),i=["function ",r,"(",In.join(),"){","var ",er,"=2*",Ge,";"],o="for(var i="+Dr+","+qe+"="+er+"*"+Dr+";i<"+An+";++i,"+qe+"+="+er+"){var x0="+rr+"["+Ce+"+"+qe+"],x1="+rr+"["+Ce+"+"+qe+"+"+Ge+"],xi="+Lo+"[i];",s="for(var j="+Ur+","+Ne+"="+er+"*"+Ur+";j<"+En+";++j,"+Ne+"+="+er+"){var y0="+nr+"["+Ce+"+"+Ne+"],"+(n?"y1="+nr+"["+Ce+"+"+Ne+"+"+Ge+"],":"")+"yi="+zo+"[j];";return t?i.push(o,Fn,":",s):i.push(s,Fn,":",o),n?i.push("if(y1<x0||x1<y0)continue;"):e?i.push("if(y0<=x0||x1<y0)continue;"):i.push("if(y0<x0||x1<y0)continue;"),i.push("for(var k="+Ce+"+1;k<"+Ge+";++k){var r0="+rr+"[k+"+qe+"],r1="+rr+"[k+"+Ge+"+"+qe+"],b0="+nr+"[k+"+Ne+"],b1="+nr+"[k+"+Ge+"+"+Ne+"];if(r1<b0||b1<r0)continue "+Fn+";}var "+Gn+"="+Eo+"("),e?i.push("yi,xi"):i.push("xi,yi"),i.push(");if("+Gn+"!==void 0)return "+Gn+";}}}"),{name:r,code:i.join("")}}function Ro(t){var e="bruteForce"+(t?"Full":"Partial"),n=[],r=In.slice();t||r.splice(3,0,Un);var i=["function "+e+"("+r.join()+"){"];function o(f,p){var g=k0(f,p,t);n.push(g.code),i.push("return "+g.name+"("+In.join()+");")}i.push("if("+An+"-"+Dr+">"+En+"-"+Ur+"){"),t?(o(!0,!1),i.push("}else{"),o(!1,!1)):(i.push("if("+Un+"){"),o(!0,!0),i.push("}else{"),o(!0,!1),i.push("}}else{if("+Un+"){"),o(!1,!0),i.push("}else{"),o(!1,!1),i.push("}")),i.push("}}return "+e);var s=n.join("")+i.join(""),c=new Function(s);return c()}Ln.partial=Ro(!1);Ln.full=Ro(!0)});var zn=xt((P1,Oo)=>{"use strict";Oo.exports=X0;var Y0="for(var j=2*a,k=j*c,l=k,m=c,n=b,o=a+b,p=c;d>p;++p,k+=j){var _;if($)if(m===p)m+=1,l+=j;else{for(var s=0;j>s;++s){var t=e[k+s];e[k+s]=e[l],e[l++]=t}var u=f[p];f[p]=f[m],f[m++]=u}}return m";function X0(t,e){var n="abcdef".split("").concat(e),r=[];return t.indexOf("lo")>=0&&r.push("lo=e[k+n]"),t.indexOf("hi")>=0&&r.push("hi=e[k+o]"),n.push(Y0.replace("_",r.join()).replace("$",t)),Function.apply(void 0,n)}});var No=xt((D1,qo)=>{"use strict";qo.exports=W0;var H0=zn(),Vo=H0("lo<p0",["p0"]),Z0=8;function $0(t,e,n,r,i,o){for(var s=2*t,c=s*(n+1)+e,f=n+1;f<r;++f,c+=s)for(var p=i[c],g=f,F=s*(f-1);g>n&&i[F+e]>p;--g,F-=s){for(var C=F,N=F+s,m=0;m<s;++m,++C,++N){var V=i[C];i[C]=i[N],i[N]=V}var Y=o[g];o[g]=o[g-1],o[g-1]=Y}}function W0(t,e,n,r,i,o){if(r<=n+1)return n;for(var s=n,c=r,f=r+n>>>1,p=2*t,g=f,F=i[p*f+e];s<c;){if(c-s<Z0){$0(t,e,s,c,i,o),F=i[p*f+e];break}var C=c-s,N=Math.random()*C+s|0,m=i[p*N+e],V=Math.random()*C+s|0,Y=i[p*V+e],et=Math.random()*C+s|0,W=i[p*et+e];m<=Y?W>=Y?(g=V,F=Y):m>=W?(g=N,F=m):(g=et,F=W):Y>=W?(g=V,F=Y):W>=m?(g=N,F=m):(g=et,F=W);for(var K=p*(c-1),tt=p*g,H=0;H<p;++H,++K,++tt){var j=i[K];i[K]=i[tt],i[tt]=j}var ut=o[c-1];o[c-1]=o[g],o[g]=ut,g=Vo(t,e,s,c-1,i,o,F);for(var K=p*(c-1),tt=p*g,H=0;H<p;++H,++K,++tt){var j=i[K];i[K]=i[tt],i[tt]=j}var ut=o[c-1];if(o[c-1]=o[g],o[g]=ut,f<g){for(c=g-1;s<c&&i[p*(c-1)+e]===F;)c-=1;c+=1}else if(g<f)for(s=g+1;s<c&&i[p*s+e]===F;)s+=1;else break}return Vo(t,e,n,f,i,o,i[p*f+e])}});var $o=xt((U1,Zo)=>{"use strict";Zo.exports=uc;var ke=br(),Rn=je(),Xo=mo(),Q0=Xo.partial,K0=Xo.full,Me=Dn(),J0=No(),Ye=zn(),Co=128,j0=1<<22,tc=1<<22,ec=Ye("!(lo>=p0)&&!(p1>=hi)",["p0","p1"]),ko=Ye("lo===p0",["p0"]),rc=Ye("lo<p0",["p0"]),nc=Ye("hi<=p0",["p0"]),Yo=Ye("lo<=p0&&p0<=hi",["p0"]),ic=Ye("lo<p0&&p0<=hi",["p0"]),mn=6,On=2,Ho=1024,ee=ke.mallocInt32(Ho),Fe=ke.mallocDouble(Ho);function oc(t,e){var n=8*Rn.log2(e+1)*(t+1)|0,r=Rn.nextPow2(mn*n);ee.length<r&&(ke.free(ee),ee=ke.mallocInt32(r));var i=Rn.nextPow2(On*n);Fe.length<i&&(ke.free(Fe),Fe=ke.mallocDouble(i))}function ce(t,e,n,r,i,o,s,c,f){var p=mn*t;ee[p]=e,ee[p+1]=n,ee[p+2]=r,ee[p+3]=i,ee[p+4]=o,ee[p+5]=s;var g=On*t;Fe[g]=c,Fe[g+1]=f}function ac(t,e,n,r,i,o,s,c,f,p,g){var F=2*t,C=f*F,N=p[C+e];t:for(var m=i,V=i*F;m<o;++m,V+=F){var Y=s[V+e],et=s[V+e+t];if(!(N<Y||et<N)&&!(r&&N===Y)){for(var W=c[m],H=e+1;H<t;++H){var Y=s[V+H],et=s[V+H+t],j=p[C+H],K=p[C+H+t];if(et<j||K<Y)continue t}var tt;if(r?tt=n(g,W):tt=n(W,g),tt!==void 0)return tt}}}function sc(t,e,n,r,i,o,s,c,f,p){var g=2*t,F=c*g,C=f[F+e];t:for(var N=r,m=r*g;N<i;++N,m+=g){var V=s[N];if(V!==p){var Y=o[m+e],et=o[m+e+t];if(!(C<Y||et<C)){for(var W=e+1;W<t;++W){var Y=o[m+W],et=o[m+W+t],H=f[F+W],j=f[F+W+t];if(et<H||j<Y)continue t}var K=n(V,p);if(K!==void 0)return K}}}}function uc(t,e,n,r,i,o,s,c,f){oc(t,r+s);var p=0,g=2*t,F;for(ce(p++,0,0,r,0,s,n?16:0,-1/0,1/0),n||ce(p++,0,0,s,0,r,1,-1/0,1/0);p>0;){p-=1;var C=p*mn,N=ee[C],m=ee[C+1],V=ee[C+2],Y=ee[C+3],et=ee[C+4],W=ee[C+5],H=p*On,j=Fe[H],K=Fe[H+1],tt=W&1,ut=!!(W&16),J=i,rt=o,D=c,a=f;if(tt&&(J=c,rt=f,D=i,a=o),!(W&2&&(V=rc(t,N,m,V,J,rt,K),m>=V))&&!(W&4&&(m=nc(t,N,m,V,J,rt,j),m>=V))){var v=V-m,T=et-Y;if(ut){if(t*v*(v+T)<tc){if(F=Me.scanComplete(t,N,e,m,V,J,rt,Y,et,D,a),F!==void 0)return F;continue}}else if(t*Math.min(v,T)<Co){if(F=Q0(t,N,e,tt,m,V,J,rt,Y,et,D,a),F!==void 0)return F;continue}else if(t*v*T<j0){if(F=Me.scanBipartite(t,N,e,tt,m,V,J,rt,Y,et,D,a),F!==void 0)return F;continue}var M=ec(t,N,m,V,J,rt,j,K);if(m<M)if(t*(M-m)<Co){if(F=K0(t,N+1,e,m,M,J,rt,Y,et,D,a),F!==void 0)return F}else if(N===t-2){if(tt?F=Me.sweepBipartite(t,e,Y,et,D,a,m,M,J,rt):F=Me.sweepBipartite(t,e,m,M,J,rt,Y,et,D,a),F!==void 0)return F}else ce(p++,N+1,m,M,Y,et,tt,-1/0,1/0),ce(p++,N+1,Y,et,m,M,tt^1,-1/0,1/0);if(M<V){var S=J0(t,N,Y,et,D,a),E=D[g*S+N],R=ko(t,N,S,et,D,a,E);if(R<et&&ce(p++,N,M,V,R,et,(tt|4)+(ut?16:0),E,K),Y<S&&ce(p++,N,M,V,Y,S,(tt|2)+(ut?16:0),j,E),S+1===R){if(ut?F=sc(t,N,e,M,V,J,rt,S,D,a[S]):F=ac(t,N,e,tt,M,V,J,rt,S,D,a[S]),F!==void 0)return F}else if(S<R){var P;if(ut){if(P=Yo(t,N,M,V,J,rt,E),M<P){var h=ko(t,N,M,P,J,rt,E);if(N===t-2){if(M<h&&(F=Me.sweepComplete(t,e,M,h,J,rt,S,R,D,a),F!==void 0)||h<P&&(F=Me.sweepBipartite(t,e,h,P,J,rt,S,R,D,a),F!==void 0))return F}else M<h&&ce(p++,N+1,M,h,S,R,16,-1/0,1/0),h<P&&(ce(p++,N+1,h,P,S,R,0,-1/0,1/0),ce(p++,N+1,S,R,h,P,1,-1/0,1/0))}}else tt?P=ic(t,N,M,V,J,rt,E):P=Yo(t,N,M,V,J,rt,E),M<P&&(N===t-2?tt?F=Me.sweepBipartite(t,e,S,R,D,a,M,P,J,rt):F=Me.sweepBipartite(t,e,M,P,J,rt,S,R,D,a):(ce(p++,N+1,M,P,S,R,tt,-1/0,1/0),ce(p++,N+1,S,R,M,P,tt^1,-1/0,1/0)))}}}}}});var Jo=xt((G1,Ko)=>{"use strict";Ko.exports=pc;var be=br(),Gr=Dn(),cc=$o();function fc(t,e){for(var n=0;n<t;++n)if(!(e[n]<=e[n+t]))return!0;return!1}function Wo(t,e,n,r){for(var i=0,o=0,s=0,c=t.length;s<c;++s){var f=t[s];if(!fc(e,f)){for(var p=0;p<2*e;++p)n[i++]=f[p];r[o++]=s}}return o}function Fr(t,e,n,r){var i=t.length,o=e.length;if(!(i<=0||o<=0)){var s=t[0].length>>>1;if(!(s<=0)){var c,f=be.mallocDouble(2*s*i),p=be.mallocInt32(i);if(i=Wo(t,s,f,p),i>0){if(s===1&&r)Gr.init(i),c=Gr.sweepComplete(s,n,0,i,f,p,0,i,f,p);else{var g=be.mallocDouble(2*s*o),F=be.mallocInt32(o);o=Wo(e,s,g,F),o>0&&(Gr.init(i+o),s===1?c=Gr.sweepBipartite(s,n,0,i,f,p,0,o,g,F):c=cc(s,n,r,i,f,p,o,g,F),be.free(g),be.free(F))}be.free(f),be.free(p)}return c}}}var ir;function Qo(t,e){ir.push([t,e])}function lc(t){return ir=[],Fr(t,t,Qo,!0),ir}function hc(t,e){return ir=[],Fr(t,e,Qo,!1),ir}function pc(t,e,n){var r;switch(arguments.length){case 1:return lc(t);case 2:return typeof e=="function"?Fr(t,t,e,!0):hc(t,e);case 3:return Fr(t,e,n,!1);default:throw new Error("box-intersect: Invalid arguments")}}});var ta=xt((F1,jo)=>{"use strict";jo.exports=dc;var Ir=xn()[3];function vc(t,e,n,r){for(var i=0;i<2;++i){var o=t[i],s=e[i],c=Math.min(o,s),f=Math.max(o,s),p=n[i],g=r[i],F=Math.min(p,g),C=Math.max(p,g);if(C<c||f<F)return!1}return!0}function dc(t,e,n,r){var i=Ir(t,n,r),o=Ir(e,n,r);if(i>0&&o>0||i<0&&o<0)return!1;var s=Ir(n,t,e),c=Ir(r,t,e);return s>0&&c>0||s<0&&c<0?!1:i===0&&o===0&&s===0&&c===0?vc(t,e,n,r):!0}});var ea=xt(()=>{});var or=xt((ra,Vn)=>{(function(t,e){"use strict";function n(D,a){if(!D)throw new Error(a||"Assertion failed")}function r(D,a){D.super_=a;var v=function(){};v.prototype=a.prototype,D.prototype=new v,D.prototype.constructor=D}function i(D,a,v){if(i.isBN(D))return D;this.negative=0,this.words=null,this.length=0,this.red=null,D!==null&&((a==="le"||a==="be")&&(v=a,a=10),this._init(D||0,a||10,v||"be"))}typeof t=="object"?t.exports=i:e.BN=i,i.BN=i,i.wordSize=26;var o;try{typeof window<"u"&&typeof window.Buffer<"u"?o=window.Buffer:o=ea().Buffer}catch{}i.isBN=function(a){return a instanceof i?!0:a!==null&&typeof a=="object"&&a.constructor.wordSize===i.wordSize&&Array.isArray(a.words)},i.max=function(a,v){return a.cmp(v)>0?a:v},i.min=function(a,v){return a.cmp(v)<0?a:v},i.prototype._init=function(a,v,T){if(typeof a=="number")return this._initNumber(a,v,T);if(typeof a=="object")return this._initArray(a,v,T);v==="hex"&&(v=16),n(v===(v|0)&&v>=2&&v<=36),a=a.toString().replace(/\s+/g,"");var M=0;a[0]==="-"&&(M++,this.negative=1),M<a.length&&(v===16?this._parseHex(a,M,T):(this._parseBase(a,v,M),T==="le"&&this._initArray(this.toArray(),v,T)))},i.prototype._initNumber=function(a,v,T){a<0&&(this.negative=1,a=-a),a<67108864?(this.words=[a&67108863],this.length=1):a<4503599627370496?(this.words=[a&67108863,a/67108864&67108863],this.length=2):(n(a<9007199254740992),this.words=[a&67108863,a/67108864&67108863,1],this.length=3),T==="le"&&this._initArray(this.toArray(),v,T)},i.prototype._initArray=function(a,v,T){if(n(typeof a.length=="number"),a.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(a.length/3),this.words=new Array(this.length);for(var M=0;M<this.length;M++)this.words[M]=0;var S,E,R=0;if(T==="be")for(M=a.length-1,S=0;M>=0;M-=3)E=a[M]|a[M-1]<<8|a[M-2]<<16,this.words[S]|=E<<R&67108863,this.words[S+1]=E>>>26-R&67108863,R+=24,R>=26&&(R-=26,S++);else if(T==="le")for(M=0,S=0;M<a.length;M+=3)E=a[M]|a[M+1]<<8|a[M+2]<<16,this.words[S]|=E<<R&67108863,this.words[S+1]=E>>>26-R&67108863,R+=24,R>=26&&(R-=26,S++);return this.strip()};function s(D,a){var v=D.charCodeAt(a);return v>=65&&v<=70?v-55:v>=97&&v<=102?v-87:v-48&15}function c(D,a,v){var T=s(D,v);return v-1>=a&&(T|=s(D,v-1)<<4),T}i.prototype._parseHex=function(a,v,T){this.length=Math.ceil((a.length-v)/6),this.words=new Array(this.length);for(var M=0;M<this.length;M++)this.words[M]=0;var S=0,E=0,R;if(T==="be")for(M=a.length-1;M>=v;M-=2)R=c(a,v,M)<<S,this.words[E]|=R&67108863,S>=18?(S-=18,E+=1,this.words[E]|=R>>>26):S+=8;else{var P=a.length-v;for(M=P%2===0?v+1:v;M<a.length;M+=2)R=c(a,v,M)<<S,this.words[E]|=R&67108863,S>=18?(S-=18,E+=1,this.words[E]|=R>>>26):S+=8}this.strip()};function f(D,a,v,T){for(var M=0,S=Math.min(D.length,v),E=a;E<S;E++){var R=D.charCodeAt(E)-48;M*=T,R>=49?M+=R-49+10:R>=17?M+=R-17+10:M+=R}return M}i.prototype._parseBase=function(a,v,T){this.words=[0],this.length=1;for(var M=0,S=1;S<=67108863;S*=v)M++;M--,S=S/v|0;for(var E=a.length-T,R=E%M,P=Math.min(E,E-R)+T,h=0,G=T;G<P;G+=M)h=f(a,G,G+M,v),this.imuln(S),this.words[0]+h<67108864?this.words[0]+=h:this._iaddn(h);if(R!==0){var ot=1;for(h=f(a,G,a.length,v),G=0;G<R;G++)ot*=v;this.imuln(ot),this.words[0]+h<67108864?this.words[0]+=h:this._iaddn(h)}this.strip()},i.prototype.copy=function(a){a.words=new Array(this.length);for(var v=0;v<this.length;v++)a.words[v]=this.words[v];a.length=this.length,a.negative=this.negative,a.red=this.red},i.prototype.clone=function(){var a=new i(null);return this.copy(a),a},i.prototype._expand=function(a){for(;this.length<a;)this.words[this.length++]=0;return this},i.prototype.strip=function(){for(;this.length>1&&this.words[this.length-1]===0;)this.length--;return this._normSign()},i.prototype._normSign=function(){return this.length===1&&this.words[0]===0&&(this.negative=0),this},i.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var p=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],g=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],F=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];i.prototype.toString=function(a,v){a=a||10,v=v|0||1;var T;if(a===16||a==="hex"){T="";for(var M=0,S=0,E=0;E<this.length;E++){var R=this.words[E],P=((R<<M|S)&16777215).toString(16);S=R>>>24-M&16777215,M+=2,M>=26&&(M-=26,E--),S!==0||E!==this.length-1?T=p[6-P.length]+P+T:T=P+T}for(S!==0&&(T=S.toString(16)+T);T.length%v!==0;)T="0"+T;return this.negative!==0&&(T="-"+T),T}if(a===(a|0)&&a>=2&&a<=36){var h=g[a],G=F[a];T="";var ot=this.clone();for(ot.negative=0;!ot.isZero();){var at=ot.modn(G).toString(a);ot=ot.idivn(G),ot.isZero()?T=at+T:T=p[h-at.length]+at+T}for(this.isZero()&&(T="0"+T);T.length%v!==0;)T="0"+T;return this.negative!==0&&(T="-"+T),T}n(!1,"Base should be between 2 and 36")},i.prototype.toNumber=function(){var a=this.words[0];return this.length===2?a+=this.words[1]*67108864:this.length===3&&this.words[2]===1?a+=4503599627370496+this.words[1]*67108864:this.length>2&&n(!1,"Number can only safely store up to 53 bits"),this.negative!==0?-a:a},i.prototype.toJSON=function(){return this.toString(16)},i.prototype.toBuffer=function(a,v){return n(typeof o<"u"),this.toArrayLike(o,a,v)},i.prototype.toArray=function(a,v){return this.toArrayLike(Array,a,v)},i.prototype.toArrayLike=function(a,v,T){var M=this.byteLength(),S=T||Math.max(1,M);n(M<=S,"byte array longer than desired length"),n(S>0,"Requested array length <= 0"),this.strip();var E=v==="le",R=new a(S),P,h,G=this.clone();if(E){for(h=0;!G.isZero();h++)P=G.andln(255),G.iushrn(8),R[h]=P;for(;h<S;h++)R[h]=0}else{for(h=0;h<S-M;h++)R[h]=0;for(h=0;!G.isZero();h++)P=G.andln(255),G.iushrn(8),R[S-h-1]=P}return R},Math.clz32?i.prototype._countBits=function(a){return 32-Math.clz32(a)}:i.prototype._countBits=function(a){var v=a,T=0;return v>=4096&&(T+=13,v>>>=13),v>=64&&(T+=7,v>>>=7),v>=8&&(T+=4,v>>>=4),v>=2&&(T+=2,v>>>=2),T+v},i.prototype._zeroBits=function(a){if(a===0)return 26;var v=a,T=0;return(v&8191)===0&&(T+=13,v>>>=13),(v&127)===0&&(T+=7,v>>>=7),(v&15)===0&&(T+=4,v>>>=4),(v&3)===0&&(T+=2,v>>>=2),(v&1)===0&&T++,T},i.prototype.bitLength=function(){var a=this.words[this.length-1],v=this._countBits(a);return(this.length-1)*26+v};function C(D){for(var a=new Array(D.bitLength()),v=0;v<a.length;v++){var T=v/26|0,M=v%26;a[v]=(D.words[T]&1<<M)>>>M}return a}i.prototype.zeroBits=function(){if(this.isZero())return 0;for(var a=0,v=0;v<this.length;v++){var T=this._zeroBits(this.words[v]);if(a+=T,T!==26)break}return a},i.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},i.prototype.toTwos=function(a){return this.negative!==0?this.abs().inotn(a).iaddn(1):this.clone()},i.prototype.fromTwos=function(a){return this.testn(a-1)?this.notn(a).iaddn(1).ineg():this.clone()},i.prototype.isNeg=function(){return this.negative!==0},i.prototype.neg=function(){return this.clone().ineg()},i.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},i.prototype.iuor=function(a){for(;this.length<a.length;)this.words[this.length++]=0;for(var v=0;v<a.length;v++)this.words[v]=this.words[v]|a.words[v];return this.strip()},i.prototype.ior=function(a){return n((this.negative|a.negative)===0),this.iuor(a)},i.prototype.or=function(a){return this.length>a.length?this.clone().ior(a):a.clone().ior(this)},i.prototype.uor=function(a){return this.length>a.length?this.clone().iuor(a):a.clone().iuor(this)},i.prototype.iuand=function(a){var v;this.length>a.length?v=a:v=this;for(var T=0;T<v.length;T++)this.words[T]=this.words[T]&a.words[T];return this.length=v.length,this.strip()},i.prototype.iand=function(a){return n((this.negative|a.negative)===0),this.iuand(a)},i.prototype.and=function(a){return this.length>a.length?this.clone().iand(a):a.clone().iand(this)},i.prototype.uand=function(a){return this.length>a.length?this.clone().iuand(a):a.clone().iuand(this)},i.prototype.iuxor=function(a){var v,T;this.length>a.length?(v=this,T=a):(v=a,T=this);for(var M=0;M<T.length;M++)this.words[M]=v.words[M]^T.words[M];if(this!==v)for(;M<v.length;M++)this.words[M]=v.words[M];return this.length=v.length,this.strip()},i.prototype.ixor=function(a){return n((this.negative|a.negative)===0),this.iuxor(a)},i.prototype.xor=function(a){return this.length>a.length?this.clone().ixor(a):a.clone().ixor(this)},i.prototype.uxor=function(a){return this.length>a.length?this.clone().iuxor(a):a.clone().iuxor(this)},i.prototype.inotn=function(a){n(typeof a=="number"&&a>=0);var v=Math.ceil(a/26)|0,T=a%26;this._expand(v),T>0&&v--;for(var M=0;M<v;M++)this.words[M]=~this.words[M]&67108863;return T>0&&(this.words[M]=~this.words[M]&67108863>>26-T),this.strip()},i.prototype.notn=function(a){return this.clone().inotn(a)},i.prototype.setn=function(a,v){n(typeof a=="number"&&a>=0);var T=a/26|0,M=a%26;return this._expand(T+1),v?this.words[T]=this.words[T]|1<<M:this.words[T]=this.words[T]&~(1<<M),this.strip()},i.prototype.iadd=function(a){var v;if(this.negative!==0&&a.negative===0)return this.negative=0,v=this.isub(a),this.negative^=1,this._normSign();if(this.negative===0&&a.negative!==0)return a.negative=0,v=this.isub(a),a.negative=1,v._normSign();var T,M;this.length>a.length?(T=this,M=a):(T=a,M=this);for(var S=0,E=0;E<M.length;E++)v=(T.words[E]|0)+(M.words[E]|0)+S,this.words[E]=v&67108863,S=v>>>26;for(;S!==0&&E<T.length;E++)v=(T.words[E]|0)+S,this.words[E]=v&67108863,S=v>>>26;if(this.length=T.length,S!==0)this.words[this.length]=S,this.length++;else if(T!==this)for(;E<T.length;E++)this.words[E]=T.words[E];return this},i.prototype.add=function(a){var v;return a.negative!==0&&this.negative===0?(a.negative=0,v=this.sub(a),a.negative^=1,v):a.negative===0&&this.negative!==0?(this.negative=0,v=a.sub(this),this.negative=1,v):this.length>a.length?this.clone().iadd(a):a.clone().iadd(this)},i.prototype.isub=function(a){if(a.negative!==0){a.negative=0;var v=this.iadd(a);return a.negative=1,v._normSign()}else if(this.negative!==0)return this.negative=0,this.iadd(a),this.negative=1,this._normSign();var T=this.cmp(a);if(T===0)return this.negative=0,this.length=1,this.words[0]=0,this;var M,S;T>0?(M=this,S=a):(M=a,S=this);for(var E=0,R=0;R<S.length;R++)v=(M.words[R]|0)-(S.words[R]|0)+E,E=v>>26,this.words[R]=v&67108863;for(;E!==0&&R<M.length;R++)v=(M.words[R]|0)+E,E=v>>26,this.words[R]=v&67108863;if(E===0&&R<M.length&&M!==this)for(;R<M.length;R++)this.words[R]=M.words[R];return this.length=Math.max(this.length,R),M!==this&&(this.negative=1),this.strip()},i.prototype.sub=function(a){return this.clone().isub(a)};function N(D,a,v){v.negative=a.negative^D.negative;var T=D.length+a.length|0;v.length=T,T=T-1|0;var M=D.words[0]|0,S=a.words[0]|0,E=M*S,R=E&67108863,P=E/67108864|0;v.words[0]=R;for(var h=1;h<T;h++){for(var G=P>>>26,ot=P&67108863,at=Math.min(h,a.length-1),st=Math.max(0,h-D.length+1);st<=at;st++){var ct=h-st|0;M=D.words[ct]|0,S=a.words[st]|0,E=M*S+ot,G+=E/67108864|0,ot=E&67108863}v.words[h]=ot|0,P=G|0}return P!==0?v.words[h]=P|0:v.length--,v.strip()}var m=function(a,v,T){var M=a.words,S=v.words,E=T.words,R=0,P,h,G,ot=M[0]|0,at=ot&8191,st=ot>>>13,ct=M[1]|0,yt=ct&8191,pt=ct>>>13,k=M[2]|0,Z=k&8191,U=k>>>13,l=M[3]|0,b=l&8191,w=l>>>13,A=M[4]|0,z=A&8191,O=A>>>13,q=M[5]|0,u=q&8191,B=q>>>13,x=M[6]|0,y=x&8191,d=x>>>13,_=M[7]|0,L=_&8191,I=_>>>13,X=M[8]|0,$=X&8191,Q=X>>>13,ft=M[9]|0,nt=ft&8191,it=ft>>>13,vt=S[0]|0,ht=vt&8191,lt=vt>>>13,dt=S[1]|0,wt=dt&8191,gt=dt>>>13,qt=S[2]|0,Mt=qt&8191,bt=qt>>>13,Xt=S[3]|0,St=Xt&8191,Bt=Xt>>>13,Zt=S[4]|0,Pt=Zt&8191,Dt=Zt>>>13,$t=S[5]|0,Ut=$t&8191,Gt=$t>>>13,Wt=S[6]|0,Ft=Wt&8191,It=Wt>>>13,Jt=S[7]|0,Lt=Jt&8191,zt=Jt>>>13,Te=S[8]|0,Rt=Te&8191,mt=Te>>>13,_e=S[9]|0,Ot=_e&8191,Vt=_e>>>13;T.negative=a.negative^v.negative,T.length=19,P=Math.imul(at,ht),h=Math.imul(at,lt),h=h+Math.imul(st,ht)|0,G=Math.imul(st,lt);var Ee=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Ee>>>26)|0,Ee&=67108863,P=Math.imul(yt,ht),h=Math.imul(yt,lt),h=h+Math.imul(pt,ht)|0,G=Math.imul(pt,lt),P=P+Math.imul(at,wt)|0,h=h+Math.imul(at,gt)|0,h=h+Math.imul(st,wt)|0,G=G+Math.imul(st,gt)|0;var Le=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Le>>>26)|0,Le&=67108863,P=Math.imul(Z,ht),h=Math.imul(Z,lt),h=h+Math.imul(U,ht)|0,G=Math.imul(U,lt),P=P+Math.imul(yt,wt)|0,h=h+Math.imul(yt,gt)|0,h=h+Math.imul(pt,wt)|0,G=G+Math.imul(pt,gt)|0,P=P+Math.imul(at,Mt)|0,h=h+Math.imul(at,bt)|0,h=h+Math.imul(st,Mt)|0,G=G+Math.imul(st,bt)|0;var ze=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(ze>>>26)|0,ze&=67108863,P=Math.imul(b,ht),h=Math.imul(b,lt),h=h+Math.imul(w,ht)|0,G=Math.imul(w,lt),P=P+Math.imul(Z,wt)|0,h=h+Math.imul(Z,gt)|0,h=h+Math.imul(U,wt)|0,G=G+Math.imul(U,gt)|0,P=P+Math.imul(yt,Mt)|0,h=h+Math.imul(yt,bt)|0,h=h+Math.imul(pt,Mt)|0,G=G+Math.imul(pt,bt)|0,P=P+Math.imul(at,St)|0,h=h+Math.imul(at,Bt)|0,h=h+Math.imul(st,St)|0,G=G+Math.imul(st,Bt)|0;var Ht=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Ht>>>26)|0,Ht&=67108863,P=Math.imul(z,ht),h=Math.imul(z,lt),h=h+Math.imul(O,ht)|0,G=Math.imul(O,lt),P=P+Math.imul(b,wt)|0,h=h+Math.imul(b,gt)|0,h=h+Math.imul(w,wt)|0,G=G+Math.imul(w,gt)|0,P=P+Math.imul(Z,Mt)|0,h=h+Math.imul(Z,bt)|0,h=h+Math.imul(U,Mt)|0,G=G+Math.imul(U,bt)|0,P=P+Math.imul(yt,St)|0,h=h+Math.imul(yt,Bt)|0,h=h+Math.imul(pt,St)|0,G=G+Math.imul(pt,Bt)|0,P=P+Math.imul(at,Pt)|0,h=h+Math.imul(at,Dt)|0,h=h+Math.imul(st,Pt)|0,G=G+Math.imul(st,Dt)|0;var kr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(kr>>>26)|0,kr&=67108863,P=Math.imul(u,ht),h=Math.imul(u,lt),h=h+Math.imul(B,ht)|0,G=Math.imul(B,lt),P=P+Math.imul(z,wt)|0,h=h+Math.imul(z,gt)|0,h=h+Math.imul(O,wt)|0,G=G+Math.imul(O,gt)|0,P=P+Math.imul(b,Mt)|0,h=h+Math.imul(b,bt)|0,h=h+Math.imul(w,Mt)|0,G=G+Math.imul(w,bt)|0,P=P+Math.imul(Z,St)|0,h=h+Math.imul(Z,Bt)|0,h=h+Math.imul(U,St)|0,G=G+Math.imul(U,Bt)|0,P=P+Math.imul(yt,Pt)|0,h=h+Math.imul(yt,Dt)|0,h=h+Math.imul(pt,Pt)|0,G=G+Math.imul(pt,Dt)|0,P=P+Math.imul(at,Ut)|0,h=h+Math.imul(at,Gt)|0,h=h+Math.imul(st,Ut)|0,G=G+Math.imul(st,Gt)|0;var Yr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Yr>>>26)|0,Yr&=67108863,P=Math.imul(y,ht),h=Math.imul(y,lt),h=h+Math.imul(d,ht)|0,G=Math.imul(d,lt),P=P+Math.imul(u,wt)|0,h=h+Math.imul(u,gt)|0,h=h+Math.imul(B,wt)|0,G=G+Math.imul(B,gt)|0,P=P+Math.imul(z,Mt)|0,h=h+Math.imul(z,bt)|0,h=h+Math.imul(O,Mt)|0,G=G+Math.imul(O,bt)|0,P=P+Math.imul(b,St)|0,h=h+Math.imul(b,Bt)|0,h=h+Math.imul(w,St)|0,G=G+Math.imul(w,Bt)|0,P=P+Math.imul(Z,Pt)|0,h=h+Math.imul(Z,Dt)|0,h=h+Math.imul(U,Pt)|0,G=G+Math.imul(U,Dt)|0,P=P+Math.imul(yt,Ut)|0,h=h+Math.imul(yt,Gt)|0,h=h+Math.imul(pt,Ut)|0,G=G+Math.imul(pt,Gt)|0,P=P+Math.imul(at,Ft)|0,h=h+Math.imul(at,It)|0,h=h+Math.imul(st,Ft)|0,G=G+Math.imul(st,It)|0;var Xr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Xr>>>26)|0,Xr&=67108863,P=Math.imul(L,ht),h=Math.imul(L,lt),h=h+Math.imul(I,ht)|0,G=Math.imul(I,lt),P=P+Math.imul(y,wt)|0,h=h+Math.imul(y,gt)|0,h=h+Math.imul(d,wt)|0,G=G+Math.imul(d,gt)|0,P=P+Math.imul(u,Mt)|0,h=h+Math.imul(u,bt)|0,h=h+Math.imul(B,Mt)|0,G=G+Math.imul(B,bt)|0,P=P+Math.imul(z,St)|0,h=h+Math.imul(z,Bt)|0,h=h+Math.imul(O,St)|0,G=G+Math.imul(O,Bt)|0,P=P+Math.imul(b,Pt)|0,h=h+Math.imul(b,Dt)|0,h=h+Math.imul(w,Pt)|0,G=G+Math.imul(w,Dt)|0,P=P+Math.imul(Z,Ut)|0,h=h+Math.imul(Z,Gt)|0,h=h+Math.imul(U,Ut)|0,G=G+Math.imul(U,Gt)|0,P=P+Math.imul(yt,Ft)|0,h=h+Math.imul(yt,It)|0,h=h+Math.imul(pt,Ft)|0,G=G+Math.imul(pt,It)|0,P=P+Math.imul(at,Lt)|0,h=h+Math.imul(at,zt)|0,h=h+Math.imul(st,Lt)|0,G=G+Math.imul(st,zt)|0;var Hr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Hr>>>26)|0,Hr&=67108863,P=Math.imul($,ht),h=Math.imul($,lt),h=h+Math.imul(Q,ht)|0,G=Math.imul(Q,lt),P=P+Math.imul(L,wt)|0,h=h+Math.imul(L,gt)|0,h=h+Math.imul(I,wt)|0,G=G+Math.imul(I,gt)|0,P=P+Math.imul(y,Mt)|0,h=h+Math.imul(y,bt)|0,h=h+Math.imul(d,Mt)|0,G=G+Math.imul(d,bt)|0,P=P+Math.imul(u,St)|0,h=h+Math.imul(u,Bt)|0,h=h+Math.imul(B,St)|0,G=G+Math.imul(B,Bt)|0,P=P+Math.imul(z,Pt)|0,h=h+Math.imul(z,Dt)|0,h=h+Math.imul(O,Pt)|0,G=G+Math.imul(O,Dt)|0,P=P+Math.imul(b,Ut)|0,h=h+Math.imul(b,Gt)|0,h=h+Math.imul(w,Ut)|0,G=G+Math.imul(w,Gt)|0,P=P+Math.imul(Z,Ft)|0,h=h+Math.imul(Z,It)|0,h=h+Math.imul(U,Ft)|0,G=G+Math.imul(U,It)|0,P=P+Math.imul(yt,Lt)|0,h=h+Math.imul(yt,zt)|0,h=h+Math.imul(pt,Lt)|0,G=G+Math.imul(pt,zt)|0,P=P+Math.imul(at,Rt)|0,h=h+Math.imul(at,mt)|0,h=h+Math.imul(st,Rt)|0,G=G+Math.imul(st,mt)|0;var Zr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Zr>>>26)|0,Zr&=67108863,P=Math.imul(nt,ht),h=Math.imul(nt,lt),h=h+Math.imul(it,ht)|0,G=Math.imul(it,lt),P=P+Math.imul($,wt)|0,h=h+Math.imul($,gt)|0,h=h+Math.imul(Q,wt)|0,G=G+Math.imul(Q,gt)|0,P=P+Math.imul(L,Mt)|0,h=h+Math.imul(L,bt)|0,h=h+Math.imul(I,Mt)|0,G=G+Math.imul(I,bt)|0,P=P+Math.imul(y,St)|0,h=h+Math.imul(y,Bt)|0,h=h+Math.imul(d,St)|0,G=G+Math.imul(d,Bt)|0,P=P+Math.imul(u,Pt)|0,h=h+Math.imul(u,Dt)|0,h=h+Math.imul(B,Pt)|0,G=G+Math.imul(B,Dt)|0,P=P+Math.imul(z,Ut)|0,h=h+Math.imul(z,Gt)|0,h=h+Math.imul(O,Ut)|0,G=G+Math.imul(O,Gt)|0,P=P+Math.imul(b,Ft)|0,h=h+Math.imul(b,It)|0,h=h+Math.imul(w,Ft)|0,G=G+Math.imul(w,It)|0,P=P+Math.imul(Z,Lt)|0,h=h+Math.imul(Z,zt)|0,h=h+Math.imul(U,Lt)|0,G=G+Math.imul(U,zt)|0,P=P+Math.imul(yt,Rt)|0,h=h+Math.imul(yt,mt)|0,h=h+Math.imul(pt,Rt)|0,G=G+Math.imul(pt,mt)|0,P=P+Math.imul(at,Ot)|0,h=h+Math.imul(at,Vt)|0,h=h+Math.imul(st,Ot)|0,G=G+Math.imul(st,Vt)|0;var $r=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+($r>>>26)|0,$r&=67108863,P=Math.imul(nt,wt),h=Math.imul(nt,gt),h=h+Math.imul(it,wt)|0,G=Math.imul(it,gt),P=P+Math.imul($,Mt)|0,h=h+Math.imul($,bt)|0,h=h+Math.imul(Q,Mt)|0,G=G+Math.imul(Q,bt)|0,P=P+Math.imul(L,St)|0,h=h+Math.imul(L,Bt)|0,h=h+Math.imul(I,St)|0,G=G+Math.imul(I,Bt)|0,P=P+Math.imul(y,Pt)|0,h=h+Math.imul(y,Dt)|0,h=h+Math.imul(d,Pt)|0,G=G+Math.imul(d,Dt)|0,P=P+Math.imul(u,Ut)|0,h=h+Math.imul(u,Gt)|0,h=h+Math.imul(B,Ut)|0,G=G+Math.imul(B,Gt)|0,P=P+Math.imul(z,Ft)|0,h=h+Math.imul(z,It)|0,h=h+Math.imul(O,Ft)|0,G=G+Math.imul(O,It)|0,P=P+Math.imul(b,Lt)|0,h=h+Math.imul(b,zt)|0,h=h+Math.imul(w,Lt)|0,G=G+Math.imul(w,zt)|0,P=P+Math.imul(Z,Rt)|0,h=h+Math.imul(Z,mt)|0,h=h+Math.imul(U,Rt)|0,G=G+Math.imul(U,mt)|0,P=P+Math.imul(yt,Ot)|0,h=h+Math.imul(yt,Vt)|0,h=h+Math.imul(pt,Ot)|0,G=G+Math.imul(pt,Vt)|0;var Wr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Wr>>>26)|0,Wr&=67108863,P=Math.imul(nt,Mt),h=Math.imul(nt,bt),h=h+Math.imul(it,Mt)|0,G=Math.imul(it,bt),P=P+Math.imul($,St)|0,h=h+Math.imul($,Bt)|0,h=h+Math.imul(Q,St)|0,G=G+Math.imul(Q,Bt)|0,P=P+Math.imul(L,Pt)|0,h=h+Math.imul(L,Dt)|0,h=h+Math.imul(I,Pt)|0,G=G+Math.imul(I,Dt)|0,P=P+Math.imul(y,Ut)|0,h=h+Math.imul(y,Gt)|0,h=h+Math.imul(d,Ut)|0,G=G+Math.imul(d,Gt)|0,P=P+Math.imul(u,Ft)|0,h=h+Math.imul(u,It)|0,h=h+Math.imul(B,Ft)|0,G=G+Math.imul(B,It)|0,P=P+Math.imul(z,Lt)|0,h=h+Math.imul(z,zt)|0,h=h+Math.imul(O,Lt)|0,G=G+Math.imul(O,zt)|0,P=P+Math.imul(b,Rt)|0,h=h+Math.imul(b,mt)|0,h=h+Math.imul(w,Rt)|0,G=G+Math.imul(w,mt)|0,P=P+Math.imul(Z,Ot)|0,h=h+Math.imul(Z,Vt)|0,h=h+Math.imul(U,Ot)|0,G=G+Math.imul(U,Vt)|0;var Qr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Qr>>>26)|0,Qr&=67108863,P=Math.imul(nt,St),h=Math.imul(nt,Bt),h=h+Math.imul(it,St)|0,G=Math.imul(it,Bt),P=P+Math.imul($,Pt)|0,h=h+Math.imul($,Dt)|0,h=h+Math.imul(Q,Pt)|0,G=G+Math.imul(Q,Dt)|0,P=P+Math.imul(L,Ut)|0,h=h+Math.imul(L,Gt)|0,h=h+Math.imul(I,Ut)|0,G=G+Math.imul(I,Gt)|0,P=P+Math.imul(y,Ft)|0,h=h+Math.imul(y,It)|0,h=h+Math.imul(d,Ft)|0,G=G+Math.imul(d,It)|0,P=P+Math.imul(u,Lt)|0,h=h+Math.imul(u,zt)|0,h=h+Math.imul(B,Lt)|0,G=G+Math.imul(B,zt)|0,P=P+Math.imul(z,Rt)|0,h=h+Math.imul(z,mt)|0,h=h+Math.imul(O,Rt)|0,G=G+Math.imul(O,mt)|0,P=P+Math.imul(b,Ot)|0,h=h+Math.imul(b,Vt)|0,h=h+Math.imul(w,Ot)|0,G=G+Math.imul(w,Vt)|0;var Kr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Kr>>>26)|0,Kr&=67108863,P=Math.imul(nt,Pt),h=Math.imul(nt,Dt),h=h+Math.imul(it,Pt)|0,G=Math.imul(it,Dt),P=P+Math.imul($,Ut)|0,h=h+Math.imul($,Gt)|0,h=h+Math.imul(Q,Ut)|0,G=G+Math.imul(Q,Gt)|0,P=P+Math.imul(L,Ft)|0,h=h+Math.imul(L,It)|0,h=h+Math.imul(I,Ft)|0,G=G+Math.imul(I,It)|0,P=P+Math.imul(y,Lt)|0,h=h+Math.imul(y,zt)|0,h=h+Math.imul(d,Lt)|0,G=G+Math.imul(d,zt)|0,P=P+Math.imul(u,Rt)|0,h=h+Math.imul(u,mt)|0,h=h+Math.imul(B,Rt)|0,G=G+Math.imul(B,mt)|0,P=P+Math.imul(z,Ot)|0,h=h+Math.imul(z,Vt)|0,h=h+Math.imul(O,Ot)|0,G=G+Math.imul(O,Vt)|0;var Jr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(Jr>>>26)|0,Jr&=67108863,P=Math.imul(nt,Ut),h=Math.imul(nt,Gt),h=h+Math.imul(it,Ut)|0,G=Math.imul(it,Gt),P=P+Math.imul($,Ft)|0,h=h+Math.imul($,It)|0,h=h+Math.imul(Q,Ft)|0,G=G+Math.imul(Q,It)|0,P=P+Math.imul(L,Lt)|0,h=h+Math.imul(L,zt)|0,h=h+Math.imul(I,Lt)|0,G=G+Math.imul(I,zt)|0,P=P+Math.imul(y,Rt)|0,h=h+Math.imul(y,mt)|0,h=h+Math.imul(d,Rt)|0,G=G+Math.imul(d,mt)|0,P=P+Math.imul(u,Ot)|0,h=h+Math.imul(u,Vt)|0,h=h+Math.imul(B,Ot)|0,G=G+Math.imul(B,Vt)|0;var jr=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(jr>>>26)|0,jr&=67108863,P=Math.imul(nt,Ft),h=Math.imul(nt,It),h=h+Math.imul(it,Ft)|0,G=Math.imul(it,It),P=P+Math.imul($,Lt)|0,h=h+Math.imul($,zt)|0,h=h+Math.imul(Q,Lt)|0,G=G+Math.imul(Q,zt)|0,P=P+Math.imul(L,Rt)|0,h=h+Math.imul(L,mt)|0,h=h+Math.imul(I,Rt)|0,G=G+Math.imul(I,mt)|0,P=P+Math.imul(y,Ot)|0,h=h+Math.imul(y,Vt)|0,h=h+Math.imul(d,Ot)|0,G=G+Math.imul(d,Vt)|0;var tn=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(tn>>>26)|0,tn&=67108863,P=Math.imul(nt,Lt),h=Math.imul(nt,zt),h=h+Math.imul(it,Lt)|0,G=Math.imul(it,zt),P=P+Math.imul($,Rt)|0,h=h+Math.imul($,mt)|0,h=h+Math.imul(Q,Rt)|0,G=G+Math.imul(Q,mt)|0,P=P+Math.imul(L,Ot)|0,h=h+Math.imul(L,Vt)|0,h=h+Math.imul(I,Ot)|0,G=G+Math.imul(I,Vt)|0;var en=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(en>>>26)|0,en&=67108863,P=Math.imul(nt,Rt),h=Math.imul(nt,mt),h=h+Math.imul(it,Rt)|0,G=Math.imul(it,mt),P=P+Math.imul($,Ot)|0,h=h+Math.imul($,Vt)|0,h=h+Math.imul(Q,Ot)|0,G=G+Math.imul(Q,Vt)|0;var rn=(R+P|0)+((h&8191)<<13)|0;R=(G+(h>>>13)|0)+(rn>>>26)|0,rn&=67108863,P=Math.imul(nt,Ot),h=Math.imul(nt,Vt),h=h+Math.imul(it,Ot)|0,G=Math.imul(it,Vt);var nn=(R+P|0)+((h&8191)<<13)|0;return R=(G+(h>>>13)|0)+(nn>>>26)|0,nn&=67108863,E[0]=Ee,E[1]=Le,E[2]=ze,E[3]=Ht,E[4]=kr,E[5]=Yr,E[6]=Xr,E[7]=Hr,E[8]=Zr,E[9]=$r,E[10]=Wr,E[11]=Qr,E[12]=Kr,E[13]=Jr,E[14]=jr,E[15]=tn,E[16]=en,E[17]=rn,E[18]=nn,R!==0&&(E[19]=R,T.length++),T};Math.imul||(m=N);function V(D,a,v){v.negative=a.negative^D.negative,v.length=D.length+a.length;for(var T=0,M=0,S=0;S<v.length-1;S++){var E=M;M=0;for(var R=T&67108863,P=Math.min(S,a.length-1),h=Math.max(0,S-D.length+1);h<=P;h++){var G=S-h,ot=D.words[G]|0,at=a.words[h]|0,st=ot*at,ct=st&67108863;E=E+(st/67108864|0)|0,ct=ct+R|0,R=ct&67108863,E=E+(ct>>>26)|0,M+=E>>>26,E&=67108863}v.words[S]=R,T=E,E=M}return T!==0?v.words[S]=T:v.length--,v.strip()}function Y(D,a,v){var T=new et;return T.mulp(D,a,v)}i.prototype.mulTo=function(a,v){var T,M=this.length+a.length;return this.length===10&&a.length===10?T=m(this,a,v):M<63?T=N(this,a,v):M<1024?T=V(this,a,v):T=Y(this,a,v),T};function et(D,a){this.x=D,this.y=a}et.prototype.makeRBT=function(a){for(var v=new Array(a),T=i.prototype._countBits(a)-1,M=0;M<a;M++)v[M]=this.revBin(M,T,a);return v},et.prototype.revBin=function(a,v,T){if(a===0||a===T-1)return a;for(var M=0,S=0;S<v;S++)M|=(a&1)<<v-S-1,a>>=1;return M},et.prototype.permute=function(a,v,T,M,S,E){for(var R=0;R<E;R++)M[R]=v[a[R]],S[R]=T[a[R]]},et.prototype.transform=function(a,v,T,M,S,E){this.permute(E,a,v,T,M,S);for(var R=1;R<S;R<<=1)for(var P=R<<1,h=Math.cos(2*Math.PI/P),G=Math.sin(2*Math.PI/P),ot=0;ot<S;ot+=P)for(var at=h,st=G,ct=0;ct<R;ct++){var yt=T[ot+ct],pt=M[ot+ct],k=T[ot+ct+R],Z=M[ot+ct+R],U=at*k-st*Z;Z=at*Z+st*k,k=U,T[ot+ct]=yt+k,M[ot+ct]=pt+Z,T[ot+ct+R]=yt-k,M[ot+ct+R]=pt-Z,ct!==P&&(U=h*at-G*st,st=h*st+G*at,at=U)}},et.prototype.guessLen13b=function(a,v){var T=Math.max(v,a)|1,M=T&1,S=0;for(T=T/2|0;T;T=T>>>1)S++;return 1<<S+1+M},et.prototype.conjugate=function(a,v,T){if(!(T<=1))for(var M=0;M<T/2;M++){var S=a[M];a[M]=a[T-M-1],a[T-M-1]=S,S=v[M],v[M]=-v[T-M-1],v[T-M-1]=-S}},et.prototype.normalize13b=function(a,v){for(var T=0,M=0;M<v/2;M++){var S=Math.round(a[2*M+1]/v)*8192+Math.round(a[2*M]/v)+T;a[M]=S&67108863,S<67108864?T=0:T=S/67108864|0}return a},et.prototype.convert13b=function(a,v,T,M){for(var S=0,E=0;E<v;E++)S=S+(a[E]|0),T[2*E]=S&8191,S=S>>>13,T[2*E+1]=S&8191,S=S>>>13;for(E=2*v;E<M;++E)T[E]=0;n(S===0),n((S&-8192)===0)},et.prototype.stub=function(a){for(var v=new Array(a),T=0;T<a;T++)v[T]=0;return v},et.prototype.mulp=function(a,v,T){var M=2*this.guessLen13b(a.length,v.length),S=this.makeRBT(M),E=this.stub(M),R=new Array(M),P=new Array(M),h=new Array(M),G=new Array(M),ot=new Array(M),at=new Array(M),st=T.words;st.length=M,this.convert13b(a.words,a.length,R,M),this.convert13b(v.words,v.length,G,M),this.transform(R,E,P,h,M,S),this.transform(G,E,ot,at,M,S);for(var ct=0;ct<M;ct++){var yt=P[ct]*ot[ct]-h[ct]*at[ct];h[ct]=P[ct]*at[ct]+h[ct]*ot[ct],P[ct]=yt}return this.conjugate(P,h,M),this.transform(P,h,st,E,M,S),this.conjugate(st,E,M),this.normalize13b(st,M),T.negative=a.negative^v.negative,T.length=a.length+v.length,T.strip()},i.prototype.mul=function(a){var v=new i(null);return v.words=new Array(this.length+a.length),this.mulTo(a,v)},i.prototype.mulf=function(a){var v=new i(null);return v.words=new Array(this.length+a.length),Y(this,a,v)},i.prototype.imul=function(a){return this.clone().mulTo(a,this)},i.prototype.imuln=function(a){n(typeof a=="number"),n(a<67108864);for(var v=0,T=0;T<this.length;T++){var M=(this.words[T]|0)*a,S=(M&67108863)+(v&67108863);v>>=26,v+=M/67108864|0,v+=S>>>26,this.words[T]=S&67108863}return v!==0&&(this.words[T]=v,this.length++),this.length=a===0?1:this.length,this},i.prototype.muln=function(a){return this.clone().imuln(a)},i.prototype.sqr=function(){return this.mul(this)},i.prototype.isqr=function(){return this.imul(this.clone())},i.prototype.pow=function(a){var v=C(a);if(v.length===0)return new i(1);for(var T=this,M=0;M<v.length&&v[M]===0;M++,T=T.sqr());if(++M<v.length)for(var S=T.sqr();M<v.length;M++,S=S.sqr())v[M]!==0&&(T=T.mul(S));return T},i.prototype.iushln=function(a){n(typeof a=="number"&&a>=0);var v=a%26,T=(a-v)/26,M=67108863>>>26-v<<26-v,S;if(v!==0){var E=0;for(S=0;S<this.length;S++){var R=this.words[S]&M,P=(this.words[S]|0)-R<<v;this.words[S]=P|E,E=R>>>26-v}E&&(this.words[S]=E,this.length++)}if(T!==0){for(S=this.length-1;S>=0;S--)this.words[S+T]=this.words[S];for(S=0;S<T;S++)this.words[S]=0;this.length+=T}return this.strip()},i.prototype.ishln=function(a){return n(this.negative===0),this.iushln(a)},i.prototype.iushrn=function(a,v,T){n(typeof a=="number"&&a>=0);var M;v?M=(v-v%26)/26:M=0;var S=a%26,E=Math.min((a-S)/26,this.length),R=67108863^67108863>>>S<<S,P=T;if(M-=E,M=Math.max(0,M),P){for(var h=0;h<E;h++)P.words[h]=this.words[h];P.length=E}if(E!==0)if(this.length>E)for(this.length-=E,h=0;h<this.length;h++)this.words[h]=this.words[h+E];else this.words[0]=0,this.length=1;var G=0;for(h=this.length-1;h>=0&&(G!==0||h>=M);h--){var ot=this.words[h]|0;this.words[h]=G<<26-S|ot>>>S,G=ot&R}return P&&G!==0&&(P.words[P.length++]=G),this.length===0&&(this.words[0]=0,this.length=1),this.strip()},i.prototype.ishrn=function(a,v,T){return n(this.negative===0),this.iushrn(a,v,T)},i.prototype.shln=function(a){return this.clone().ishln(a)},i.prototype.ushln=function(a){return this.clone().iushln(a)},i.prototype.shrn=function(a){return this.clone().ishrn(a)},i.prototype.ushrn=function(a){return this.clone().iushrn(a)},i.prototype.testn=function(a){n(typeof a=="number"&&a>=0);var v=a%26,T=(a-v)/26,M=1<<v;if(this.length<=T)return!1;var S=this.words[T];return!!(S&M)},i.prototype.imaskn=function(a){n(typeof a=="number"&&a>=0);var v=a%26,T=(a-v)/26;if(n(this.negative===0,"imaskn works only with positive numbers"),this.length<=T)return this;if(v!==0&&T++,this.length=Math.min(T,this.length),v!==0){var M=67108863^67108863>>>v<<v;this.words[this.length-1]&=M}return this.strip()},i.prototype.maskn=function(a){return this.clone().imaskn(a)},i.prototype.iaddn=function(a){return n(typeof a=="number"),n(a<67108864),a<0?this.isubn(-a):this.negative!==0?this.length===1&&(this.words[0]|0)<a?(this.words[0]=a-(this.words[0]|0),this.negative=0,this):(this.negative=0,this.isubn(a),this.negative=1,this):this._iaddn(a)},i.prototype._iaddn=function(a){this.words[0]+=a;for(var v=0;v<this.length&&this.words[v]>=67108864;v++)this.words[v]-=67108864,v===this.length-1?this.words[v+1]=1:this.words[v+1]++;return this.length=Math.max(this.length,v+1),this},i.prototype.isubn=function(a){if(n(typeof a=="number"),n(a<67108864),a<0)return this.iaddn(-a);if(this.negative!==0)return this.negative=0,this.iaddn(a),this.negative=1,this;if(this.words[0]-=a,this.length===1&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var v=0;v<this.length&&this.words[v]<0;v++)this.words[v]+=67108864,this.words[v+1]-=1;return this.strip()},i.prototype.addn=function(a){return this.clone().iaddn(a)},i.prototype.subn=function(a){return this.clone().isubn(a)},i.prototype.iabs=function(){return this.negative=0,this},i.prototype.abs=function(){return this.clone().iabs()},i.prototype._ishlnsubmul=function(a,v,T){var M=a.length+T,S;this._expand(M);var E,R=0;for(S=0;S<a.length;S++){E=(this.words[S+T]|0)+R;var P=(a.words[S]|0)*v;E-=P&67108863,R=(E>>26)-(P/67108864|0),this.words[S+T]=E&67108863}for(;S<this.length-T;S++)E=(this.words[S+T]|0)+R,R=E>>26,this.words[S+T]=E&67108863;if(R===0)return this.strip();for(n(R===-1),R=0,S=0;S<this.length;S++)E=-(this.words[S]|0)+R,R=E>>26,this.words[S]=E&67108863;return this.negative=1,this.strip()},i.prototype._wordDiv=function(a,v){var T=this.length-a.length,M=this.clone(),S=a,E=S.words[S.length-1]|0,R=this._countBits(E);T=26-R,T!==0&&(S=S.ushln(T),M.iushln(T),E=S.words[S.length-1]|0);var P=M.length-S.length,h;if(v!=="mod"){h=new i(null),h.length=P+1,h.words=new Array(h.length);for(var G=0;G<h.length;G++)h.words[G]=0}var ot=M.clone()._ishlnsubmul(S,1,P);ot.negative===0&&(M=ot,h&&(h.words[P]=1));for(var at=P-1;at>=0;at--){var st=(M.words[S.length+at]|0)*67108864+(M.words[S.length+at-1]|0);for(st=Math.min(st/E|0,67108863),M._ishlnsubmul(S,st,at);M.negative!==0;)st--,M.negative=0,M._ishlnsubmul(S,1,at),M.isZero()||(M.negative^=1);h&&(h.words[at]=st)}return h&&h.strip(),M.strip(),v!=="div"&&T!==0&&M.iushrn(T),{div:h||null,mod:M}},i.prototype.divmod=function(a,v,T){if(n(!a.isZero()),this.isZero())return{div:new i(0),mod:new i(0)};var M,S,E;return this.negative!==0&&a.negative===0?(E=this.neg().divmod(a,v),v!=="mod"&&(M=E.div.neg()),v!=="div"&&(S=E.mod.neg(),T&&S.negative!==0&&S.iadd(a)),{div:M,mod:S}):this.negative===0&&a.negative!==0?(E=this.divmod(a.neg(),v),v!=="mod"&&(M=E.div.neg()),{div:M,mod:E.mod}):(this.negative&a.negative)!==0?(E=this.neg().divmod(a.neg(),v),v!=="div"&&(S=E.mod.neg(),T&&S.negative!==0&&S.isub(a)),{div:E.div,mod:S}):a.length>this.length||this.cmp(a)<0?{div:new i(0),mod:this}:a.length===1?v==="div"?{div:this.divn(a.words[0]),mod:null}:v==="mod"?{div:null,mod:new i(this.modn(a.words[0]))}:{div:this.divn(a.words[0]),mod:new i(this.modn(a.words[0]))}:this._wordDiv(a,v)},i.prototype.div=function(a){return this.divmod(a,"div",!1).div},i.prototype.mod=function(a){return this.divmod(a,"mod",!1).mod},i.prototype.umod=function(a){return this.divmod(a,"mod",!0).mod},i.prototype.divRound=function(a){var v=this.divmod(a);if(v.mod.isZero())return v.div;var T=v.div.negative!==0?v.mod.isub(a):v.mod,M=a.ushrn(1),S=a.andln(1),E=T.cmp(M);return E<0||S===1&&E===0?v.div:v.div.negative!==0?v.div.isubn(1):v.div.iaddn(1)},i.prototype.modn=function(a){n(a<=67108863);for(var v=(1<<26)%a,T=0,M=this.length-1;M>=0;M--)T=(v*T+(this.words[M]|0))%a;return T},i.prototype.idivn=function(a){n(a<=67108863);for(var v=0,T=this.length-1;T>=0;T--){var M=(this.words[T]|0)+v*67108864;this.words[T]=M/a|0,v=M%a}return this.strip()},i.prototype.divn=function(a){return this.clone().idivn(a)},i.prototype.egcd=function(a){n(a.negative===0),n(!a.isZero());var v=this,T=a.clone();v.negative!==0?v=v.umod(a):v=v.clone();for(var M=new i(1),S=new i(0),E=new i(0),R=new i(1),P=0;v.isEven()&&T.isEven();)v.iushrn(1),T.iushrn(1),++P;for(var h=T.clone(),G=v.clone();!v.isZero();){for(var ot=0,at=1;(v.words[0]&at)===0&&ot<26;++ot,at<<=1);if(ot>0)for(v.iushrn(ot);ot-- >0;)(M.isOdd()||S.isOdd())&&(M.iadd(h),S.isub(G)),M.iushrn(1),S.iushrn(1);for(var st=0,ct=1;(T.words[0]&ct)===0&&st<26;++st,ct<<=1);if(st>0)for(T.iushrn(st);st-- >0;)(E.isOdd()||R.isOdd())&&(E.iadd(h),R.isub(G)),E.iushrn(1),R.iushrn(1);v.cmp(T)>=0?(v.isub(T),M.isub(E),S.isub(R)):(T.isub(v),E.isub(M),R.isub(S))}return{a:E,b:R,gcd:T.iushln(P)}},i.prototype._invmp=function(a){n(a.negative===0),n(!a.isZero());var v=this,T=a.clone();v.negative!==0?v=v.umod(a):v=v.clone();for(var M=new i(1),S=new i(0),E=T.clone();v.cmpn(1)>0&&T.cmpn(1)>0;){for(var R=0,P=1;(v.words[0]&P)===0&&R<26;++R,P<<=1);if(R>0)for(v.iushrn(R);R-- >0;)M.isOdd()&&M.iadd(E),M.iushrn(1);for(var h=0,G=1;(T.words[0]&G)===0&&h<26;++h,G<<=1);if(h>0)for(T.iushrn(h);h-- >0;)S.isOdd()&&S.iadd(E),S.iushrn(1);v.cmp(T)>=0?(v.isub(T),M.isub(S)):(T.isub(v),S.isub(M))}var ot;return v.cmpn(1)===0?ot=M:ot=S,ot.cmpn(0)<0&&ot.iadd(a),ot},i.prototype.gcd=function(a){if(this.isZero())return a.abs();if(a.isZero())return this.abs();var v=this.clone(),T=a.clone();v.negative=0,T.negative=0;for(var M=0;v.isEven()&&T.isEven();M++)v.iushrn(1),T.iushrn(1);do{for(;v.isEven();)v.iushrn(1);for(;T.isEven();)T.iushrn(1);var S=v.cmp(T);if(S<0){var E=v;v=T,T=E}else if(S===0||T.cmpn(1)===0)break;v.isub(T)}while(!0);return T.iushln(M)},i.prototype.invm=function(a){return this.egcd(a).a.umod(a)},i.prototype.isEven=function(){return(this.words[0]&1)===0},i.prototype.isOdd=function(){return(this.words[0]&1)===1},i.prototype.andln=function(a){return this.words[0]&a},i.prototype.bincn=function(a){n(typeof a=="number");var v=a%26,T=(a-v)/26,M=1<<v;if(this.length<=T)return this._expand(T+1),this.words[T]|=M,this;for(var S=M,E=T;S!==0&&E<this.length;E++){var R=this.words[E]|0;R+=S,S=R>>>26,R&=67108863,this.words[E]=R}return S!==0&&(this.words[E]=S,this.length++),this},i.prototype.isZero=function(){return this.length===1&&this.words[0]===0},i.prototype.cmpn=function(a){var v=a<0;if(this.negative!==0&&!v)return-1;if(this.negative===0&&v)return 1;this.strip();var T;if(this.length>1)T=1;else{v&&(a=-a),n(a<=67108863,"Number is too big");var M=this.words[0]|0;T=M===a?0:M<a?-1:1}return this.negative!==0?-T|0:T},i.prototype.cmp=function(a){if(this.negative!==0&&a.negative===0)return-1;if(this.negative===0&&a.negative!==0)return 1;var v=this.ucmp(a);return this.negative!==0?-v|0:v},i.prototype.ucmp=function(a){if(this.length>a.length)return 1;if(this.length<a.length)return-1;for(var v=0,T=this.length-1;T>=0;T--){var M=this.words[T]|0,S=a.words[T]|0;if(M!==S){M<S?v=-1:M>S&&(v=1);break}}return v},i.prototype.gtn=function(a){return this.cmpn(a)===1},i.prototype.gt=function(a){return this.cmp(a)===1},i.prototype.gten=function(a){return this.cmpn(a)>=0},i.prototype.gte=function(a){return this.cmp(a)>=0},i.prototype.ltn=function(a){return this.cmpn(a)===-1},i.prototype.lt=function(a){return this.cmp(a)===-1},i.prototype.lten=function(a){return this.cmpn(a)<=0},i.prototype.lte=function(a){return this.cmp(a)<=0},i.prototype.eqn=function(a){return this.cmpn(a)===0},i.prototype.eq=function(a){return this.cmp(a)===0},i.red=function(a){return new J(a)},i.prototype.toRed=function(a){return n(!this.red,"Already a number in reduction context"),n(this.negative===0,"red works only with positives"),a.convertTo(this)._forceRed(a)},i.prototype.fromRed=function(){return n(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},i.prototype._forceRed=function(a){return this.red=a,this},i.prototype.forceRed=function(a){return n(!this.red,"Already a number in reduction context"),this._forceRed(a)},i.prototype.redAdd=function(a){return n(this.red,"redAdd works only with red numbers"),this.red.add(this,a)},i.prototype.redIAdd=function(a){return n(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,a)},i.prototype.redSub=function(a){return n(this.red,"redSub works only with red numbers"),this.red.sub(this,a)},i.prototype.redISub=function(a){return n(this.red,"redISub works only with red numbers"),this.red.isub(this,a)},i.prototype.redShl=function(a){return n(this.red,"redShl works only with red numbers"),this.red.shl(this,a)},i.prototype.redMul=function(a){return n(this.red,"redMul works only with red numbers"),this.red._verify2(this,a),this.red.mul(this,a)},i.prototype.redIMul=function(a){return n(this.red,"redMul works only with red numbers"),this.red._verify2(this,a),this.red.imul(this,a)},i.prototype.redSqr=function(){return n(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},i.prototype.redISqr=function(){return n(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},i.prototype.redSqrt=function(){return n(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},i.prototype.redInvm=function(){return n(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},i.prototype.redNeg=function(){return n(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},i.prototype.redPow=function(a){return n(this.red&&!a.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,a)};var W={k256:null,p224:null,p192:null,p25519:null};function H(D,a){this.name=D,this.p=new i(a,16),this.n=this.p.bitLength(),this.k=new i(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}H.prototype._tmp=function(){var a=new i(null);return a.words=new Array(Math.ceil(this.n/13)),a},H.prototype.ireduce=function(a){var v=a,T;do this.split(v,this.tmp),v=this.imulK(v),v=v.iadd(this.tmp),T=v.bitLength();while(T>this.n);var M=T<this.n?-1:v.ucmp(this.p);return M===0?(v.words[0]=0,v.length=1):M>0?v.isub(this.p):v.strip!==void 0?v.strip():v._strip(),v},H.prototype.split=function(a,v){a.iushrn(this.n,0,v)},H.prototype.imulK=function(a){return a.imul(this.k)};function j(){H.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}r(j,H),j.prototype.split=function(a,v){for(var T=4194303,M=Math.min(a.length,9),S=0;S<M;S++)v.words[S]=a.words[S];if(v.length=M,a.length<=9){a.words[0]=0,a.length=1;return}var E=a.words[9];for(v.words[v.length++]=E&T,S=10;S<a.length;S++){var R=a.words[S]|0;a.words[S-10]=(R&T)<<4|E>>>22,E=R}E>>>=22,a.words[S-10]=E,E===0&&a.length>10?a.length-=10:a.length-=9},j.prototype.imulK=function(a){a.words[a.length]=0,a.words[a.length+1]=0,a.length+=2;for(var v=0,T=0;T<a.length;T++){var M=a.words[T]|0;v+=M*977,a.words[T]=v&67108863,v=M*64+(v/67108864|0)}return a.words[a.length-1]===0&&(a.length--,a.words[a.length-1]===0&&a.length--),a};function K(){H.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}r(K,H);function tt(){H.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}r(tt,H);function ut(){H.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}r(ut,H),ut.prototype.imulK=function(a){for(var v=0,T=0;T<a.length;T++){var M=(a.words[T]|0)*19+v,S=M&67108863;M>>>=26,a.words[T]=S,v=M}return v!==0&&(a.words[a.length++]=v),a},i._prime=function(a){if(W[a])return W[a];var v;if(a==="k256")v=new j;else if(a==="p224")v=new K;else if(a==="p192")v=new tt;else if(a==="p25519")v=new ut;else throw new Error("Unknown prime "+a);return W[a]=v,v};function J(D){if(typeof D=="string"){var a=i._prime(D);this.m=a.p,this.prime=a}else n(D.gtn(1),"modulus must be greater than 1"),this.m=D,this.prime=null}J.prototype._verify1=function(a){n(a.negative===0,"red works only with positives"),n(a.red,"red works only with red numbers")},J.prototype._verify2=function(a,v){n((a.negative|v.negative)===0,"red works only with positives"),n(a.red&&a.red===v.red,"red works only with red numbers")},J.prototype.imod=function(a){return this.prime?this.prime.ireduce(a)._forceRed(this):a.umod(this.m)._forceRed(this)},J.prototype.neg=function(a){return a.isZero()?a.clone():this.m.sub(a)._forceRed(this)},J.prototype.add=function(a,v){this._verify2(a,v);var T=a.add(v);return T.cmp(this.m)>=0&&T.isub(this.m),T._forceRed(this)},J.prototype.iadd=function(a,v){this._verify2(a,v);var T=a.iadd(v);return T.cmp(this.m)>=0&&T.isub(this.m),T},J.prototype.sub=function(a,v){this._verify2(a,v);var T=a.sub(v);return T.cmpn(0)<0&&T.iadd(this.m),T._forceRed(this)},J.prototype.isub=function(a,v){this._verify2(a,v);var T=a.isub(v);return T.cmpn(0)<0&&T.iadd(this.m),T},J.prototype.shl=function(a,v){return this._verify1(a),this.imod(a.ushln(v))},J.prototype.imul=function(a,v){return this._verify2(a,v),this.imod(a.imul(v))},J.prototype.mul=function(a,v){return this._verify2(a,v),this.imod(a.mul(v))},J.prototype.isqr=function(a){return this.imul(a,a.clone())},J.prototype.sqr=function(a){return this.mul(a,a)},J.prototype.sqrt=function(a){if(a.isZero())return a.clone();var v=this.m.andln(3);if(n(v%2===1),v===3){var T=this.m.add(new i(1)).iushrn(2);return this.pow(a,T)}for(var M=this.m.subn(1),S=0;!M.isZero()&&M.andln(1)===0;)S++,M.iushrn(1);n(!M.isZero());var E=new i(1).toRed(this),R=E.redNeg(),P=this.m.subn(1).iushrn(1),h=this.m.bitLength();for(h=new i(2*h*h).toRed(this);this.pow(h,P).cmp(R)!==0;)h.redIAdd(R);for(var G=this.pow(h,M),ot=this.pow(a,M.addn(1).iushrn(1)),at=this.pow(a,M),st=S;at.cmp(E)!==0;){for(var ct=at,yt=0;ct.cmp(E)!==0;yt++)ct=ct.redSqr();n(yt<st);var pt=this.pow(G,new i(1).iushln(st-yt-1));ot=ot.redMul(pt),G=pt.redSqr(),at=at.redMul(G),st=yt}return ot},J.prototype.invm=function(a){var v=a._invmp(this.m);return v.negative!==0?(v.negative=0,this.imod(v).redNeg()):this.imod(v)},J.prototype.pow=function(a,v){if(v.isZero())return new i(1).toRed(this);if(v.cmpn(1)===0)return a.clone();var T=4,M=new Array(1<<T);M[0]=new i(1).toRed(this),M[1]=a;for(var S=2;S<M.length;S++)M[S]=this.mul(M[S-1],a);var E=M[0],R=0,P=0,h=v.bitLength()%26;for(h===0&&(h=26),S=v.length-1;S>=0;S--){for(var G=v.words[S],ot=h-1;ot>=0;ot--){var at=G>>ot&1;if(E!==M[0]&&(E=this.sqr(E)),at===0&&R===0){P=0;continue}R<<=1,R|=at,P++,!(P!==T&&(S!==0||ot!==0))&&(E=this.mul(E,M[R]),P=0,R=0)}h=26}return E},J.prototype.convertTo=function(a){var v=a.umod(this.m);return v===a?v.clone():v},J.prototype.convertFrom=function(a){var v=a.clone();return v.red=null,v},i.mont=function(a){return new rt(a)};function rt(D){J.call(this,D),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new i(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}r(rt,J),rt.prototype.convertTo=function(a){return this.imod(a.ushln(this.shift))},rt.prototype.convertFrom=function(a){var v=this.imod(a.mul(this.rinv));return v.red=null,v},rt.prototype.imul=function(a,v){if(a.isZero()||v.isZero())return a.words[0]=0,a.length=1,a;var T=a.imul(v),M=T.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),S=T.isub(M).iushrn(this.shift),E=S;return S.cmp(this.m)>=0?E=S.isub(this.m):S.cmpn(0)<0&&(E=S.iadd(this.m)),E._forceRed(this)},rt.prototype.mul=function(a,v){if(a.isZero()||v.isZero())return new i(0)._forceRed(this);var T=a.mul(v),M=T.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),S=T.isub(M).iushrn(this.shift),E=S;return S.cmp(this.m)>=0?E=S.isub(this.m):S.cmpn(0)<0&&(E=S.iadd(this.m)),E._forceRed(this)},rt.prototype.invm=function(a){var v=this.imod(a._invmp(this.m).mul(this.r2));return v._forceRed(this)}})(typeof Vn>"u"||Vn,ra)});var qn=xt((L1,na)=>{"use strict";var E1=or();na.exports=gc;function gc(t){return t&&typeof t=="object"&&!!t.words}});var aa=xt((z1,oa)=>{"use strict";var ia=qn();oa.exports=wc;function wc(t){return Array.isArray(t)&&t.length===2&&ia(t[0])&&ia(t[1])}});var Ar=xt((R1,Ct)=>{var Nn=!1;if(typeof Float64Array<"u")if(fe=new Float64Array(1),re=new Uint32Array(fe.buffer),fe[0]=1,Nn=!0,re[1]===1072693248){let t=function(r,i){return re[0]=r,re[1]=i,fe[0]},e=function(r){return fe[0]=r,re[0]},n=function(r){return fe[0]=r,re[1]};xc=t,yc=e,Mc=n,Ct.exports=function(i){return fe[0]=i,[re[0],re[1]]},Ct.exports.pack=t,Ct.exports.lo=e,Ct.exports.hi=n}else if(re[0]===1072693248){let t=function(r,i){return re[1]=r,re[0]=i,fe[0]},e=function(r){return fe[0]=r,re[1]},n=function(r){return fe[0]=r,re[0]};bc=t,Tc=e,_c=n,Ct.exports=function(i){return fe[0]=i,[re[1],re[0]]},Ct.exports.pack=t,Ct.exports.lo=e,Ct.exports.hi=n}else Nn=!1;var fe,re,xc,yc,Mc,bc,Tc,_c;if(!Nn){let t=function(r,i){return le.writeUInt32LE(r,0,!0),le.writeUInt32LE(i,4,!0),le.readDoubleLE(0,!0)},e=function(r){return le.writeDoubleLE(r,0,!0),le.readUInt32LE(0,!0)},n=function(r){return le.writeDoubleLE(r,0,!0),le.readUInt32LE(4,!0)};Sc=t,Bc=e,Pc=n,le=new Buffer(8),Ct.exports=function(i){return le.writeDoubleLE(i,0,!0),[le.readUInt32LE(0,!0),le.readUInt32LE(4,!0)]},Ct.exports.pack=t,Ct.exports.lo=e,Ct.exports.hi=n}var le,Sc,Bc,Pc;Ct.exports.sign=function(t){return Ct.exports.hi(t)>>>31};Ct.exports.exponent=function(t){var e=Ct.exports.hi(t);return(e<<1>>>21)-1023};Ct.exports.fraction=function(t){var e=Ct.exports.lo(t),n=Ct.exports.hi(t),r=n&(1<<20)-1;return n&2146435072&&(r+=1<<20),[e,r]};Ct.exports.denormalized=function(t){var e=Ct.exports.hi(t);return!(e&2146435072)}});var Cn=xt((m1,ua)=>{"use strict";var sa=or(),Dc=Ar();ua.exports=Uc;function Uc(t){var e=Dc.exponent(t);return e<52?new sa(t):new sa(t*Math.pow(2,52-e)).ushln(e-52)}});var fa=xt((O1,ca)=>{"use strict";var Gc=or();ca.exports=Fc;function Fc(t){return new Gc(t)}});var Er=xt((V1,la)=>{"use strict";var Ic=or();la.exports=Ac;function Ac(t){return t.cmp(new Ic(0))}});var Xe=xt((q1,pa)=>{"use strict";var Lr=Cn(),ha=Er();pa.exports=Ec;function Ec(t,e){var n=ha(t),r=ha(e);if(n===0)return[Lr(0),Lr(1)];if(r===0)return[Lr(0),Lr(0)];r<0&&(t=t.neg(),e=e.neg());var i=t.gcd(e);return i.cmpn(1)?[t.div(i),e.div(i)]:[t,e]}});var kn=xt((N1,va)=>{"use strict";var Lc=Xe();va.exports=zc;function zc(t,e){return Lc(t[0].mul(e[1]),t[1].mul(e[0]))}});var zr=xt((C1,ya)=>{"use strict";var da=aa(),ga=qn(),Ie=Cn(),wa=fa(),Rc=Xe(),mc=kn();ya.exports=xa;function xa(t,e){if(da(t))return e?mc(t,xa(e)):[t[0].clone(),t[1].clone()];var n=0,r,i;if(ga(t))r=t.clone();else if(typeof t=="string")r=wa(t);else{if(t===0)return[Ie(0),Ie(1)];if(t===Math.floor(t))r=Ie(t);else{for(;t!==Math.floor(t);)t=t*Math.pow(2,256),n-=256;r=Ie(t)}}if(da(e))r.mul(e[1]),i=e[0].clone();else if(ga(e))i=e.clone();else if(typeof e=="string")i=wa(e);else if(!e)i=Ie(1);else if(e===Math.floor(e))i=Ie(e);else{for(;e!==Math.floor(e);)e=e*Math.pow(2,256),n+=256;i=Ie(e)}return n>0?r=r.ushln(n):n<0&&(i=i.ushln(-n)),Rc(r,i)}});var ba=xt((k1,Ma)=>{"use strict";Ma.exports=Oc;function Oc(t,e){return t[0].mul(e[1]).cmp(e[0].mul(t[1]))}});var _a=xt((Y1,Ta)=>{"use strict";var Vc=Er();Ta.exports=qc;function qc(t){var e=t.length,n=t.words,r=0;if(e===1)r=n[0];else if(e===2)r=n[0]+n[1]*67108864;else for(var i=0;i<e;i++){var o=n[i];r+=o*Math.pow(67108864,i)}return Vc(t)*r}});var Da=xt((X1,Pa)=>{"use strict";var Sa=Ar(),Ba=je().countTrailingZeros;Pa.exports=Nc;function Nc(t){var e=Ba(Sa.lo(t));if(e<32)return e;var n=Ba(Sa.hi(t));return n>20?52:n+32}});var Ga=xt((H1,Ua)=>{"use strict";var Yn=_a(),Cc=Da();Ua.exports=kc;function kc(t){var e=t[0],n=t[1];if(e.cmpn(0)===0)return 0;var r=e.abs().divmod(n.abs()),i=r.div,o=Yn(i),s=r.mod,c=e.negative!==n.negative?-1:1;if(s.cmpn(0)===0)return c*o;if(o){var f=Cc(o)+4,p=Yn(s.ushln(f).divRound(n));return c*(o+p*Math.pow(2,-f))}else{var g=n.bitLength()-s.bitLength()+53,p=Yn(s.ushln(g).divRound(n));return g<1023?c*p*Math.pow(2,-g):(p*=Math.pow(2,-1023),c*p*Math.pow(2,1023-g))}}});var Ia=xt((Z1,Fa)=>{"use strict";Fa.exports=Xc;var Yc=zr();function Xc(t){for(var e=new Array(t.length),n=0;n<t.length;++n)e[n]=Yc(t[n]);return e}});var za=xt(($1,La)=>{"use strict";var Xn=Ar(),Aa=Math.pow(2,-1074),Ea=-1>>>0;La.exports=Hc;function Hc(t,e){if(isNaN(t)||isNaN(e))return NaN;if(t===e)return t;if(t===0)return e<0?-Aa:Aa;var n=Xn.hi(t),r=Xn.lo(t);return e>t==t>0?r===Ea?(n+=1,r=0):r+=1:r===0?(r=Ea,n-=1):r-=1,Xn.pack(r,n)}});var Hn=xt((W1,Ra)=>{"use strict";var Zc=Xe();Ra.exports=$c;function $c(t,e){return Zc(t[0].mul(e[0]),t[1].mul(e[1]))}});var Zn=xt((Q1,ma)=>{"use strict";var Wc=Xe();ma.exports=Qc;function Qc(t,e){return Wc(t[0].mul(e[1]).sub(t[1].mul(e[0])),t[1].mul(e[1]))}});var qa=xt((K1,Va)=>{"use strict";var Oa=Er();Va.exports=Kc;function Kc(t){return Oa(t[0])*Oa(t[1])}});var Ca=xt((J1,Na)=>{"use strict";var Jc=Zn();Na.exports=jc;function jc(t,e){for(var n=t.length,r=new Array(n),i=0;i<n;++i)r[i]=Jc(t[i],e[i]);return r}});var Ya=xt((j1,ka)=>{"use strict";var tf=Xe();ka.exports=ef;function ef(t,e){return tf(t[0].mul(e[1]).add(e[0].mul(t[1])),t[1].mul(e[1]))}});var Ha=xt((th,Xa)=>{"use strict";var rf=Ya();Xa.exports=nf;function nf(t,e){for(var n=t.length,r=new Array(n),i=0;i<n;++i)r[i]=rf(t[i],e[i]);return r}});var $a=xt((eh,Za)=>{"use strict";var of=zr(),af=Hn();Za.exports=sf;function sf(t,e){for(var n=of(e),r=t.length,i=new Array(r),o=0;o<r;++o)i[o]=af(t[o],n);return i}});var Ja=xt((rh,Ka)=>{"use strict";Ka.exports=pf;var Wa=Hn(),uf=kn(),cf=Zn(),ff=qa(),$n=Ca(),lf=Ha(),hf=$a();function Qa(t,e){return cf(Wa(t[0],e[1]),Wa(t[1],e[0]))}function pf(t,e,n,r){var i=$n(e,t),o=$n(r,n),s=Qa(i,o);if(ff(s)===0)return null;var c=$n(t,n),f=Qa(o,c),p=uf(f,s),g=hf(i,p),F=lf(t,g);return F}});var ss=xt((nh,as)=>{"use strict";as.exports=Sf;var vf=co(),Qn=Jo(),rs=ta(),ja=zr(),ts=ba(),Wn=Ga(),Rr=Ia(),oe=za(),df=Ja();function es(t){var e=Wn(t);return[oe(e,-1/0),oe(e,1/0)]}function gf(t,e){for(var n=new Array(e.length),r=0;r<e.length;++r){var i=e[r],o=t[i[0]],s=t[i[1]];n[r]=[oe(Math.min(o[0],s[0]),-1/0),oe(Math.min(o[1],s[1]),-1/0),oe(Math.max(o[0],s[0]),1/0),oe(Math.max(o[1],s[1]),1/0)]}return n}function ns(t){for(var e=new Array(t.length),n=0;n<t.length;++n){var r=t[n];e[n]=[oe(r[0],-1/0),oe(r[1],-1/0),oe(r[0],1/0),oe(r[1],1/0)]}return e}function wf(t,e,n){var r=[];return Qn(n,function(i,o){var s=e[i],c=e[o];if(!(s[0]===c[0]||s[0]===c[1]||s[1]===c[0]||s[1]===c[1])){var f=t[s[0]],p=t[s[1]],g=t[c[0]],F=t[c[1]];rs(f,p,g,F)&&r.push([i,o])}}),r}function xf(t,e,n,r){var i=[];return Qn(n,r,function(o,s){var c=e[o];if(!(c[0]===s||c[1]===s)){var f=t[s],p=t[c[0]],g=t[c[1]];rs(p,g,f,f)&&i.push([o,s])}}),i}function yf(t,e,n,r,i){var o,s,c=t.map(function(J){return[ja(J[0]),ja(J[1])]});for(o=0;o<n.length;++o){var f=n[o];s=f[0];var p=f[1],g=e[s],F=e[p],C=df(Rr(t[g[0]]),Rr(t[g[1]]),Rr(t[F[0]]),Rr(t[F[1]]));if(C){var N=t.length;t.push([Wn(C[0]),Wn(C[1])]),c.push(C),r.push([s,N],[p,N])}}for(r.sort(function(J,rt){if(J[0]!==rt[0])return J[0]-rt[0];var D=c[J[1]],a=c[rt[1]];return ts(D[0],a[0])||ts(D[1],a[1])}),o=r.length-1;o>=0;--o){var m=r[o];s=m[0];var V=e[s],Y=V[0],et=V[1],W=t[Y],H=t[et];if((W[0]-H[0]||W[1]-H[1])<0){var j=Y;Y=et,et=j}V[0]=Y;var K=V[1]=m[1],tt;for(i&&(tt=V[2]);o>0&&r[o-1][0]===s;){var m=r[--o],ut=m[1];i?e.push([K,ut,tt]):e.push([K,ut]),K=ut}i?e.push([K,et,tt]):e.push([K,et])}return c}function is(t,e,n){for(var r=e.length,i=new vf(r),o=[],s=0;s<e.length;++s){var c=e[s],f=es(c[0]),p=es(c[1]);o.push([oe(f[0],-1/0),oe(p[0],-1/0),oe(f[1],1/0),oe(p[1],1/0)])}Qn(o,function(m,V){i.link(m,V)});for(var g=!0,F=new Array(r),s=0;s<r;++s){var C=i.find(s);C!==s&&(g=!1,t[C]=[Math.min(t[s][0],t[C][0]),Math.min(t[s][1],t[C][1])])}if(g)return null;for(var N=0,s=0;s<r;++s){var C=i.find(s);C===s?(F[s]=N,t[N++]=t[s]):F[s]=-1}t.length=N;for(var s=0;s<r;++s)F[s]<0&&(F[s]=F[i.find(s)]);return F}function Mf(t,e){return t[0]-e[0]||t[1]-e[1]}function bf(t,e){var n=t[0]-e[0]||t[1]-e[1];return n||(t[2]<e[2]?-1:t[2]>e[2]?1:0)}function os(t,e,n){if(t.length!==0){if(e)for(var r=0;r<t.length;++r){var i=t[r],o=e[i[0]],s=e[i[1]];i[0]=Math.min(o,s),i[1]=Math.max(o,s)}else for(var r=0;r<t.length;++r){var i=t[r],o=i[0],s=i[1];i[0]=Math.min(o,s),i[1]=Math.max(o,s)}n?t.sort(bf):t.sort(Mf);for(var c=1,r=1;r<t.length;++r){var f=t[r-1],p=t[r];p[0]===f[0]&&p[1]===f[1]&&(!n||p[2]===f[2])||(t[c++]=p)}t.length=c}}function Tf(t,e,n){var r=is(t,[],ns(t));return os(e,r,n),!!r}function _f(t,e,n){var r=gf(t,e),i=wf(t,e,r),o=ns(t),s=xf(t,e,r,o),c=yf(t,e,i,s,n),f=is(t,c,o);return os(e,f,n),f?!0:i.length>0||s.length>0}function Sf(t,e,n){var r;if(n){r=e;for(var i=new Array(e.length),o=0;o<e.length;++o){var s=e[o];i[o]=[s[0],s[1],n[o]]}e=i}for(var c=Tf(t,e,!!n);_f(t,e,!!n);)c=!0;if(n&&c){r.length=0,n.length=0;for(var o=0;o<e.length;++o){var s=e[o];r.push([s[0],s[1]]),n.push(s[2])}}return c}});function ne(t,e,n,r,i,o,s){let c=t.createTexture({label:e,size:{width:n,height:r},format:o,usage:s,mipLevelCount:i,sampleCount:1,dimension:"2d"}),f=c.createView(),p=[];for(let F=0;F<i;F++)p.push(c.createView({label:e,format:o,dimension:"2d",aspect:"all",baseMipLevel:F,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let g=t.createSampler({label:`${e} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:n,height:r},texture:c,view:f,mip_view:p,sampler:g}}async function he(t,e,n,r="rgba8unorm"){let o=await(await fetch(n)).blob(),s=await createImageBitmap(o),c=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,p=ne(t.device,e,s.width,s.height,1,r,c);t.device.queue.copyExternalImageToTexture({source:s},{texture:p.texture},{width:s.width,height:s.height});let g={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return p.sampler=t.device.createSampler(g),p}function He(t,e,n,r="rgba8unorm"){let i=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,s=ne(t.device,e,n.width,n.height,1,r,i);t.device.queue.writeTexture({texture:s.texture},n.data,{bytesPerRow:4*n.width},{width:n.width,height:n.height});let c={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return s.sampler=t.device.createSampler(c),s}var ni="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var ue=7,Gs=0,ii=1,Fs=2,oi=3,ai={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(t,e={}){return Is(t,e)},onRun:function(t,e,n){As(t,e.data,n)},onDestroy:function(t,e){ui(e)},onResize:function(t,e){Es(t,e)},onViewportPosition:function(t,e){}};function Is(t,e){let{device:n}=t,r=t.viewport.width,i=t.viewport.height,o={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},s=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});o.bind_group_layout.push(s),o.bind_groups_textures.push(ne(n,"bloom downsampler image 0",r/2,i/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),o.bind_groups_textures.push(ne(n,"bloom downsampler image 1",r/2,i/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),o.bind_groups_textures.push(e.refs.bloom.data);let c=n.createPipelineLayout({bindGroupLayouts:o.bind_group_layout}),f=n.createComputePipeline({layout:c,compute:{module:n.createShaderModule({code:ni}),entryPoint:"cs_main"}});return si(t,o,e),o.compute_pipeline=f,o}function si(t,e,n){let{refs:r}=n,{device:i}=t,o=n.options.bloom_threshold??.1,s=n.options.bloom_knee??.2,c=n.options.bloom_combine_constant??.68,f=new Float32Array([o,o-s,s*2,.25/s,c,0,0,0]),p=i.createBuffer({label:"bloom static parameters buffer",size:f.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(p.getMappedRange()).set(f),p.unmap(),e.bind_group.length=0,e.params_buf=p,e.bind_group.push(Re(i,e,e.bind_groups_textures[0].mip_view[0],r.emissive.data.view,r.hdr.data.view,r.hdr.data.sampler,p,Gs<<16|0));for(let F=1;F<ue;F++)e.bind_group.push(Re(i,e,e.bind_groups_textures[1].mip_view[F],e.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,p,ii<<16|F-1)),e.bind_group.push(Re(i,e,e.bind_groups_textures[0].mip_view[F],e.bind_groups_textures[1].view,r.hdr.data.view,r.hdr.data.sampler,p,ii<<16|F));e.bind_group.push(Re(i,e,e.bind_groups_textures[2].mip_view[ue-1],e.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,p,Fs<<16|ue-2));let g=!0;for(let F=ue-2;F>=0;F--)g?(e.bind_group.push(Re(i,e,e.bind_groups_textures[1].mip_view[F],e.bind_groups_textures[0].view,e.bind_groups_textures[2].view,r.hdr.data.sampler,p,oi<<16|F)),g=!1):(e.bind_group.push(Re(i,e,e.bind_groups_textures[2].mip_view[F],e.bind_groups_textures[0].view,e.bind_groups_textures[1].view,r.hdr.data.sampler,p,oi<<16|F)),g=!0)}function Re(t,e,n,r,i,o,s,c){let f=new Uint32Array([c]),p=t.createBuffer({label:"bloom static mode_lod buffer",size:f.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(p.getMappedRange()).set(f),p.unmap(),t.createBindGroup({label:"bloom bind group layout",layout:e.bind_group_layout[0],entries:[{binding:0,resource:n},{binding:1,resource:r},{binding:2,resource:i},{binding:3,resource:o},{binding:4,resource:{buffer:s}},{binding:5,resource:{buffer:p}}]})}function As(t,e,n){let c=0,f=n.beginComputePass({label:"bloom Compute Pass"});f.setPipeline(e.compute_pipeline),f.setBindGroup(0,e.bind_group[c]),c+=1;let p=ar(0,e.bind_groups_textures[0]);f.dispatchWorkgroups(p.width/8+1,p.height/4+1,1);for(let g=1;g<ue;g++)p=ar(g,e.bind_groups_textures[0]),f.setBindGroup(0,e.bind_group[c]),c+=1,f.dispatchWorkgroups(p.width/8+1,p.height/4+1,1),f.setBindGroup(0,e.bind_group[c]),c+=1,f.dispatchWorkgroups(p.width/8+1,p.height/4+1,1);f.setBindGroup(0,e.bind_group[c]),c+=1,p=ar(ue-1,e.bind_groups_textures[2]),f.dispatchWorkgroups(p.width/8+1,p.height/4+1,1);for(let g=ue-2;g>=0;g--)p=ar(g,e.bind_groups_textures[2]),f.setBindGroup(0,e.bind_group[c]),c+=1,f.dispatchWorkgroups(p.width/8+1,p.height/4+1,1);f.end()}function ar(t,e){let n=e.size.width,r=e.size.height;for(let i=0;i<t;i++)n/=2,r/=2;return{width:n,height:r,depthOrArrayLayers:1}}function Es(t,e){let{device:n}=t,r=e.data;ui(r),r.bind_groups_textures.push(ne(n,"bloom downsampler image 0",t.viewport.width/2,t.viewport.height/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(ne(n,"bloom downsampler image 1",t.viewport.width/2,t.viewport.height/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(e.refs.bloom.data),si(t,r,e)}function ui(t){for(let e of t.bind_groups_textures)e.texture.destroy();t.bind_groups_textures.length=0}var an="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var ci={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Ls(t,e)},onRun:function(t,e,n){zs(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){Rs(t,e)},onViewportPosition:function(t,e){}};function Ls(t,e){let{options:n,refs:r}=e,{device:i}=t,o=fi(t),s=n.bloom_intensity??40,c=n.bloom_combine_constant??.68,f=new Float32Array([s,c]),p=i.createBuffer({label:"scene composite params buffer",size:f.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(p.getMappedRange()).set(f),p.unmap();let g=i.createRenderPipeline({layout:"auto",vertex:{module:i.createShaderModule({code:an}),entryPoint:"vert_main"},fragment:{module:i.createShaderModule({code:an}),entryPoint:"frag_main",targets:[{format:o}]},primitive:{topology:"triangle-list"}});return{bindGroup:i.createBindGroup({layout:g.getBindGroupLayout(0),entries:[{binding:0,resource:r.hdr.data.sampler},{binding:1,resource:r.hdr.data.view},{binding:2,resource:r.bloom.data.mip_view[0]},{binding:3,resource:{buffer:p}}]}),pipeline:g,params_buf:p}}function zs(t,e,n){let r=n.beginRenderPass({colorAttachments:[{view:e.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:i,bindGroup:o}=e.data;r.setPipeline(i),r.setBindGroup(0,o),r.draw(3),r.end()}function Rs(t,e){let{pipeline:n,params_buf:r}=e.data,{device:i}=t;e.data.bindGroup=i.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:e.refs.hdr.data.sampler},{binding:1,resource:e.refs.hdr.data.view},{binding:2,resource:e.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:r}}]})}var $e={};ei($e,{addSprite:()=>Os,clear:()=>qs,removeSprite:()=>Vs,setSprite:()=>Zs,setSpriteName:()=>Ns,setSpriteOpacity:()=>Ys,setSpritePosition:()=>Cs,setSpriteRotation:()=>Xs,setSpriteScale:()=>Hs,setSpriteTint:()=>ks});function sn(t,e,n){if(n.spriteCount===0)return 0;let r=0,i=n.spriteCount-1,o=t<<16&16711680|e&65535;for(;r<=i;){let s=n.spriteData[r*12+11];if(o<=s)return r;let c=n.spriteData[i*12+11];if(o>=c)return i+1;let f=Math.floor((r+i)/2),p=n.spriteData[f*12+11];if(o===p)return f+1;o>p?r=f+1:i=f-1}return r}function Ze(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function Os(t,e,n,r,i,o,s,c,f){let p=e.refs.spritesheet.data.spritesheet;e=e.data;let g=p.locations.indexOf(n),F=sn(f,g,e),C=(F+1)*12;e.spriteData.set(e.spriteData.subarray(F*12,e.spriteCount*12),C),li(e,p,F,n,r,i,o,s,c,f);for(let[m,V]of e.spriteIndices)V>=F&&e.spriteIndices.set(m,V+1);let N=Ze();return e.spriteIndices.set(N,F),e.spriteCount++,e.dirty=!0,N}function Vs(t,e,n){e=e.data;let r=e.spriteIndices.get(n);for(let[o,s]of e.spriteIndices)s>r&&e.spriteIndices.set(o,s-1);let i=r*12;e.spriteData.set(e.spriteData.subarray((r+1)*12,e.spriteCount*12),i),e.spriteIndices.delete(n),e.spriteCount--,e.dirty=!0}function qs(t,e){e=e.data,e.spriteIndices.clear(),e.spriteCount=0,e.instancedDrawCallCount=0,e.dirty=!0}function Ns(t,e,n,r,i){let o=e.refs.spritesheet.data.spritesheet;e=e.data;let s=o.locations.indexOf(r),c=o.spriteMeta[r].w,f=o.spriteMeta[r].h,g=e.spriteIndices.get(n)*12;e.spriteData[g+2]=c*i[0],e.spriteData[g+3]=f*i[1];let C=(e.spriteData[g+11]>>16&255)<<16&16711680|s&65535;e.spriteData[g+11]=C,e.dirty=!0}function Cs(t,e,n,r){e=e.data;let o=e.spriteIndices.get(n)*12;e.spriteData[o]=r[0],e.spriteData[o+1]=r[1],e.dirty=!0}function ks(t,e,n,r){e=e.data;let o=e.spriteIndices.get(n)*12;e.spriteData[o+4]=r[0],e.spriteData[o+5]=r[1],e.spriteData[o+6]=r[2],e.spriteData[o+7]=r[3],e.dirty=!0}function Ys(t,e,n,r){e=e.data;let o=e.spriteIndices.get(n)*12;e.spriteData[o+8]=r,e.dirty=!0}function Xs(t,e,n,r){e=e.data;let o=e.spriteIndices.get(n)*12;e.spriteData[o+9]=r,e.dirty=!0}function Hs(t,e,n,r,i){let o=e.refs.spritesheet.data.spritesheet;e=e.data;let c=e.spriteIndices.get(n)*12,f=o.spriteMeta[r].w,p=o.spriteMeta[r].h;e.spriteData[c+2]=f*i[0],e.spriteData[c+3]=p*i[1],e.dirty=!0}function Zs(t,e,n,r,i,o,s,c,f,p){let g=e.refs.spritesheet.data.spritesheet;e=e.data;let F=e.spriteIndices.get(n);li(e,g,F,r,i,o,s,c,f,p),e.dirty=!0}function li(t,e,n,r,i,o,s,c,f,p){if(!e.spriteMeta[r])throw new Error(`Sprite name ${r} could not be found in the spritesheet metaData`);let g=n*12,F=e.spriteMeta[r].w,C=e.spriteMeta[r].h,N=e.locations.indexOf(r),m=p<<16&16711680|N&65535;t.spriteData[g]=i[0],t.spriteData[g+1]=i[1],t.spriteData[g+2]=F*o[0],t.spriteData[g+3]=C*o[1],t.spriteData[g+4]=s[0],t.spriteData[g+5]=s[1],t.spriteData[g+6]=s[2],t.spriteData[g+7]=s[3],t.spriteData[g+8]=c,t.spriteData[g+9]=f,t.spriteData[g+11]=m}var hi={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return $s(t,e)},onRun:function(t,e,n){Ws(t,e,n)},onDestroy:function(t,e){Ks(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{...$e}};async function $s(t,e){let{device:n}=t,r=16192,i=r,s=Float32Array.BYTES_PER_ELEMENT*2,f=Float32Array.BYTES_PER_ELEMENT*2,g=Float32Array.BYTES_PER_ELEMENT*4,C=Float32Array.BYTES_PER_ELEMENT*4,N=n.createBuffer({size:(s+f+g+C)*i,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),m=e.refs.spritesheet.data,V=n.createBindGroup({layout:e.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:m.uniformBuffer}},{binding:1,resource:m.colorTexture.view},{binding:2,resource:m.colorTexture.sampler},{binding:3,resource:{buffer:N}},{binding:4,resource:m.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(r*2),instancedDrawCallCount:0,bindGroup:V,spriteBuffer:N,spriteData:new Float32Array(r*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Ws(t,e,n){let{device:r}=t,i=e.options.loadOp||"load";if(e.data.dirty&&(Qs(e.data),e.data.dirty=!1),e.data.spriteCount>0){let f=e.data.spriteCount*12*Float32Array.BYTES_PER_ELEMENT;r.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer,0,f)}let o=n.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:i,storeOp:"store"},{view:e.refs.emissive.data.view,clearValue:t.clearValue,loadOp:"clear",storeOp:"store"}]});o.setPipeline(e.refs.spritesheet.data.pipeline),o.setBindGroup(0,e.data.bindGroup),o.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let s=6,c=0;for(let f=0;f<e.data.instancedDrawCallCount;f++){let p=e.data.instancedDrawCalls[f*2]*s,g=e.data.instancedDrawCalls[f*2+1];o.draw(s,g,p,c),c+=g}o.end()}function Qs(t){let e=-1,n=0;t.instancedDrawCallCount=0;for(let r=0;r<t.spriteCount;r++){let i=t.spriteData[r*12+11]&65535;i!==e&&(n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++),e=i,n=0),n++}n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++)}function Ks(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var vi={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Js(t,e)},onRun:function(t,e,n){js(t,e,n)},onDestroy:function(t,e){pi(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{setTexture:async function(t,e,n){let{device:r}=t;pi(e),e.options.textureUrl=n;let i=await he(t,"tile map",e.options.textureUrl),o=r.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:i.view},{binding:2,resource:i.sampler}]});e.data.bindGroup=o,e.data.material=i}}};async function Js(t,e){let{device:n}=t,r=await he(t,"tile map",e.options.textureUrl),i=new Float32Array([e.options.scrollScale,e.options.scrollScale]),o=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,s={size:i.byteLength,usage:o,mappedAtCreation:!0},c=n.createBuffer(s);return new Float32Array(c.getMappedRange()).set(i),c.unmap(),{bindGroup:n.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:r.view},{binding:2,resource:r.sampler}]}),material:r,uniformBuffer:c,scrollScale:e.options.scrollScale}}function js(t,e,n){let{device:r}=t,i=e.options.loadOp||"load",o=n.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:i,storeOp:"store"}]}),s=e.refs.tileAtlas.data;o.setPipeline(s.pipeline),o.setBindGroup(0,e.data.bindGroup),o.setBindGroup(1,s.atlasBindGroup),o.draw(3),o.end()}function pi(t){t.data.material.texture.destroy(),t.data.material.texture=void 0}var sr=class{device;floatsPerSprite=6;bufferGpu;bufferNeedsUpdate=!1;sprites=new Map;get spriteCount(){return this.sprites.size}constructor(e){this.device=e.device,this.bufferGpu=this.device.createBuffer({size:e.maxSpriteCount*this.floatsPerSprite*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})}destroy(){this.bufferGpu.destroy}update(){if(this.bufferNeedsUpdate){let e=[];for(let r of this.sprites.values())e.push(...r);let n=new Float32Array(e);this.device.queue.writeBuffer(this.bufferGpu,0,n)}}addTriangle(e){let n=Ze();if(this.sprites.has(n))throw new Error(`Duplicate triangle "${n}".`);let r=this.buildTriangleData(e);return this.sprites.set(n,r),this.bufferNeedsUpdate=!0,n}removeTriangle(e){if(!this.sprites.has(e))throw new Error(`Unknown triangle "${e}".`);this.sprites.delete(e),this.bufferNeedsUpdate=!0}setTriangle(e,n){if(!this.sprites.has(e))throw new Error(`Unknown triangle "${e}".`);let r=this.buildTriangleData(n);this.sprites.set(e,r),this.bufferNeedsUpdate=!0}buildTriangleData(e){return[e[0][0],e[0][1],e[1][0],e[1][1],e[2][0],e[2][1]]}};var ur=class{device;bufferGpu;needsUpdate=!0;constructor(e){this.device=e.device,this.bufferGpu=this.device.createBuffer({label:"DisplacementParametersBuffer buffer",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.setParameters(e.initialParameters)}setParameters(e){this.device.queue.writeBuffer(this.bufferGpu,0,new Float32Array([e.offsetX,e.offsetY,e.scale]))}destroy(){this.bufferGpu.destroy()}};var di="struct DisplacementParameters{offset:vec2<f32>,scale:f32,};@group(0)@binding(0)var<uniform> uniforms:DisplacementParameters;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var colorSampler:sampler;@group(0)@binding(3)var noiseTexture:texture_2d<f32>;@group(0)@binding(4)var noiseSampler:sampler;@group(0)@binding(5)var displacementTexture:texture_2d<f32>;struct VertexIn{@builtin(vertex_index)vertexIndex:u32,};struct VertexOut{@builtin(position)position:vec4<f32>,@location(0)uv:vec2<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{const corners=array<vec2<f32>,4>(vec2<f32>(-1,-1),vec2<f32>(1,-1),vec2<f32>(-1,1),vec2<f32>(1,1),);let screenPosition=corners[in.vertexIndex];var out:VertexOut;out.position=vec4<f32>(screenPosition,0,1);out.uv=(0.5+0.5*screenPosition*vec2<f32>(1,-1));return out;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment(in:VertexOut)->FragmentOut{let noiseTextureDimensions=vec2<f32>(textureDimensions(noiseTexture,0));let noiseUv=in.uv+uniforms.offset/noiseTextureDimensions;var noise=textureSample(noiseTexture,noiseSampler,noiseUv).rg;noise-=0.5;noise*=uniforms.scale/noiseTextureDimensions;let displacement=textureSample(displacementTexture,colorSampler,in.uv).r;noise*=displacement;let colorUv=in.uv+noise;var out:FragmentOut;out.color=textureSample(colorTexture,colorSampler,colorUv);return out;}";var cr=class{device;targetFormat;renderPipeline;colorSampler;noiseSampler;displacementParametersBuffer;renderBundle=null;colorTextureView;noiseMapTextureView;displacementTextureView;constructor(e){this.device=e.device,this.targetFormat=e.targetFormat,this.colorTextureView=e.colorTextureView,this.noiseMapTextureView=e.noiseMapTextureView,this.displacementTextureView=e.displacementTextureView,this.displacementParametersBuffer=e.displacementParametersBuffer;let n=this.device.createShaderModule({label:"DisplacementComposition shader module",code:di});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementComposition renderpipeline",layout:"auto",vertex:{module:n,entryPoint:"main_vertex"},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:e.targetFormat}]},primitive:{cullMode:"none",topology:"triangle-strip"}}),this.noiseSampler=this.device.createSampler({label:"DisplacementComposition noisesampler",addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),this.colorSampler=this.device.createSampler({label:"DisplacementComposition colorSampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"})}getRenderBundle(){return this.renderBundle||(this.renderBundle=this.buildRenderBundle()),this.renderBundle}destroy(){}setColorTextureView(e){this.colorTextureView=e,this.renderBundle=null}setNoiseMapTextureView(e){this.noiseMapTextureView=e,this.renderBundle=null}setDisplacementTextureView(e){this.displacementTextureView=e,this.renderBundle=null}buildRenderBundle(){let e=this.device.createBindGroup({label:"DisplacementComposition bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.displacementParametersBuffer.bufferGpu}},{binding:1,resource:this.colorTextureView},{binding:2,resource:this.colorSampler},{binding:3,resource:this.noiseMapTextureView},{binding:4,resource:this.noiseSampler},{binding:5,resource:this.displacementTextureView}]}),n=this.device.createRenderBundleEncoder({label:"DisplacementComposition renderbundle encoder",colorFormats:[this.targetFormat]});return n.setPipeline(this.renderPipeline),n.setBindGroup(0,e),n.draw(4),n.finish({label:"DisplacementComposition renderbundle"})}};var gi="struct TransformData{mvpMatrix:mat4x4<f32>,};@group(0)@binding(0)var<uniform> transformUBO:TransformData;struct VertexIn{@location(0)position:vec2<f32>,};struct VertexOut{@builtin(position)position:vec4<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{var output:VertexOut;output.position=transformUBO.mvpMatrix*vec4<f32>(in.position,0.0,1.0);return output;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment()->FragmentOut{var out:FragmentOut;out.color=vec4<f32>(1.0,1.0,1.0,1.0);return out;}";function tu(t,e){return class extends t{constructor(...n){super(...n),e(this)}}}var eu=tu(Array,t=>t.fill(0)),Tt=1e-6;function ru(t){function e(z=0,O=0){let q=new t(2);return z!==void 0&&(q[0]=z,O!==void 0&&(q[1]=O)),q}let n=e;function r(z,O,q){let u=q??new t(2);return u[0]=z,u[1]=O,u}function i(z,O){let q=O??new t(2);return q[0]=Math.ceil(z[0]),q[1]=Math.ceil(z[1]),q}function o(z,O){let q=O??new t(2);return q[0]=Math.floor(z[0]),q[1]=Math.floor(z[1]),q}function s(z,O){let q=O??new t(2);return q[0]=Math.round(z[0]),q[1]=Math.round(z[1]),q}function c(z,O=0,q=1,u){let B=u??new t(2);return B[0]=Math.min(q,Math.max(O,z[0])),B[1]=Math.min(q,Math.max(O,z[1])),B}function f(z,O,q){let u=q??new t(2);return u[0]=z[0]+O[0],u[1]=z[1]+O[1],u}function p(z,O,q,u){let B=u??new t(2);return B[0]=z[0]+O[0]*q,B[1]=z[1]+O[1]*q,B}function g(z,O){let q=z[0],u=z[1],B=O[0],x=O[1],y=Math.sqrt(q*q+u*u),d=Math.sqrt(B*B+x*x),_=y*d,L=_&&rt(z,O)/_;return Math.acos(L)}function F(z,O,q){let u=q??new t(2);return u[0]=z[0]-O[0],u[1]=z[1]-O[1],u}let C=F;function N(z,O){return Math.abs(z[0]-O[0])<Tt&&Math.abs(z[1]-O[1])<Tt}function m(z,O){return z[0]===O[0]&&z[1]===O[1]}function V(z,O,q,u){let B=u??new t(2);return B[0]=z[0]+q*(O[0]-z[0]),B[1]=z[1]+q*(O[1]-z[1]),B}function Y(z,O,q,u){let B=u??new t(2);return B[0]=z[0]+q[0]*(O[0]-z[0]),B[1]=z[1]+q[1]*(O[1]-z[1]),B}function et(z,O,q){let u=q??new t(2);return u[0]=Math.max(z[0],O[0]),u[1]=Math.max(z[1],O[1]),u}function W(z,O,q){let u=q??new t(2);return u[0]=Math.min(z[0],O[0]),u[1]=Math.min(z[1],O[1]),u}function H(z,O,q){let u=q??new t(2);return u[0]=z[0]*O,u[1]=z[1]*O,u}let j=H;function K(z,O,q){let u=q??new t(2);return u[0]=z[0]/O,u[1]=z[1]/O,u}function tt(z,O){let q=O??new t(2);return q[0]=1/z[0],q[1]=1/z[1],q}let ut=tt;function J(z,O,q){let u=q??new t(3),B=z[0]*O[1]-z[1]*O[0];return u[0]=0,u[1]=0,u[2]=B,u}function rt(z,O){return z[0]*O[0]+z[1]*O[1]}function D(z){let O=z[0],q=z[1];return Math.sqrt(O*O+q*q)}let a=D;function v(z){let O=z[0],q=z[1];return O*O+q*q}let T=v;function M(z,O){let q=z[0]-O[0],u=z[1]-O[1];return Math.sqrt(q*q+u*u)}let S=M;function E(z,O){let q=z[0]-O[0],u=z[1]-O[1];return q*q+u*u}let R=E;function P(z,O){let q=O??new t(2),u=z[0],B=z[1],x=Math.sqrt(u*u+B*B);return x>1e-5?(q[0]=u/x,q[1]=B/x):(q[0]=0,q[1]=0),q}function h(z,O){let q=O??new t(2);return q[0]=-z[0],q[1]=-z[1],q}function G(z,O){let q=O??new t(2);return q[0]=z[0],q[1]=z[1],q}let ot=G;function at(z,O,q){let u=q??new t(2);return u[0]=z[0]*O[0],u[1]=z[1]*O[1],u}let st=at;function ct(z,O,q){let u=q??new t(2);return u[0]=z[0]/O[0],u[1]=z[1]/O[1],u}let yt=ct;function pt(z=1,O){let q=O??new t(2),u=Math.random()*2*Math.PI;return q[0]=Math.cos(u)*z,q[1]=Math.sin(u)*z,q}function k(z){let O=z??new t(2);return O[0]=0,O[1]=0,O}function Z(z,O,q){let u=q??new t(2),B=z[0],x=z[1];return u[0]=B*O[0]+x*O[4]+O[12],u[1]=B*O[1]+x*O[5]+O[13],u}function U(z,O,q){let u=q??new t(2),B=z[0],x=z[1];return u[0]=O[0]*B+O[4]*x+O[8],u[1]=O[1]*B+O[5]*x+O[9],u}function l(z,O,q,u){let B=u??new t(2),x=z[0]-O[0],y=z[1]-O[1],d=Math.sin(q),_=Math.cos(q);return B[0]=x*_-y*d+O[0],B[1]=x*d+y*_+O[1],B}function b(z,O,q){let u=q??new t(2);return P(z,u),H(u,O,u)}function w(z,O,q){let u=q??new t(2);return D(z)>O?b(z,O,u):G(z,u)}function A(z,O,q){let u=q??new t(2);return V(z,O,.5,u)}return{create:e,fromValues:n,set:r,ceil:i,floor:o,round:s,clamp:c,add:f,addScaled:p,angle:g,subtract:F,sub:C,equalsApproximately:N,equals:m,lerp:V,lerpV:Y,max:et,min:W,mulScalar:H,scale:j,divScalar:K,inverse:tt,invert:ut,cross:J,dot:rt,length:D,len:a,lengthSq:v,lenSq:T,distance:M,dist:S,distanceSq:E,distSq:R,normalize:P,negate:h,copy:G,clone:ot,multiply:at,mul:st,divide:ct,div:yt,random:pt,zero:k,transformMat4:Z,transformMat3:U,rotate:l,setLength:b,truncate:w,midpoint:A}}var wi=new Map;function _i(t){let e=wi.get(t);return e||(e=ru(t),wi.set(t,e)),e}function nu(t){function e(d,_,L){let I=new t(3);return d!==void 0&&(I[0]=d,_!==void 0&&(I[1]=_,L!==void 0&&(I[2]=L))),I}let n=e;function r(d,_,L,I){let X=I??new t(3);return X[0]=d,X[1]=_,X[2]=L,X}function i(d,_){let L=_??new t(3);return L[0]=Math.ceil(d[0]),L[1]=Math.ceil(d[1]),L[2]=Math.ceil(d[2]),L}function o(d,_){let L=_??new t(3);return L[0]=Math.floor(d[0]),L[1]=Math.floor(d[1]),L[2]=Math.floor(d[2]),L}function s(d,_){let L=_??new t(3);return L[0]=Math.round(d[0]),L[1]=Math.round(d[1]),L[2]=Math.round(d[2]),L}function c(d,_=0,L=1,I){let X=I??new t(3);return X[0]=Math.min(L,Math.max(_,d[0])),X[1]=Math.min(L,Math.max(_,d[1])),X[2]=Math.min(L,Math.max(_,d[2])),X}function f(d,_,L){let I=L??new t(3);return I[0]=d[0]+_[0],I[1]=d[1]+_[1],I[2]=d[2]+_[2],I}function p(d,_,L,I){let X=I??new t(3);return X[0]=d[0]+_[0]*L,X[1]=d[1]+_[1]*L,X[2]=d[2]+_[2]*L,X}function g(d,_){let L=d[0],I=d[1],X=d[2],$=_[0],Q=_[1],ft=_[2],nt=Math.sqrt(L*L+I*I+X*X),it=Math.sqrt($*$+Q*Q+ft*ft),vt=nt*it,ht=vt&&rt(d,_)/vt;return Math.acos(ht)}function F(d,_,L){let I=L??new t(3);return I[0]=d[0]-_[0],I[1]=d[1]-_[1],I[2]=d[2]-_[2],I}let C=F;function N(d,_){return Math.abs(d[0]-_[0])<Tt&&Math.abs(d[1]-_[1])<Tt&&Math.abs(d[2]-_[2])<Tt}function m(d,_){return d[0]===_[0]&&d[1]===_[1]&&d[2]===_[2]}function V(d,_,L,I){let X=I??new t(3);return X[0]=d[0]+L*(_[0]-d[0]),X[1]=d[1]+L*(_[1]-d[1]),X[2]=d[2]+L*(_[2]-d[2]),X}function Y(d,_,L,I){let X=I??new t(3);return X[0]=d[0]+L[0]*(_[0]-d[0]),X[1]=d[1]+L[1]*(_[1]-d[1]),X[2]=d[2]+L[2]*(_[2]-d[2]),X}function et(d,_,L){let I=L??new t(3);return I[0]=Math.max(d[0],_[0]),I[1]=Math.max(d[1],_[1]),I[2]=Math.max(d[2],_[2]),I}function W(d,_,L){let I=L??new t(3);return I[0]=Math.min(d[0],_[0]),I[1]=Math.min(d[1],_[1]),I[2]=Math.min(d[2],_[2]),I}function H(d,_,L){let I=L??new t(3);return I[0]=d[0]*_,I[1]=d[1]*_,I[2]=d[2]*_,I}let j=H;function K(d,_,L){let I=L??new t(3);return I[0]=d[0]/_,I[1]=d[1]/_,I[2]=d[2]/_,I}function tt(d,_){let L=_??new t(3);return L[0]=1/d[0],L[1]=1/d[1],L[2]=1/d[2],L}let ut=tt;function J(d,_,L){let I=L??new t(3),X=d[2]*_[0]-d[0]*_[2],$=d[0]*_[1]-d[1]*_[0];return I[0]=d[1]*_[2]-d[2]*_[1],I[1]=X,I[2]=$,I}function rt(d,_){return d[0]*_[0]+d[1]*_[1]+d[2]*_[2]}function D(d){let _=d[0],L=d[1],I=d[2];return Math.sqrt(_*_+L*L+I*I)}let a=D;function v(d){let _=d[0],L=d[1],I=d[2];return _*_+L*L+I*I}let T=v;function M(d,_){let L=d[0]-_[0],I=d[1]-_[1],X=d[2]-_[2];return Math.sqrt(L*L+I*I+X*X)}let S=M;function E(d,_){let L=d[0]-_[0],I=d[1]-_[1],X=d[2]-_[2];return L*L+I*I+X*X}let R=E;function P(d,_){let L=_??new t(3),I=d[0],X=d[1],$=d[2],Q=Math.sqrt(I*I+X*X+$*$);return Q>1e-5?(L[0]=I/Q,L[1]=X/Q,L[2]=$/Q):(L[0]=0,L[1]=0,L[2]=0),L}function h(d,_){let L=_??new t(3);return L[0]=-d[0],L[1]=-d[1],L[2]=-d[2],L}function G(d,_){let L=_??new t(3);return L[0]=d[0],L[1]=d[1],L[2]=d[2],L}let ot=G;function at(d,_,L){let I=L??new t(3);return I[0]=d[0]*_[0],I[1]=d[1]*_[1],I[2]=d[2]*_[2],I}let st=at;function ct(d,_,L){let I=L??new t(3);return I[0]=d[0]/_[0],I[1]=d[1]/_[1],I[2]=d[2]/_[2],I}let yt=ct;function pt(d=1,_){let L=_??new t(3),I=Math.random()*2*Math.PI,X=Math.random()*2-1,$=Math.sqrt(1-X*X)*d;return L[0]=Math.cos(I)*$,L[1]=Math.sin(I)*$,L[2]=X*d,L}function k(d){let _=d??new t(3);return _[0]=0,_[1]=0,_[2]=0,_}function Z(d,_,L){let I=L??new t(3),X=d[0],$=d[1],Q=d[2],ft=_[3]*X+_[7]*$+_[11]*Q+_[15]||1;return I[0]=(_[0]*X+_[4]*$+_[8]*Q+_[12])/ft,I[1]=(_[1]*X+_[5]*$+_[9]*Q+_[13])/ft,I[2]=(_[2]*X+_[6]*$+_[10]*Q+_[14])/ft,I}function U(d,_,L){let I=L??new t(3),X=d[0],$=d[1],Q=d[2];return I[0]=X*_[0*4+0]+$*_[1*4+0]+Q*_[2*4+0],I[1]=X*_[0*4+1]+$*_[1*4+1]+Q*_[2*4+1],I[2]=X*_[0*4+2]+$*_[1*4+2]+Q*_[2*4+2],I}function l(d,_,L){let I=L??new t(3),X=d[0],$=d[1],Q=d[2];return I[0]=X*_[0]+$*_[4]+Q*_[8],I[1]=X*_[1]+$*_[5]+Q*_[9],I[2]=X*_[2]+$*_[6]+Q*_[10],I}function b(d,_,L){let I=L??new t(3),X=_[0],$=_[1],Q=_[2],ft=_[3]*2,nt=d[0],it=d[1],vt=d[2],ht=$*vt-Q*it,lt=Q*nt-X*vt,dt=X*it-$*nt;return I[0]=nt+ht*ft+($*dt-Q*lt)*2,I[1]=it+lt*ft+(Q*ht-X*dt)*2,I[2]=vt+dt*ft+(X*lt-$*ht)*2,I}function w(d,_){let L=_??new t(3);return L[0]=d[12],L[1]=d[13],L[2]=d[14],L}function A(d,_,L){let I=L??new t(3),X=_*4;return I[0]=d[X+0],I[1]=d[X+1],I[2]=d[X+2],I}function z(d,_){let L=_??new t(3),I=d[0],X=d[1],$=d[2],Q=d[4],ft=d[5],nt=d[6],it=d[8],vt=d[9],ht=d[10];return L[0]=Math.sqrt(I*I+X*X+$*$),L[1]=Math.sqrt(Q*Q+ft*ft+nt*nt),L[2]=Math.sqrt(it*it+vt*vt+ht*ht),L}function O(d,_,L,I){let X=I??new t(3),$=[],Q=[];return $[0]=d[0]-_[0],$[1]=d[1]-_[1],$[2]=d[2]-_[2],Q[0]=$[0],Q[1]=$[1]*Math.cos(L)-$[2]*Math.sin(L),Q[2]=$[1]*Math.sin(L)+$[2]*Math.cos(L),X[0]=Q[0]+_[0],X[1]=Q[1]+_[1],X[2]=Q[2]+_[2],X}function q(d,_,L,I){let X=I??new t(3),$=[],Q=[];return $[0]=d[0]-_[0],$[1]=d[1]-_[1],$[2]=d[2]-_[2],Q[0]=$[2]*Math.sin(L)+$[0]*Math.cos(L),Q[1]=$[1],Q[2]=$[2]*Math.cos(L)-$[0]*Math.sin(L),X[0]=Q[0]+_[0],X[1]=Q[1]+_[1],X[2]=Q[2]+_[2],X}function u(d,_,L,I){let X=I??new t(3),$=[],Q=[];return $[0]=d[0]-_[0],$[1]=d[1]-_[1],$[2]=d[2]-_[2],Q[0]=$[0]*Math.cos(L)-$[1]*Math.sin(L),Q[1]=$[0]*Math.sin(L)+$[1]*Math.cos(L),Q[2]=$[2],X[0]=Q[0]+_[0],X[1]=Q[1]+_[1],X[2]=Q[2]+_[2],X}function B(d,_,L){let I=L??new t(3);return P(d,I),H(I,_,I)}function x(d,_,L){let I=L??new t(3);return D(d)>_?B(d,_,I):G(d,I)}function y(d,_,L){let I=L??new t(3);return V(d,_,.5,I)}return{create:e,fromValues:n,set:r,ceil:i,floor:o,round:s,clamp:c,add:f,addScaled:p,angle:g,subtract:F,sub:C,equalsApproximately:N,equals:m,lerp:V,lerpV:Y,max:et,min:W,mulScalar:H,scale:j,divScalar:K,inverse:tt,invert:ut,cross:J,dot:rt,length:D,len:a,lengthSq:v,lenSq:T,distance:M,dist:S,distanceSq:E,distSq:R,normalize:P,negate:h,copy:G,clone:ot,multiply:at,mul:st,divide:ct,div:yt,random:pt,zero:k,transformMat4:Z,transformMat4Upper3x3:U,transformMat3:l,transformQuat:b,getTranslation:w,getAxis:A,getScaling:z,rotateX:O,rotateY:q,rotateZ:u,setLength:B,truncate:x,midpoint:y}}var xi=new Map;function fr(t){let e=xi.get(t);return e||(e=nu(t),xi.set(t,e)),e}function iu(t){let e=_i(t),n=fr(t);function r(l,b,w,A,z,O,q,u,B){let x=new t(12);return x[3]=0,x[7]=0,x[11]=0,l!==void 0&&(x[0]=l,b!==void 0&&(x[1]=b,w!==void 0&&(x[2]=w,A!==void 0&&(x[4]=A,z!==void 0&&(x[5]=z,O!==void 0&&(x[6]=O,q!==void 0&&(x[8]=q,u!==void 0&&(x[9]=u,B!==void 0&&(x[10]=B))))))))),x}function i(l,b,w,A,z,O,q,u,B,x){let y=x??new t(12);return y[0]=l,y[1]=b,y[2]=w,y[3]=0,y[4]=A,y[5]=z,y[6]=O,y[7]=0,y[8]=q,y[9]=u,y[10]=B,y[11]=0,y}function o(l,b){let w=b??new t(12);return w[0]=l[0],w[1]=l[1],w[2]=l[2],w[3]=0,w[4]=l[4],w[5]=l[5],w[6]=l[6],w[7]=0,w[8]=l[8],w[9]=l[9],w[10]=l[10],w[11]=0,w}function s(l,b){let w=b??new t(12),A=l[0],z=l[1],O=l[2],q=l[3],u=A+A,B=z+z,x=O+O,y=A*u,d=z*u,_=z*B,L=O*u,I=O*B,X=O*x,$=q*u,Q=q*B,ft=q*x;return w[0]=1-_-X,w[1]=d+ft,w[2]=L-Q,w[3]=0,w[4]=d-ft,w[5]=1-y-X,w[6]=I+$,w[7]=0,w[8]=L+Q,w[9]=I-$,w[10]=1-y-_,w[11]=0,w}function c(l,b){let w=b??new t(12);return w[0]=-l[0],w[1]=-l[1],w[2]=-l[2],w[4]=-l[4],w[5]=-l[5],w[6]=-l[6],w[8]=-l[8],w[9]=-l[9],w[10]=-l[10],w}function f(l,b,w){let A=w??new t(12);return A[0]=l[0]*b,A[1]=l[1]*b,A[2]=l[2]*b,A[4]=l[4]*b,A[5]=l[5]*b,A[6]=l[6]*b,A[8]=l[8]*b,A[9]=l[9]*b,A[10]=l[10]*b,A}let p=f;function g(l,b,w){let A=w??new t(12);return A[0]=l[0]+b[0],A[1]=l[1]+b[1],A[2]=l[2]+b[2],A[4]=l[4]+b[4],A[5]=l[5]+b[5],A[6]=l[6]+b[6],A[8]=l[8]+b[8],A[9]=l[9]+b[9],A[10]=l[10]+b[10],A}function F(l,b){let w=b??new t(12);return w[0]=l[0],w[1]=l[1],w[2]=l[2],w[4]=l[4],w[5]=l[5],w[6]=l[6],w[8]=l[8],w[9]=l[9],w[10]=l[10],w}let C=F;function N(l,b){return Math.abs(l[0]-b[0])<Tt&&Math.abs(l[1]-b[1])<Tt&&Math.abs(l[2]-b[2])<Tt&&Math.abs(l[4]-b[4])<Tt&&Math.abs(l[5]-b[5])<Tt&&Math.abs(l[6]-b[6])<Tt&&Math.abs(l[8]-b[8])<Tt&&Math.abs(l[9]-b[9])<Tt&&Math.abs(l[10]-b[10])<Tt}function m(l,b){return l[0]===b[0]&&l[1]===b[1]&&l[2]===b[2]&&l[4]===b[4]&&l[5]===b[5]&&l[6]===b[6]&&l[8]===b[8]&&l[9]===b[9]&&l[10]===b[10]}function V(l){let b=l??new t(12);return b[0]=1,b[1]=0,b[2]=0,b[4]=0,b[5]=1,b[6]=0,b[8]=0,b[9]=0,b[10]=1,b}function Y(l,b){let w=b??new t(12);if(w===l){let _;return _=l[1],l[1]=l[4],l[4]=_,_=l[2],l[2]=l[8],l[8]=_,_=l[6],l[6]=l[9],l[9]=_,w}let A=l[0*4+0],z=l[0*4+1],O=l[0*4+2],q=l[1*4+0],u=l[1*4+1],B=l[1*4+2],x=l[2*4+0],y=l[2*4+1],d=l[2*4+2];return w[0]=A,w[1]=q,w[2]=x,w[4]=z,w[5]=u,w[6]=y,w[8]=O,w[9]=B,w[10]=d,w}function et(l,b){let w=b??new t(12),A=l[0*4+0],z=l[0*4+1],O=l[0*4+2],q=l[1*4+0],u=l[1*4+1],B=l[1*4+2],x=l[2*4+0],y=l[2*4+1],d=l[2*4+2],_=d*u-B*y,L=-d*q+B*x,I=y*q-u*x,X=1/(A*_+z*L+O*I);return w[0]=_*X,w[1]=(-d*z+O*y)*X,w[2]=(B*z-O*u)*X,w[4]=L*X,w[5]=(d*A-O*x)*X,w[6]=(-B*A+O*q)*X,w[8]=I*X,w[9]=(-y*A+z*x)*X,w[10]=(u*A-z*q)*X,w}function W(l){let b=l[0],w=l[0*4+1],A=l[0*4+2],z=l[1*4+0],O=l[1*4+1],q=l[1*4+2],u=l[2*4+0],B=l[2*4+1],x=l[2*4+2];return b*(O*x-B*q)-z*(w*x-B*A)+u*(w*q-O*A)}let H=et;function j(l,b,w){let A=w??new t(12),z=l[0],O=l[1],q=l[2],u=l[4],B=l[5],x=l[6],y=l[8],d=l[9],_=l[10],L=b[0],I=b[1],X=b[2],$=b[4],Q=b[5],ft=b[6],nt=b[8],it=b[9],vt=b[10];return A[0]=z*L+u*I+y*X,A[1]=O*L+B*I+d*X,A[2]=q*L+x*I+_*X,A[4]=z*$+u*Q+y*ft,A[5]=O*$+B*Q+d*ft,A[6]=q*$+x*Q+_*ft,A[8]=z*nt+u*it+y*vt,A[9]=O*nt+B*it+d*vt,A[10]=q*nt+x*it+_*vt,A}let K=j;function tt(l,b,w){let A=w??V();return l!==A&&(A[0]=l[0],A[1]=l[1],A[2]=l[2],A[4]=l[4],A[5]=l[5],A[6]=l[6]),A[8]=b[0],A[9]=b[1],A[10]=1,A}function ut(l,b){let w=b??e.create();return w[0]=l[8],w[1]=l[9],w}function J(l,b,w){let A=w??e.create(),z=b*4;return A[0]=l[z+0],A[1]=l[z+1],A}function rt(l,b,w,A){let z=A===l?l:F(l,A),O=w*4;return z[O+0]=b[0],z[O+1]=b[1],z}function D(l,b){let w=b??e.create(),A=l[0],z=l[1],O=l[4],q=l[5];return w[0]=Math.sqrt(A*A+z*z),w[1]=Math.sqrt(O*O+q*q),w}function a(l,b){let w=b??n.create(),A=l[0],z=l[1],O=l[2],q=l[4],u=l[5],B=l[6],x=l[8],y=l[9],d=l[10];return w[0]=Math.sqrt(A*A+z*z+O*O),w[1]=Math.sqrt(q*q+u*u+B*B),w[2]=Math.sqrt(x*x+y*y+d*d),w}function v(l,b){let w=b??new t(12);return w[0]=1,w[1]=0,w[2]=0,w[4]=0,w[5]=1,w[6]=0,w[8]=l[0],w[9]=l[1],w[10]=1,w}function T(l,b,w){let A=w??new t(12),z=b[0],O=b[1],q=l[0],u=l[1],B=l[2],x=l[1*4+0],y=l[1*4+1],d=l[1*4+2],_=l[2*4+0],L=l[2*4+1],I=l[2*4+2];return l!==A&&(A[0]=q,A[1]=u,A[2]=B,A[4]=x,A[5]=y,A[6]=d),A[8]=q*z+x*O+_,A[9]=u*z+y*O+L,A[10]=B*z+d*O+I,A}function M(l,b){let w=b??new t(12),A=Math.cos(l),z=Math.sin(l);return w[0]=A,w[1]=z,w[2]=0,w[4]=-z,w[5]=A,w[6]=0,w[8]=0,w[9]=0,w[10]=1,w}function S(l,b,w){let A=w??new t(12),z=l[0*4+0],O=l[0*4+1],q=l[0*4+2],u=l[1*4+0],B=l[1*4+1],x=l[1*4+2],y=Math.cos(b),d=Math.sin(b);return A[0]=y*z+d*u,A[1]=y*O+d*B,A[2]=y*q+d*x,A[4]=y*u-d*z,A[5]=y*B-d*O,A[6]=y*x-d*q,l!==A&&(A[8]=l[8],A[9]=l[9],A[10]=l[10]),A}function E(l,b){let w=b??new t(12),A=Math.cos(l),z=Math.sin(l);return w[0]=1,w[1]=0,w[2]=0,w[4]=0,w[5]=A,w[6]=z,w[8]=0,w[9]=-z,w[10]=A,w}function R(l,b,w){let A=w??new t(12),z=l[4],O=l[5],q=l[6],u=l[8],B=l[9],x=l[10],y=Math.cos(b),d=Math.sin(b);return A[4]=y*z+d*u,A[5]=y*O+d*B,A[6]=y*q+d*x,A[8]=y*u-d*z,A[9]=y*B-d*O,A[10]=y*x-d*q,l!==A&&(A[0]=l[0],A[1]=l[1],A[2]=l[2]),A}function P(l,b){let w=b??new t(12),A=Math.cos(l),z=Math.sin(l);return w[0]=A,w[1]=0,w[2]=-z,w[4]=0,w[5]=1,w[6]=0,w[8]=z,w[9]=0,w[10]=A,w}function h(l,b,w){let A=w??new t(12),z=l[0*4+0],O=l[0*4+1],q=l[0*4+2],u=l[2*4+0],B=l[2*4+1],x=l[2*4+2],y=Math.cos(b),d=Math.sin(b);return A[0]=y*z-d*u,A[1]=y*O-d*B,A[2]=y*q-d*x,A[8]=y*u+d*z,A[9]=y*B+d*O,A[10]=y*x+d*q,l!==A&&(A[4]=l[4],A[5]=l[5],A[6]=l[6]),A}let G=M,ot=S;function at(l,b){let w=b??new t(12);return w[0]=l[0],w[1]=0,w[2]=0,w[4]=0,w[5]=l[1],w[6]=0,w[8]=0,w[9]=0,w[10]=1,w}function st(l,b,w){let A=w??new t(12),z=b[0],O=b[1];return A[0]=z*l[0*4+0],A[1]=z*l[0*4+1],A[2]=z*l[0*4+2],A[4]=O*l[1*4+0],A[5]=O*l[1*4+1],A[6]=O*l[1*4+2],l!==A&&(A[8]=l[8],A[9]=l[9],A[10]=l[10]),A}function ct(l,b){let w=b??new t(12);return w[0]=l[0],w[1]=0,w[2]=0,w[4]=0,w[5]=l[1],w[6]=0,w[8]=0,w[9]=0,w[10]=l[2],w}function yt(l,b,w){let A=w??new t(12),z=b[0],O=b[1],q=b[2];return A[0]=z*l[0*4+0],A[1]=z*l[0*4+1],A[2]=z*l[0*4+2],A[4]=O*l[1*4+0],A[5]=O*l[1*4+1],A[6]=O*l[1*4+2],A[8]=q*l[2*4+0],A[9]=q*l[2*4+1],A[10]=q*l[2*4+2],A}function pt(l,b){let w=b??new t(12);return w[0]=l,w[1]=0,w[2]=0,w[4]=0,w[5]=l,w[6]=0,w[8]=0,w[9]=0,w[10]=1,w}function k(l,b,w){let A=w??new t(12);return A[0]=b*l[0*4+0],A[1]=b*l[0*4+1],A[2]=b*l[0*4+2],A[4]=b*l[1*4+0],A[5]=b*l[1*4+1],A[6]=b*l[1*4+2],l!==A&&(A[8]=l[8],A[9]=l[9],A[10]=l[10]),A}function Z(l,b){let w=b??new t(12);return w[0]=l,w[1]=0,w[2]=0,w[4]=0,w[5]=l,w[6]=0,w[8]=0,w[9]=0,w[10]=l,w}function U(l,b,w){let A=w??new t(12);return A[0]=b*l[0*4+0],A[1]=b*l[0*4+1],A[2]=b*l[0*4+2],A[4]=b*l[1*4+0],A[5]=b*l[1*4+1],A[6]=b*l[1*4+2],A[8]=b*l[2*4+0],A[9]=b*l[2*4+1],A[10]=b*l[2*4+2],A}return{add:g,clone:C,copy:F,create:r,determinant:W,equals:m,equalsApproximately:N,fromMat4:o,fromQuat:s,get3DScaling:a,getAxis:J,getScaling:D,getTranslation:ut,identity:V,inverse:et,invert:H,mul:K,mulScalar:p,multiply:j,multiplyScalar:f,negate:c,rotate:S,rotateX:R,rotateY:h,rotateZ:ot,rotation:M,rotationX:E,rotationY:P,rotationZ:G,scale:st,scale3D:yt,scaling:at,scaling3D:ct,set:i,setAxis:rt,setTranslation:tt,translate:T,translation:v,transpose:Y,uniformScale:k,uniformScale3D:U,uniformScaling:pt,uniformScaling3D:Z}}var yi=new Map;function ou(t){let e=yi.get(t);return e||(e=iu(t),yi.set(t,e)),e}function au(t){let e=fr(t);function n(u,B,x,y,d,_,L,I,X,$,Q,ft,nt,it,vt,ht){let lt=new t(16);return u!==void 0&&(lt[0]=u,B!==void 0&&(lt[1]=B,x!==void 0&&(lt[2]=x,y!==void 0&&(lt[3]=y,d!==void 0&&(lt[4]=d,_!==void 0&&(lt[5]=_,L!==void 0&&(lt[6]=L,I!==void 0&&(lt[7]=I,X!==void 0&&(lt[8]=X,$!==void 0&&(lt[9]=$,Q!==void 0&&(lt[10]=Q,ft!==void 0&&(lt[11]=ft,nt!==void 0&&(lt[12]=nt,it!==void 0&&(lt[13]=it,vt!==void 0&&(lt[14]=vt,ht!==void 0&&(lt[15]=ht)))))))))))))))),lt}function r(u,B,x,y,d,_,L,I,X,$,Q,ft,nt,it,vt,ht,lt){let dt=lt??new t(16);return dt[0]=u,dt[1]=B,dt[2]=x,dt[3]=y,dt[4]=d,dt[5]=_,dt[6]=L,dt[7]=I,dt[8]=X,dt[9]=$,dt[10]=Q,dt[11]=ft,dt[12]=nt,dt[13]=it,dt[14]=vt,dt[15]=ht,dt}function i(u,B){let x=B??new t(16);return x[0]=u[0],x[1]=u[1],x[2]=u[2],x[3]=0,x[4]=u[4],x[5]=u[5],x[6]=u[6],x[7]=0,x[8]=u[8],x[9]=u[9],x[10]=u[10],x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function o(u,B){let x=B??new t(16),y=u[0],d=u[1],_=u[2],L=u[3],I=y+y,X=d+d,$=_+_,Q=y*I,ft=d*I,nt=d*X,it=_*I,vt=_*X,ht=_*$,lt=L*I,dt=L*X,wt=L*$;return x[0]=1-nt-ht,x[1]=ft+wt,x[2]=it-dt,x[3]=0,x[4]=ft-wt,x[5]=1-Q-ht,x[6]=vt+lt,x[7]=0,x[8]=it+dt,x[9]=vt-lt,x[10]=1-Q-nt,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function s(u,B){let x=B??new t(16);return x[0]=-u[0],x[1]=-u[1],x[2]=-u[2],x[3]=-u[3],x[4]=-u[4],x[5]=-u[5],x[6]=-u[6],x[7]=-u[7],x[8]=-u[8],x[9]=-u[9],x[10]=-u[10],x[11]=-u[11],x[12]=-u[12],x[13]=-u[13],x[14]=-u[14],x[15]=-u[15],x}function c(u,B,x){let y=x??new t(16);return y[0]=u[0]+B[0],y[1]=u[1]+B[1],y[2]=u[2]+B[2],y[3]=u[3]+B[3],y[4]=u[4]+B[4],y[5]=u[5]+B[5],y[6]=u[6]+B[6],y[7]=u[7]+B[7],y[8]=u[8]+B[8],y[9]=u[9]+B[9],y[10]=u[10]+B[10],y[11]=u[11]+B[11],y[12]=u[12]+B[12],y[13]=u[13]+B[13],y[14]=u[14]+B[14],y[15]=u[15]+B[15],y}function f(u,B,x){let y=x??new t(16);return y[0]=u[0]*B,y[1]=u[1]*B,y[2]=u[2]*B,y[3]=u[3]*B,y[4]=u[4]*B,y[5]=u[5]*B,y[6]=u[6]*B,y[7]=u[7]*B,y[8]=u[8]*B,y[9]=u[9]*B,y[10]=u[10]*B,y[11]=u[11]*B,y[12]=u[12]*B,y[13]=u[13]*B,y[14]=u[14]*B,y[15]=u[15]*B,y}let p=f;function g(u,B){let x=B??new t(16);return x[0]=u[0],x[1]=u[1],x[2]=u[2],x[3]=u[3],x[4]=u[4],x[5]=u[5],x[6]=u[6],x[7]=u[7],x[8]=u[8],x[9]=u[9],x[10]=u[10],x[11]=u[11],x[12]=u[12],x[13]=u[13],x[14]=u[14],x[15]=u[15],x}let F=g;function C(u,B){return Math.abs(u[0]-B[0])<Tt&&Math.abs(u[1]-B[1])<Tt&&Math.abs(u[2]-B[2])<Tt&&Math.abs(u[3]-B[3])<Tt&&Math.abs(u[4]-B[4])<Tt&&Math.abs(u[5]-B[5])<Tt&&Math.abs(u[6]-B[6])<Tt&&Math.abs(u[7]-B[7])<Tt&&Math.abs(u[8]-B[8])<Tt&&Math.abs(u[9]-B[9])<Tt&&Math.abs(u[10]-B[10])<Tt&&Math.abs(u[11]-B[11])<Tt&&Math.abs(u[12]-B[12])<Tt&&Math.abs(u[13]-B[13])<Tt&&Math.abs(u[14]-B[14])<Tt&&Math.abs(u[15]-B[15])<Tt}function N(u,B){return u[0]===B[0]&&u[1]===B[1]&&u[2]===B[2]&&u[3]===B[3]&&u[4]===B[4]&&u[5]===B[5]&&u[6]===B[6]&&u[7]===B[7]&&u[8]===B[8]&&u[9]===B[9]&&u[10]===B[10]&&u[11]===B[11]&&u[12]===B[12]&&u[13]===B[13]&&u[14]===B[14]&&u[15]===B[15]}function m(u){let B=u??new t(16);return B[0]=1,B[1]=0,B[2]=0,B[3]=0,B[4]=0,B[5]=1,B[6]=0,B[7]=0,B[8]=0,B[9]=0,B[10]=1,B[11]=0,B[12]=0,B[13]=0,B[14]=0,B[15]=1,B}function V(u,B){let x=B??new t(16);if(x===u){let gt;return gt=u[1],u[1]=u[4],u[4]=gt,gt=u[2],u[2]=u[8],u[8]=gt,gt=u[3],u[3]=u[12],u[12]=gt,gt=u[6],u[6]=u[9],u[9]=gt,gt=u[7],u[7]=u[13],u[13]=gt,gt=u[11],u[11]=u[14],u[14]=gt,x}let y=u[0*4+0],d=u[0*4+1],_=u[0*4+2],L=u[0*4+3],I=u[1*4+0],X=u[1*4+1],$=u[1*4+2],Q=u[1*4+3],ft=u[2*4+0],nt=u[2*4+1],it=u[2*4+2],vt=u[2*4+3],ht=u[3*4+0],lt=u[3*4+1],dt=u[3*4+2],wt=u[3*4+3];return x[0]=y,x[1]=I,x[2]=ft,x[3]=ht,x[4]=d,x[5]=X,x[6]=nt,x[7]=lt,x[8]=_,x[9]=$,x[10]=it,x[11]=dt,x[12]=L,x[13]=Q,x[14]=vt,x[15]=wt,x}function Y(u,B){let x=B??new t(16),y=u[0*4+0],d=u[0*4+1],_=u[0*4+2],L=u[0*4+3],I=u[1*4+0],X=u[1*4+1],$=u[1*4+2],Q=u[1*4+3],ft=u[2*4+0],nt=u[2*4+1],it=u[2*4+2],vt=u[2*4+3],ht=u[3*4+0],lt=u[3*4+1],dt=u[3*4+2],wt=u[3*4+3],gt=it*wt,qt=dt*vt,Mt=$*wt,bt=dt*Q,Xt=$*vt,St=it*Q,Bt=_*wt,Zt=dt*L,Pt=_*vt,Dt=it*L,$t=_*Q,Ut=$*L,Gt=ft*lt,Wt=ht*nt,Ft=I*lt,It=ht*X,Jt=I*nt,Lt=ft*X,zt=y*lt,Te=ht*d,Rt=y*nt,mt=ft*d,_e=y*X,Ot=I*d,Vt=gt*X+bt*nt+Xt*lt-(qt*X+Mt*nt+St*lt),Ee=qt*d+Bt*nt+Dt*lt-(gt*d+Zt*nt+Pt*lt),Le=Mt*d+Zt*X+$t*lt-(bt*d+Bt*X+Ut*lt),ze=St*d+Pt*X+Ut*nt-(Xt*d+Dt*X+$t*nt),Ht=1/(y*Vt+I*Ee+ft*Le+ht*ze);return x[0]=Ht*Vt,x[1]=Ht*Ee,x[2]=Ht*Le,x[3]=Ht*ze,x[4]=Ht*(qt*I+Mt*ft+St*ht-(gt*I+bt*ft+Xt*ht)),x[5]=Ht*(gt*y+Zt*ft+Pt*ht-(qt*y+Bt*ft+Dt*ht)),x[6]=Ht*(bt*y+Bt*I+Ut*ht-(Mt*y+Zt*I+$t*ht)),x[7]=Ht*(Xt*y+Dt*I+$t*ft-(St*y+Pt*I+Ut*ft)),x[8]=Ht*(Gt*Q+It*vt+Jt*wt-(Wt*Q+Ft*vt+Lt*wt)),x[9]=Ht*(Wt*L+zt*vt+mt*wt-(Gt*L+Te*vt+Rt*wt)),x[10]=Ht*(Ft*L+Te*Q+_e*wt-(It*L+zt*Q+Ot*wt)),x[11]=Ht*(Lt*L+Rt*Q+Ot*vt-(Jt*L+mt*Q+_e*vt)),x[12]=Ht*(Ft*it+Lt*dt+Wt*$-(Jt*dt+Gt*$+It*it)),x[13]=Ht*(Rt*dt+Gt*_+Te*it-(zt*it+mt*dt+Wt*_)),x[14]=Ht*(zt*$+Ot*dt+It*_-(_e*dt+Ft*_+Te*$)),x[15]=Ht*(_e*it+Jt*_+mt*$-(Rt*$+Ot*it+Lt*_)),x}function et(u){let B=u[0],x=u[0*4+1],y=u[0*4+2],d=u[0*4+3],_=u[1*4+0],L=u[1*4+1],I=u[1*4+2],X=u[1*4+3],$=u[2*4+0],Q=u[2*4+1],ft=u[2*4+2],nt=u[2*4+3],it=u[3*4+0],vt=u[3*4+1],ht=u[3*4+2],lt=u[3*4+3],dt=ft*lt,wt=ht*nt,gt=I*lt,qt=ht*X,Mt=I*nt,bt=ft*X,Xt=y*lt,St=ht*d,Bt=y*nt,Zt=ft*d,Pt=y*X,Dt=I*d,$t=dt*L+qt*Q+Mt*vt-(wt*L+gt*Q+bt*vt),Ut=wt*x+Xt*Q+Zt*vt-(dt*x+St*Q+Bt*vt),Gt=gt*x+St*L+Pt*vt-(qt*x+Xt*L+Dt*vt),Wt=bt*x+Bt*L+Dt*Q-(Mt*x+Zt*L+Pt*Q);return B*$t+_*Ut+$*Gt+it*Wt}let W=Y;function H(u,B,x){let y=x??new t(16),d=u[0],_=u[1],L=u[2],I=u[3],X=u[4],$=u[5],Q=u[6],ft=u[7],nt=u[8],it=u[9],vt=u[10],ht=u[11],lt=u[12],dt=u[13],wt=u[14],gt=u[15],qt=B[0],Mt=B[1],bt=B[2],Xt=B[3],St=B[4],Bt=B[5],Zt=B[6],Pt=B[7],Dt=B[8],$t=B[9],Ut=B[10],Gt=B[11],Wt=B[12],Ft=B[13],It=B[14],Jt=B[15];return y[0]=d*qt+X*Mt+nt*bt+lt*Xt,y[1]=_*qt+$*Mt+it*bt+dt*Xt,y[2]=L*qt+Q*Mt+vt*bt+wt*Xt,y[3]=I*qt+ft*Mt+ht*bt+gt*Xt,y[4]=d*St+X*Bt+nt*Zt+lt*Pt,y[5]=_*St+$*Bt+it*Zt+dt*Pt,y[6]=L*St+Q*Bt+vt*Zt+wt*Pt,y[7]=I*St+ft*Bt+ht*Zt+gt*Pt,y[8]=d*Dt+X*$t+nt*Ut+lt*Gt,y[9]=_*Dt+$*$t+it*Ut+dt*Gt,y[10]=L*Dt+Q*$t+vt*Ut+wt*Gt,y[11]=I*Dt+ft*$t+ht*Ut+gt*Gt,y[12]=d*Wt+X*Ft+nt*It+lt*Jt,y[13]=_*Wt+$*Ft+it*It+dt*Jt,y[14]=L*Wt+Q*Ft+vt*It+wt*Jt,y[15]=I*Wt+ft*Ft+ht*It+gt*Jt,y}let j=H;function K(u,B,x){let y=x??m();return u!==y&&(y[0]=u[0],y[1]=u[1],y[2]=u[2],y[3]=u[3],y[4]=u[4],y[5]=u[5],y[6]=u[6],y[7]=u[7],y[8]=u[8],y[9]=u[9],y[10]=u[10],y[11]=u[11]),y[12]=B[0],y[13]=B[1],y[14]=B[2],y[15]=1,y}function tt(u,B){let x=B??e.create();return x[0]=u[12],x[1]=u[13],x[2]=u[14],x}function ut(u,B,x){let y=x??e.create(),d=B*4;return y[0]=u[d+0],y[1]=u[d+1],y[2]=u[d+2],y}function J(u,B,x,y){let d=y===u?y:g(u,y),_=x*4;return d[_+0]=B[0],d[_+1]=B[1],d[_+2]=B[2],d}function rt(u,B){let x=B??e.create(),y=u[0],d=u[1],_=u[2],L=u[4],I=u[5],X=u[6],$=u[8],Q=u[9],ft=u[10];return x[0]=Math.sqrt(y*y+d*d+_*_),x[1]=Math.sqrt(L*L+I*I+X*X),x[2]=Math.sqrt($*$+Q*Q+ft*ft),x}function D(u,B,x,y,d){let _=d??new t(16),L=Math.tan(Math.PI*.5-.5*u);if(_[0]=L/B,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=L,_[6]=0,_[7]=0,_[8]=0,_[9]=0,_[11]=-1,_[12]=0,_[13]=0,_[15]=0,Number.isFinite(y)){let I=1/(x-y);_[10]=y*I,_[14]=y*x*I}else _[10]=-1,_[14]=-x;return _}function a(u,B,x,y=1/0,d){let _=d??new t(16),L=1/Math.tan(u*.5);if(_[0]=L/B,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=L,_[6]=0,_[7]=0,_[8]=0,_[9]=0,_[11]=-1,_[12]=0,_[13]=0,_[15]=0,y===1/0)_[10]=0,_[14]=x;else{let I=1/(y-x);_[10]=x*I,_[14]=y*x*I}return _}function v(u,B,x,y,d,_,L){let I=L??new t(16);return I[0]=2/(B-u),I[1]=0,I[2]=0,I[3]=0,I[4]=0,I[5]=2/(y-x),I[6]=0,I[7]=0,I[8]=0,I[9]=0,I[10]=1/(d-_),I[11]=0,I[12]=(B+u)/(u-B),I[13]=(y+x)/(x-y),I[14]=d/(d-_),I[15]=1,I}function T(u,B,x,y,d,_,L){let I=L??new t(16),X=B-u,$=y-x,Q=d-_;return I[0]=2*d/X,I[1]=0,I[2]=0,I[3]=0,I[4]=0,I[5]=2*d/$,I[6]=0,I[7]=0,I[8]=(u+B)/X,I[9]=(y+x)/$,I[10]=_/Q,I[11]=-1,I[12]=0,I[13]=0,I[14]=d*_/Q,I[15]=0,I}function M(u,B,x,y,d,_=1/0,L){let I=L??new t(16),X=B-u,$=y-x;if(I[0]=2*d/X,I[1]=0,I[2]=0,I[3]=0,I[4]=0,I[5]=2*d/$,I[6]=0,I[7]=0,I[8]=(u+B)/X,I[9]=(y+x)/$,I[11]=-1,I[12]=0,I[13]=0,I[15]=0,_===1/0)I[10]=0,I[14]=d;else{let Q=1/(_-d);I[10]=d*Q,I[14]=_*d*Q}return I}let S=e.create(),E=e.create(),R=e.create();function P(u,B,x,y){let d=y??new t(16);return e.normalize(e.subtract(B,u,R),R),e.normalize(e.cross(x,R,S),S),e.normalize(e.cross(R,S,E),E),d[0]=S[0],d[1]=S[1],d[2]=S[2],d[3]=0,d[4]=E[0],d[5]=E[1],d[6]=E[2],d[7]=0,d[8]=R[0],d[9]=R[1],d[10]=R[2],d[11]=0,d[12]=u[0],d[13]=u[1],d[14]=u[2],d[15]=1,d}function h(u,B,x,y){let d=y??new t(16);return e.normalize(e.subtract(u,B,R),R),e.normalize(e.cross(x,R,S),S),e.normalize(e.cross(R,S,E),E),d[0]=S[0],d[1]=S[1],d[2]=S[2],d[3]=0,d[4]=E[0],d[5]=E[1],d[6]=E[2],d[7]=0,d[8]=R[0],d[9]=R[1],d[10]=R[2],d[11]=0,d[12]=u[0],d[13]=u[1],d[14]=u[2],d[15]=1,d}function G(u,B,x,y){let d=y??new t(16);return e.normalize(e.subtract(u,B,R),R),e.normalize(e.cross(x,R,S),S),e.normalize(e.cross(R,S,E),E),d[0]=S[0],d[1]=E[0],d[2]=R[0],d[3]=0,d[4]=S[1],d[5]=E[1],d[6]=R[1],d[7]=0,d[8]=S[2],d[9]=E[2],d[10]=R[2],d[11]=0,d[12]=-(S[0]*u[0]+S[1]*u[1]+S[2]*u[2]),d[13]=-(E[0]*u[0]+E[1]*u[1]+E[2]*u[2]),d[14]=-(R[0]*u[0]+R[1]*u[1]+R[2]*u[2]),d[15]=1,d}function ot(u,B){let x=B??new t(16);return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=u[0],x[13]=u[1],x[14]=u[2],x[15]=1,x}function at(u,B,x){let y=x??new t(16),d=B[0],_=B[1],L=B[2],I=u[0],X=u[1],$=u[2],Q=u[3],ft=u[1*4+0],nt=u[1*4+1],it=u[1*4+2],vt=u[1*4+3],ht=u[2*4+0],lt=u[2*4+1],dt=u[2*4+2],wt=u[2*4+3],gt=u[3*4+0],qt=u[3*4+1],Mt=u[3*4+2],bt=u[3*4+3];return u!==y&&(y[0]=I,y[1]=X,y[2]=$,y[3]=Q,y[4]=ft,y[5]=nt,y[6]=it,y[7]=vt,y[8]=ht,y[9]=lt,y[10]=dt,y[11]=wt),y[12]=I*d+ft*_+ht*L+gt,y[13]=X*d+nt*_+lt*L+qt,y[14]=$*d+it*_+dt*L+Mt,y[15]=Q*d+vt*_+wt*L+bt,y}function st(u,B){let x=B??new t(16),y=Math.cos(u),d=Math.sin(u);return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=y,x[6]=d,x[7]=0,x[8]=0,x[9]=-d,x[10]=y,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function ct(u,B,x){let y=x??new t(16),d=u[4],_=u[5],L=u[6],I=u[7],X=u[8],$=u[9],Q=u[10],ft=u[11],nt=Math.cos(B),it=Math.sin(B);return y[4]=nt*d+it*X,y[5]=nt*_+it*$,y[6]=nt*L+it*Q,y[7]=nt*I+it*ft,y[8]=nt*X-it*d,y[9]=nt*$-it*_,y[10]=nt*Q-it*L,y[11]=nt*ft-it*I,u!==y&&(y[0]=u[0],y[1]=u[1],y[2]=u[2],y[3]=u[3],y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function yt(u,B){let x=B??new t(16),y=Math.cos(u),d=Math.sin(u);return x[0]=y,x[1]=0,x[2]=-d,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=d,x[9]=0,x[10]=y,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function pt(u,B,x){let y=x??new t(16),d=u[0*4+0],_=u[0*4+1],L=u[0*4+2],I=u[0*4+3],X=u[2*4+0],$=u[2*4+1],Q=u[2*4+2],ft=u[2*4+3],nt=Math.cos(B),it=Math.sin(B);return y[0]=nt*d-it*X,y[1]=nt*_-it*$,y[2]=nt*L-it*Q,y[3]=nt*I-it*ft,y[8]=nt*X+it*d,y[9]=nt*$+it*_,y[10]=nt*Q+it*L,y[11]=nt*ft+it*I,u!==y&&(y[4]=u[4],y[5]=u[5],y[6]=u[6],y[7]=u[7],y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function k(u,B){let x=B??new t(16),y=Math.cos(u),d=Math.sin(u);return x[0]=y,x[1]=d,x[2]=0,x[3]=0,x[4]=-d,x[5]=y,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function Z(u,B,x){let y=x??new t(16),d=u[0*4+0],_=u[0*4+1],L=u[0*4+2],I=u[0*4+3],X=u[1*4+0],$=u[1*4+1],Q=u[1*4+2],ft=u[1*4+3],nt=Math.cos(B),it=Math.sin(B);return y[0]=nt*d+it*X,y[1]=nt*_+it*$,y[2]=nt*L+it*Q,y[3]=nt*I+it*ft,y[4]=nt*X-it*d,y[5]=nt*$-it*_,y[6]=nt*Q-it*L,y[7]=nt*ft-it*I,u!==y&&(y[8]=u[8],y[9]=u[9],y[10]=u[10],y[11]=u[11],y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function U(u,B,x){let y=x??new t(16),d=u[0],_=u[1],L=u[2],I=Math.sqrt(d*d+_*_+L*L);d/=I,_/=I,L/=I;let X=d*d,$=_*_,Q=L*L,ft=Math.cos(B),nt=Math.sin(B),it=1-ft;return y[0]=X+(1-X)*ft,y[1]=d*_*it+L*nt,y[2]=d*L*it-_*nt,y[3]=0,y[4]=d*_*it-L*nt,y[5]=$+(1-$)*ft,y[6]=_*L*it+d*nt,y[7]=0,y[8]=d*L*it+_*nt,y[9]=_*L*it-d*nt,y[10]=Q+(1-Q)*ft,y[11]=0,y[12]=0,y[13]=0,y[14]=0,y[15]=1,y}let l=U;function b(u,B,x,y){let d=y??new t(16),_=B[0],L=B[1],I=B[2],X=Math.sqrt(_*_+L*L+I*I);_/=X,L/=X,I/=X;let $=_*_,Q=L*L,ft=I*I,nt=Math.cos(x),it=Math.sin(x),vt=1-nt,ht=$+(1-$)*nt,lt=_*L*vt+I*it,dt=_*I*vt-L*it,wt=_*L*vt-I*it,gt=Q+(1-Q)*nt,qt=L*I*vt+_*it,Mt=_*I*vt+L*it,bt=L*I*vt-_*it,Xt=ft+(1-ft)*nt,St=u[0],Bt=u[1],Zt=u[2],Pt=u[3],Dt=u[4],$t=u[5],Ut=u[6],Gt=u[7],Wt=u[8],Ft=u[9],It=u[10],Jt=u[11];return d[0]=ht*St+lt*Dt+dt*Wt,d[1]=ht*Bt+lt*$t+dt*Ft,d[2]=ht*Zt+lt*Ut+dt*It,d[3]=ht*Pt+lt*Gt+dt*Jt,d[4]=wt*St+gt*Dt+qt*Wt,d[5]=wt*Bt+gt*$t+qt*Ft,d[6]=wt*Zt+gt*Ut+qt*It,d[7]=wt*Pt+gt*Gt+qt*Jt,d[8]=Mt*St+bt*Dt+Xt*Wt,d[9]=Mt*Bt+bt*$t+Xt*Ft,d[10]=Mt*Zt+bt*Ut+Xt*It,d[11]=Mt*Pt+bt*Gt+Xt*Jt,u!==d&&(d[12]=u[12],d[13]=u[13],d[14]=u[14],d[15]=u[15]),d}let w=b;function A(u,B){let x=B??new t(16);return x[0]=u[0],x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=u[1],x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=u[2],x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function z(u,B,x){let y=x??new t(16),d=B[0],_=B[1],L=B[2];return y[0]=d*u[0*4+0],y[1]=d*u[0*4+1],y[2]=d*u[0*4+2],y[3]=d*u[0*4+3],y[4]=_*u[1*4+0],y[5]=_*u[1*4+1],y[6]=_*u[1*4+2],y[7]=_*u[1*4+3],y[8]=L*u[2*4+0],y[9]=L*u[2*4+1],y[10]=L*u[2*4+2],y[11]=L*u[2*4+3],u!==y&&(y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function O(u,B){let x=B??new t(16);return x[0]=u,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=u,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=u,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function q(u,B,x){let y=x??new t(16);return y[0]=B*u[0*4+0],y[1]=B*u[0*4+1],y[2]=B*u[0*4+2],y[3]=B*u[0*4+3],y[4]=B*u[1*4+0],y[5]=B*u[1*4+1],y[6]=B*u[1*4+2],y[7]=B*u[1*4+3],y[8]=B*u[2*4+0],y[9]=B*u[2*4+1],y[10]=B*u[2*4+2],y[11]=B*u[2*4+3],u!==y&&(y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}return{add:c,aim:P,axisRotate:b,axisRotation:U,cameraAim:h,clone:F,copy:g,create:n,determinant:et,equals:N,equalsApproximately:C,fromMat3:i,fromQuat:o,frustum:T,frustumReverseZ:M,getAxis:ut,getScaling:rt,getTranslation:tt,identity:m,inverse:Y,invert:W,lookAt:G,mul:j,mulScalar:p,multiply:H,multiplyScalar:f,negate:s,ortho:v,perspective:D,perspectiveReverseZ:a,rotate:w,rotateX:ct,rotateY:pt,rotateZ:Z,rotation:l,rotationX:st,rotationY:yt,rotationZ:k,scale:z,scaling:A,set:r,setAxis:J,setTranslation:K,translate:at,translation:ot,transpose:V,uniformScale:q,uniformScaling:O}}var Mi=new Map;function su(t){let e=Mi.get(t);return e||(e=au(t),Mi.set(t,e)),e}function uu(t){let e=fr(t);function n(k,Z,U,l){let b=new t(4);return k!==void 0&&(b[0]=k,Z!==void 0&&(b[1]=Z,U!==void 0&&(b[2]=U,l!==void 0&&(b[3]=l)))),b}let r=n;function i(k,Z,U,l,b){let w=b??new t(4);return w[0]=k,w[1]=Z,w[2]=U,w[3]=l,w}function o(k,Z,U){let l=U??new t(4),b=Z*.5,w=Math.sin(b);return l[0]=w*k[0],l[1]=w*k[1],l[2]=w*k[2],l[3]=Math.cos(b),l}function s(k,Z){let U=Z??e.create(3),l=Math.acos(k[3])*2,b=Math.sin(l*.5);return b>Tt?(U[0]=k[0]/b,U[1]=k[1]/b,U[2]=k[2]/b):(U[0]=1,U[1]=0,U[2]=0),{angle:l,axis:U}}function c(k,Z){let U=D(k,Z);return Math.acos(2*U*U-1)}function f(k,Z,U){let l=U??new t(4),b=k[0],w=k[1],A=k[2],z=k[3],O=Z[0],q=Z[1],u=Z[2],B=Z[3];return l[0]=b*B+z*O+w*u-A*q,l[1]=w*B+z*q+A*O-b*u,l[2]=A*B+z*u+b*q-w*O,l[3]=z*B-b*O-w*q-A*u,l}let p=f;function g(k,Z,U){let l=U??new t(4),b=Z*.5,w=k[0],A=k[1],z=k[2],O=k[3],q=Math.sin(b),u=Math.cos(b);return l[0]=w*u+O*q,l[1]=A*u+z*q,l[2]=z*u-A*q,l[3]=O*u-w*q,l}function F(k,Z,U){let l=U??new t(4),b=Z*.5,w=k[0],A=k[1],z=k[2],O=k[3],q=Math.sin(b),u=Math.cos(b);return l[0]=w*u-z*q,l[1]=A*u+O*q,l[2]=z*u+w*q,l[3]=O*u-A*q,l}function C(k,Z,U){let l=U??new t(4),b=Z*.5,w=k[0],A=k[1],z=k[2],O=k[3],q=Math.sin(b),u=Math.cos(b);return l[0]=w*u+A*q,l[1]=A*u-w*q,l[2]=z*u+O*q,l[3]=O*u-z*q,l}function N(k,Z,U,l){let b=l??new t(4),w=k[0],A=k[1],z=k[2],O=k[3],q=Z[0],u=Z[1],B=Z[2],x=Z[3],y=w*q+A*u+z*B+O*x;y<0&&(y=-y,q=-q,u=-u,B=-B,x=-x);let d,_;if(1-y>Tt){let L=Math.acos(y),I=Math.sin(L);d=Math.sin((1-U)*L)/I,_=Math.sin(U*L)/I}else d=1-U,_=U;return b[0]=d*w+_*q,b[1]=d*A+_*u,b[2]=d*z+_*B,b[3]=d*O+_*x,b}function m(k,Z){let U=Z??new t(4),l=k[0],b=k[1],w=k[2],A=k[3],z=l*l+b*b+w*w+A*A,O=z?1/z:0;return U[0]=-l*O,U[1]=-b*O,U[2]=-w*O,U[3]=A*O,U}function V(k,Z){let U=Z??new t(4);return U[0]=-k[0],U[1]=-k[1],U[2]=-k[2],U[3]=k[3],U}function Y(k,Z){let U=Z??new t(4),l=k[0]+k[5]+k[10];if(l>0){let b=Math.sqrt(l+1);U[3]=.5*b;let w=.5/b;U[0]=(k[6]-k[9])*w,U[1]=(k[8]-k[2])*w,U[2]=(k[1]-k[4])*w}else{let b=0;k[5]>k[0]&&(b=1),k[10]>k[b*4+b]&&(b=2);let w=(b+1)%3,A=(b+2)%3,z=Math.sqrt(k[b*4+b]-k[w*4+w]-k[A*4+A]+1);U[b]=.5*z;let O=.5/z;U[3]=(k[w*4+A]-k[A*4+w])*O,U[w]=(k[w*4+b]+k[b*4+w])*O,U[A]=(k[A*4+b]+k[b*4+A])*O}return U}function et(k,Z,U,l,b){let w=b??new t(4),A=k*.5,z=Z*.5,O=U*.5,q=Math.sin(A),u=Math.cos(A),B=Math.sin(z),x=Math.cos(z),y=Math.sin(O),d=Math.cos(O);switch(l){case"xyz":w[0]=q*x*d+u*B*y,w[1]=u*B*d-q*x*y,w[2]=u*x*y+q*B*d,w[3]=u*x*d-q*B*y;break;case"xzy":w[0]=q*x*d-u*B*y,w[1]=u*B*d-q*x*y,w[2]=u*x*y+q*B*d,w[3]=u*x*d+q*B*y;break;case"yxz":w[0]=q*x*d+u*B*y,w[1]=u*B*d-q*x*y,w[2]=u*x*y-q*B*d,w[3]=u*x*d+q*B*y;break;case"yzx":w[0]=q*x*d+u*B*y,w[1]=u*B*d+q*x*y,w[2]=u*x*y-q*B*d,w[3]=u*x*d-q*B*y;break;case"zxy":w[0]=q*x*d-u*B*y,w[1]=u*B*d+q*x*y,w[2]=u*x*y+q*B*d,w[3]=u*x*d-q*B*y;break;case"zyx":w[0]=q*x*d-u*B*y,w[1]=u*B*d+q*x*y,w[2]=u*x*y-q*B*d,w[3]=u*x*d+q*B*y;break;default:throw new Error(`Unknown rotation order: ${l}`)}return w}function W(k,Z){let U=Z??new t(4);return U[0]=k[0],U[1]=k[1],U[2]=k[2],U[3]=k[3],U}let H=W;function j(k,Z,U){let l=U??new t(4);return l[0]=k[0]+Z[0],l[1]=k[1]+Z[1],l[2]=k[2]+Z[2],l[3]=k[3]+Z[3],l}function K(k,Z,U){let l=U??new t(4);return l[0]=k[0]-Z[0],l[1]=k[1]-Z[1],l[2]=k[2]-Z[2],l[3]=k[3]-Z[3],l}let tt=K;function ut(k,Z,U){let l=U??new t(4);return l[0]=k[0]*Z,l[1]=k[1]*Z,l[2]=k[2]*Z,l[3]=k[3]*Z,l}let J=ut;function rt(k,Z,U){let l=U??new t(4);return l[0]=k[0]/Z,l[1]=k[1]/Z,l[2]=k[2]/Z,l[3]=k[3]/Z,l}function D(k,Z){return k[0]*Z[0]+k[1]*Z[1]+k[2]*Z[2]+k[3]*Z[3]}function a(k,Z,U,l){let b=l??new t(4);return b[0]=k[0]+U*(Z[0]-k[0]),b[1]=k[1]+U*(Z[1]-k[1]),b[2]=k[2]+U*(Z[2]-k[2]),b[3]=k[3]+U*(Z[3]-k[3]),b}function v(k){let Z=k[0],U=k[1],l=k[2],b=k[3];return Math.sqrt(Z*Z+U*U+l*l+b*b)}let T=v;function M(k){let Z=k[0],U=k[1],l=k[2],b=k[3];return Z*Z+U*U+l*l+b*b}let S=M;function E(k,Z){let U=Z??new t(4),l=k[0],b=k[1],w=k[2],A=k[3],z=Math.sqrt(l*l+b*b+w*w+A*A);return z>1e-5?(U[0]=l/z,U[1]=b/z,U[2]=w/z,U[3]=A/z):(U[0]=0,U[1]=0,U[2]=0,U[3]=1),U}function R(k,Z){return Math.abs(k[0]-Z[0])<Tt&&Math.abs(k[1]-Z[1])<Tt&&Math.abs(k[2]-Z[2])<Tt&&Math.abs(k[3]-Z[3])<Tt}function P(k,Z){return k[0]===Z[0]&&k[1]===Z[1]&&k[2]===Z[2]&&k[3]===Z[3]}function h(k){let Z=k??new t(4);return Z[0]=0,Z[1]=0,Z[2]=0,Z[3]=1,Z}let G=e.create(),ot=e.create(),at=e.create();function st(k,Z,U){let l=U??new t(4),b=e.dot(k,Z);return b<-.999999?(e.cross(ot,k,G),e.len(G)<1e-6&&e.cross(at,k,G),e.normalize(G,G),o(G,Math.PI,l),l):b>.999999?(l[0]=0,l[1]=0,l[2]=0,l[3]=1,l):(e.cross(k,Z,G),l[0]=G[0],l[1]=G[1],l[2]=G[2],l[3]=1+b,E(l,l))}let ct=new t(4),yt=new t(4);function pt(k,Z,U,l,b,w){let A=w??new t(4);return N(k,l,b,ct),N(Z,U,b,yt),N(ct,yt,2*b*(1-b),A),A}return{create:n,fromValues:r,set:i,fromAxisAngle:o,toAxisAngle:s,angle:c,multiply:f,mul:p,rotateX:g,rotateY:F,rotateZ:C,slerp:N,inverse:m,conjugate:V,fromMat:Y,fromEuler:et,copy:W,clone:H,add:j,subtract:K,sub:tt,mulScalar:ut,scale:J,divScalar:rt,dot:D,lerp:a,length:v,len:T,lengthSq:M,lenSq:S,normalize:E,equalsApproximately:R,equals:P,identity:h,rotationTo:st,sqlerp:pt}}var bi=new Map;function cu(t){let e=bi.get(t);return e||(e=uu(t),bi.set(t,e)),e}function fu(t){function e(U,l,b,w){let A=new t(4);return U!==void 0&&(A[0]=U,l!==void 0&&(A[1]=l,b!==void 0&&(A[2]=b,w!==void 0&&(A[3]=w)))),A}let n=e;function r(U,l,b,w,A){let z=A??new t(4);return z[0]=U,z[1]=l,z[2]=b,z[3]=w,z}function i(U,l){let b=l??new t(4);return b[0]=Math.ceil(U[0]),b[1]=Math.ceil(U[1]),b[2]=Math.ceil(U[2]),b[3]=Math.ceil(U[3]),b}function o(U,l){let b=l??new t(4);return b[0]=Math.floor(U[0]),b[1]=Math.floor(U[1]),b[2]=Math.floor(U[2]),b[3]=Math.floor(U[3]),b}function s(U,l){let b=l??new t(4);return b[0]=Math.round(U[0]),b[1]=Math.round(U[1]),b[2]=Math.round(U[2]),b[3]=Math.round(U[3]),b}function c(U,l=0,b=1,w){let A=w??new t(4);return A[0]=Math.min(b,Math.max(l,U[0])),A[1]=Math.min(b,Math.max(l,U[1])),A[2]=Math.min(b,Math.max(l,U[2])),A[3]=Math.min(b,Math.max(l,U[3])),A}function f(U,l,b){let w=b??new t(4);return w[0]=U[0]+l[0],w[1]=U[1]+l[1],w[2]=U[2]+l[2],w[3]=U[3]+l[3],w}function p(U,l,b,w){let A=w??new t(4);return A[0]=U[0]+l[0]*b,A[1]=U[1]+l[1]*b,A[2]=U[2]+l[2]*b,A[3]=U[3]+l[3]*b,A}function g(U,l,b){let w=b??new t(4);return w[0]=U[0]-l[0],w[1]=U[1]-l[1],w[2]=U[2]-l[2],w[3]=U[3]-l[3],w}let F=g;function C(U,l){return Math.abs(U[0]-l[0])<Tt&&Math.abs(U[1]-l[1])<Tt&&Math.abs(U[2]-l[2])<Tt&&Math.abs(U[3]-l[3])<Tt}function N(U,l){return U[0]===l[0]&&U[1]===l[1]&&U[2]===l[2]&&U[3]===l[3]}function m(U,l,b,w){let A=w??new t(4);return A[0]=U[0]+b*(l[0]-U[0]),A[1]=U[1]+b*(l[1]-U[1]),A[2]=U[2]+b*(l[2]-U[2]),A[3]=U[3]+b*(l[3]-U[3]),A}function V(U,l,b,w){let A=w??new t(4);return A[0]=U[0]+b[0]*(l[0]-U[0]),A[1]=U[1]+b[1]*(l[1]-U[1]),A[2]=U[2]+b[2]*(l[2]-U[2]),A[3]=U[3]+b[3]*(l[3]-U[3]),A}function Y(U,l,b){let w=b??new t(4);return w[0]=Math.max(U[0],l[0]),w[1]=Math.max(U[1],l[1]),w[2]=Math.max(U[2],l[2]),w[3]=Math.max(U[3],l[3]),w}function et(U,l,b){let w=b??new t(4);return w[0]=Math.min(U[0],l[0]),w[1]=Math.min(U[1],l[1]),w[2]=Math.min(U[2],l[2]),w[3]=Math.min(U[3],l[3]),w}function W(U,l,b){let w=b??new t(4);return w[0]=U[0]*l,w[1]=U[1]*l,w[2]=U[2]*l,w[3]=U[3]*l,w}let H=W;function j(U,l,b){let w=b??new t(4);return w[0]=U[0]/l,w[1]=U[1]/l,w[2]=U[2]/l,w[3]=U[3]/l,w}function K(U,l){let b=l??new t(4);return b[0]=1/U[0],b[1]=1/U[1],b[2]=1/U[2],b[3]=1/U[3],b}let tt=K;function ut(U,l){return U[0]*l[0]+U[1]*l[1]+U[2]*l[2]+U[3]*l[3]}function J(U){let l=U[0],b=U[1],w=U[2],A=U[3];return Math.sqrt(l*l+b*b+w*w+A*A)}let rt=J;function D(U){let l=U[0],b=U[1],w=U[2],A=U[3];return l*l+b*b+w*w+A*A}let a=D;function v(U,l){let b=U[0]-l[0],w=U[1]-l[1],A=U[2]-l[2],z=U[3]-l[3];return Math.sqrt(b*b+w*w+A*A+z*z)}let T=v;function M(U,l){let b=U[0]-l[0],w=U[1]-l[1],A=U[2]-l[2],z=U[3]-l[3];return b*b+w*w+A*A+z*z}let S=M;function E(U,l){let b=l??new t(4),w=U[0],A=U[1],z=U[2],O=U[3],q=Math.sqrt(w*w+A*A+z*z+O*O);return q>1e-5?(b[0]=w/q,b[1]=A/q,b[2]=z/q,b[3]=O/q):(b[0]=0,b[1]=0,b[2]=0,b[3]=0),b}function R(U,l){let b=l??new t(4);return b[0]=-U[0],b[1]=-U[1],b[2]=-U[2],b[3]=-U[3],b}function P(U,l){let b=l??new t(4);return b[0]=U[0],b[1]=U[1],b[2]=U[2],b[3]=U[3],b}let h=P;function G(U,l,b){let w=b??new t(4);return w[0]=U[0]*l[0],w[1]=U[1]*l[1],w[2]=U[2]*l[2],w[3]=U[3]*l[3],w}let ot=G;function at(U,l,b){let w=b??new t(4);return w[0]=U[0]/l[0],w[1]=U[1]/l[1],w[2]=U[2]/l[2],w[3]=U[3]/l[3],w}let st=at;function ct(U){let l=U??new t(4);return l[0]=0,l[1]=0,l[2]=0,l[3]=0,l}function yt(U,l,b){let w=b??new t(4),A=U[0],z=U[1],O=U[2],q=U[3];return w[0]=l[0]*A+l[4]*z+l[8]*O+l[12]*q,w[1]=l[1]*A+l[5]*z+l[9]*O+l[13]*q,w[2]=l[2]*A+l[6]*z+l[10]*O+l[14]*q,w[3]=l[3]*A+l[7]*z+l[11]*O+l[15]*q,w}function pt(U,l,b){let w=b??new t(4);return E(U,w),W(w,l,w)}function k(U,l,b){let w=b??new t(4);return J(U)>l?pt(U,l,w):P(U,w)}function Z(U,l,b){let w=b??new t(4);return m(U,l,.5,w)}return{create:e,fromValues:n,set:r,ceil:i,floor:o,round:s,clamp:c,add:f,addScaled:p,subtract:g,sub:F,equalsApproximately:C,equals:N,lerp:m,lerpV:V,max:Y,min:et,mulScalar:W,scale:H,divScalar:j,inverse:K,invert:tt,dot:ut,length:J,len:rt,lengthSq:D,lenSq:a,distance:v,dist:T,distanceSq:M,distSq:S,normalize:E,negate:R,copy:P,clone:h,multiply:G,mul:ot,divide:at,div:st,zero:ct,transformMat4:yt,setLength:pt,truncate:k,midpoint:Z}}var Ti=new Map;function lu(t){let e=Ti.get(t);return e||(e=fu(t),Ti.set(t,e)),e}function un(t,e,n,r,i,o){return{mat3:ou(t),mat4:su(e),quat:cu(n),vec2:_i(r),vec3:fr(i),vec4:lu(o)}}var{mat3:xe,mat4:Et,quat:Ml,vec2:jt,vec3:pe,vec4:Si}=un(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:bl,mat4:Tl,quat:_l,vec2:Sl,vec3:Bl,vec4:Pl}=un(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:Dl,mat4:Ul,quat:Gl,vec2:Fl,vec3:Il,vec4:Al}=un(eu,Array,Array,Array,Array,Array);var lr=class{device;format="r8unorm";downsizeFactor;multisample;textureSimple;textureMultisampled=null;renderPipeline;bindgroup;uniformsBuffer;trianglesBuffer;constructor(e){this.device=e.device,this.downsizeFactor=e.blurFactor,this.multisample=this.downsizeFactor>1?4:1,[this.textureSimple,this.textureMultisampled]=this.createTextures(e.width,e.height),this.trianglesBuffer=e.trianglesBuffer;let n=this.device.createShaderModule({label:"DisplacementTexture shader module",code:gi});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementTexture renderpipeline",layout:"auto",vertex:{module:n,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x2"}],arrayStride:2*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"}]},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:this.format}]},primitive:{cullMode:"none",topology:"triangle-list"},multisample:{count:this.multisample}}),this.uniformsBuffer=this.device.createBuffer({label:"DisplacementTexture uniforms buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bindgroup=this.device.createBindGroup({label:"DisplacementTexture bindgroup",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformsBuffer}}]})}update(e){let n=this.textureMultisampled??this.textureSimple,r={view:n.view,clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"};this.textureMultisampled&&(r.resolveTarget=this.textureSimple.view);let i=e.beginRenderPass({label:"DisplacementTexture render to texture renderpass",colorAttachments:[r]}),[o,s]=[n.texture.width,n.texture.height];i.setViewport(0,0,o,s,0,1),i.setScissorRect(0,0,o,s),i.setPipeline(this.renderPipeline),i.setBindGroup(0,this.bindgroup),i.setVertexBuffer(0,this.trianglesBuffer.bufferGpu),i.draw(3*this.trianglesBuffer.spriteCount),i.end()}resize(e,n){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),[this.textureSimple,this.textureMultisampled]=this.createTextures(e,n)}setViewport(e){let n=[1,1,1],r=0,i=[1,1,0],o=Et.identity();Et.multiply(Et.scaling(n),o,o),Et.multiply(Et.rotationZ(r),o,o),Et.multiply(Et.translation(i),o,o);let s=Et.translation([-e.position[0],-e.position[1],0]),c=e.width/e.zoom,f=e.height/e.zoom,p=Et.ortho(0,c,f,0,-10,10),g=Et.identity();Et.multiply(s,o,g),Et.multiply(p,g,g),this.device.queue.writeBuffer(this.uniformsBuffer,0,g)}getView(){return this.textureSimple.view}destroy(){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),this.uniformsBuffer.destroy()}createTextures(e,n){let r=this.device.createTexture({label:"DisplacementTexture texture",size:[Math.ceil(e/this.downsizeFactor),Math.ceil(n/this.downsizeFactor)],format:this.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),i={texture:r,view:r.createView({label:"DisplacementTexture texture view"})},o=null;if(this.multisample>1){let s=this.device.createTexture({label:"DisplacementTexture texture multisampled",size:[r.width,r.height],format:r.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.multisample});o={texture:s,view:s.createView({label:"DisplacementTexture texture multisampled view"})}}return[i,o]}};var Pi={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return hu(t,e)},onRun:function(t,e,n){pu(t,e,n)},onDestroy:function(t,e){vu(e)},onResize:function(t,e){e.data.displacementTexture.resize(t.viewport.width,t.viewport.height),e.data.displacementComposition.setColorTextureView(e.refs.color.data.view),e.data.displacementComposition.setNoiseMapTextureView(e.refs.map.view),e.data.displacementComposition.setDisplacementTextureView(e.data.displacementTexture.getView())},onViewportPosition:function(t,e){e.data.displacementTexture.setViewport(t.viewport)},customFunctions:{addTriangle:function(t,e,n){return e.data.trianglesBuffer.addTriangle(n)},removeTriangle:function(t,e,n){e.data.trianglesBuffer.removeTriangle(n)},setPosition:function(t,e,n,r){e.data.trianglesBuffer.setTriangle(n,r)}}};async function hu(t,e){let{device:n}=t,r=new ur({device:n,initialParameters:{offsetX:e.options.offseyX??0,offsetY:e.options.offseyY??0,scale:e.options.scale??20}}),i=256,o=new sr({device:n,maxSpriteCount:i}),s=new lr({device:n,width:t.viewport.width,height:t.viewport.height,blurFactor:8,trianglesBuffer:o}),c=new cr({device:n,targetFormat:"bgra8unorm",colorTextureView:e.refs.color.data.view,noiseMapTextureView:e.refs.map.view,displacementTextureView:s.getView(),displacementParametersBuffer:r});return{displacementParameters:r,displacementTexture:s,displacementComposition:c,trianglesBuffer:o}}function pu(t,e,n){if(e.data.trianglesBuffer.spriteCount===0)return;e.data.trianglesBuffer.update(),e.data.displacementTexture.update(n);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});i.executeBundles([e.data.displacementComposition.getRenderBundle()]),i.end()}function vu(t){t.data.trianglesBuffer.destroy(),t.data.trianglesBuffer=null,t.data.displacementParameters.destroy(),t.data.displacementParameters=null,t.data.displacementTexture.destroy(),t.data.displacementTexture=null,t.data.displacementComposition.destroy(),t.data.displacementComposition=null}function cn(t,e){let n=e.vertices,r=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,i={size:n.byteLength,usage:r,mappedAtCreation:!0},o=t.createBuffer(i);return new Float32Array(o.getMappedRange()).set(n),o.unmap(),{buffer:o,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var fn="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var jl=Si.create(),Di=pe.create(),Gi={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return du(t,e)},onRun:function(t,e,n){gu(t,e,n)},onDestroy:function(t,e){xu(e)},onResize:function(t,e){Ui(t,e)},onViewportPosition:function(t,e){Ui(t,e)},customFunctions:{...$e}};async function du(t,e){let{device:n}=t,r=16192,i=r,s=Float32Array.BYTES_PER_ELEMENT*2,f=Float32Array.BYTES_PER_ELEMENT*2,g=Float32Array.BYTES_PER_ELEMENT*4,C=Float32Array.BYTES_PER_ELEMENT*4,N=n.createBuffer({size:(s+f+g+C)*i,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),m=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),V=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),Y=n.createBindGroup({layout:V,entries:[{binding:0,resource:{buffer:m}},{binding:1,resource:e.refs.spritesheet.data.colorTexture.view},{binding:2,resource:e.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:N}}]}),et=n.createPipelineLayout({bindGroupLayouts:[V]}),W=n.createRenderPipeline({label:"overlay",vertex:{module:n.createShaderModule({code:fn}),entryPoint:"vs_main",buffers:[e.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:n.createShaderModule({code:fn}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:et});return{instancedDrawCalls:new Uint32Array(r*2),instancedDrawCallCount:0,spriteBuffer:N,uniformBuffer:m,pipeline:W,bindGroupLayout:V,bindGroup:Y,spriteData:new Float32Array(r*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function gu(t,e,n){let{device:r}=t,i=e.options.loadOp||"load";if(e.data.dirty&&(wu(e.data),e.data.dirty=!1),e.data.spriteCount>0){let f=e.data.spriteCount*12*Float32Array.BYTES_PER_ELEMENT;r.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer,0,f)}let o=n.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:i,storeOp:"store"}]});o.setPipeline(e.data.pipeline),o.setBindGroup(0,e.data.bindGroup),o.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let s=6,c=0;for(let f=0;f<e.data.instancedDrawCallCount;f++){let p=e.data.instancedDrawCalls[f*2]*s,g=e.data.instancedDrawCalls[f*2+1];o.draw(s,g,p,c),c+=g}o.end()}function wu(t){let e=-1,n=0;t.instancedDrawCallCount=0;for(let r=0;r<t.spriteCount;r++){let i=t.spriteData[r*12+11]&65535;i!==e&&(n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++),e=i,n=0),n++}n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++)}function Ui(t,e){let r=Math.round(t.viewport.width/1),i=Math.round(t.viewport.height/1),o=Et.ortho(0,r,i,0,-10,10);pe.set(0,0,0,Di);let s=Et.translation(Di);t.device.queue.writeBuffer(e.data.uniformBuffer,0,s.buffer),t.device.queue.writeBuffer(e.data.uniformBuffer,64,o.buffer)}function xu(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var hn="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var Fi={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return yu(t,e)},onRun:function(t,e,n){Mu(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){bu(t,e)},onViewportPosition:function(t,e){}};async function yu(t,e){let{device:n}=t,r=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),i=n.createBindGroup({layout:r,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]}),o=n.createPipelineLayout({bindGroupLayouts:[r]}),s=n.createRenderPipeline({label:"fb-blit",vertex:{module:n.createShaderModule({code:hn}),entryPoint:"vs_main",buffers:[]},fragment:{module:n.createShaderModule({code:hn}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:o});return{bindGroupLayout:r,bindGroup:i,pipeline:s}}function Mu(t,e,n){let{device:r}=t,i=n.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.draw(3),i.end()}function bu(t,e){let{device:n}=t;e.data.bindGroup=n.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]})}var Ii="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";var cs=ri(ao(),1);var us=ri(ss(),1);function Kn(t,e){if(!Array.isArray(t))throw new Error("poly-to-pslg: Error, invalid polygon");if(t.length===0)return{points:[],edges:[]};e=e||{};var n=!0;"nested"in e?n=!!e.nested:t[0].length===2&&typeof t[0][0]=="number"&&(n=!1),n||(t=[t]);for(var r=[],i=[],o=0;o<t.length;++o)for(var s=t[o],c=r.length,f=0;f<s.length;++f)r.push(s[f]),i.push([c+f,c+(f+1)%s.length]);var p="clean"in e?!0:!!e.clean;return p&&(0,us.default)(r,i),{points:r,edges:i}}var fs={line:Ae,save:function(t,e){e.data.transforms.push(xe.clone(e.data.transforms.at(-1)))},restore:function(t,e){e.data.transforms.length>1&&e.data.transforms.pop()},translate:function(t,e,n){let r=e.data.transforms.at(-1);xe.translate(r,n,r)},rotate:function(t,e,n){let r=e.data.transforms.at(-1);xe.rotate(r,n,r)},scale:function(t,e,n){let r=e.data.transforms.at(-1);xe.scale(r,n,r)},strokePath:function(t,e,n,r,i=1){for(let o of n)Ae(t,e,o[0],o[1],r,i)},filledPath:function(t,e,n,r){let i=Kn(n),o=(0,cs.default)(i.points,i.edges,{exterior:!1}),s=e.data.transforms.at(-1),c=e.data.vertexCount*6,f=jt.create();for(let p of o)jt.transformMat3(n[p[0]],s,f),e.data.vertices[c+0]=f[0],e.data.vertices[c+1]=f[1],e.data.vertices[c+2]=r[0],e.data.vertices[c+3]=r[1],e.data.vertices[c+4]=r[2],e.data.vertices[c+5]=r[3],jt.transformMat3(n[p[1]],s,f),e.data.vertices[c+6]=f[0],e.data.vertices[c+7]=f[1],e.data.vertices[c+8]=r[0],e.data.vertices[c+9]=r[1],e.data.vertices[c+10]=r[2],e.data.vertices[c+11]=r[3],jt.transformMat3(n[p[2]],s,f),e.data.vertices[c+12]=f[0],e.data.vertices[c+13]=f[1],e.data.vertices[c+14]=r[0],e.data.vertices[c+15]=r[1],e.data.vertices[c+16]=r[2],e.data.vertices[c+17]=r[3],c+=18;e.data.vertexCount+=3*o.length,e.data.dirty=!0},ellipse:function(t,e,n,r,i,o,s,c=1){let[f,p]=n,g=2*Math.PI/o;for(let F=0;F<o;F++){let C=F*g,N=(F+1)*g,m=f+r*Math.cos(C),V=p+i*Math.sin(C),Y=f+r*Math.cos(N),et=p+i*Math.sin(N);Ae(t,e,[m,V],[Y,et],s,c)}},filledEllipse:function(t,e,n,r,i,o,s){let[c,f]=n,p=2*Math.PI/o,g=e.data.transforms.at(-1);for(let F=0;F<o;F++){let C=F*p,N=(F+1)*p,m=c+r*Math.cos(C),V=f+i*Math.sin(C),Y=c+r*Math.cos(N),et=f+i*Math.sin(N),H=e.data.vertexCount*6+F*18,j=jt.transformMat3([c,f],g);e.data.vertices[H+0]=j[0],e.data.vertices[H+1]=j[1],e.data.vertices[H+2]=s[0],e.data.vertices[H+3]=s[1],e.data.vertices[H+4]=s[2],e.data.vertices[H+5]=s[3],jt.transformMat3([m,V],g,j),e.data.vertices[H+6]=j[0],e.data.vertices[H+7]=j[1],e.data.vertices[H+8]=s[0],e.data.vertices[H+9]=s[1],e.data.vertices[H+10]=s[2],e.data.vertices[H+11]=s[3],jt.transformMat3([Y,et],g,j),e.data.vertices[H+12]=j[0],e.data.vertices[H+13]=j[1],e.data.vertices[H+14]=s[0],e.data.vertices[H+15]=s[1],e.data.vertices[H+16]=s[2],e.data.vertices[H+17]=s[3]}e.data.vertexCount+=3*o,e.data.dirty=!0},box:function(t,e,n,r,i,o,s=1){let[c,f]=n,p=r/2,g=i/2,F=[c-p,f-g],C=[c+p,f-g],N=[c-p,f+g],m=[c+p,f+g];Ae(t,e,F,C,o,s),Ae(t,e,N,m,o,s),Ae(t,e,F,N,o,s),Ae(t,e,C,m,o,s)},filledBox:function(t,e,n,r,i,o){let[s,c]=n,f=r/2,p=i/2,g=e.data.transforms.at(-1),F=jt.transformMat3([s-f,c-p],g),C=jt.transformMat3([s+f,c-p],g),N=jt.transformMat3([s-f,c+p],g),m=jt.transformMat3([s+f,c+p],g),V=e.data.vertexCount*6;e.data.vertices[V+0]=F[0],e.data.vertices[V+1]=F[1],e.data.vertices[V+2]=o[0],e.data.vertices[V+3]=o[1],e.data.vertices[V+4]=o[2],e.data.vertices[V+5]=o[3],e.data.vertices[V+6]=N[0],e.data.vertices[V+7]=N[1],e.data.vertices[V+8]=o[0],e.data.vertices[V+9]=o[1],e.data.vertices[V+10]=o[2],e.data.vertices[V+11]=o[3],e.data.vertices[V+12]=C[0],e.data.vertices[V+13]=C[1],e.data.vertices[V+14]=o[0],e.data.vertices[V+15]=o[1],e.data.vertices[V+16]=o[2],e.data.vertices[V+17]=o[3],e.data.vertices[V+18]=N[0],e.data.vertices[V+19]=N[1],e.data.vertices[V+20]=o[0],e.data.vertices[V+21]=o[1],e.data.vertices[V+22]=o[2],e.data.vertices[V+23]=o[3],e.data.vertices[V+24]=m[0],e.data.vertices[V+25]=m[1],e.data.vertices[V+26]=o[0],e.data.vertices[V+27]=o[1],e.data.vertices[V+28]=o[2],e.data.vertices[V+29]=o[3],e.data.vertices[V+30]=C[0],e.data.vertices[V+31]=C[1],e.data.vertices[V+32]=o[0],e.data.vertices[V+33]=o[1],e.data.vertices[V+34]=o[2],e.data.vertices[V+35]=o[3],e.data.vertexCount+=6,e.data.dirty=!0},clear:function(t,e){e.data.vertexCount=0,e.data.transforms.length=1,xe.identity(e.data.transforms[0]),e.data.dirty=!0}};function Ae(t,e,n,r,i,o=1){let s=e.data.transforms.at(-1);n=jt.transformMat3(n,s),r=jt.transformMat3(r,s);let c=jt.sub(r,n),f=jt.normalize(c),p=Bf(f),g=o/2,F=e.data.vertexCount*6;e.data.vertices[F+0]=n[0]+p[0]*g,e.data.vertices[F+1]=n[1]+p[1]*g,e.data.vertices[F+2]=i[0],e.data.vertices[F+3]=i[1],e.data.vertices[F+4]=i[2],e.data.vertices[F+5]=i[3],e.data.vertices[F+6]=n[0]-p[0]*g,e.data.vertices[F+7]=n[1]-p[1]*g,e.data.vertices[F+8]=i[0],e.data.vertices[F+9]=i[1],e.data.vertices[F+10]=i[2],e.data.vertices[F+11]=i[3],e.data.vertices[F+12]=r[0]+p[0]*g,e.data.vertices[F+13]=r[1]+p[1]*g,e.data.vertices[F+14]=i[0],e.data.vertices[F+15]=i[1],e.data.vertices[F+16]=i[2],e.data.vertices[F+17]=i[3],e.data.vertices[F+18]=n[0]-p[0]*g,e.data.vertices[F+19]=n[1]-p[1]*g,e.data.vertices[F+20]=i[0],e.data.vertices[F+21]=i[1],e.data.vertices[F+22]=i[2],e.data.vertices[F+23]=i[3],e.data.vertices[F+24]=r[0]+p[0]*g,e.data.vertices[F+25]=r[1]+p[1]*g,e.data.vertices[F+26]=i[0],e.data.vertices[F+27]=i[1],e.data.vertices[F+28]=i[2],e.data.vertices[F+29]=i[3],e.data.vertices[F+30]=r[0]-p[0]*g,e.data.vertices[F+31]=r[1]-p[1]*g,e.data.vertices[F+32]=i[0],e.data.vertices[F+33]=i[1],e.data.vertices[F+34]=i[2],e.data.vertices[F+35]=i[3],e.data.vertexCount+=6,e.data.dirty=!0}function Bf(t){return[-t[1],t[0]]}var ls=pe.create(0,0,0),ps={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Pf(t,e)},onRun:function(t,e,n){Df(t,e,n)},onDestroy:function(t,e){Uf(e)},onResize:function(t,e){hs(t,e)},onViewportPosition:function(t,e){hs(t,e)},customFunctions:fs};async function Pf(t,e){let{device:n}=t,r=new Float32Array(3e5),i=n.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),o=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),s=n.createShaderModule({code:Ii}),c=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),f=n.createPipelineLayout({bindGroupLayouts:[c]}),p=n.createBindGroup({layout:c,entries:[{binding:0,resource:{buffer:o}}]}),g=n.createRenderPipeline({layout:f,vertex:{module:s,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:s,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:o,vertexBuffer:i,pipeline:g,bindGroup:p,vertexCount:0,dirty:!1,vertices:r,transforms:[xe.identity()]}}function Df(t,e,n){if(e.data.vertexCount===0)return;let{device:r}=t;if(e.data.dirty){e.data.dirty=!1;let s=6*Float32Array.BYTES_PER_ELEMENT,c=e.data.vertexCount*s;if(c>e.data.vertexBuffer.size){console.warn("too many primitives, bailing");return}t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer,0,c)}let i=e.options.loadOp||"load",o=n.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:i,storeOp:"store"}]});o.setPipeline(e.data.pipeline),o.setBindGroup(0,e.data.bindGroup),o.setVertexBuffer(0,e.data.vertexBuffer),o.draw(e.data.vertexCount),o.end()}function Uf(t){t.data.vertexBuffer.destroy(),t.data.vertexBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.transforms.length=0}function hs(t,e){let{device:n}=t,r=t.viewport.width/t.viewport.zoom,i=t.viewport.height/t.viewport.zoom,o=Et.ortho(0,r,i,0,-10,10);pe.set(-t.viewport.position[0]-1,-t.viewport.position[1]-1,0,ls);let s=Et.translation(ls);n.queue.writeBuffer(e.data.uniformBuffer,0,s.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,o.buffer)}var Jn={};ei(Jn,{setAmbientLight:()=>Ff,setLights:()=>Gf,setOccluders:()=>If});function Gf(t,e,n){e.data.lights=n,e.data.lightsBufferNeedsUpdate=!0}function Ff(t,e,n){e.data.lightsRenderer.setAmbientLight(n)}function If(t,e,n){e.data.lightsRenderer.setObstacles(n),e.data.lightsTextureNeedsUpdate=!0}var mr=class{invViewProjectionMatrix=Et.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(e){this.setViewportSize(e.viewportSize.width,e.viewportSize.height);let n=e.center??this.topLeft;this.setTopLeft(...n);let r=e.zoom??1;this.setZoom(r)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(e,n){this.viewportSize.width=e,this.viewportSize.height=n,this.updateMatrices()}setTopLeft(e,n){this.topLeft[0]=e,this.topLeft[1]=n,this.updateMatrices()}setZoom(e){this.zoom=e,this.updateMatrices()}updateMatrices(){Et.identity(this.invViewProjectionMatrix),Et.multiply(Et.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Et.multiply(Et.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Et.multiply(Et.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Et.multiply(Et.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var se=class t{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(e,n){this.device=e,this.maxLightsCount=n;let r=new ArrayBuffer(t.computeBufferBytesLength(n)),i=e.createBuffer({label:"LightsBuffer buffer",size:r.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:r,bufferGpu:i},this.setLights([])}setLights(e){if(e.length>this.maxLightsCount)throw new Error(`Too many lights "${e.length}", max is "${this.maxLightsCount}".`);let n=t.computeBufferBytesLength(e.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([e.length]),e.forEach((r,i)=>{new Float32Array(this.buffer.bufferCpu,t.structs.lightsBuffer.lights.offset+t.structs.lightsBuffer.lights.stride*i,9).set([...r.color,r.radius,...r.position,r.intensity,r.attenuationLinear,r.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,n),this.currentLightsCount=e.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(e){return t.structs.lightsBuffer.lights.offset+t.structs.lightsBuffer.lights.stride*e}};var Or=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(e,n,r,i){this.lightsBuffer=n;let o=e.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${se.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${r.gridSize.x}, ${r.gridSize.y});
const cellsGridSizeF = vec2<f32>(${r.gridSize.x}, ${r.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${i}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=e.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:o,entryPoint:"main_vertex"},fragment:{module:o,entryPoint:"main_fragment",targets:[{format:r.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:r.sampleCount}}),this.bindgroup=e.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let s=e.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[r.format],sampleCount:r.sampleCount});s.setPipeline(this.renderPipeline),s.setBindGroup(0,this.bindgroup),s.draw(4),this.renderBundle=s.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var Vr=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(e,n,r,i){this.device=e,this.lightsBuffer=n;let o=!0,s=e.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${r.gridSize.x}, ${r.gridSize.y});
const cellsGridSizeF = vec2<f32>(${r.gridSize.x}, ${r.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${i});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=e.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:s,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:se.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:se.structs.light.position.offset,format:"float32x2"}],arrayStride:se.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:s,entryPoint:"main_fragment",targets:[{format:r.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:o?"none":"back",topology:"triangle-list"},multisample:{count:r.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:e.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[r.format],sampleCount:r.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(e){let n=[],r=[];for(let p of e){let g=n.length/3;n.push(...p[0],0,...p[1],0,...p[0],1,...p[1],1),r.push(g+0,g+1,g+3,g+0,g+3,g+2)}let i=!1,o=new Float32Array(n),s=this.obstacles?.positionsBufferGpu;(!s||s.size<o.byteLength)&&(s?.destroy(),s=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:o.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),i=!0),this.device.queue.writeBuffer(s,0,o);let c=new Uint16Array(r),f=this.obstacles?.indexBufferGpu;(!f||f.size<c.byteLength)&&(f?.destroy(),f=this.device.createBuffer({label:"LightsTextureMask index buffer",size:c.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),i=!0),this.device.queue.writeBuffer(f,0,c),this.obstacles={positionsBufferGpu:s,indexBufferGpu:f},this.setIndirectIndexCount(r.length),i&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(e){this.setIndirectInstanceCount(e)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(e){let n=new Uint32Array(this.indirectDrawing.bufferCpu);n[0]!==e&&(n[0]=e,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(e){let n=new Uint32Array(this.indirectDrawing.bufferCpu);n[1]!==e&&(n[1]=e,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let e=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(e.setPipeline(this.renderPipeline),e.setVertexBuffer(0,this.obstacles.positionsBufferGpu),e.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,se.structs.lightsBuffer.lights.offset),e.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),e.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),e.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var qr=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(e,n,r){this.lightsBuffer=n;let i=this.lightsBuffer.maxLightsCount/4,o={x:Math.ceil(Math.sqrt(i)),y:0};o.y=Math.ceil(i/o.x),this.gridSize=o;let s={width:o.x*r.resolutionPerLight,height:o.y*r.resolutionPerLight},c="rgba8unorm";this.texture=e.createTexture({label:"LightsTextureMask texture",size:[s.width,s.height],format:c,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),r.antialiased&&(this.textureMultisampled=e.createTexture({label:"LightsTextureMask texture multisampled",size:[s.width,s.height],format:c,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let p={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};r.antialiased&&(p.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[p]};let g={gridSize:o,format:c,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new Or(e,n,g,r.maxLightSize),this.textureMask=new Vr(e,n,g,r.maxLightSize)}update(e){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let n=e.beginRenderPass(this.textureRenderpassDescriptor),[r,i]=[this.texture.width,this.texture.height];n.setViewport(0,0,r,i,0,1),n.setScissorRect(0,0,r,i),n.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),n.end()}setObstacles(e){this.textureMask.setObstacles(e)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var Nr=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(e){this.device=e.device,this.targetTexture=e.targetTexture,this.lightsBuffer=e.lightsBuffer,this.lightsTexture=new qr(e.device,e.lightsBuffer,e.lightsTextureProperties),this.uniformsBufferGpu=e.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let n=e.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${se.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/e.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${e.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=e.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:n,entryPoint:"main_vertex"},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let r=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=e.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:r,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:e.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:e.lightsTextureProperties.filtering,minFilter:e.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(e.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(e){this.lightsTexture.update(e)}render(e,n){let r=new ArrayBuffer(80);new Float32Array(r,0,16).set(n),new Float32Array(r,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,r),e.executeBundles([this.renderBundle])}setAlbedo(e){this.bindgroup1=this.buildBindgroup1(e),this.renderBundle=this.buildRenderBundle()}setAmbientLight(e){this.ambientLight=[...e]}setObstacles(e){this.lightsTexture.setObstacles(e)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(e){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:e.view},{binding:1,resource:e.sampler}]})}buildRenderBundle(){let e=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindgroup0),e.setBindGroup(1,this.bindgroup1),e.draw(4),e.finish({label:"LightsRenderer renderbundle"})}};var vs={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return Af(t,e)},onRun:function(t,e,n){Ef(t,e,n)},onDestroy:function(t,e){Lf(e)},onResize:function(t,e){zf(t,e)},onViewportPosition:function(t,e){e.data.viewport.setTopLeft(...t.viewport.position)},customFunctions:{...Jn}};async function Af(t,e){let{device:n}=t,r=256,i=256,o=new se(n,r),s=new mr({viewportSize:{width:t.viewport.width,height:t.viewport.height},center:t.viewport.position,zoom:t.viewport.zoom}),c=new Nr({device:n,albedo:{view:e.refs.in.data.view,sampler:e.refs.in.data.sampler},targetTexture:e.refs.out.data.texture,lightsBuffer:o,lightsTextureProperties:{resolutionPerLight:i,maxLightSize:i,antialiased:!1,filtering:"nearest"}});return{lightsBuffer:o,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:c,viewport:s,lights:[]}}function Ef(t,e,n){e.data.lightsBufferNeedsUpdate&&(e.data.lightsBuffer.setLights(e.data.lights),e.data.lightsBufferNeedsUpdate=!1,e.data.lightsTextureNeedsUpdate=!0);let r=e.data.lightsRenderer;e.data.lightsTextureNeedsUpdate&&(r.computeLightsTexture(n),e.data.lightsTextureNeedsUpdate=!1);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.out.data.view,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});e.data.viewport.setZoom(t.viewport.zoom);let o=e.data.viewport.invertViewProjectionMatrix;r.render(i,o),i.end()}function Lf(t){t.data.lightsBuffer.destroy(),t.data.lightsRenderer.destroy()}function zf(t,e){e.data.lightsRenderer.setAlbedo({view:e.refs.in.data.view,sampler:e.refs.in.data.sampler}),e.data.viewport.setViewportSize(t.viewport.width,t.viewport.height)}var jn="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var we=new Float32Array(8),gs={type:"cobalt:tileAtlas",refs:[],onInit:async function(t,e={}){return Rf(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){mf(data)},onResize:function(t,e){ds(t,e)},onViewportPosition:function(t,e){ds(t,e)}};async function Rf(t,e){let{device:n}=t,r=await he(t,"tile atlas",e.options.textureUrl),i=n.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),o=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),s=n.createBindGroup({layout:o,entries:[{binding:0,resource:{buffer:i}},{binding:1,resource:r.view},{binding:2,resource:r.sampler}]}),c=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),f=n.createPipelineLayout({bindGroupLayouts:[c,o]});return{pipeline:n.createRenderPipeline({label:"tile",vertex:{module:n.createShaderModule({code:jn}),entryPoint:"vs_main",buffers:[]},fragment:{module:n.createShaderModule({code:jn}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:f}),uniformBuffer:i,atlasBindGroup:s,atlasMaterial:r,tileBindGroupLayout:c,tileSize:e.options.tileSize,tileScale:e.options.tileScale}}function mf(t){t.atlasMaterial.texture.destroy(),t.atlasMaterial.texture=void 0}function ds(t,e){we[0]=t.viewport.position[0],we[1]=t.viewport.position[1];let n=e.data,{tileScale:r,tileSize:i}=n,o=t.viewport.width/t.viewport.zoom,s=t.viewport.height/t.viewport.zoom;we[2]=o/r,we[3]=s/r,we[4]=1/n.atlasMaterial.texture.width,we[5]=1/n.atlasMaterial.texture.height,we[6]=i,we[7]=1/i,t.device.queue.writeBuffer(n.uniformBuffer,0,we,0,8)}function Cr(t){let n=Object.keys(t.frames).length,r=new Float32Array(n*30),i=[],o={},s=0;for(let c in t.frames){let f=t.frames[c];i.push(c),o[c]=f.sourceSize;let p=-.5+f.spriteSourceSize.x/f.sourceSize.w,g=-.5+f.spriteSourceSize.y/f.sourceSize.h,F=-.5+(f.spriteSourceSize.x+f.spriteSourceSize.w)/f.sourceSize.w,C=-.5+(f.spriteSourceSize.y+f.spriteSourceSize.h)/f.sourceSize.h,N=[p,g,0],m=[p,C,0],V=[F,C,0],Y=[F,g,0],et=0+f.frame.x/t.meta.size.w,W=0+f.frame.y/t.meta.size.h,H=0+(f.frame.x+f.frame.w)/t.meta.size.w,j=0+(f.frame.y+f.frame.h)/t.meta.size.h,K=[et,W],tt=[et,j],ut=[H,j],J=[H,W];r.set(N,s),r.set(K,s+3),r.set(m,s+5),r.set(tt,s+8),r.set(V,s+10),r.set(ut,s+13),r.set(N,s+15),r.set(K,s+18),r.set(V,s+20),r.set(ut,s+23),r.set(Y,s+25),r.set(J,s+28),s+=30}return{spriteMeta:o,locations:i,vertices:r}}var ti="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var ws=pe.create(0,0,0),ys={type:"cobalt:spritesheet",refs:[],onInit:async function(t,e={}){return Of(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){Vf(e)},onResize:function(t,e){xs(t,e)},onViewportPosition:function(t,e){xs(t,e)}};async function Of(t,e){let{canvas:n,device:r}=t,i,o,s;n?(i=await qf(e.options.spriteSheetJsonUrl),i=Cr(i),o=await he(t,"sprite",e.options.colorTextureUrl,"rgba8unorm"),s=await he(t,"emissive sprite",e.options.emissiveTextureUrl,"rgba8unorm"),n.style.imageRendering="pixelated"):(i=Cr(e.options.spriteSheetJson),o=await He(t,"sprite",e.options.colorTexture,"rgba8unorm"),s=await He(t,"emissive sprite",e.options.emissiveTexture,"rgba8unorm"));let c=cn(r,i),f=r.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),p=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),g=r.createPipelineLayout({bindGroupLayouts:[p]});return{pipeline:r.createRenderPipeline({label:"sprite",vertex:{module:r.createShaderModule({code:ti}),entryPoint:"vs_main",buffers:[c.bufferLayout]},fragment:{module:r.createShaderModule({code:ti}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:g}),uniformBuffer:f,quads:c,colorTexture:o,emissiveTexture:s,bindGroupLayout:p,spritesheet:i}}function Vf(t){t.data.quads.buffer.destroy(),t.data.colorTexture.buffer.destroy(),t.data.uniformBuffer.destroy(),t.data.emissiveTexture.texture.destroy()}async function qf(t){return(await fetch(t)).json()}function xs(t,e){let{device:n,viewport:r}=t,i=r.width/r.zoom,o=r.height/r.zoom,s=Et.ortho(0,i,o,0,-10,10);pe.set(-r.position[0],-r.position[1],0,ws);let c=Et.translation(ws);n.queue.writeBuffer(e.data.uniformBuffer,0,c.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,s.buffer)}var Ms={type:"fbTexture",refs:[],onInit:async function(t,e={}){return Nf(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){bs(data)},onResize:function(t,e){Cf(t,e)},onViewportPosition:function(t,e){}};async function Nf(t,e){let{device:n}=t,{label:r,mip_count:i,format:o,usage:s,viewportScale:c}=e.options;return ne(n,r,t.viewport.width*c,t.viewport.height*c,i,o,s)}function bs(t){t.data.texture.destroy()}function Cf(t,e){let{device:n}=t;bs(e);let{width:r,height:i}=t.viewport,{options:o}=e,s=e.options.viewportScale;e.data=ne(n,o.label,r*s,i*s,o.mip_count,o.format,o.usage)}async function hp(t,e,n){let r,i,o,s;return t.sdlWindow&&t.gpu?(i=t.gpu,r=await(await i.create(["verbose=1"]).requestAdapter()).requestDevice(),o=i.renderGPUDeviceToWindow({device:r,window:t.sdlWindow}),global.GPUBufferUsage=i.GPUBufferUsage,global.GPUShaderStage=i.GPUShaderStage,global.GPUTextureUsage=i.GPUTextureUsage):(s=t,r=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),i=navigator.gpu,o=s.getContext("webgpu"),o.configure({device:r,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":gs,"cobalt:spritesheet":ys,"cobalt:fbTexture":Ms,"cobalt:bloom":ai,"cobalt:composite":ci,"cobalt:sprite":hi,"cobalt:tile":vi,"cobalt:displacement":Pi,"cobalt:overlay":Gi,"cobalt:fbBlit":Fi,"cobalt:primitives":ps,"cobalt:light":vs},nodes:[],defaultTextureViewRefs:[],canvas:s,device:r,context:o,gpu:i,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:e,height:n,zoom:1,position:[0,0]}}}function pp(t,e){if(!e?.type)throw new Error("Can't define a new node missing a type.");t.nodeDefs[e.type]=e}async function vp(t,e){let n=t.nodeDefs[e?.type];if(!n)throw new Error("Can't initialize a new node missing a type.");let r={type:e.type,refs:e.refs||{},options:e.options||{},data:{},enabled:!0};for(let o in r.refs)r.refs[o]==="FRAME_TEXTURE_VIEW"&&(t.defaultTextureViewRefs.push({node:r,refName:o}),r.refs[o]=Ts(t));r.data=await n.onInit(t,r);let i=n.customFunctions||{};for(let o in i)r[o]=function(...s){return i[o](t,r,...s)};return t.nodes.push(r),r}function dp(t){let{device:e,context:n}=t,r=e.createCommandEncoder(),i=Ts(t);for(let o of t.defaultTextureViewRefs)o.node.refs[o.refName]=i;for(let o of t.nodes){if(!o.enabled)continue;t.nodeDefs[o.type].onRun(t,o,r)}e.queue.submit([r.finish()]),t.canvas||t.context.swap()}function gp(t){for(let e of t.nodes)t.nodeDefs[e.type].onDestroy(t,e);t.nodes.length=0,t.defaultTextureViewRefs.length=0}function wp(t,e,n){t.viewport.width=e,t.viewport.height=n;for(let r of t.nodes)t.nodeDefs[r.type].onResize(t,r)}function xp(t,e){t.viewport.position[0]=e[0]-t.viewport.width/2/t.viewport.zoom,t.viewport.position[1]=e[1]-t.viewport.height/2/t.viewport.zoom;for(let n of t.nodes)t.nodeDefs[n.type].onViewportPosition(t,n)}function fi(t){return t.canvas?navigator.gpu.getPreferredCanvasFormat():t.context.getPreferredFormat()}function Ts(t){return t.canvas?t.context.getCurrentTexture().createView():t.context.getCurrentTextureView()}export{ne as createTexture,He as createTextureFromBuffer,he as createTextureFromUrl,pp as defineNode,dp as draw,Ts as getCurrentTextureView,fi as getPreferredFormat,hp as init,vp as initNode,gp as reset,wp as setViewportDimensions,xp as setViewportPosition};

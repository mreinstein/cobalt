var Xs=Object.create;var ln=Object.defineProperty;var ks=Object.getOwnPropertyDescriptor;var Ys=Object.getOwnPropertyNames;var Hs=Object.getPrototypeOf,Zs=Object.prototype.hasOwnProperty;var xt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),hn=(e,t)=>{for(var n in t)ln(e,n,{get:t[n],enumerable:!0})},$s=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ys(t))!Zs.call(e,i)&&i!==n&&ln(e,i,{get:()=>t[i],enumerable:!(r=ks(t,i))||r.enumerable});return e};var vi=(e,t,n)=>(n=e!=null?Xs(Hs(e)):{},$s(t||!e||!e.__esModule?ln(n,"default",{value:e,enumerable:!0}):n,e));var je=xt((zl,Gi)=>{"use strict";function Du(e,t,n,r,i){for(var o=i+1;r<=i;){var a=r+i>>>1,f=e[a],h=n!==void 0?n(f,t):f-t;h>=0?(o=a,i=a-1):r=a+1}return o}function Fu(e,t,n,r,i){for(var o=i+1;r<=i;){var a=r+i>>>1,f=e[a],h=n!==void 0?n(f,t):f-t;h>0?(o=a,i=a-1):r=a+1}return o}function Au(e,t,n,r,i){for(var o=r-1;r<=i;){var a=r+i>>>1,f=e[a],h=n!==void 0?n(f,t):f-t;h<0?(o=a,r=a+1):i=a-1}return o}function Uu(e,t,n,r,i){for(var o=r-1;r<=i;){var a=r+i>>>1,f=e[a],h=n!==void 0?n(f,t):f-t;h<=0?(o=a,r=a+1):i=a-1}return o}function zu(e,t,n,r,i){for(;r<=i;){var o=r+i>>>1,a=e[o],f=n!==void 0?n(a,t):a-t;if(f===0)return o;f<=0?r=o+1:i=o-1}return-1}function Je(e,t,n,r,i,o){return typeof n=="function"?o(e,t,n,r===void 0?0:r|0,i===void 0?e.length-1:i|0):o(e,t,void 0,n===void 0?0:n|0,r===void 0?e.length-1:r|0)}Gi.exports={ge:function(e,t,n,r,i){return Je(e,t,n,r,i,Du)},gt:function(e,t,n,r,i){return Je(e,t,n,r,i,Fu)},lt:function(e,t,n,r,i){return Je(e,t,n,r,i,Au)},le:function(e,t,n,r,i){return Je(e,t,n,r,i,Uu)},eq:function(e,t,n,r,i){return Je(e,t,n,r,i,zu)}}});var _r=xt((El,Vi)=>{"use strict";Vi.exports=Eu;var Oi=+(Math.pow(2,27)+1);function Eu(e,t,n){var r=e*t,i=Oi*e,o=i-e,a=i-o,f=e-a,h=Oi*t,v=h-t,d=h-v,D=t-d,X=r-a*d,m=X-f*d,G=m-a*D,q=f*D-G;return n?(n[0]=q,n[1]=r,n):[q,r]}});var dn=xt((Il,qi)=>{"use strict";qi.exports=Lu;function Iu(e,t){var n=e+t,r=n-e,i=n-r,o=t-r,a=e-i,f=a+o;return f?[f,n]:[n]}function Lu(e,t){var n=e.length|0,r=t.length|0;if(n===1&&r===1)return Iu(e[0],t[0]);var i=n+r,o=new Array(i),a=0,f=0,h=0,v=Math.abs,d=e[f],D=v(d),X=t[h],m=v(X),G,q;D<m?(q=d,f+=1,f<n&&(d=e[f],D=v(d))):(q=X,h+=1,h<r&&(X=t[h],m=v(X))),f<n&&D<m||h>=r?(G=d,f+=1,f<n&&(d=e[f],D=v(d))):(G=X,h+=1,h<r&&(X=t[h],m=v(X)));for(var N=G+q,Y=N-G,K=q-Y,Q=K,tt=N,H,W,st,et,rt;f<n&&h<r;)D<m?(G=d,f+=1,f<n&&(d=e[f],D=v(d))):(G=X,h+=1,h<r&&(X=t[h],m=v(X))),q=Q,N=G+q,Y=N-G,K=q-Y,K&&(o[a++]=K),H=tt+N,W=H-tt,st=H-W,et=N-W,rt=tt-st,Q=rt+et,tt=H;for(;f<n;)G=d,q=Q,N=G+q,Y=N-G,K=q-Y,K&&(o[a++]=K),H=tt+N,W=H-tt,st=H-W,et=N-W,rt=tt-st,Q=rt+et,tt=H,f+=1,f<n&&(d=e[f]);for(;h<r;)G=X,q=Q,N=G+q,Y=N-G,K=q-Y,K&&(o[a++]=K),H=tt+N,W=H-tt,st=H-W,et=N-W,rt=tt-st,Q=rt+et,tt=H,h+=1,h<r&&(X=t[h]);return Q&&(o[a++]=Q),tt&&(o[a++]=tt),a||(o[a++]=0),o.length=a,o}});var mi=xt((Ll,Ni)=>{"use strict";Ni.exports=Ru;function Ru(e,t,n){var r=e+t,i=r-e,o=r-i,a=t-i,f=e-o;return n?(n[0]=f+a,n[1]=r,n):[f+a,r]}});var xn=xt((Rl,Ci)=>{"use strict";var wn=_r(),Gu=mi();Ci.exports=Ou;function Ou(e,t){var n=e.length;if(n===1){var r=wn(e[0],t);return r[0]?r:[r[1]]}var i=new Array(2*n),o=[.1,.1],a=[.1,.1],f=0;wn(e[0],t,o),o[0]&&(i[f++]=o[0]);for(var h=1;h<n;++h){wn(e[h],t,a);var v=o[1];Gu(v,a[0],o),o[0]&&(i[f++]=o[0]);var d=a[1],D=o[1],X=d+D,m=X-d,G=D-m;o[1]=X,G&&(i[f++]=G)}return o[1]&&(i[f++]=o[1]),f===0&&(i[f++]=0),i.length=f,i}});var yn=xt((Gl,Xi)=>{"use strict";Xi.exports=qu;function Vu(e,t){var n=e+t,r=n-e,i=n-r,o=t-r,a=e-i,f=a+o;return f?[f,n]:[n]}function qu(e,t){var n=e.length|0,r=t.length|0;if(n===1&&r===1)return Vu(e[0],-t[0]);var i=n+r,o=new Array(i),a=0,f=0,h=0,v=Math.abs,d=e[f],D=v(d),X=-t[h],m=v(X),G,q;D<m?(q=d,f+=1,f<n&&(d=e[f],D=v(d))):(q=X,h+=1,h<r&&(X=-t[h],m=v(X))),f<n&&D<m||h>=r?(G=d,f+=1,f<n&&(d=e[f],D=v(d))):(G=X,h+=1,h<r&&(X=-t[h],m=v(X)));for(var N=G+q,Y=N-G,K=q-Y,Q=K,tt=N,H,W,st,et,rt;f<n&&h<r;)D<m?(G=d,f+=1,f<n&&(d=e[f],D=v(d))):(G=X,h+=1,h<r&&(X=-t[h],m=v(X))),q=Q,N=G+q,Y=N-G,K=q-Y,K&&(o[a++]=K),H=tt+N,W=H-tt,st=H-W,et=N-W,rt=tt-st,Q=rt+et,tt=H;for(;f<n;)G=d,q=Q,N=G+q,Y=N-G,K=q-Y,K&&(o[a++]=K),H=tt+N,W=H-tt,st=H-W,et=N-W,rt=tt-st,Q=rt+et,tt=H,f+=1,f<n&&(d=e[f]);for(;h<r;)G=X,q=Q,N=G+q,Y=N-G,K=q-Y,K&&(o[a++]=K),H=tt+N,W=H-tt,st=H-W,et=N-W,rt=tt-st,Q=rt+et,tt=H,h+=1,h<r&&(X=-t[h]);return Q&&(o[a++]=Q),tt&&(o[a++]=tt),a||(o[a++]=0),o.length=a,o}});var bn=xt((Ol,Mn)=>{"use strict";var Nu=_r(),mu=dn(),Cu=xn(),Xu=yn(),ki=5,Sr=11102230246251565e-32,ku=(3+16*Sr)*Sr,Yu=(7+56*Sr)*Sr;function Hu(e,t,n,r){return function(o,a,f){var h=e(e(t(a[1],f[0]),t(-f[1],a[0])),e(t(o[1],a[0]),t(-a[1],o[0]))),v=e(t(o[1],f[0]),t(-f[1],o[0])),d=r(h,v);return d[d.length-1]}}function Zu(e,t,n,r){return function(o,a,f,h){var v=e(e(n(e(t(f[1],h[0]),t(-h[1],f[0])),a[2]),e(n(e(t(a[1],h[0]),t(-h[1],a[0])),-f[2]),n(e(t(a[1],f[0]),t(-f[1],a[0])),h[2]))),e(n(e(t(a[1],h[0]),t(-h[1],a[0])),o[2]),e(n(e(t(o[1],h[0]),t(-h[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),h[2])))),d=e(e(n(e(t(f[1],h[0]),t(-h[1],f[0])),o[2]),e(n(e(t(o[1],h[0]),t(-h[1],o[0])),-f[2]),n(e(t(o[1],f[0]),t(-f[1],o[0])),h[2]))),e(n(e(t(a[1],f[0]),t(-f[1],a[0])),o[2]),e(n(e(t(o[1],f[0]),t(-f[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),f[2])))),D=r(v,d);return D[D.length-1]}}function $u(e,t,n,r){return function(o,a,f,h,v){var d=e(e(e(n(e(n(e(t(h[1],v[0]),t(-v[1],h[0])),f[2]),e(n(e(t(f[1],v[0]),t(-v[1],f[0])),-h[2]),n(e(t(f[1],h[0]),t(-h[1],f[0])),v[2]))),a[3]),e(n(e(n(e(t(h[1],v[0]),t(-v[1],h[0])),a[2]),e(n(e(t(a[1],v[0]),t(-v[1],a[0])),-h[2]),n(e(t(a[1],h[0]),t(-h[1],a[0])),v[2]))),-f[3]),n(e(n(e(t(f[1],v[0]),t(-v[1],f[0])),a[2]),e(n(e(t(a[1],v[0]),t(-v[1],a[0])),-f[2]),n(e(t(a[1],f[0]),t(-f[1],a[0])),v[2]))),h[3]))),e(n(e(n(e(t(f[1],h[0]),t(-h[1],f[0])),a[2]),e(n(e(t(a[1],h[0]),t(-h[1],a[0])),-f[2]),n(e(t(a[1],f[0]),t(-f[1],a[0])),h[2]))),-v[3]),e(n(e(n(e(t(h[1],v[0]),t(-v[1],h[0])),a[2]),e(n(e(t(a[1],v[0]),t(-v[1],a[0])),-h[2]),n(e(t(a[1],h[0]),t(-h[1],a[0])),v[2]))),o[3]),n(e(n(e(t(h[1],v[0]),t(-v[1],h[0])),o[2]),e(n(e(t(o[1],v[0]),t(-v[1],o[0])),-h[2]),n(e(t(o[1],h[0]),t(-h[1],o[0])),v[2]))),-a[3])))),e(e(n(e(n(e(t(a[1],v[0]),t(-v[1],a[0])),o[2]),e(n(e(t(o[1],v[0]),t(-v[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),v[2]))),h[3]),e(n(e(n(e(t(a[1],h[0]),t(-h[1],a[0])),o[2]),e(n(e(t(o[1],h[0]),t(-h[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),h[2]))),-v[3]),n(e(n(e(t(f[1],h[0]),t(-h[1],f[0])),a[2]),e(n(e(t(a[1],h[0]),t(-h[1],a[0])),-f[2]),n(e(t(a[1],f[0]),t(-f[1],a[0])),h[2]))),o[3]))),e(n(e(n(e(t(f[1],h[0]),t(-h[1],f[0])),o[2]),e(n(e(t(o[1],h[0]),t(-h[1],o[0])),-f[2]),n(e(t(o[1],f[0]),t(-f[1],o[0])),h[2]))),-a[3]),e(n(e(n(e(t(a[1],h[0]),t(-h[1],a[0])),o[2]),e(n(e(t(o[1],h[0]),t(-h[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),h[2]))),f[3]),n(e(n(e(t(a[1],f[0]),t(-f[1],a[0])),o[2]),e(n(e(t(o[1],f[0]),t(-f[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),f[2]))),-h[3]))))),D=e(e(e(n(e(n(e(t(h[1],v[0]),t(-v[1],h[0])),f[2]),e(n(e(t(f[1],v[0]),t(-v[1],f[0])),-h[2]),n(e(t(f[1],h[0]),t(-h[1],f[0])),v[2]))),o[3]),n(e(n(e(t(h[1],v[0]),t(-v[1],h[0])),o[2]),e(n(e(t(o[1],v[0]),t(-v[1],o[0])),-h[2]),n(e(t(o[1],h[0]),t(-h[1],o[0])),v[2]))),-f[3])),e(n(e(n(e(t(f[1],v[0]),t(-v[1],f[0])),o[2]),e(n(e(t(o[1],v[0]),t(-v[1],o[0])),-f[2]),n(e(t(o[1],f[0]),t(-f[1],o[0])),v[2]))),h[3]),n(e(n(e(t(f[1],h[0]),t(-h[1],f[0])),o[2]),e(n(e(t(o[1],h[0]),t(-h[1],o[0])),-f[2]),n(e(t(o[1],f[0]),t(-f[1],o[0])),h[2]))),-v[3]))),e(e(n(e(n(e(t(f[1],v[0]),t(-v[1],f[0])),a[2]),e(n(e(t(a[1],v[0]),t(-v[1],a[0])),-f[2]),n(e(t(a[1],f[0]),t(-f[1],a[0])),v[2]))),o[3]),n(e(n(e(t(f[1],v[0]),t(-v[1],f[0])),o[2]),e(n(e(t(o[1],v[0]),t(-v[1],o[0])),-f[2]),n(e(t(o[1],f[0]),t(-f[1],o[0])),v[2]))),-a[3])),e(n(e(n(e(t(a[1],v[0]),t(-v[1],a[0])),o[2]),e(n(e(t(o[1],v[0]),t(-v[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),v[2]))),f[3]),n(e(n(e(t(a[1],f[0]),t(-f[1],a[0])),o[2]),e(n(e(t(o[1],f[0]),t(-f[1],o[0])),-a[2]),n(e(t(o[1],a[0]),t(-a[1],o[0])),f[2]))),-v[3])))),X=r(d,D);return X[X.length-1]}}function Tr(e){var t=e===3?Hu:e===4?Zu:$u;return t(mu,Nu,Cu,Xu)}var Wu=Tr(3),Ku=Tr(4),De=[function(){return 0},function(){return 0},function(t,n){return n[0]-t[0]},function(t,n,r){var i=(t[1]-r[1])*(n[0]-r[0]),o=(t[0]-r[0])*(n[1]-r[1]),a=i-o,f;if(i>0){if(o<=0)return a;f=i+o}else if(i<0){if(o>=0)return a;f=-(i+o)}else return a;var h=ku*f;return a>=h||a<=-h?a:Wu(t,n,r)},function(t,n,r,i){var o=t[0]-i[0],a=n[0]-i[0],f=r[0]-i[0],h=t[1]-i[1],v=n[1]-i[1],d=r[1]-i[1],D=t[2]-i[2],X=n[2]-i[2],m=r[2]-i[2],G=a*d,q=f*v,N=f*h,Y=o*d,K=o*v,Q=a*h,tt=D*(G-q)+X*(N-Y)+m*(K-Q),H=(Math.abs(G)+Math.abs(q))*Math.abs(D)+(Math.abs(N)+Math.abs(Y))*Math.abs(X)+(Math.abs(K)+Math.abs(Q))*Math.abs(m),W=Yu*H;return tt>W||-tt>W?tt:Ku(t,n,r,i)}];function Qu(e){var t=De[e.length];return t||(t=De[e.length]=Tr(e.length)),t.apply(void 0,e)}function Ju(e,t,n,r,i,o,a){return function(h,v,d,D,X){switch(arguments.length){case 0:case 1:return 0;case 2:return r(h,v);case 3:return i(h,v,d);case 4:return o(h,v,d,D);case 5:return a(h,v,d,D,X)}for(var m=new Array(arguments.length),G=0;G<arguments.length;++G)m[G]=arguments[G];return e(m)}}function ju(){for(;De.length<=ki;)De.push(Tr(De.length));Mn.exports=Ju.apply(void 0,[Qu].concat(De));for(var e=0;e<=ki;++e)Mn.exports[e]=De[e]}ju()});var Ki=xt((Vl,Wi)=>{"use strict";var Br=je(),be=bn()[3],Sn=0,Yi=1,_n=2;Wi.exports=i0;function Zi(e,t,n,r,i){this.a=e,this.b=t,this.idx=n,this.lowerIds=r,this.upperIds=i}function tr(e,t,n,r){this.a=e,this.b=t,this.type=n,this.idx=r}function t0(e,t){var n=e.a[0]-t.a[0]||e.a[1]-t.a[1]||e.type-t.type;return n||e.type!==Sn&&(n=be(e.a,e.b,t.b),n)?n:e.idx-t.idx}function Hi(e,t){return be(e.a,e.b,t)}function e0(e,t,n,r,i){for(var o=Br.lt(t,r,Hi),a=Br.gt(t,r,Hi),f=o;f<a;++f){for(var h=t[f],v=h.lowerIds,D=v.length;D>1&&be(n[v[D-2]],n[v[D-1]],r)>0;)e.push([v[D-1],v[D-2],i]),D-=1;v.length=D,v.push(i);for(var d=h.upperIds,D=d.length;D>1&&be(n[d[D-2]],n[d[D-1]],r)<0;)e.push([d[D-2],d[D-1],i]),D-=1;d.length=D,d.push(i)}}function $i(e,t){var n;return e.a[0]<t.a[0]?n=be(e.a,e.b,t.a):n=be(t.b,t.a,e.a),n||(t.b[0]<e.b[0]?n=be(e.a,e.b,t.b):n=be(t.b,t.a,e.b),n||e.idx-t.idx)}function r0(e,t,n){var r=Br.le(e,n,$i),i=e[r],o=i.upperIds,a=o[o.length-1];i.upperIds=[a],e.splice(r+1,0,new Zi(n.a,n.b,n.idx,[a],o))}function n0(e,t,n){var r=n.a;n.a=n.b,n.b=r;var i=Br.eq(e,n,$i),o=e[i],a=e[i-1];a.upperIds=o.upperIds,e.splice(i,1)}function i0(e,t){for(var n=e.length,r=t.length,i=[],o=0;o<n;++o)i.push(new tr(e[o],null,Sn,o));for(var o=0;o<r;++o){var a=t[o],f=e[a[0]],h=e[a[1]];f[0]<h[0]?i.push(new tr(f,h,_n,o),new tr(h,f,Yi,o)):f[0]>h[0]&&i.push(new tr(h,f,_n,o),new tr(f,h,Yi,o))}i.sort(t0);for(var v=i[0].a[0]-(1+Math.abs(i[0].a[0]))*Math.pow(2,-52),d=[new Zi([v,1],[v,0],-1,[],[],[],[])],D=[],o=0,X=i.length;o<X;++o){var m=i[o],G=m.type;G===Sn?e0(D,d,e,m.a,m.idx):G===_n?r0(d,e,m):n0(d,e,m)}return D}});var ji=xt((ql,Ji)=>{"use strict";var o0=je();Ji.exports=a0;function Qi(e,t){this.stars=e,this.edges=t}var Fe=Qi.prototype;function Tn(e,t,n){for(var r=1,i=e.length;r<i;r+=2)if(e[r-1]===t&&e[r]===n){e[r-1]=e[i-2],e[r]=e[i-1],e.length=i-2;return}}Fe.isConstraint=(function(){var e=[0,0];function t(n,r){return n[0]-r[0]||n[1]-r[1]}return function(n,r){return e[0]=Math.min(n,r),e[1]=Math.max(n,r),o0.eq(this.edges,e,t)>=0}})();Fe.removeTriangle=function(e,t,n){var r=this.stars;Tn(r[e],t,n),Tn(r[t],n,e),Tn(r[n],e,t)};Fe.addTriangle=function(e,t,n){var r=this.stars;r[e].push(t,n),r[t].push(n,e),r[n].push(e,t)};Fe.opposite=function(e,t){for(var n=this.stars[t],r=1,i=n.length;r<i;r+=2)if(n[r]===e)return n[r-1];return-1};Fe.flip=function(e,t){var n=this.opposite(e,t),r=this.opposite(t,e);this.removeTriangle(e,t,n),this.removeTriangle(t,e,r),this.addTriangle(e,r,n),this.addTriangle(t,n,r)};Fe.edges=function(){for(var e=this.stars,t=[],n=0,r=e.length;n<r;++n)for(var i=e[n],o=0,a=i.length;o<a;o+=2)t.push([i[o],i[o+1]]);return t};Fe.cells=function(){for(var e=this.stars,t=[],n=0,r=e.length;n<r;++n)for(var i=e[n],o=0,a=i.length;o<a;o+=2){var f=i[o],h=i[o+1];n<Math.min(f,h)&&t.push([n,f,h])}return t};function a0(e,t){for(var n=new Array(e),r=0;r<e;++r)n[r]=[];return new Qi(n,t)}});var ro=xt((Nl,Bn)=>{"use strict";var s0=_r(),u0=dn(),f0=yn(),c0=xn(),to=6;function eo(e){var t=e===3?p0:e===4?g0:e===5?d0:w0;return t(u0,f0,s0,c0)}function l0(){return 0}function h0(){return 0}function v0(){return 0}function p0(e,t,n,r){function i(o,a,f){var h=n(o[0],o[0]),v=r(h,a[0]),d=r(h,f[0]),D=n(a[0],a[0]),X=r(D,o[0]),m=r(D,f[0]),G=n(f[0],f[0]),q=r(G,o[0]),N=r(G,a[0]),Y=e(t(N,m),t(X,v)),K=t(q,d),Q=t(Y,K);return Q[Q.length-1]}return i}function g0(e,t,n,r){function i(o,a,f,h){var v=e(n(o[0],o[0]),n(o[1],o[1])),d=r(v,a[0]),D=r(v,f[0]),X=r(v,h[0]),m=e(n(a[0],a[0]),n(a[1],a[1])),G=r(m,o[0]),q=r(m,f[0]),N=r(m,h[0]),Y=e(n(f[0],f[0]),n(f[1],f[1])),K=r(Y,o[0]),Q=r(Y,a[0]),tt=r(Y,h[0]),H=e(n(h[0],h[0]),n(h[1],h[1])),W=r(H,o[0]),st=r(H,a[0]),et=r(H,f[0]),rt=e(e(r(t(et,tt),a[1]),e(r(t(st,N),-f[1]),r(t(Q,q),h[1]))),e(r(t(st,N),o[1]),e(r(t(W,X),-a[1]),r(t(G,d),h[1])))),F=e(e(r(t(et,tt),o[1]),e(r(t(W,X),-f[1]),r(t(K,D),h[1]))),e(r(t(Q,q),o[1]),e(r(t(K,D),-a[1]),r(t(G,d),f[1])))),s=t(rt,F);return s[s.length-1]}return i}function d0(e,t,n,r){function i(o,a,f,h,v){var d=e(n(o[0],o[0]),e(n(o[1],o[1]),n(o[2],o[2]))),D=r(d,a[0]),X=r(d,f[0]),m=r(d,h[0]),G=r(d,v[0]),q=e(n(a[0],a[0]),e(n(a[1],a[1]),n(a[2],a[2]))),N=r(q,o[0]),Y=r(q,f[0]),K=r(q,h[0]),Q=r(q,v[0]),tt=e(n(f[0],f[0]),e(n(f[1],f[1]),n(f[2],f[2]))),H=r(tt,o[0]),W=r(tt,a[0]),st=r(tt,h[0]),et=r(tt,v[0]),rt=e(n(h[0],h[0]),e(n(h[1],h[1]),n(h[2],h[2]))),F=r(rt,o[0]),s=r(rt,a[0]),p=r(rt,f[0]),_=r(rt,v[0]),M=e(n(v[0],v[0]),e(n(v[1],v[1]),n(v[2],v[2]))),T=r(M,o[0]),I=r(M,a[0]),O=r(M,f[0]),P=r(M,h[0]),l=e(e(e(r(e(r(t(P,_),f[1]),e(r(t(O,et),-h[1]),r(t(p,st),v[1]))),a[2]),e(r(e(r(t(P,_),a[1]),e(r(t(I,Q),-h[1]),r(t(s,K),v[1]))),-f[2]),r(e(r(t(O,et),a[1]),e(r(t(I,Q),-f[1]),r(t(W,Y),v[1]))),h[2]))),e(r(e(r(t(p,st),a[1]),e(r(t(s,K),-f[1]),r(t(W,Y),h[1]))),-v[2]),e(r(e(r(t(P,_),a[1]),e(r(t(I,Q),-h[1]),r(t(s,K),v[1]))),o[2]),r(e(r(t(P,_),o[1]),e(r(t(T,G),-h[1]),r(t(F,m),v[1]))),-a[2])))),e(e(r(e(r(t(I,Q),o[1]),e(r(t(T,G),-a[1]),r(t(N,D),v[1]))),h[2]),e(r(e(r(t(s,K),o[1]),e(r(t(F,m),-a[1]),r(t(N,D),h[1]))),-v[2]),r(e(r(t(p,st),a[1]),e(r(t(s,K),-f[1]),r(t(W,Y),h[1]))),o[2]))),e(r(e(r(t(p,st),o[1]),e(r(t(F,m),-f[1]),r(t(H,X),h[1]))),-a[2]),e(r(e(r(t(s,K),o[1]),e(r(t(F,m),-a[1]),r(t(N,D),h[1]))),f[2]),r(e(r(t(W,Y),o[1]),e(r(t(H,X),-a[1]),r(t(N,D),f[1]))),-h[2]))))),U=e(e(e(r(e(r(t(P,_),f[1]),e(r(t(O,et),-h[1]),r(t(p,st),v[1]))),o[2]),r(e(r(t(P,_),o[1]),e(r(t(T,G),-h[1]),r(t(F,m),v[1]))),-f[2])),e(r(e(r(t(O,et),o[1]),e(r(t(T,G),-f[1]),r(t(H,X),v[1]))),h[2]),r(e(r(t(p,st),o[1]),e(r(t(F,m),-f[1]),r(t(H,X),h[1]))),-v[2]))),e(e(r(e(r(t(O,et),a[1]),e(r(t(I,Q),-f[1]),r(t(W,Y),v[1]))),o[2]),r(e(r(t(O,et),o[1]),e(r(t(T,G),-f[1]),r(t(H,X),v[1]))),-a[2])),e(r(e(r(t(I,Q),o[1]),e(r(t(T,G),-a[1]),r(t(N,D),v[1]))),f[2]),r(e(r(t(W,Y),o[1]),e(r(t(H,X),-a[1]),r(t(N,D),f[1]))),-v[2])))),ot=t(l,U);return ot[ot.length-1]}return i}function w0(e,t,n,r){function i(o,a,f,h,v,d){var D=e(e(n(o[0],o[0]),n(o[1],o[1])),e(n(o[2],o[2]),n(o[3],o[3]))),X=r(D,a[0]),m=r(D,f[0]),G=r(D,h[0]),q=r(D,v[0]),N=r(D,d[0]),Y=e(e(n(a[0],a[0]),n(a[1],a[1])),e(n(a[2],a[2]),n(a[3],a[3]))),K=r(Y,o[0]),Q=r(Y,f[0]),tt=r(Y,h[0]),H=r(Y,v[0]),W=r(Y,d[0]),st=e(e(n(f[0],f[0]),n(f[1],f[1])),e(n(f[2],f[2]),n(f[3],f[3]))),et=r(st,o[0]),rt=r(st,a[0]),F=r(st,h[0]),s=r(st,v[0]),p=r(st,d[0]),_=e(e(n(h[0],h[0]),n(h[1],h[1])),e(n(h[2],h[2]),n(h[3],h[3]))),M=r(_,o[0]),T=r(_,a[0]),I=r(_,f[0]),O=r(_,v[0]),P=r(_,d[0]),l=e(e(n(v[0],v[0]),n(v[1],v[1])),e(n(v[2],v[2]),n(v[3],v[3]))),U=r(l,o[0]),ot=r(l,a[0]),at=r(l,f[0]),ut=r(l,h[0]),ft=r(l,d[0]),yt=e(e(n(d[0],d[0]),n(d[1],d[1])),e(n(d[2],d[2]),n(d[3],d[3]))),vt=r(yt,o[0]),k=r(yt,a[0]),$=r(yt,f[0]),A=r(yt,h[0]),c=r(yt,v[0]),b=e(e(e(r(e(e(r(e(r(t(c,ft),h[1]),e(r(t(A,P),-v[1]),r(t(ut,O),d[1]))),f[2]),r(e(r(t(c,ft),f[1]),e(r(t($,p),-v[1]),r(t(at,s),d[1]))),-h[2])),e(r(e(r(t(A,P),f[1]),e(r(t($,p),-h[1]),r(t(I,F),d[1]))),v[2]),r(e(r(t(ut,O),f[1]),e(r(t(at,s),-h[1]),r(t(I,F),v[1]))),-d[2]))),a[3]),e(r(e(e(r(e(r(t(c,ft),h[1]),e(r(t(A,P),-v[1]),r(t(ut,O),d[1]))),a[2]),r(e(r(t(c,ft),a[1]),e(r(t(k,W),-v[1]),r(t(ot,H),d[1]))),-h[2])),e(r(e(r(t(A,P),a[1]),e(r(t(k,W),-h[1]),r(t(T,tt),d[1]))),v[2]),r(e(r(t(ut,O),a[1]),e(r(t(ot,H),-h[1]),r(t(T,tt),v[1]))),-d[2]))),-f[3]),r(e(e(r(e(r(t(c,ft),f[1]),e(r(t($,p),-v[1]),r(t(at,s),d[1]))),a[2]),r(e(r(t(c,ft),a[1]),e(r(t(k,W),-v[1]),r(t(ot,H),d[1]))),-f[2])),e(r(e(r(t($,p),a[1]),e(r(t(k,W),-f[1]),r(t(rt,Q),d[1]))),v[2]),r(e(r(t(at,s),a[1]),e(r(t(ot,H),-f[1]),r(t(rt,Q),v[1]))),-d[2]))),h[3]))),e(e(r(e(e(r(e(r(t(A,P),f[1]),e(r(t($,p),-h[1]),r(t(I,F),d[1]))),a[2]),r(e(r(t(A,P),a[1]),e(r(t(k,W),-h[1]),r(t(T,tt),d[1]))),-f[2])),e(r(e(r(t($,p),a[1]),e(r(t(k,W),-f[1]),r(t(rt,Q),d[1]))),h[2]),r(e(r(t(I,F),a[1]),e(r(t(T,tt),-f[1]),r(t(rt,Q),h[1]))),-d[2]))),-v[3]),r(e(e(r(e(r(t(ut,O),f[1]),e(r(t(at,s),-h[1]),r(t(I,F),v[1]))),a[2]),r(e(r(t(ut,O),a[1]),e(r(t(ot,H),-h[1]),r(t(T,tt),v[1]))),-f[2])),e(r(e(r(t(at,s),a[1]),e(r(t(ot,H),-f[1]),r(t(rt,Q),v[1]))),h[2]),r(e(r(t(I,F),a[1]),e(r(t(T,tt),-f[1]),r(t(rt,Q),h[1]))),-v[2]))),d[3])),e(r(e(e(r(e(r(t(c,ft),h[1]),e(r(t(A,P),-v[1]),r(t(ut,O),d[1]))),a[2]),r(e(r(t(c,ft),a[1]),e(r(t(k,W),-v[1]),r(t(ot,H),d[1]))),-h[2])),e(r(e(r(t(A,P),a[1]),e(r(t(k,W),-h[1]),r(t(T,tt),d[1]))),v[2]),r(e(r(t(ut,O),a[1]),e(r(t(ot,H),-h[1]),r(t(T,tt),v[1]))),-d[2]))),o[3]),r(e(e(r(e(r(t(c,ft),h[1]),e(r(t(A,P),-v[1]),r(t(ut,O),d[1]))),o[2]),r(e(r(t(c,ft),o[1]),e(r(t(vt,N),-v[1]),r(t(U,q),d[1]))),-h[2])),e(r(e(r(t(A,P),o[1]),e(r(t(vt,N),-h[1]),r(t(M,G),d[1]))),v[2]),r(e(r(t(ut,O),o[1]),e(r(t(U,q),-h[1]),r(t(M,G),v[1]))),-d[2]))),-a[3])))),e(e(e(r(e(e(r(e(r(t(c,ft),a[1]),e(r(t(k,W),-v[1]),r(t(ot,H),d[1]))),o[2]),r(e(r(t(c,ft),o[1]),e(r(t(vt,N),-v[1]),r(t(U,q),d[1]))),-a[2])),e(r(e(r(t(k,W),o[1]),e(r(t(vt,N),-a[1]),r(t(K,X),d[1]))),v[2]),r(e(r(t(ot,H),o[1]),e(r(t(U,q),-a[1]),r(t(K,X),v[1]))),-d[2]))),h[3]),r(e(e(r(e(r(t(A,P),a[1]),e(r(t(k,W),-h[1]),r(t(T,tt),d[1]))),o[2]),r(e(r(t(A,P),o[1]),e(r(t(vt,N),-h[1]),r(t(M,G),d[1]))),-a[2])),e(r(e(r(t(k,W),o[1]),e(r(t(vt,N),-a[1]),r(t(K,X),d[1]))),h[2]),r(e(r(t(T,tt),o[1]),e(r(t(M,G),-a[1]),r(t(K,X),h[1]))),-d[2]))),-v[3])),e(r(e(e(r(e(r(t(ut,O),a[1]),e(r(t(ot,H),-h[1]),r(t(T,tt),v[1]))),o[2]),r(e(r(t(ut,O),o[1]),e(r(t(U,q),-h[1]),r(t(M,G),v[1]))),-a[2])),e(r(e(r(t(ot,H),o[1]),e(r(t(U,q),-a[1]),r(t(K,X),v[1]))),h[2]),r(e(r(t(T,tt),o[1]),e(r(t(M,G),-a[1]),r(t(K,X),h[1]))),-v[2]))),d[3]),r(e(e(r(e(r(t(A,P),f[1]),e(r(t($,p),-h[1]),r(t(I,F),d[1]))),a[2]),r(e(r(t(A,P),a[1]),e(r(t(k,W),-h[1]),r(t(T,tt),d[1]))),-f[2])),e(r(e(r(t($,p),a[1]),e(r(t(k,W),-f[1]),r(t(rt,Q),d[1]))),h[2]),r(e(r(t(I,F),a[1]),e(r(t(T,tt),-f[1]),r(t(rt,Q),h[1]))),-d[2]))),o[3]))),e(e(r(e(e(r(e(r(t(A,P),f[1]),e(r(t($,p),-h[1]),r(t(I,F),d[1]))),o[2]),r(e(r(t(A,P),o[1]),e(r(t(vt,N),-h[1]),r(t(M,G),d[1]))),-f[2])),e(r(e(r(t($,p),o[1]),e(r(t(vt,N),-f[1]),r(t(et,m),d[1]))),h[2]),r(e(r(t(I,F),o[1]),e(r(t(M,G),-f[1]),r(t(et,m),h[1]))),-d[2]))),-a[3]),r(e(e(r(e(r(t(A,P),a[1]),e(r(t(k,W),-h[1]),r(t(T,tt),d[1]))),o[2]),r(e(r(t(A,P),o[1]),e(r(t(vt,N),-h[1]),r(t(M,G),d[1]))),-a[2])),e(r(e(r(t(k,W),o[1]),e(r(t(vt,N),-a[1]),r(t(K,X),d[1]))),h[2]),r(e(r(t(T,tt),o[1]),e(r(t(M,G),-a[1]),r(t(K,X),h[1]))),-d[2]))),f[3])),e(r(e(e(r(e(r(t($,p),a[1]),e(r(t(k,W),-f[1]),r(t(rt,Q),d[1]))),o[2]),r(e(r(t($,p),o[1]),e(r(t(vt,N),-f[1]),r(t(et,m),d[1]))),-a[2])),e(r(e(r(t(k,W),o[1]),e(r(t(vt,N),-a[1]),r(t(K,X),d[1]))),f[2]),r(e(r(t(rt,Q),o[1]),e(r(t(et,m),-a[1]),r(t(K,X),f[1]))),-d[2]))),-h[3]),r(e(e(r(e(r(t(I,F),a[1]),e(r(t(T,tt),-f[1]),r(t(rt,Q),h[1]))),o[2]),r(e(r(t(I,F),o[1]),e(r(t(M,G),-f[1]),r(t(et,m),h[1]))),-a[2])),e(r(e(r(t(T,tt),o[1]),e(r(t(M,G),-a[1]),r(t(K,X),h[1]))),f[2]),r(e(r(t(rt,Q),o[1]),e(r(t(et,m),-a[1]),r(t(K,X),f[1]))),-h[2]))),d[3]))))),w=e(e(e(r(e(e(r(e(r(t(c,ft),h[1]),e(r(t(A,P),-v[1]),r(t(ut,O),d[1]))),f[2]),r(e(r(t(c,ft),f[1]),e(r(t($,p),-v[1]),r(t(at,s),d[1]))),-h[2])),e(r(e(r(t(A,P),f[1]),e(r(t($,p),-h[1]),r(t(I,F),d[1]))),v[2]),r(e(r(t(ut,O),f[1]),e(r(t(at,s),-h[1]),r(t(I,F),v[1]))),-d[2]))),o[3]),e(r(e(e(r(e(r(t(c,ft),h[1]),e(r(t(A,P),-v[1]),r(t(ut,O),d[1]))),o[2]),r(e(r(t(c,ft),o[1]),e(r(t(vt,N),-v[1]),r(t(U,q),d[1]))),-h[2])),e(r(e(r(t(A,P),o[1]),e(r(t(vt,N),-h[1]),r(t(M,G),d[1]))),v[2]),r(e(r(t(ut,O),o[1]),e(r(t(U,q),-h[1]),r(t(M,G),v[1]))),-d[2]))),-f[3]),r(e(e(r(e(r(t(c,ft),f[1]),e(r(t($,p),-v[1]),r(t(at,s),d[1]))),o[2]),r(e(r(t(c,ft),o[1]),e(r(t(vt,N),-v[1]),r(t(U,q),d[1]))),-f[2])),e(r(e(r(t($,p),o[1]),e(r(t(vt,N),-f[1]),r(t(et,m),d[1]))),v[2]),r(e(r(t(at,s),o[1]),e(r(t(U,q),-f[1]),r(t(et,m),v[1]))),-d[2]))),h[3]))),e(e(r(e(e(r(e(r(t(A,P),f[1]),e(r(t($,p),-h[1]),r(t(I,F),d[1]))),o[2]),r(e(r(t(A,P),o[1]),e(r(t(vt,N),-h[1]),r(t(M,G),d[1]))),-f[2])),e(r(e(r(t($,p),o[1]),e(r(t(vt,N),-f[1]),r(t(et,m),d[1]))),h[2]),r(e(r(t(I,F),o[1]),e(r(t(M,G),-f[1]),r(t(et,m),h[1]))),-d[2]))),-v[3]),r(e(e(r(e(r(t(ut,O),f[1]),e(r(t(at,s),-h[1]),r(t(I,F),v[1]))),o[2]),r(e(r(t(ut,O),o[1]),e(r(t(U,q),-h[1]),r(t(M,G),v[1]))),-f[2])),e(r(e(r(t(at,s),o[1]),e(r(t(U,q),-f[1]),r(t(et,m),v[1]))),h[2]),r(e(r(t(I,F),o[1]),e(r(t(M,G),-f[1]),r(t(et,m),h[1]))),-v[2]))),d[3])),e(r(e(e(r(e(r(t(c,ft),f[1]),e(r(t($,p),-v[1]),r(t(at,s),d[1]))),a[2]),r(e(r(t(c,ft),a[1]),e(r(t(k,W),-v[1]),r(t(ot,H),d[1]))),-f[2])),e(r(e(r(t($,p),a[1]),e(r(t(k,W),-f[1]),r(t(rt,Q),d[1]))),v[2]),r(e(r(t(at,s),a[1]),e(r(t(ot,H),-f[1]),r(t(rt,Q),v[1]))),-d[2]))),o[3]),r(e(e(r(e(r(t(c,ft),f[1]),e(r(t($,p),-v[1]),r(t(at,s),d[1]))),o[2]),r(e(r(t(c,ft),o[1]),e(r(t(vt,N),-v[1]),r(t(U,q),d[1]))),-f[2])),e(r(e(r(t($,p),o[1]),e(r(t(vt,N),-f[1]),r(t(et,m),d[1]))),v[2]),r(e(r(t(at,s),o[1]),e(r(t(U,q),-f[1]),r(t(et,m),v[1]))),-d[2]))),-a[3])))),e(e(e(r(e(e(r(e(r(t(c,ft),a[1]),e(r(t(k,W),-v[1]),r(t(ot,H),d[1]))),o[2]),r(e(r(t(c,ft),o[1]),e(r(t(vt,N),-v[1]),r(t(U,q),d[1]))),-a[2])),e(r(e(r(t(k,W),o[1]),e(r(t(vt,N),-a[1]),r(t(K,X),d[1]))),v[2]),r(e(r(t(ot,H),o[1]),e(r(t(U,q),-a[1]),r(t(K,X),v[1]))),-d[2]))),f[3]),r(e(e(r(e(r(t($,p),a[1]),e(r(t(k,W),-f[1]),r(t(rt,Q),d[1]))),o[2]),r(e(r(t($,p),o[1]),e(r(t(vt,N),-f[1]),r(t(et,m),d[1]))),-a[2])),e(r(e(r(t(k,W),o[1]),e(r(t(vt,N),-a[1]),r(t(K,X),d[1]))),f[2]),r(e(r(t(rt,Q),o[1]),e(r(t(et,m),-a[1]),r(t(K,X),f[1]))),-d[2]))),-v[3])),e(r(e(e(r(e(r(t(at,s),a[1]),e(r(t(ot,H),-f[1]),r(t(rt,Q),v[1]))),o[2]),r(e(r(t(at,s),o[1]),e(r(t(U,q),-f[1]),r(t(et,m),v[1]))),-a[2])),e(r(e(r(t(ot,H),o[1]),e(r(t(U,q),-a[1]),r(t(K,X),v[1]))),f[2]),r(e(r(t(rt,Q),o[1]),e(r(t(et,m),-a[1]),r(t(K,X),f[1]))),-v[2]))),d[3]),r(e(e(r(e(r(t(ut,O),f[1]),e(r(t(at,s),-h[1]),r(t(I,F),v[1]))),a[2]),r(e(r(t(ut,O),a[1]),e(r(t(ot,H),-h[1]),r(t(T,tt),v[1]))),-f[2])),e(r(e(r(t(at,s),a[1]),e(r(t(ot,H),-f[1]),r(t(rt,Q),v[1]))),h[2]),r(e(r(t(I,F),a[1]),e(r(t(T,tt),-f[1]),r(t(rt,Q),h[1]))),-v[2]))),o[3]))),e(e(r(e(e(r(e(r(t(ut,O),f[1]),e(r(t(at,s),-h[1]),r(t(I,F),v[1]))),o[2]),r(e(r(t(ut,O),o[1]),e(r(t(U,q),-h[1]),r(t(M,G),v[1]))),-f[2])),e(r(e(r(t(at,s),o[1]),e(r(t(U,q),-f[1]),r(t(et,m),v[1]))),h[2]),r(e(r(t(I,F),o[1]),e(r(t(M,G),-f[1]),r(t(et,m),h[1]))),-v[2]))),-a[3]),r(e(e(r(e(r(t(ut,O),a[1]),e(r(t(ot,H),-h[1]),r(t(T,tt),v[1]))),o[2]),r(e(r(t(ut,O),o[1]),e(r(t(U,q),-h[1]),r(t(M,G),v[1]))),-a[2])),e(r(e(r(t(ot,H),o[1]),e(r(t(U,q),-a[1]),r(t(K,X),v[1]))),h[2]),r(e(r(t(T,tt),o[1]),e(r(t(M,G),-a[1]),r(t(K,X),h[1]))),-v[2]))),f[3])),e(r(e(e(r(e(r(t(at,s),a[1]),e(r(t(ot,H),-f[1]),r(t(rt,Q),v[1]))),o[2]),r(e(r(t(at,s),o[1]),e(r(t(U,q),-f[1]),r(t(et,m),v[1]))),-a[2])),e(r(e(r(t(ot,H),o[1]),e(r(t(U,q),-a[1]),r(t(K,X),v[1]))),f[2]),r(e(r(t(rt,Q),o[1]),e(r(t(et,m),-a[1]),r(t(K,X),f[1]))),-v[2]))),-h[3]),r(e(e(r(e(r(t(I,F),a[1]),e(r(t(T,tt),-f[1]),r(t(rt,Q),h[1]))),o[2]),r(e(r(t(I,F),o[1]),e(r(t(M,G),-f[1]),r(t(et,m),h[1]))),-a[2])),e(r(e(r(t(T,tt),o[1]),e(r(t(M,G),-a[1]),r(t(K,X),h[1]))),f[2]),r(e(r(t(rt,Q),o[1]),e(r(t(et,m),-a[1]),r(t(K,X),f[1]))),-h[2]))),v[3]))))),E=t(b,w);return E[E.length-1]}return i}var Ae=[l0,h0,v0];function x0(e){var t=Ae[e.length];return t||(t=Ae[e.length]=eo(e.length)),t.apply(void 0,e)}function y0(e,t,n,r,i,o,a,f){function h(v,d,D,X,m,G){switch(arguments.length){case 0:case 1:return 0;case 2:return r(v,d);case 3:return i(v,d,D);case 4:return o(v,d,D,X);case 5:return a(v,d,D,X,m);case 6:return f(v,d,D,X,m,G)}for(var q=new Array(arguments.length),N=0;N<arguments.length;++N)q[N]=arguments[N];return e(q)}return h}function M0(){for(;Ae.length<=to;)Ae.push(eo(Ae.length));Bn.exports=y0.apply(void 0,[x0].concat(Ae));for(var e=0;e<=to;++e)Bn.exports[e]=Ae[e]}M0()});var io=xt((Cl,no)=>{"use strict";var Pn=ro()[4],ml=je();no.exports=b0;function Pr(e,t,n,r,i,o){var a=t.opposite(r,i);if(!(a<0)){if(i<r){var f=r;r=i,i=f,f=o,o=a,a=f}t.isConstraint(r,i)||Pn(e[r],e[i],e[o],e[a])<0&&n.push(r,i)}}function b0(e,t){for(var n=[],r=e.length,i=t.stars,o=0;o<r;++o)for(var a=i[o],f=1;f<a.length;f+=2){var h=a[f];if(!(h<o)&&!t.isConstraint(o,h)){for(var v=a[f-1],d=-1,D=1;D<a.length;D+=2)if(a[D-1]===h){d=a[D];break}d<0||Pn(e[o],e[h],e[v],e[d])<0&&n.push(o,h)}}for(;n.length>0;){for(var h=n.pop(),o=n.pop(),v=-1,d=-1,a=i[o],X=1;X<a.length;X+=2){var m=a[X-1],G=a[X];m===h?d=G:G===h&&(v=m)}v<0||d<0||Pn(e[o],e[h],e[v],e[d])>=0||(t.flip(o,h),Pr(e,t,n,v,o,d),Pr(e,t,n,o,d,v),Pr(e,t,n,d,h,v),Pr(e,t,n,h,v,d))}}});var uo=xt((Xl,so)=>{"use strict";var _0=je();so.exports=P0;function oo(e,t,n,r,i,o,a){this.cells=e,this.neighbor=t,this.flags=r,this.constraint=n,this.active=i,this.next=o,this.boundary=a}var S0=oo.prototype;function ao(e,t){return e[0]-t[0]||e[1]-t[1]||e[2]-t[2]}S0.locate=(function(){var e=[0,0,0];return function(t,n,r){var i=t,o=n,a=r;return n<r?n<t&&(i=n,o=r,a=t):r<t&&(i=r,o=t,a=n),i<0?-1:(e[0]=i,e[1]=o,e[2]=a,_0.eq(this.cells,e,ao))}})();function T0(e,t){for(var n=e.cells(),r=n.length,i=0;i<r;++i){var o=n[i],a=o[0],f=o[1],h=o[2];f<h?f<a&&(o[0]=f,o[1]=h,o[2]=a):h<a&&(o[0]=h,o[1]=a,o[2]=f)}n.sort(ao);for(var v=new Array(r),i=0;i<v.length;++i)v[i]=0;var d=[],D=[],X=new Array(3*r),m=new Array(3*r),G=null;t&&(G=[]);for(var q=new oo(n,X,m,v,d,D,G),i=0;i<r;++i)for(var o=n[i],N=0;N<3;++N){var a=o[N],f=o[(N+1)%3],Y=X[3*i+N]=q.locate(f,a,e.opposite(f,a)),K=m[3*i+N]=e.isConstraint(a,f);Y<0&&(K?D.push(i):(d.push(i),v[i]=1),t&&G.push([f,a,-1]))}return q}function B0(e,t,n){for(var r=0,i=0;i<e.length;++i)t[i]===n&&(e[r++]=e[i]);return e.length=r,e}function P0(e,t,n){var r=T0(e,n);if(t===0)return n?r.cells.concat(r.boundary):r.cells;for(var i=1,o=r.active,a=r.next,f=r.flags,h=r.cells,v=r.constraint,d=r.neighbor;o.length>0||a.length>0;){for(;o.length>0;){var D=o.pop();if(f[D]!==-i){f[D]=i;for(var X=h[D],m=0;m<3;++m){var G=d[3*D+m];G>=0&&f[G]===0&&(v[3*D+m]?a.push(G):(o.push(G),f[G]=i))}}}var q=a;a=o,o=q,a.length=0,i=-i}var N=B0(h,f,t);return n?N.concat(r.boundary):N}});var co=xt((kl,fo)=>{"use strict";var D0=Ki(),F0=ji(),A0=io(),Dn=uo();fo.exports=I0;function U0(e){return[Math.min(e[0],e[1]),Math.max(e[0],e[1])]}function z0(e,t){return e[0]-t[0]||e[1]-t[1]}function E0(e){return e.map(U0).sort(z0)}function Dr(e,t,n){return t in e?e[t]:n}function I0(e,t,n){Array.isArray(t)?(n=n||{},t=t||[]):(n=t||{},t=[]);var r=!!Dr(n,"delaunay",!0),i=!!Dr(n,"interior",!0),o=!!Dr(n,"exterior",!0),a=!!Dr(n,"infinity",!1);if(!i&&!o||e.length===0)return[];var f=D0(e,t);if(r||i!==o||a){for(var h=F0(e.length,E0(t)),v=0;v<f.length;++v){var d=f[v];h.addTriangle(d[0],d[1],d[2])}return r&&A0(e,h),o?i?a?Dn(h,0,a):h.cells():Dn(h,1,a):Dn(h,-1)}else return f}});var vo=xt((Yl,ho)=>{"use strict";"use restrict";ho.exports=lo;function lo(e){this.roots=new Array(e),this.ranks=new Array(e);for(var t=0;t<e;++t)this.roots[t]=t,this.ranks[t]=0}var Fr=lo.prototype;Object.defineProperty(Fr,"length",{get:function(){return this.roots.length}});Fr.makeSet=function(){var e=this.roots.length;return this.roots.push(e),this.ranks.push(0),e};Fr.find=function(e){for(var t=e,n=this.roots;n[e]!==e;)e=n[e];for(;n[t]!==e;){var r=n[t];n[t]=e,t=r}return e};Fr.link=function(e,t){var n=this.find(e),r=this.find(t);if(n!==r){var i=this.ranks,o=this.roots,a=i[n],f=i[r];a<f?o[n]=r:f<a?o[r]=n:(o[r]=n,++i[n])}}});var rr=xt(Xt=>{"use strict";"use restrict";var Fn=32;Xt.INT_BITS=Fn;Xt.INT_MAX=2147483647;Xt.INT_MIN=-1<<Fn-1;Xt.sign=function(e){return(e>0)-(e<0)};Xt.abs=function(e){var t=e>>Fn-1;return(e^t)-t};Xt.min=function(e,t){return t^(e^t)&-(e<t)};Xt.max=function(e,t){return e^(e^t)&-(e<t)};Xt.isPow2=function(e){return!(e&e-1)&&!!e};Xt.log2=function(e){var t,n;return t=(e>65535)<<4,e>>>=t,n=(e>255)<<3,e>>>=n,t|=n,n=(e>15)<<2,e>>>=n,t|=n,n=(e>3)<<1,e>>>=n,t|=n,t|e>>1};Xt.log10=function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0};Xt.popCount=function(e){return e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),(e+(e>>>4)&252645135)*16843009>>>24};function po(e){var t=32;return e&=-e,e&&t--,e&65535&&(t-=16),e&16711935&&(t-=8),e&252645135&&(t-=4),e&858993459&&(t-=2),e&1431655765&&(t-=1),t}Xt.countTrailingZeros=po;Xt.nextPow2=function(e){return e+=e===0,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e+1};Xt.prevPow2=function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e-(e>>>1)};Xt.parity=function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,e&=15,27030>>>e&1};var er=new Array(256);(function(e){for(var t=0;t<256;++t){var n=t,r=t,i=7;for(n>>>=1;n;n>>>=1)r<<=1,r|=n&1,--i;e[t]=r<<i&255}})(er);Xt.reverse=function(e){return er[e&255]<<24|er[e>>>8&255]<<16|er[e>>>16&255]<<8|er[e>>>24&255]};Xt.interleave2=function(e,t){return e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t&=65535,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e|t<<1};Xt.deinterleave2=function(e,t){return e=e>>>t&1431655765,e=(e|e>>>1)&858993459,e=(e|e>>>2)&252645135,e=(e|e>>>4)&16711935,e=(e|e>>>16)&65535,e<<16>>16};Xt.interleave3=function(e,t,n){return e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,e|=t<<1,n&=1023,n=(n|n<<16)&4278190335,n=(n|n<<8)&251719695,n=(n|n<<4)&3272356035,n=(n|n<<2)&1227133513,e|n<<2};Xt.deinterleave3=function(e,t){return e=e>>>t&1227133513,e=(e|e>>>2)&3272356035,e=(e|e>>>4)&251719695,e=(e|e>>>8)&4278190335,e=(e|e>>>16)&1023,e<<22>>22};Xt.nextCombination=function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>po(e)+1}});var xo=xt((Zl,wo)=>{"use strict";function go(e,t,n){var r=e[n]|0;if(r<=0)return[];var i=new Array(r),o;if(n===e.length-1)for(o=0;o<r;++o)i[o]=t;else for(o=0;o<r;++o)i[o]=go(e,t,n+1);return i}function L0(e,t){var n,r;for(n=new Array(e),r=0;r<e;++r)n[r]=t;return n}function R0(e,t){switch(typeof t>"u"&&(t=0),typeof e){case"number":if(e>0)return L0(e|0,t);break;case"object":if(typeof e.length=="number")return go(e,t,0);break}return[]}wo.exports=R0});var zr=xt(It=>{"use strict";var Ar=rr(),te=xo();globalThis.__TYPEDARRAY_POOL||(globalThis.__TYPEDARRAY_POOL={UINT8:te([32,0]),UINT16:te([32,0]),UINT32:te([32,0]),BIGUINT64:te([32,0]),INT8:te([32,0]),INT16:te([32,0]),INT32:te([32,0]),BIGINT64:te([32,0]),FLOAT:te([32,0]),DOUBLE:te([32,0]),DATA:te([32,0]),UINT8C:te([32,0])});var G0=typeof Uint8ClampedArray<"u",O0=typeof BigUint64Array<"u",V0=typeof BigInt64Array<"u",Qt=globalThis.__TYPEDARRAY_POOL;Qt.UINT8C||(Qt.UINT8C=te([32,0]));Qt.BIGUINT64||(Qt.BIGUINT64=te([32,0]));Qt.BIGINT64||(Qt.BIGINT64=te([32,0]));var Ur=Qt.DATA;It.free=function(t){if(Object.prototype.toString.call(t)!=="[object ArrayBuffer]"&&(t=t.buffer),!!t){var n=t.length||t.byteLength,r=Ar.log2(n)|0;Ur[r].push(t)}};function yo(e){if(e){var t=e.length||e.byteLength,n=Ar.log2(t);Ur[n].push(e)}}function q0(e){yo(e.buffer)}It.freeUint8=It.freeUint16=It.freeUint32=It.freeBigUint64=It.freeInt8=It.freeInt16=It.freeInt32=It.freeBigInt64=It.freeFloat32=It.freeFloat=It.freeFloat64=It.freeDouble=It.freeUint8Clamped=It.freeDataView=q0;It.freeArrayBuffer=yo;It.malloc=function(t,n){if(n===void 0||n==="arraybuffer")return ie(t);switch(n){case"uint8":return An(t);case"uint16":return Mo(t);case"uint32":return bo(t);case"int8":return _o(t);case"int16":return So(t);case"int32":return To(t);case"float":case"float32":return Bo(t);case"double":case"float64":return Po(t);case"uint8_clamped":return Do(t);case"bigint64":return Ao(t);case"biguint64":return Fo(t);case"data":case"dataview":return Uo(t);default:return null}return null};function ie(t){var t=Ar.nextPow2(t),n=Ar.log2(t),r=Ur[n];return r.length>0?r.pop():new ArrayBuffer(t)}It.mallocArrayBuffer=ie;function An(e){return new Uint8Array(ie(e),0,e)}It.mallocUint8=An;function Mo(e){return new Uint16Array(ie(2*e),0,e)}It.mallocUint16=Mo;function bo(e){return new Uint32Array(ie(4*e),0,e)}It.mallocUint32=bo;function _o(e){return new Int8Array(ie(e),0,e)}It.mallocInt8=_o;function So(e){return new Int16Array(ie(2*e),0,e)}It.mallocInt16=So;function To(e){return new Int32Array(ie(4*e),0,e)}It.mallocInt32=To;function Bo(e){return new Float32Array(ie(4*e),0,e)}It.mallocFloat32=It.mallocFloat=Bo;function Po(e){return new Float64Array(ie(8*e),0,e)}It.mallocFloat64=It.mallocDouble=Po;function Do(e){return G0?new Uint8ClampedArray(ie(e),0,e):An(e)}It.mallocUint8Clamped=Do;function Fo(e){return O0?new BigUint64Array(ie(8*e),0,e):null}It.mallocBigUint64=Fo;function Ao(e){return V0?new BigInt64Array(ie(8*e),0,e):null}It.mallocBigInt64=Ao;function Uo(e){return new DataView(ie(e),0,e)}It.mallocDataView=Uo;It.clearCache=function(){for(var t=0;t<32;++t)Qt.UINT8[t].length=0,Qt.UINT16[t].length=0,Qt.UINT32[t].length=0,Qt.INT8[t].length=0,Qt.INT16[t].length=0,Qt.INT32[t].length=0,Qt.FLOAT[t].length=0,Qt.DOUBLE[t].length=0,Qt.BIGUINT64[t].length=0,Qt.BIGINT64[t].length=0,Qt.UINT8C[t].length=0,Ur[t].length=0}});var Ro=xt((Wl,Lo)=>{"use strict";Lo.exports=N0;var Ir=32;function N0(e,t){t<=4*Ir?Lr(0,t-1,e):Rr(0,t-1,e)}function Lr(e,t,n){for(var r=2*(e+1),i=e+1;i<=t;++i){for(var o=n[r++],a=n[r++],f=i,h=r-2;f-- >e;){var v=n[h-2],d=n[h-1];if(v<o)break;if(v===o&&d<a)break;n[h]=v,n[h+1]=d,h-=2}n[h]=o,n[h+1]=a}}function zo(e,t,n){e*=2,t*=2;var r=n[e],i=n[e+1];n[e]=n[t],n[e+1]=n[t+1],n[t]=r,n[t+1]=i}function Eo(e,t,n){e*=2,t*=2,n[e]=n[t],n[e+1]=n[t+1]}function m0(e,t,n,r){e*=2,t*=2,n*=2;var i=r[e],o=r[e+1];r[e]=r[t],r[e+1]=r[t+1],r[t]=r[n],r[t+1]=r[n+1],r[n]=i,r[n+1]=o}function Io(e,t,n,r,i){e*=2,t*=2,i[e]=i[t],i[t]=n,i[e+1]=i[t+1],i[t+1]=r}function de(e,t,n){e*=2,t*=2;var r=n[e],i=n[t];return r<i?!1:r===i?n[e+1]>n[t+1]:!0}function Er(e,t,n,r){e*=2;var i=r[e];return i<t?!0:i===t?r[e+1]<n:!1}function Rr(e,t,n){var r=(t-e+1)/6|0,i=e+r,o=t-r,a=e+t>>1,f=a-r,h=a+r,v=i,d=f,D=a,X=h,m=o,G=e+1,q=t-1,N=0;de(v,d,n)&&(N=v,v=d,d=N),de(X,m,n)&&(N=X,X=m,m=N),de(v,D,n)&&(N=v,v=D,D=N),de(d,D,n)&&(N=d,d=D,D=N),de(v,X,n)&&(N=v,v=X,X=N),de(D,X,n)&&(N=D,D=X,X=N),de(d,m,n)&&(N=d,d=m,m=N),de(d,D,n)&&(N=d,d=D,D=N),de(X,m,n)&&(N=X,X=m,m=N);for(var Y=n[2*d],K=n[2*d+1],Q=n[2*X],tt=n[2*X+1],H=2*v,W=2*D,st=2*m,et=2*i,rt=2*a,F=2*o,s=0;s<2;++s){var p=n[H+s],_=n[W+s],M=n[st+s];n[et+s]=p,n[rt+s]=_,n[F+s]=M}Eo(f,e,n),Eo(h,t,n);for(var T=G;T<=q;++T)if(Er(T,Y,K,n))T!==G&&zo(T,G,n),++G;else if(!Er(T,Q,tt,n))for(;;)if(Er(q,Q,tt,n)){Er(q,Y,K,n)?(m0(T,G,q,n),++G,--q):(zo(T,q,n),--q);break}else{if(--q<T)break;continue}Io(e,G-1,Y,K,n),Io(t,q+1,Q,tt,n),G-2-e<=Ir?Lr(e,G-2,n):Rr(e,G-2,n),t-(q+2)<=Ir?Lr(q+2,t,n):Rr(q+2,t,n),q-G<=Ir?Lr(G,q,n):Rr(G,q,n)}});var Un=xt((Kl,Go)=>{"use strict";Go.exports={init:X0,sweepBipartite:k0,sweepComplete:Y0,scanBipartite:H0,scanComplete:Z0};var Yt=zr(),C0=rr(),Gr=Ro(),se=1<<28,ze=1024,Jt=Yt.mallocInt32(ze),we=Yt.mallocInt32(ze),xe=Yt.mallocInt32(ze),Ue=Yt.mallocInt32(ze),Xe=Yt.mallocInt32(ze),nr=Yt.mallocInt32(ze),St=Yt.mallocDouble(ze*8);function X0(e){var t=C0.nextPow2(e);Jt.length<t&&(Yt.free(Jt),Jt=Yt.mallocInt32(t)),we.length<t&&(Yt.free(we),we=Yt.mallocInt32(t)),xe.length<t&&(Yt.free(xe),xe=Yt.mallocInt32(t)),Ue.length<t&&(Yt.free(Ue),Ue=Yt.mallocInt32(t)),Xe.length<t&&(Yt.free(Xe),Xe=Yt.mallocInt32(t)),nr.length<t&&(Yt.free(nr),nr=Yt.mallocInt32(t));var n=8*t;St.length<n&&(Yt.free(St),St=Yt.mallocDouble(n))}function ke(e,t,n,r){var i=t[r],o=e[n-1];e[i]=o,t[o]=i}function Ye(e,t,n,r){e[n]=r,t[r]=n}function k0(e,t,n,r,i,o,a,f,h,v){for(var d=0,D=2*e,X=e-1,m=D-1,G=n;G<r;++G){var q=o[G],N=D*G;St[d++]=i[N+X],St[d++]=-(q+1),St[d++]=i[N+m],St[d++]=q}for(var G=a;G<f;++G){var q=v[G]+se,Y=D*G;St[d++]=h[Y+X],St[d++]=-q,St[d++]=h[Y+m],St[d++]=q}var K=d>>>1;Gr(St,K);for(var Q=0,tt=0,G=0;G<K;++G){var H=St[2*G+1]|0;if(H>=se)H=H-se|0,ke(xe,Ue,tt--,H);else if(H>=0)ke(Jt,we,Q--,H);else if(H<=-se){H=-H-se|0;for(var W=0;W<Q;++W){var st=t(Jt[W],H);if(st!==void 0)return st}Ye(xe,Ue,tt++,H)}else{H=-H-1|0;for(var W=0;W<tt;++W){var st=t(H,xe[W]);if(st!==void 0)return st}Ye(Jt,we,Q++,H)}}}function Y0(e,t,n,r,i,o,a,f,h,v){for(var d=0,D=2*e,X=e-1,m=D-1,G=n;G<r;++G){var q=o[G]+1<<1,N=D*G;St[d++]=i[N+X],St[d++]=-q,St[d++]=i[N+m],St[d++]=q}for(var G=a;G<f;++G){var q=v[G]+1<<1,Y=D*G;St[d++]=h[Y+X],St[d++]=-q|1,St[d++]=h[Y+m],St[d++]=q|1}var K=d>>>1;Gr(St,K);for(var Q=0,tt=0,H=0,G=0;G<K;++G){var W=St[2*G+1]|0,st=W&1;if(G<K-1&&W>>1===St[2*G+3]>>1&&(st=2,G+=1),W<0){for(var et=-(W>>1)-1,rt=0;rt<H;++rt){var F=t(Xe[rt],et);if(F!==void 0)return F}if(st!==0)for(var rt=0;rt<Q;++rt){var F=t(Jt[rt],et);if(F!==void 0)return F}if(st!==1)for(var rt=0;rt<tt;++rt){var F=t(xe[rt],et);if(F!==void 0)return F}st===0?Ye(Jt,we,Q++,et):st===1?Ye(xe,Ue,tt++,et):st===2&&Ye(Xe,nr,H++,et)}else{var et=(W>>1)-1;st===0?ke(Jt,we,Q--,et):st===1?ke(xe,Ue,tt--,et):st===2&&ke(Xe,nr,H--,et)}}}function H0(e,t,n,r,i,o,a,f,h,v,d,D){var X=0,m=2*e,G=t,q=t+e,N=1,Y=1;r?Y=se:N=se;for(var K=i;K<o;++K){var Q=K+N,tt=m*K;St[X++]=a[tt+G],St[X++]=-Q,St[X++]=a[tt+q],St[X++]=Q}for(var K=h;K<v;++K){var Q=K+Y,H=m*K;St[X++]=d[H+G],St[X++]=-Q}var W=X>>>1;Gr(St,W);for(var st=0,K=0;K<W;++K){var et=St[2*K+1]|0;if(et<0){var Q=-et,rt=!1;if(Q>=se?(rt=!r,Q-=se):(rt=!!r,Q-=1),rt)Ye(Jt,we,st++,Q);else{var F=D[Q],s=m*Q,p=d[s+t+1],_=d[s+t+1+e];t:for(var M=0;M<st;++M){var T=Jt[M],I=m*T;if(!(_<a[I+t+1]||a[I+t+1+e]<p)){for(var O=t+2;O<e;++O)if(d[s+O+e]<a[I+O]||a[I+O+e]<d[s+O])continue t;var P=f[T],l;if(r?l=n(F,P):l=n(P,F),l!==void 0)return l}}}}else ke(Jt,we,st--,et-N)}}function Z0(e,t,n,r,i,o,a,f,h,v,d){for(var D=0,X=2*e,m=t,G=t+e,q=r;q<i;++q){var N=q+se,Y=X*q;St[D++]=o[Y+m],St[D++]=-N,St[D++]=o[Y+G],St[D++]=N}for(var q=f;q<h;++q){var N=q+1,K=X*q;St[D++]=v[K+m],St[D++]=-N}var Q=D>>>1;Gr(St,Q);for(var tt=0,q=0;q<Q;++q){var H=St[2*q+1]|0;if(H<0){var N=-H;if(N>=se)Jt[tt++]=N-se;else{N-=1;var W=d[N],st=X*N,et=v[st+t+1],rt=v[st+t+1+e];t:for(var F=0;F<tt;++F){var s=Jt[F],p=a[s];if(p===W)break;var _=X*s;if(!(rt<o[_+t+1]||o[_+t+1+e]<et)){for(var M=t+2;M<e;++M)if(v[st+M+e]<o[_+M]||o[_+M+e]<v[st+M])continue t;var T=n(p,W);if(T!==void 0)return T}}}}else{for(var N=H-se,F=tt-1;F>=0;--F)if(Jt[F]===N){for(var M=F+1;M<tt;++M)Jt[M-1]=Jt[M];break}--tt}}}});var mo=xt(On=>{"use strict";var Ee="d",$e="ax",Oo="vv",zn="fp",ir="es",Or="rs",Rn="re",or="rb",Vo="ri",He="rp",Vr="bs",Gn="be",ar="bb",qo="bi",Ze="bp",En="rv",In="Q",Ln=[Ee,$e,Oo,Or,Rn,or,Vo,Vr,Gn,ar,qo];function $0(e,t,n){var r="bruteForce"+(e?"Red":"Blue")+(t?"Flip":"")+(n?"Full":""),i=["function ",r,"(",Ln.join(),"){","var ",ir,"=2*",Ee,";"],o="for(var i="+Or+","+He+"="+ir+"*"+Or+";i<"+Rn+";++i,"+He+"+="+ir+"){var x0="+or+"["+$e+"+"+He+"],x1="+or+"["+$e+"+"+He+"+"+Ee+"],xi="+Vo+"[i];",a="for(var j="+Vr+","+Ze+"="+ir+"*"+Vr+";j<"+Gn+";++j,"+Ze+"+="+ir+"){var y0="+ar+"["+$e+"+"+Ze+"],"+(n?"y1="+ar+"["+$e+"+"+Ze+"+"+Ee+"],":"")+"yi="+qo+"[j];";return e?i.push(o,In,":",a):i.push(a,In,":",o),n?i.push("if(y1<x0||x1<y0)continue;"):t?i.push("if(y0<=x0||x1<y0)continue;"):i.push("if(y0<x0||x1<y0)continue;"),i.push("for(var k="+$e+"+1;k<"+Ee+";++k){var r0="+or+"[k+"+He+"],r1="+or+"[k+"+Ee+"+"+He+"],b0="+ar+"[k+"+Ze+"],b1="+ar+"[k+"+Ee+"+"+Ze+"];if(r1<b0||b1<r0)continue "+In+";}var "+En+"="+Oo+"("),t?i.push("yi,xi"):i.push("xi,yi"),i.push(");if("+En+"!==void 0)return "+En+";}}}"),{name:r,code:i.join("")}}function No(e){var t="bruteForce"+(e?"Full":"Partial"),n=[],r=Ln.slice();e||r.splice(3,0,zn);var i=["function "+t+"("+r.join()+"){"];function o(h,v){var d=$0(h,v,e);n.push(d.code),i.push("return "+d.name+"("+Ln.join()+");")}i.push("if("+Rn+"-"+Or+">"+Gn+"-"+Vr+"){"),e?(o(!0,!1),i.push("}else{"),o(!1,!1)):(i.push("if("+zn+"){"),o(!0,!0),i.push("}else{"),o(!0,!1),i.push("}}else{if("+zn+"){"),o(!1,!0),i.push("}else{"),o(!1,!1),i.push("}")),i.push("}}return "+t);var a=n.join("")+i.join(""),f=new Function(a);return f()}On.partial=No(!1);On.full=No(!0)});var Vn=xt((Jl,Co)=>{"use strict";Co.exports=K0;var W0="for(var j=2*a,k=j*c,l=k,m=c,n=b,o=a+b,p=c;d>p;++p,k+=j){var _;if($)if(m===p)m+=1,l+=j;else{for(var s=0;j>s;++s){var t=e[k+s];e[k+s]=e[l],e[l++]=t}var u=f[p];f[p]=f[m],f[m++]=u}}return m";function K0(e,t){var n="abcdef".split("").concat(t),r=[];return e.indexOf("lo")>=0&&r.push("lo=e[k+n]"),e.indexOf("hi")>=0&&r.push("hi=e[k+o]"),n.push(W0.replace("_",r.join()).replace("$",e)),Function.apply(void 0,n)}});var Yo=xt((jl,ko)=>{"use strict";ko.exports=tf;var Q0=Vn(),Xo=Q0("lo<p0",["p0"]),J0=8;function j0(e,t,n,r,i,o){for(var a=2*e,f=a*(n+1)+t,h=n+1;h<r;++h,f+=a)for(var v=i[f],d=h,D=a*(h-1);d>n&&i[D+t]>v;--d,D-=a){for(var X=D,m=D+a,G=0;G<a;++G,++X,++m){var q=i[X];i[X]=i[m],i[m]=q}var N=o[d];o[d]=o[d-1],o[d-1]=N}}function tf(e,t,n,r,i,o){if(r<=n+1)return n;for(var a=n,f=r,h=r+n>>>1,v=2*e,d=h,D=i[v*h+t];a<f;){if(f-a<J0){j0(e,t,a,f,i,o),D=i[v*h+t];break}var X=f-a,m=Math.random()*X+a|0,G=i[v*m+t],q=Math.random()*X+a|0,N=i[v*q+t],Y=Math.random()*X+a|0,K=i[v*Y+t];G<=N?K>=N?(d=q,D=N):G>=K?(d=m,D=G):(d=Y,D=K):N>=K?(d=q,D=N):K>=G?(d=m,D=G):(d=Y,D=K);for(var H=v*(f-1),W=v*d,Q=0;Q<v;++Q,++H,++W){var tt=i[H];i[H]=i[W],i[W]=tt}var st=o[f-1];o[f-1]=o[d],o[d]=st,d=Xo(e,t,a,f-1,i,o,D);for(var H=v*(f-1),W=v*d,Q=0;Q<v;++Q,++H,++W){var tt=i[H];i[H]=i[W],i[W]=tt}var st=o[f-1];if(o[f-1]=o[d],o[d]=st,h<d){for(f=d-1;a<f&&i[v*(f-1)+t]===D;)f-=1;f+=1}else if(d<h)for(a=d+1;a<f&&i[v*a+t]===D;)a+=1;else break}return Xo(e,t,n,h,i,o,i[v*h+t])}});var Jo=xt((th,Qo)=>{"use strict";Qo.exports=pf;var We=zr(),qn=rr(),Wo=mo(),ef=Wo.partial,rf=Wo.full,_e=Un(),nf=Yo(),Ke=Vn(),Ho=128,of=1<<22,af=1<<22,sf=Ke("!(lo>=p0)&&!(p1>=hi)",["p0","p1"]),Zo=Ke("lo===p0",["p0"]),uf=Ke("lo<p0",["p0"]),ff=Ke("hi<=p0",["p0"]),$o=Ke("lo<=p0&&p0<=hi",["p0"]),cf=Ke("lo<p0&&p0<=hi",["p0"]),Nn=6,mn=2,Ko=1024,ee=We.mallocInt32(Ko),Ie=We.mallocDouble(Ko);function lf(e,t){var n=8*qn.log2(t+1)*(e+1)|0,r=qn.nextPow2(Nn*n);ee.length<r&&(We.free(ee),ee=We.mallocInt32(r));var i=qn.nextPow2(mn*n);Ie.length<i&&(We.free(Ie),Ie=We.mallocDouble(i))}function ce(e,t,n,r,i,o,a,f,h){var v=Nn*e;ee[v]=t,ee[v+1]=n,ee[v+2]=r,ee[v+3]=i,ee[v+4]=o,ee[v+5]=a;var d=mn*e;Ie[d]=f,Ie[d+1]=h}function hf(e,t,n,r,i,o,a,f,h,v,d){var D=2*e,X=h*D,m=v[X+t];t:for(var G=i,q=i*D;G<o;++G,q+=D){var N=a[q+t],Y=a[q+t+e];if(!(m<N||Y<m)&&!(r&&m===N)){for(var K=f[G],Q=t+1;Q<e;++Q){var N=a[q+Q],Y=a[q+Q+e],tt=v[X+Q],H=v[X+Q+e];if(Y<tt||H<N)continue t}var W;if(r?W=n(d,K):W=n(K,d),W!==void 0)return W}}}function vf(e,t,n,r,i,o,a,f,h,v){var d=2*e,D=f*d,X=h[D+t];t:for(var m=r,G=r*d;m<i;++m,G+=d){var q=a[m];if(q!==v){var N=o[G+t],Y=o[G+t+e];if(!(X<N||Y<X)){for(var K=t+1;K<e;++K){var N=o[G+K],Y=o[G+K+e],Q=h[D+K],tt=h[D+K+e];if(Y<Q||tt<N)continue t}var H=n(q,v);if(H!==void 0)return H}}}}function pf(e,t,n,r,i,o,a,f,h){lf(e,r+a);var v=0,d=2*e,D;for(ce(v++,0,0,r,0,a,n?16:0,-1/0,1/0),n||ce(v++,0,0,a,0,r,1,-1/0,1/0);v>0;){v-=1;var X=v*Nn,m=ee[X],G=ee[X+1],q=ee[X+2],N=ee[X+3],Y=ee[X+4],K=ee[X+5],Q=v*mn,tt=Ie[Q],H=Ie[Q+1],W=K&1,st=!!(K&16),et=i,rt=o,F=f,s=h;if(W&&(et=f,rt=h,F=i,s=o),!(K&2&&(q=uf(e,m,G,q,et,rt,H),G>=q))&&!(K&4&&(G=ff(e,m,G,q,et,rt,tt),G>=q))){var p=q-G,_=Y-N;if(st){if(e*p*(p+_)<af){if(D=_e.scanComplete(e,m,t,G,q,et,rt,N,Y,F,s),D!==void 0)return D;continue}}else if(e*Math.min(p,_)<Ho){if(D=ef(e,m,t,W,G,q,et,rt,N,Y,F,s),D!==void 0)return D;continue}else if(e*p*_<of){if(D=_e.scanBipartite(e,m,t,W,G,q,et,rt,N,Y,F,s),D!==void 0)return D;continue}var M=sf(e,m,G,q,et,rt,tt,H);if(G<M)if(e*(M-G)<Ho){if(D=rf(e,m+1,t,G,M,et,rt,N,Y,F,s),D!==void 0)return D}else if(m===e-2){if(W?D=_e.sweepBipartite(e,t,N,Y,F,s,G,M,et,rt):D=_e.sweepBipartite(e,t,G,M,et,rt,N,Y,F,s),D!==void 0)return D}else ce(v++,m+1,G,M,N,Y,W,-1/0,1/0),ce(v++,m+1,N,Y,G,M,W^1,-1/0,1/0);if(M<q){var T=nf(e,m,N,Y,F,s),I=F[d*T+m],O=Zo(e,m,T,Y,F,s,I);if(O<Y&&ce(v++,m,M,q,O,Y,(W|4)+(st?16:0),I,H),N<T&&ce(v++,m,M,q,N,T,(W|2)+(st?16:0),tt,I),T+1===O){if(st?D=vf(e,m,t,M,q,et,rt,T,F,s[T]):D=hf(e,m,t,W,M,q,et,rt,T,F,s[T]),D!==void 0)return D}else if(T<O){var P;if(st){if(P=$o(e,m,M,q,et,rt,I),M<P){var l=Zo(e,m,M,P,et,rt,I);if(m===e-2){if(M<l&&(D=_e.sweepComplete(e,t,M,l,et,rt,T,O,F,s),D!==void 0)||l<P&&(D=_e.sweepBipartite(e,t,l,P,et,rt,T,O,F,s),D!==void 0))return D}else M<l&&ce(v++,m+1,M,l,T,O,16,-1/0,1/0),l<P&&(ce(v++,m+1,l,P,T,O,0,-1/0,1/0),ce(v++,m+1,T,O,l,P,1,-1/0,1/0))}}else W?P=cf(e,m,M,q,et,rt,I):P=$o(e,m,M,q,et,rt,I),M<P&&(m===e-2?W?D=_e.sweepBipartite(e,t,T,O,F,s,M,P,et,rt):D=_e.sweepBipartite(e,t,M,P,et,rt,T,O,F,s):(ce(v++,m+1,M,P,T,O,W,-1/0,1/0),ce(v++,m+1,T,O,M,P,W^1,-1/0,1/0)))}}}}}});var ra=xt((eh,ea)=>{"use strict";ea.exports=yf;var Se=zr(),qr=Un(),gf=Jo();function df(e,t){for(var n=0;n<e;++n)if(!(t[n]<=t[n+e]))return!0;return!1}function jo(e,t,n,r){for(var i=0,o=0,a=0,f=e.length;a<f;++a){var h=e[a];if(!df(t,h)){for(var v=0;v<2*t;++v)n[i++]=h[v];r[o++]=a}}return o}function Nr(e,t,n,r){var i=e.length,o=t.length;if(!(i<=0||o<=0)){var a=e[0].length>>>1;if(!(a<=0)){var f,h=Se.mallocDouble(2*a*i),v=Se.mallocInt32(i);if(i=jo(e,a,h,v),i>0){if(a===1&&r)qr.init(i),f=qr.sweepComplete(a,n,0,i,h,v,0,i,h,v);else{var d=Se.mallocDouble(2*a*o),D=Se.mallocInt32(o);o=jo(t,a,d,D),o>0&&(qr.init(i+o),a===1?f=qr.sweepBipartite(a,n,0,i,h,v,0,o,d,D):f=gf(a,n,r,i,h,v,o,d,D),Se.free(d),Se.free(D))}Se.free(h),Se.free(v)}return f}}}var sr;function ta(e,t){sr.push([e,t])}function wf(e){return sr=[],Nr(e,e,ta,!0),sr}function xf(e,t){return sr=[],Nr(e,t,ta,!1),sr}function yf(e,t,n){var r;switch(arguments.length){case 1:return wf(e);case 2:return typeof t=="function"?Nr(e,e,t,!0):xf(e,t);case 3:return Nr(e,t,n,!1);default:throw new Error("box-intersect: Invalid arguments")}}});var ia=xt((rh,na)=>{"use strict";na.exports=bf;var mr=bn()[3];function Mf(e,t,n,r){for(var i=0;i<2;++i){var o=e[i],a=t[i],f=Math.min(o,a),h=Math.max(o,a),v=n[i],d=r[i],D=Math.min(v,d),X=Math.max(v,d);if(X<f||h<D)return!1}return!0}function bf(e,t,n,r){var i=mr(e,n,r),o=mr(t,n,r);if(i>0&&o>0||i<0&&o<0)return!1;var a=mr(n,e,t),f=mr(r,e,t);return a>0&&f>0||a<0&&f<0?!1:i===0&&o===0&&a===0&&f===0?Mf(e,t,n,r):!0}});var oa=xt(()=>{});var ur=xt((aa,Cn)=>{(function(e,t){"use strict";function n(F,s){if(!F)throw new Error(s||"Assertion failed")}function r(F,s){F.super_=s;var p=function(){};p.prototype=s.prototype,F.prototype=new p,F.prototype.constructor=F}function i(F,s,p){if(i.isBN(F))return F;this.negative=0,this.words=null,this.length=0,this.red=null,F!==null&&((s==="le"||s==="be")&&(p=s,s=10),this._init(F||0,s||10,p||"be"))}typeof e=="object"?e.exports=i:t.BN=i,i.BN=i,i.wordSize=26;var o;try{typeof window<"u"&&typeof window.Buffer<"u"?o=window.Buffer:o=oa().Buffer}catch{}i.isBN=function(s){return s instanceof i?!0:s!==null&&typeof s=="object"&&s.constructor.wordSize===i.wordSize&&Array.isArray(s.words)},i.max=function(s,p){return s.cmp(p)>0?s:p},i.min=function(s,p){return s.cmp(p)<0?s:p},i.prototype._init=function(s,p,_){if(typeof s=="number")return this._initNumber(s,p,_);if(typeof s=="object")return this._initArray(s,p,_);p==="hex"&&(p=16),n(p===(p|0)&&p>=2&&p<=36),s=s.toString().replace(/\s+/g,"");var M=0;s[0]==="-"&&(M++,this.negative=1),M<s.length&&(p===16?this._parseHex(s,M,_):(this._parseBase(s,p,M),_==="le"&&this._initArray(this.toArray(),p,_)))},i.prototype._initNumber=function(s,p,_){s<0&&(this.negative=1,s=-s),s<67108864?(this.words=[s&67108863],this.length=1):s<4503599627370496?(this.words=[s&67108863,s/67108864&67108863],this.length=2):(n(s<9007199254740992),this.words=[s&67108863,s/67108864&67108863,1],this.length=3),_==="le"&&this._initArray(this.toArray(),p,_)},i.prototype._initArray=function(s,p,_){if(n(typeof s.length=="number"),s.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(s.length/3),this.words=new Array(this.length);for(var M=0;M<this.length;M++)this.words[M]=0;var T,I,O=0;if(_==="be")for(M=s.length-1,T=0;M>=0;M-=3)I=s[M]|s[M-1]<<8|s[M-2]<<16,this.words[T]|=I<<O&67108863,this.words[T+1]=I>>>26-O&67108863,O+=24,O>=26&&(O-=26,T++);else if(_==="le")for(M=0,T=0;M<s.length;M+=3)I=s[M]|s[M+1]<<8|s[M+2]<<16,this.words[T]|=I<<O&67108863,this.words[T+1]=I>>>26-O&67108863,O+=24,O>=26&&(O-=26,T++);return this.strip()};function a(F,s){var p=F.charCodeAt(s);return p>=65&&p<=70?p-55:p>=97&&p<=102?p-87:p-48&15}function f(F,s,p){var _=a(F,p);return p-1>=s&&(_|=a(F,p-1)<<4),_}i.prototype._parseHex=function(s,p,_){this.length=Math.ceil((s.length-p)/6),this.words=new Array(this.length);for(var M=0;M<this.length;M++)this.words[M]=0;var T=0,I=0,O;if(_==="be")for(M=s.length-1;M>=p;M-=2)O=f(s,p,M)<<T,this.words[I]|=O&67108863,T>=18?(T-=18,I+=1,this.words[I]|=O>>>26):T+=8;else{var P=s.length-p;for(M=P%2===0?p+1:p;M<s.length;M+=2)O=f(s,p,M)<<T,this.words[I]|=O&67108863,T>=18?(T-=18,I+=1,this.words[I]|=O>>>26):T+=8}this.strip()};function h(F,s,p,_){for(var M=0,T=Math.min(F.length,p),I=s;I<T;I++){var O=F.charCodeAt(I)-48;M*=_,O>=49?M+=O-49+10:O>=17?M+=O-17+10:M+=O}return M}i.prototype._parseBase=function(s,p,_){this.words=[0],this.length=1;for(var M=0,T=1;T<=67108863;T*=p)M++;M--,T=T/p|0;for(var I=s.length-_,O=I%M,P=Math.min(I,I-O)+_,l=0,U=_;U<P;U+=M)l=h(s,U,U+M,p),this.imuln(T),this.words[0]+l<67108864?this.words[0]+=l:this._iaddn(l);if(O!==0){var ot=1;for(l=h(s,U,s.length,p),U=0;U<O;U++)ot*=p;this.imuln(ot),this.words[0]+l<67108864?this.words[0]+=l:this._iaddn(l)}this.strip()},i.prototype.copy=function(s){s.words=new Array(this.length);for(var p=0;p<this.length;p++)s.words[p]=this.words[p];s.length=this.length,s.negative=this.negative,s.red=this.red},i.prototype.clone=function(){var s=new i(null);return this.copy(s),s},i.prototype._expand=function(s){for(;this.length<s;)this.words[this.length++]=0;return this},i.prototype.strip=function(){for(;this.length>1&&this.words[this.length-1]===0;)this.length--;return this._normSign()},i.prototype._normSign=function(){return this.length===1&&this.words[0]===0&&(this.negative=0),this},i.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var v=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],d=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],D=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];i.prototype.toString=function(s,p){s=s||10,p=p|0||1;var _;if(s===16||s==="hex"){_="";for(var M=0,T=0,I=0;I<this.length;I++){var O=this.words[I],P=((O<<M|T)&16777215).toString(16);T=O>>>24-M&16777215,M+=2,M>=26&&(M-=26,I--),T!==0||I!==this.length-1?_=v[6-P.length]+P+_:_=P+_}for(T!==0&&(_=T.toString(16)+_);_.length%p!==0;)_="0"+_;return this.negative!==0&&(_="-"+_),_}if(s===(s|0)&&s>=2&&s<=36){var l=d[s],U=D[s];_="";var ot=this.clone();for(ot.negative=0;!ot.isZero();){var at=ot.modn(U).toString(s);ot=ot.idivn(U),ot.isZero()?_=at+_:_=v[l-at.length]+at+_}for(this.isZero()&&(_="0"+_);_.length%p!==0;)_="0"+_;return this.negative!==0&&(_="-"+_),_}n(!1,"Base should be between 2 and 36")},i.prototype.toNumber=function(){var s=this.words[0];return this.length===2?s+=this.words[1]*67108864:this.length===3&&this.words[2]===1?s+=4503599627370496+this.words[1]*67108864:this.length>2&&n(!1,"Number can only safely store up to 53 bits"),this.negative!==0?-s:s},i.prototype.toJSON=function(){return this.toString(16)},i.prototype.toBuffer=function(s,p){return n(typeof o<"u"),this.toArrayLike(o,s,p)},i.prototype.toArray=function(s,p){return this.toArrayLike(Array,s,p)},i.prototype.toArrayLike=function(s,p,_){var M=this.byteLength(),T=_||Math.max(1,M);n(M<=T,"byte array longer than desired length"),n(T>0,"Requested array length <= 0"),this.strip();var I=p==="le",O=new s(T),P,l,U=this.clone();if(I){for(l=0;!U.isZero();l++)P=U.andln(255),U.iushrn(8),O[l]=P;for(;l<T;l++)O[l]=0}else{for(l=0;l<T-M;l++)O[l]=0;for(l=0;!U.isZero();l++)P=U.andln(255),U.iushrn(8),O[T-l-1]=P}return O},Math.clz32?i.prototype._countBits=function(s){return 32-Math.clz32(s)}:i.prototype._countBits=function(s){var p=s,_=0;return p>=4096&&(_+=13,p>>>=13),p>=64&&(_+=7,p>>>=7),p>=8&&(_+=4,p>>>=4),p>=2&&(_+=2,p>>>=2),_+p},i.prototype._zeroBits=function(s){if(s===0)return 26;var p=s,_=0;return(p&8191)===0&&(_+=13,p>>>=13),(p&127)===0&&(_+=7,p>>>=7),(p&15)===0&&(_+=4,p>>>=4),(p&3)===0&&(_+=2,p>>>=2),(p&1)===0&&_++,_},i.prototype.bitLength=function(){var s=this.words[this.length-1],p=this._countBits(s);return(this.length-1)*26+p};function X(F){for(var s=new Array(F.bitLength()),p=0;p<s.length;p++){var _=p/26|0,M=p%26;s[p]=(F.words[_]&1<<M)>>>M}return s}i.prototype.zeroBits=function(){if(this.isZero())return 0;for(var s=0,p=0;p<this.length;p++){var _=this._zeroBits(this.words[p]);if(s+=_,_!==26)break}return s},i.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},i.prototype.toTwos=function(s){return this.negative!==0?this.abs().inotn(s).iaddn(1):this.clone()},i.prototype.fromTwos=function(s){return this.testn(s-1)?this.notn(s).iaddn(1).ineg():this.clone()},i.prototype.isNeg=function(){return this.negative!==0},i.prototype.neg=function(){return this.clone().ineg()},i.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},i.prototype.iuor=function(s){for(;this.length<s.length;)this.words[this.length++]=0;for(var p=0;p<s.length;p++)this.words[p]=this.words[p]|s.words[p];return this.strip()},i.prototype.ior=function(s){return n((this.negative|s.negative)===0),this.iuor(s)},i.prototype.or=function(s){return this.length>s.length?this.clone().ior(s):s.clone().ior(this)},i.prototype.uor=function(s){return this.length>s.length?this.clone().iuor(s):s.clone().iuor(this)},i.prototype.iuand=function(s){var p;this.length>s.length?p=s:p=this;for(var _=0;_<p.length;_++)this.words[_]=this.words[_]&s.words[_];return this.length=p.length,this.strip()},i.prototype.iand=function(s){return n((this.negative|s.negative)===0),this.iuand(s)},i.prototype.and=function(s){return this.length>s.length?this.clone().iand(s):s.clone().iand(this)},i.prototype.uand=function(s){return this.length>s.length?this.clone().iuand(s):s.clone().iuand(this)},i.prototype.iuxor=function(s){var p,_;this.length>s.length?(p=this,_=s):(p=s,_=this);for(var M=0;M<_.length;M++)this.words[M]=p.words[M]^_.words[M];if(this!==p)for(;M<p.length;M++)this.words[M]=p.words[M];return this.length=p.length,this.strip()},i.prototype.ixor=function(s){return n((this.negative|s.negative)===0),this.iuxor(s)},i.prototype.xor=function(s){return this.length>s.length?this.clone().ixor(s):s.clone().ixor(this)},i.prototype.uxor=function(s){return this.length>s.length?this.clone().iuxor(s):s.clone().iuxor(this)},i.prototype.inotn=function(s){n(typeof s=="number"&&s>=0);var p=Math.ceil(s/26)|0,_=s%26;this._expand(p),_>0&&p--;for(var M=0;M<p;M++)this.words[M]=~this.words[M]&67108863;return _>0&&(this.words[M]=~this.words[M]&67108863>>26-_),this.strip()},i.prototype.notn=function(s){return this.clone().inotn(s)},i.prototype.setn=function(s,p){n(typeof s=="number"&&s>=0);var _=s/26|0,M=s%26;return this._expand(_+1),p?this.words[_]=this.words[_]|1<<M:this.words[_]=this.words[_]&~(1<<M),this.strip()},i.prototype.iadd=function(s){var p;if(this.negative!==0&&s.negative===0)return this.negative=0,p=this.isub(s),this.negative^=1,this._normSign();if(this.negative===0&&s.negative!==0)return s.negative=0,p=this.isub(s),s.negative=1,p._normSign();var _,M;this.length>s.length?(_=this,M=s):(_=s,M=this);for(var T=0,I=0;I<M.length;I++)p=(_.words[I]|0)+(M.words[I]|0)+T,this.words[I]=p&67108863,T=p>>>26;for(;T!==0&&I<_.length;I++)p=(_.words[I]|0)+T,this.words[I]=p&67108863,T=p>>>26;if(this.length=_.length,T!==0)this.words[this.length]=T,this.length++;else if(_!==this)for(;I<_.length;I++)this.words[I]=_.words[I];return this},i.prototype.add=function(s){var p;return s.negative!==0&&this.negative===0?(s.negative=0,p=this.sub(s),s.negative^=1,p):s.negative===0&&this.negative!==0?(this.negative=0,p=s.sub(this),this.negative=1,p):this.length>s.length?this.clone().iadd(s):s.clone().iadd(this)},i.prototype.isub=function(s){if(s.negative!==0){s.negative=0;var p=this.iadd(s);return s.negative=1,p._normSign()}else if(this.negative!==0)return this.negative=0,this.iadd(s),this.negative=1,this._normSign();var _=this.cmp(s);if(_===0)return this.negative=0,this.length=1,this.words[0]=0,this;var M,T;_>0?(M=this,T=s):(M=s,T=this);for(var I=0,O=0;O<T.length;O++)p=(M.words[O]|0)-(T.words[O]|0)+I,I=p>>26,this.words[O]=p&67108863;for(;I!==0&&O<M.length;O++)p=(M.words[O]|0)+I,I=p>>26,this.words[O]=p&67108863;if(I===0&&O<M.length&&M!==this)for(;O<M.length;O++)this.words[O]=M.words[O];return this.length=Math.max(this.length,O),M!==this&&(this.negative=1),this.strip()},i.prototype.sub=function(s){return this.clone().isub(s)};function m(F,s,p){p.negative=s.negative^F.negative;var _=F.length+s.length|0;p.length=_,_=_-1|0;var M=F.words[0]|0,T=s.words[0]|0,I=M*T,O=I&67108863,P=I/67108864|0;p.words[0]=O;for(var l=1;l<_;l++){for(var U=P>>>26,ot=P&67108863,at=Math.min(l,s.length-1),ut=Math.max(0,l-F.length+1);ut<=at;ut++){var ft=l-ut|0;M=F.words[ft]|0,T=s.words[ut]|0,I=M*T+ot,U+=I/67108864|0,ot=I&67108863}p.words[l]=ot|0,P=U|0}return P!==0?p.words[l]=P|0:p.length--,p.strip()}var G=function(s,p,_){var M=s.words,T=p.words,I=_.words,O=0,P,l,U,ot=M[0]|0,at=ot&8191,ut=ot>>>13,ft=M[1]|0,yt=ft&8191,vt=ft>>>13,k=M[2]|0,$=k&8191,A=k>>>13,c=M[3]|0,b=c&8191,w=c>>>13,E=M[4]|0,R=E&8191,V=E>>>13,C=M[5]|0,u=C&8191,B=C>>>13,x=M[6]|0,y=x&8191,g=x>>>13,S=M[7]|0,L=S&8191,z=S>>>13,Z=M[8]|0,J=Z&8191,j=Z>>>13,ct=M[9]|0,nt=ct&8191,it=ct>>>13,pt=T[0]|0,ht=pt&8191,lt=pt>>>13,gt=T[1]|0,wt=gt&8191,dt=gt>>>13,Ct=T[2]|0,Mt=Ct&8191,bt=Ct>>>13,Ht=T[3]|0,Bt=Ht&8191,Pt=Ht>>>13,$t=T[4]|0,Dt=$t&8191,Ft=$t>>>13,Wt=T[5]|0,At=Wt&8191,Ut=Wt>>>13,Kt=T[6]|0,zt=Kt&8191,Et=Kt>>>13,jt=T[7]|0,Rt=jt&8191,Gt=jt>>>13,Te=T[8]|0,Ot=Te&8191,Vt=Te>>>13,Be=T[9]|0,qt=Be&8191,mt=Be>>>13;_.negative=s.negative^p.negative,_.length=19,P=Math.imul(at,ht),l=Math.imul(at,lt),l=l+Math.imul(ut,ht)|0,U=Math.imul(ut,lt);var Ve=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Ve>>>26)|0,Ve&=67108863,P=Math.imul(yt,ht),l=Math.imul(yt,lt),l=l+Math.imul(vt,ht)|0,U=Math.imul(vt,lt),P=P+Math.imul(at,wt)|0,l=l+Math.imul(at,dt)|0,l=l+Math.imul(ut,wt)|0,U=U+Math.imul(ut,dt)|0;var qe=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(qe>>>26)|0,qe&=67108863,P=Math.imul($,ht),l=Math.imul($,lt),l=l+Math.imul(A,ht)|0,U=Math.imul(A,lt),P=P+Math.imul(yt,wt)|0,l=l+Math.imul(yt,dt)|0,l=l+Math.imul(vt,wt)|0,U=U+Math.imul(vt,dt)|0,P=P+Math.imul(at,Mt)|0,l=l+Math.imul(at,bt)|0,l=l+Math.imul(ut,Mt)|0,U=U+Math.imul(ut,bt)|0;var Ne=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Ne>>>26)|0,Ne&=67108863,P=Math.imul(b,ht),l=Math.imul(b,lt),l=l+Math.imul(w,ht)|0,U=Math.imul(w,lt),P=P+Math.imul($,wt)|0,l=l+Math.imul($,dt)|0,l=l+Math.imul(A,wt)|0,U=U+Math.imul(A,dt)|0,P=P+Math.imul(yt,Mt)|0,l=l+Math.imul(yt,bt)|0,l=l+Math.imul(vt,Mt)|0,U=U+Math.imul(vt,bt)|0,P=P+Math.imul(at,Bt)|0,l=l+Math.imul(at,Pt)|0,l=l+Math.imul(ut,Bt)|0,U=U+Math.imul(ut,Pt)|0;var Zt=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Zt>>>26)|0,Zt&=67108863,P=Math.imul(R,ht),l=Math.imul(R,lt),l=l+Math.imul(V,ht)|0,U=Math.imul(V,lt),P=P+Math.imul(b,wt)|0,l=l+Math.imul(b,dt)|0,l=l+Math.imul(w,wt)|0,U=U+Math.imul(w,dt)|0,P=P+Math.imul($,Mt)|0,l=l+Math.imul($,bt)|0,l=l+Math.imul(A,Mt)|0,U=U+Math.imul(A,bt)|0,P=P+Math.imul(yt,Bt)|0,l=l+Math.imul(yt,Pt)|0,l=l+Math.imul(vt,Bt)|0,U=U+Math.imul(vt,Pt)|0,P=P+Math.imul(at,Dt)|0,l=l+Math.imul(at,Ft)|0,l=l+Math.imul(ut,Dt)|0,U=U+Math.imul(ut,Ft)|0;var Wr=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Wr>>>26)|0,Wr&=67108863,P=Math.imul(u,ht),l=Math.imul(u,lt),l=l+Math.imul(B,ht)|0,U=Math.imul(B,lt),P=P+Math.imul(R,wt)|0,l=l+Math.imul(R,dt)|0,l=l+Math.imul(V,wt)|0,U=U+Math.imul(V,dt)|0,P=P+Math.imul(b,Mt)|0,l=l+Math.imul(b,bt)|0,l=l+Math.imul(w,Mt)|0,U=U+Math.imul(w,bt)|0,P=P+Math.imul($,Bt)|0,l=l+Math.imul($,Pt)|0,l=l+Math.imul(A,Bt)|0,U=U+Math.imul(A,Pt)|0,P=P+Math.imul(yt,Dt)|0,l=l+Math.imul(yt,Ft)|0,l=l+Math.imul(vt,Dt)|0,U=U+Math.imul(vt,Ft)|0,P=P+Math.imul(at,At)|0,l=l+Math.imul(at,Ut)|0,l=l+Math.imul(ut,At)|0,U=U+Math.imul(ut,Ut)|0;var Kr=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Kr>>>26)|0,Kr&=67108863,P=Math.imul(y,ht),l=Math.imul(y,lt),l=l+Math.imul(g,ht)|0,U=Math.imul(g,lt),P=P+Math.imul(u,wt)|0,l=l+Math.imul(u,dt)|0,l=l+Math.imul(B,wt)|0,U=U+Math.imul(B,dt)|0,P=P+Math.imul(R,Mt)|0,l=l+Math.imul(R,bt)|0,l=l+Math.imul(V,Mt)|0,U=U+Math.imul(V,bt)|0,P=P+Math.imul(b,Bt)|0,l=l+Math.imul(b,Pt)|0,l=l+Math.imul(w,Bt)|0,U=U+Math.imul(w,Pt)|0,P=P+Math.imul($,Dt)|0,l=l+Math.imul($,Ft)|0,l=l+Math.imul(A,Dt)|0,U=U+Math.imul(A,Ft)|0,P=P+Math.imul(yt,At)|0,l=l+Math.imul(yt,Ut)|0,l=l+Math.imul(vt,At)|0,U=U+Math.imul(vt,Ut)|0,P=P+Math.imul(at,zt)|0,l=l+Math.imul(at,Et)|0,l=l+Math.imul(ut,zt)|0,U=U+Math.imul(ut,Et)|0;var Qr=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Qr>>>26)|0,Qr&=67108863,P=Math.imul(L,ht),l=Math.imul(L,lt),l=l+Math.imul(z,ht)|0,U=Math.imul(z,lt),P=P+Math.imul(y,wt)|0,l=l+Math.imul(y,dt)|0,l=l+Math.imul(g,wt)|0,U=U+Math.imul(g,dt)|0,P=P+Math.imul(u,Mt)|0,l=l+Math.imul(u,bt)|0,l=l+Math.imul(B,Mt)|0,U=U+Math.imul(B,bt)|0,P=P+Math.imul(R,Bt)|0,l=l+Math.imul(R,Pt)|0,l=l+Math.imul(V,Bt)|0,U=U+Math.imul(V,Pt)|0,P=P+Math.imul(b,Dt)|0,l=l+Math.imul(b,Ft)|0,l=l+Math.imul(w,Dt)|0,U=U+Math.imul(w,Ft)|0,P=P+Math.imul($,At)|0,l=l+Math.imul($,Ut)|0,l=l+Math.imul(A,At)|0,U=U+Math.imul(A,Ut)|0,P=P+Math.imul(yt,zt)|0,l=l+Math.imul(yt,Et)|0,l=l+Math.imul(vt,zt)|0,U=U+Math.imul(vt,Et)|0,P=P+Math.imul(at,Rt)|0,l=l+Math.imul(at,Gt)|0,l=l+Math.imul(ut,Rt)|0,U=U+Math.imul(ut,Gt)|0;var Jr=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(Jr>>>26)|0,Jr&=67108863,P=Math.imul(J,ht),l=Math.imul(J,lt),l=l+Math.imul(j,ht)|0,U=Math.imul(j,lt),P=P+Math.imul(L,wt)|0,l=l+Math.imul(L,dt)|0,l=l+Math.imul(z,wt)|0,U=U+Math.imul(z,dt)|0,P=P+Math.imul(y,Mt)|0,l=l+Math.imul(y,bt)|0,l=l+Math.imul(g,Mt)|0,U=U+Math.imul(g,bt)|0,P=P+Math.imul(u,Bt)|0,l=l+Math.imul(u,Pt)|0,l=l+Math.imul(B,Bt)|0,U=U+Math.imul(B,Pt)|0,P=P+Math.imul(R,Dt)|0,l=l+Math.imul(R,Ft)|0,l=l+Math.imul(V,Dt)|0,U=U+Math.imul(V,Ft)|0,P=P+Math.imul(b,At)|0,l=l+Math.imul(b,Ut)|0,l=l+Math.imul(w,At)|0,U=U+Math.imul(w,Ut)|0,P=P+Math.imul($,zt)|0,l=l+Math.imul($,Et)|0,l=l+Math.imul(A,zt)|0,U=U+Math.imul(A,Et)|0,P=P+Math.imul(yt,Rt)|0,l=l+Math.imul(yt,Gt)|0,l=l+Math.imul(vt,Rt)|0,U=U+Math.imul(vt,Gt)|0,P=P+Math.imul(at,Ot)|0,l=l+Math.imul(at,Vt)|0,l=l+Math.imul(ut,Ot)|0,U=U+Math.imul(ut,Vt)|0;var jr=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(jr>>>26)|0,jr&=67108863,P=Math.imul(nt,ht),l=Math.imul(nt,lt),l=l+Math.imul(it,ht)|0,U=Math.imul(it,lt),P=P+Math.imul(J,wt)|0,l=l+Math.imul(J,dt)|0,l=l+Math.imul(j,wt)|0,U=U+Math.imul(j,dt)|0,P=P+Math.imul(L,Mt)|0,l=l+Math.imul(L,bt)|0,l=l+Math.imul(z,Mt)|0,U=U+Math.imul(z,bt)|0,P=P+Math.imul(y,Bt)|0,l=l+Math.imul(y,Pt)|0,l=l+Math.imul(g,Bt)|0,U=U+Math.imul(g,Pt)|0,P=P+Math.imul(u,Dt)|0,l=l+Math.imul(u,Ft)|0,l=l+Math.imul(B,Dt)|0,U=U+Math.imul(B,Ft)|0,P=P+Math.imul(R,At)|0,l=l+Math.imul(R,Ut)|0,l=l+Math.imul(V,At)|0,U=U+Math.imul(V,Ut)|0,P=P+Math.imul(b,zt)|0,l=l+Math.imul(b,Et)|0,l=l+Math.imul(w,zt)|0,U=U+Math.imul(w,Et)|0,P=P+Math.imul($,Rt)|0,l=l+Math.imul($,Gt)|0,l=l+Math.imul(A,Rt)|0,U=U+Math.imul(A,Gt)|0,P=P+Math.imul(yt,Ot)|0,l=l+Math.imul(yt,Vt)|0,l=l+Math.imul(vt,Ot)|0,U=U+Math.imul(vt,Vt)|0,P=P+Math.imul(at,qt)|0,l=l+Math.imul(at,mt)|0,l=l+Math.imul(ut,qt)|0,U=U+Math.imul(ut,mt)|0;var tn=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(tn>>>26)|0,tn&=67108863,P=Math.imul(nt,wt),l=Math.imul(nt,dt),l=l+Math.imul(it,wt)|0,U=Math.imul(it,dt),P=P+Math.imul(J,Mt)|0,l=l+Math.imul(J,bt)|0,l=l+Math.imul(j,Mt)|0,U=U+Math.imul(j,bt)|0,P=P+Math.imul(L,Bt)|0,l=l+Math.imul(L,Pt)|0,l=l+Math.imul(z,Bt)|0,U=U+Math.imul(z,Pt)|0,P=P+Math.imul(y,Dt)|0,l=l+Math.imul(y,Ft)|0,l=l+Math.imul(g,Dt)|0,U=U+Math.imul(g,Ft)|0,P=P+Math.imul(u,At)|0,l=l+Math.imul(u,Ut)|0,l=l+Math.imul(B,At)|0,U=U+Math.imul(B,Ut)|0,P=P+Math.imul(R,zt)|0,l=l+Math.imul(R,Et)|0,l=l+Math.imul(V,zt)|0,U=U+Math.imul(V,Et)|0,P=P+Math.imul(b,Rt)|0,l=l+Math.imul(b,Gt)|0,l=l+Math.imul(w,Rt)|0,U=U+Math.imul(w,Gt)|0,P=P+Math.imul($,Ot)|0,l=l+Math.imul($,Vt)|0,l=l+Math.imul(A,Ot)|0,U=U+Math.imul(A,Vt)|0,P=P+Math.imul(yt,qt)|0,l=l+Math.imul(yt,mt)|0,l=l+Math.imul(vt,qt)|0,U=U+Math.imul(vt,mt)|0;var en=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(en>>>26)|0,en&=67108863,P=Math.imul(nt,Mt),l=Math.imul(nt,bt),l=l+Math.imul(it,Mt)|0,U=Math.imul(it,bt),P=P+Math.imul(J,Bt)|0,l=l+Math.imul(J,Pt)|0,l=l+Math.imul(j,Bt)|0,U=U+Math.imul(j,Pt)|0,P=P+Math.imul(L,Dt)|0,l=l+Math.imul(L,Ft)|0,l=l+Math.imul(z,Dt)|0,U=U+Math.imul(z,Ft)|0,P=P+Math.imul(y,At)|0,l=l+Math.imul(y,Ut)|0,l=l+Math.imul(g,At)|0,U=U+Math.imul(g,Ut)|0,P=P+Math.imul(u,zt)|0,l=l+Math.imul(u,Et)|0,l=l+Math.imul(B,zt)|0,U=U+Math.imul(B,Et)|0,P=P+Math.imul(R,Rt)|0,l=l+Math.imul(R,Gt)|0,l=l+Math.imul(V,Rt)|0,U=U+Math.imul(V,Gt)|0,P=P+Math.imul(b,Ot)|0,l=l+Math.imul(b,Vt)|0,l=l+Math.imul(w,Ot)|0,U=U+Math.imul(w,Vt)|0,P=P+Math.imul($,qt)|0,l=l+Math.imul($,mt)|0,l=l+Math.imul(A,qt)|0,U=U+Math.imul(A,mt)|0;var rn=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(rn>>>26)|0,rn&=67108863,P=Math.imul(nt,Bt),l=Math.imul(nt,Pt),l=l+Math.imul(it,Bt)|0,U=Math.imul(it,Pt),P=P+Math.imul(J,Dt)|0,l=l+Math.imul(J,Ft)|0,l=l+Math.imul(j,Dt)|0,U=U+Math.imul(j,Ft)|0,P=P+Math.imul(L,At)|0,l=l+Math.imul(L,Ut)|0,l=l+Math.imul(z,At)|0,U=U+Math.imul(z,Ut)|0,P=P+Math.imul(y,zt)|0,l=l+Math.imul(y,Et)|0,l=l+Math.imul(g,zt)|0,U=U+Math.imul(g,Et)|0,P=P+Math.imul(u,Rt)|0,l=l+Math.imul(u,Gt)|0,l=l+Math.imul(B,Rt)|0,U=U+Math.imul(B,Gt)|0,P=P+Math.imul(R,Ot)|0,l=l+Math.imul(R,Vt)|0,l=l+Math.imul(V,Ot)|0,U=U+Math.imul(V,Vt)|0,P=P+Math.imul(b,qt)|0,l=l+Math.imul(b,mt)|0,l=l+Math.imul(w,qt)|0,U=U+Math.imul(w,mt)|0;var nn=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(nn>>>26)|0,nn&=67108863,P=Math.imul(nt,Dt),l=Math.imul(nt,Ft),l=l+Math.imul(it,Dt)|0,U=Math.imul(it,Ft),P=P+Math.imul(J,At)|0,l=l+Math.imul(J,Ut)|0,l=l+Math.imul(j,At)|0,U=U+Math.imul(j,Ut)|0,P=P+Math.imul(L,zt)|0,l=l+Math.imul(L,Et)|0,l=l+Math.imul(z,zt)|0,U=U+Math.imul(z,Et)|0,P=P+Math.imul(y,Rt)|0,l=l+Math.imul(y,Gt)|0,l=l+Math.imul(g,Rt)|0,U=U+Math.imul(g,Gt)|0,P=P+Math.imul(u,Ot)|0,l=l+Math.imul(u,Vt)|0,l=l+Math.imul(B,Ot)|0,U=U+Math.imul(B,Vt)|0,P=P+Math.imul(R,qt)|0,l=l+Math.imul(R,mt)|0,l=l+Math.imul(V,qt)|0,U=U+Math.imul(V,mt)|0;var on=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(on>>>26)|0,on&=67108863,P=Math.imul(nt,At),l=Math.imul(nt,Ut),l=l+Math.imul(it,At)|0,U=Math.imul(it,Ut),P=P+Math.imul(J,zt)|0,l=l+Math.imul(J,Et)|0,l=l+Math.imul(j,zt)|0,U=U+Math.imul(j,Et)|0,P=P+Math.imul(L,Rt)|0,l=l+Math.imul(L,Gt)|0,l=l+Math.imul(z,Rt)|0,U=U+Math.imul(z,Gt)|0,P=P+Math.imul(y,Ot)|0,l=l+Math.imul(y,Vt)|0,l=l+Math.imul(g,Ot)|0,U=U+Math.imul(g,Vt)|0,P=P+Math.imul(u,qt)|0,l=l+Math.imul(u,mt)|0,l=l+Math.imul(B,qt)|0,U=U+Math.imul(B,mt)|0;var an=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(an>>>26)|0,an&=67108863,P=Math.imul(nt,zt),l=Math.imul(nt,Et),l=l+Math.imul(it,zt)|0,U=Math.imul(it,Et),P=P+Math.imul(J,Rt)|0,l=l+Math.imul(J,Gt)|0,l=l+Math.imul(j,Rt)|0,U=U+Math.imul(j,Gt)|0,P=P+Math.imul(L,Ot)|0,l=l+Math.imul(L,Vt)|0,l=l+Math.imul(z,Ot)|0,U=U+Math.imul(z,Vt)|0,P=P+Math.imul(y,qt)|0,l=l+Math.imul(y,mt)|0,l=l+Math.imul(g,qt)|0,U=U+Math.imul(g,mt)|0;var sn=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(sn>>>26)|0,sn&=67108863,P=Math.imul(nt,Rt),l=Math.imul(nt,Gt),l=l+Math.imul(it,Rt)|0,U=Math.imul(it,Gt),P=P+Math.imul(J,Ot)|0,l=l+Math.imul(J,Vt)|0,l=l+Math.imul(j,Ot)|0,U=U+Math.imul(j,Vt)|0,P=P+Math.imul(L,qt)|0,l=l+Math.imul(L,mt)|0,l=l+Math.imul(z,qt)|0,U=U+Math.imul(z,mt)|0;var un=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(un>>>26)|0,un&=67108863,P=Math.imul(nt,Ot),l=Math.imul(nt,Vt),l=l+Math.imul(it,Ot)|0,U=Math.imul(it,Vt),P=P+Math.imul(J,qt)|0,l=l+Math.imul(J,mt)|0,l=l+Math.imul(j,qt)|0,U=U+Math.imul(j,mt)|0;var fn=(O+P|0)+((l&8191)<<13)|0;O=(U+(l>>>13)|0)+(fn>>>26)|0,fn&=67108863,P=Math.imul(nt,qt),l=Math.imul(nt,mt),l=l+Math.imul(it,qt)|0,U=Math.imul(it,mt);var cn=(O+P|0)+((l&8191)<<13)|0;return O=(U+(l>>>13)|0)+(cn>>>26)|0,cn&=67108863,I[0]=Ve,I[1]=qe,I[2]=Ne,I[3]=Zt,I[4]=Wr,I[5]=Kr,I[6]=Qr,I[7]=Jr,I[8]=jr,I[9]=tn,I[10]=en,I[11]=rn,I[12]=nn,I[13]=on,I[14]=an,I[15]=sn,I[16]=un,I[17]=fn,I[18]=cn,O!==0&&(I[19]=O,_.length++),_};Math.imul||(G=m);function q(F,s,p){p.negative=s.negative^F.negative,p.length=F.length+s.length;for(var _=0,M=0,T=0;T<p.length-1;T++){var I=M;M=0;for(var O=_&67108863,P=Math.min(T,s.length-1),l=Math.max(0,T-F.length+1);l<=P;l++){var U=T-l,ot=F.words[U]|0,at=s.words[l]|0,ut=ot*at,ft=ut&67108863;I=I+(ut/67108864|0)|0,ft=ft+O|0,O=ft&67108863,I=I+(ft>>>26)|0,M+=I>>>26,I&=67108863}p.words[T]=O,_=I,I=M}return _!==0?p.words[T]=_:p.length--,p.strip()}function N(F,s,p){var _=new Y;return _.mulp(F,s,p)}i.prototype.mulTo=function(s,p){var _,M=this.length+s.length;return this.length===10&&s.length===10?_=G(this,s,p):M<63?_=m(this,s,p):M<1024?_=q(this,s,p):_=N(this,s,p),_};function Y(F,s){this.x=F,this.y=s}Y.prototype.makeRBT=function(s){for(var p=new Array(s),_=i.prototype._countBits(s)-1,M=0;M<s;M++)p[M]=this.revBin(M,_,s);return p},Y.prototype.revBin=function(s,p,_){if(s===0||s===_-1)return s;for(var M=0,T=0;T<p;T++)M|=(s&1)<<p-T-1,s>>=1;return M},Y.prototype.permute=function(s,p,_,M,T,I){for(var O=0;O<I;O++)M[O]=p[s[O]],T[O]=_[s[O]]},Y.prototype.transform=function(s,p,_,M,T,I){this.permute(I,s,p,_,M,T);for(var O=1;O<T;O<<=1)for(var P=O<<1,l=Math.cos(2*Math.PI/P),U=Math.sin(2*Math.PI/P),ot=0;ot<T;ot+=P)for(var at=l,ut=U,ft=0;ft<O;ft++){var yt=_[ot+ft],vt=M[ot+ft],k=_[ot+ft+O],$=M[ot+ft+O],A=at*k-ut*$;$=at*$+ut*k,k=A,_[ot+ft]=yt+k,M[ot+ft]=vt+$,_[ot+ft+O]=yt-k,M[ot+ft+O]=vt-$,ft!==P&&(A=l*at-U*ut,ut=l*ut+U*at,at=A)}},Y.prototype.guessLen13b=function(s,p){var _=Math.max(p,s)|1,M=_&1,T=0;for(_=_/2|0;_;_=_>>>1)T++;return 1<<T+1+M},Y.prototype.conjugate=function(s,p,_){if(!(_<=1))for(var M=0;M<_/2;M++){var T=s[M];s[M]=s[_-M-1],s[_-M-1]=T,T=p[M],p[M]=-p[_-M-1],p[_-M-1]=-T}},Y.prototype.normalize13b=function(s,p){for(var _=0,M=0;M<p/2;M++){var T=Math.round(s[2*M+1]/p)*8192+Math.round(s[2*M]/p)+_;s[M]=T&67108863,T<67108864?_=0:_=T/67108864|0}return s},Y.prototype.convert13b=function(s,p,_,M){for(var T=0,I=0;I<p;I++)T=T+(s[I]|0),_[2*I]=T&8191,T=T>>>13,_[2*I+1]=T&8191,T=T>>>13;for(I=2*p;I<M;++I)_[I]=0;n(T===0),n((T&-8192)===0)},Y.prototype.stub=function(s){for(var p=new Array(s),_=0;_<s;_++)p[_]=0;return p},Y.prototype.mulp=function(s,p,_){var M=2*this.guessLen13b(s.length,p.length),T=this.makeRBT(M),I=this.stub(M),O=new Array(M),P=new Array(M),l=new Array(M),U=new Array(M),ot=new Array(M),at=new Array(M),ut=_.words;ut.length=M,this.convert13b(s.words,s.length,O,M),this.convert13b(p.words,p.length,U,M),this.transform(O,I,P,l,M,T),this.transform(U,I,ot,at,M,T);for(var ft=0;ft<M;ft++){var yt=P[ft]*ot[ft]-l[ft]*at[ft];l[ft]=P[ft]*at[ft]+l[ft]*ot[ft],P[ft]=yt}return this.conjugate(P,l,M),this.transform(P,l,ut,I,M,T),this.conjugate(ut,I,M),this.normalize13b(ut,M),_.negative=s.negative^p.negative,_.length=s.length+p.length,_.strip()},i.prototype.mul=function(s){var p=new i(null);return p.words=new Array(this.length+s.length),this.mulTo(s,p)},i.prototype.mulf=function(s){var p=new i(null);return p.words=new Array(this.length+s.length),N(this,s,p)},i.prototype.imul=function(s){return this.clone().mulTo(s,this)},i.prototype.imuln=function(s){n(typeof s=="number"),n(s<67108864);for(var p=0,_=0;_<this.length;_++){var M=(this.words[_]|0)*s,T=(M&67108863)+(p&67108863);p>>=26,p+=M/67108864|0,p+=T>>>26,this.words[_]=T&67108863}return p!==0&&(this.words[_]=p,this.length++),this.length=s===0?1:this.length,this},i.prototype.muln=function(s){return this.clone().imuln(s)},i.prototype.sqr=function(){return this.mul(this)},i.prototype.isqr=function(){return this.imul(this.clone())},i.prototype.pow=function(s){var p=X(s);if(p.length===0)return new i(1);for(var _=this,M=0;M<p.length&&p[M]===0;M++,_=_.sqr());if(++M<p.length)for(var T=_.sqr();M<p.length;M++,T=T.sqr())p[M]!==0&&(_=_.mul(T));return _},i.prototype.iushln=function(s){n(typeof s=="number"&&s>=0);var p=s%26,_=(s-p)/26,M=67108863>>>26-p<<26-p,T;if(p!==0){var I=0;for(T=0;T<this.length;T++){var O=this.words[T]&M,P=(this.words[T]|0)-O<<p;this.words[T]=P|I,I=O>>>26-p}I&&(this.words[T]=I,this.length++)}if(_!==0){for(T=this.length-1;T>=0;T--)this.words[T+_]=this.words[T];for(T=0;T<_;T++)this.words[T]=0;this.length+=_}return this.strip()},i.prototype.ishln=function(s){return n(this.negative===0),this.iushln(s)},i.prototype.iushrn=function(s,p,_){n(typeof s=="number"&&s>=0);var M;p?M=(p-p%26)/26:M=0;var T=s%26,I=Math.min((s-T)/26,this.length),O=67108863^67108863>>>T<<T,P=_;if(M-=I,M=Math.max(0,M),P){for(var l=0;l<I;l++)P.words[l]=this.words[l];P.length=I}if(I!==0)if(this.length>I)for(this.length-=I,l=0;l<this.length;l++)this.words[l]=this.words[l+I];else this.words[0]=0,this.length=1;var U=0;for(l=this.length-1;l>=0&&(U!==0||l>=M);l--){var ot=this.words[l]|0;this.words[l]=U<<26-T|ot>>>T,U=ot&O}return P&&U!==0&&(P.words[P.length++]=U),this.length===0&&(this.words[0]=0,this.length=1),this.strip()},i.prototype.ishrn=function(s,p,_){return n(this.negative===0),this.iushrn(s,p,_)},i.prototype.shln=function(s){return this.clone().ishln(s)},i.prototype.ushln=function(s){return this.clone().iushln(s)},i.prototype.shrn=function(s){return this.clone().ishrn(s)},i.prototype.ushrn=function(s){return this.clone().iushrn(s)},i.prototype.testn=function(s){n(typeof s=="number"&&s>=0);var p=s%26,_=(s-p)/26,M=1<<p;if(this.length<=_)return!1;var T=this.words[_];return!!(T&M)},i.prototype.imaskn=function(s){n(typeof s=="number"&&s>=0);var p=s%26,_=(s-p)/26;if(n(this.negative===0,"imaskn works only with positive numbers"),this.length<=_)return this;if(p!==0&&_++,this.length=Math.min(_,this.length),p!==0){var M=67108863^67108863>>>p<<p;this.words[this.length-1]&=M}return this.strip()},i.prototype.maskn=function(s){return this.clone().imaskn(s)},i.prototype.iaddn=function(s){return n(typeof s=="number"),n(s<67108864),s<0?this.isubn(-s):this.negative!==0?this.length===1&&(this.words[0]|0)<s?(this.words[0]=s-(this.words[0]|0),this.negative=0,this):(this.negative=0,this.isubn(s),this.negative=1,this):this._iaddn(s)},i.prototype._iaddn=function(s){this.words[0]+=s;for(var p=0;p<this.length&&this.words[p]>=67108864;p++)this.words[p]-=67108864,p===this.length-1?this.words[p+1]=1:this.words[p+1]++;return this.length=Math.max(this.length,p+1),this},i.prototype.isubn=function(s){if(n(typeof s=="number"),n(s<67108864),s<0)return this.iaddn(-s);if(this.negative!==0)return this.negative=0,this.iaddn(s),this.negative=1,this;if(this.words[0]-=s,this.length===1&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var p=0;p<this.length&&this.words[p]<0;p++)this.words[p]+=67108864,this.words[p+1]-=1;return this.strip()},i.prototype.addn=function(s){return this.clone().iaddn(s)},i.prototype.subn=function(s){return this.clone().isubn(s)},i.prototype.iabs=function(){return this.negative=0,this},i.prototype.abs=function(){return this.clone().iabs()},i.prototype._ishlnsubmul=function(s,p,_){var M=s.length+_,T;this._expand(M);var I,O=0;for(T=0;T<s.length;T++){I=(this.words[T+_]|0)+O;var P=(s.words[T]|0)*p;I-=P&67108863,O=(I>>26)-(P/67108864|0),this.words[T+_]=I&67108863}for(;T<this.length-_;T++)I=(this.words[T+_]|0)+O,O=I>>26,this.words[T+_]=I&67108863;if(O===0)return this.strip();for(n(O===-1),O=0,T=0;T<this.length;T++)I=-(this.words[T]|0)+O,O=I>>26,this.words[T]=I&67108863;return this.negative=1,this.strip()},i.prototype._wordDiv=function(s,p){var _=this.length-s.length,M=this.clone(),T=s,I=T.words[T.length-1]|0,O=this._countBits(I);_=26-O,_!==0&&(T=T.ushln(_),M.iushln(_),I=T.words[T.length-1]|0);var P=M.length-T.length,l;if(p!=="mod"){l=new i(null),l.length=P+1,l.words=new Array(l.length);for(var U=0;U<l.length;U++)l.words[U]=0}var ot=M.clone()._ishlnsubmul(T,1,P);ot.negative===0&&(M=ot,l&&(l.words[P]=1));for(var at=P-1;at>=0;at--){var ut=(M.words[T.length+at]|0)*67108864+(M.words[T.length+at-1]|0);for(ut=Math.min(ut/I|0,67108863),M._ishlnsubmul(T,ut,at);M.negative!==0;)ut--,M.negative=0,M._ishlnsubmul(T,1,at),M.isZero()||(M.negative^=1);l&&(l.words[at]=ut)}return l&&l.strip(),M.strip(),p!=="div"&&_!==0&&M.iushrn(_),{div:l||null,mod:M}},i.prototype.divmod=function(s,p,_){if(n(!s.isZero()),this.isZero())return{div:new i(0),mod:new i(0)};var M,T,I;return this.negative!==0&&s.negative===0?(I=this.neg().divmod(s,p),p!=="mod"&&(M=I.div.neg()),p!=="div"&&(T=I.mod.neg(),_&&T.negative!==0&&T.iadd(s)),{div:M,mod:T}):this.negative===0&&s.negative!==0?(I=this.divmod(s.neg(),p),p!=="mod"&&(M=I.div.neg()),{div:M,mod:I.mod}):(this.negative&s.negative)!==0?(I=this.neg().divmod(s.neg(),p),p!=="div"&&(T=I.mod.neg(),_&&T.negative!==0&&T.isub(s)),{div:I.div,mod:T}):s.length>this.length||this.cmp(s)<0?{div:new i(0),mod:this}:s.length===1?p==="div"?{div:this.divn(s.words[0]),mod:null}:p==="mod"?{div:null,mod:new i(this.modn(s.words[0]))}:{div:this.divn(s.words[0]),mod:new i(this.modn(s.words[0]))}:this._wordDiv(s,p)},i.prototype.div=function(s){return this.divmod(s,"div",!1).div},i.prototype.mod=function(s){return this.divmod(s,"mod",!1).mod},i.prototype.umod=function(s){return this.divmod(s,"mod",!0).mod},i.prototype.divRound=function(s){var p=this.divmod(s);if(p.mod.isZero())return p.div;var _=p.div.negative!==0?p.mod.isub(s):p.mod,M=s.ushrn(1),T=s.andln(1),I=_.cmp(M);return I<0||T===1&&I===0?p.div:p.div.negative!==0?p.div.isubn(1):p.div.iaddn(1)},i.prototype.modn=function(s){n(s<=67108863);for(var p=(1<<26)%s,_=0,M=this.length-1;M>=0;M--)_=(p*_+(this.words[M]|0))%s;return _},i.prototype.idivn=function(s){n(s<=67108863);for(var p=0,_=this.length-1;_>=0;_--){var M=(this.words[_]|0)+p*67108864;this.words[_]=M/s|0,p=M%s}return this.strip()},i.prototype.divn=function(s){return this.clone().idivn(s)},i.prototype.egcd=function(s){n(s.negative===0),n(!s.isZero());var p=this,_=s.clone();p.negative!==0?p=p.umod(s):p=p.clone();for(var M=new i(1),T=new i(0),I=new i(0),O=new i(1),P=0;p.isEven()&&_.isEven();)p.iushrn(1),_.iushrn(1),++P;for(var l=_.clone(),U=p.clone();!p.isZero();){for(var ot=0,at=1;(p.words[0]&at)===0&&ot<26;++ot,at<<=1);if(ot>0)for(p.iushrn(ot);ot-- >0;)(M.isOdd()||T.isOdd())&&(M.iadd(l),T.isub(U)),M.iushrn(1),T.iushrn(1);for(var ut=0,ft=1;(_.words[0]&ft)===0&&ut<26;++ut,ft<<=1);if(ut>0)for(_.iushrn(ut);ut-- >0;)(I.isOdd()||O.isOdd())&&(I.iadd(l),O.isub(U)),I.iushrn(1),O.iushrn(1);p.cmp(_)>=0?(p.isub(_),M.isub(I),T.isub(O)):(_.isub(p),I.isub(M),O.isub(T))}return{a:I,b:O,gcd:_.iushln(P)}},i.prototype._invmp=function(s){n(s.negative===0),n(!s.isZero());var p=this,_=s.clone();p.negative!==0?p=p.umod(s):p=p.clone();for(var M=new i(1),T=new i(0),I=_.clone();p.cmpn(1)>0&&_.cmpn(1)>0;){for(var O=0,P=1;(p.words[0]&P)===0&&O<26;++O,P<<=1);if(O>0)for(p.iushrn(O);O-- >0;)M.isOdd()&&M.iadd(I),M.iushrn(1);for(var l=0,U=1;(_.words[0]&U)===0&&l<26;++l,U<<=1);if(l>0)for(_.iushrn(l);l-- >0;)T.isOdd()&&T.iadd(I),T.iushrn(1);p.cmp(_)>=0?(p.isub(_),M.isub(T)):(_.isub(p),T.isub(M))}var ot;return p.cmpn(1)===0?ot=M:ot=T,ot.cmpn(0)<0&&ot.iadd(s),ot},i.prototype.gcd=function(s){if(this.isZero())return s.abs();if(s.isZero())return this.abs();var p=this.clone(),_=s.clone();p.negative=0,_.negative=0;for(var M=0;p.isEven()&&_.isEven();M++)p.iushrn(1),_.iushrn(1);do{for(;p.isEven();)p.iushrn(1);for(;_.isEven();)_.iushrn(1);var T=p.cmp(_);if(T<0){var I=p;p=_,_=I}else if(T===0||_.cmpn(1)===0)break;p.isub(_)}while(!0);return _.iushln(M)},i.prototype.invm=function(s){return this.egcd(s).a.umod(s)},i.prototype.isEven=function(){return(this.words[0]&1)===0},i.prototype.isOdd=function(){return(this.words[0]&1)===1},i.prototype.andln=function(s){return this.words[0]&s},i.prototype.bincn=function(s){n(typeof s=="number");var p=s%26,_=(s-p)/26,M=1<<p;if(this.length<=_)return this._expand(_+1),this.words[_]|=M,this;for(var T=M,I=_;T!==0&&I<this.length;I++){var O=this.words[I]|0;O+=T,T=O>>>26,O&=67108863,this.words[I]=O}return T!==0&&(this.words[I]=T,this.length++),this},i.prototype.isZero=function(){return this.length===1&&this.words[0]===0},i.prototype.cmpn=function(s){var p=s<0;if(this.negative!==0&&!p)return-1;if(this.negative===0&&p)return 1;this.strip();var _;if(this.length>1)_=1;else{p&&(s=-s),n(s<=67108863,"Number is too big");var M=this.words[0]|0;_=M===s?0:M<s?-1:1}return this.negative!==0?-_|0:_},i.prototype.cmp=function(s){if(this.negative!==0&&s.negative===0)return-1;if(this.negative===0&&s.negative!==0)return 1;var p=this.ucmp(s);return this.negative!==0?-p|0:p},i.prototype.ucmp=function(s){if(this.length>s.length)return 1;if(this.length<s.length)return-1;for(var p=0,_=this.length-1;_>=0;_--){var M=this.words[_]|0,T=s.words[_]|0;if(M!==T){M<T?p=-1:M>T&&(p=1);break}}return p},i.prototype.gtn=function(s){return this.cmpn(s)===1},i.prototype.gt=function(s){return this.cmp(s)===1},i.prototype.gten=function(s){return this.cmpn(s)>=0},i.prototype.gte=function(s){return this.cmp(s)>=0},i.prototype.ltn=function(s){return this.cmpn(s)===-1},i.prototype.lt=function(s){return this.cmp(s)===-1},i.prototype.lten=function(s){return this.cmpn(s)<=0},i.prototype.lte=function(s){return this.cmp(s)<=0},i.prototype.eqn=function(s){return this.cmpn(s)===0},i.prototype.eq=function(s){return this.cmp(s)===0},i.red=function(s){return new et(s)},i.prototype.toRed=function(s){return n(!this.red,"Already a number in reduction context"),n(this.negative===0,"red works only with positives"),s.convertTo(this)._forceRed(s)},i.prototype.fromRed=function(){return n(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},i.prototype._forceRed=function(s){return this.red=s,this},i.prototype.forceRed=function(s){return n(!this.red,"Already a number in reduction context"),this._forceRed(s)},i.prototype.redAdd=function(s){return n(this.red,"redAdd works only with red numbers"),this.red.add(this,s)},i.prototype.redIAdd=function(s){return n(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,s)},i.prototype.redSub=function(s){return n(this.red,"redSub works only with red numbers"),this.red.sub(this,s)},i.prototype.redISub=function(s){return n(this.red,"redISub works only with red numbers"),this.red.isub(this,s)},i.prototype.redShl=function(s){return n(this.red,"redShl works only with red numbers"),this.red.shl(this,s)},i.prototype.redMul=function(s){return n(this.red,"redMul works only with red numbers"),this.red._verify2(this,s),this.red.mul(this,s)},i.prototype.redIMul=function(s){return n(this.red,"redMul works only with red numbers"),this.red._verify2(this,s),this.red.imul(this,s)},i.prototype.redSqr=function(){return n(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},i.prototype.redISqr=function(){return n(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},i.prototype.redSqrt=function(){return n(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},i.prototype.redInvm=function(){return n(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},i.prototype.redNeg=function(){return n(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},i.prototype.redPow=function(s){return n(this.red&&!s.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,s)};var K={k256:null,p224:null,p192:null,p25519:null};function Q(F,s){this.name=F,this.p=new i(s,16),this.n=this.p.bitLength(),this.k=new i(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}Q.prototype._tmp=function(){var s=new i(null);return s.words=new Array(Math.ceil(this.n/13)),s},Q.prototype.ireduce=function(s){var p=s,_;do this.split(p,this.tmp),p=this.imulK(p),p=p.iadd(this.tmp),_=p.bitLength();while(_>this.n);var M=_<this.n?-1:p.ucmp(this.p);return M===0?(p.words[0]=0,p.length=1):M>0?p.isub(this.p):p.strip!==void 0?p.strip():p._strip(),p},Q.prototype.split=function(s,p){s.iushrn(this.n,0,p)},Q.prototype.imulK=function(s){return s.imul(this.k)};function tt(){Q.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}r(tt,Q),tt.prototype.split=function(s,p){for(var _=4194303,M=Math.min(s.length,9),T=0;T<M;T++)p.words[T]=s.words[T];if(p.length=M,s.length<=9){s.words[0]=0,s.length=1;return}var I=s.words[9];for(p.words[p.length++]=I&_,T=10;T<s.length;T++){var O=s.words[T]|0;s.words[T-10]=(O&_)<<4|I>>>22,I=O}I>>>=22,s.words[T-10]=I,I===0&&s.length>10?s.length-=10:s.length-=9},tt.prototype.imulK=function(s){s.words[s.length]=0,s.words[s.length+1]=0,s.length+=2;for(var p=0,_=0;_<s.length;_++){var M=s.words[_]|0;p+=M*977,s.words[_]=p&67108863,p=M*64+(p/67108864|0)}return s.words[s.length-1]===0&&(s.length--,s.words[s.length-1]===0&&s.length--),s};function H(){Q.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}r(H,Q);function W(){Q.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}r(W,Q);function st(){Q.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}r(st,Q),st.prototype.imulK=function(s){for(var p=0,_=0;_<s.length;_++){var M=(s.words[_]|0)*19+p,T=M&67108863;M>>>=26,s.words[_]=T,p=M}return p!==0&&(s.words[s.length++]=p),s},i._prime=function(s){if(K[s])return K[s];var p;if(s==="k256")p=new tt;else if(s==="p224")p=new H;else if(s==="p192")p=new W;else if(s==="p25519")p=new st;else throw new Error("Unknown prime "+s);return K[s]=p,p};function et(F){if(typeof F=="string"){var s=i._prime(F);this.m=s.p,this.prime=s}else n(F.gtn(1),"modulus must be greater than 1"),this.m=F,this.prime=null}et.prototype._verify1=function(s){n(s.negative===0,"red works only with positives"),n(s.red,"red works only with red numbers")},et.prototype._verify2=function(s,p){n((s.negative|p.negative)===0,"red works only with positives"),n(s.red&&s.red===p.red,"red works only with red numbers")},et.prototype.imod=function(s){return this.prime?this.prime.ireduce(s)._forceRed(this):s.umod(this.m)._forceRed(this)},et.prototype.neg=function(s){return s.isZero()?s.clone():this.m.sub(s)._forceRed(this)},et.prototype.add=function(s,p){this._verify2(s,p);var _=s.add(p);return _.cmp(this.m)>=0&&_.isub(this.m),_._forceRed(this)},et.prototype.iadd=function(s,p){this._verify2(s,p);var _=s.iadd(p);return _.cmp(this.m)>=0&&_.isub(this.m),_},et.prototype.sub=function(s,p){this._verify2(s,p);var _=s.sub(p);return _.cmpn(0)<0&&_.iadd(this.m),_._forceRed(this)},et.prototype.isub=function(s,p){this._verify2(s,p);var _=s.isub(p);return _.cmpn(0)<0&&_.iadd(this.m),_},et.prototype.shl=function(s,p){return this._verify1(s),this.imod(s.ushln(p))},et.prototype.imul=function(s,p){return this._verify2(s,p),this.imod(s.imul(p))},et.prototype.mul=function(s,p){return this._verify2(s,p),this.imod(s.mul(p))},et.prototype.isqr=function(s){return this.imul(s,s.clone())},et.prototype.sqr=function(s){return this.mul(s,s)},et.prototype.sqrt=function(s){if(s.isZero())return s.clone();var p=this.m.andln(3);if(n(p%2===1),p===3){var _=this.m.add(new i(1)).iushrn(2);return this.pow(s,_)}for(var M=this.m.subn(1),T=0;!M.isZero()&&M.andln(1)===0;)T++,M.iushrn(1);n(!M.isZero());var I=new i(1).toRed(this),O=I.redNeg(),P=this.m.subn(1).iushrn(1),l=this.m.bitLength();for(l=new i(2*l*l).toRed(this);this.pow(l,P).cmp(O)!==0;)l.redIAdd(O);for(var U=this.pow(l,M),ot=this.pow(s,M.addn(1).iushrn(1)),at=this.pow(s,M),ut=T;at.cmp(I)!==0;){for(var ft=at,yt=0;ft.cmp(I)!==0;yt++)ft=ft.redSqr();n(yt<ut);var vt=this.pow(U,new i(1).iushln(ut-yt-1));ot=ot.redMul(vt),U=vt.redSqr(),at=at.redMul(U),ut=yt}return ot},et.prototype.invm=function(s){var p=s._invmp(this.m);return p.negative!==0?(p.negative=0,this.imod(p).redNeg()):this.imod(p)},et.prototype.pow=function(s,p){if(p.isZero())return new i(1).toRed(this);if(p.cmpn(1)===0)return s.clone();var _=4,M=new Array(1<<_);M[0]=new i(1).toRed(this),M[1]=s;for(var T=2;T<M.length;T++)M[T]=this.mul(M[T-1],s);var I=M[0],O=0,P=0,l=p.bitLength()%26;for(l===0&&(l=26),T=p.length-1;T>=0;T--){for(var U=p.words[T],ot=l-1;ot>=0;ot--){var at=U>>ot&1;if(I!==M[0]&&(I=this.sqr(I)),at===0&&O===0){P=0;continue}O<<=1,O|=at,P++,!(P!==_&&(T!==0||ot!==0))&&(I=this.mul(I,M[O]),P=0,O=0)}l=26}return I},et.prototype.convertTo=function(s){var p=s.umod(this.m);return p===s?p.clone():p},et.prototype.convertFrom=function(s){var p=s.clone();return p.red=null,p},i.mont=function(s){return new rt(s)};function rt(F){et.call(this,F),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new i(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}r(rt,et),rt.prototype.convertTo=function(s){return this.imod(s.ushln(this.shift))},rt.prototype.convertFrom=function(s){var p=this.imod(s.mul(this.rinv));return p.red=null,p},rt.prototype.imul=function(s,p){if(s.isZero()||p.isZero())return s.words[0]=0,s.length=1,s;var _=s.imul(p),M=_.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),T=_.isub(M).iushrn(this.shift),I=T;return T.cmp(this.m)>=0?I=T.isub(this.m):T.cmpn(0)<0&&(I=T.iadd(this.m)),I._forceRed(this)},rt.prototype.mul=function(s,p){if(s.isZero()||p.isZero())return new i(0)._forceRed(this);var _=s.mul(p),M=_.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),T=_.isub(M).iushrn(this.shift),I=T;return T.cmp(this.m)>=0?I=T.isub(this.m):T.cmpn(0)<0&&(I=T.iadd(this.m)),I._forceRed(this)},rt.prototype.invm=function(s){var p=this.imod(s._invmp(this.m).mul(this.r2));return p._forceRed(this)}})(typeof Cn>"u"||Cn,aa)});var Xn=xt((ah,sa)=>{"use strict";var oh=ur();sa.exports=_f;function _f(e){return e&&typeof e=="object"&&!!e.words}});var ca=xt((sh,fa)=>{"use strict";var ua=Xn();fa.exports=Sf;function Sf(e){return Array.isArray(e)&&e.length===2&&ua(e[0])&&ua(e[1])}});var Cr=xt((uh,kt)=>{var kn=!1;if(typeof Float64Array<"u")if(le=new Float64Array(1),re=new Uint32Array(le.buffer),le[0]=1,kn=!0,re[1]===1072693248){let e=function(r,i){return re[0]=r,re[1]=i,le[0]},t=function(r){return le[0]=r,re[0]},n=function(r){return le[0]=r,re[1]};Tf=e,Bf=t,Pf=n,kt.exports=function(i){return le[0]=i,[re[0],re[1]]},kt.exports.pack=e,kt.exports.lo=t,kt.exports.hi=n}else if(re[0]===1072693248){let e=function(r,i){return re[1]=r,re[0]=i,le[0]},t=function(r){return le[0]=r,re[1]},n=function(r){return le[0]=r,re[0]};Df=e,Ff=t,Af=n,kt.exports=function(i){return le[0]=i,[re[1],re[0]]},kt.exports.pack=e,kt.exports.lo=t,kt.exports.hi=n}else kn=!1;var le,re,Tf,Bf,Pf,Df,Ff,Af;if(!kn){let e=function(r,i){return he.writeUInt32LE(r,0,!0),he.writeUInt32LE(i,4,!0),he.readDoubleLE(0,!0)},t=function(r){return he.writeDoubleLE(r,0,!0),he.readUInt32LE(0,!0)},n=function(r){return he.writeDoubleLE(r,0,!0),he.readUInt32LE(4,!0)};Uf=e,zf=t,Ef=n,he=new Buffer(8),kt.exports=function(i){return he.writeDoubleLE(i,0,!0),[he.readUInt32LE(0,!0),he.readUInt32LE(4,!0)]},kt.exports.pack=e,kt.exports.lo=t,kt.exports.hi=n}var he,Uf,zf,Ef;kt.exports.sign=function(e){return kt.exports.hi(e)>>>31};kt.exports.exponent=function(e){var t=kt.exports.hi(e);return(t<<1>>>21)-1023};kt.exports.fraction=function(e){var t=kt.exports.lo(e),n=kt.exports.hi(e),r=n&(1<<20)-1;return n&2146435072&&(r+=1<<20),[t,r]};kt.exports.denormalized=function(e){var t=kt.exports.hi(e);return!(t&2146435072)}});var Yn=xt((fh,ha)=>{"use strict";var la=ur(),If=Cr();ha.exports=Lf;function Lf(e){var t=If.exponent(e);return t<52?new la(e):new la(e*Math.pow(2,52-t)).ushln(t-52)}});var pa=xt((ch,va)=>{"use strict";var Rf=ur();va.exports=Gf;function Gf(e){return new Rf(e)}});var Xr=xt((lh,ga)=>{"use strict";var Of=ur();ga.exports=Vf;function Vf(e){return e.cmp(new Of(0))}});var Qe=xt((hh,wa)=>{"use strict";var kr=Yn(),da=Xr();wa.exports=qf;function qf(e,t){var n=da(e),r=da(t);if(n===0)return[kr(0),kr(1)];if(r===0)return[kr(0),kr(0)];r<0&&(e=e.neg(),t=t.neg());var i=e.gcd(t);return i.cmpn(1)?[e.div(i),t.div(i)]:[e,t]}});var Hn=xt((vh,xa)=>{"use strict";var Nf=Qe();xa.exports=mf;function mf(e,t){return Nf(e[0].mul(t[1]),e[1].mul(t[0]))}});var Yr=xt((ph,Sa)=>{"use strict";var ya=ca(),Ma=Xn(),Le=Yn(),ba=pa(),Cf=Qe(),Xf=Hn();Sa.exports=_a;function _a(e,t){if(ya(e))return t?Xf(e,_a(t)):[e[0].clone(),e[1].clone()];var n=0,r,i;if(Ma(e))r=e.clone();else if(typeof e=="string")r=ba(e);else{if(e===0)return[Le(0),Le(1)];if(e===Math.floor(e))r=Le(e);else{for(;e!==Math.floor(e);)e=e*Math.pow(2,256),n-=256;r=Le(e)}}if(ya(t))r.mul(t[1]),i=t[0].clone();else if(Ma(t))i=t.clone();else if(typeof t=="string")i=ba(t);else if(!t)i=Le(1);else if(t===Math.floor(t))i=Le(t);else{for(;t!==Math.floor(t);)t=t*Math.pow(2,256),n+=256;i=Le(t)}return n>0?r=r.ushln(n):n<0&&(i=i.ushln(-n)),Cf(r,i)}});var Ba=xt((gh,Ta)=>{"use strict";Ta.exports=kf;function kf(e,t){return e[0].mul(t[1]).cmp(t[0].mul(e[1]))}});var Da=xt((dh,Pa)=>{"use strict";var Yf=Xr();Pa.exports=Hf;function Hf(e){var t=e.length,n=e.words,r=0;if(t===1)r=n[0];else if(t===2)r=n[0]+n[1]*67108864;else for(var i=0;i<t;i++){var o=n[i];r+=o*Math.pow(67108864,i)}return Yf(e)*r}});var za=xt((wh,Ua)=>{"use strict";var Fa=Cr(),Aa=rr().countTrailingZeros;Ua.exports=Zf;function Zf(e){var t=Aa(Fa.lo(e));if(t<32)return t;var n=Aa(Fa.hi(e));return n>20?52:n+32}});var Ia=xt((xh,Ea)=>{"use strict";var Zn=Da(),$f=za();Ea.exports=Wf;function Wf(e){var t=e[0],n=e[1];if(t.cmpn(0)===0)return 0;var r=t.abs().divmod(n.abs()),i=r.div,o=Zn(i),a=r.mod,f=t.negative!==n.negative?-1:1;if(a.cmpn(0)===0)return f*o;if(o){var h=$f(o)+4,v=Zn(a.ushln(h).divRound(n));return f*(o+v*Math.pow(2,-h))}else{var d=n.bitLength()-a.bitLength()+53,v=Zn(a.ushln(d).divRound(n));return d<1023?f*v*Math.pow(2,-d):(v*=Math.pow(2,-1023),f*v*Math.pow(2,1023-d))}}});var Ra=xt((yh,La)=>{"use strict";La.exports=Qf;var Kf=Yr();function Qf(e){for(var t=new Array(e.length),n=0;n<e.length;++n)t[n]=Kf(e[n]);return t}});var qa=xt((Mh,Va)=>{"use strict";var $n=Cr(),Ga=Math.pow(2,-1074),Oa=-1>>>0;Va.exports=Jf;function Jf(e,t){if(isNaN(e)||isNaN(t))return NaN;if(e===t)return e;if(e===0)return t<0?-Ga:Ga;var n=$n.hi(e),r=$n.lo(e);return t>e==e>0?r===Oa?(n+=1,r=0):r+=1:r===0?(r=Oa,n-=1):r-=1,$n.pack(r,n)}});var Wn=xt((bh,Na)=>{"use strict";var jf=Qe();Na.exports=tc;function tc(e,t){return jf(e[0].mul(t[0]),e[1].mul(t[1]))}});var Kn=xt((_h,ma)=>{"use strict";var ec=Qe();ma.exports=rc;function rc(e,t){return ec(e[0].mul(t[1]).sub(e[1].mul(t[0])),e[1].mul(t[1]))}});var ka=xt((Sh,Xa)=>{"use strict";var Ca=Xr();Xa.exports=nc;function nc(e){return Ca(e[0])*Ca(e[1])}});var Ha=xt((Th,Ya)=>{"use strict";var ic=Kn();Ya.exports=oc;function oc(e,t){for(var n=e.length,r=new Array(n),i=0;i<n;++i)r[i]=ic(e[i],t[i]);return r}});var $a=xt((Bh,Za)=>{"use strict";var ac=Qe();Za.exports=sc;function sc(e,t){return ac(e[0].mul(t[1]).add(t[0].mul(e[1])),e[1].mul(t[1]))}});var Ka=xt((Ph,Wa)=>{"use strict";var uc=$a();Wa.exports=fc;function fc(e,t){for(var n=e.length,r=new Array(n),i=0;i<n;++i)r[i]=uc(e[i],t[i]);return r}});var Ja=xt((Dh,Qa)=>{"use strict";var cc=Yr(),lc=Wn();Qa.exports=hc;function hc(e,t){for(var n=cc(t),r=e.length,i=new Array(r),o=0;o<r;++o)i[o]=lc(e[o],n);return i}});var rs=xt((Fh,es)=>{"use strict";es.exports=xc;var ja=Wn(),vc=Hn(),pc=Kn(),gc=ka(),Qn=Ha(),dc=Ka(),wc=Ja();function ts(e,t){return pc(ja(e[0],t[1]),ja(e[1],t[0]))}function xc(e,t,n,r){var i=Qn(t,e),o=Qn(r,n),a=ts(i,o);if(gc(a)===0)return null;var f=Qn(e,n),h=ts(o,f),v=vc(h,a),d=wc(i,v),D=dc(e,d);return D}});var ls=xt((Ah,cs)=>{"use strict";cs.exports=Ac;var yc=vo(),jn=ra(),as=ia(),ns=Yr(),is=Ba(),Jn=Ia(),Hr=Ra(),oe=qa(),Mc=rs();function os(e){var t=Jn(e);return[oe(t,-1/0),oe(t,1/0)]}function bc(e,t){for(var n=new Array(t.length),r=0;r<t.length;++r){var i=t[r],o=e[i[0]],a=e[i[1]];n[r]=[oe(Math.min(o[0],a[0]),-1/0),oe(Math.min(o[1],a[1]),-1/0),oe(Math.max(o[0],a[0]),1/0),oe(Math.max(o[1],a[1]),1/0)]}return n}function ss(e){for(var t=new Array(e.length),n=0;n<e.length;++n){var r=e[n];t[n]=[oe(r[0],-1/0),oe(r[1],-1/0),oe(r[0],1/0),oe(r[1],1/0)]}return t}function _c(e,t,n){var r=[];return jn(n,function(i,o){var a=t[i],f=t[o];if(!(a[0]===f[0]||a[0]===f[1]||a[1]===f[0]||a[1]===f[1])){var h=e[a[0]],v=e[a[1]],d=e[f[0]],D=e[f[1]];as(h,v,d,D)&&r.push([i,o])}}),r}function Sc(e,t,n,r){var i=[];return jn(n,r,function(o,a){var f=t[o];if(!(f[0]===a||f[1]===a)){var h=e[a],v=e[f[0]],d=e[f[1]];as(v,d,h,h)&&i.push([o,a])}}),i}function Tc(e,t,n,r,i){var o,a,f=e.map(function(et){return[ns(et[0]),ns(et[1])]});for(o=0;o<n.length;++o){var h=n[o];a=h[0];var v=h[1],d=t[a],D=t[v],X=Mc(Hr(e[d[0]]),Hr(e[d[1]]),Hr(e[D[0]]),Hr(e[D[1]]));if(X){var m=e.length;e.push([Jn(X[0]),Jn(X[1])]),f.push(X),r.push([a,m],[v,m])}}for(r.sort(function(et,rt){if(et[0]!==rt[0])return et[0]-rt[0];var F=f[et[1]],s=f[rt[1]];return is(F[0],s[0])||is(F[1],s[1])}),o=r.length-1;o>=0;--o){var G=r[o];a=G[0];var q=t[a],N=q[0],Y=q[1],K=e[N],Q=e[Y];if((K[0]-Q[0]||K[1]-Q[1])<0){var tt=N;N=Y,Y=tt}q[0]=N;var H=q[1]=G[1],W;for(i&&(W=q[2]);o>0&&r[o-1][0]===a;){var G=r[--o],st=G[1];i?t.push([H,st,W]):t.push([H,st]),H=st}i?t.push([H,Y,W]):t.push([H,Y])}return f}function us(e,t,n){for(var r=t.length,i=new yc(r),o=[],a=0;a<t.length;++a){var f=t[a],h=os(f[0]),v=os(f[1]);o.push([oe(h[0],-1/0),oe(v[0],-1/0),oe(h[1],1/0),oe(v[1],1/0)])}jn(o,function(G,q){i.link(G,q)});for(var d=!0,D=new Array(r),a=0;a<r;++a){var X=i.find(a);X!==a&&(d=!1,e[X]=[Math.min(e[a][0],e[X][0]),Math.min(e[a][1],e[X][1])])}if(d)return null;for(var m=0,a=0;a<r;++a){var X=i.find(a);X===a?(D[a]=m,e[m++]=e[a]):D[a]=-1}e.length=m;for(var a=0;a<r;++a)D[a]<0&&(D[a]=D[i.find(a)]);return D}function Bc(e,t){return e[0]-t[0]||e[1]-t[1]}function Pc(e,t){var n=e[0]-t[0]||e[1]-t[1];return n||(e[2]<t[2]?-1:e[2]>t[2]?1:0)}function fs(e,t,n){if(e.length!==0){if(t)for(var r=0;r<e.length;++r){var i=e[r],o=t[i[0]],a=t[i[1]];i[0]=Math.min(o,a),i[1]=Math.max(o,a)}else for(var r=0;r<e.length;++r){var i=e[r],o=i[0],a=i[1];i[0]=Math.min(o,a),i[1]=Math.max(o,a)}n?e.sort(Pc):e.sort(Bc);for(var f=1,r=1;r<e.length;++r){var h=e[r-1],v=e[r];v[0]===h[0]&&v[1]===h[1]&&(!n||v[2]===h[2])||(e[f++]=v)}e.length=f}}function Dc(e,t,n){var r=us(e,[],ss(e));return fs(t,r,n),!!r}function Fc(e,t,n){var r=bc(e,t),i=_c(e,t,r),o=ss(e),a=Sc(e,t,r,o),f=Tc(e,t,i,a,n),h=us(e,f,o);return fs(t,h,n),h?!0:i.length>0||a.length>0}function Ac(e,t,n){var r;if(n){r=t;for(var i=new Array(t.length),o=0;o<t.length;++o){var a=t[o];i[o]=[a[0],a[1],n[o]]}t=i}for(var f=Dc(e,t,!!n);Fc(e,t,!!n);)f=!0;if(n&&f){r.length=0,n.length=0;for(var o=0;o<t.length;++o){var a=t[o];r.push([a[0],a[1]]),n.push(a[2])}}return f}});function ne(e,t,n,r,i,o,a){let f=e.createTexture({label:t,size:{width:n,height:r},format:o,usage:a,mipLevelCount:i,sampleCount:1,dimension:"2d"}),h=f.createView(),v=[];for(let D=0;D<i;D++)v.push(f.createView({label:t,format:o,dimension:"2d",aspect:"all",baseMipLevel:D,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let d=e.createSampler({label:`${t} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:n,height:r},texture:f,view:h,mip_view:v,sampler:d}}function Nt(e){return e.canvas?navigator.gpu?.getPreferredCanvasFormat():e.context.getPreferredFormat()}function ve(e,t,n,r){r=r||Nt(e);let i=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,a=ne(e.device,t,n.width,n.height,1,r,i);e.device.queue.writeTexture({texture:a.texture},n.data,{bytesPerRow:4*n.width},{width:n.width,height:n.height});let f={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return a.sampler=e.device.createSampler(f),a}async function pe(e,t,n,r){let o=await(await fetch(n)).blob();r=r||Nt(e);let a=await createImageBitmap(o),f=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,v=ne(e.device,t,a.width,a.height,1,r,f);e.device.queue.copyExternalImageToTexture({source:a},{texture:v.texture},{width:a.width,height:a.height});let d={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return v.sampler=e.device.createSampler(d),v}var pi="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var ue=7,Ws=0,gi=1,Ks=2,di=3,wi={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(e,t={}){return Qs(e,t)},onRun:function(e,t,n){Js(e,t.data,n)},onDestroy:function(e,t){yi(t)},onResize:function(e,t){js(e,t)},onViewportPosition:function(e,t){}};function Qs(e,t){let{device:n}=e,r=e.viewport.width,i=e.viewport.height,o={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[],buffers:[]},a=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});o.bind_group_layout.push(a),o.bind_groups_textures.push(ne(n,"bloom downsampler image 0",r/2,i/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),o.bind_groups_textures.push(ne(n,"bloom downsampler image 1",r/2,i/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),o.bind_groups_textures.push(t.refs.bloom.data);let f=n.createPipelineLayout({bindGroupLayouts:o.bind_group_layout}),h=n.createComputePipeline({layout:f,compute:{module:n.createShaderModule({code:pi}),entryPoint:"cs_main"}});return xi(e,o,t),o.compute_pipeline=h,o}function xi(e,t,n){let{refs:r}=n,{device:i}=e,o=n.options.bloom_threshold??.1,a=n.options.bloom_knee??.2,f=n.options.bloom_combine_constant??.68,h=new Float32Array([o,o-a,a*2,.25/a,f,0,0,0]),v=i.createBuffer({label:"bloom static parameters buffer",size:h.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});t.buffers.push(v),new Float32Array(v.getMappedRange()).set(h),v.unmap(),t.bind_group.length=0,t.params_buf=v,t.bind_group.push(me(i,t,t.bind_groups_textures[0].mip_view[0],r.emissive.data.view,r.hdr.data.view,r.hdr.data.sampler,v,Ws<<16|0));for(let D=1;D<ue;D++)t.bind_group.push(me(i,t,t.bind_groups_textures[1].mip_view[D],t.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,v,gi<<16|D-1)),t.bind_group.push(me(i,t,t.bind_groups_textures[0].mip_view[D],t.bind_groups_textures[1].view,r.hdr.data.view,r.hdr.data.sampler,v,gi<<16|D));t.bind_group.push(me(i,t,t.bind_groups_textures[2].mip_view[ue-1],t.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,v,Ks<<16|ue-2));let d=!0;for(let D=ue-2;D>=0;D--)d?(t.bind_group.push(me(i,t,t.bind_groups_textures[1].mip_view[D],t.bind_groups_textures[0].view,t.bind_groups_textures[2].view,r.hdr.data.sampler,v,di<<16|D)),d=!1):(t.bind_group.push(me(i,t,t.bind_groups_textures[2].mip_view[D],t.bind_groups_textures[0].view,t.bind_groups_textures[1].view,r.hdr.data.sampler,v,di<<16|D)),d=!0)}function me(e,t,n,r,i,o,a,f){let h=new Uint32Array([f]),v=e.createBuffer({label:"bloom static mode_lod buffer",size:h.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return t.buffers.push(v),new Uint32Array(v.getMappedRange()).set(h),v.unmap(),e.createBindGroup({label:"bloom bind group layout",layout:t.bind_group_layout[0],entries:[{binding:0,resource:n},{binding:1,resource:r},{binding:2,resource:i},{binding:3,resource:o},{binding:4,resource:{buffer:a}},{binding:5,resource:{buffer:v}}]})}function Js(e,t,n){let f=0,h=n.beginComputePass({label:"bloom Compute Pass"});h.setPipeline(t.compute_pipeline),h.setBindGroup(0,t.bind_group[f]),f+=1;let v=lr(0,t.bind_groups_textures[0]);h.dispatchWorkgroups(v.width/8+1,v.height/4+1,1);for(let d=1;d<ue;d++)v=lr(d,t.bind_groups_textures[0]),h.setBindGroup(0,t.bind_group[f]),f+=1,h.dispatchWorkgroups(v.width/8+1,v.height/4+1,1),h.setBindGroup(0,t.bind_group[f]),f+=1,h.dispatchWorkgroups(v.width/8+1,v.height/4+1,1);h.setBindGroup(0,t.bind_group[f]),f+=1,v=lr(ue-1,t.bind_groups_textures[2]),h.dispatchWorkgroups(v.width/8+1,v.height/4+1,1);for(let d=ue-2;d>=0;d--)v=lr(d,t.bind_groups_textures[2]),h.setBindGroup(0,t.bind_group[f]),f+=1,h.dispatchWorkgroups(v.width/8+1,v.height/4+1,1);h.end()}function lr(e,t){let n=t.size.width,r=t.size.height;for(let i=0;i<e;i++)n/=2,r/=2;return{width:n,height:r,depthOrArrayLayers:1}}function js(e,t){let{device:n}=e,r=t.data;yi(t),r.bind_groups_textures.push(ne(n,"bloom downsampler image 0",e.viewport.width/2,e.viewport.height/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(ne(n,"bloom downsampler image 1",e.viewport.width/2,e.viewport.height/2,ue,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(t.refs.bloom.data),xi(e,r,t)}function yi(e){for(let t of e.data.bind_groups_textures)t.texture.destroy();for(let t of e.data.buffers)t.destroy();e.data.buffers.length=0,e.data.bind_groups_textures.length=0}var Mi="struct DisplacementParameters{offset:vec2<f32>,scale:f32,};@group(0)@binding(0)var<uniform> uniforms:DisplacementParameters;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var colorSampler:sampler;@group(0)@binding(3)var noiseTexture:texture_2d<f32>;@group(0)@binding(4)var noiseSampler:sampler;@group(0)@binding(5)var displacementTexture:texture_2d<f32>;struct VertexIn{@builtin(vertex_index)vertexIndex:u32,};struct VertexOut{@builtin(position)position:vec4<f32>,@location(0)uv:vec2<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{const corners=array<vec2<f32>,4>(vec2<f32>(-1,-1),vec2<f32>(1,-1),vec2<f32>(-1,1),vec2<f32>(1,1),);let screenPosition=corners[in.vertexIndex];var out:VertexOut;out.position=vec4<f32>(screenPosition,0,1);out.uv=(0.5+0.5*screenPosition*vec2<f32>(1,-1));return out;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment(in:VertexOut)->FragmentOut{let noiseTextureDimensions=vec2<f32>(textureDimensions(noiseTexture,0));let noiseUv=in.uv+uniforms.offset/noiseTextureDimensions;var noise=textureSample(noiseTexture,noiseSampler,noiseUv).rg;noise-=0.5;noise*=uniforms.scale/noiseTextureDimensions;let displacement=textureSample(displacementTexture,colorSampler,in.uv).r;noise*=displacement;let colorUv=in.uv+noise;var out:FragmentOut;out.color=textureSample(colorTexture,colorSampler,colorUv);return out;}";var hr=class{device;targetFormat;renderPipeline;colorSampler;noiseSampler;displacementParametersBuffer;renderBundle=null;colorTextureView;noiseMapTextureView;displacementTextureView;constructor(t){this.device=t.device,this.targetFormat=t.targetFormat,this.colorTextureView=t.colorTextureView,this.noiseMapTextureView=t.noiseMapTextureView,this.displacementTextureView=t.displacementTextureView,this.displacementParametersBuffer=t.displacementParametersBuffer;let n=this.device.createShaderModule({label:"DisplacementComposition shader module",code:Mi});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementComposition renderpipeline",layout:"auto",vertex:{module:n,entryPoint:"main_vertex"},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:t.targetFormat}]},primitive:{cullMode:"none",topology:"triangle-strip"}}),this.noiseSampler=this.device.createSampler({label:"DisplacementComposition noisesampler",addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),this.colorSampler=this.device.createSampler({label:"DisplacementComposition colorSampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"})}getRenderBundle(){return this.renderBundle||(this.renderBundle=this.buildRenderBundle()),this.renderBundle}destroy(){}setColorTextureView(t){this.colorTextureView=t,this.renderBundle=null}setNoiseMapTextureView(t){this.noiseMapTextureView=t,this.renderBundle=null}setDisplacementTextureView(t){this.displacementTextureView=t,this.renderBundle=null}buildRenderBundle(){let t=this.device.createBindGroup({label:"DisplacementComposition bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.displacementParametersBuffer.bufferGpu}},{binding:1,resource:this.colorTextureView},{binding:2,resource:this.colorSampler},{binding:3,resource:this.noiseMapTextureView},{binding:4,resource:this.noiseSampler},{binding:5,resource:this.displacementTextureView}]}),n=this.device.createRenderBundleEncoder({label:"DisplacementComposition renderbundle encoder",colorFormats:[this.targetFormat]});return n.setPipeline(this.renderPipeline),n.setBindGroup(0,t),n.draw(4),n.finish({label:"DisplacementComposition renderbundle"})}};var vr=class{device;bufferGpu;needsUpdate=!0;constructor(t){this.device=t.device,this.bufferGpu=this.device.createBuffer({label:"DisplacementParametersBuffer buffer",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.setParameters(t.initialParameters)}setParameters(t){this.device.queue.writeBuffer(this.bufferGpu,0,new Float32Array([t.offsetX,t.offsetY,t.scale]))}destroy(){this.bufferGpu.destroy()}};var bi="struct TransformData{mvpMatrix:mat4x4<f32>,};@group(0)@binding(0)var<uniform> transformUBO:TransformData;struct VertexIn{@location(0)position:vec2<f32>,};struct VertexOut{@builtin(position)position:vec4<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{var output:VertexOut;output.position=transformUBO.mvpMatrix*vec4<f32>(in.position,0.0,1.0);return output;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment()->FragmentOut{var out:FragmentOut;out.color=vec4<f32>(1.0,1.0,1.0,1.0);return out;}";function tu(e,t){return class extends e{constructor(...n){super(...n),t(this)}}}var eu=tu(Array,e=>e.fill(0)),_t=1e-6;function ru(e){function t(R=0,V=0){let C=new e(2);return R!==void 0&&(C[0]=R,V!==void 0&&(C[1]=V)),C}let n=t;function r(R,V,C){let u=C??new e(2);return u[0]=R,u[1]=V,u}function i(R,V){let C=V??new e(2);return C[0]=Math.ceil(R[0]),C[1]=Math.ceil(R[1]),C}function o(R,V){let C=V??new e(2);return C[0]=Math.floor(R[0]),C[1]=Math.floor(R[1]),C}function a(R,V){let C=V??new e(2);return C[0]=Math.round(R[0]),C[1]=Math.round(R[1]),C}function f(R,V=0,C=1,u){let B=u??new e(2);return B[0]=Math.min(C,Math.max(V,R[0])),B[1]=Math.min(C,Math.max(V,R[1])),B}function h(R,V,C){let u=C??new e(2);return u[0]=R[0]+V[0],u[1]=R[1]+V[1],u}function v(R,V,C,u){let B=u??new e(2);return B[0]=R[0]+V[0]*C,B[1]=R[1]+V[1]*C,B}function d(R,V){let C=R[0],u=R[1],B=V[0],x=V[1],y=Math.sqrt(C*C+u*u),g=Math.sqrt(B*B+x*x),S=y*g,L=S&&rt(R,V)/S;return Math.acos(L)}function D(R,V,C){let u=C??new e(2);return u[0]=R[0]-V[0],u[1]=R[1]-V[1],u}let X=D;function m(R,V){return Math.abs(R[0]-V[0])<_t&&Math.abs(R[1]-V[1])<_t}function G(R,V){return R[0]===V[0]&&R[1]===V[1]}function q(R,V,C,u){let B=u??new e(2);return B[0]=R[0]+C*(V[0]-R[0]),B[1]=R[1]+C*(V[1]-R[1]),B}function N(R,V,C,u){let B=u??new e(2);return B[0]=R[0]+C[0]*(V[0]-R[0]),B[1]=R[1]+C[1]*(V[1]-R[1]),B}function Y(R,V,C){let u=C??new e(2);return u[0]=Math.max(R[0],V[0]),u[1]=Math.max(R[1],V[1]),u}function K(R,V,C){let u=C??new e(2);return u[0]=Math.min(R[0],V[0]),u[1]=Math.min(R[1],V[1]),u}function Q(R,V,C){let u=C??new e(2);return u[0]=R[0]*V,u[1]=R[1]*V,u}let tt=Q;function H(R,V,C){let u=C??new e(2);return u[0]=R[0]/V,u[1]=R[1]/V,u}function W(R,V){let C=V??new e(2);return C[0]=1/R[0],C[1]=1/R[1],C}let st=W;function et(R,V,C){let u=C??new e(3),B=R[0]*V[1]-R[1]*V[0];return u[0]=0,u[1]=0,u[2]=B,u}function rt(R,V){return R[0]*V[0]+R[1]*V[1]}function F(R){let V=R[0],C=R[1];return Math.sqrt(V*V+C*C)}let s=F;function p(R){let V=R[0],C=R[1];return V*V+C*C}let _=p;function M(R,V){let C=R[0]-V[0],u=R[1]-V[1];return Math.sqrt(C*C+u*u)}let T=M;function I(R,V){let C=R[0]-V[0],u=R[1]-V[1];return C*C+u*u}let O=I;function P(R,V){let C=V??new e(2),u=R[0],B=R[1],x=Math.sqrt(u*u+B*B);return x>1e-5?(C[0]=u/x,C[1]=B/x):(C[0]=0,C[1]=0),C}function l(R,V){let C=V??new e(2);return C[0]=-R[0],C[1]=-R[1],C}function U(R,V){let C=V??new e(2);return C[0]=R[0],C[1]=R[1],C}let ot=U;function at(R,V,C){let u=C??new e(2);return u[0]=R[0]*V[0],u[1]=R[1]*V[1],u}let ut=at;function ft(R,V,C){let u=C??new e(2);return u[0]=R[0]/V[0],u[1]=R[1]/V[1],u}let yt=ft;function vt(R=1,V){let C=V??new e(2),u=Math.random()*2*Math.PI;return C[0]=Math.cos(u)*R,C[1]=Math.sin(u)*R,C}function k(R){let V=R??new e(2);return V[0]=0,V[1]=0,V}function $(R,V,C){let u=C??new e(2),B=R[0],x=R[1];return u[0]=B*V[0]+x*V[4]+V[12],u[1]=B*V[1]+x*V[5]+V[13],u}function A(R,V,C){let u=C??new e(2),B=R[0],x=R[1];return u[0]=V[0]*B+V[4]*x+V[8],u[1]=V[1]*B+V[5]*x+V[9],u}function c(R,V,C,u){let B=u??new e(2),x=R[0]-V[0],y=R[1]-V[1],g=Math.sin(C),S=Math.cos(C);return B[0]=x*S-y*g+V[0],B[1]=x*g+y*S+V[1],B}function b(R,V,C){let u=C??new e(2);return P(R,u),Q(u,V,u)}function w(R,V,C){let u=C??new e(2);return F(R)>V?b(R,V,u):U(R,u)}function E(R,V,C){let u=C??new e(2);return q(R,V,.5,u)}return{create:t,fromValues:n,set:r,ceil:i,floor:o,round:a,clamp:f,add:h,addScaled:v,angle:d,subtract:D,sub:X,equalsApproximately:m,equals:G,lerp:q,lerpV:N,max:Y,min:K,mulScalar:Q,scale:tt,divScalar:H,inverse:W,invert:st,cross:et,dot:rt,length:F,len:s,lengthSq:p,lenSq:_,distance:M,dist:T,distanceSq:I,distSq:O,normalize:P,negate:l,copy:U,clone:ot,multiply:at,mul:ut,divide:ft,div:yt,random:vt,zero:k,transformMat4:$,transformMat3:A,rotate:c,setLength:b,truncate:w,midpoint:E}}var _i=new Map;function Fi(e){let t=_i.get(e);return t||(t=ru(e),_i.set(e,t)),t}function nu(e){function t(g,S,L){let z=new e(3);return g!==void 0&&(z[0]=g,S!==void 0&&(z[1]=S,L!==void 0&&(z[2]=L))),z}let n=t;function r(g,S,L,z){let Z=z??new e(3);return Z[0]=g,Z[1]=S,Z[2]=L,Z}function i(g,S){let L=S??new e(3);return L[0]=Math.ceil(g[0]),L[1]=Math.ceil(g[1]),L[2]=Math.ceil(g[2]),L}function o(g,S){let L=S??new e(3);return L[0]=Math.floor(g[0]),L[1]=Math.floor(g[1]),L[2]=Math.floor(g[2]),L}function a(g,S){let L=S??new e(3);return L[0]=Math.round(g[0]),L[1]=Math.round(g[1]),L[2]=Math.round(g[2]),L}function f(g,S=0,L=1,z){let Z=z??new e(3);return Z[0]=Math.min(L,Math.max(S,g[0])),Z[1]=Math.min(L,Math.max(S,g[1])),Z[2]=Math.min(L,Math.max(S,g[2])),Z}function h(g,S,L){let z=L??new e(3);return z[0]=g[0]+S[0],z[1]=g[1]+S[1],z[2]=g[2]+S[2],z}function v(g,S,L,z){let Z=z??new e(3);return Z[0]=g[0]+S[0]*L,Z[1]=g[1]+S[1]*L,Z[2]=g[2]+S[2]*L,Z}function d(g,S){let L=g[0],z=g[1],Z=g[2],J=S[0],j=S[1],ct=S[2],nt=Math.sqrt(L*L+z*z+Z*Z),it=Math.sqrt(J*J+j*j+ct*ct),pt=nt*it,ht=pt&&rt(g,S)/pt;return Math.acos(ht)}function D(g,S,L){let z=L??new e(3);return z[0]=g[0]-S[0],z[1]=g[1]-S[1],z[2]=g[2]-S[2],z}let X=D;function m(g,S){return Math.abs(g[0]-S[0])<_t&&Math.abs(g[1]-S[1])<_t&&Math.abs(g[2]-S[2])<_t}function G(g,S){return g[0]===S[0]&&g[1]===S[1]&&g[2]===S[2]}function q(g,S,L,z){let Z=z??new e(3);return Z[0]=g[0]+L*(S[0]-g[0]),Z[1]=g[1]+L*(S[1]-g[1]),Z[2]=g[2]+L*(S[2]-g[2]),Z}function N(g,S,L,z){let Z=z??new e(3);return Z[0]=g[0]+L[0]*(S[0]-g[0]),Z[1]=g[1]+L[1]*(S[1]-g[1]),Z[2]=g[2]+L[2]*(S[2]-g[2]),Z}function Y(g,S,L){let z=L??new e(3);return z[0]=Math.max(g[0],S[0]),z[1]=Math.max(g[1],S[1]),z[2]=Math.max(g[2],S[2]),z}function K(g,S,L){let z=L??new e(3);return z[0]=Math.min(g[0],S[0]),z[1]=Math.min(g[1],S[1]),z[2]=Math.min(g[2],S[2]),z}function Q(g,S,L){let z=L??new e(3);return z[0]=g[0]*S,z[1]=g[1]*S,z[2]=g[2]*S,z}let tt=Q;function H(g,S,L){let z=L??new e(3);return z[0]=g[0]/S,z[1]=g[1]/S,z[2]=g[2]/S,z}function W(g,S){let L=S??new e(3);return L[0]=1/g[0],L[1]=1/g[1],L[2]=1/g[2],L}let st=W;function et(g,S,L){let z=L??new e(3),Z=g[2]*S[0]-g[0]*S[2],J=g[0]*S[1]-g[1]*S[0];return z[0]=g[1]*S[2]-g[2]*S[1],z[1]=Z,z[2]=J,z}function rt(g,S){return g[0]*S[0]+g[1]*S[1]+g[2]*S[2]}function F(g){let S=g[0],L=g[1],z=g[2];return Math.sqrt(S*S+L*L+z*z)}let s=F;function p(g){let S=g[0],L=g[1],z=g[2];return S*S+L*L+z*z}let _=p;function M(g,S){let L=g[0]-S[0],z=g[1]-S[1],Z=g[2]-S[2];return Math.sqrt(L*L+z*z+Z*Z)}let T=M;function I(g,S){let L=g[0]-S[0],z=g[1]-S[1],Z=g[2]-S[2];return L*L+z*z+Z*Z}let O=I;function P(g,S){let L=S??new e(3),z=g[0],Z=g[1],J=g[2],j=Math.sqrt(z*z+Z*Z+J*J);return j>1e-5?(L[0]=z/j,L[1]=Z/j,L[2]=J/j):(L[0]=0,L[1]=0,L[2]=0),L}function l(g,S){let L=S??new e(3);return L[0]=-g[0],L[1]=-g[1],L[2]=-g[2],L}function U(g,S){let L=S??new e(3);return L[0]=g[0],L[1]=g[1],L[2]=g[2],L}let ot=U;function at(g,S,L){let z=L??new e(3);return z[0]=g[0]*S[0],z[1]=g[1]*S[1],z[2]=g[2]*S[2],z}let ut=at;function ft(g,S,L){let z=L??new e(3);return z[0]=g[0]/S[0],z[1]=g[1]/S[1],z[2]=g[2]/S[2],z}let yt=ft;function vt(g=1,S){let L=S??new e(3),z=Math.random()*2*Math.PI,Z=Math.random()*2-1,J=Math.sqrt(1-Z*Z)*g;return L[0]=Math.cos(z)*J,L[1]=Math.sin(z)*J,L[2]=Z*g,L}function k(g){let S=g??new e(3);return S[0]=0,S[1]=0,S[2]=0,S}function $(g,S,L){let z=L??new e(3),Z=g[0],J=g[1],j=g[2],ct=S[3]*Z+S[7]*J+S[11]*j+S[15]||1;return z[0]=(S[0]*Z+S[4]*J+S[8]*j+S[12])/ct,z[1]=(S[1]*Z+S[5]*J+S[9]*j+S[13])/ct,z[2]=(S[2]*Z+S[6]*J+S[10]*j+S[14])/ct,z}function A(g,S,L){let z=L??new e(3),Z=g[0],J=g[1],j=g[2];return z[0]=Z*S[0]+J*S[4]+j*S[8],z[1]=Z*S[1]+J*S[5]+j*S[9],z[2]=Z*S[2]+J*S[6]+j*S[10],z}function c(g,S,L){let z=L??new e(3),Z=g[0],J=g[1],j=g[2];return z[0]=Z*S[0]+J*S[4]+j*S[8],z[1]=Z*S[1]+J*S[5]+j*S[9],z[2]=Z*S[2]+J*S[6]+j*S[10],z}function b(g,S,L){let z=L??new e(3),Z=S[0],J=S[1],j=S[2],ct=S[3]*2,nt=g[0],it=g[1],pt=g[2],ht=J*pt-j*it,lt=j*nt-Z*pt,gt=Z*it-J*nt;return z[0]=nt+ht*ct+(J*gt-j*lt)*2,z[1]=it+lt*ct+(j*ht-Z*gt)*2,z[2]=pt+gt*ct+(Z*lt-J*ht)*2,z}function w(g,S){let L=S??new e(3);return L[0]=g[12],L[1]=g[13],L[2]=g[14],L}function E(g,S,L){let z=L??new e(3),Z=S*4;return z[0]=g[Z+0],z[1]=g[Z+1],z[2]=g[Z+2],z}function R(g,S){let L=S??new e(3),z=g[0],Z=g[1],J=g[2],j=g[4],ct=g[5],nt=g[6],it=g[8],pt=g[9],ht=g[10];return L[0]=Math.sqrt(z*z+Z*Z+J*J),L[1]=Math.sqrt(j*j+ct*ct+nt*nt),L[2]=Math.sqrt(it*it+pt*pt+ht*ht),L}function V(g,S,L,z){let Z=z??new e(3),J=[],j=[];return J[0]=g[0]-S[0],J[1]=g[1]-S[1],J[2]=g[2]-S[2],j[0]=J[0],j[1]=J[1]*Math.cos(L)-J[2]*Math.sin(L),j[2]=J[1]*Math.sin(L)+J[2]*Math.cos(L),Z[0]=j[0]+S[0],Z[1]=j[1]+S[1],Z[2]=j[2]+S[2],Z}function C(g,S,L,z){let Z=z??new e(3),J=[],j=[];return J[0]=g[0]-S[0],J[1]=g[1]-S[1],J[2]=g[2]-S[2],j[0]=J[2]*Math.sin(L)+J[0]*Math.cos(L),j[1]=J[1],j[2]=J[2]*Math.cos(L)-J[0]*Math.sin(L),Z[0]=j[0]+S[0],Z[1]=j[1]+S[1],Z[2]=j[2]+S[2],Z}function u(g,S,L,z){let Z=z??new e(3),J=[],j=[];return J[0]=g[0]-S[0],J[1]=g[1]-S[1],J[2]=g[2]-S[2],j[0]=J[0]*Math.cos(L)-J[1]*Math.sin(L),j[1]=J[0]*Math.sin(L)+J[1]*Math.cos(L),j[2]=J[2],Z[0]=j[0]+S[0],Z[1]=j[1]+S[1],Z[2]=j[2]+S[2],Z}function B(g,S,L){let z=L??new e(3);return P(g,z),Q(z,S,z)}function x(g,S,L){let z=L??new e(3);return F(g)>S?B(g,S,z):U(g,z)}function y(g,S,L){let z=L??new e(3);return q(g,S,.5,z)}return{create:t,fromValues:n,set:r,ceil:i,floor:o,round:a,clamp:f,add:h,addScaled:v,angle:d,subtract:D,sub:X,equalsApproximately:m,equals:G,lerp:q,lerpV:N,max:Y,min:K,mulScalar:Q,scale:tt,divScalar:H,inverse:W,invert:st,cross:et,dot:rt,length:F,len:s,lengthSq:p,lenSq:_,distance:M,dist:T,distanceSq:I,distSq:O,normalize:P,negate:l,copy:U,clone:ot,multiply:at,mul:ut,divide:ft,div:yt,random:vt,zero:k,transformMat4:$,transformMat4Upper3x3:A,transformMat3:c,transformQuat:b,getTranslation:w,getAxis:E,getScaling:R,rotateX:V,rotateY:C,rotateZ:u,setLength:B,truncate:x,midpoint:y}}var Si=new Map;function pr(e){let t=Si.get(e);return t||(t=nu(e),Si.set(e,t)),t}function iu(e){let t=Fi(e),n=pr(e);function r(c,b,w,E,R,V,C,u,B){let x=new e(12);return x[3]=0,x[7]=0,x[11]=0,c!==void 0&&(x[0]=c,b!==void 0&&(x[1]=b,w!==void 0&&(x[2]=w,E!==void 0&&(x[4]=E,R!==void 0&&(x[5]=R,V!==void 0&&(x[6]=V,C!==void 0&&(x[8]=C,u!==void 0&&(x[9]=u,B!==void 0&&(x[10]=B))))))))),x}function i(c,b,w,E,R,V,C,u,B,x){let y=x??new e(12);return y[0]=c,y[1]=b,y[2]=w,y[3]=0,y[4]=E,y[5]=R,y[6]=V,y[7]=0,y[8]=C,y[9]=u,y[10]=B,y[11]=0,y}function o(c,b){let w=b??new e(12);return w[0]=c[0],w[1]=c[1],w[2]=c[2],w[3]=0,w[4]=c[4],w[5]=c[5],w[6]=c[6],w[7]=0,w[8]=c[8],w[9]=c[9],w[10]=c[10],w[11]=0,w}function a(c,b){let w=b??new e(12),E=c[0],R=c[1],V=c[2],C=c[3],u=E+E,B=R+R,x=V+V,y=E*u,g=R*u,S=R*B,L=V*u,z=V*B,Z=V*x,J=C*u,j=C*B,ct=C*x;return w[0]=1-S-Z,w[1]=g+ct,w[2]=L-j,w[3]=0,w[4]=g-ct,w[5]=1-y-Z,w[6]=z+J,w[7]=0,w[8]=L+j,w[9]=z-J,w[10]=1-y-S,w[11]=0,w}function f(c,b){let w=b??new e(12);return w[0]=-c[0],w[1]=-c[1],w[2]=-c[2],w[4]=-c[4],w[5]=-c[5],w[6]=-c[6],w[8]=-c[8],w[9]=-c[9],w[10]=-c[10],w}function h(c,b,w){let E=w??new e(12);return E[0]=c[0]*b,E[1]=c[1]*b,E[2]=c[2]*b,E[4]=c[4]*b,E[5]=c[5]*b,E[6]=c[6]*b,E[8]=c[8]*b,E[9]=c[9]*b,E[10]=c[10]*b,E}let v=h;function d(c,b,w){let E=w??new e(12);return E[0]=c[0]+b[0],E[1]=c[1]+b[1],E[2]=c[2]+b[2],E[4]=c[4]+b[4],E[5]=c[5]+b[5],E[6]=c[6]+b[6],E[8]=c[8]+b[8],E[9]=c[9]+b[9],E[10]=c[10]+b[10],E}function D(c,b){let w=b??new e(12);return w[0]=c[0],w[1]=c[1],w[2]=c[2],w[4]=c[4],w[5]=c[5],w[6]=c[6],w[8]=c[8],w[9]=c[9],w[10]=c[10],w}let X=D;function m(c,b){return Math.abs(c[0]-b[0])<_t&&Math.abs(c[1]-b[1])<_t&&Math.abs(c[2]-b[2])<_t&&Math.abs(c[4]-b[4])<_t&&Math.abs(c[5]-b[5])<_t&&Math.abs(c[6]-b[6])<_t&&Math.abs(c[8]-b[8])<_t&&Math.abs(c[9]-b[9])<_t&&Math.abs(c[10]-b[10])<_t}function G(c,b){return c[0]===b[0]&&c[1]===b[1]&&c[2]===b[2]&&c[4]===b[4]&&c[5]===b[5]&&c[6]===b[6]&&c[8]===b[8]&&c[9]===b[9]&&c[10]===b[10]}function q(c){let b=c??new e(12);return b[0]=1,b[1]=0,b[2]=0,b[4]=0,b[5]=1,b[6]=0,b[8]=0,b[9]=0,b[10]=1,b}function N(c,b){let w=b??new e(12);if(w===c){let S;return S=c[1],c[1]=c[4],c[4]=S,S=c[2],c[2]=c[8],c[8]=S,S=c[6],c[6]=c[9],c[9]=S,w}let E=c[0],R=c[1],V=c[2],C=c[4],u=c[5],B=c[6],x=c[8],y=c[9],g=c[10];return w[0]=E,w[1]=C,w[2]=x,w[4]=R,w[5]=u,w[6]=y,w[8]=V,w[9]=B,w[10]=g,w}function Y(c,b){let w=b??new e(12),E=c[0],R=c[1],V=c[2],C=c[4],u=c[5],B=c[6],x=c[8],y=c[9],g=c[10],S=g*u-B*y,L=-g*C+B*x,z=y*C-u*x,Z=1/(E*S+R*L+V*z);return w[0]=S*Z,w[1]=(-g*R+V*y)*Z,w[2]=(B*R-V*u)*Z,w[4]=L*Z,w[5]=(g*E-V*x)*Z,w[6]=(-B*E+V*C)*Z,w[8]=z*Z,w[9]=(-y*E+R*x)*Z,w[10]=(u*E-R*C)*Z,w}function K(c){let b=c[0],w=c[1],E=c[2],R=c[4],V=c[5],C=c[6],u=c[8],B=c[9],x=c[10];return b*(V*x-B*C)-R*(w*x-B*E)+u*(w*C-V*E)}let Q=Y;function tt(c,b,w){let E=w??new e(12),R=c[0],V=c[1],C=c[2],u=c[4],B=c[5],x=c[6],y=c[8],g=c[9],S=c[10],L=b[0],z=b[1],Z=b[2],J=b[4],j=b[5],ct=b[6],nt=b[8],it=b[9],pt=b[10];return E[0]=R*L+u*z+y*Z,E[1]=V*L+B*z+g*Z,E[2]=C*L+x*z+S*Z,E[4]=R*J+u*j+y*ct,E[5]=V*J+B*j+g*ct,E[6]=C*J+x*j+S*ct,E[8]=R*nt+u*it+y*pt,E[9]=V*nt+B*it+g*pt,E[10]=C*nt+x*it+S*pt,E}let H=tt;function W(c,b,w){let E=w??q();return c!==E&&(E[0]=c[0],E[1]=c[1],E[2]=c[2],E[4]=c[4],E[5]=c[5],E[6]=c[6]),E[8]=b[0],E[9]=b[1],E[10]=1,E}function st(c,b){let w=b??t.create();return w[0]=c[8],w[1]=c[9],w}function et(c,b,w){let E=w??t.create(),R=b*4;return E[0]=c[R+0],E[1]=c[R+1],E}function rt(c,b,w,E){let R=E===c?c:D(c,E),V=w*4;return R[V+0]=b[0],R[V+1]=b[1],R}function F(c,b){let w=b??t.create(),E=c[0],R=c[1],V=c[4],C=c[5];return w[0]=Math.sqrt(E*E+R*R),w[1]=Math.sqrt(V*V+C*C),w}function s(c,b){let w=b??n.create(),E=c[0],R=c[1],V=c[2],C=c[4],u=c[5],B=c[6],x=c[8],y=c[9],g=c[10];return w[0]=Math.sqrt(E*E+R*R+V*V),w[1]=Math.sqrt(C*C+u*u+B*B),w[2]=Math.sqrt(x*x+y*y+g*g),w}function p(c,b){let w=b??new e(12);return w[0]=1,w[1]=0,w[2]=0,w[4]=0,w[5]=1,w[6]=0,w[8]=c[0],w[9]=c[1],w[10]=1,w}function _(c,b,w){let E=w??new e(12),R=b[0],V=b[1],C=c[0],u=c[1],B=c[2],x=c[4],y=c[5],g=c[6],S=c[8],L=c[9],z=c[10];return c!==E&&(E[0]=C,E[1]=u,E[2]=B,E[4]=x,E[5]=y,E[6]=g),E[8]=C*R+x*V+S,E[9]=u*R+y*V+L,E[10]=B*R+g*V+z,E}function M(c,b){let w=b??new e(12),E=Math.cos(c),R=Math.sin(c);return w[0]=E,w[1]=R,w[2]=0,w[4]=-R,w[5]=E,w[6]=0,w[8]=0,w[9]=0,w[10]=1,w}function T(c,b,w){let E=w??new e(12),R=c[0],V=c[1],C=c[2],u=c[4],B=c[5],x=c[6],y=Math.cos(b),g=Math.sin(b);return E[0]=y*R+g*u,E[1]=y*V+g*B,E[2]=y*C+g*x,E[4]=y*u-g*R,E[5]=y*B-g*V,E[6]=y*x-g*C,c!==E&&(E[8]=c[8],E[9]=c[9],E[10]=c[10]),E}function I(c,b){let w=b??new e(12),E=Math.cos(c),R=Math.sin(c);return w[0]=1,w[1]=0,w[2]=0,w[4]=0,w[5]=E,w[6]=R,w[8]=0,w[9]=-R,w[10]=E,w}function O(c,b,w){let E=w??new e(12),R=c[4],V=c[5],C=c[6],u=c[8],B=c[9],x=c[10],y=Math.cos(b),g=Math.sin(b);return E[4]=y*R+g*u,E[5]=y*V+g*B,E[6]=y*C+g*x,E[8]=y*u-g*R,E[9]=y*B-g*V,E[10]=y*x-g*C,c!==E&&(E[0]=c[0],E[1]=c[1],E[2]=c[2]),E}function P(c,b){let w=b??new e(12),E=Math.cos(c),R=Math.sin(c);return w[0]=E,w[1]=0,w[2]=-R,w[4]=0,w[5]=1,w[6]=0,w[8]=R,w[9]=0,w[10]=E,w}function l(c,b,w){let E=w??new e(12),R=c[0],V=c[1],C=c[2],u=c[8],B=c[9],x=c[10],y=Math.cos(b),g=Math.sin(b);return E[0]=y*R-g*u,E[1]=y*V-g*B,E[2]=y*C-g*x,E[8]=y*u+g*R,E[9]=y*B+g*V,E[10]=y*x+g*C,c!==E&&(E[4]=c[4],E[5]=c[5],E[6]=c[6]),E}let U=M,ot=T;function at(c,b){let w=b??new e(12);return w[0]=c[0],w[1]=0,w[2]=0,w[4]=0,w[5]=c[1],w[6]=0,w[8]=0,w[9]=0,w[10]=1,w}function ut(c,b,w){let E=w??new e(12),R=b[0],V=b[1];return E[0]=R*c[0],E[1]=R*c[1],E[2]=R*c[2],E[4]=V*c[4],E[5]=V*c[5],E[6]=V*c[6],c!==E&&(E[8]=c[8],E[9]=c[9],E[10]=c[10]),E}function ft(c,b){let w=b??new e(12);return w[0]=c[0],w[1]=0,w[2]=0,w[4]=0,w[5]=c[1],w[6]=0,w[8]=0,w[9]=0,w[10]=c[2],w}function yt(c,b,w){let E=w??new e(12),R=b[0],V=b[1],C=b[2];return E[0]=R*c[0],E[1]=R*c[1],E[2]=R*c[2],E[4]=V*c[4],E[5]=V*c[5],E[6]=V*c[6],E[8]=C*c[8],E[9]=C*c[9],E[10]=C*c[10],E}function vt(c,b){let w=b??new e(12);return w[0]=c,w[1]=0,w[2]=0,w[4]=0,w[5]=c,w[6]=0,w[8]=0,w[9]=0,w[10]=1,w}function k(c,b,w){let E=w??new e(12);return E[0]=b*c[0],E[1]=b*c[1],E[2]=b*c[2],E[4]=b*c[4],E[5]=b*c[5],E[6]=b*c[6],c!==E&&(E[8]=c[8],E[9]=c[9],E[10]=c[10]),E}function $(c,b){let w=b??new e(12);return w[0]=c,w[1]=0,w[2]=0,w[4]=0,w[5]=c,w[6]=0,w[8]=0,w[9]=0,w[10]=c,w}function A(c,b,w){let E=w??new e(12);return E[0]=b*c[0],E[1]=b*c[1],E[2]=b*c[2],E[4]=b*c[4],E[5]=b*c[5],E[6]=b*c[6],E[8]=b*c[8],E[9]=b*c[9],E[10]=b*c[10],E}return{add:d,clone:X,copy:D,create:r,determinant:K,equals:G,equalsApproximately:m,fromMat4:o,fromQuat:a,get3DScaling:s,getAxis:et,getScaling:F,getTranslation:st,identity:q,inverse:Y,invert:Q,mul:H,mulScalar:v,multiply:tt,multiplyScalar:h,negate:f,rotate:T,rotateX:O,rotateY:l,rotateZ:ot,rotation:M,rotationX:I,rotationY:P,rotationZ:U,scale:ut,scale3D:yt,scaling:at,scaling3D:ft,set:i,setAxis:rt,setTranslation:W,translate:_,translation:p,transpose:N,uniformScale:k,uniformScale3D:A,uniformScaling:vt,uniformScaling3D:$}}var Ti=new Map;function ou(e){let t=Ti.get(e);return t||(t=iu(e),Ti.set(e,t)),t}function au(e){let t=pr(e);function n(u,B,x,y,g,S,L,z,Z,J,j,ct,nt,it,pt,ht){let lt=new e(16);return u!==void 0&&(lt[0]=u,B!==void 0&&(lt[1]=B,x!==void 0&&(lt[2]=x,y!==void 0&&(lt[3]=y,g!==void 0&&(lt[4]=g,S!==void 0&&(lt[5]=S,L!==void 0&&(lt[6]=L,z!==void 0&&(lt[7]=z,Z!==void 0&&(lt[8]=Z,J!==void 0&&(lt[9]=J,j!==void 0&&(lt[10]=j,ct!==void 0&&(lt[11]=ct,nt!==void 0&&(lt[12]=nt,it!==void 0&&(lt[13]=it,pt!==void 0&&(lt[14]=pt,ht!==void 0&&(lt[15]=ht)))))))))))))))),lt}function r(u,B,x,y,g,S,L,z,Z,J,j,ct,nt,it,pt,ht,lt){let gt=lt??new e(16);return gt[0]=u,gt[1]=B,gt[2]=x,gt[3]=y,gt[4]=g,gt[5]=S,gt[6]=L,gt[7]=z,gt[8]=Z,gt[9]=J,gt[10]=j,gt[11]=ct,gt[12]=nt,gt[13]=it,gt[14]=pt,gt[15]=ht,gt}function i(u,B){let x=B??new e(16);return x[0]=u[0],x[1]=u[1],x[2]=u[2],x[3]=0,x[4]=u[4],x[5]=u[5],x[6]=u[6],x[7]=0,x[8]=u[8],x[9]=u[9],x[10]=u[10],x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function o(u,B){let x=B??new e(16),y=u[0],g=u[1],S=u[2],L=u[3],z=y+y,Z=g+g,J=S+S,j=y*z,ct=g*z,nt=g*Z,it=S*z,pt=S*Z,ht=S*J,lt=L*z,gt=L*Z,wt=L*J;return x[0]=1-nt-ht,x[1]=ct+wt,x[2]=it-gt,x[3]=0,x[4]=ct-wt,x[5]=1-j-ht,x[6]=pt+lt,x[7]=0,x[8]=it+gt,x[9]=pt-lt,x[10]=1-j-nt,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function a(u,B){let x=B??new e(16);return x[0]=-u[0],x[1]=-u[1],x[2]=-u[2],x[3]=-u[3],x[4]=-u[4],x[5]=-u[5],x[6]=-u[6],x[7]=-u[7],x[8]=-u[8],x[9]=-u[9],x[10]=-u[10],x[11]=-u[11],x[12]=-u[12],x[13]=-u[13],x[14]=-u[14],x[15]=-u[15],x}function f(u,B,x){let y=x??new e(16);return y[0]=u[0]+B[0],y[1]=u[1]+B[1],y[2]=u[2]+B[2],y[3]=u[3]+B[3],y[4]=u[4]+B[4],y[5]=u[5]+B[5],y[6]=u[6]+B[6],y[7]=u[7]+B[7],y[8]=u[8]+B[8],y[9]=u[9]+B[9],y[10]=u[10]+B[10],y[11]=u[11]+B[11],y[12]=u[12]+B[12],y[13]=u[13]+B[13],y[14]=u[14]+B[14],y[15]=u[15]+B[15],y}function h(u,B,x){let y=x??new e(16);return y[0]=u[0]*B,y[1]=u[1]*B,y[2]=u[2]*B,y[3]=u[3]*B,y[4]=u[4]*B,y[5]=u[5]*B,y[6]=u[6]*B,y[7]=u[7]*B,y[8]=u[8]*B,y[9]=u[9]*B,y[10]=u[10]*B,y[11]=u[11]*B,y[12]=u[12]*B,y[13]=u[13]*B,y[14]=u[14]*B,y[15]=u[15]*B,y}let v=h;function d(u,B){let x=B??new e(16);return x[0]=u[0],x[1]=u[1],x[2]=u[2],x[3]=u[3],x[4]=u[4],x[5]=u[5],x[6]=u[6],x[7]=u[7],x[8]=u[8],x[9]=u[9],x[10]=u[10],x[11]=u[11],x[12]=u[12],x[13]=u[13],x[14]=u[14],x[15]=u[15],x}let D=d;function X(u,B){return Math.abs(u[0]-B[0])<_t&&Math.abs(u[1]-B[1])<_t&&Math.abs(u[2]-B[2])<_t&&Math.abs(u[3]-B[3])<_t&&Math.abs(u[4]-B[4])<_t&&Math.abs(u[5]-B[5])<_t&&Math.abs(u[6]-B[6])<_t&&Math.abs(u[7]-B[7])<_t&&Math.abs(u[8]-B[8])<_t&&Math.abs(u[9]-B[9])<_t&&Math.abs(u[10]-B[10])<_t&&Math.abs(u[11]-B[11])<_t&&Math.abs(u[12]-B[12])<_t&&Math.abs(u[13]-B[13])<_t&&Math.abs(u[14]-B[14])<_t&&Math.abs(u[15]-B[15])<_t}function m(u,B){return u[0]===B[0]&&u[1]===B[1]&&u[2]===B[2]&&u[3]===B[3]&&u[4]===B[4]&&u[5]===B[5]&&u[6]===B[6]&&u[7]===B[7]&&u[8]===B[8]&&u[9]===B[9]&&u[10]===B[10]&&u[11]===B[11]&&u[12]===B[12]&&u[13]===B[13]&&u[14]===B[14]&&u[15]===B[15]}function G(u){let B=u??new e(16);return B[0]=1,B[1]=0,B[2]=0,B[3]=0,B[4]=0,B[5]=1,B[6]=0,B[7]=0,B[8]=0,B[9]=0,B[10]=1,B[11]=0,B[12]=0,B[13]=0,B[14]=0,B[15]=1,B}function q(u,B){let x=B??new e(16);if(x===u){let dt;return dt=u[1],u[1]=u[4],u[4]=dt,dt=u[2],u[2]=u[8],u[8]=dt,dt=u[3],u[3]=u[12],u[12]=dt,dt=u[6],u[6]=u[9],u[9]=dt,dt=u[7],u[7]=u[13],u[13]=dt,dt=u[11],u[11]=u[14],u[14]=dt,x}let y=u[0],g=u[1],S=u[2],L=u[3],z=u[4],Z=u[5],J=u[6],j=u[7],ct=u[8],nt=u[9],it=u[10],pt=u[11],ht=u[12],lt=u[13],gt=u[14],wt=u[15];return x[0]=y,x[1]=z,x[2]=ct,x[3]=ht,x[4]=g,x[5]=Z,x[6]=nt,x[7]=lt,x[8]=S,x[9]=J,x[10]=it,x[11]=gt,x[12]=L,x[13]=j,x[14]=pt,x[15]=wt,x}function N(u,B){let x=B??new e(16),y=u[0],g=u[1],S=u[2],L=u[3],z=u[4],Z=u[5],J=u[6],j=u[7],ct=u[8],nt=u[9],it=u[10],pt=u[11],ht=u[12],lt=u[13],gt=u[14],wt=u[15],dt=it*wt,Ct=gt*pt,Mt=J*wt,bt=gt*j,Ht=J*pt,Bt=it*j,Pt=S*wt,$t=gt*L,Dt=S*pt,Ft=it*L,Wt=S*j,At=J*L,Ut=ct*lt,Kt=ht*nt,zt=z*lt,Et=ht*Z,jt=z*nt,Rt=ct*Z,Gt=y*lt,Te=ht*g,Ot=y*nt,Vt=ct*g,Be=y*Z,qt=z*g,mt=dt*Z+bt*nt+Ht*lt-(Ct*Z+Mt*nt+Bt*lt),Ve=Ct*g+Pt*nt+Ft*lt-(dt*g+$t*nt+Dt*lt),qe=Mt*g+$t*Z+Wt*lt-(bt*g+Pt*Z+At*lt),Ne=Bt*g+Dt*Z+At*nt-(Ht*g+Ft*Z+Wt*nt),Zt=1/(y*mt+z*Ve+ct*qe+ht*Ne);return x[0]=Zt*mt,x[1]=Zt*Ve,x[2]=Zt*qe,x[3]=Zt*Ne,x[4]=Zt*(Ct*z+Mt*ct+Bt*ht-(dt*z+bt*ct+Ht*ht)),x[5]=Zt*(dt*y+$t*ct+Dt*ht-(Ct*y+Pt*ct+Ft*ht)),x[6]=Zt*(bt*y+Pt*z+At*ht-(Mt*y+$t*z+Wt*ht)),x[7]=Zt*(Ht*y+Ft*z+Wt*ct-(Bt*y+Dt*z+At*ct)),x[8]=Zt*(Ut*j+Et*pt+jt*wt-(Kt*j+zt*pt+Rt*wt)),x[9]=Zt*(Kt*L+Gt*pt+Vt*wt-(Ut*L+Te*pt+Ot*wt)),x[10]=Zt*(zt*L+Te*j+Be*wt-(Et*L+Gt*j+qt*wt)),x[11]=Zt*(Rt*L+Ot*j+qt*pt-(jt*L+Vt*j+Be*pt)),x[12]=Zt*(zt*it+Rt*gt+Kt*J-(jt*gt+Ut*J+Et*it)),x[13]=Zt*(Ot*gt+Ut*S+Te*it-(Gt*it+Vt*gt+Kt*S)),x[14]=Zt*(Gt*J+qt*gt+Et*S-(Be*gt+zt*S+Te*J)),x[15]=Zt*(Be*it+jt*S+Vt*J-(Ot*J+qt*it+Rt*S)),x}function Y(u){let B=u[0],x=u[1],y=u[2],g=u[3],S=u[4],L=u[5],z=u[6],Z=u[7],J=u[8],j=u[9],ct=u[10],nt=u[11],it=u[12],pt=u[13],ht=u[14],lt=u[15],gt=ct*lt,wt=ht*nt,dt=z*lt,Ct=ht*Z,Mt=z*nt,bt=ct*Z,Ht=y*lt,Bt=ht*g,Pt=y*nt,$t=ct*g,Dt=y*Z,Ft=z*g,Wt=gt*L+Ct*j+Mt*pt-(wt*L+dt*j+bt*pt),At=wt*x+Ht*j+$t*pt-(gt*x+Bt*j+Pt*pt),Ut=dt*x+Bt*L+Dt*pt-(Ct*x+Ht*L+Ft*pt),Kt=bt*x+Pt*L+Ft*j-(Mt*x+$t*L+Dt*j);return B*Wt+S*At+J*Ut+it*Kt}let K=N;function Q(u,B,x){let y=x??new e(16),g=u[0],S=u[1],L=u[2],z=u[3],Z=u[4],J=u[5],j=u[6],ct=u[7],nt=u[8],it=u[9],pt=u[10],ht=u[11],lt=u[12],gt=u[13],wt=u[14],dt=u[15],Ct=B[0],Mt=B[1],bt=B[2],Ht=B[3],Bt=B[4],Pt=B[5],$t=B[6],Dt=B[7],Ft=B[8],Wt=B[9],At=B[10],Ut=B[11],Kt=B[12],zt=B[13],Et=B[14],jt=B[15];return y[0]=g*Ct+Z*Mt+nt*bt+lt*Ht,y[1]=S*Ct+J*Mt+it*bt+gt*Ht,y[2]=L*Ct+j*Mt+pt*bt+wt*Ht,y[3]=z*Ct+ct*Mt+ht*bt+dt*Ht,y[4]=g*Bt+Z*Pt+nt*$t+lt*Dt,y[5]=S*Bt+J*Pt+it*$t+gt*Dt,y[6]=L*Bt+j*Pt+pt*$t+wt*Dt,y[7]=z*Bt+ct*Pt+ht*$t+dt*Dt,y[8]=g*Ft+Z*Wt+nt*At+lt*Ut,y[9]=S*Ft+J*Wt+it*At+gt*Ut,y[10]=L*Ft+j*Wt+pt*At+wt*Ut,y[11]=z*Ft+ct*Wt+ht*At+dt*Ut,y[12]=g*Kt+Z*zt+nt*Et+lt*jt,y[13]=S*Kt+J*zt+it*Et+gt*jt,y[14]=L*Kt+j*zt+pt*Et+wt*jt,y[15]=z*Kt+ct*zt+ht*Et+dt*jt,y}let tt=Q;function H(u,B,x){let y=x??G();return u!==y&&(y[0]=u[0],y[1]=u[1],y[2]=u[2],y[3]=u[3],y[4]=u[4],y[5]=u[5],y[6]=u[6],y[7]=u[7],y[8]=u[8],y[9]=u[9],y[10]=u[10],y[11]=u[11]),y[12]=B[0],y[13]=B[1],y[14]=B[2],y[15]=1,y}function W(u,B){let x=B??t.create();return x[0]=u[12],x[1]=u[13],x[2]=u[14],x}function st(u,B,x){let y=x??t.create(),g=B*4;return y[0]=u[g+0],y[1]=u[g+1],y[2]=u[g+2],y}function et(u,B,x,y){let g=y===u?y:d(u,y),S=x*4;return g[S+0]=B[0],g[S+1]=B[1],g[S+2]=B[2],g}function rt(u,B){let x=B??t.create(),y=u[0],g=u[1],S=u[2],L=u[4],z=u[5],Z=u[6],J=u[8],j=u[9],ct=u[10];return x[0]=Math.sqrt(y*y+g*g+S*S),x[1]=Math.sqrt(L*L+z*z+Z*Z),x[2]=Math.sqrt(J*J+j*j+ct*ct),x}function F(u,B,x,y,g){let S=g??new e(16),L=Math.tan(Math.PI*.5-.5*u);if(S[0]=L/B,S[1]=0,S[2]=0,S[3]=0,S[4]=0,S[5]=L,S[6]=0,S[7]=0,S[8]=0,S[9]=0,S[11]=-1,S[12]=0,S[13]=0,S[15]=0,Number.isFinite(y)){let z=1/(x-y);S[10]=y*z,S[14]=y*x*z}else S[10]=-1,S[14]=-x;return S}function s(u,B,x,y=1/0,g){let S=g??new e(16),L=1/Math.tan(u*.5);if(S[0]=L/B,S[1]=0,S[2]=0,S[3]=0,S[4]=0,S[5]=L,S[6]=0,S[7]=0,S[8]=0,S[9]=0,S[11]=-1,S[12]=0,S[13]=0,S[15]=0,y===1/0)S[10]=0,S[14]=x;else{let z=1/(y-x);S[10]=x*z,S[14]=y*x*z}return S}function p(u,B,x,y,g,S,L){let z=L??new e(16);return z[0]=2/(B-u),z[1]=0,z[2]=0,z[3]=0,z[4]=0,z[5]=2/(y-x),z[6]=0,z[7]=0,z[8]=0,z[9]=0,z[10]=1/(g-S),z[11]=0,z[12]=(B+u)/(u-B),z[13]=(y+x)/(x-y),z[14]=g/(g-S),z[15]=1,z}function _(u,B,x,y,g,S,L){let z=L??new e(16),Z=B-u,J=y-x,j=g-S;return z[0]=2*g/Z,z[1]=0,z[2]=0,z[3]=0,z[4]=0,z[5]=2*g/J,z[6]=0,z[7]=0,z[8]=(u+B)/Z,z[9]=(y+x)/J,z[10]=S/j,z[11]=-1,z[12]=0,z[13]=0,z[14]=g*S/j,z[15]=0,z}function M(u,B,x,y,g,S=1/0,L){let z=L??new e(16),Z=B-u,J=y-x;if(z[0]=2*g/Z,z[1]=0,z[2]=0,z[3]=0,z[4]=0,z[5]=2*g/J,z[6]=0,z[7]=0,z[8]=(u+B)/Z,z[9]=(y+x)/J,z[11]=-1,z[12]=0,z[13]=0,z[15]=0,S===1/0)z[10]=0,z[14]=g;else{let j=1/(S-g);z[10]=g*j,z[14]=S*g*j}return z}let T=t.create(),I=t.create(),O=t.create();function P(u,B,x,y){let g=y??new e(16);return t.normalize(t.subtract(B,u,O),O),t.normalize(t.cross(x,O,T),T),t.normalize(t.cross(O,T,I),I),g[0]=T[0],g[1]=T[1],g[2]=T[2],g[3]=0,g[4]=I[0],g[5]=I[1],g[6]=I[2],g[7]=0,g[8]=O[0],g[9]=O[1],g[10]=O[2],g[11]=0,g[12]=u[0],g[13]=u[1],g[14]=u[2],g[15]=1,g}function l(u,B,x,y){let g=y??new e(16);return t.normalize(t.subtract(u,B,O),O),t.normalize(t.cross(x,O,T),T),t.normalize(t.cross(O,T,I),I),g[0]=T[0],g[1]=T[1],g[2]=T[2],g[3]=0,g[4]=I[0],g[5]=I[1],g[6]=I[2],g[7]=0,g[8]=O[0],g[9]=O[1],g[10]=O[2],g[11]=0,g[12]=u[0],g[13]=u[1],g[14]=u[2],g[15]=1,g}function U(u,B,x,y){let g=y??new e(16);return t.normalize(t.subtract(u,B,O),O),t.normalize(t.cross(x,O,T),T),t.normalize(t.cross(O,T,I),I),g[0]=T[0],g[1]=I[0],g[2]=O[0],g[3]=0,g[4]=T[1],g[5]=I[1],g[6]=O[1],g[7]=0,g[8]=T[2],g[9]=I[2],g[10]=O[2],g[11]=0,g[12]=-(T[0]*u[0]+T[1]*u[1]+T[2]*u[2]),g[13]=-(I[0]*u[0]+I[1]*u[1]+I[2]*u[2]),g[14]=-(O[0]*u[0]+O[1]*u[1]+O[2]*u[2]),g[15]=1,g}function ot(u,B){let x=B??new e(16);return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=u[0],x[13]=u[1],x[14]=u[2],x[15]=1,x}function at(u,B,x){let y=x??new e(16),g=B[0],S=B[1],L=B[2],z=u[0],Z=u[1],J=u[2],j=u[3],ct=u[4],nt=u[5],it=u[6],pt=u[7],ht=u[8],lt=u[9],gt=u[10],wt=u[11],dt=u[12],Ct=u[13],Mt=u[14],bt=u[15];return u!==y&&(y[0]=z,y[1]=Z,y[2]=J,y[3]=j,y[4]=ct,y[5]=nt,y[6]=it,y[7]=pt,y[8]=ht,y[9]=lt,y[10]=gt,y[11]=wt),y[12]=z*g+ct*S+ht*L+dt,y[13]=Z*g+nt*S+lt*L+Ct,y[14]=J*g+it*S+gt*L+Mt,y[15]=j*g+pt*S+wt*L+bt,y}function ut(u,B){let x=B??new e(16),y=Math.cos(u),g=Math.sin(u);return x[0]=1,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=y,x[6]=g,x[7]=0,x[8]=0,x[9]=-g,x[10]=y,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function ft(u,B,x){let y=x??new e(16),g=u[4],S=u[5],L=u[6],z=u[7],Z=u[8],J=u[9],j=u[10],ct=u[11],nt=Math.cos(B),it=Math.sin(B);return y[4]=nt*g+it*Z,y[5]=nt*S+it*J,y[6]=nt*L+it*j,y[7]=nt*z+it*ct,y[8]=nt*Z-it*g,y[9]=nt*J-it*S,y[10]=nt*j-it*L,y[11]=nt*ct-it*z,u!==y&&(y[0]=u[0],y[1]=u[1],y[2]=u[2],y[3]=u[3],y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function yt(u,B){let x=B??new e(16),y=Math.cos(u),g=Math.sin(u);return x[0]=y,x[1]=0,x[2]=-g,x[3]=0,x[4]=0,x[5]=1,x[6]=0,x[7]=0,x[8]=g,x[9]=0,x[10]=y,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function vt(u,B,x){let y=x??new e(16),g=u[0],S=u[1],L=u[2],z=u[3],Z=u[8],J=u[9],j=u[10],ct=u[11],nt=Math.cos(B),it=Math.sin(B);return y[0]=nt*g-it*Z,y[1]=nt*S-it*J,y[2]=nt*L-it*j,y[3]=nt*z-it*ct,y[8]=nt*Z+it*g,y[9]=nt*J+it*S,y[10]=nt*j+it*L,y[11]=nt*ct+it*z,u!==y&&(y[4]=u[4],y[5]=u[5],y[6]=u[6],y[7]=u[7],y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function k(u,B){let x=B??new e(16),y=Math.cos(u),g=Math.sin(u);return x[0]=y,x[1]=g,x[2]=0,x[3]=0,x[4]=-g,x[5]=y,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=1,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function $(u,B,x){let y=x??new e(16),g=u[0],S=u[1],L=u[2],z=u[3],Z=u[4],J=u[5],j=u[6],ct=u[7],nt=Math.cos(B),it=Math.sin(B);return y[0]=nt*g+it*Z,y[1]=nt*S+it*J,y[2]=nt*L+it*j,y[3]=nt*z+it*ct,y[4]=nt*Z-it*g,y[5]=nt*J-it*S,y[6]=nt*j-it*L,y[7]=nt*ct-it*z,u!==y&&(y[8]=u[8],y[9]=u[9],y[10]=u[10],y[11]=u[11],y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function A(u,B,x){let y=x??new e(16),g=u[0],S=u[1],L=u[2],z=Math.sqrt(g*g+S*S+L*L);g/=z,S/=z,L/=z;let Z=g*g,J=S*S,j=L*L,ct=Math.cos(B),nt=Math.sin(B),it=1-ct;return y[0]=Z+(1-Z)*ct,y[1]=g*S*it+L*nt,y[2]=g*L*it-S*nt,y[3]=0,y[4]=g*S*it-L*nt,y[5]=J+(1-J)*ct,y[6]=S*L*it+g*nt,y[7]=0,y[8]=g*L*it+S*nt,y[9]=S*L*it-g*nt,y[10]=j+(1-j)*ct,y[11]=0,y[12]=0,y[13]=0,y[14]=0,y[15]=1,y}let c=A;function b(u,B,x,y){let g=y??new e(16),S=B[0],L=B[1],z=B[2],Z=Math.sqrt(S*S+L*L+z*z);S/=Z,L/=Z,z/=Z;let J=S*S,j=L*L,ct=z*z,nt=Math.cos(x),it=Math.sin(x),pt=1-nt,ht=J+(1-J)*nt,lt=S*L*pt+z*it,gt=S*z*pt-L*it,wt=S*L*pt-z*it,dt=j+(1-j)*nt,Ct=L*z*pt+S*it,Mt=S*z*pt+L*it,bt=L*z*pt-S*it,Ht=ct+(1-ct)*nt,Bt=u[0],Pt=u[1],$t=u[2],Dt=u[3],Ft=u[4],Wt=u[5],At=u[6],Ut=u[7],Kt=u[8],zt=u[9],Et=u[10],jt=u[11];return g[0]=ht*Bt+lt*Ft+gt*Kt,g[1]=ht*Pt+lt*Wt+gt*zt,g[2]=ht*$t+lt*At+gt*Et,g[3]=ht*Dt+lt*Ut+gt*jt,g[4]=wt*Bt+dt*Ft+Ct*Kt,g[5]=wt*Pt+dt*Wt+Ct*zt,g[6]=wt*$t+dt*At+Ct*Et,g[7]=wt*Dt+dt*Ut+Ct*jt,g[8]=Mt*Bt+bt*Ft+Ht*Kt,g[9]=Mt*Pt+bt*Wt+Ht*zt,g[10]=Mt*$t+bt*At+Ht*Et,g[11]=Mt*Dt+bt*Ut+Ht*jt,u!==g&&(g[12]=u[12],g[13]=u[13],g[14]=u[14],g[15]=u[15]),g}let w=b;function E(u,B){let x=B??new e(16);return x[0]=u[0],x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=u[1],x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=u[2],x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function R(u,B,x){let y=x??new e(16),g=B[0],S=B[1],L=B[2];return y[0]=g*u[0],y[1]=g*u[1],y[2]=g*u[2],y[3]=g*u[3],y[4]=S*u[4],y[5]=S*u[5],y[6]=S*u[6],y[7]=S*u[7],y[8]=L*u[8],y[9]=L*u[9],y[10]=L*u[10],y[11]=L*u[11],u!==y&&(y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}function V(u,B){let x=B??new e(16);return x[0]=u,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=u,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=u,x[11]=0,x[12]=0,x[13]=0,x[14]=0,x[15]=1,x}function C(u,B,x){let y=x??new e(16);return y[0]=B*u[0],y[1]=B*u[1],y[2]=B*u[2],y[3]=B*u[3],y[4]=B*u[4],y[5]=B*u[5],y[6]=B*u[6],y[7]=B*u[7],y[8]=B*u[8],y[9]=B*u[9],y[10]=B*u[10],y[11]=B*u[11],u!==y&&(y[12]=u[12],y[13]=u[13],y[14]=u[14],y[15]=u[15]),y}return{add:f,aim:P,axisRotate:b,axisRotation:A,cameraAim:l,clone:D,copy:d,create:n,determinant:Y,equals:m,equalsApproximately:X,fromMat3:i,fromQuat:o,frustum:_,frustumReverseZ:M,getAxis:st,getScaling:rt,getTranslation:W,identity:G,inverse:N,invert:K,lookAt:U,mul:tt,mulScalar:v,multiply:Q,multiplyScalar:h,negate:a,ortho:p,perspective:F,perspectiveReverseZ:s,rotate:w,rotateX:ft,rotateY:vt,rotateZ:$,rotation:c,rotationX:ut,rotationY:yt,rotationZ:k,scale:R,scaling:E,set:r,setAxis:et,setTranslation:H,translate:at,translation:ot,transpose:q,uniformScale:C,uniformScaling:V}}var Bi=new Map;function su(e){let t=Bi.get(e);return t||(t=au(e),Bi.set(e,t)),t}function uu(e){let t=pr(e);function n(k,$,A,c){let b=new e(4);return k!==void 0&&(b[0]=k,$!==void 0&&(b[1]=$,A!==void 0&&(b[2]=A,c!==void 0&&(b[3]=c)))),b}let r=n;function i(k,$,A,c,b){let w=b??new e(4);return w[0]=k,w[1]=$,w[2]=A,w[3]=c,w}function o(k,$,A){let c=A??new e(4),b=$*.5,w=Math.sin(b);return c[0]=w*k[0],c[1]=w*k[1],c[2]=w*k[2],c[3]=Math.cos(b),c}function a(k,$){let A=$??t.create(3),c=Math.acos(k[3])*2,b=Math.sin(c*.5);return b>_t?(A[0]=k[0]/b,A[1]=k[1]/b,A[2]=k[2]/b):(A[0]=1,A[1]=0,A[2]=0),{angle:c,axis:A}}function f(k,$){let A=F(k,$);return Math.acos(2*A*A-1)}function h(k,$,A){let c=A??new e(4),b=k[0],w=k[1],E=k[2],R=k[3],V=$[0],C=$[1],u=$[2],B=$[3];return c[0]=b*B+R*V+w*u-E*C,c[1]=w*B+R*C+E*V-b*u,c[2]=E*B+R*u+b*C-w*V,c[3]=R*B-b*V-w*C-E*u,c}let v=h;function d(k,$,A){let c=A??new e(4),b=$*.5,w=k[0],E=k[1],R=k[2],V=k[3],C=Math.sin(b),u=Math.cos(b);return c[0]=w*u+V*C,c[1]=E*u+R*C,c[2]=R*u-E*C,c[3]=V*u-w*C,c}function D(k,$,A){let c=A??new e(4),b=$*.5,w=k[0],E=k[1],R=k[2],V=k[3],C=Math.sin(b),u=Math.cos(b);return c[0]=w*u-R*C,c[1]=E*u+V*C,c[2]=R*u+w*C,c[3]=V*u-E*C,c}function X(k,$,A){let c=A??new e(4),b=$*.5,w=k[0],E=k[1],R=k[2],V=k[3],C=Math.sin(b),u=Math.cos(b);return c[0]=w*u+E*C,c[1]=E*u-w*C,c[2]=R*u+V*C,c[3]=V*u-R*C,c}function m(k,$,A,c){let b=c??new e(4),w=k[0],E=k[1],R=k[2],V=k[3],C=$[0],u=$[1],B=$[2],x=$[3],y=w*C+E*u+R*B+V*x;y<0&&(y=-y,C=-C,u=-u,B=-B,x=-x);let g,S;if(1-y>_t){let L=Math.acos(y),z=Math.sin(L);g=Math.sin((1-A)*L)/z,S=Math.sin(A*L)/z}else g=1-A,S=A;return b[0]=g*w+S*C,b[1]=g*E+S*u,b[2]=g*R+S*B,b[3]=g*V+S*x,b}function G(k,$){let A=$??new e(4),c=k[0],b=k[1],w=k[2],E=k[3],R=c*c+b*b+w*w+E*E,V=R?1/R:0;return A[0]=-c*V,A[1]=-b*V,A[2]=-w*V,A[3]=E*V,A}function q(k,$){let A=$??new e(4);return A[0]=-k[0],A[1]=-k[1],A[2]=-k[2],A[3]=k[3],A}function N(k,$){let A=$??new e(4),c=k[0]+k[5]+k[10];if(c>0){let b=Math.sqrt(c+1);A[3]=.5*b;let w=.5/b;A[0]=(k[6]-k[9])*w,A[1]=(k[8]-k[2])*w,A[2]=(k[1]-k[4])*w}else{let b=0;k[5]>k[0]&&(b=1),k[10]>k[b*4+b]&&(b=2);let w=(b+1)%3,E=(b+2)%3,R=Math.sqrt(k[b*4+b]-k[w*4+w]-k[E*4+E]+1);A[b]=.5*R;let V=.5/R;A[3]=(k[w*4+E]-k[E*4+w])*V,A[w]=(k[w*4+b]+k[b*4+w])*V,A[E]=(k[E*4+b]+k[b*4+E])*V}return A}function Y(k,$,A,c,b){let w=b??new e(4),E=k*.5,R=$*.5,V=A*.5,C=Math.sin(E),u=Math.cos(E),B=Math.sin(R),x=Math.cos(R),y=Math.sin(V),g=Math.cos(V);switch(c){case"xyz":w[0]=C*x*g+u*B*y,w[1]=u*B*g-C*x*y,w[2]=u*x*y+C*B*g,w[3]=u*x*g-C*B*y;break;case"xzy":w[0]=C*x*g-u*B*y,w[1]=u*B*g-C*x*y,w[2]=u*x*y+C*B*g,w[3]=u*x*g+C*B*y;break;case"yxz":w[0]=C*x*g+u*B*y,w[1]=u*B*g-C*x*y,w[2]=u*x*y-C*B*g,w[3]=u*x*g+C*B*y;break;case"yzx":w[0]=C*x*g+u*B*y,w[1]=u*B*g+C*x*y,w[2]=u*x*y-C*B*g,w[3]=u*x*g-C*B*y;break;case"zxy":w[0]=C*x*g-u*B*y,w[1]=u*B*g+C*x*y,w[2]=u*x*y+C*B*g,w[3]=u*x*g-C*B*y;break;case"zyx":w[0]=C*x*g-u*B*y,w[1]=u*B*g+C*x*y,w[2]=u*x*y-C*B*g,w[3]=u*x*g+C*B*y;break;default:throw new Error(`Unknown rotation order: ${c}`)}return w}function K(k,$){let A=$??new e(4);return A[0]=k[0],A[1]=k[1],A[2]=k[2],A[3]=k[3],A}let Q=K;function tt(k,$,A){let c=A??new e(4);return c[0]=k[0]+$[0],c[1]=k[1]+$[1],c[2]=k[2]+$[2],c[3]=k[3]+$[3],c}function H(k,$,A){let c=A??new e(4);return c[0]=k[0]-$[0],c[1]=k[1]-$[1],c[2]=k[2]-$[2],c[3]=k[3]-$[3],c}let W=H;function st(k,$,A){let c=A??new e(4);return c[0]=k[0]*$,c[1]=k[1]*$,c[2]=k[2]*$,c[3]=k[3]*$,c}let et=st;function rt(k,$,A){let c=A??new e(4);return c[0]=k[0]/$,c[1]=k[1]/$,c[2]=k[2]/$,c[3]=k[3]/$,c}function F(k,$){return k[0]*$[0]+k[1]*$[1]+k[2]*$[2]+k[3]*$[3]}function s(k,$,A,c){let b=c??new e(4);return b[0]=k[0]+A*($[0]-k[0]),b[1]=k[1]+A*($[1]-k[1]),b[2]=k[2]+A*($[2]-k[2]),b[3]=k[3]+A*($[3]-k[3]),b}function p(k){let $=k[0],A=k[1],c=k[2],b=k[3];return Math.sqrt($*$+A*A+c*c+b*b)}let _=p;function M(k){let $=k[0],A=k[1],c=k[2],b=k[3];return $*$+A*A+c*c+b*b}let T=M;function I(k,$){let A=$??new e(4),c=k[0],b=k[1],w=k[2],E=k[3],R=Math.sqrt(c*c+b*b+w*w+E*E);return R>1e-5?(A[0]=c/R,A[1]=b/R,A[2]=w/R,A[3]=E/R):(A[0]=0,A[1]=0,A[2]=0,A[3]=1),A}function O(k,$){return Math.abs(k[0]-$[0])<_t&&Math.abs(k[1]-$[1])<_t&&Math.abs(k[2]-$[2])<_t&&Math.abs(k[3]-$[3])<_t}function P(k,$){return k[0]===$[0]&&k[1]===$[1]&&k[2]===$[2]&&k[3]===$[3]}function l(k){let $=k??new e(4);return $[0]=0,$[1]=0,$[2]=0,$[3]=1,$}let U=t.create(),ot=t.create(),at=t.create();function ut(k,$,A){let c=A??new e(4),b=t.dot(k,$);return b<-.999999?(t.cross(ot,k,U),t.len(U)<1e-6&&t.cross(at,k,U),t.normalize(U,U),o(U,Math.PI,c),c):b>.999999?(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c):(t.cross(k,$,U),c[0]=U[0],c[1]=U[1],c[2]=U[2],c[3]=1+b,I(c,c))}let ft=new e(4),yt=new e(4);function vt(k,$,A,c,b,w){let E=w??new e(4);return m(k,c,b,ft),m($,A,b,yt),m(ft,yt,2*b*(1-b),E),E}return{create:n,fromValues:r,set:i,fromAxisAngle:o,toAxisAngle:a,angle:f,multiply:h,mul:v,rotateX:d,rotateY:D,rotateZ:X,slerp:m,inverse:G,conjugate:q,fromMat:N,fromEuler:Y,copy:K,clone:Q,add:tt,subtract:H,sub:W,mulScalar:st,scale:et,divScalar:rt,dot:F,lerp:s,length:p,len:_,lengthSq:M,lenSq:T,normalize:I,equalsApproximately:O,equals:P,identity:l,rotationTo:ut,sqlerp:vt}}var Pi=new Map;function fu(e){let t=Pi.get(e);return t||(t=uu(e),Pi.set(e,t)),t}function cu(e){function t(A,c,b,w){let E=new e(4);return A!==void 0&&(E[0]=A,c!==void 0&&(E[1]=c,b!==void 0&&(E[2]=b,w!==void 0&&(E[3]=w)))),E}let n=t;function r(A,c,b,w,E){let R=E??new e(4);return R[0]=A,R[1]=c,R[2]=b,R[3]=w,R}function i(A,c){let b=c??new e(4);return b[0]=Math.ceil(A[0]),b[1]=Math.ceil(A[1]),b[2]=Math.ceil(A[2]),b[3]=Math.ceil(A[3]),b}function o(A,c){let b=c??new e(4);return b[0]=Math.floor(A[0]),b[1]=Math.floor(A[1]),b[2]=Math.floor(A[2]),b[3]=Math.floor(A[3]),b}function a(A,c){let b=c??new e(4);return b[0]=Math.round(A[0]),b[1]=Math.round(A[1]),b[2]=Math.round(A[2]),b[3]=Math.round(A[3]),b}function f(A,c=0,b=1,w){let E=w??new e(4);return E[0]=Math.min(b,Math.max(c,A[0])),E[1]=Math.min(b,Math.max(c,A[1])),E[2]=Math.min(b,Math.max(c,A[2])),E[3]=Math.min(b,Math.max(c,A[3])),E}function h(A,c,b){let w=b??new e(4);return w[0]=A[0]+c[0],w[1]=A[1]+c[1],w[2]=A[2]+c[2],w[3]=A[3]+c[3],w}function v(A,c,b,w){let E=w??new e(4);return E[0]=A[0]+c[0]*b,E[1]=A[1]+c[1]*b,E[2]=A[2]+c[2]*b,E[3]=A[3]+c[3]*b,E}function d(A,c,b){let w=b??new e(4);return w[0]=A[0]-c[0],w[1]=A[1]-c[1],w[2]=A[2]-c[2],w[3]=A[3]-c[3],w}let D=d;function X(A,c){return Math.abs(A[0]-c[0])<_t&&Math.abs(A[1]-c[1])<_t&&Math.abs(A[2]-c[2])<_t&&Math.abs(A[3]-c[3])<_t}function m(A,c){return A[0]===c[0]&&A[1]===c[1]&&A[2]===c[2]&&A[3]===c[3]}function G(A,c,b,w){let E=w??new e(4);return E[0]=A[0]+b*(c[0]-A[0]),E[1]=A[1]+b*(c[1]-A[1]),E[2]=A[2]+b*(c[2]-A[2]),E[3]=A[3]+b*(c[3]-A[3]),E}function q(A,c,b,w){let E=w??new e(4);return E[0]=A[0]+b[0]*(c[0]-A[0]),E[1]=A[1]+b[1]*(c[1]-A[1]),E[2]=A[2]+b[2]*(c[2]-A[2]),E[3]=A[3]+b[3]*(c[3]-A[3]),E}function N(A,c,b){let w=b??new e(4);return w[0]=Math.max(A[0],c[0]),w[1]=Math.max(A[1],c[1]),w[2]=Math.max(A[2],c[2]),w[3]=Math.max(A[3],c[3]),w}function Y(A,c,b){let w=b??new e(4);return w[0]=Math.min(A[0],c[0]),w[1]=Math.min(A[1],c[1]),w[2]=Math.min(A[2],c[2]),w[3]=Math.min(A[3],c[3]),w}function K(A,c,b){let w=b??new e(4);return w[0]=A[0]*c,w[1]=A[1]*c,w[2]=A[2]*c,w[3]=A[3]*c,w}let Q=K;function tt(A,c,b){let w=b??new e(4);return w[0]=A[0]/c,w[1]=A[1]/c,w[2]=A[2]/c,w[3]=A[3]/c,w}function H(A,c){let b=c??new e(4);return b[0]=1/A[0],b[1]=1/A[1],b[2]=1/A[2],b[3]=1/A[3],b}let W=H;function st(A,c){return A[0]*c[0]+A[1]*c[1]+A[2]*c[2]+A[3]*c[3]}function et(A){let c=A[0],b=A[1],w=A[2],E=A[3];return Math.sqrt(c*c+b*b+w*w+E*E)}let rt=et;function F(A){let c=A[0],b=A[1],w=A[2],E=A[3];return c*c+b*b+w*w+E*E}let s=F;function p(A,c){let b=A[0]-c[0],w=A[1]-c[1],E=A[2]-c[2],R=A[3]-c[3];return Math.sqrt(b*b+w*w+E*E+R*R)}let _=p;function M(A,c){let b=A[0]-c[0],w=A[1]-c[1],E=A[2]-c[2],R=A[3]-c[3];return b*b+w*w+E*E+R*R}let T=M;function I(A,c){let b=c??new e(4),w=A[0],E=A[1],R=A[2],V=A[3],C=Math.sqrt(w*w+E*E+R*R+V*V);return C>1e-5?(b[0]=w/C,b[1]=E/C,b[2]=R/C,b[3]=V/C):(b[0]=0,b[1]=0,b[2]=0,b[3]=0),b}function O(A,c){let b=c??new e(4);return b[0]=-A[0],b[1]=-A[1],b[2]=-A[2],b[3]=-A[3],b}function P(A,c){let b=c??new e(4);return b[0]=A[0],b[1]=A[1],b[2]=A[2],b[3]=A[3],b}let l=P;function U(A,c,b){let w=b??new e(4);return w[0]=A[0]*c[0],w[1]=A[1]*c[1],w[2]=A[2]*c[2],w[3]=A[3]*c[3],w}let ot=U;function at(A,c,b){let w=b??new e(4);return w[0]=A[0]/c[0],w[1]=A[1]/c[1],w[2]=A[2]/c[2],w[3]=A[3]/c[3],w}let ut=at;function ft(A){let c=A??new e(4);return c[0]=0,c[1]=0,c[2]=0,c[3]=0,c}function yt(A,c,b){let w=b??new e(4),E=A[0],R=A[1],V=A[2],C=A[3];return w[0]=c[0]*E+c[4]*R+c[8]*V+c[12]*C,w[1]=c[1]*E+c[5]*R+c[9]*V+c[13]*C,w[2]=c[2]*E+c[6]*R+c[10]*V+c[14]*C,w[3]=c[3]*E+c[7]*R+c[11]*V+c[15]*C,w}function vt(A,c,b){let w=b??new e(4);return I(A,w),K(w,c,w)}function k(A,c,b){let w=b??new e(4);return et(A)>c?vt(A,c,w):P(A,w)}function $(A,c,b){let w=b??new e(4);return G(A,c,.5,w)}return{create:t,fromValues:n,set:r,ceil:i,floor:o,round:a,clamp:f,add:h,addScaled:v,subtract:d,sub:D,equalsApproximately:X,equals:m,lerp:G,lerpV:q,max:N,min:Y,mulScalar:K,scale:Q,divScalar:tt,inverse:H,invert:W,dot:st,length:et,len:rt,lengthSq:F,lenSq:s,distance:p,dist:_,distanceSq:M,distSq:T,normalize:I,negate:O,copy:P,clone:l,multiply:U,mul:ot,divide:at,div:ut,zero:ft,transformMat4:yt,setLength:vt,truncate:k,midpoint:$}}var Di=new Map;function lu(e){let t=Di.get(e);return t||(t=cu(e),Di.set(e,t)),t}function vn(e,t,n,r,i,o){return{mat3:ou(e),mat4:su(t),quat:fu(n),vec2:Fi(r),vec3:pr(i),vec4:lu(o)}}var{mat3:Me,mat4:Tt,quat:z1,vec2:Lt,vec3:fe,vec4:Ce}=vn(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:E1,mat4:I1,quat:L1,vec2:R1,vec3:G1,vec4:O1}=vn(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:V1,mat4:q1,quat:N1,vec2:m1,vec3:C1,vec4:X1}=vn(eu,Array,Array,Array,Array,Array);var gr=class{device;format="r8unorm";downsizeFactor;multisample;textureSimple;textureMultisampled=null;renderPipeline;bindgroup;uniformsBuffer;trianglesBuffer;constructor(t){this.device=t.device,this.downsizeFactor=t.blurFactor,this.multisample=this.downsizeFactor>1?4:1,[this.textureSimple,this.textureMultisampled]=this.createTextures(t.width,t.height),this.trianglesBuffer=t.trianglesBuffer;let n=this.device.createShaderModule({label:"DisplacementTexture shader module",code:bi});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementTexture renderpipeline",layout:"auto",vertex:{module:n,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x2"}],arrayStride:2*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"}]},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:this.format}]},primitive:{cullMode:"none",topology:"triangle-list"},multisample:{count:this.multisample}}),this.uniformsBuffer=this.device.createBuffer({label:"DisplacementTexture uniforms buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bindgroup=this.device.createBindGroup({label:"DisplacementTexture bindgroup",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformsBuffer}}]})}update(t){let n=this.textureMultisampled??this.textureSimple,r={view:n.view,clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"};this.textureMultisampled&&(r.resolveTarget=this.textureSimple.view);let i=t.beginRenderPass({label:"DisplacementTexture render to texture renderpass",colorAttachments:[r]}),[o,a]=[n.texture.width,n.texture.height];i.setViewport(0,0,o,a,0,1),i.setScissorRect(0,0,o,a),i.setPipeline(this.renderPipeline),i.setBindGroup(0,this.bindgroup),i.setVertexBuffer(0,this.trianglesBuffer.bufferGpu),i.draw(3*this.trianglesBuffer.spriteCount),i.end()}resize(t,n){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),[this.textureSimple,this.textureMultisampled]=this.createTextures(t,n)}setViewport(t){let n=[1,1,1],r=0,i=[1,1,0],o=Tt.identity();Tt.multiply(Tt.scaling(n),o,o),Tt.multiply(Tt.rotationZ(r),o,o),Tt.multiply(Tt.translation(i),o,o);let a=Tt.translation([-t.position[0],-t.position[1],0]),f=t.width/t.zoom,h=t.height/t.zoom,v=Tt.ortho(0,f,h,0,-10,10),d=Tt.identity();Tt.multiply(a,o,d),Tt.multiply(v,d,d),this.device.queue.writeBuffer(this.uniformsBuffer,0,d)}getView(){return this.textureSimple.view}destroy(){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),this.uniformsBuffer.destroy()}createTextures(t,n){let r=this.device.createTexture({label:"DisplacementTexture texture",size:[Math.ceil(t/this.downsizeFactor),Math.ceil(n/this.downsizeFactor)],format:this.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),i={texture:r,view:r.createView({label:"DisplacementTexture texture view"})},o=null;if(this.multisample>1){let a=this.device.createTexture({label:"DisplacementTexture texture multisampled",size:[r.width,r.height],format:r.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.multisample});o={texture:a,view:a.createView({label:"DisplacementTexture texture multisampled view"})}}return[i,o]}};function Pe(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}var dr=class{device;floatsPerSprite=6;bufferGpu;bufferNeedsUpdate=!1;sprites=new Map;get spriteCount(){return this.sprites.size}constructor(t){this.device=t.device,this.bufferGpu=this.device.createBuffer({size:t.maxSpriteCount*this.floatsPerSprite*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})}destroy(){this.bufferGpu.destroy}update(){if(this.bufferNeedsUpdate){let t=[];for(let r of this.sprites.values())t.push(...r);let n=new Float32Array(t);this.device.queue.writeBuffer(this.bufferGpu,0,n)}}addTriangle(t){let n=Pe();if(this.sprites.has(n))throw new Error(`Duplicate triangle "${n}".`);let r=this.buildTriangleData(t);return this.sprites.set(n,r),this.bufferNeedsUpdate=!0,n}removeTriangle(t){if(!this.sprites.has(t))throw new Error(`Unknown triangle "${t}".`);this.sprites.delete(t),this.bufferNeedsUpdate=!0}setTriangle(t,n){if(!this.sprites.has(t))throw new Error(`Unknown triangle "${t}".`);let r=this.buildTriangleData(n);this.sprites.set(t,r),this.bufferNeedsUpdate=!0}buildTriangleData(t){return[t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1]]}};var Ui={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(e,t={}){return hu(e,t)},onRun:function(e,t,n){vu(e,t,n)},onDestroy:function(e,t){pu(t)},onResize:function(e,t){t.data.displacementTexture.resize(e.viewport.width,e.viewport.height),t.data.displacementComposition.setColorTextureView(t.refs.color.data.view),t.data.displacementComposition.setNoiseMapTextureView(t.refs.map.view),t.data.displacementComposition.setDisplacementTextureView(t.data.displacementTexture.getView())},onViewportPosition:function(e,t){t.data.displacementTexture.setViewport(e.viewport)},customFunctions:{addTriangle:function(e,t,n){return t.data.trianglesBuffer.addTriangle(n)},removeTriangle:function(e,t,n){t.data.trianglesBuffer.removeTriangle(n)},setPosition:function(e,t,n,r){t.data.trianglesBuffer.setTriangle(n,r)}}};async function hu(e,t){let{device:n}=e,r=new vr({device:n,initialParameters:{offsetX:t.options.offseyX??0,offsetY:t.options.offseyY??0,scale:t.options.scale??20}}),i=256,o=new dr({device:n,maxSpriteCount:i}),a=new gr({device:n,width:e.viewport.width,height:e.viewport.height,blurFactor:8,trianglesBuffer:o}),f=new hr({device:n,targetFormat:Nt(e),colorTextureView:t.refs.color.data.view,noiseMapTextureView:t.refs.map.view,displacementTextureView:a.getView(),displacementParametersBuffer:r});return{displacementParameters:r,displacementTexture:a,displacementComposition:f,trianglesBuffer:o}}function vu(e,t,n){if(t.data.trianglesBuffer.spriteCount===0)return;t.data.trianglesBuffer.update(),t.data.displacementTexture.update(n);let i=n.beginRenderPass({label:"displacement",colorAttachments:[{view:t.refs.out,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});i.executeBundles([t.data.displacementComposition.getRenderBundle()]),i.end()}function pu(e){e.data.trianglesBuffer.destroy(),e.data.trianglesBuffer=null,e.data.displacementParameters.destroy(),e.data.displacementParameters=null,e.data.displacementTexture.destroy(),e.data.displacementTexture=null,e.data.displacementComposition.destroy(),e.data.displacementComposition=null}var pn="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var zi={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"PREFERRED_TEXTURE_FORMAT",access:"read"},{name:"out",type:"cobaltTexture",format:"PREFERRED_TEXTURE_FORMAT",access:"write"}],onInit:async function(e,t={}){return gu(e,t)},onRun:function(e,t,n){du(e,t,n)},onDestroy:function(e,t){},onResize:function(e,t){wu(e,t)},onViewportPosition:function(e,t){}};async function gu(e,t){let{device:n}=e,r=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),i=n.createBindGroup({layout:r,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]}),o=n.createPipelineLayout({bindGroupLayouts:[r]}),a=n.createRenderPipeline({label:"fb-blit",vertex:{module:n.createShaderModule({code:pn}),entryPoint:"vs_main",buffers:[]},fragment:{module:n.createShaderModule({code:pn}),entryPoint:"fs_main",targets:[{format:Nt(e),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:o});return{bindGroupLayout:r,bindGroup:i,pipeline:a}}function du(e,t,n){let{device:r}=e,i=n.beginRenderPass({label:"fb-blit",colorAttachments:[{view:t.refs.out,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});i.setPipeline(t.data.pipeline),i.setBindGroup(0,t.data.bindGroup),i.draw(3),i.end()}function wu(e,t){let{device:n}=e;t.data.bindGroup=n.createBindGroup({layout:t.data.bindGroupLayout,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]})}var Ei={type:"fbTexture",refs:[],onInit:async function(e,t={}){return xu(e,t)},onRun:function(e,t,n){},onDestroy:function(e,t){Ii(t)},onResize:function(e,t){yu(e,t)},onViewportPosition:function(e,t){}};async function xu(e,t){let{device:n}=e;t.options.format=t.options.format==="PREFERRED_TEXTURE_FORMAT"?Nt(e):t.options.format;let{format:r,label:i,mip_count:o,usage:a,viewportScale:f}=t.options;return ne(n,i,e.viewport.width*f,e.viewport.height*f,o,r,a)}function Ii(e){e.data.texture.destroy()}function yu(e,t){let{device:n}=e;Ii(t);let{width:r,height:i}=e.viewport,{options:o}=t,a=t.options.viewportScale;t.data=ne(n,o.label,r*a,i*a,o.mip_count,o.format,o.usage)}var ae=class e{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(t,n){this.device=t,this.maxLightsCount=n;let r=new ArrayBuffer(e.computeBufferBytesLength(n)),i=t.createBuffer({label:"LightsBuffer buffer",size:r.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:r,bufferGpu:i},this.setLights([])}setLights(t){if(t.length>this.maxLightsCount)throw new Error(`Too many lights "${t.length}", max is "${this.maxLightsCount}".`);let n=e.computeBufferBytesLength(t.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([t.length]),t.forEach((r,i)=>{new Float32Array(this.buffer.bufferCpu,e.structs.lightsBuffer.lights.offset+e.structs.lightsBuffer.lights.stride*i,9).set([...r.color,r.radius,...r.position,r.intensity,r.attenuationLinear,r.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,n),this.currentLightsCount=t.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(t){return e.structs.lightsBuffer.lights.offset+e.structs.lightsBuffer.lights.stride*t}};var wr=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(t,n,r,i){this.lightsBuffer=n;let o=t.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${ae.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${r.gridSize.x}, ${r.gridSize.y});
const cellsGridSizeF = vec2<f32>(${r.gridSize.x}, ${r.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${i}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=t.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:o,entryPoint:"main_vertex"},fragment:{module:o,entryPoint:"main_fragment",targets:[{format:r.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:r.sampleCount}}),this.bindgroup=t.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let a=t.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[r.format],sampleCount:r.sampleCount});a.setPipeline(this.renderPipeline),a.setBindGroup(0,this.bindgroup),a.draw(4),this.renderBundle=a.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var xr=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(t,n,r,i){this.device=t,this.lightsBuffer=n;let o=!0,a=t.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${r.gridSize.x}, ${r.gridSize.y});
const cellsGridSizeF = vec2<f32>(${r.gridSize.x}, ${r.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${i});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=t.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:a,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:ae.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:ae.structs.light.position.offset,format:"float32x2"}],arrayStride:ae.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:a,entryPoint:"main_fragment",targets:[{format:r.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:o?"none":"back",topology:"triangle-list"},multisample:{count:r.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:t.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[r.format],sampleCount:r.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(t){let n=[],r=[];for(let v of t){let d=n.length/3;n.push(...v[0],0,...v[1],0,...v[0],1,...v[1],1),r.push(d+0,d+1,d+3,d+0,d+3,d+2)}let i=!1,o=new Float32Array(n),a=this.obstacles?.positionsBufferGpu;(!a||a.size<o.byteLength)&&(a?.destroy(),a=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:o.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),i=!0),this.device.queue.writeBuffer(a,0,o);let f=new Uint16Array(r),h=this.obstacles?.indexBufferGpu;(!h||h.size<f.byteLength)&&(h?.destroy(),h=this.device.createBuffer({label:"LightsTextureMask index buffer",size:f.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),i=!0),this.device.queue.writeBuffer(h,0,f),this.obstacles={positionsBufferGpu:a,indexBufferGpu:h},this.setIndirectIndexCount(r.length),i&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(t){this.setIndirectInstanceCount(t)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(t){let n=new Uint32Array(this.indirectDrawing.bufferCpu);n[0]!==t&&(n[0]=t,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(t){let n=new Uint32Array(this.indirectDrawing.bufferCpu);n[1]!==t&&(n[1]=t,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let t=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(t.setPipeline(this.renderPipeline),t.setVertexBuffer(0,this.obstacles.positionsBufferGpu),t.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,ae.structs.lightsBuffer.lights.offset),t.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),t.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),t.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var yr=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(t,n,r){this.lightsBuffer=n;let i=this.lightsBuffer.maxLightsCount/4,o={x:Math.ceil(Math.sqrt(i)),y:0};o.y=Math.ceil(i/o.x),this.gridSize=o;let a={width:o.x*r.resolutionPerLight,height:o.y*r.resolutionPerLight},f=r.textureFormat;this.texture=t.createTexture({label:"LightsTextureMask texture",size:[a.width,a.height],format:f,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),r.antialiased&&(this.textureMultisampled=t.createTexture({label:"LightsTextureMask texture multisampled",size:[a.width,a.height],format:f,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let v={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};r.antialiased&&(v.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[v]};let d={gridSize:o,format:f,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new wr(t,n,d,r.maxLightSize),this.textureMask=new xr(t,n,d,r.maxLightSize)}update(t){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let n=t.beginRenderPass(this.textureRenderpassDescriptor),[r,i]=[this.texture.width,this.texture.height];n.setViewport(0,0,r,i,0,1),n.setScissorRect(0,0,r,i),n.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),n.end()}setObstacles(t){this.textureMask.setObstacles(t)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var Mr=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(t){this.device=t.device,this.targetTexture=t.targetTexture,this.lightsBuffer=t.lightsBuffer,this.lightsTexture=new yr(t.device,t.lightsBuffer,t.lightsTextureProperties),this.uniformsBufferGpu=t.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let n=t.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${ae.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/t.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${t.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=t.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:n,entryPoint:"main_vertex"},fragment:{module:n,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let r=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=t.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:r,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:t.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:t.lightsTextureProperties.filtering,minFilter:t.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(t.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(t){this.lightsTexture.update(t)}render(t,n){let r=new ArrayBuffer(80);new Float32Array(r,0,16).set(n),new Float32Array(r,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,r),t.executeBundles([this.renderBundle])}setAlbedo(t){this.bindgroup1=this.buildBindgroup1(t),this.renderBundle=this.buildRenderBundle()}setAmbientLight(t){this.ambientLight=[...t]}setObstacles(t){this.lightsTexture.setObstacles(t)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(t){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:t.view},{binding:1,resource:t.sampler}]})}buildRenderBundle(){let t=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return t.setPipeline(this.renderPipeline),t.setBindGroup(0,this.bindgroup0),t.setBindGroup(1,this.bindgroup1),t.draw(4),t.finish({label:"LightsRenderer renderbundle"})}};var gn={};hn(gn,{setAmbientLight:()=>bu,setLights:()=>Mu,setOccluders:()=>_u});function Mu(e,t,n){t.data.lights=n,t.data.lightsBufferNeedsUpdate=!0}function bu(e,t,n){t.data.lightsRenderer.setAmbientLight(n)}function _u(e,t,n){t.data.lightsRenderer.setObstacles(n),t.data.lightsTextureNeedsUpdate=!0}var br=class{invViewProjectionMatrix=Tt.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(t){this.setViewportSize(t.viewportSize.width,t.viewportSize.height);let n=t.center??this.topLeft;this.setTopLeft(...n);let r=t.zoom??1;this.setZoom(r)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(t,n){this.viewportSize.width=t,this.viewportSize.height=n,this.updateMatrices()}setTopLeft(t,n){this.topLeft[0]=t,this.topLeft[1]=n,this.updateMatrices()}setZoom(t){this.zoom=t,this.updateMatrices()}updateMatrices(){Tt.identity(this.invViewProjectionMatrix),Tt.multiply(Tt.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Tt.multiply(Tt.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Tt.multiply(Tt.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Tt.multiply(Tt.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var Li={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return Su(e,t)},onRun:function(e,t,n){Tu(e,t,n)},onDestroy:function(e,t){Bu(t)},onResize:function(e,t){Pu(e,t)},onViewportPosition:function(e,t){t.data.viewport.setTopLeft(...e.viewport.position)},customFunctions:{...gn}};async function Su(e,t){let{device:n}=e,r=256,i=256,o=new ae(n,r),a=new br({viewportSize:{width:e.viewport.width,height:e.viewport.height},center:e.viewport.position,zoom:e.viewport.zoom}),f=new Mr({device:n,albedo:{view:t.refs.in.data.view,sampler:t.refs.in.data.sampler},targetTexture:t.refs.out.data.texture,lightsBuffer:o,lightsTextureProperties:{resolutionPerLight:i,maxLightSize:i,antialiased:!1,filtering:"nearest",textureFormat:Nt(e)}});return{lightsBuffer:o,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:f,viewport:a,lights:[]}}function Tu(e,t,n){t.data.lightsBufferNeedsUpdate&&(t.data.lightsBuffer.setLights(t.data.lights),t.data.lightsBufferNeedsUpdate=!1,t.data.lightsTextureNeedsUpdate=!0);let r=t.data.lightsRenderer;t.data.lightsTextureNeedsUpdate&&(r.computeLightsTexture(n),t.data.lightsTextureNeedsUpdate=!1);let i=n.beginRenderPass({label:"light",colorAttachments:[{view:t.refs.out.data.view,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});t.data.viewport.setZoom(e.viewport.zoom);let o=t.data.viewport.invertViewProjectionMatrix;r.render(i,o),i.end()}function Bu(e){e.data.lightsBuffer.destroy(),e.data.lightsRenderer.destroy()}function Pu(e,t){t.data.lightsRenderer.setAlbedo({view:t.refs.in.data.view,sampler:t.refs.in.data.sampler}),t.data.viewport.setViewportSize(e.viewport.width,e.viewport.height)}function ge(e){return e>=0?Math.round(e):e%.5===0?Math.floor(e):Math.round(e)}var Ri="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";var vs=vi(co(),1);var hs=vi(ls(),1);function ti(e,t){if(!Array.isArray(e))throw new Error("poly-to-pslg: Error, invalid polygon");if(e.length===0)return{points:[],edges:[]};t=t||{};var n=!0;"nested"in t?n=!!t.nested:e[0].length===2&&typeof e[0][0]=="number"&&(n=!1),n||(e=[e]);for(var r=[],i=[],o=0;o<e.length;++o)for(var a=e[o],f=r.length,h=0;h<a.length;++h)r.push(a[h]),i.push([f+h,f+(h+1)%a.length]);var v="clean"in t?!0:!!t.clean;return v&&(0,hs.default)(r,i),{points:r,edges:i}}var ps={line:Re,save:function(e,t){t.data.transforms.push(Me.clone(t.data.transforms.at(-1)))},restore:function(e,t){t.data.transforms.length>1&&t.data.transforms.pop()},translate:function(e,t,n){let r=t.data.transforms.at(-1);Me.translate(r,n,r)},rotate:function(e,t,n){let r=t.data.transforms.at(-1);Me.rotate(r,n,r)},scale:function(e,t,n){let r=t.data.transforms.at(-1);Me.scale(r,n,r)},strokePath:function(e,t,n,r,i=1){for(let o of n)Re(e,t,o[0],o[1],r,i)},filledPath:function(e,t,n,r){let i=ti(n),o=(0,vs.default)(i.points,i.edges,{exterior:!1}),a=t.data.transforms.at(-1),f=t.data.vertexCount*6,h=t.data.vertexCount*6,v=o.length*3*6;t.data.vertices=Zr(Float32Array,t.data.vertices,h,v);let d=Lt.create();for(let D of o)Lt.transformMat3(n[D[0]],a,d),t.data.vertices[f+0]=d[0],t.data.vertices[f+1]=d[1],t.data.vertices[f+2]=r[0],t.data.vertices[f+3]=r[1],t.data.vertices[f+4]=r[2],t.data.vertices[f+5]=r[3],Lt.transformMat3(n[D[1]],a,d),t.data.vertices[f+6]=d[0],t.data.vertices[f+7]=d[1],t.data.vertices[f+8]=r[0],t.data.vertices[f+9]=r[1],t.data.vertices[f+10]=r[2],t.data.vertices[f+11]=r[3],Lt.transformMat3(n[D[2]],a,d),t.data.vertices[f+12]=d[0],t.data.vertices[f+13]=d[1],t.data.vertices[f+14]=r[0],t.data.vertices[f+15]=r[1],t.data.vertices[f+16]=r[2],t.data.vertices[f+17]=r[3],f+=18;t.data.vertexCount+=3*o.length,t.data.dirty=!0},ellipse:function(e,t,n,r,i,o,a,f=1){let[h,v]=n,d=2*Math.PI/o;for(let D=0;D<o;D++){let X=D*d,m=(D+1)*d,G=h+r*Math.cos(X),q=v+i*Math.sin(X),N=h+r*Math.cos(m),Y=v+i*Math.sin(m);Re(e,t,[G,q],[N,Y],a,f)}},filledEllipse:function(e,t,n,r,i,o,a){let[f,h]=n,v=2*Math.PI/o,d=t.data.vertexCount*6,D=o*3*6;t.data.vertices=Zr(Float32Array,t.data.vertices,d,D);let X=t.data.transforms.at(-1);for(let m=0;m<o;m++){let G=m*v,q=(m+1)*v,N=f+r*Math.cos(G),Y=h+i*Math.sin(G),K=f+r*Math.cos(q),Q=h+i*Math.sin(q),H=t.data.vertexCount*6+m*18,W=Lt.transformMat3([f,h],X);t.data.vertices[H+0]=W[0],t.data.vertices[H+1]=W[1],t.data.vertices[H+2]=a[0],t.data.vertices[H+3]=a[1],t.data.vertices[H+4]=a[2],t.data.vertices[H+5]=a[3],Lt.transformMat3([N,Y],X,W),t.data.vertices[H+6]=W[0],t.data.vertices[H+7]=W[1],t.data.vertices[H+8]=a[0],t.data.vertices[H+9]=a[1],t.data.vertices[H+10]=a[2],t.data.vertices[H+11]=a[3],Lt.transformMat3([K,Q],X,W),t.data.vertices[H+12]=W[0],t.data.vertices[H+13]=W[1],t.data.vertices[H+14]=a[0],t.data.vertices[H+15]=a[1],t.data.vertices[H+16]=a[2],t.data.vertices[H+17]=a[3]}t.data.vertexCount+=3*o,t.data.dirty=!0},box:function(e,t,n,r,i,o,a=1){let[f,h]=n,v=r/2,d=i/2,D=[f-v,h-d],X=[f+v,h-d],m=[f-v,h+d],G=[f+v,h+d];Re(e,t,D,X,o,a),Re(e,t,m,G,o,a),Re(e,t,D,m,o,a),Re(e,t,X,G,o,a)},filledBox:function(e,t,n,r,i,o){let[a,f]=n,h=r/2,v=i/2,d=t.data.transforms.at(-1),D=Lt.transformMat3([a-h,f-v],d),X=Lt.transformMat3([a+h,f-v],d),m=Lt.transformMat3([a-h,f+v],d),G=Lt.transformMat3([a+h,f+v],d),q=t.data.vertexCount*6,N=36;t.data.vertices=Zr(Float32Array,t.data.vertices,q,N);let Y=t.data.vertexCount*6;t.data.vertices[Y+0]=D[0],t.data.vertices[Y+1]=D[1],t.data.vertices[Y+2]=o[0],t.data.vertices[Y+3]=o[1],t.data.vertices[Y+4]=o[2],t.data.vertices[Y+5]=o[3],t.data.vertices[Y+6]=m[0],t.data.vertices[Y+7]=m[1],t.data.vertices[Y+8]=o[0],t.data.vertices[Y+9]=o[1],t.data.vertices[Y+10]=o[2],t.data.vertices[Y+11]=o[3],t.data.vertices[Y+12]=X[0],t.data.vertices[Y+13]=X[1],t.data.vertices[Y+14]=o[0],t.data.vertices[Y+15]=o[1],t.data.vertices[Y+16]=o[2],t.data.vertices[Y+17]=o[3],t.data.vertices[Y+18]=m[0],t.data.vertices[Y+19]=m[1],t.data.vertices[Y+20]=o[0],t.data.vertices[Y+21]=o[1],t.data.vertices[Y+22]=o[2],t.data.vertices[Y+23]=o[3],t.data.vertices[Y+24]=G[0],t.data.vertices[Y+25]=G[1],t.data.vertices[Y+26]=o[0],t.data.vertices[Y+27]=o[1],t.data.vertices[Y+28]=o[2],t.data.vertices[Y+29]=o[3],t.data.vertices[Y+30]=X[0],t.data.vertices[Y+31]=X[1],t.data.vertices[Y+32]=o[0],t.data.vertices[Y+33]=o[1],t.data.vertices[Y+34]=o[2],t.data.vertices[Y+35]=o[3],t.data.vertexCount+=6,t.data.dirty=!0},clear:function(e,t){t.data.vertexCount=0,t.data.transforms.length=1,Me.identity(t.data.transforms[0]),t.data.dirty=!0}};function Re(e,t,n,r,i,o=1){let a=t.data.transforms.at(-1);n=Lt.transformMat3(n,a),r=Lt.transformMat3(r,a);let f=Lt.sub(r,n),h=Lt.normalize(f),v=Uc(h),d=o/2,D=t.data.vertexCount*6,X=t.data.vertexCount*6,m=36;t.data.vertices=Zr(Float32Array,t.data.vertices,X,m),t.data.vertices[D+0]=n[0]+v[0]*d,t.data.vertices[D+1]=n[1]+v[1]*d,t.data.vertices[D+2]=i[0],t.data.vertices[D+3]=i[1],t.data.vertices[D+4]=i[2],t.data.vertices[D+5]=i[3],t.data.vertices[D+6]=n[0]-v[0]*d,t.data.vertices[D+7]=n[1]-v[1]*d,t.data.vertices[D+8]=i[0],t.data.vertices[D+9]=i[1],t.data.vertices[D+10]=i[2],t.data.vertices[D+11]=i[3],t.data.vertices[D+12]=r[0]+v[0]*d,t.data.vertices[D+13]=r[1]+v[1]*d,t.data.vertices[D+14]=i[0],t.data.vertices[D+15]=i[1],t.data.vertices[D+16]=i[2],t.data.vertices[D+17]=i[3],t.data.vertices[D+18]=n[0]-v[0]*d,t.data.vertices[D+19]=n[1]-v[1]*d,t.data.vertices[D+20]=i[0],t.data.vertices[D+21]=i[1],t.data.vertices[D+22]=i[2],t.data.vertices[D+23]=i[3],t.data.vertices[D+24]=r[0]+v[0]*d,t.data.vertices[D+25]=r[1]+v[1]*d,t.data.vertices[D+26]=i[0],t.data.vertices[D+27]=i[1],t.data.vertices[D+28]=i[2],t.data.vertices[D+29]=i[3],t.data.vertices[D+30]=r[0]-v[0]*d,t.data.vertices[D+31]=r[1]-v[1]*d,t.data.vertices[D+32]=i[0],t.data.vertices[D+33]=i[1],t.data.vertices[D+34]=i[2],t.data.vertices[D+35]=i[3],t.data.vertexCount+=6,t.data.dirty=!0}function Zr(e,t,n,r){if(n+r<=t.length)return t;let i=t.length*2,o=16*1024*1024/t.BYTES_PER_ELEMENT;if(i>o)throw new Error("vertices exceed max array size");let a=new e(i);return a.set(t),a}function Uc(e){return[-e[1],e[0]]}var gs=fe.create(0,0,0),ds=Tt.identity(),ws=Tt.identity(),ys={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"PREFERRED_TEXTURE_VIEW",access:"write"}],onInit:async function(e,t={}){return zc(e,t)},onRun:function(e,t,n){Ec(e,t,n)},onDestroy:function(e,t){Ic(t)},onResize:function(e,t){xs(e,t)},onViewportPosition:function(e,t){xs(e,t)},customFunctions:ps};async function zc(e,t){let{device:n}=e,r=new Float32Array(1024),i=n.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),o=n.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=n.createShaderModule({code:Ri}),f=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),h=n.createPipelineLayout({bindGroupLayouts:[f]}),v=n.createBindGroup({layout:f,entries:[{binding:0,resource:{buffer:o}}]}),d=n.createRenderPipeline({label:"primitives",layout:h,vertex:{module:a,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:a,entryPoint:"fs_main",targets:[{format:Nt(e),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:o,vertexBuffer:i,pipeline:d,bindGroup:v,vertexCount:0,dirty:!1,vertices:r,transforms:[Me.identity()]}}function Ec(e,t,n){if(t.data.vertexCount===0)return;let{device:r}=e;if(t.data.dirty){t.data.dirty=!1;let a=6*Float32Array.BYTES_PER_ELEMENT;t.data.vertices.buffer.byteLength>t.data.vertexBuffer.size&&(t.data.vertexBuffer.destroy(),t.data.vertexBuffer=r.createBuffer({size:t.data.vertices.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}));let f=t.data.vertexCount*a;if(f>t.data.vertexBuffer.size){console.error("too many primitives, bailing");return}e.device.queue.writeBuffer(t.data.vertexBuffer,0,t.data.vertices.buffer,0,f)}let i=t.options.loadOp||"load",o=n.beginRenderPass({label:"primitives",colorAttachments:[{view:t.refs.color,clearValue:e.clearValue,loadOp:i,storeOp:"store"}]});o.setPipeline(t.data.pipeline),o.setBindGroup(0,t.data.bindGroup),o.setVertexBuffer(0,t.data.vertexBuffer),o.draw(t.data.vertexCount),o.end()}function Ic(e){e.data.vertexBuffer.destroy(),e.data.vertexBuffer=null,e.data.uniformBuffer.destroy(),e.data.uniformBuffer=null,e.data.transforms.length=0}function xs(e,t){let{device:n}=e,r=e.viewport.width/e.viewport.zoom,i=e.viewport.height/e.viewport.zoom;Tt.ortho(0,r,i,0,-10,10,ds),fe.set(-e.viewport.position[0]-1,-e.viewport.position[1]-1,0,gs),Tt.translation(gs,ws),n.queue.writeBuffer(t.data.uniformBuffer,0,ws.buffer),n.queue.writeBuffer(t.data.uniformBuffer,64,ds.buffer)}var ei="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Ms={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"PREFERRED_TEXTURE_FORMAT",access:"write"}],onInit:async function(e,t={}){return Lc(e,t)},onRun:function(e,t,n){Rc(e,t,n)},onDestroy:function(e,t){},onResize:function(e,t){Gc(e,t)},onViewportPosition:function(e,t){}};function Lc(e,t){let{options:n,refs:r}=t,{device:i}=e,o=Nt(e),a=n.bloom_intensity??40,f=n.bloom_combine_constant??.68,h=new Float32Array([a,f]),v=i.createBuffer({label:"scene composite params buffer",size:h.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(v.getMappedRange()).set(h),v.unmap();let d=i.createRenderPipeline({label:"scene-composite",layout:"auto",vertex:{module:i.createShaderModule({code:ei}),entryPoint:"vert_main"},fragment:{module:i.createShaderModule({code:ei}),entryPoint:"frag_main",targets:[{format:o}]},primitive:{topology:"triangle-list"}});return{bindGroup:i.createBindGroup({layout:d.getBindGroupLayout(0),entries:[{binding:0,resource:r.hdr.data.sampler},{binding:1,resource:r.hdr.data.view},{binding:2,resource:r.bloom.data.mip_view[0]},{binding:3,resource:{buffer:v}}]}),pipeline:d,params_buf:v}}function Rc(e,t,n){let r=n.beginRenderPass({label:"scene-composite",colorAttachments:[{view:t.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:i,bindGroup:o}=t.data;r.setPipeline(i),r.setBindGroup(0,o),r.draw(3),r.end()}function Gc(e,t){let{pipeline:n,params_buf:r}=t.data,{device:i}=e;t.data.bindGroup=i.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:t.refs.hdr.data.sampler},{binding:1,resource:t.refs.hdr.data.view},{binding:2,resource:t.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:r}}]})}var ri={};hn(ri,{addSprite:()=>Oc,clear:()=>qc,removeSprite:()=>Vc,setSpriteName:()=>Nc,setSpriteOpacity:()=>Xc,setSpritePosition:()=>mc,setSpriteRotation:()=>kc,setSpriteScale:()=>Yc,setSpriteTint:()=>Cc});function Oc(e,t,n,r,i,o,a,f){let{idByName:h}=t.refs.spritesheet.data;return t.data.sprites.push({position:Lt.clone(r),sizeX:1,sizeY:1,scale:Lt.clone(i),rotation:f,opacity:a,tint:Ce.clone(o),spriteID:h.get(n),id:Pe()}),t.data.sprites.at(-1).id}function Vc(e,t,n){for(let r=0;r<t.data.sprites.length;r++)if(t.data.sprites[r].id===n){t.data.sprites.splice(r,1);return}}function qc(e,t){t.data.sprites.length=0}function Nc(e,t,n,r){let i=t.data.sprites,o=i.length;for(let a=0;a<o;a++)if(i[a].id===n){i[a].spriteID=t.refs.spritesheet.data.idByName.get(r);return}}function mc(e,t,n,r){let i=t.data.sprites,o=i.length;for(let a=0;a<o;a++)if(i[a].id===n){Lt.copy(r,i[a].position);return}}function Cc(e,t,n,r){let i=t.data.sprites,o=i.length;for(let a=0;a<o;a++)if(i[a].id===n){Ce.copy(r,i[a].tint);return}}function Xc(e,t,n,r){let i=t.data.sprites,o=i.length;for(let a=0;a<o;a++)if(i[a].id===n){i[a].opacity=r;return}}function kc(e,t,n,r){let i=t.data.sprites,o=i.length;for(let a=0;a<o;a++)if(i[a].id===n){i[a].rotation=r;return}}function Yc(e,t,n,r){let i=t.data.sprites,o=i.length;for(let a=0;a<o;a++)if(i[a].id===n){Lt.copy(r,i[a].scale);return}}var bs="struct ViewParams{view:mat4x4<f32>,proj:mat4x4<f32>};@group(0)@binding(0)var<uniform> uView:ViewParams;@group(0)@binding(1)var uSampler:sampler;@group(0)@binding(2)var uTex:texture_2d<f32>;struct SpriteDesc{uvOrigin:vec2<f32>,uvSpan:vec2<f32>,frameSize:vec2<f32>,centerOffset:vec2<f32>,};@group(0)@binding(3)var<storage,read>Sprites:array<SpriteDesc>;struct VSOut{@builtin(position)pos:vec4<f32>,@location(0)uv:vec2<f32>,@location(1)tint:vec4<f32>,@location(2)opacity:f32,};const corners=array<vec2<f32>,4>(vec2<f32>(-0.5,-0.5),vec2<f32>(0.5,-0.5),vec2<f32>(-0.5,0.5),vec2<f32>(0.5,0.5),);const uvBase=array<vec2<f32>,4>(vec2<f32>(0.0,0.0),vec2<f32>(1.0,0.0),vec2<f32>(0.0,1.0),vec2<f32>(1.0,1.0),);@vertex fn vs_main(@builtin(vertex_index)vid:u32,@location(0)i_pos:vec2<f32>,@location(1)i_size:vec2<f32>,@location(2)i_scale:vec2<f32>,@location(3)i_tint:vec4<f32>,@location(4)i_spriteId:u32,@location(5)i_opacity:f32,@location(6)i_rotation:f32)->VSOut{let rot=i_rotation;let c=cos(rot);let s=sin(rot);let d=Sprites[i_spriteId];let corner=corners[vid];let sizePx=d.frameSize*i_size*i_scale;var local=corner*sizePx;local+=d.centerOffset*i_scale;let rotated=vec2<f32>(local.x*c-local.y*s,local.x*s+local.y*c);let world=vec4<f32>(rotated+i_pos,0.0,1.0);var out:VSOut;out.pos=uView.proj*uView.view*world;out.uv=d.uvOrigin+d.uvSpan*uvBase[vid];out.tint=i_tint;out.opacity=i_opacity;return out;}@fragment fn fs_main(in:VSOut)->@location(0)vec4<f32>{let texel=textureSample(uTex,uSampler,in.uv);return vec4<f32>(texel.rgb*(1.0-in.tint.a)+(in.tint.rgb*in.tint.a),texel.a*in.opacity);}";var ni=fe.create(0,0,0),_s=Tt.identity(),Ss=Tt.identity(),Ge=64,ii=0,oi=8,ai=16,fr=24,Bs=40,Ps=44,Ds=48,Fs={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return Hc(e,t)},onRun:function(e,t,n){$c(e,t,n)},onDestroy:function(e,t){try{t.data.instanceBuf?.destroy()}catch{}try{t.data.spriteBuf?.destroy()}catch{}try{t.data.uniformBuffer?.destroy()}catch{}t.data.pipeline=null,t.data.bindGroup=null,t.data.bindGroupLayout=null,t.data.instanceStaging=null,t.data.instanceView=null,t.data.sprites.length=0,t.data.visible.length=0},onResize:function(e,t){Ts(e,t)},onViewportPosition:function(e,t){Ts(e,t)},customFunctions:{...ri}};async function Hc(e,t){let{device:n}=e,{descs:r,names:i}=t.refs.spritesheet.data.spritesheet,o=n.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=32,f=new ArrayBuffer(a*r.length),h=new Float32Array(f);for(let tt=0;tt<r.length;tt++){let H=r[tt],W=tt*8;h[W+0]=H.UvOrigin[0],h[W+1]=H.UvOrigin[1],h[W+2]=H.UvSpan[0],h[W+3]=H.UvSpan[1],h[W+4]=H.FrameSize[0],h[W+5]=H.FrameSize[1],h[W+6]=H.CenterOffset[0],h[W+7]=H.CenterOffset[1]}let v=n.createBuffer({label:"sprite desc table",size:Math.max(16,f.byteLength),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});n.queue.writeBuffer(v,0,f);let d=1024,D=n.createBuffer({label:"sprite instances",size:Ge*d,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),X=new ArrayBuffer(Ge*d),m=new DataView(X),G=n.createShaderModule({code:bs}),q=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),N=n.createPipelineLayout({bindGroupLayouts:[q]}),Y={arrayStride:Ge,stepMode:"instance",attributes:[{shaderLocation:0,offset:ii,format:"float32x2"},{shaderLocation:1,offset:oi,format:"float32x2"},{shaderLocation:2,offset:ai,format:"float32x2"},{shaderLocation:3,offset:fr,format:"float32x4"},{shaderLocation:4,offset:Bs,format:"uint32"},{shaderLocation:5,offset:Ps,format:"float32"},{shaderLocation:6,offset:Ds,format:"float32"}]},K=n.createRenderPipeline({layout:N,vertex:{module:G,entryPoint:"vs_main",buffers:[Y]},fragment:{module:G,entryPoint:"fs_main",targets:[{format:Nt(e),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-strip",cullMode:"none"},multisample:{count:1}}),Q=n.createBindGroup({layout:q,entries:[{binding:0,resource:{buffer:o}},{binding:1,resource:t.refs.spritesheet.data.colorTexture.sampler},{binding:2,resource:t.refs.spritesheet.data.colorTexture.view},{binding:3,resource:{buffer:v}}]});return{sprites:[],visible:[],visibleCount:0,viewRect:{x:0,y:0,w:0,h:0},spriteBuf:v,uniformBuffer:o,instanceCap:d,instanceView:m,instanceBuf:D,instanceStaging:X,pipeline:K,bindGroup:Q}}function Zc(e,t,n){let{instanceCap:r}=t.data;if(n<=r)return;let i=r;for(i===0&&(i=1024);i<n;)i*=2;t.data.instanceBuf.destroy(),t.data.instanceBuf=e.device.createBuffer({size:Ge*i,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.data.instanceStaging=new ArrayBuffer(Ge*i),t.data.instanceView=new DataView(t.data.instanceStaging),t.data.instanceCap=i}function $c(e,t,n){let{device:r,context:i}=e,{instanceView:o,instanceBuf:a,instanceStaging:f,pipeline:h,bindGroup:v}=t.data,{descs:d}=t.refs.spritesheet.data.spritesheet,D=t.data.viewRect;D.x=e.viewport.position[0],D.y=e.viewport.position[1],D.w=e.viewport.width,D.h=e.viewport.height,t.data.visibleCount=0;for(let G of t.data.sprites){let q=d[G.spriteID];if(q){if(!t.options.isScreenSpace){let N=q.FrameSize[0]*G.sizeX*G.scale[0]*.5,Y=q.FrameSize[1]*G.sizeY*G.scale[1]*.5,K=Math.hypot(N,Y),Q=G.position[0],tt=G.position[1];if(Q+K<D.x||Q-K>D.x+D.w||tt+K<D.y||tt-K>D.y+D.h)continue}t.data.visible[t.data.visibleCount]=G,t.data.visibleCount++}}Zc(e,t,t.data.visibleCount);for(let G=0;G<t.data.visibleCount;G++){let q=G*Ge,N=t.data.visible[G],Y=N.tint;o.setFloat32(q+ii+0,N.position[0],!0),o.setFloat32(q+ii+4,N.position[1],!0),o.setFloat32(q+oi+0,N.sizeX,!0),o.setFloat32(q+oi+4,N.sizeY,!0),o.setFloat32(q+ai+0,N.scale[0],!0),o.setFloat32(q+ai+4,N.scale[1],!0),o.setFloat32(q+fr+0,Y[0],!0),o.setFloat32(q+fr+4,Y[1],!0),o.setFloat32(q+fr+8,Y[2],!0),o.setFloat32(q+fr+12,Y[3],!0),o.setUint32(q+Bs,N.spriteID>>>0,!0),o.setFloat32(q+Ps,N.opacity,!0),o.setFloat32(q+Ds,N.rotation,!0)}r.queue.writeBuffer(a,0,f,0,t.data.visibleCount*Ge);let X=t.options.loadOp||"load",m=n.beginRenderPass({label:"sprite renderpass",colorAttachments:[{view:t.refs.color,clearValue:e.clearValue,loadOp:X,storeOp:"store"}]});m.setPipeline(h),m.setBindGroup(0,v),m.setVertexBuffer(0,a),t.data.visibleCount&&m.draw(4,t.data.visibleCount,0,0),m.end()}function Ts(e,t){let{device:n,viewport:r}=e,i=r.width/r.zoom,o=r.height/r.zoom;Tt.ortho(0,i,o,0,-10,10,_s),t.options.isScreenSpace?fe.set(0,0,0,ni):fe.set(-ge(r.position[0]),-ge(r.position[1]),0,ni),Tt.translation(ni,Ss),n.queue.writeBuffer(t.data.uniformBuffer,0,Ss.buffer),n.queue.writeBuffer(t.data.uniformBuffer,64,_s.buffer)}var si={};hn(si,{addSprite:()=>Wc,clear:()=>Qc,removeSprite:()=>Kc,setSpriteName:()=>Jc,setSpriteOpacity:()=>e1,setSpritePosition:()=>jc,setSpriteRotation:()=>r1,setSpriteScale:()=>n1,setSpriteTint:()=>t1});function Wc(e,t,n,r,i,o,a,f){let{idByName:h}=t.refs.spritesheet.data;return t.data.sprites.push({position:Lt.clone(r),sizeX:1,sizeY:1,scale:Lt.clone(i),rotation:f,opacity:a,tint:Ce.clone(o),spriteID:h.get(n),id:Pe()}),t.data.sprites.at(-1).id}function Kc(e,t,n){for(let r=0;r<t.data.sprites.length;r++)if(t.data.sprites[r].id===n){t.data.sprites.splice(r,1);return}}function Qc(e,t){t.data.sprites.length=0}function Jc(e,t,n,r){let i=t.data.sprites.find(a=>a.id===n);if(!i)return;let{idByName:o}=t.refs.spritesheet.data;i.spriteID=o.get(r)}function jc(e,t,n,r){let i=t.data.sprites.find(o=>o.id===n);i&&Lt.copy(r,i.position)}function t1(e,t,n,r){let i=t.data.sprites.find(o=>o.id===n);i&&Ce.copy(r,i.tint)}function e1(e,t,n,r){let i=t.data.sprites.find(o=>o.id===n);i&&(i.opacity=r)}function r1(e,t,n,r){let i=t.data.sprites.find(o=>o.id===n);i&&(i.rotation=r)}function n1(e,t,n,r){let i=t.data.sprites.find(o=>o.id===n);i&&Lt.copy(r,i.scale)}var As="struct ViewParams{view:mat4x4<f32>,proj:mat4x4<f32>};@group(0)@binding(0)var<uniform> uView:ViewParams;@group(0)@binding(1)var uSampler:sampler;@group(0)@binding(2)var uTex:texture_2d<f32>;struct SpriteDesc{uvOrigin:vec2<f32>,uvSpan:vec2<f32>,frameSize:vec2<f32>,centerOffset:vec2<f32>,};@group(0)@binding(3)var<storage,read>Sprites:array<SpriteDesc>;@group(0)@binding(4)var emissiveTexture:texture_2d<f32>;struct VSOut{@builtin(position)pos:vec4<f32>,@location(0)uv:vec2<f32>,@location(1)tint:vec4<f32>,@location(2)opacity:f32,};const corners=array<vec2<f32>,4>(vec2<f32>(-0.5,-0.5),vec2<f32>(0.5,-0.5),vec2<f32>(-0.5,0.5),vec2<f32>(0.5,0.5),);const uvBase=array<vec2<f32>,4>(vec2<f32>(0.0,0.0),vec2<f32>(1.0,0.0),vec2<f32>(0.0,1.0),vec2<f32>(1.0,1.0),);struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(vertex_index)vid:u32,@location(0)i_pos:vec2<f32>,@location(1)i_size:vec2<f32>,@location(2)i_scale:vec2<f32>,@location(3)i_tint:vec4<f32>,@location(4)i_spriteId:u32,@location(5)i_opacity:f32,@location(6)i_rotation:f32)->VSOut{let rot=i_rotation;let c=cos(rot);let s=sin(rot);let d=Sprites[i_spriteId];let corner=corners[vid];let sizePx=d.frameSize*i_size*i_scale;var local=corner*sizePx;local+=d.centerOffset*i_scale;let rotated=vec2<f32>(local.x*c-local.y*s,local.x*s+local.y*c);let world=vec4<f32>(rotated+i_pos,0.0,1.0);var out:VSOut;out.pos=uView.proj*uView.view*world;out.uv=d.uvOrigin+d.uvSpan*uvBase[vid];out.tint=i_tint;out.opacity=i_opacity;return out;}@fragment fn fs_main(in:VSOut)->GBufferOutput{var output:GBufferOutput;let texel=textureSample(uTex,uSampler,in.uv);output.color=vec4<f32>(texel.rgb*(1.0-in.tint.a)+(in.tint.rgb*in.tint.a),texel.a*in.opacity);let emissive=textureSample(emissiveTexture,uSampler,in.uv);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var ui=fe.create(0,0,0),Us=Tt.identity(),zs=Tt.identity(),Oe=64,fi=0,ci=8,li=16,cr=24,Is=40,Ls=44,Rs=48,Gs={type:"cobalt:spriteHDR",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return i1(e,t)},onRun:function(e,t,n){a1(e,t,n)},onDestroy:function(e,t){try{t.data.instanceBuf?.destroy()}catch{}try{t.data.spriteBuf?.destroy()}catch{}try{t.data.uniformBuffer?.destroy()}catch{}t.data.pipeline=null,t.data.bindGroup=null,t.data.bindGroupLayout=null,t.data.instanceStaging=null,t.data.instanceView=null,t.data.sprites.length=0,t.data.visible.length=0},onResize:function(e,t){Es(e,t)},onViewportPosition:function(e,t){Es(e,t)},customFunctions:{...si}};async function i1(e,t){let{device:n}=e,{descs:r,names:i}=t.refs.spritesheet.data.spritesheet,o=n.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=32,f=new ArrayBuffer(a*r.length),h=new Float32Array(f);for(let H=0;H<r.length;H++){let W=r[H],st=H*8;h[st+0]=W.UvOrigin[0],h[st+1]=W.UvOrigin[1],h[st+2]=W.UvSpan[0],h[st+3]=W.UvSpan[1],h[st+4]=W.FrameSize[0],h[st+5]=W.FrameSize[1],h[st+6]=W.CenterOffset[0],h[st+7]=W.CenterOffset[1]}let v=n.createBuffer({label:"spriteHDR desc table",size:Math.max(16,f.byteLength),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});n.queue.writeBuffer(v,0,f);let d=1024,D=n.createBuffer({label:"spriteHDR instances",size:Oe*d,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),X=new ArrayBuffer(Oe*d),m=new DataView(X),G=n.createShaderModule({code:As}),q=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),N=n.createPipelineLayout({bindGroupLayouts:[q]}),Y={arrayStride:Oe,stepMode:"instance",attributes:[{shaderLocation:0,offset:fi,format:"float32x2"},{shaderLocation:1,offset:ci,format:"float32x2"},{shaderLocation:2,offset:li,format:"float32x2"},{shaderLocation:3,offset:cr,format:"float32x4"},{shaderLocation:4,offset:Is,format:"uint32"},{shaderLocation:5,offset:Ls,format:"float32"},{shaderLocation:6,offset:Rs,format:"float32"}]},K=n.createRenderPipeline({layout:N,vertex:{module:G,entryPoint:"vs_main",buffers:[Y]},fragment:{module:G,entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-strip",cullMode:"none"},multisample:{count:1}}),Q=q,tt=n.createBindGroup({layout:q,entries:[{binding:0,resource:{buffer:o}},{binding:1,resource:t.refs.spritesheet.data.colorTexture.sampler},{binding:2,resource:t.refs.spritesheet.data.colorTexture.view},{binding:3,resource:{buffer:v}},{binding:4,resource:t.refs.spritesheet.data.emissiveTexture.view}]});return{sprites:[],visible:[],visibleCount:0,viewRect:{x:0,y:0,w:0,h:0},spriteBuf:v,uniformBuffer:o,instanceCap:d,instanceView:m,instanceBuf:D,instanceStaging:X,pipeline:K,bindGroup:tt}}function o1(e,t,n){let{instanceCap:r}=t.data;if(n<=r)return;let i=r;for(i===0&&(i=1024);i<n;)i*=2;t.data.instanceBuf.destroy(),t.data.instanceBuf=e.device.createBuffer({size:Oe*i,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.data.instanceStaging=new ArrayBuffer(Oe*i),t.data.instanceView=new DataView(t.data.instanceStaging),t.data.instanceCap=i}function a1(e,t,n){let{device:r,context:i}=e,{instanceView:o,instanceBuf:a,instanceStaging:f,pipeline:h,bindGroup:v}=t.data,{descs:d}=t.refs.spritesheet.data.spritesheet,D=t.data.viewRect;D.x=e.viewport.position[0],D.y=e.viewport.position[1],D.w=e.viewport.width,D.h=e.viewport.height,t.data.visibleCount=0;for(let G of t.data.sprites){let q=d[G.spriteID];if(q){if(!t.options.isScreenSpace){let N=q.FrameSize[0]*G.sizeX*G.scale[0]*.5,Y=q.FrameSize[1]*G.sizeY*G.scale[1]*.5,K=Math.hypot(N,Y),Q=G.position[0],tt=G.position[1];if(Q+K<D.x||Q-K>D.x+D.w||tt+K<D.y||tt-K>D.y+D.h)continue}t.data.visible[t.data.visibleCount]=G,t.data.visibleCount++}}o1(e,t,t.data.visibleCount);for(let G=0;G<t.data.visibleCount;G++){let q=G*Oe,N=t.data.visible[G],Y=N.tint;o.setFloat32(q+fi+0,N.position[0],!0),o.setFloat32(q+fi+4,N.position[1],!0),o.setFloat32(q+ci+0,N.sizeX,!0),o.setFloat32(q+ci+4,N.sizeY,!0),o.setFloat32(q+li+0,N.scale[0],!0),o.setFloat32(q+li+4,N.scale[1],!0),o.setFloat32(q+cr+0,Y[0],!0),o.setFloat32(q+cr+4,Y[1],!0),o.setFloat32(q+cr+8,Y[2],!0),o.setFloat32(q+cr+12,Y[3],!0),o.setUint32(q+Is,N.spriteID>>>0,!0),o.setFloat32(q+Ls,N.opacity,!0),o.setFloat32(q+Rs,N.rotation,!0)}r.queue.writeBuffer(a,0,f,0,t.data.visibleCount*Oe);let X=t.options.loadOp||"load",m=n.beginRenderPass({label:"spriteHDR renderpass",colorAttachments:[{view:t.refs.color.data.view,clearValue:e.clearValue,loadOp:X,storeOp:"store"},{view:t.refs.emissive.data.view,clearValue:e.clearValue,loadOp:"clear",storeOp:"store"}]});m.setPipeline(h),m.setBindGroup(0,v),m.setVertexBuffer(0,a),t.data.visibleCount&&m.draw(4,t.data.visibleCount,0,0),m.end()}function Es(e,t){let{device:n,viewport:r}=e,i=r.width/r.zoom,o=r.height/r.zoom;Tt.ortho(0,i,o,0,-10,10,Us),t.options.isScreenSpace?fe.set(0,0,0,ui):fe.set(-ge(r.position[0]),-ge(r.position[1]),0,ui),Tt.translation(ui,zs),n.queue.writeBuffer(t.data.uniformBuffer,0,zs.buffer),n.queue.writeBuffer(t.data.uniformBuffer,64,Us.buffer)}function $r(e){let t=e.meta.size.w,n=e.meta.size.h,r=Object.keys(e.frames).sort(),i=new Array(r.length);for(let o=0;o<r.length;o++){let a=e.frames[r[o]],f=a.frame.x,h=a.frame.y,v=a.frame.w,d=a.frame.h,D=f/t,X=h/n,m=v/t,G=d/n,q=a.sourceSize.w,N=a.sourceSize.h,Y=a.spriteSourceSize.x,K=a.spriteSourceSize.y,Q=Y+v*.5-q*.5,tt=K+d*.5-N*.5;i[o]={UvOrigin:[D,X],UvSpan:[m,G],FrameSize:[v,d],CenterOffset:[Q,tt]}}return{descs:i,names:r}}var Os={type:"cobalt:spritesheet",refs:[],onInit:async function(e,t={}){return s1(e,t)},onRun:function(e,t,n){},onDestroy:function(e,t){u1(t)},onResize:function(e,t){},onViewportPosition:function(e,t){}};async function s1(e,t){let{canvas:n,device:r}=e,i,o,a,f=t.options.format||"rgba8unorm";n?(i=await fetch(t.options.spriteSheetJsonUrl),i=await i.json(),i=$r(i),o=await pe(e,"sprite",t.options.colorTextureUrl,f),a=await pe(e,"emissive sprite",t.options.emissiveTextureUrl,f),n.style.imageRendering="pixelated"):(i=$r(t.options.spriteSheetJson),o=await ve(e,"sprite",t.options.colorTexture,f),a=await ve(e,"emissive sprite",t.options.emissiveTexture,f));let h=new Map(i.names.map((v,d)=>[v,d]));return{colorTexture:o,emissiveTexture:a,spritesheet:i,idByName:h}}function u1(e){e.data.colorTexture.texture.destroy(),e.data.emissiveTexture.texture.destroy()}var hi="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var ye=new Float32Array(8),qs={type:"cobalt:tileAtlas",refs:[],onInit:async function(e,t={}){return f1(e,t)},onRun:function(e,t,n){},onDestroy:function(e,t){c1(t)},onResize:function(e,t){Vs(e,t)},onViewportPosition:function(e,t){Vs(e,t)}};async function f1(e,t){let{canvas:n,device:r}=e,i=t.options.format||"rgba8unorm",o;n?o=await pe(e,"tile atlas",t.options.textureUrl,i):o=await ve(e,"tile atlas",t.options.texture,i);let a=r.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),h=r.createBindGroup({layout:f,entries:[{binding:0,resource:{buffer:a}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]}),v=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),d=r.createPipelineLayout({bindGroupLayouts:[v,f]});return{pipeline:r.createRenderPipeline({label:"tileatlas",vertex:{module:r.createShaderModule({code:hi}),entryPoint:"vs_main",buffers:[]},fragment:{module:r.createShaderModule({code:hi}),entryPoint:"fs_main",targets:[{format:t.options.outputFormat||Nt(e),blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:d}),uniformBuffer:a,atlasBindGroup:h,atlasMaterial:o,tileBindGroupLayout:v,tileSize:t.options.tileSize,tileScale:t.options.tileScale}}function c1(e){e.data.atlasMaterial.texture.destroy(),e.data.atlasMaterial.texture=void 0}function Vs(e,t){ye[0]=ge(e.viewport.position[0]),ye[1]=ge(e.viewport.position[1]);let n=t.data,{tileScale:r,tileSize:i}=n,o=e.viewport.width/e.viewport.zoom,a=e.viewport.height/e.viewport.zoom;ye[2]=o/r,ye[3]=a/r,ye[4]=1/n.atlasMaterial.texture.width,ye[5]=1/n.atlasMaterial.texture.height,ye[6]=i,ye[7]=1/i,e.device.queue.writeBuffer(n.uniformBuffer,0,ye,0,8)}var ms={type:"cobalt:tileHDR",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return l1(e,t)},onRun:function(e,t,n){h1(e,t,n)},onDestroy:function(e,t){Ns(t)},onResize:function(e,t){},onViewportPosition:function(e,t){},customFunctions:{setTexture:async function(e,t,n){let{canvas:r,device:i}=e;Ns(t);let o=t.options.format||Nt(e),a;r?(t.options.textureUrl=n,a=await pe(e,"tile map",n,o)):a=await ve(e,"tile map",n,o);let f=i.createBindGroup({layout:t.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:t.data.uniformBuffer}},{binding:1,resource:a.view},{binding:2,resource:a.sampler}]});t.data.bindGroup=f,t.data.material=a}}};async function l1(e,t){let{canvas:n,device:r}=e,i,o=t.options.format||Nt(e);n?i=await pe(e,"tile map",t.options.textureUrl,o):i=await ve(e,"tile map",t.options.texture,o);let a=new Float32Array([t.options.scrollScale,t.options.scrollScale]),f=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,h={size:a.byteLength,usage:f,mappedAtCreation:!0},v=r.createBuffer(h);return new Float32Array(v.getMappedRange()).set(a),v.unmap(),{bindGroup:r.createBindGroup({layout:t.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:i.view},{binding:2,resource:i.sampler}]}),material:i,uniformBuffer:v,scrollScale:t.options.scrollScale}}function h1(e,t,n){if(!t.data.material.texture)return;let{device:r}=e,i=t.options.loadOp||"load",o=n.beginRenderPass({label:"tile",colorAttachments:[{view:t.refs.hdr.data?.view||t.refs.hdr,clearValue:e.clearValue,loadOp:i,storeOp:"store"}]}),a=t.refs.tileAtlas.data;o.setPipeline(a.pipeline),o.setBindGroup(0,t.data.bindGroup),o.setBindGroup(1,a.atlasBindGroup),o.draw(3),o.end()}function Ns(e){e.data.material.texture.destroy(),e.data.material.texture=void 0}async function Ov(e,t,n){let r,i,o,a;return e.sdlWindow&&e.gpu?(i=e.gpu,r=await(await i.create(["verbose=1","enable-dawn-features=allow_unsafe_apis"]).requestAdapter()).requestDevice({requiredFeatures:["texture-component-swizzle"]}),o=i.renderGPUDeviceToWindow({device:r,window:e.sdlWindow}),global.GPUBufferUsage=i.GPUBufferUsage,global.GPUShaderStage=i.GPUShaderStage,global.GPUTextureUsage=i.GPUTextureUsage):(a=e,r=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),i=navigator.gpu,o=a.getContext("webgpu"),o.configure({device:r,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":qs,"cobalt:spritesheet":Os,"cobalt:fbTexture":Ei,"cobalt:sprite":Fs,"cobalt:bloom":wi,"cobalt:composite":Ms,"cobalt:spriteHDR":Gs,"cobalt:tileHDR":ms,"cobalt:displacement":Ui,"cobalt:fbBlit":zi,"cobalt:primitives":ys,"cobalt:light":Li},nodes:[],defaultTextureViewRefs:[],canvas:a,device:r,context:o,gpu:i,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:t,height:n,zoom:1,position:[0,0]}}}function Vv(e,t){if(!t?.type)throw new Error("Can't define a new node missing a type.");e.nodeDefs[t.type]=t}async function qv(e,t){let n=e.nodeDefs[t?.type];if(!n)throw new Error("Can't initialize a new node missing a type.");let r={type:t.type,refs:t.refs||{},options:t.options||{},data:{},enabled:!0};for(let o in r.refs)r.refs[o]==="FRAME_TEXTURE_VIEW"&&(e.defaultTextureViewRefs.push({node:r,refName:o}),r.refs[o]=Cs(e));r.data=await n.onInit(e,r);let i=n.customFunctions||{};for(let o in i)r[o]=function(...a){return i[o](e,r,...a)};return e.nodes.push(r),r}function Nv(e){let{device:t,context:n}=e,r=t.createCommandEncoder(),i=Cs(e);for(let o of e.defaultTextureViewRefs)o.node.refs[o.refName]=i;for(let o of e.nodes){if(!o.enabled)continue;e.nodeDefs[o.type].onRun(e,o,r)}t.queue.submit([r.finish()]),e.canvas||e.context.swap()}function mv(e){for(let t of e.nodes)e.nodeDefs[t.type].onDestroy(e,t);e.nodes.length=0,e.defaultTextureViewRefs.length=0}function Cv(e,t,n){e.viewport.width=t,e.viewport.height=n;for(let r of e.nodes)e.nodeDefs[r.type].onResize(e,r)}function Xv(e,t){e.viewport.position[0]=t[0]-e.viewport.width/2/e.viewport.zoom,e.viewport.position[1]=t[1]-e.viewport.height/2/e.viewport.zoom;for(let n of e.nodes)e.nodeDefs[n.type].onViewportPosition(e,n)}function Cs(e){return e.canvas?e.context.getCurrentTexture().createView():e.context.getCurrentTextureView()}export{ne as createTexture,ve as createTextureFromBuffer,pe as createTextureFromUrl,Vv as defineNode,Nv as draw,Cs as getCurrentTextureView,Nt as getPreferredFormat,Ov as init,qv as initNode,mv as reset,Cv as setViewportDimensions,Xv as setViewportPosition};

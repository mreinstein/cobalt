var vn=Object.defineProperty;var _e=(e,t)=>{for(var l in t)vn(e,l,{get:t[l],enumerable:!0})};function St(e,t,l,f,v,g,T){let G=e.createTexture({label:t,size:{width:l,height:f},format:g,usage:T,mipLevelCount:v,sampleCount:1,dimension:"2d"}),D=G.createView(),U=[];for(let E=0;E<v;E++)U.push(G.createView({label:t,format:g,dimension:"2d",aspect:"all",baseMipLevel:E,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let z=e.createSampler({label:`${t} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:l,height:f},texture:G,view:D,mip_view:U,sampler:z}}async function Ct(e,t,l,f="rgba8unorm"){let g=await(await fetch(l)).blob(),T=await createImageBitmap(g),G=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,U=St(e.device,t,T.width,T.height,1,f,G);e.device.queue.copyExternalImageToTexture({source:T},{texture:U.texture},{width:T.width,height:T.height});let z={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return U.sampler=e.device.createSampler(z),U}function Wt(e,t,l,f="rgba8unorm"){let v=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,T=St(e.device,t,l.width,l.height,1,f,v);e.device.queue.writeTexture({texture:T.texture},l.data,{bytesPerRow:4*l.width},{width:l.width,height:l.height});let G={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return T.sampler=e.device.createSampler(G),T}var Ge="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var Ot=7,yn=0,Ue=1,bn=2,ze=3,Ee={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(e,t={}){return Tn(e,t)},onRun:function(e,t,l){Mn(e,t.data,l)},onDestroy:function(e,t){Ie(t)},onResize:function(e,t){Sn(e,t)},onViewportPosition:function(e,t){}};function Tn(e,t){let{device:l}=e,f=e.viewport.width,v=e.viewport.height,g={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},T=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});g.bind_group_layout.push(T),g.bind_groups_textures.push(St(l,"bloom downsampler image 0",f/2,v/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),g.bind_groups_textures.push(St(l,"bloom downsampler image 1",f/2,v/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),g.bind_groups_textures.push(t.refs.bloom.data);let G=l.createPipelineLayout({bindGroupLayouts:g.bind_group_layout}),D=l.createComputePipeline({layout:G,compute:{module:l.createShaderModule({code:Ge}),entryPoint:"cs_main"}});return Le(e,g,t),g.compute_pipeline=D,g}function Le(e,t,l){let{refs:f}=l,{device:v}=e,g=l.options.bloom_threshold??.1,T=l.options.bloom_knee??.2,G=l.options.bloom_combine_constant??.68,D=new Float32Array([g,g-T,T*2,.25/T,G,0,0,0]),U=v.createBuffer({label:"bloom static parameters buffer",size:D.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(U.getMappedRange()).set(D),U.unmap(),t.bind_group.length=0,t.params_buf=U,t.bind_group.push($t(v,t,t.bind_groups_textures[0].mip_view[0],f.emissive.data.view,f.hdr.data.view,f.hdr.data.sampler,U,yn<<16|0));for(let E=1;E<Ot;E++)t.bind_group.push($t(v,t,t.bind_groups_textures[1].mip_view[E],t.bind_groups_textures[0].view,f.hdr.data.view,f.hdr.data.sampler,U,Ue<<16|E-1)),t.bind_group.push($t(v,t,t.bind_groups_textures[0].mip_view[E],t.bind_groups_textures[1].view,f.hdr.data.view,f.hdr.data.sampler,U,Ue<<16|E));t.bind_group.push($t(v,t,t.bind_groups_textures[2].mip_view[Ot-1],t.bind_groups_textures[0].view,f.hdr.data.view,f.hdr.data.sampler,U,bn<<16|Ot-2));let z=!0;for(let E=Ot-2;E>=0;E--)z?(t.bind_group.push($t(v,t,t.bind_groups_textures[1].mip_view[E],t.bind_groups_textures[0].view,t.bind_groups_textures[2].view,f.hdr.data.sampler,U,ze<<16|E)),z=!1):(t.bind_group.push($t(v,t,t.bind_groups_textures[2].mip_view[E],t.bind_groups_textures[0].view,t.bind_groups_textures[1].view,f.hdr.data.sampler,U,ze<<16|E)),z=!0)}function $t(e,t,l,f,v,g,T,G){let D=new Uint32Array([G]),U=e.createBuffer({label:"bloom static mode_lod buffer",size:D.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(U.getMappedRange()).set(D),U.unmap(),e.createBindGroup({label:"bloom bind group layout",layout:t.bind_group_layout[0],entries:[{binding:0,resource:l},{binding:1,resource:f},{binding:2,resource:v},{binding:3,resource:g},{binding:4,resource:{buffer:T}},{binding:5,resource:{buffer:U}}]})}function Mn(e,t,l){let G=0,D=l.beginComputePass({label:"bloom Compute Pass"});D.setPipeline(t.compute_pipeline),D.setBindGroup(0,t.bind_group[G]),G+=1;let U=ne(0,t.bind_groups_textures[0]);D.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);for(let z=1;z<Ot;z++)U=ne(z,t.bind_groups_textures[0]),D.setBindGroup(0,t.bind_group[G]),G+=1,D.dispatchWorkgroups(U.width/8+1,U.height/4+1,1),D.setBindGroup(0,t.bind_group[G]),G+=1,D.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);D.setBindGroup(0,t.bind_group[G]),G+=1,U=ne(Ot-1,t.bind_groups_textures[2]),D.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);for(let z=Ot-2;z>=0;z--)U=ne(z,t.bind_groups_textures[2]),D.setBindGroup(0,t.bind_group[G]),G+=1,D.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);D.end()}function ne(e,t){let l=t.size.width,f=t.size.height;for(let v=0;v<e;v++)l/=2,f/=2;return{width:l,height:f,depthOrArrayLayers:1}}function Sn(e,t){let{device:l}=e,f=t.data;Ie(f),f.bind_groups_textures.push(St(l,"bloom downsampler image 0",e.viewport.width/2,e.viewport.height/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),f.bind_groups_textures.push(St(l,"bloom downsampler image 1",e.viewport.width/2,e.viewport.height/2,Ot,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),f.bind_groups_textures.push(t.refs.bloom.data),Le(e,f,t)}function Ie(e){for(let t of e.bind_groups_textures)t.texture.destroy();e.bind_groups_textures.length=0}var me="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Fe={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return Bn(e,t)},onRun:function(e,t,l){Dn(e,t,l)},onDestroy:function(e,t){},onResize:function(e,t){_n(e,t)},onViewportPosition:function(e,t){}};function Bn(e,t){let{options:l,refs:f}=t,{device:v}=e,g=Re(e),T=l.bloom_intensity??40,G=l.bloom_combine_constant??.68,D=new Float32Array([T,G]),U=v.createBuffer({label:"scene composite params buffer",size:D.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(U.getMappedRange()).set(D),U.unmap();let z=v.createRenderPipeline({layout:"auto",vertex:{module:v.createShaderModule({code:me}),entryPoint:"vert_main"},fragment:{module:v.createShaderModule({code:me}),entryPoint:"frag_main",targets:[{format:g}]},primitive:{topology:"triangle-list"}});return{bindGroup:v.createBindGroup({layout:z.getBindGroupLayout(0),entries:[{binding:0,resource:f.hdr.data.sampler},{binding:1,resource:f.hdr.data.view},{binding:2,resource:f.bloom.data.mip_view[0]},{binding:3,resource:{buffer:U}}]}),pipeline:z,params_buf:U}}function Dn(e,t,l){let f=l.beginRenderPass({colorAttachments:[{view:t.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:v,bindGroup:g}=t.data;f.setPipeline(v),f.setBindGroup(0,g),f.draw(3),f.end()}function _n(e,t){let{pipeline:l,params_buf:f}=t.data,{device:v}=e;t.data.bindGroup=v.createBindGroup({layout:l.getBindGroupLayout(0),entries:[{binding:0,resource:t.refs.hdr.data.sampler},{binding:1,resource:t.refs.hdr.data.view},{binding:2,resource:t.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:f}}]})}var jt={};_e(jt,{addSprite:()=>Un,clear:()=>En,removeSprite:()=>zn,setSprite:()=>On,setSpriteName:()=>Ln,setSpriteOpacity:()=>Rn,setSpritePosition:()=>In,setSpriteRotation:()=>An,setSpriteScale:()=>Vn,setSpriteTint:()=>Fn});function ge(e,t,l){if(l.spriteCount===0)return 0;let f=0,v=l.spriteCount-1,g=e<<16&16711680|t&65535;for(;f<=v;){let T=l.spriteData[f*12+11];if(g<=T)return f;let G=l.spriteData[v*12+11];if(g>=G)return v+1;let D=Math.floor((f+v)/2),U=l.spriteData[D*12+11];if(g===U)return D+1;g>U?f=D+1:v=D-1}return f}function Ht(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function Un(e,t,l,f,v,g,T,G,D){let U=t.refs.spritesheet.data.spritesheet;t=t.data;let z=U.locations.indexOf(l),E=ge(D,z,t),C=(E+1)*12;t.spriteData.set(t.spriteData.subarray(E*12,t.spriteCount*12),C),Ae(t,U,E,l,f,v,g,T,G,D);for(let[Y,L]of t.spriteIndices)L>=E&&t.spriteIndices.set(Y,L+1);let V=Ht();return t.spriteIndices.set(V,E),t.spriteCount++,t.dirty=!0,V}function zn(e,t,l){t=t.data;let f=t.spriteIndices.get(l);for(let[g,T]of t.spriteIndices)T>f&&t.spriteIndices.set(g,T-1);let v=f*12;t.spriteData.set(t.spriteData.subarray((f+1)*12,t.spriteCount*12),v),t.spriteIndices.delete(l),t.spriteCount--,t.dirty=!0}function En(e,t){t=t.data,t.spriteIndices.clear(),t.spriteCount=0,t.instancedDrawCallCount=0,t.dirty=!0}function Ln(e,t,l,f,v){let g=t.refs.spritesheet.data.spritesheet;t=t.data;let T=g.locations.indexOf(f),G=g.spriteMeta[f].w,D=g.spriteMeta[f].h,z=t.spriteIndices.get(l)*12;t.spriteData[z+2]=G*v[0],t.spriteData[z+3]=D*v[1];let C=(t.spriteData[z+11]>>16&255)<<16&16711680|T&65535;t.spriteData[z+11]=C,t.dirty=!0}function In(e,t,l,f){t=t.data;let g=t.spriteIndices.get(l)*12;t.spriteData[g]=f[0],t.spriteData[g+1]=f[1],t.dirty=!0}function Fn(e,t,l,f){t=t.data;let g=t.spriteIndices.get(l)*12;t.spriteData[g+4]=f[0],t.spriteData[g+5]=f[1],t.spriteData[g+6]=f[2],t.spriteData[g+7]=f[3],t.dirty=!0}function Rn(e,t,l,f){t=t.data;let g=t.spriteIndices.get(l)*12;t.spriteData[g+8]=f,t.dirty=!0}function An(e,t,l,f){t=t.data;let g=t.spriteIndices.get(l)*12;t.spriteData[g+9]=f,t.dirty=!0}function Vn(e,t,l,f,v){let g=t.refs.spritesheet.data.spritesheet;t=t.data;let G=t.spriteIndices.get(l)*12,D=g.spriteMeta[f].w,U=g.spriteMeta[f].h;t.spriteData[G+2]=D*v[0],t.spriteData[G+3]=U*v[1],t.dirty=!0}function On(e,t,l,f,v,g,T,G,D,U){let z=t.refs.spritesheet.data.spritesheet;t=t.data;let E=t.spriteIndices.get(l);Ae(t,z,E,f,v,g,T,G,D,U),t.dirty=!0}function Ae(e,t,l,f,v,g,T,G,D,U){if(!t.spriteMeta[f])throw new Error(`Sprite name ${f} could not be found in the spritesheet metaData`);let z=l*12,E=t.spriteMeta[f].w,C=t.spriteMeta[f].h,V=t.locations.indexOf(f),Y=U<<16&16711680|V&65535;e.spriteData[z]=v[0],e.spriteData[z+1]=v[1],e.spriteData[z+2]=E*g[0],e.spriteData[z+3]=C*g[1],e.spriteData[z+4]=T[0],e.spriteData[z+5]=T[1],e.spriteData[z+6]=T[2],e.spriteData[z+7]=T[3],e.spriteData[z+8]=G,e.spriteData[z+9]=D,e.spriteData[z+11]=Y}var Ve={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return Cn(e,t)},onRun:function(e,t,l){Nn(e,t,l)},onDestroy:function(e,t){Yn(t)},onResize:function(e,t){},onViewportPosition:function(e,t){},customFunctions:{...jt}};async function Cn(e,t){let{device:l}=e,f=16192,v=f,T=Float32Array.BYTES_PER_ELEMENT*2,D=Float32Array.BYTES_PER_ELEMENT*2,z=Float32Array.BYTES_PER_ELEMENT*4,C=Float32Array.BYTES_PER_ELEMENT*4,V=l.createBuffer({size:(T+D+z+C)*v,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Y=t.refs.spritesheet.data,L=l.createBindGroup({layout:t.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:Y.uniformBuffer}},{binding:1,resource:Y.colorTexture.view},{binding:2,resource:Y.colorTexture.sampler},{binding:3,resource:{buffer:V}},{binding:4,resource:Y.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(f*2),instancedDrawCallCount:0,bindGroup:L,spriteBuffer:V,spriteData:new Float32Array(f*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Nn(e,t,l){let{device:f}=e,v=t.options.loadOp||"load";if(t.data.dirty&&(qn(t.data),t.data.dirty=!1),t.data.spriteCount>0){let D=t.data.spriteCount*12*Float32Array.BYTES_PER_ELEMENT;f.queue.writeBuffer(t.data.spriteBuffer,0,t.data.spriteData.buffer,0,D)}let g=l.beginRenderPass({colorAttachments:[{view:t.refs.hdr.data.view,clearValue:e.clearValue,loadOp:v,storeOp:"store"},{view:t.refs.emissive.data.view,clearValue:e.clearValue,loadOp:"clear",storeOp:"store"}]});g.setPipeline(t.refs.spritesheet.data.pipeline),g.setBindGroup(0,t.data.bindGroup),g.setVertexBuffer(0,t.refs.spritesheet.data.quads.buffer);let T=6,G=0;for(let D=0;D<t.data.instancedDrawCallCount;D++){let U=t.data.instancedDrawCalls[D*2]*T,z=t.data.instancedDrawCalls[D*2+1];g.draw(T,z,U,G),G+=z}g.end()}function qn(e){let t=-1,l=0;e.instancedDrawCallCount=0;for(let f=0;f<e.spriteCount;f++){let v=e.spriteData[f*12+11]&65535;v!==t&&(l>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=l,e.instancedDrawCallCount++),t=v,l=0),l++}l>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=l,e.instancedDrawCallCount++)}function Yn(e){e.data.instancedDrawCalls=null,e.data.bindGroup=null,e.data.spriteBuffer.destroy(),e.data.spriteBuffer=null,e.data.spriteData=null,e.data.spriteIndices.clear(),e.data.spriteIndices=null}var Ce={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return Xn(e,t)},onRun:function(e,t,l){$n(e,t,l)},onDestroy:function(e,t){Oe(t)},onResize:function(e,t){},onViewportPosition:function(e,t){},customFunctions:{setTexture:async function(e,t,l){let{device:f}=e;Oe(t),t.options.textureUrl=l;let v=await Ct(e,"tile map",t.options.textureUrl),g=f.createBindGroup({layout:t.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:t.data.uniformBuffer}},{binding:1,resource:v.view},{binding:2,resource:v.sampler}]});t.data.bindGroup=g,t.data.material=v}}};async function Xn(e,t){let{device:l}=e,f=await Ct(e,"tile map",t.options.textureUrl),v=new Float32Array([t.options.scrollScale,t.options.scrollScale]),g=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,T={size:v.byteLength,usage:g,mappedAtCreation:!0},G=l.createBuffer(T);return new Float32Array(G.getMappedRange()).set(v),G.unmap(),{bindGroup:l.createBindGroup({layout:t.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:G}},{binding:1,resource:f.view},{binding:2,resource:f.sampler}]}),material:f,uniformBuffer:G,scrollScale:t.options.scrollScale}}function $n(e,t,l){let{device:f}=e,v=t.options.loadOp||"load",g=l.beginRenderPass({colorAttachments:[{view:t.refs.hdr.data.view,clearValue:e.clearValue,loadOp:v,storeOp:"store"}]}),T=t.refs.tileAtlas.data;g.setPipeline(T.pipeline),g.setBindGroup(0,t.data.bindGroup),g.setBindGroup(1,T.atlasBindGroup),g.draw(3),g.end()}function Oe(e){e.data.material.texture.destroy(),e.data.material.texture=void 0}var re=class{device;floatsPerSprite=6;bufferGpu;bufferNeedsUpdate=!1;sprites=new Map;get spriteCount(){return this.sprites.size}constructor(t){this.device=t.device,this.bufferGpu=this.device.createBuffer({size:t.maxSpriteCount*this.floatsPerSprite*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})}destroy(){this.bufferGpu.destroy}update(){if(this.bufferNeedsUpdate){let t=[];for(let f of this.sprites.values())t.push(...f);let l=new Float32Array(t);this.device.queue.writeBuffer(this.bufferGpu,0,l)}}addTriangle(t){let l=Ht();if(this.sprites.has(l))throw new Error(`Duplicate triangle "${l}".`);let f=this.buildTriangleData(t);return this.sprites.set(l,f),this.bufferNeedsUpdate=!0,l}removeTriangle(t){if(!this.sprites.has(t))throw new Error(`Unknown triangle "${t}".`);this.sprites.delete(t),this.bufferNeedsUpdate=!0}setTriangle(t,l){if(!this.sprites.has(t))throw new Error(`Unknown triangle "${t}".`);let f=this.buildTriangleData(l);this.sprites.set(t,f),this.bufferNeedsUpdate=!0}buildTriangleData(t){return[t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1]]}};var ie=class{device;bufferGpu;needsUpdate=!0;constructor(t){this.device=t.device,this.bufferGpu=this.device.createBuffer({label:"DisplacementParametersBuffer buffer",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.setParameters(t.initialParameters)}setParameters(t){this.device.queue.writeBuffer(this.bufferGpu,0,new Float32Array([t.offsetX,t.offsetY,t.scale]))}destroy(){this.bufferGpu.destroy()}};var Ne="struct DisplacementParameters{offset:vec2<f32>,scale:f32,};@group(0)@binding(0)var<uniform> uniforms:DisplacementParameters;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var colorSampler:sampler;@group(0)@binding(3)var noiseTexture:texture_2d<f32>;@group(0)@binding(4)var noiseSampler:sampler;@group(0)@binding(5)var displacementTexture:texture_2d<f32>;struct VertexIn{@builtin(vertex_index)vertexIndex:u32,};struct VertexOut{@builtin(position)position:vec4<f32>,@location(0)uv:vec2<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{const corners=array<vec2<f32>,4>(vec2<f32>(-1,-1),vec2<f32>(1,-1),vec2<f32>(-1,1),vec2<f32>(1,1),);let screenPosition=corners[in.vertexIndex];var out:VertexOut;out.position=vec4<f32>(screenPosition,0,1);out.uv=(0.5+0.5*screenPosition*vec2<f32>(1,-1));return out;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment(in:VertexOut)->FragmentOut{let noiseTextureDimensions=vec2<f32>(textureDimensions(noiseTexture,0));let noiseUv=in.uv+uniforms.offset/noiseTextureDimensions;var noise=textureSample(noiseTexture,noiseSampler,noiseUv).rg;noise-=0.5;noise*=uniforms.scale/noiseTextureDimensions;let displacement=textureSample(displacementTexture,colorSampler,in.uv).r;noise*=displacement;let colorUv=in.uv+noise;var out:FragmentOut;out.color=textureSample(colorTexture,colorSampler,colorUv);return out;}";var oe=class{device;targetFormat;renderPipeline;colorSampler;noiseSampler;displacementParametersBuffer;renderBundle=null;colorTextureView;noiseMapTextureView;displacementTextureView;constructor(t){this.device=t.device,this.targetFormat=t.targetFormat,this.colorTextureView=t.colorTextureView,this.noiseMapTextureView=t.noiseMapTextureView,this.displacementTextureView=t.displacementTextureView,this.displacementParametersBuffer=t.displacementParametersBuffer;let l=this.device.createShaderModule({label:"DisplacementComposition shader module",code:Ne});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementComposition renderpipeline",layout:"auto",vertex:{module:l,entryPoint:"main_vertex"},fragment:{module:l,entryPoint:"main_fragment",targets:[{format:t.targetFormat}]},primitive:{cullMode:"none",topology:"triangle-strip"}}),this.noiseSampler=this.device.createSampler({label:"DisplacementComposition noisesampler",addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),this.colorSampler=this.device.createSampler({label:"DisplacementComposition colorSampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"})}getRenderBundle(){return this.renderBundle||(this.renderBundle=this.buildRenderBundle()),this.renderBundle}destroy(){}setColorTextureView(t){this.colorTextureView=t,this.renderBundle=null}setNoiseMapTextureView(t){this.noiseMapTextureView=t,this.renderBundle=null}setDisplacementTextureView(t){this.displacementTextureView=t,this.renderBundle=null}buildRenderBundle(){let t=this.device.createBindGroup({label:"DisplacementComposition bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.displacementParametersBuffer.bufferGpu}},{binding:1,resource:this.colorTextureView},{binding:2,resource:this.colorSampler},{binding:3,resource:this.noiseMapTextureView},{binding:4,resource:this.noiseSampler},{binding:5,resource:this.displacementTextureView}]}),l=this.device.createRenderBundleEncoder({label:"DisplacementComposition renderbundle encoder",colorFormats:[this.targetFormat]});return l.setPipeline(this.renderPipeline),l.setBindGroup(0,t),l.draw(4),l.finish({label:"DisplacementComposition renderbundle"})}};var qe="struct TransformData{mvpMatrix:mat4x4<f32>,};@group(0)@binding(0)var<uniform> transformUBO:TransformData;struct VertexIn{@location(0)position:vec2<f32>,};struct VertexOut{@builtin(position)position:vec4<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{var output:VertexOut;output.position=transformUBO.mvpMatrix*vec4<f32>(in.position,0.0,1.0);return output;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment()->FragmentOut{var out:FragmentOut;out.color=vec4<f32>(1.0,1.0,1.0,1.0);return out;}";function jn(e,t){return class extends e{constructor(...l){super(...l),t(this)}}}var kn=jn(Array,e=>e.fill(0)),O=1e-6;function Zn(e){function t(n=0,c=0){let r=new e(2);return n!==void 0&&(r[0]=n,c!==void 0&&(r[1]=c)),r}let l=t;function f(n,c,r){let o=r??new e(2);return o[0]=n,o[1]=c,o}function v(n,c){let r=c??new e(2);return r[0]=Math.ceil(n[0]),r[1]=Math.ceil(n[1]),r}function g(n,c){let r=c??new e(2);return r[0]=Math.floor(n[0]),r[1]=Math.floor(n[1]),r}function T(n,c){let r=c??new e(2);return r[0]=Math.round(n[0]),r[1]=Math.round(n[1]),r}function G(n,c=0,r=1,o){let d=o??new e(2);return d[0]=Math.min(r,Math.max(c,n[0])),d[1]=Math.min(r,Math.max(c,n[1])),d}function D(n,c,r){let o=r??new e(2);return o[0]=n[0]+c[0],o[1]=n[1]+c[1],o}function U(n,c,r,o){let d=o??new e(2);return d[0]=n[0]+c[0]*r,d[1]=n[1]+c[1]*r,d}function z(n,c){let r=n[0],o=n[1],d=c[0],y=c[1],P=Math.sqrt(r*r+o*o),u=Math.sqrt(d*d+y*y),p=P*u,w=p&&Pt(n,c)/p;return Math.acos(w)}function E(n,c,r){let o=r??new e(2);return o[0]=n[0]-c[0],o[1]=n[1]-c[1],o}let C=E;function V(n,c){return Math.abs(n[0]-c[0])<O&&Math.abs(n[1]-c[1])<O}function Y(n,c){return n[0]===c[0]&&n[1]===c[1]}function L(n,c,r,o){let d=o??new e(2);return d[0]=n[0]+r*(c[0]-n[0]),d[1]=n[1]+r*(c[1]-n[1]),d}function tt(n,c,r,o){let d=o??new e(2);return d[0]=n[0]+r[0]*(c[0]-n[0]),d[1]=n[1]+r[1]*(c[1]-n[1]),d}function K(n,c,r){let o=r??new e(2);return o[0]=Math.max(n[0],c[0]),o[1]=Math.max(n[1],c[1]),o}function et(n,c,r){let o=r??new e(2);return o[0]=Math.min(n[0],c[0]),o[1]=Math.min(n[1],c[1]),o}function X(n,c,r){let o=r??new e(2);return o[0]=n[0]*c,o[1]=n[1]*c,o}let Z=X;function st(n,c,r){let o=r??new e(2);return o[0]=n[0]/c,o[1]=n[1]/c,o}function pt(n,c){let r=c??new e(2);return r[0]=1/n[0],r[1]=1/n[1],r}let mt=pt;function gt(n,c,r){let o=r??new e(3),d=n[0]*c[1]-n[1]*c[0];return o[0]=0,o[1]=0,o[2]=d,o}function Pt(n,c){return n[0]*c[0]+n[1]*c[1]}function it(n){let c=n[0],r=n[1];return Math.sqrt(c*c+r*r)}let zt=it;function $(n){let c=n[0],r=n[1];return c*c+r*r}let j=$;function q(n,c){let r=n[0]-c[0],o=n[1]-c[1];return Math.sqrt(r*r+o*o)}let It=q;function ht(n,c){let r=n[0]-c[0],o=n[1]-c[1];return r*r+o*o}let Ft=ht;function xt(n,c){let r=c??new e(2),o=n[0],d=n[1],y=Math.sqrt(o*o+d*d);return y>1e-5?(r[0]=o/y,r[1]=d/y):(r[0]=0,r[1]=0),r}function Rt(n,c){let r=c??new e(2);return r[0]=-n[0],r[1]=-n[1],r}function k(n,c){let r=c??new e(2);return r[0]=n[0],r[1]=n[1],r}let At=k;function Tt(n,c,r){let o=r??new e(2);return o[0]=n[0]*c[0],o[1]=n[1]*c[1],o}let Vt=Tt;function Mt(n,c,r){let o=r??new e(2);return o[0]=n[0]/c[0],o[1]=n[1]/c[1],o}let Et=Mt;function Bt(n=1,c){let r=c??new e(2),o=Math.random()*2*Math.PI;return r[0]=Math.cos(o)*n,r[1]=Math.sin(o)*n,r}function s(n){let c=n??new e(2);return c[0]=0,c[1]=0,c}function h(n,c,r){let o=r??new e(2),d=n[0],y=n[1];return o[0]=d*c[0]+y*c[4]+c[12],o[1]=d*c[1]+y*c[5]+c[13],o}function i(n,c,r){let o=r??new e(2),d=n[0],y=n[1];return o[0]=c[0]*d+c[4]*y+c[8],o[1]=c[1]*d+c[5]*y+c[9],o}function a(n,c,r,o){let d=o??new e(2),y=n[0]-c[0],P=n[1]-c[1],u=Math.sin(r),p=Math.cos(r);return d[0]=y*p-P*u+c[0],d[1]=y*u+P*p+c[1],d}function m(n,c,r){let o=r??new e(2);return xt(n,o),X(o,c,o)}function x(n,c,r){let o=r??new e(2);return it(n)>c?m(n,c,o):k(n,o)}function S(n,c,r){let o=r??new e(2);return L(n,c,.5,o)}return{create:t,fromValues:l,set:f,ceil:v,floor:g,round:T,clamp:G,add:D,addScaled:U,angle:z,subtract:E,sub:C,equalsApproximately:V,equals:Y,lerp:L,lerpV:tt,max:K,min:et,mulScalar:X,scale:Z,divScalar:st,inverse:pt,invert:mt,cross:gt,dot:Pt,length:it,len:zt,lengthSq:$,lenSq:j,distance:q,dist:It,distanceSq:ht,distSq:Ft,normalize:xt,negate:Rt,copy:k,clone:At,multiply:Tt,mul:Vt,divide:Mt,div:Et,random:Bt,zero:s,transformMat4:h,transformMat3:i,rotate:a,setLength:m,truncate:x,midpoint:S}}var Ye=new Map;function ke(e){let t=Ye.get(e);return t||(t=Zn(e),Ye.set(e,t)),t}function Qn(e){function t(u,p,w){let b=new e(3);return u!==void 0&&(b[0]=u,p!==void 0&&(b[1]=p,w!==void 0&&(b[2]=w))),b}let l=t;function f(u,p,w,b){let M=b??new e(3);return M[0]=u,M[1]=p,M[2]=w,M}function v(u,p){let w=p??new e(3);return w[0]=Math.ceil(u[0]),w[1]=Math.ceil(u[1]),w[2]=Math.ceil(u[2]),w}function g(u,p){let w=p??new e(3);return w[0]=Math.floor(u[0]),w[1]=Math.floor(u[1]),w[2]=Math.floor(u[2]),w}function T(u,p){let w=p??new e(3);return w[0]=Math.round(u[0]),w[1]=Math.round(u[1]),w[2]=Math.round(u[2]),w}function G(u,p=0,w=1,b){let M=b??new e(3);return M[0]=Math.min(w,Math.max(p,u[0])),M[1]=Math.min(w,Math.max(p,u[1])),M[2]=Math.min(w,Math.max(p,u[2])),M}function D(u,p,w){let b=w??new e(3);return b[0]=u[0]+p[0],b[1]=u[1]+p[1],b[2]=u[2]+p[2],b}function U(u,p,w,b){let M=b??new e(3);return M[0]=u[0]+p[0]*w,M[1]=u[1]+p[1]*w,M[2]=u[2]+p[2]*w,M}function z(u,p){let w=u[0],b=u[1],M=u[2],B=p[0],_=p[1],F=p[2],A=Math.sqrt(w*w+b*b+M*M),I=Math.sqrt(B*B+_*_+F*F),R=A*I,N=R&&Pt(u,p)/R;return Math.acos(N)}function E(u,p,w){let b=w??new e(3);return b[0]=u[0]-p[0],b[1]=u[1]-p[1],b[2]=u[2]-p[2],b}let C=E;function V(u,p){return Math.abs(u[0]-p[0])<O&&Math.abs(u[1]-p[1])<O&&Math.abs(u[2]-p[2])<O}function Y(u,p){return u[0]===p[0]&&u[1]===p[1]&&u[2]===p[2]}function L(u,p,w,b){let M=b??new e(3);return M[0]=u[0]+w*(p[0]-u[0]),M[1]=u[1]+w*(p[1]-u[1]),M[2]=u[2]+w*(p[2]-u[2]),M}function tt(u,p,w,b){let M=b??new e(3);return M[0]=u[0]+w[0]*(p[0]-u[0]),M[1]=u[1]+w[1]*(p[1]-u[1]),M[2]=u[2]+w[2]*(p[2]-u[2]),M}function K(u,p,w){let b=w??new e(3);return b[0]=Math.max(u[0],p[0]),b[1]=Math.max(u[1],p[1]),b[2]=Math.max(u[2],p[2]),b}function et(u,p,w){let b=w??new e(3);return b[0]=Math.min(u[0],p[0]),b[1]=Math.min(u[1],p[1]),b[2]=Math.min(u[2],p[2]),b}function X(u,p,w){let b=w??new e(3);return b[0]=u[0]*p,b[1]=u[1]*p,b[2]=u[2]*p,b}let Z=X;function st(u,p,w){let b=w??new e(3);return b[0]=u[0]/p,b[1]=u[1]/p,b[2]=u[2]/p,b}function pt(u,p){let w=p??new e(3);return w[0]=1/u[0],w[1]=1/u[1],w[2]=1/u[2],w}let mt=pt;function gt(u,p,w){let b=w??new e(3),M=u[2]*p[0]-u[0]*p[2],B=u[0]*p[1]-u[1]*p[0];return b[0]=u[1]*p[2]-u[2]*p[1],b[1]=M,b[2]=B,b}function Pt(u,p){return u[0]*p[0]+u[1]*p[1]+u[2]*p[2]}function it(u){let p=u[0],w=u[1],b=u[2];return Math.sqrt(p*p+w*w+b*b)}let zt=it;function $(u){let p=u[0],w=u[1],b=u[2];return p*p+w*w+b*b}let j=$;function q(u,p){let w=u[0]-p[0],b=u[1]-p[1],M=u[2]-p[2];return Math.sqrt(w*w+b*b+M*M)}let It=q;function ht(u,p){let w=u[0]-p[0],b=u[1]-p[1],M=u[2]-p[2];return w*w+b*b+M*M}let Ft=ht;function xt(u,p){let w=p??new e(3),b=u[0],M=u[1],B=u[2],_=Math.sqrt(b*b+M*M+B*B);return _>1e-5?(w[0]=b/_,w[1]=M/_,w[2]=B/_):(w[0]=0,w[1]=0,w[2]=0),w}function Rt(u,p){let w=p??new e(3);return w[0]=-u[0],w[1]=-u[1],w[2]=-u[2],w}function k(u,p){let w=p??new e(3);return w[0]=u[0],w[1]=u[1],w[2]=u[2],w}let At=k;function Tt(u,p,w){let b=w??new e(3);return b[0]=u[0]*p[0],b[1]=u[1]*p[1],b[2]=u[2]*p[2],b}let Vt=Tt;function Mt(u,p,w){let b=w??new e(3);return b[0]=u[0]/p[0],b[1]=u[1]/p[1],b[2]=u[2]/p[2],b}let Et=Mt;function Bt(u=1,p){let w=p??new e(3),b=Math.random()*2*Math.PI,M=Math.random()*2-1,B=Math.sqrt(1-M*M)*u;return w[0]=Math.cos(b)*B,w[1]=Math.sin(b)*B,w[2]=M*u,w}function s(u){let p=u??new e(3);return p[0]=0,p[1]=0,p[2]=0,p}function h(u,p,w){let b=w??new e(3),M=u[0],B=u[1],_=u[2],F=p[3]*M+p[7]*B+p[11]*_+p[15]||1;return b[0]=(p[0]*M+p[4]*B+p[8]*_+p[12])/F,b[1]=(p[1]*M+p[5]*B+p[9]*_+p[13])/F,b[2]=(p[2]*M+p[6]*B+p[10]*_+p[14])/F,b}function i(u,p,w){let b=w??new e(3),M=u[0],B=u[1],_=u[2];return b[0]=M*p[0*4+0]+B*p[1*4+0]+_*p[2*4+0],b[1]=M*p[0*4+1]+B*p[1*4+1]+_*p[2*4+1],b[2]=M*p[0*4+2]+B*p[1*4+2]+_*p[2*4+2],b}function a(u,p,w){let b=w??new e(3),M=u[0],B=u[1],_=u[2];return b[0]=M*p[0]+B*p[4]+_*p[8],b[1]=M*p[1]+B*p[5]+_*p[9],b[2]=M*p[2]+B*p[6]+_*p[10],b}function m(u,p,w){let b=w??new e(3),M=p[0],B=p[1],_=p[2],F=p[3]*2,A=u[0],I=u[1],R=u[2],N=B*R-_*I,W=_*A-M*R,Q=M*I-B*A;return b[0]=A+N*F+(B*Q-_*W)*2,b[1]=I+W*F+(_*N-M*Q)*2,b[2]=R+Q*F+(M*W-B*N)*2,b}function x(u,p){let w=p??new e(3);return w[0]=u[12],w[1]=u[13],w[2]=u[14],w}function S(u,p,w){let b=w??new e(3),M=p*4;return b[0]=u[M+0],b[1]=u[M+1],b[2]=u[M+2],b}function n(u,p){let w=p??new e(3),b=u[0],M=u[1],B=u[2],_=u[4],F=u[5],A=u[6],I=u[8],R=u[9],N=u[10];return w[0]=Math.sqrt(b*b+M*M+B*B),w[1]=Math.sqrt(_*_+F*F+A*A),w[2]=Math.sqrt(I*I+R*R+N*N),w}function c(u,p,w,b){let M=b??new e(3),B=[],_=[];return B[0]=u[0]-p[0],B[1]=u[1]-p[1],B[2]=u[2]-p[2],_[0]=B[0],_[1]=B[1]*Math.cos(w)-B[2]*Math.sin(w),_[2]=B[1]*Math.sin(w)+B[2]*Math.cos(w),M[0]=_[0]+p[0],M[1]=_[1]+p[1],M[2]=_[2]+p[2],M}function r(u,p,w,b){let M=b??new e(3),B=[],_=[];return B[0]=u[0]-p[0],B[1]=u[1]-p[1],B[2]=u[2]-p[2],_[0]=B[2]*Math.sin(w)+B[0]*Math.cos(w),_[1]=B[1],_[2]=B[2]*Math.cos(w)-B[0]*Math.sin(w),M[0]=_[0]+p[0],M[1]=_[1]+p[1],M[2]=_[2]+p[2],M}function o(u,p,w,b){let M=b??new e(3),B=[],_=[];return B[0]=u[0]-p[0],B[1]=u[1]-p[1],B[2]=u[2]-p[2],_[0]=B[0]*Math.cos(w)-B[1]*Math.sin(w),_[1]=B[0]*Math.sin(w)+B[1]*Math.cos(w),_[2]=B[2],M[0]=_[0]+p[0],M[1]=_[1]+p[1],M[2]=_[2]+p[2],M}function d(u,p,w){let b=w??new e(3);return xt(u,b),X(b,p,b)}function y(u,p,w){let b=w??new e(3);return it(u)>p?d(u,p,b):k(u,b)}function P(u,p,w){let b=w??new e(3);return L(u,p,.5,b)}return{create:t,fromValues:l,set:f,ceil:v,floor:g,round:T,clamp:G,add:D,addScaled:U,angle:z,subtract:E,sub:C,equalsApproximately:V,equals:Y,lerp:L,lerpV:tt,max:K,min:et,mulScalar:X,scale:Z,divScalar:st,inverse:pt,invert:mt,cross:gt,dot:Pt,length:it,len:zt,lengthSq:$,lenSq:j,distance:q,dist:It,distanceSq:ht,distSq:Ft,normalize:xt,negate:Rt,copy:k,clone:At,multiply:Tt,mul:Vt,divide:Mt,div:Et,random:Bt,zero:s,transformMat4:h,transformMat4Upper3x3:i,transformMat3:a,transformQuat:m,getTranslation:x,getAxis:S,getScaling:n,rotateX:c,rotateY:r,rotateZ:o,setLength:d,truncate:y,midpoint:P}}var Xe=new Map;function se(e){let t=Xe.get(e);return t||(t=Qn(e),Xe.set(e,t)),t}function Kn(e){let t=ke(e),l=se(e);function f(s,h,i,a,m,x,S,n,c){let r=new e(12);return r[3]=0,r[7]=0,r[11]=0,s!==void 0&&(r[0]=s,h!==void 0&&(r[1]=h,i!==void 0&&(r[2]=i,a!==void 0&&(r[4]=a,m!==void 0&&(r[5]=m,x!==void 0&&(r[6]=x,S!==void 0&&(r[8]=S,n!==void 0&&(r[9]=n,c!==void 0&&(r[10]=c))))))))),r}function v(s,h,i,a,m,x,S,n,c,r){let o=r??new e(12);return o[0]=s,o[1]=h,o[2]=i,o[3]=0,o[4]=a,o[5]=m,o[6]=x,o[7]=0,o[8]=S,o[9]=n,o[10]=c,o[11]=0,o}function g(s,h){let i=h??new e(12);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=0,i[4]=s[4],i[5]=s[5],i[6]=s[6],i[7]=0,i[8]=s[8],i[9]=s[9],i[10]=s[10],i[11]=0,i}function T(s,h){let i=h??new e(12),a=s[0],m=s[1],x=s[2],S=s[3],n=a+a,c=m+m,r=x+x,o=a*n,d=m*n,y=m*c,P=x*n,u=x*c,p=x*r,w=S*n,b=S*c,M=S*r;return i[0]=1-y-p,i[1]=d+M,i[2]=P-b,i[3]=0,i[4]=d-M,i[5]=1-o-p,i[6]=u+w,i[7]=0,i[8]=P+b,i[9]=u-w,i[10]=1-o-y,i[11]=0,i}function G(s,h){let i=h??new e(12);return i[0]=-s[0],i[1]=-s[1],i[2]=-s[2],i[4]=-s[4],i[5]=-s[5],i[6]=-s[6],i[8]=-s[8],i[9]=-s[9],i[10]=-s[10],i}function D(s,h){let i=h??new e(12);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[4]=s[4],i[5]=s[5],i[6]=s[6],i[8]=s[8],i[9]=s[9],i[10]=s[10],i}let U=D;function z(s,h){return Math.abs(s[0]-h[0])<O&&Math.abs(s[1]-h[1])<O&&Math.abs(s[2]-h[2])<O&&Math.abs(s[4]-h[4])<O&&Math.abs(s[5]-h[5])<O&&Math.abs(s[6]-h[6])<O&&Math.abs(s[8]-h[8])<O&&Math.abs(s[9]-h[9])<O&&Math.abs(s[10]-h[10])<O}function E(s,h){return s[0]===h[0]&&s[1]===h[1]&&s[2]===h[2]&&s[4]===h[4]&&s[5]===h[5]&&s[6]===h[6]&&s[8]===h[8]&&s[9]===h[9]&&s[10]===h[10]}function C(s){let h=s??new e(12);return h[0]=1,h[1]=0,h[2]=0,h[4]=0,h[5]=1,h[6]=0,h[8]=0,h[9]=0,h[10]=1,h}function V(s,h){let i=h??new e(12);if(i===s){let y;return y=s[1],s[1]=s[4],s[4]=y,y=s[2],s[2]=s[8],s[8]=y,y=s[6],s[6]=s[9],s[9]=y,i}let a=s[0*4+0],m=s[0*4+1],x=s[0*4+2],S=s[1*4+0],n=s[1*4+1],c=s[1*4+2],r=s[2*4+0],o=s[2*4+1],d=s[2*4+2];return i[0]=a,i[1]=S,i[2]=r,i[4]=m,i[5]=n,i[6]=o,i[8]=x,i[9]=c,i[10]=d,i}function Y(s,h){let i=h??new e(12),a=s[0*4+0],m=s[0*4+1],x=s[0*4+2],S=s[1*4+0],n=s[1*4+1],c=s[1*4+2],r=s[2*4+0],o=s[2*4+1],d=s[2*4+2],y=d*n-c*o,P=-d*S+c*r,u=o*S-n*r,p=1/(a*y+m*P+x*u);return i[0]=y*p,i[1]=(-d*m+x*o)*p,i[2]=(c*m-x*n)*p,i[4]=P*p,i[5]=(d*a-x*r)*p,i[6]=(-c*a+x*S)*p,i[8]=u*p,i[9]=(-o*a+m*r)*p,i[10]=(n*a-m*S)*p,i}function L(s){let h=s[0],i=s[0*4+1],a=s[0*4+2],m=s[1*4+0],x=s[1*4+1],S=s[1*4+2],n=s[2*4+0],c=s[2*4+1],r=s[2*4+2];return h*(x*r-c*S)-m*(i*r-c*a)+n*(i*S-x*a)}let tt=Y;function K(s,h,i){let a=i??new e(12),m=s[0],x=s[1],S=s[2],n=s[4],c=s[5],r=s[6],o=s[8],d=s[9],y=s[10],P=h[0],u=h[1],p=h[2],w=h[4],b=h[5],M=h[6],B=h[8],_=h[9],F=h[10];return a[0]=m*P+n*u+o*p,a[1]=x*P+c*u+d*p,a[2]=S*P+r*u+y*p,a[4]=m*w+n*b+o*M,a[5]=x*w+c*b+d*M,a[6]=S*w+r*b+y*M,a[8]=m*B+n*_+o*F,a[9]=x*B+c*_+d*F,a[10]=S*B+r*_+y*F,a}let et=K;function X(s,h,i){let a=i??C();return s!==a&&(a[0]=s[0],a[1]=s[1],a[2]=s[2],a[4]=s[4],a[5]=s[5],a[6]=s[6]),a[8]=h[0],a[9]=h[1],a[10]=1,a}function Z(s,h){let i=h??t.create();return i[0]=s[8],i[1]=s[9],i}function st(s,h,i){let a=i??t.create(),m=h*4;return a[0]=s[m+0],a[1]=s[m+1],a}function pt(s,h,i,a){let m=a===s?s:D(s,a),x=i*4;return m[x+0]=h[0],m[x+1]=h[1],m}function mt(s,h){let i=h??t.create(),a=s[0],m=s[1],x=s[4],S=s[5];return i[0]=Math.sqrt(a*a+m*m),i[1]=Math.sqrt(x*x+S*S),i}function gt(s,h){let i=h??l.create(),a=s[0],m=s[1],x=s[2],S=s[4],n=s[5],c=s[6],r=s[8],o=s[9],d=s[10];return i[0]=Math.sqrt(a*a+m*m+x*x),i[1]=Math.sqrt(S*S+n*n+c*c),i[2]=Math.sqrt(r*r+o*o+d*d),i}function Pt(s,h){let i=h??new e(12);return i[0]=1,i[1]=0,i[2]=0,i[4]=0,i[5]=1,i[6]=0,i[8]=s[0],i[9]=s[1],i[10]=1,i}function it(s,h,i){let a=i??new e(12),m=h[0],x=h[1],S=s[0],n=s[1],c=s[2],r=s[1*4+0],o=s[1*4+1],d=s[1*4+2],y=s[2*4+0],P=s[2*4+1],u=s[2*4+2];return s!==a&&(a[0]=S,a[1]=n,a[2]=c,a[4]=r,a[5]=o,a[6]=d),a[8]=S*m+r*x+y,a[9]=n*m+o*x+P,a[10]=c*m+d*x+u,a}function zt(s,h){let i=h??new e(12),a=Math.cos(s),m=Math.sin(s);return i[0]=a,i[1]=m,i[2]=0,i[4]=-m,i[5]=a,i[6]=0,i[8]=0,i[9]=0,i[10]=1,i}function $(s,h,i){let a=i??new e(12),m=s[0*4+0],x=s[0*4+1],S=s[0*4+2],n=s[1*4+0],c=s[1*4+1],r=s[1*4+2],o=Math.cos(h),d=Math.sin(h);return a[0]=o*m+d*n,a[1]=o*x+d*c,a[2]=o*S+d*r,a[4]=o*n-d*m,a[5]=o*c-d*x,a[6]=o*r-d*S,s!==a&&(a[8]=s[8],a[9]=s[9],a[10]=s[10]),a}function j(s,h){let i=h??new e(12),a=Math.cos(s),m=Math.sin(s);return i[0]=1,i[1]=0,i[2]=0,i[4]=0,i[5]=a,i[6]=m,i[8]=0,i[9]=-m,i[10]=a,i}function q(s,h,i){let a=i??new e(12),m=s[4],x=s[5],S=s[6],n=s[8],c=s[9],r=s[10],o=Math.cos(h),d=Math.sin(h);return a[4]=o*m+d*n,a[5]=o*x+d*c,a[6]=o*S+d*r,a[8]=o*n-d*m,a[9]=o*c-d*x,a[10]=o*r-d*S,s!==a&&(a[0]=s[0],a[1]=s[1],a[2]=s[2]),a}function It(s,h){let i=h??new e(12),a=Math.cos(s),m=Math.sin(s);return i[0]=a,i[1]=0,i[2]=-m,i[4]=0,i[5]=1,i[6]=0,i[8]=m,i[9]=0,i[10]=a,i}function ht(s,h,i){let a=i??new e(12),m=s[0*4+0],x=s[0*4+1],S=s[0*4+2],n=s[2*4+0],c=s[2*4+1],r=s[2*4+2],o=Math.cos(h),d=Math.sin(h);return a[0]=o*m-d*n,a[1]=o*x-d*c,a[2]=o*S-d*r,a[8]=o*n+d*m,a[9]=o*c+d*x,a[10]=o*r+d*S,s!==a&&(a[4]=s[4],a[5]=s[5],a[6]=s[6]),a}let Ft=zt,xt=$;function Rt(s,h){let i=h??new e(12);return i[0]=s[0],i[1]=0,i[2]=0,i[4]=0,i[5]=s[1],i[6]=0,i[8]=0,i[9]=0,i[10]=1,i}function k(s,h,i){let a=i??new e(12),m=h[0],x=h[1];return a[0]=m*s[0*4+0],a[1]=m*s[0*4+1],a[2]=m*s[0*4+2],a[4]=x*s[1*4+0],a[5]=x*s[1*4+1],a[6]=x*s[1*4+2],s!==a&&(a[8]=s[8],a[9]=s[9],a[10]=s[10]),a}function At(s,h){let i=h??new e(12);return i[0]=s[0],i[1]=0,i[2]=0,i[4]=0,i[5]=s[1],i[6]=0,i[8]=0,i[9]=0,i[10]=s[2],i}function Tt(s,h,i){let a=i??new e(12),m=h[0],x=h[1],S=h[2];return a[0]=m*s[0*4+0],a[1]=m*s[0*4+1],a[2]=m*s[0*4+2],a[4]=x*s[1*4+0],a[5]=x*s[1*4+1],a[6]=x*s[1*4+2],a[8]=S*s[2*4+0],a[9]=S*s[2*4+1],a[10]=S*s[2*4+2],a}function Vt(s,h){let i=h??new e(12);return i[0]=s,i[1]=0,i[2]=0,i[4]=0,i[5]=s,i[6]=0,i[8]=0,i[9]=0,i[10]=1,i}function Mt(s,h,i){let a=i??new e(12);return a[0]=h*s[0*4+0],a[1]=h*s[0*4+1],a[2]=h*s[0*4+2],a[4]=h*s[1*4+0],a[5]=h*s[1*4+1],a[6]=h*s[1*4+2],s!==a&&(a[8]=s[8],a[9]=s[9],a[10]=s[10]),a}function Et(s,h){let i=h??new e(12);return i[0]=s,i[1]=0,i[2]=0,i[4]=0,i[5]=s,i[6]=0,i[8]=0,i[9]=0,i[10]=s,i}function Bt(s,h,i){let a=i??new e(12);return a[0]=h*s[0*4+0],a[1]=h*s[0*4+1],a[2]=h*s[0*4+2],a[4]=h*s[1*4+0],a[5]=h*s[1*4+1],a[6]=h*s[1*4+2],a[8]=h*s[2*4+0],a[9]=h*s[2*4+1],a[10]=h*s[2*4+2],a}return{clone:U,create:f,set:v,fromMat4:g,fromQuat:T,negate:G,copy:D,equalsApproximately:z,equals:E,identity:C,transpose:V,inverse:Y,invert:tt,determinant:L,mul:et,multiply:K,setTranslation:X,getTranslation:Z,getAxis:st,setAxis:pt,getScaling:mt,get3DScaling:gt,translation:Pt,translate:it,rotation:zt,rotate:$,rotationX:j,rotateX:q,rotationY:It,rotateY:ht,rotationZ:Ft,rotateZ:xt,scaling:Rt,scale:k,uniformScaling:Vt,uniformScale:Mt,scaling3D:At,scale3D:Tt,uniformScaling3D:Et,uniformScale3D:Bt}}var $e=new Map;function Jn(e){let t=$e.get(e);return t||(t=Kn(e),$e.set(e,t)),t}function tr(e){let t=se(e);function l(n,c,r,o,d,y,P,u,p,w,b,M,B,_,F,A){let I=new e(16);return n!==void 0&&(I[0]=n,c!==void 0&&(I[1]=c,r!==void 0&&(I[2]=r,o!==void 0&&(I[3]=o,d!==void 0&&(I[4]=d,y!==void 0&&(I[5]=y,P!==void 0&&(I[6]=P,u!==void 0&&(I[7]=u,p!==void 0&&(I[8]=p,w!==void 0&&(I[9]=w,b!==void 0&&(I[10]=b,M!==void 0&&(I[11]=M,B!==void 0&&(I[12]=B,_!==void 0&&(I[13]=_,F!==void 0&&(I[14]=F,A!==void 0&&(I[15]=A)))))))))))))))),I}function f(n,c,r,o,d,y,P,u,p,w,b,M,B,_,F,A,I){let R=I??new e(16);return R[0]=n,R[1]=c,R[2]=r,R[3]=o,R[4]=d,R[5]=y,R[6]=P,R[7]=u,R[8]=p,R[9]=w,R[10]=b,R[11]=M,R[12]=B,R[13]=_,R[14]=F,R[15]=A,R}function v(n,c){let r=c??new e(16);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=0,r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=0,r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function g(n,c){let r=c??new e(16),o=n[0],d=n[1],y=n[2],P=n[3],u=o+o,p=d+d,w=y+y,b=o*u,M=d*u,B=d*p,_=y*u,F=y*p,A=y*w,I=P*u,R=P*p,N=P*w;return r[0]=1-B-A,r[1]=M+N,r[2]=_-R,r[3]=0,r[4]=M-N,r[5]=1-b-A,r[6]=F+I,r[7]=0,r[8]=_+R,r[9]=F-I,r[10]=1-b-B,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function T(n,c){let r=c??new e(16);return r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r[4]=-n[4],r[5]=-n[5],r[6]=-n[6],r[7]=-n[7],r[8]=-n[8],r[9]=-n[9],r[10]=-n[10],r[11]=-n[11],r[12]=-n[12],r[13]=-n[13],r[14]=-n[14],r[15]=-n[15],r}function G(n,c){let r=c??new e(16);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r}let D=G;function U(n,c){return Math.abs(n[0]-c[0])<O&&Math.abs(n[1]-c[1])<O&&Math.abs(n[2]-c[2])<O&&Math.abs(n[3]-c[3])<O&&Math.abs(n[4]-c[4])<O&&Math.abs(n[5]-c[5])<O&&Math.abs(n[6]-c[6])<O&&Math.abs(n[7]-c[7])<O&&Math.abs(n[8]-c[8])<O&&Math.abs(n[9]-c[9])<O&&Math.abs(n[10]-c[10])<O&&Math.abs(n[11]-c[11])<O&&Math.abs(n[12]-c[12])<O&&Math.abs(n[13]-c[13])<O&&Math.abs(n[14]-c[14])<O&&Math.abs(n[15]-c[15])<O}function z(n,c){return n[0]===c[0]&&n[1]===c[1]&&n[2]===c[2]&&n[3]===c[3]&&n[4]===c[4]&&n[5]===c[5]&&n[6]===c[6]&&n[7]===c[7]&&n[8]===c[8]&&n[9]===c[9]&&n[10]===c[10]&&n[11]===c[11]&&n[12]===c[12]&&n[13]===c[13]&&n[14]===c[14]&&n[15]===c[15]}function E(n){let c=n??new e(16);return c[0]=1,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=1,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c}function C(n,c){let r=c??new e(16);if(r===n){let W;return W=n[1],n[1]=n[4],n[4]=W,W=n[2],n[2]=n[8],n[8]=W,W=n[3],n[3]=n[12],n[12]=W,W=n[6],n[6]=n[9],n[9]=W,W=n[7],n[7]=n[13],n[13]=W,W=n[11],n[11]=n[14],n[14]=W,r}let o=n[0*4+0],d=n[0*4+1],y=n[0*4+2],P=n[0*4+3],u=n[1*4+0],p=n[1*4+1],w=n[1*4+2],b=n[1*4+3],M=n[2*4+0],B=n[2*4+1],_=n[2*4+2],F=n[2*4+3],A=n[3*4+0],I=n[3*4+1],R=n[3*4+2],N=n[3*4+3];return r[0]=o,r[1]=u,r[2]=M,r[3]=A,r[4]=d,r[5]=p,r[6]=B,r[7]=I,r[8]=y,r[9]=w,r[10]=_,r[11]=R,r[12]=P,r[13]=b,r[14]=F,r[15]=N,r}function V(n,c){let r=c??new e(16),o=n[0*4+0],d=n[0*4+1],y=n[0*4+2],P=n[0*4+3],u=n[1*4+0],p=n[1*4+1],w=n[1*4+2],b=n[1*4+3],M=n[2*4+0],B=n[2*4+1],_=n[2*4+2],F=n[2*4+3],A=n[3*4+0],I=n[3*4+1],R=n[3*4+2],N=n[3*4+3],W=_*N,Q=R*F,nt=w*N,rt=R*b,ot=w*F,at=_*b,ct=y*N,ut=R*P,lt=y*F,ft=_*P,vt=y*b,wt=w*P,yt=M*I,bt=A*B,Dt=u*I,_t=A*p,Gt=u*B,kt=M*p,Zt=o*I,Qt=A*d,Kt=o*B,Jt=M*d,te=o*p,ee=u*d,Se=W*p+rt*B+ot*I-(Q*p+nt*B+at*I),Pe=Q*d+ct*B+ft*I-(W*d+ut*B+lt*I),Be=nt*d+ut*p+vt*I-(rt*d+ct*p+wt*I),De=at*d+lt*p+wt*B-(ot*d+ft*p+vt*B),dt=1/(o*Se+u*Pe+M*Be+A*De);return r[0]=dt*Se,r[1]=dt*Pe,r[2]=dt*Be,r[3]=dt*De,r[4]=dt*(Q*u+nt*M+at*A-(W*u+rt*M+ot*A)),r[5]=dt*(W*o+ut*M+lt*A-(Q*o+ct*M+ft*A)),r[6]=dt*(rt*o+ct*u+wt*A-(nt*o+ut*u+vt*A)),r[7]=dt*(ot*o+ft*u+vt*M-(at*o+lt*u+wt*M)),r[8]=dt*(yt*b+_t*F+Gt*N-(bt*b+Dt*F+kt*N)),r[9]=dt*(bt*P+Zt*F+Jt*N-(yt*P+Qt*F+Kt*N)),r[10]=dt*(Dt*P+Qt*b+te*N-(_t*P+Zt*b+ee*N)),r[11]=dt*(kt*P+Kt*b+ee*F-(Gt*P+Jt*b+te*F)),r[12]=dt*(Dt*_+kt*R+bt*w-(Gt*R+yt*w+_t*_)),r[13]=dt*(Kt*R+yt*y+Qt*_-(Zt*_+Jt*R+bt*y)),r[14]=dt*(Zt*w+ee*R+_t*y-(te*R+Dt*y+Qt*w)),r[15]=dt*(te*_+Gt*y+Jt*w-(Kt*w+ee*_+kt*y)),r}function Y(n){let c=n[0],r=n[0*4+1],o=n[0*4+2],d=n[0*4+3],y=n[1*4+0],P=n[1*4+1],u=n[1*4+2],p=n[1*4+3],w=n[2*4+0],b=n[2*4+1],M=n[2*4+2],B=n[2*4+3],_=n[3*4+0],F=n[3*4+1],A=n[3*4+2],I=n[3*4+3],R=M*I,N=A*B,W=u*I,Q=A*p,nt=u*B,rt=M*p,ot=o*I,at=A*d,ct=o*B,ut=M*d,lt=o*p,ft=u*d,vt=R*P+Q*b+nt*F-(N*P+W*b+rt*F),wt=N*r+ot*b+ut*F-(R*r+at*b+ct*F),yt=W*r+at*P+lt*F-(Q*r+ot*P+ft*F),bt=rt*r+ct*P+ft*b-(nt*r+ut*P+lt*b);return c*vt+y*wt+w*yt+_*bt}let L=V;function tt(n,c,r){let o=r??new e(16),d=n[0],y=n[1],P=n[2],u=n[3],p=n[4],w=n[5],b=n[6],M=n[7],B=n[8],_=n[9],F=n[10],A=n[11],I=n[12],R=n[13],N=n[14],W=n[15],Q=c[0],nt=c[1],rt=c[2],ot=c[3],at=c[4],ct=c[5],ut=c[6],lt=c[7],ft=c[8],vt=c[9],wt=c[10],yt=c[11],bt=c[12],Dt=c[13],_t=c[14],Gt=c[15];return o[0]=d*Q+p*nt+B*rt+I*ot,o[1]=y*Q+w*nt+_*rt+R*ot,o[2]=P*Q+b*nt+F*rt+N*ot,o[3]=u*Q+M*nt+A*rt+W*ot,o[4]=d*at+p*ct+B*ut+I*lt,o[5]=y*at+w*ct+_*ut+R*lt,o[6]=P*at+b*ct+F*ut+N*lt,o[7]=u*at+M*ct+A*ut+W*lt,o[8]=d*ft+p*vt+B*wt+I*yt,o[9]=y*ft+w*vt+_*wt+R*yt,o[10]=P*ft+b*vt+F*wt+N*yt,o[11]=u*ft+M*vt+A*wt+W*yt,o[12]=d*bt+p*Dt+B*_t+I*Gt,o[13]=y*bt+w*Dt+_*_t+R*Gt,o[14]=P*bt+b*Dt+F*_t+N*Gt,o[15]=u*bt+M*Dt+A*_t+W*Gt,o}let K=tt;function et(n,c,r){let o=r??E();return n!==o&&(o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],o[4]=n[4],o[5]=n[5],o[6]=n[6],o[7]=n[7],o[8]=n[8],o[9]=n[9],o[10]=n[10],o[11]=n[11]),o[12]=c[0],o[13]=c[1],o[14]=c[2],o[15]=1,o}function X(n,c){let r=c??t.create();return r[0]=n[12],r[1]=n[13],r[2]=n[14],r}function Z(n,c,r){let o=r??t.create(),d=c*4;return o[0]=n[d+0],o[1]=n[d+1],o[2]=n[d+2],o}function st(n,c,r,o){let d=o===n?o:G(n,o),y=r*4;return d[y+0]=c[0],d[y+1]=c[1],d[y+2]=c[2],d}function pt(n,c){let r=c??t.create(),o=n[0],d=n[1],y=n[2],P=n[4],u=n[5],p=n[6],w=n[8],b=n[9],M=n[10];return r[0]=Math.sqrt(o*o+d*d+y*y),r[1]=Math.sqrt(P*P+u*u+p*p),r[2]=Math.sqrt(w*w+b*b+M*M),r}function mt(n,c,r,o,d){let y=d??new e(16),P=Math.tan(Math.PI*.5-.5*n);if(y[0]=P/c,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=P,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,Number.isFinite(o)){let u=1/(r-o);y[10]=o*u,y[14]=o*r*u}else y[10]=-1,y[14]=-r;return y}function gt(n,c,r,o=1/0,d){let y=d??new e(16),P=1/Math.tan(n*.5);if(y[0]=P/c,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=P,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,o===1/0)y[10]=0,y[14]=r;else{let u=1/(o-r);y[10]=r*u,y[14]=o*r*u}return y}function Pt(n,c,r,o,d,y,P){let u=P??new e(16);return u[0]=2/(c-n),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(o-r),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1/(d-y),u[11]=0,u[12]=(c+n)/(n-c),u[13]=(o+r)/(r-o),u[14]=d/(d-y),u[15]=1,u}function it(n,c,r,o,d,y,P){let u=P??new e(16),p=c-n,w=o-r,b=d-y;return u[0]=2*d/p,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*d/w,u[6]=0,u[7]=0,u[8]=(n+c)/p,u[9]=(o+r)/w,u[10]=y/b,u[11]=-1,u[12]=0,u[13]=0,u[14]=d*y/b,u[15]=0,u}function zt(n,c,r,o,d,y=1/0,P){let u=P??new e(16),p=c-n,w=o-r;if(u[0]=2*d/p,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*d/w,u[6]=0,u[7]=0,u[8]=(n+c)/p,u[9]=(o+r)/w,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,y===1/0)u[10]=0,u[14]=d;else{let b=1/(y-d);u[10]=d*b,u[14]=y*d*b}return u}let $=t.create(),j=t.create(),q=t.create();function It(n,c,r,o){let d=o??new e(16);return t.normalize(t.subtract(c,n,q),q),t.normalize(t.cross(r,q,$),$),t.normalize(t.cross(q,$,j),j),d[0]=$[0],d[1]=$[1],d[2]=$[2],d[3]=0,d[4]=j[0],d[5]=j[1],d[6]=j[2],d[7]=0,d[8]=q[0],d[9]=q[1],d[10]=q[2],d[11]=0,d[12]=n[0],d[13]=n[1],d[14]=n[2],d[15]=1,d}function ht(n,c,r,o){let d=o??new e(16);return t.normalize(t.subtract(n,c,q),q),t.normalize(t.cross(r,q,$),$),t.normalize(t.cross(q,$,j),j),d[0]=$[0],d[1]=$[1],d[2]=$[2],d[3]=0,d[4]=j[0],d[5]=j[1],d[6]=j[2],d[7]=0,d[8]=q[0],d[9]=q[1],d[10]=q[2],d[11]=0,d[12]=n[0],d[13]=n[1],d[14]=n[2],d[15]=1,d}function Ft(n,c,r,o){let d=o??new e(16);return t.normalize(t.subtract(n,c,q),q),t.normalize(t.cross(r,q,$),$),t.normalize(t.cross(q,$,j),j),d[0]=$[0],d[1]=j[0],d[2]=q[0],d[3]=0,d[4]=$[1],d[5]=j[1],d[6]=q[1],d[7]=0,d[8]=$[2],d[9]=j[2],d[10]=q[2],d[11]=0,d[12]=-($[0]*n[0]+$[1]*n[1]+$[2]*n[2]),d[13]=-(j[0]*n[0]+j[1]*n[1]+j[2]*n[2]),d[14]=-(q[0]*n[0]+q[1]*n[1]+q[2]*n[2]),d[15]=1,d}function xt(n,c){let r=c??new e(16);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function Rt(n,c,r){let o=r??new e(16),d=c[0],y=c[1],P=c[2],u=n[0],p=n[1],w=n[2],b=n[3],M=n[1*4+0],B=n[1*4+1],_=n[1*4+2],F=n[1*4+3],A=n[2*4+0],I=n[2*4+1],R=n[2*4+2],N=n[2*4+3],W=n[3*4+0],Q=n[3*4+1],nt=n[3*4+2],rt=n[3*4+3];return n!==o&&(o[0]=u,o[1]=p,o[2]=w,o[3]=b,o[4]=M,o[5]=B,o[6]=_,o[7]=F,o[8]=A,o[9]=I,o[10]=R,o[11]=N),o[12]=u*d+M*y+A*P+W,o[13]=p*d+B*y+I*P+Q,o[14]=w*d+_*y+R*P+nt,o[15]=b*d+F*y+N*P+rt,o}function k(n,c){let r=c??new e(16),o=Math.cos(n),d=Math.sin(n);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=o,r[6]=d,r[7]=0,r[8]=0,r[9]=-d,r[10]=o,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function At(n,c,r){let o=r??new e(16),d=n[4],y=n[5],P=n[6],u=n[7],p=n[8],w=n[9],b=n[10],M=n[11],B=Math.cos(c),_=Math.sin(c);return o[4]=B*d+_*p,o[5]=B*y+_*w,o[6]=B*P+_*b,o[7]=B*u+_*M,o[8]=B*p-_*d,o[9]=B*w-_*y,o[10]=B*b-_*P,o[11]=B*M-_*u,n!==o&&(o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function Tt(n,c){let r=c??new e(16),o=Math.cos(n),d=Math.sin(n);return r[0]=o,r[1]=0,r[2]=-d,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=d,r[9]=0,r[10]=o,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Vt(n,c,r){let o=r??new e(16),d=n[0*4+0],y=n[0*4+1],P=n[0*4+2],u=n[0*4+3],p=n[2*4+0],w=n[2*4+1],b=n[2*4+2],M=n[2*4+3],B=Math.cos(c),_=Math.sin(c);return o[0]=B*d-_*p,o[1]=B*y-_*w,o[2]=B*P-_*b,o[3]=B*u-_*M,o[8]=B*p+_*d,o[9]=B*w+_*y,o[10]=B*b+_*P,o[11]=B*M+_*u,n!==o&&(o[4]=n[4],o[5]=n[5],o[6]=n[6],o[7]=n[7],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function Mt(n,c){let r=c??new e(16),o=Math.cos(n),d=Math.sin(n);return r[0]=o,r[1]=d,r[2]=0,r[3]=0,r[4]=-d,r[5]=o,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Et(n,c,r){let o=r??new e(16),d=n[0*4+0],y=n[0*4+1],P=n[0*4+2],u=n[0*4+3],p=n[1*4+0],w=n[1*4+1],b=n[1*4+2],M=n[1*4+3],B=Math.cos(c),_=Math.sin(c);return o[0]=B*d+_*p,o[1]=B*y+_*w,o[2]=B*P+_*b,o[3]=B*u+_*M,o[4]=B*p-_*d,o[5]=B*w-_*y,o[6]=B*b-_*P,o[7]=B*M-_*u,n!==o&&(o[8]=n[8],o[9]=n[9],o[10]=n[10],o[11]=n[11],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function Bt(n,c,r){let o=r??new e(16),d=n[0],y=n[1],P=n[2],u=Math.sqrt(d*d+y*y+P*P);d/=u,y/=u,P/=u;let p=d*d,w=y*y,b=P*P,M=Math.cos(c),B=Math.sin(c),_=1-M;return o[0]=p+(1-p)*M,o[1]=d*y*_+P*B,o[2]=d*P*_-y*B,o[3]=0,o[4]=d*y*_-P*B,o[5]=w+(1-w)*M,o[6]=y*P*_+d*B,o[7]=0,o[8]=d*P*_+y*B,o[9]=y*P*_-d*B,o[10]=b+(1-b)*M,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}let s=Bt;function h(n,c,r,o){let d=o??new e(16),y=c[0],P=c[1],u=c[2],p=Math.sqrt(y*y+P*P+u*u);y/=p,P/=p,u/=p;let w=y*y,b=P*P,M=u*u,B=Math.cos(r),_=Math.sin(r),F=1-B,A=w+(1-w)*B,I=y*P*F+u*_,R=y*u*F-P*_,N=y*P*F-u*_,W=b+(1-b)*B,Q=P*u*F+y*_,nt=y*u*F+P*_,rt=P*u*F-y*_,ot=M+(1-M)*B,at=n[0],ct=n[1],ut=n[2],lt=n[3],ft=n[4],vt=n[5],wt=n[6],yt=n[7],bt=n[8],Dt=n[9],_t=n[10],Gt=n[11];return d[0]=A*at+I*ft+R*bt,d[1]=A*ct+I*vt+R*Dt,d[2]=A*ut+I*wt+R*_t,d[3]=A*lt+I*yt+R*Gt,d[4]=N*at+W*ft+Q*bt,d[5]=N*ct+W*vt+Q*Dt,d[6]=N*ut+W*wt+Q*_t,d[7]=N*lt+W*yt+Q*Gt,d[8]=nt*at+rt*ft+ot*bt,d[9]=nt*ct+rt*vt+ot*Dt,d[10]=nt*ut+rt*wt+ot*_t,d[11]=nt*lt+rt*yt+ot*Gt,n!==d&&(d[12]=n[12],d[13]=n[13],d[14]=n[14],d[15]=n[15]),d}let i=h;function a(n,c){let r=c??new e(16);return r[0]=n[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function m(n,c,r){let o=r??new e(16),d=c[0],y=c[1],P=c[2];return o[0]=d*n[0*4+0],o[1]=d*n[0*4+1],o[2]=d*n[0*4+2],o[3]=d*n[0*4+3],o[4]=y*n[1*4+0],o[5]=y*n[1*4+1],o[6]=y*n[1*4+2],o[7]=y*n[1*4+3],o[8]=P*n[2*4+0],o[9]=P*n[2*4+1],o[10]=P*n[2*4+2],o[11]=P*n[2*4+3],n!==o&&(o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function x(n,c){let r=c??new e(16);return r[0]=n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function S(n,c,r){let o=r??new e(16);return o[0]=c*n[0*4+0],o[1]=c*n[0*4+1],o[2]=c*n[0*4+2],o[3]=c*n[0*4+3],o[4]=c*n[1*4+0],o[5]=c*n[1*4+1],o[6]=c*n[1*4+2],o[7]=c*n[1*4+3],o[8]=c*n[2*4+0],o[9]=c*n[2*4+1],o[10]=c*n[2*4+2],o[11]=c*n[2*4+3],n!==o&&(o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}return{create:l,set:f,fromMat3:v,fromQuat:g,negate:T,copy:G,clone:D,equalsApproximately:U,equals:z,identity:E,transpose:C,inverse:V,determinant:Y,invert:L,multiply:tt,mul:K,setTranslation:et,getTranslation:X,getAxis:Z,setAxis:st,getScaling:pt,perspective:mt,perspectiveReverseZ:gt,ortho:Pt,frustum:it,frustumReverseZ:zt,aim:It,cameraAim:ht,lookAt:Ft,translation:xt,translate:Rt,rotationX:k,rotateX:At,rotationY:Tt,rotateY:Vt,rotationZ:Mt,rotateZ:Et,axisRotation:Bt,rotation:s,axisRotate:h,rotate:i,scaling:a,scale:m,uniformScaling:x,uniformScale:S}}var We=new Map;function er(e){let t=We.get(e);return t||(t=tr(e),We.set(e,t)),t}function nr(e){let t=se(e);function l(s,h,i,a){let m=new e(4);return s!==void 0&&(m[0]=s,h!==void 0&&(m[1]=h,i!==void 0&&(m[2]=i,a!==void 0&&(m[3]=a)))),m}let f=l;function v(s,h,i,a,m){let x=m??new e(4);return x[0]=s,x[1]=h,x[2]=i,x[3]=a,x}function g(s,h,i){let a=i??new e(4),m=h*.5,x=Math.sin(m);return a[0]=x*s[0],a[1]=x*s[1],a[2]=x*s[2],a[3]=Math.cos(m),a}function T(s,h){let i=h??t.create(3),a=Math.acos(s[3])*2,m=Math.sin(a*.5);return m>O?(i[0]=s[0]/m,i[1]=s[1]/m,i[2]=s[2]/m):(i[0]=1,i[1]=0,i[2]=0),{angle:a,axis:i}}function G(s,h){let i=it(s,h);return Math.acos(2*i*i-1)}function D(s,h,i){let a=i??new e(4),m=s[0],x=s[1],S=s[2],n=s[3],c=h[0],r=h[1],o=h[2],d=h[3];return a[0]=m*d+n*c+x*o-S*r,a[1]=x*d+n*r+S*c-m*o,a[2]=S*d+n*o+m*r-x*c,a[3]=n*d-m*c-x*r-S*o,a}let U=D;function z(s,h,i){let a=i??new e(4),m=h*.5,x=s[0],S=s[1],n=s[2],c=s[3],r=Math.sin(m),o=Math.cos(m);return a[0]=x*o+c*r,a[1]=S*o+n*r,a[2]=n*o-S*r,a[3]=c*o-x*r,a}function E(s,h,i){let a=i??new e(4),m=h*.5,x=s[0],S=s[1],n=s[2],c=s[3],r=Math.sin(m),o=Math.cos(m);return a[0]=x*o-n*r,a[1]=S*o+c*r,a[2]=n*o+x*r,a[3]=c*o-S*r,a}function C(s,h,i){let a=i??new e(4),m=h*.5,x=s[0],S=s[1],n=s[2],c=s[3],r=Math.sin(m),o=Math.cos(m);return a[0]=x*o+S*r,a[1]=S*o-x*r,a[2]=n*o+c*r,a[3]=c*o-n*r,a}function V(s,h,i,a){let m=a??new e(4),x=s[0],S=s[1],n=s[2],c=s[3],r=h[0],o=h[1],d=h[2],y=h[3],P=x*r+S*o+n*d+c*y;P<0&&(P=-P,r=-r,o=-o,d=-d,y=-y);let u,p;if(1-P>O){let w=Math.acos(P),b=Math.sin(w);u=Math.sin((1-i)*w)/b,p=Math.sin(i*w)/b}else u=1-i,p=i;return m[0]=u*x+p*r,m[1]=u*S+p*o,m[2]=u*n+p*d,m[3]=u*c+p*y,m}function Y(s,h){let i=h??new e(4),a=s[0],m=s[1],x=s[2],S=s[3],n=a*a+m*m+x*x+S*S,c=n?1/n:0;return i[0]=-a*c,i[1]=-m*c,i[2]=-x*c,i[3]=S*c,i}function L(s,h){let i=h??new e(4);return i[0]=-s[0],i[1]=-s[1],i[2]=-s[2],i[3]=s[3],i}function tt(s,h){let i=h??new e(4),a=s[0]+s[5]+s[10];if(a>0){let m=Math.sqrt(a+1);i[3]=.5*m;let x=.5/m;i[0]=(s[6]-s[9])*x,i[1]=(s[8]-s[2])*x,i[2]=(s[1]-s[4])*x}else{let m=0;s[5]>s[0]&&(m=1),s[10]>s[m*4+m]&&(m=2);let x=(m+1)%3,S=(m+2)%3,n=Math.sqrt(s[m*4+m]-s[x*4+x]-s[S*4+S]+1);i[m]=.5*n;let c=.5/n;i[3]=(s[x*4+S]-s[S*4+x])*c,i[x]=(s[x*4+m]+s[m*4+x])*c,i[S]=(s[S*4+m]+s[m*4+S])*c}return i}function K(s,h,i,a,m){let x=m??new e(4),S=s*.5,n=h*.5,c=i*.5,r=Math.sin(S),o=Math.cos(S),d=Math.sin(n),y=Math.cos(n),P=Math.sin(c),u=Math.cos(c);switch(a){case"xyz":x[0]=r*y*u+o*d*P,x[1]=o*d*u-r*y*P,x[2]=o*y*P+r*d*u,x[3]=o*y*u-r*d*P;break;case"xzy":x[0]=r*y*u-o*d*P,x[1]=o*d*u-r*y*P,x[2]=o*y*P+r*d*u,x[3]=o*y*u+r*d*P;break;case"yxz":x[0]=r*y*u+o*d*P,x[1]=o*d*u-r*y*P,x[2]=o*y*P-r*d*u,x[3]=o*y*u+r*d*P;break;case"yzx":x[0]=r*y*u+o*d*P,x[1]=o*d*u+r*y*P,x[2]=o*y*P-r*d*u,x[3]=o*y*u-r*d*P;break;case"zxy":x[0]=r*y*u-o*d*P,x[1]=o*d*u+r*y*P,x[2]=o*y*P+r*d*u,x[3]=o*y*u-r*d*P;break;case"zyx":x[0]=r*y*u-o*d*P,x[1]=o*d*u+r*y*P,x[2]=o*y*P-r*d*u,x[3]=o*y*u+r*d*P;break;default:throw new Error(`Unknown rotation order: ${a}`)}return x}function et(s,h){let i=h??new e(4);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],i}let X=et;function Z(s,h,i){let a=i??new e(4);return a[0]=s[0]+h[0],a[1]=s[1]+h[1],a[2]=s[2]+h[2],a[3]=s[3]+h[3],a}function st(s,h,i){let a=i??new e(4);return a[0]=s[0]-h[0],a[1]=s[1]-h[1],a[2]=s[2]-h[2],a[3]=s[3]-h[3],a}let pt=st;function mt(s,h,i){let a=i??new e(4);return a[0]=s[0]*h,a[1]=s[1]*h,a[2]=s[2]*h,a[3]=s[3]*h,a}let gt=mt;function Pt(s,h,i){let a=i??new e(4);return a[0]=s[0]/h,a[1]=s[1]/h,a[2]=s[2]/h,a[3]=s[3]/h,a}function it(s,h){return s[0]*h[0]+s[1]*h[1]+s[2]*h[2]+s[3]*h[3]}function zt(s,h,i,a){let m=a??new e(4);return m[0]=s[0]+i*(h[0]-s[0]),m[1]=s[1]+i*(h[1]-s[1]),m[2]=s[2]+i*(h[2]-s[2]),m[3]=s[3]+i*(h[3]-s[3]),m}function $(s){let h=s[0],i=s[1],a=s[2],m=s[3];return Math.sqrt(h*h+i*i+a*a+m*m)}let j=$;function q(s){let h=s[0],i=s[1],a=s[2],m=s[3];return h*h+i*i+a*a+m*m}let It=q;function ht(s,h){let i=h??new e(4),a=s[0],m=s[1],x=s[2],S=s[3],n=Math.sqrt(a*a+m*m+x*x+S*S);return n>1e-5?(i[0]=a/n,i[1]=m/n,i[2]=x/n,i[3]=S/n):(i[0]=0,i[1]=0,i[2]=0,i[3]=1),i}function Ft(s,h){return Math.abs(s[0]-h[0])<O&&Math.abs(s[1]-h[1])<O&&Math.abs(s[2]-h[2])<O&&Math.abs(s[3]-h[3])<O}function xt(s,h){return s[0]===h[0]&&s[1]===h[1]&&s[2]===h[2]&&s[3]===h[3]}function Rt(s){let h=s??new e(4);return h[0]=0,h[1]=0,h[2]=0,h[3]=1,h}let k=t.create(),At=t.create(),Tt=t.create();function Vt(s,h,i){let a=i??new e(4),m=t.dot(s,h);return m<-.999999?(t.cross(At,s,k),t.len(k)<1e-6&&t.cross(Tt,s,k),t.normalize(k,k),g(k,Math.PI,a),a):m>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(t.cross(s,h,k),a[0]=k[0],a[1]=k[1],a[2]=k[2],a[3]=1+m,ht(a,a))}let Mt=new e(4),Et=new e(4);function Bt(s,h,i,a,m,x){let S=x??new e(4);return V(s,a,m,Mt),V(h,i,m,Et),V(Mt,Et,2*m*(1-m),S),S}return{create:l,fromValues:f,set:v,fromAxisAngle:g,toAxisAngle:T,angle:G,multiply:D,mul:U,rotateX:z,rotateY:E,rotateZ:C,slerp:V,inverse:Y,conjugate:L,fromMat:tt,fromEuler:K,copy:et,clone:X,add:Z,subtract:st,sub:pt,mulScalar:mt,scale:gt,divScalar:Pt,dot:it,lerp:zt,length:$,len:j,lengthSq:q,lenSq:It,normalize:ht,equalsApproximately:Ft,equals:xt,identity:Rt,rotationTo:Vt,sqlerp:Bt}}var He=new Map;function rr(e){let t=He.get(e);return t||(t=nr(e),He.set(e,t)),t}function ir(e){function t(i,a,m,x){let S=new e(4);return i!==void 0&&(S[0]=i,a!==void 0&&(S[1]=a,m!==void 0&&(S[2]=m,x!==void 0&&(S[3]=x)))),S}let l=t;function f(i,a,m,x,S){let n=S??new e(4);return n[0]=i,n[1]=a,n[2]=m,n[3]=x,n}function v(i,a){let m=a??new e(4);return m[0]=Math.ceil(i[0]),m[1]=Math.ceil(i[1]),m[2]=Math.ceil(i[2]),m[3]=Math.ceil(i[3]),m}function g(i,a){let m=a??new e(4);return m[0]=Math.floor(i[0]),m[1]=Math.floor(i[1]),m[2]=Math.floor(i[2]),m[3]=Math.floor(i[3]),m}function T(i,a){let m=a??new e(4);return m[0]=Math.round(i[0]),m[1]=Math.round(i[1]),m[2]=Math.round(i[2]),m[3]=Math.round(i[3]),m}function G(i,a=0,m=1,x){let S=x??new e(4);return S[0]=Math.min(m,Math.max(a,i[0])),S[1]=Math.min(m,Math.max(a,i[1])),S[2]=Math.min(m,Math.max(a,i[2])),S[3]=Math.min(m,Math.max(a,i[3])),S}function D(i,a,m){let x=m??new e(4);return x[0]=i[0]+a[0],x[1]=i[1]+a[1],x[2]=i[2]+a[2],x[3]=i[3]+a[3],x}function U(i,a,m,x){let S=x??new e(4);return S[0]=i[0]+a[0]*m,S[1]=i[1]+a[1]*m,S[2]=i[2]+a[2]*m,S[3]=i[3]+a[3]*m,S}function z(i,a,m){let x=m??new e(4);return x[0]=i[0]-a[0],x[1]=i[1]-a[1],x[2]=i[2]-a[2],x[3]=i[3]-a[3],x}let E=z;function C(i,a){return Math.abs(i[0]-a[0])<O&&Math.abs(i[1]-a[1])<O&&Math.abs(i[2]-a[2])<O&&Math.abs(i[3]-a[3])<O}function V(i,a){return i[0]===a[0]&&i[1]===a[1]&&i[2]===a[2]&&i[3]===a[3]}function Y(i,a,m,x){let S=x??new e(4);return S[0]=i[0]+m*(a[0]-i[0]),S[1]=i[1]+m*(a[1]-i[1]),S[2]=i[2]+m*(a[2]-i[2]),S[3]=i[3]+m*(a[3]-i[3]),S}function L(i,a,m,x){let S=x??new e(4);return S[0]=i[0]+m[0]*(a[0]-i[0]),S[1]=i[1]+m[1]*(a[1]-i[1]),S[2]=i[2]+m[2]*(a[2]-i[2]),S[3]=i[3]+m[3]*(a[3]-i[3]),S}function tt(i,a,m){let x=m??new e(4);return x[0]=Math.max(i[0],a[0]),x[1]=Math.max(i[1],a[1]),x[2]=Math.max(i[2],a[2]),x[3]=Math.max(i[3],a[3]),x}function K(i,a,m){let x=m??new e(4);return x[0]=Math.min(i[0],a[0]),x[1]=Math.min(i[1],a[1]),x[2]=Math.min(i[2],a[2]),x[3]=Math.min(i[3],a[3]),x}function et(i,a,m){let x=m??new e(4);return x[0]=i[0]*a,x[1]=i[1]*a,x[2]=i[2]*a,x[3]=i[3]*a,x}let X=et;function Z(i,a,m){let x=m??new e(4);return x[0]=i[0]/a,x[1]=i[1]/a,x[2]=i[2]/a,x[3]=i[3]/a,x}function st(i,a){let m=a??new e(4);return m[0]=1/i[0],m[1]=1/i[1],m[2]=1/i[2],m[3]=1/i[3],m}let pt=st;function mt(i,a){return i[0]*a[0]+i[1]*a[1]+i[2]*a[2]+i[3]*a[3]}function gt(i){let a=i[0],m=i[1],x=i[2],S=i[3];return Math.sqrt(a*a+m*m+x*x+S*S)}let Pt=gt;function it(i){let a=i[0],m=i[1],x=i[2],S=i[3];return a*a+m*m+x*x+S*S}let zt=it;function $(i,a){let m=i[0]-a[0],x=i[1]-a[1],S=i[2]-a[2],n=i[3]-a[3];return Math.sqrt(m*m+x*x+S*S+n*n)}let j=$;function q(i,a){let m=i[0]-a[0],x=i[1]-a[1],S=i[2]-a[2],n=i[3]-a[3];return m*m+x*x+S*S+n*n}let It=q;function ht(i,a){let m=a??new e(4),x=i[0],S=i[1],n=i[2],c=i[3],r=Math.sqrt(x*x+S*S+n*n+c*c);return r>1e-5?(m[0]=x/r,m[1]=S/r,m[2]=n/r,m[3]=c/r):(m[0]=0,m[1]=0,m[2]=0,m[3]=0),m}function Ft(i,a){let m=a??new e(4);return m[0]=-i[0],m[1]=-i[1],m[2]=-i[2],m[3]=-i[3],m}function xt(i,a){let m=a??new e(4);return m[0]=i[0],m[1]=i[1],m[2]=i[2],m[3]=i[3],m}let Rt=xt;function k(i,a,m){let x=m??new e(4);return x[0]=i[0]*a[0],x[1]=i[1]*a[1],x[2]=i[2]*a[2],x[3]=i[3]*a[3],x}let At=k;function Tt(i,a,m){let x=m??new e(4);return x[0]=i[0]/a[0],x[1]=i[1]/a[1],x[2]=i[2]/a[2],x[3]=i[3]/a[3],x}let Vt=Tt;function Mt(i){let a=i??new e(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a}function Et(i,a,m){let x=m??new e(4),S=i[0],n=i[1],c=i[2],r=i[3];return x[0]=a[0]*S+a[4]*n+a[8]*c+a[12]*r,x[1]=a[1]*S+a[5]*n+a[9]*c+a[13]*r,x[2]=a[2]*S+a[6]*n+a[10]*c+a[14]*r,x[3]=a[3]*S+a[7]*n+a[11]*c+a[15]*r,x}function Bt(i,a,m){let x=m??new e(4);return ht(i,x),et(x,a,x)}function s(i,a,m){let x=m??new e(4);return gt(i)>a?Bt(i,a,x):xt(i,x)}function h(i,a,m){let x=m??new e(4);return Y(i,a,.5,x)}return{create:t,fromValues:l,set:f,ceil:v,floor:g,round:T,clamp:G,add:D,addScaled:U,subtract:z,sub:E,equalsApproximately:C,equals:V,lerp:Y,lerpV:L,max:tt,min:K,mulScalar:et,scale:X,divScalar:Z,inverse:st,invert:pt,dot:mt,length:gt,len:Pt,lengthSq:it,lenSq:zt,distance:$,dist:j,distanceSq:q,distSq:It,normalize:ht,negate:Ft,copy:xt,clone:Rt,multiply:k,mul:At,divide:Tt,div:Vt,zero:Mt,transformMat4:Et,setLength:Bt,truncate:s,midpoint:h}}var je=new Map;function or(e){let t=je.get(e);return t||(t=ir(e),je.set(e,t)),t}function he(e,t,l,f,v,g){return{mat3:Jn(e),mat4:er(t),quat:rr(l),vec2:ke(f),vec3:se(v),vec4:or(g)}}var{mat3:Yt,mat4:H,quat:hi,vec2:Lt,vec3:Nt,vec4:Ze}=he(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:xi,mat4:vi,quat:wi,vec2:yi,vec3:bi,vec4:Ti}=he(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:Mi,mat4:Si,quat:Pi,vec2:Bi,vec3:Di,vec4:_i}=he(kn,Array,Array,Array,Array,Array);var ae=class{device;format="r8unorm";downsizeFactor;multisample;textureSimple;textureMultisampled=null;renderPipeline;bindgroup;uniformsBuffer;trianglesBuffer;constructor(t){this.device=t.device,this.downsizeFactor=t.blurFactor,this.multisample=this.downsizeFactor>1?4:1,[this.textureSimple,this.textureMultisampled]=this.createTextures(t.width,t.height),this.trianglesBuffer=t.trianglesBuffer;let l=this.device.createShaderModule({label:"DisplacementTexture shader module",code:qe});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementTexture renderpipeline",layout:"auto",vertex:{module:l,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x2"}],arrayStride:2*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"}]},fragment:{module:l,entryPoint:"main_fragment",targets:[{format:this.format}]},primitive:{cullMode:"none",topology:"triangle-list"},multisample:{count:this.multisample}}),this.uniformsBuffer=this.device.createBuffer({label:"DisplacementTexture uniforms buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bindgroup=this.device.createBindGroup({label:"DisplacementTexture bindgroup",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformsBuffer}}]})}update(t){let l=this.textureMultisampled??this.textureSimple,f={view:l.view,clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"};this.textureMultisampled&&(f.resolveTarget=this.textureSimple.view);let v=t.beginRenderPass({label:"DisplacementTexture render to texture renderpass",colorAttachments:[f]}),[g,T]=[l.texture.width,l.texture.height];v.setViewport(0,0,g,T,0,1),v.setScissorRect(0,0,g,T),v.setPipeline(this.renderPipeline),v.setBindGroup(0,this.bindgroup),v.setVertexBuffer(0,this.trianglesBuffer.bufferGpu),v.draw(3*this.trianglesBuffer.spriteCount),v.end()}resize(t,l){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),[this.textureSimple,this.textureMultisampled]=this.createTextures(t,l)}setViewport(t){let l=[1,1,1],f=0,v=[1,1,0],g=H.identity();H.multiply(H.scaling(l),g,g),H.multiply(H.rotationZ(f),g,g),H.multiply(H.translation(v),g,g);let T=H.translation([-t.position[0],-t.position[1],0]),G=t.width/t.zoom,D=t.height/t.zoom,U=H.ortho(0,G,D,0,-10,10),z=H.identity();H.multiply(T,g,z),H.multiply(U,z,z),this.device.queue.writeBuffer(this.uniformsBuffer,0,z)}getView(){return this.textureSimple.view}destroy(){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),this.uniformsBuffer.destroy()}createTextures(t,l){let f=this.device.createTexture({label:"DisplacementTexture texture",size:[Math.ceil(t/this.downsizeFactor),Math.ceil(l/this.downsizeFactor)],format:this.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),v={texture:f,view:f.createView({label:"DisplacementTexture texture view"})},g=null;if(this.multisample>1){let T=this.device.createTexture({label:"DisplacementTexture texture multisampled",size:[f.width,f.height],format:f.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.multisample});g={texture:T,view:T.createView({label:"DisplacementTexture texture multisampled view"})}}return[v,g]}};var Ke={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(e,t={}){return sr(e,t)},onRun:function(e,t,l){ar(e,t,l)},onDestroy:function(e,t){cr(t)},onResize:function(e,t){t.data.displacementTexture.resize(e.viewport.width,e.viewport.height),t.data.displacementComposition.setColorTextureView(t.refs.color.data.view),t.data.displacementComposition.setNoiseMapTextureView(t.refs.map.view),t.data.displacementComposition.setDisplacementTextureView(t.data.displacementTexture.getView())},onViewportPosition:function(e,t){t.data.displacementTexture.setViewport(e.viewport)},customFunctions:{addTriangle:function(e,t,l){return t.data.trianglesBuffer.addTriangle(l)},removeTriangle:function(e,t,l){t.data.trianglesBuffer.removeTriangle(l)},setPosition:function(e,t,l,f){t.data.trianglesBuffer.setTriangle(l,f)}}};async function sr(e,t){let{device:l}=e,f=new ie({device:l,initialParameters:{offsetX:t.options.offseyX??0,offsetY:t.options.offseyY??0,scale:t.options.scale??20}}),v=256,g=new re({device:l,maxSpriteCount:v}),T=new ae({device:l,width:e.viewport.width,height:e.viewport.height,blurFactor:8,trianglesBuffer:g}),G=new oe({device:l,targetFormat:"bgra8unorm",colorTextureView:t.refs.color.data.view,noiseMapTextureView:t.refs.map.view,displacementTextureView:T.getView(),displacementParametersBuffer:f});return{displacementParameters:f,displacementTexture:T,displacementComposition:G,trianglesBuffer:g}}function ar(e,t,l){if(t.data.trianglesBuffer.spriteCount===0)return;t.data.trianglesBuffer.update(),t.data.displacementTexture.update(l);let v=l.beginRenderPass({colorAttachments:[{view:t.refs.out,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});v.executeBundles([t.data.displacementComposition.getRenderBundle()]),v.end()}function cr(e){e.data.trianglesBuffer.destroy(),e.data.trianglesBuffer=null,e.data.displacementParameters.destroy(),e.data.displacementParameters=null,e.data.displacementTexture.destroy(),e.data.displacementTexture=null,e.data.displacementComposition.destroy(),e.data.displacementComposition=null}function xe(e,t){let l=t.vertices,f=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,v={size:l.byteLength,usage:f,mappedAtCreation:!0},g=e.createBuffer(v);return new Float32Array(g.getMappedRange()).set(l),g.unmap(),{buffer:g,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var ve="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var ki=Ze.create(),Je=Nt.create(),en={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return lr(e,t)},onRun:function(e,t,l){fr(e,t,l)},onDestroy:function(e,t){pr(t)},onResize:function(e,t){tn(e,t)},onViewportPosition:function(e,t){tn(e,t)},customFunctions:{...jt}};async function lr(e,t){let{device:l}=e,f=16192,v=f,T=Float32Array.BYTES_PER_ELEMENT*2,D=Float32Array.BYTES_PER_ELEMENT*2,z=Float32Array.BYTES_PER_ELEMENT*4,C=Float32Array.BYTES_PER_ELEMENT*4,V=l.createBuffer({size:(T+D+z+C)*v,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Y=l.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),L=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),tt=l.createBindGroup({layout:L,entries:[{binding:0,resource:{buffer:Y}},{binding:1,resource:t.refs.spritesheet.data.colorTexture.view},{binding:2,resource:t.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:V}}]}),K=l.createPipelineLayout({bindGroupLayouts:[L]}),et=l.createRenderPipeline({label:"overlay",vertex:{module:l.createShaderModule({code:ve}),entryPoint:"vs_main",buffers:[t.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:l.createShaderModule({code:ve}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:K});return{instancedDrawCalls:new Uint32Array(f*2),instancedDrawCallCount:0,spriteBuffer:V,uniformBuffer:Y,pipeline:et,bindGroupLayout:L,bindGroup:tt,spriteData:new Float32Array(f*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function fr(e,t,l){let{device:f}=e,v=t.options.loadOp||"load";if(t.data.dirty&&(dr(t.data),t.data.dirty=!1),t.data.spriteCount>0){let D=t.data.spriteCount*12*Float32Array.BYTES_PER_ELEMENT;f.queue.writeBuffer(t.data.spriteBuffer,0,t.data.spriteData.buffer,0,D)}let g=l.beginRenderPass({colorAttachments:[{view:t.refs.color,clearValue:e.clearValue,loadOp:v,storeOp:"store"}]});g.setPipeline(t.data.pipeline),g.setBindGroup(0,t.data.bindGroup),g.setVertexBuffer(0,t.refs.spritesheet.data.quads.buffer);let T=6,G=0;for(let D=0;D<t.data.instancedDrawCallCount;D++){let U=t.data.instancedDrawCalls[D*2]*T,z=t.data.instancedDrawCalls[D*2+1];g.draw(T,z,U,G),G+=z}g.end()}function dr(e){let t=-1,l=0;e.instancedDrawCallCount=0;for(let f=0;f<e.spriteCount;f++){let v=e.spriteData[f*12+11]&65535;v!==t&&(l>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=l,e.instancedDrawCallCount++),t=v,l=0),l++}l>0&&(e.instancedDrawCalls[e.instancedDrawCallCount*2]=t,e.instancedDrawCalls[e.instancedDrawCallCount*2+1]=l,e.instancedDrawCallCount++)}function tn(e,t){let f=Math.round(e.viewport.width/1),v=Math.round(e.viewport.height/1),g=H.ortho(0,f,v,0,-10,10);Nt.set(0,0,0,Je);let T=H.translation(Je);e.device.queue.writeBuffer(t.data.uniformBuffer,0,T.buffer),e.device.queue.writeBuffer(t.data.uniformBuffer,64,g.buffer)}function pr(e){e.data.instancedDrawCalls=null,e.data.bindGroup=null,e.data.spriteBuffer.destroy(),e.data.spriteBuffer=null,e.data.uniformBuffer.destroy(),e.data.uniformBuffer=null,e.data.spriteData=null,e.data.spriteIndices.clear(),e.data.spriteIndices=null}var ye="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var nn={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(e,t={}){return gr(e,t)},onRun:function(e,t,l){hr(e,t,l)},onDestroy:function(e,t){},onResize:function(e,t){xr(e,t)},onViewportPosition:function(e,t){}};async function gr(e,t){let{device:l}=e,f=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),v=l.createBindGroup({layout:f,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]}),g=l.createPipelineLayout({bindGroupLayouts:[f]}),T=l.createRenderPipeline({label:"fb-blit",vertex:{module:l.createShaderModule({code:ye}),entryPoint:"vs_main",buffers:[]},fragment:{module:l.createShaderModule({code:ye}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:g});return{bindGroupLayout:f,bindGroup:v,pipeline:T}}function hr(e,t,l){let{device:f}=e,v=l.beginRenderPass({colorAttachments:[{view:t.refs.out,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});v.setPipeline(t.data.pipeline),v.setBindGroup(0,t.data.bindGroup),v.draw(3),v.end()}function xr(e,t){let{device:l}=e;t.data.bindGroup=l.createBindGroup({layout:t.data.bindGroupLayout,entries:[{binding:0,resource:t.refs.in.data.view},{binding:1,resource:t.refs.in.data.sampler}]})}var rn="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";var on={line:Xt,save:function(e,t){t.data.transforms.push(Yt.clone(t.data.transforms.at(-1)))},restore:function(e,t){t.data.transforms.length>1&&t.data.transforms.pop()},translate:function(e,t,l){let f=t.data.transforms.at(-1);Yt.translate(f,l,f)},rotate:function(e,t,l){let f=t.data.transforms.at(-1);Yt.rotate(f,l,f)},scale:function(e,t,l){let f=t.data.transforms.at(-1);Yt.scale(f,l,f)},strokePath:function(e,t,l,f,v=1){for(let g of l)Xt(e,t,g[0],g[1],f,v)},filledPath:function(e,t,l,f){},ellipse:function(e,t,l,f,v,g,T,G=1){let[D,U]=l,z=2*Math.PI/g;for(let E=0;E<g;E++){let C=E*z,V=(E+1)*z,Y=D+f*Math.cos(C),L=U+v*Math.sin(C),tt=D+f*Math.cos(V),K=U+v*Math.sin(V);Xt(e,t,[Y,L],[tt,K],T,G)}},filledEllipse:function(e,t,l,f,v,g,T){let[G,D]=l,U=2*Math.PI/g,z=t.data.transforms.at(-1);for(let E=0;E<g;E++){let C=E*U,V=(E+1)*U,Y=G+f*Math.cos(C),L=D+v*Math.sin(C),tt=G+f*Math.cos(V),K=D+v*Math.sin(V),X=t.data.vertexCount*6+E*18,Z=Lt.transformMat3([G,D],z);t.data.vertices[X+0]=Z[0],t.data.vertices[X+1]=Z[1],t.data.vertices[X+2]=T[0],t.data.vertices[X+3]=T[1],t.data.vertices[X+4]=T[2],t.data.vertices[X+5]=T[3],Lt.transformMat3([Y,L],z,Z),t.data.vertices[X+6]=Z[0],t.data.vertices[X+7]=Z[1],t.data.vertices[X+8]=T[0],t.data.vertices[X+9]=T[1],t.data.vertices[X+10]=T[2],t.data.vertices[X+11]=T[3],Lt.transformMat3([tt,K],z,Z),t.data.vertices[X+12]=Z[0],t.data.vertices[X+13]=Z[1],t.data.vertices[X+14]=T[0],t.data.vertices[X+15]=T[1],t.data.vertices[X+16]=T[2],t.data.vertices[X+17]=T[3]}t.data.vertexCount+=3*g,t.data.dirty=!0},box:function(e,t,l,f,v,g,T=1){let[G,D]=l,U=f/2,z=v/2,E=[G-U,D-z],C=[G+U,D-z],V=[G-U,D+z],Y=[G+U,D+z];Xt(e,t,E,C,g,T),Xt(e,t,V,Y,g,T),Xt(e,t,E,V,g,T),Xt(e,t,C,Y,g,T)},filledBox:function(e,t,l,f,v,g){let[T,G]=l,D=f/2,U=v/2,z=t.data.transforms.at(-1),E=Lt.transformMat3([T-D,G-U],z),C=Lt.transformMat3([T+D,G-U],z),V=Lt.transformMat3([T-D,G+U],z),Y=Lt.transformMat3([T+D,G+U],z),L=t.data.vertexCount*6;t.data.vertices[L+0]=E[0],t.data.vertices[L+1]=E[1],t.data.vertices[L+2]=g[0],t.data.vertices[L+3]=g[1],t.data.vertices[L+4]=g[2],t.data.vertices[L+5]=g[3],t.data.vertices[L+6]=V[0],t.data.vertices[L+7]=V[1],t.data.vertices[L+8]=g[0],t.data.vertices[L+9]=g[1],t.data.vertices[L+10]=g[2],t.data.vertices[L+11]=g[3],t.data.vertices[L+12]=C[0],t.data.vertices[L+13]=C[1],t.data.vertices[L+14]=g[0],t.data.vertices[L+15]=g[1],t.data.vertices[L+16]=g[2],t.data.vertices[L+17]=g[3],t.data.vertices[L+18]=V[0],t.data.vertices[L+19]=V[1],t.data.vertices[L+20]=g[0],t.data.vertices[L+21]=g[1],t.data.vertices[L+22]=g[2],t.data.vertices[L+23]=g[3],t.data.vertices[L+24]=Y[0],t.data.vertices[L+25]=Y[1],t.data.vertices[L+26]=g[0],t.data.vertices[L+27]=g[1],t.data.vertices[L+28]=g[2],t.data.vertices[L+29]=g[3],t.data.vertices[L+30]=C[0],t.data.vertices[L+31]=C[1],t.data.vertices[L+32]=g[0],t.data.vertices[L+33]=g[1],t.data.vertices[L+34]=g[2],t.data.vertices[L+35]=g[3],t.data.vertexCount+=6,t.data.dirty=!0},clear:function(e,t){t.data.vertexCount=0,t.data.transforms.length=1,Yt.identity(t.data.transforms[0]),t.data.dirty=!0}};function Xt(e,t,l,f,v,g=1){let T=t.data.transforms.at(-1);l=Lt.transformMat3(l,T),f=Lt.transformMat3(f,T);let G=Lt.sub(f,l),D=Lt.normalize(G),U=wr(D),z=g/2,E=t.data.vertexCount*6;t.data.vertices[E+0]=l[0]+U[0]*z,t.data.vertices[E+1]=l[1]+U[1]*z,t.data.vertices[E+2]=v[0],t.data.vertices[E+3]=v[1],t.data.vertices[E+4]=v[2],t.data.vertices[E+5]=v[3],t.data.vertices[E+6]=l[0]-U[0]*z,t.data.vertices[E+7]=l[1]-U[1]*z,t.data.vertices[E+8]=v[0],t.data.vertices[E+9]=v[1],t.data.vertices[E+10]=v[2],t.data.vertices[E+11]=v[3],t.data.vertices[E+12]=f[0]+U[0]*z,t.data.vertices[E+13]=f[1]+U[1]*z,t.data.vertices[E+14]=v[0],t.data.vertices[E+15]=v[1],t.data.vertices[E+16]=v[2],t.data.vertices[E+17]=v[3],t.data.vertices[E+18]=l[0]-U[0]*z,t.data.vertices[E+19]=l[1]-U[1]*z,t.data.vertices[E+20]=v[0],t.data.vertices[E+21]=v[1],t.data.vertices[E+22]=v[2],t.data.vertices[E+23]=v[3],t.data.vertices[E+24]=f[0]+U[0]*z,t.data.vertices[E+25]=f[1]+U[1]*z,t.data.vertices[E+26]=v[0],t.data.vertices[E+27]=v[1],t.data.vertices[E+28]=v[2],t.data.vertices[E+29]=v[3],t.data.vertices[E+30]=f[0]-U[0]*z,t.data.vertices[E+31]=f[1]-U[1]*z,t.data.vertices[E+32]=v[0],t.data.vertices[E+33]=v[1],t.data.vertices[E+34]=v[2],t.data.vertices[E+35]=v[3],t.data.vertexCount+=6,t.data.dirty=!0}function wr(e){return[-e[1],e[0]]}var sn=Nt.create(0,0,0),cn={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(e,t={}){return yr(e,t)},onRun:function(e,t,l){br(e,t,l)},onDestroy:function(e,t){Tr(t)},onResize:function(e,t){an(e,t)},onViewportPosition:function(e,t){an(e,t)},customFunctions:on};async function yr(e,t){let{device:l}=e,f=new Float32Array(3e5),v=l.createBuffer({size:f.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),g=l.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),T=l.createShaderModule({code:rn}),G=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),D=l.createPipelineLayout({bindGroupLayouts:[G]}),U=l.createBindGroup({layout:G,entries:[{binding:0,resource:{buffer:g}}]}),z=l.createRenderPipeline({layout:D,vertex:{module:T,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:T,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:g,vertexBuffer:v,pipeline:z,bindGroup:U,vertexCount:0,dirty:!1,vertices:f,transforms:[Yt.identity()]}}function br(e,t,l){if(t.data.vertexCount===0)return;let{device:f}=e;if(t.data.dirty){t.data.dirty=!1;let T=6*Float32Array.BYTES_PER_ELEMENT,G=t.data.vertexCount*T;if(G>t.data.vertexBuffer.size){console.warn("too many primitives, bailing");return}e.device.queue.writeBuffer(t.data.vertexBuffer,0,t.data.vertices.buffer,0,G)}let v=t.options.loadOp||"load",g=l.beginRenderPass({colorAttachments:[{view:t.refs.color,clearValue:e.clearValue,loadOp:v,storeOp:"store"}]});g.setPipeline(t.data.pipeline),g.setBindGroup(0,t.data.bindGroup),g.setVertexBuffer(0,t.data.vertexBuffer),g.draw(t.data.vertexCount),g.end()}function Tr(e){e.data.vertexBuffer.destroy(),e.data.vertexBuffer=null,e.data.uniformBuffer.destroy(),e.data.uniformBuffer=null,e.data.transforms.length=0}function an(e,t){let{device:l}=e,f=e.viewport.width/e.viewport.zoom,v=e.viewport.height/e.viewport.zoom,g=H.ortho(0,f,v,0,-10,10);Nt.set(-e.viewport.position[0],-e.viewport.position[1],0,sn);let T=H.translation(sn);l.queue.writeBuffer(t.data.uniformBuffer,0,T.buffer),l.queue.writeBuffer(t.data.uniformBuffer,64,g.buffer)}var be={};_e(be,{setAmbientLight:()=>Sr,setLights:()=>Mr,setOccluders:()=>Pr});function Mr(e,t,l){t.data.lights=l,t.data.lightsBufferNeedsUpdate=!0}function Sr(e,t,l){t.data.lightsRenderer.setAmbientLight(l)}function Pr(e,t,l){t.data.lightsRenderer.setObstacles(l),t.data.lightsTextureNeedsUpdate=!0}var ce=class{invViewProjectionMatrix=H.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(t){this.setViewportSize(t.viewportSize.width,t.viewportSize.height);let l=t.center??this.topLeft;this.setTopLeft(...l);let f=t.zoom??1;this.setZoom(f)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(t,l){this.viewportSize.width=t,this.viewportSize.height=l,this.updateMatrices()}setTopLeft(t,l){this.topLeft[0]=t,this.topLeft[1]=l,this.updateMatrices()}setZoom(t){this.zoom=t,this.updateMatrices()}updateMatrices(){H.identity(this.invViewProjectionMatrix),H.multiply(H.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),H.multiply(H.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),H.multiply(H.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),H.multiply(H.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var Ut=class e{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(t,l){this.device=t,this.maxLightsCount=l;let f=new ArrayBuffer(e.computeBufferBytesLength(l)),v=t.createBuffer({label:"LightsBuffer buffer",size:f.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:f,bufferGpu:v},this.setLights([])}setLights(t){if(t.length>this.maxLightsCount)throw new Error(`Too many lights "${t.length}", max is "${this.maxLightsCount}".`);let l=e.computeBufferBytesLength(t.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([t.length]),t.forEach((f,v)=>{new Float32Array(this.buffer.bufferCpu,e.structs.lightsBuffer.lights.offset+e.structs.lightsBuffer.lights.stride*v,9).set([...f.color,f.radius,...f.position,f.intensity,f.attenuationLinear,f.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,l),this.currentLightsCount=t.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(t){return e.structs.lightsBuffer.lights.offset+e.structs.lightsBuffer.lights.stride*t}};var ue=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(t,l,f,v){this.lightsBuffer=l;let g=t.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${Ut.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${f.gridSize.x}, ${f.gridSize.y});
const cellsGridSizeF = vec2<f32>(${f.gridSize.x}, ${f.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${v}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=t.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:g,entryPoint:"main_vertex"},fragment:{module:g,entryPoint:"main_fragment",targets:[{format:f.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:f.sampleCount}}),this.bindgroup=t.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let T=t.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[f.format],sampleCount:f.sampleCount});T.setPipeline(this.renderPipeline),T.setBindGroup(0,this.bindgroup),T.draw(4),this.renderBundle=T.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var le=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(t,l,f,v){this.device=t,this.lightsBuffer=l;let g=!0,T=t.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${f.gridSize.x}, ${f.gridSize.y});
const cellsGridSizeF = vec2<f32>(${f.gridSize.x}, ${f.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${v});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=t.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:T,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:Ut.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:Ut.structs.light.position.offset,format:"float32x2"}],arrayStride:Ut.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:T,entryPoint:"main_fragment",targets:[{format:f.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:g?"none":"back",topology:"triangle-list"},multisample:{count:f.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:t.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[f.format],sampleCount:f.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(t){let l=[],f=[];for(let U of t){let z=l.length/3;l.push(...U[0],0,...U[1],0,...U[0],1,...U[1],1),f.push(z+0,z+1,z+3,z+0,z+3,z+2)}let v=!1,g=new Float32Array(l),T=this.obstacles?.positionsBufferGpu;(!T||T.size<g.byteLength)&&(T?.destroy(),T=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:g.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),v=!0),this.device.queue.writeBuffer(T,0,g);let G=new Uint16Array(f),D=this.obstacles?.indexBufferGpu;(!D||D.size<G.byteLength)&&(D?.destroy(),D=this.device.createBuffer({label:"LightsTextureMask index buffer",size:G.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),v=!0),this.device.queue.writeBuffer(D,0,G),this.obstacles={positionsBufferGpu:T,indexBufferGpu:D},this.setIndirectIndexCount(f.length),v&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(t){this.setIndirectInstanceCount(t)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(t){let l=new Uint32Array(this.indirectDrawing.bufferCpu);l[0]!==t&&(l[0]=t,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(t){let l=new Uint32Array(this.indirectDrawing.bufferCpu);l[1]!==t&&(l[1]=t,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let t=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(t.setPipeline(this.renderPipeline),t.setVertexBuffer(0,this.obstacles.positionsBufferGpu),t.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,Ut.structs.lightsBuffer.lights.offset),t.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),t.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),t.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var fe=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(t,l,f){this.lightsBuffer=l;let v=this.lightsBuffer.maxLightsCount/4,g={x:Math.ceil(Math.sqrt(v)),y:0};g.y=Math.ceil(v/g.x),this.gridSize=g;let T={width:g.x*f.resolutionPerLight,height:g.y*f.resolutionPerLight},G="rgba8unorm";this.texture=t.createTexture({label:"LightsTextureMask texture",size:[T.width,T.height],format:G,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),f.antialiased&&(this.textureMultisampled=t.createTexture({label:"LightsTextureMask texture multisampled",size:[T.width,T.height],format:G,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let U={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};f.antialiased&&(U.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[U]};let z={gridSize:g,format:G,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new ue(t,l,z,f.maxLightSize),this.textureMask=new le(t,l,z,f.maxLightSize)}update(t){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let l=t.beginRenderPass(this.textureRenderpassDescriptor),[f,v]=[this.texture.width,this.texture.height];l.setViewport(0,0,f,v,0,1),l.setScissorRect(0,0,f,v),l.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),l.end()}setObstacles(t){this.textureMask.setObstacles(t)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var de=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(t){this.device=t.device,this.targetTexture=t.targetTexture,this.lightsBuffer=t.lightsBuffer,this.lightsTexture=new fe(t.device,t.lightsBuffer,t.lightsTextureProperties),this.uniformsBufferGpu=t.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let l=t.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${Ut.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/t.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${t.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=t.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:l,entryPoint:"main_vertex"},fragment:{module:l,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let f=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=t.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:f,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:t.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:t.lightsTextureProperties.filtering,minFilter:t.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(t.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(t){this.lightsTexture.update(t)}render(t,l){let f=new ArrayBuffer(80);new Float32Array(f,0,16).set(l),new Float32Array(f,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,f),t.executeBundles([this.renderBundle])}setAlbedo(t){this.bindgroup1=this.buildBindgroup1(t),this.renderBundle=this.buildRenderBundle()}setAmbientLight(t){this.ambientLight=[...t]}setObstacles(t){this.lightsTexture.setObstacles(t)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(t){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:t.view},{binding:1,resource:t.sampler}]})}buildRenderBundle(){let t=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return t.setPipeline(this.renderPipeline),t.setBindGroup(0,this.bindgroup0),t.setBindGroup(1,this.bindgroup1),t.draw(4),t.finish({label:"LightsRenderer renderbundle"})}};var un={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(e,t={}){return Br(e,t)},onRun:function(e,t,l){Dr(e,t,l)},onDestroy:function(e,t){_r(t)},onResize:function(e,t){Gr(e,t)},onViewportPosition:function(e,t){t.data.viewport.setTopLeft(...e.viewport.position)},customFunctions:{...be}};async function Br(e,t){let{device:l}=e,f=256,v=256,g=new Ut(l,f),T=new ce({viewportSize:{width:e.viewport.width,height:e.viewport.height},center:e.viewport.position,zoom:e.viewport.zoom}),G=new de({device:l,albedo:{view:t.refs.in.data.view,sampler:t.refs.in.data.sampler},targetTexture:t.refs.out.data.texture,lightsBuffer:g,lightsTextureProperties:{resolutionPerLight:v,maxLightSize:v,antialiased:!1,filtering:"nearest"}});return{lightsBuffer:g,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:G,viewport:T,lights:[]}}function Dr(e,t,l){t.data.lightsBufferNeedsUpdate&&(t.data.lightsBuffer.setLights(t.data.lights),t.data.lightsBufferNeedsUpdate=!1,t.data.lightsTextureNeedsUpdate=!0);let f=t.data.lightsRenderer;t.data.lightsTextureNeedsUpdate&&(f.computeLightsTexture(l),t.data.lightsTextureNeedsUpdate=!1);let v=l.beginRenderPass({colorAttachments:[{view:t.refs.out.data.view,clearValue:e.clearValue,loadOp:"load",storeOp:"store"}]});t.data.viewport.setZoom(e.viewport.zoom);let g=t.data.viewport.invertViewProjectionMatrix;f.render(v,g),v.end()}function _r(e){e.data.lightsBuffer.destroy(),e.data.lightsRenderer.destroy()}function Gr(e,t){t.data.lightsRenderer.setAlbedo({view:t.refs.in.data.view,sampler:t.refs.in.data.sampler}),t.data.viewport.setViewportSize(e.viewport.width,e.viewport.height)}var Te="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var qt=new Float32Array(8),fn={type:"cobalt:tileAtlas",refs:[],onInit:async function(e,t={}){return zr(e,t)},onRun:function(e,t,l){},onDestroy:function(e,t){Er(data)},onResize:function(e,t){ln(e,t)},onViewportPosition:function(e,t){ln(e,t)}};async function zr(e,t){let{device:l}=e,f=await Ct(e,"tile atlas",t.options.textureUrl),v=l.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),g=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),T=l.createBindGroup({layout:g,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:f.view},{binding:2,resource:f.sampler}]}),G=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),D=l.createPipelineLayout({bindGroupLayouts:[G,g]});return{pipeline:l.createRenderPipeline({label:"tile",vertex:{module:l.createShaderModule({code:Te}),entryPoint:"vs_main",buffers:[]},fragment:{module:l.createShaderModule({code:Te}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:D}),uniformBuffer:v,atlasBindGroup:T,atlasMaterial:f,tileBindGroupLayout:G,tileSize:t.options.tileSize,tileScale:t.options.tileScale}}function Er(e){e.atlasMaterial.texture.destroy(),e.atlasMaterial.texture=void 0}function ln(e,t){qt[0]=e.viewport.position[0],qt[1]=e.viewport.position[1];let l=t.data,{tileScale:f,tileSize:v}=l,g=e.viewport.width/e.viewport.zoom,T=e.viewport.height/e.viewport.zoom;qt[2]=g/f,qt[3]=T/f,qt[4]=1/l.atlasMaterial.texture.width,qt[5]=1/l.atlasMaterial.texture.height,qt[6]=v,qt[7]=1/v,e.device.queue.writeBuffer(l.uniformBuffer,0,qt,0,8)}function pe(e){let l=Object.keys(e.frames).length,f=new Float32Array(l*30),v=[],g={},T=0;for(let G in e.frames){let D=e.frames[G];v.push(G),g[G]=D.sourceSize;let U=-.5+D.spriteSourceSize.x/D.sourceSize.w,z=-.5+D.spriteSourceSize.y/D.sourceSize.h,E=-.5+(D.spriteSourceSize.x+D.spriteSourceSize.w)/D.sourceSize.w,C=-.5+(D.spriteSourceSize.y+D.spriteSourceSize.h)/D.sourceSize.h,V=[U,z,0],Y=[U,C,0],L=[E,C,0],tt=[E,z,0],K=0+D.frame.x/e.meta.size.w,et=0+D.frame.y/e.meta.size.h,X=0+(D.frame.x+D.frame.w)/e.meta.size.w,Z=0+(D.frame.y+D.frame.h)/e.meta.size.h,st=[K,et],pt=[K,Z],mt=[X,Z],gt=[X,et];f.set(V,T),f.set(st,T+3),f.set(Y,T+5),f.set(pt,T+8),f.set(L,T+10),f.set(mt,T+13),f.set(V,T+15),f.set(st,T+18),f.set(L,T+20),f.set(mt,T+23),f.set(tt,T+25),f.set(gt,T+28),T+=30}return{spriteMeta:g,locations:v,vertices:f}}var Me="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var dn=Nt.create(0,0,0),mn={type:"cobalt:spritesheet",refs:[],onInit:async function(e,t={}){return Ir(e,t)},onRun:function(e,t,l){},onDestroy:function(e,t){Fr(t)},onResize:function(e,t){pn(e,t)},onViewportPosition:function(e,t){pn(e,t)}};async function Ir(e,t){let{canvas:l,device:f}=e,v,g,T;l?(v=await Rr(t.options.spriteSheetJsonUrl),v=pe(v),g=await Ct(e,"sprite",t.options.colorTextureUrl,"rgba8unorm"),T=await Ct(e,"emissive sprite",t.options.emissiveTextureUrl,"rgba8unorm"),l.style.imageRendering="pixelated"):(v=pe(t.options.spriteSheetJson),g=await Wt(e,"sprite",t.options.colorTexture,"rgba8unorm"),T=await Wt(e,"emissive sprite",t.options.emissiveTexture,"rgba8unorm"));let G=xe(f,v),D=f.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),U=f.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),z=f.createPipelineLayout({bindGroupLayouts:[U]});return{pipeline:f.createRenderPipeline({label:"sprite",vertex:{module:f.createShaderModule({code:Me}),entryPoint:"vs_main",buffers:[G.bufferLayout]},fragment:{module:f.createShaderModule({code:Me}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:z}),uniformBuffer:D,quads:G,colorTexture:g,emissiveTexture:T,bindGroupLayout:U,spritesheet:v}}function Fr(e){e.data.quads.buffer.destroy(),e.data.colorTexture.buffer.destroy(),e.data.uniformBuffer.destroy(),e.data.emissiveTexture.texture.destroy()}async function Rr(e){return(await fetch(e)).json()}function pn(e,t){let{device:l,viewport:f}=e,v=f.width/f.zoom,g=f.height/f.zoom,T=H.ortho(0,v,g,0,-10,10);Nt.set(-f.position[0],-f.position[1],0,dn);let G=H.translation(dn);l.queue.writeBuffer(t.data.uniformBuffer,0,G.buffer),l.queue.writeBuffer(t.data.uniformBuffer,64,T.buffer)}var gn={type:"fbTexture",refs:[],onInit:async function(e,t={}){return Ar(e,t)},onRun:function(e,t,l){},onDestroy:function(e,t){hn(data)},onResize:function(e,t){Vr(e,t)},onViewportPosition:function(e,t){}};async function Ar(e,t){let{device:l}=e,{label:f,mip_count:v,format:g,usage:T,viewportScale:G}=t.options;return St(l,f,e.viewport.width*G,e.viewport.height*G,v,g,T)}function hn(e){e.data.texture.destroy()}function Vr(e,t){let{device:l}=e;hn(t);let{width:f,height:v}=e.viewport,{options:g}=t,T=t.options.viewportScale;t.data=St(l,g.label,f*T,v*T,g.mip_count,g.format,g.usage)}async function cs(e,t,l){let f,v,g,T;return e.sdlWindow&&e.gpu?(v=e.gpu,f=await(await v.create(["verbose=1"]).requestAdapter()).requestDevice(),g=v.renderGPUDeviceToWindow({device:f,window:e.sdlWindow}),global.GPUBufferUsage=v.GPUBufferUsage,global.GPUShaderStage=v.GPUShaderStage,global.GPUTextureUsage=v.GPUTextureUsage):(T=e,f=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),v=navigator.gpu,g=T.getContext("webgpu"),g.configure({device:f,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":fn,"cobalt:spritesheet":mn,"cobalt:fbTexture":gn,"cobalt:bloom":Ee,"cobalt:composite":Fe,"cobalt:sprite":Ve,"cobalt:tile":Ce,"cobalt:displacement":Ke,"cobalt:overlay":en,"cobalt:fbBlit":nn,"cobalt:primitives":cn,"cobalt:light":un},nodes:[],defaultTextureViewRefs:[],canvas:T,device:f,context:g,gpu:v,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:t,height:l,zoom:1,position:[0,0]}}}function us(e,t){if(!t?.type)throw new Error("Can't define a new node missing a type.");e.nodeDefs[t.type]=t}async function ls(e,t){let l=e.nodeDefs[t?.type];if(!l)throw new Error("Can't initialize a new node missing a type.");let f={type:t.type,refs:t.refs||{},options:t.options||{},data:{},enabled:!0};for(let g in f.refs)f.refs[g]==="FRAME_TEXTURE_VIEW"&&(e.defaultTextureViewRefs.push({node:f,refName:g}),f.refs[g]=xn(e));f.data=await l.onInit(e,f);let v=l.customFunctions||{};for(let g in v)f[g]=function(...T){return v[g](e,f,...T)};return e.nodes.push(f),f}function fs(e){let{device:t,context:l}=e,f=t.createCommandEncoder(),v=xn(e);for(let g of e.defaultTextureViewRefs)g.node.refs[g.refName]=v;for(let g of e.nodes){if(!g.enabled)continue;e.nodeDefs[g.type].onRun(e,g,f)}t.queue.submit([f.finish()]),e.canvas||e.context.swap()}function ds(e){for(let t of e.nodes)e.nodeDefs[t.type].onDestroy(e,t);e.nodes.length=0,e.defaultTextureViewRefs.length=0}function ps(e,t,l){e.viewport.width=t,e.viewport.height=l;for(let f of e.nodes)e.nodeDefs[f.type].onResize(e,f)}function ms(e,t){e.viewport.position[0]=t[0]-e.viewport.width/2/e.viewport.zoom,e.viewport.position[1]=t[1]-e.viewport.height/2/e.viewport.zoom;for(let l of e.nodes)e.nodeDefs[l.type].onViewportPosition(e,l)}function Re(e){return e.canvas?navigator.gpu.getPreferredCanvasFormat():e.context.getPreferredFormat()}function xn(e){return e.canvas?e.context.getCurrentTexture().createView():e.context.getCurrentTextureView()}export{St as createTexture,Wt as createTextureFromBuffer,Ct as createTextureFromUrl,us as defineNode,fs as draw,xn as getCurrentTextureView,Re as getPreferredFormat,cs as init,ls as initNode,ds as reset,ps as setViewportDimensions,ms as setViewportPosition};

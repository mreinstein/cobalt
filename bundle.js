var Ee=Object.defineProperty;var Be=(t,e)=>{for(var r in e)Ee(t,r,{get:e[r],enumerable:!0})};function b(t,e,r,i,o,a,n){let f=t.createTexture({label:e,size:{width:r,height:i},format:a,usage:n,mipLevelCount:o,sampleCount:1,dimension:"2d"}),s=f.createView(),c=[];for(let p=0;p<o;p++)c.push(f.createView({label:e,format:a,dimension:"2d",aspect:"all",baseMipLevel:p,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let u=t.createSampler({label:`${e} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:r,height:i},texture:f,view:s,mip_view:c,sampler:u}}async function w(t,e,r,i="rgba8unorm"){let a=await(await fetch(r)).blob(),n=await createImageBitmap(a),f=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,c=b(t.device,e,n.width,n.height,1,i,f);t.device.queue.copyExternalImageToTexture({source:n},{texture:c.texture},{width:n.width,height:n.height});let u={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return c.sampler=t.device.createSampler(u),c}var k="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<=u32(imgSize.x)&&global_invocation_id.y<=u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var S=7,Ue=0,Q=1,Fe=2,K=3,$={type:"bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(t,e={}){return Pe(t,e)},onRun:function(t,e,r){Me(t,e.data,r)},onDestroy:function(t,e){Z(e)},onResize:function(t,e){De(t,e)},onViewportPosition:function(t,e){}};function Pe(t,e){let{device:r}=t,i=t.viewport.width,o=t.viewport.height,a={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},n=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});a.bind_group_layout.push(n),a.bind_groups_textures.push(b(r,"bloom downsampler image 0",i/2,o/2,S,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),a.bind_groups_textures.push(b(r,"bloom downsampler image 1",i/2,o/2,S,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),a.bind_groups_textures.push(e.refs.bloom.data);let f=r.createPipelineLayout({bindGroupLayouts:a.bind_group_layout}),s=r.createComputePipeline({layout:f,compute:{module:r.createShaderModule({code:k}),entryPoint:"cs_main"}});return J(t,a,e),a.compute_pipeline=s,a}function J(t,e,r){let{refs:i}=r,{device:o}=t,a=r.options.bloom_threshold??.1,n=r.options.bloom_knee??.2,f=r.options.bloom_combine_constant??.68,s=new Float32Array([a,a-n,n*2,.25/n,f,0,0,0]),c=o.createBuffer({label:"bloom static parameters buffer",size:s.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(c.getMappedRange()).set(s),c.unmap(),e.bind_group.length=0,e.params_buf=c,e.bind_group.push(E(o,e,e.bind_groups_textures[0].mip_view[0],i.emissive.data.view,i.hdr.data.view,i.hdr.data.sampler,c,Ue<<16|0));for(let p=1;p<S;p++)e.bind_group.push(E(o,e,e.bind_groups_textures[1].mip_view[p],e.bind_groups_textures[0].view,i.hdr.data.view,i.hdr.data.sampler,c,Q<<16|p-1)),e.bind_group.push(E(o,e,e.bind_groups_textures[0].mip_view[p],e.bind_groups_textures[1].view,i.hdr.data.view,i.hdr.data.sampler,c,Q<<16|p));e.bind_group.push(E(o,e,e.bind_groups_textures[2].mip_view[S-1],e.bind_groups_textures[0].view,i.hdr.data.view,i.hdr.data.sampler,c,Fe<<16|S-2));let u=!0;for(let p=S-2;p>=0;p--)u?(e.bind_group.push(E(o,e,e.bind_groups_textures[1].mip_view[p],e.bind_groups_textures[0].view,e.bind_groups_textures[2].view,i.hdr.data.sampler,c,K<<16|p)),u=!1):(e.bind_group.push(E(o,e,e.bind_groups_textures[2].mip_view[p],e.bind_groups_textures[0].view,e.bind_groups_textures[1].view,i.hdr.data.sampler,c,K<<16|p)),u=!0)}function E(t,e,r,i,o,a,n,f){let s=new Uint32Array([f]),c=t.createBuffer({label:"bloom static mode_lod buffer",size:s.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(c.getMappedRange()).set(s),c.unmap(),t.createBindGroup({label:"bloom bind group layout",layout:e.bind_group_layout[0],entries:[{binding:0,resource:r},{binding:1,resource:i},{binding:2,resource:o},{binding:3,resource:a},{binding:4,resource:{buffer:n}},{binding:5,resource:{buffer:c}}]})}function Me(t,e,r){let f=0,s=r.beginComputePass({label:"bloom Compute Pass"});s.setPipeline(e.compute_pipeline),s.setBindGroup(0,e.bind_group[f]),f+=1;let c=R(0,e.bind_groups_textures[0]);s.dispatchWorkgroups(c.width/8+1,c.height/4+1,1);for(let u=1;u<S;u++)c=R(u,e.bind_groups_textures[0]),s.setBindGroup(0,e.bind_group[f]),f+=1,s.dispatchWorkgroups(c.width/8+1,c.height/4+1,1),s.setBindGroup(0,e.bind_group[f]),f+=1,s.dispatchWorkgroups(c.width/8+1,c.height/4+1,1);s.setBindGroup(0,e.bind_group[f]),f+=1,c=R(S-1,e.bind_groups_textures[2]),s.dispatchWorkgroups(c.width/8+1,c.height/4+1,1);for(let u=S-2;u>=0;u--)c=R(u,e.bind_groups_textures[2]),s.setBindGroup(0,e.bind_group[f]),f+=1,s.dispatchWorkgroups(c.width/8+1,c.height/4+1,1);s.end()}function R(t,e){let r=e.size.width,i=e.size.height;for(let o=0;o<t;o++)r/=2,i/=2;return{width:r,height:i,depthOrArrayLayers:1}}function De(t,e){let{device:r}=t,i=e.data;Z(i),i.bind_groups_textures.push(b(r,"bloom downsampler image 0",t.viewport.width/2,t.viewport.height/2,S,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),i.bind_groups_textures.push(b(r,"bloom downsampler image 1",t.viewport.width/2,t.viewport.height/2,S,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),i.bind_groups_textures.push(e.refs.bloom.data),J(t,i,e)}function Z(t){for(let e of t.bind_groups_textures)e.texture.destroy();t.bind_groups_textures.length=0}var I="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{const pos=array(vec2(1.0,1.0),vec2(1.0,-1.0),vec2(-1.0,-1.0),vec2(1.0,1.0),vec2(-1.0,-1.0),vec2(-1.0,1.0),);const uv=array(vec2(1.0,0.0),vec2(1.0,1.0),vec2(0.0,1.0),vec2(1.0,0.0),vec2(0.0,1.0),vec2(0.0,0.0),);var output:VertexOutput;output.Position=vec4(pos[VertexIndex],0.0,1.0);output.fragUV=uv[VertexIndex];return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var ee={type:"bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return ze(t,e)},onRun:function(t,e,r){Ie(t,e,r)},onDestroy:function(t,e){},onResize:function(t,e){Le(t,e)},onViewportPosition:function(t,e){}};function ze(t,e){let{options:r,refs:i}=e,{device:o}=t,a=navigator.gpu.getPreferredCanvasFormat(),n=r.bloom_intensity??40,f=r.bloom_combine_constant??.68,s=new Float32Array([n,f]),c=o.createBuffer({label:"scene composite params buffer",size:s.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(c.getMappedRange()).set(s),c.unmap();let u=o.createRenderPipeline({layout:"auto",vertex:{module:o.createShaderModule({code:I}),entryPoint:"vert_main"},fragment:{module:o.createShaderModule({code:I}),entryPoint:"frag_main",targets:[{format:a}]},primitive:{topology:"triangle-list"}});return{bindGroup:o.createBindGroup({layout:u.getBindGroupLayout(0),entries:[{binding:0,resource:i.hdr.data.sampler},{binding:1,resource:i.hdr.data.view},{binding:2,resource:i.bloom.data.mip_view[0]},{binding:3,resource:{buffer:c}}]}),pipeline:u,params_buf:c}}function Ie(t,e,r){let i=r.beginRenderPass({colorAttachments:[{view:e.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:o,bindGroup:a}=e.data;i.setPipeline(o),i.setBindGroup(0,a),i.draw(6,1,0,0),i.end()}function Le(t,e){let{pipeline:r,params_buf:i}=e.data,{device:o}=t;e.data.bindGroup=o.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:e.refs.hdr.data.sampler},{binding:1,resource:e.refs.hdr.data.view},{binding:2,resource:e.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:i}}]})}var G={};Be(G,{addSprite:()=>Oe,removeSprite:()=>Ae,setSprite:()=>We,setSpriteName:()=>Ve,setSpriteOpacity:()=>qe,setSpritePosition:()=>Ne,setSpriteRotation:()=>Xe,setSpriteTint:()=>Ye});function L(t,e,r){if(r.spriteCount===0)return 0;let i=0,o=r.spriteCount-1,a=t<<16&16711680|e&65535;for(;i<=o;){let n=r.spriteData[i*12+11];if(a<=n)return i;let f=r.spriteData[o*12+11];if(a>=f)return o+1;let s=Math.floor((i+o)/2),c=r.spriteData[s*12+11];if(a===c)return s+1;a>c?i=s+1:o=s-1}return i}function B(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function Oe(t,e,r,i,o,a,n,f,s){let c=e.refs.spritesheet.data.spritesheet;e=e.data;let u=c.locations.indexOf(r),p=L(s,u,e),m=(p+1)*12;e.spriteData.set(e.spriteData.subarray(p*12,e.spriteCount*12),m),te(e,c,p,r,i,o,a,n,f,s);for(let[l,g]of e.spriteIndices)g>=p&&e.spriteIndices.set(l,g+1);let v=B();return e.spriteIndices.set(v,p),e.spriteCount++,e.dirty=!0,v}function Ae(t,e,r){e=e.data;let i=e.spriteIndices.get(r);for(let[a,n]of e.spriteIndices)n>i&&e.spriteIndices.set(a,n-1);let o=i*12;e.spriteData.set(e.spriteData.subarray((i+1)*12,e.spriteCount*12),o),e.spriteIndices.delete(r),e.spriteCount--,e.dirty=!0}function Ve(t,e,r,i,o){let a=e.refs.spritesheet.data.spritesheet;e=e.data;let n=a.locations.indexOf(i),f=a.spriteMeta[i].w,s=a.spriteMeta[i].h,u=e.spriteIndices.get(r)*12;e.spriteData[u+2]=f*o[0],e.spriteData[u+3]=s*o[1];let m=(e.spriteData[u+11]>>16&255)<<16&16711680|n&65535;e.spriteData[u+11]=m,e.dirty=!0}function Ne(t,e,r,i){e=e.data;let a=e.spriteIndices.get(r)*12;e.spriteData[a]=i[0],e.spriteData[a+1]=i[1],e.dirty=!0}function Ye(t,e,r,i){e=e.data;let a=e.spriteIndices.get(r)*12;e.spriteData[a+4]=i[0],e.spriteData[a+5]=i[1],e.spriteData[a+6]=i[2],e.spriteData[a+7]=i[3],e.dirty=!0}function qe(t,e,r,i){e=e.data;let a=e.spriteIndices.get(r)*12;e.spriteData[a+8]=i,e.dirty=!0}function Xe(t,e,r,i){e=e.data;let a=e.spriteIndices.get(r)*12;e.spriteData[a+9]=i,e.dirty=!0}function We(t,e,r,i,o,a,n,f,s,c){let u=e.refs.spritesheet.data.spritesheet;e=e.data;let p=e.spriteIndices.get(r);te(e,u,p,i,o,a,n,f,s,c),e.dirty=!0}function te(t,e,r,i,o,a,n,f,s,c){if(!e.spriteMeta[i])throw new Error(`Sprite name ${i} could not be found in the spritesheet metaData`);let u=r*12,p=e.spriteMeta[i].w,m=e.spriteMeta[i].h,v=e.locations.indexOf(i),l=c<<16&16711680|v&65535;t.spriteData[u]=o[0],t.spriteData[u+1]=o[1],t.spriteData[u+2]=p*a[0],t.spriteData[u+3]=m*a[1],t.spriteData[u+4]=n[0],t.spriteData[u+5]=n[1],t.spriteData[u+6]=n[2],t.spriteData[u+7]=n[3],t.spriteData[u+8]=f,t.spriteData[u+9]=s,t.spriteData[u+11]=l}var re={type:"sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return He(t,e)},onRun:function(t,e,r){je(t,e,r)},onDestroy:function(t,e){Qe(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{...G}};async function He(t,e){let{device:r}=t,i=16192,o=i,n=Float32Array.BYTES_PER_ELEMENT*2,s=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*4,m=Float32Array.BYTES_PER_ELEMENT*4,v=r.createBuffer({size:(n+s+u+m)*o,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),l=e.refs.spritesheet.data,g=r.createBindGroup({layout:e.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:l.uniformBuffer}},{binding:1,resource:l.colorTexture.view},{binding:2,resource:l.colorTexture.sampler},{binding:3,resource:{buffer:v}},{binding:4,resource:l.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(i*2),instancedDrawCallCount:0,bindGroup:g,spriteBuffer:v,spriteData:new Float32Array(i*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function je(t,e,r){let{device:i}=t,o=e.options.loadOp||"load";e.data.dirty&&(ke(e.data),e.data.dirty=!1),i.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer);let a=r.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:o,storeOp:"store"},{view:e.refs.emissive.data.view,clearValue:t.clearValue,loadOp:"clear",storeOp:"store"}]});a.setPipeline(e.refs.spritesheet.data.pipeline),a.setBindGroup(0,e.data.bindGroup),a.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let n=6,f=0;for(let s=0;s<e.data.instancedDrawCallCount;s++){let c=e.data.instancedDrawCalls[s*2]*n,u=e.data.instancedDrawCalls[s*2+1];a.draw(n,u,c,f),f+=u}a.end()}function ke(t){let e=-1,r=0;t.instancedDrawCallCount=0;for(let i=0;i<t.spriteCount;i++){let o=t.spriteData[i*12+11]&65535;o!==e&&(r>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=r,t.instancedDrawCallCount++),e=o,r=0),r++}r>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=r,t.instancedDrawCallCount++)}function Qe(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var ae={type:"tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Ke(t,e)},onRun:function(t,e,r){$e(t,e,r)},onDestroy:function(t,e){ie(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{setTexture:async function(t,e,r){let{device:i}=t;ie(e),e.options.textureUrl=r;let o=await w(t,"tile map",e.options.textureUrl),a=i.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]});e.data.bindGroup=a,e.data.material=o}}};async function Ke(t,e){let{device:r}=t,i=await w(t,"tile map",e.options.textureUrl),o=new Float32Array([e.options.scrollScale,e.options.scrollScale]),a=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,n={size:o.byteLength,usage:a,mappedAtCreation:!0},f=r.createBuffer(n);return new Float32Array(f.getMappedRange()).set(o),f.unmap(),{bindGroup:r.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:f}},{binding:1,resource:i.view},{binding:2,resource:i.sampler}]}),material:i,uniformBuffer:f,scrollScale:e.options.scrollScale}}function $e(t,e,r){let{device:i}=t,o=e.options.loadOp||"load",a=r.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]}),n=e.refs.tileAtlas.data;a.setPipeline(n.pipeline),a.setVertexBuffer(0,n.quad.buffer),a.setBindGroup(0,e.data.bindGroup),a.setBindGroup(1,n.atlasBindGroup),a.draw(6,1,0,0),a.end()}function ie(t){t.data.material.texture.destroy(),t.data.material.texture=void 0}var O="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct displacement_param{offset:vec2<f32>,scale:f32,noop:f32};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:displacement_param;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const sx:f32=1.0;const sy:f32=1.0;const sz:f32=1.0;const tx:f32=1.0;const ty:f32=1.0;const tz:f32=0;const rot:f32=0.0;const s=sin(rot);const c=cos(rot);const scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);const modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";import{default as Jt}from"https://cdn.jsdelivr.net/gh/mreinstein/remove-array-items/src/remove-array-items.js";import{default as er}from"https://cdn.skypack.dev/pin/round-half-up-symmetric@v2.0.0-pfMZ4UGGs9FcqO8UiEHO/mode=imports,min/optimized/round-half-up-symmetric.js";import{mat4 as y,vec2 as A,vec3 as _,vec4 as oe}from"https://wgpu-matrix.org/dist/2.x/wgpu-matrix.module.js";var ne=_.create(0,0,0),U=6,se={type:"displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return Ze(t,e)},onRun:function(t,e,r){et(t,e,r)},onDestroy:function(t,e){tt(e)},onResize:function(t,e){rt(t,e)},onViewportPosition:function(t,e){it(t,e)},customFunctions:{addTriangle:function(t,e,r){let i=B(),o=e.data.spriteCount;e.data.spriteIndices.set(i,o);let a=o*U;return e.data.spriteData[a]=r[0][0],e.data.spriteData[a+1]=r[0][1],e.data.spriteData[a+2]=r[1][0],e.data.spriteData[a+3]=r[1][1],e.data.spriteData[a+4]=r[2][0],e.data.spriteData[a+5]=r[2][1],e.data.spriteCount++,i},removeTriangle:function(t,e,r){e.data.spriteIndices.delete(r),e.data.spriteCount--},setPosition:function(t,e,r,i){let a=e.data.spriteIndices.get(r)*U;e.data.spriteData[a]=i[0][0],e.data.spriteData[a+1]=i[0][1],e.data.spriteData[a+2]=i[1][0],e.data.spriteData[a+3]=i[1][1],e.data.spriteData[a+4]=i[2][0],e.data.spriteData[a+5]=i[2][1]}}};async function Ze(t,e){let{device:r}=t,i=new Float32Array([e.options.offseyX??0,e.options.offseyY??0,e.options.scale??20,0]),o=r.createBuffer({label:"displacement options buffer",size:i.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(o.getMappedRange()).set(i),o.unmap();let a=256,n=a,s=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*2,m=Float32Array.BYTES_PER_ELEMENT*2,v=r.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),l=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),g=r.createPipelineLayout({bindGroupLayouts:[l]}),T="repeat",d="linear",C=r.createSampler({label:"displacement ampler",addressModeU:T,addressModeV:T,addressModeW:T,magFilter:d,minFilter:d,mipmapFilter:d}),P=r.createBindGroup({layout:l,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:e.refs.color.data.view},{binding:2,resource:C},{binding:3,resource:e.refs.map.view},{binding:4,resource:{buffer:o}}]}),M=r.createBuffer({size:a*U,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),D={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},z=r.createRenderPipeline({label:"displacement",vertex:{module:r.createShaderModule({code:O}),entryPoint:"vs_main",buffers:[D]},fragment:{module:r.createShaderModule({code:O}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:g});return{bindGroup:P,bindGroupLayout:l,uniformBuffer:v,sampler:C,pipeline:z,params_buf:o,buffer:M,spriteData:new Float32Array(a*U),spriteCount:0,spriteIndices:new Map}}function et(t,e,r){if(e.data.spriteCount===0)return;let{device:i}=t,o=U*e.data.spriteCount*Float32Array.BYTES_PER_ELEMENT;i.queue.writeBuffer(e.data.buffer,0,e.data.spriteData.buffer,0,o);let a=r.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});a.setPipeline(e.data.pipeline),a.setBindGroup(0,e.data.bindGroup),a.setVertexBuffer(0,e.data.buffer);let n=e.data.spriteCount*3;a.draw(n,1,0,0),a.end()}function tt(t){t.data.bindGroup=null,t.data.buffer.destroy(),t.data.buffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null,t.data.params_buf.destroy(),t.data.params_buf=null}function rt(t,e){let{device:r}=t;e.data.bindGroup=r.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:e.refs.color.data.view},{binding:2,resource:e.data.sampler},{binding:3,resource:e.refs.map.view},{binding:4,resource:{buffer:e.data.params_buf}}]})}function it(t,e){let{device:r}=t,i=t.viewport.width/t.viewport.zoom,o=t.viewport.height/t.viewport.zoom,a=y.ortho(0,i,o,0,-10,10);_.set(-t.viewport.position[0],-t.viewport.position[1],0,ne);let n=y.translation(ne);r.queue.writeBuffer(e.data.uniformBuffer,0,n.buffer),r.queue.writeBuffer(e.data.uniformBuffer,64,a.buffer)}function V(t,e){let r=e.vertices,i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,o={size:r.byteLength,usage:i,mappedAtCreation:!0},a=t.createBuffer(o);return new Float32Array(a.getMappedRange()).set(r),a.unmap(),{buffer:a,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var N="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var Sr=oe.create(),ue=_.create(),le={type:"overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return ot(t,e)},onRun:function(t,e,r){nt(t,e,r)},onDestroy:function(t,e){ut(e)},onResize:function(t,e){ce(t,e)},onViewportPosition:function(t,e){ce(t,e)},customFunctions:{...G}};async function ot(t,e){let{device:r}=t,i=16192,o=i,n=Float32Array.BYTES_PER_ELEMENT*2,s=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*4,m=Float32Array.BYTES_PER_ELEMENT*4,v=r.createBuffer({size:(n+s+u+m)*o,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),l=r.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),g=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),T=r.createBindGroup({layout:g,entries:[{binding:0,resource:{buffer:l}},{binding:1,resource:e.refs.spritesheet.data.colorTexture.view},{binding:2,resource:e.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:v}}]}),d=r.createPipelineLayout({bindGroupLayouts:[g]}),C=r.createRenderPipeline({label:"overlay",vertex:{module:r.createShaderModule({code:N}),entryPoint:"vs_main",buffers:[e.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:r.createShaderModule({code:N}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:d});return{instancedDrawCalls:new Uint32Array(i*2),instancedDrawCallCount:0,spriteBuffer:v,uniformBuffer:l,pipeline:C,bindGroupLayout:g,bindGroup:T,spriteData:new Float32Array(i*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function nt(t,e,r){let{device:i}=t,o=e.options.loadOp||"load";e.data.dirty&&(st(e.data),e.data.dirty=!1),i.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer);let a=r.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});a.setPipeline(e.data.pipeline),a.setBindGroup(0,e.data.bindGroup),a.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let n=6,f=0;for(let s=0;s<e.data.instancedDrawCallCount;s++){let c=e.data.instancedDrawCalls[s*2]*n,u=e.data.instancedDrawCalls[s*2+1];a.draw(n,u,c,f),f+=u}a.end()}function st(t){let e=-1,r=0;t.instancedDrawCallCount=0;for(let i=0;i<t.spriteCount;i++){let o=t.spriteData[i*12+11]&65535;o!==e&&(r>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=r,t.instancedDrawCallCount++),e=o,r=0),r++}r>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=r,t.instancedDrawCallCount++)}function ce(t,e){let i=Math.round(t.viewport.width/1),o=Math.round(t.viewport.height/1),a=y.ortho(0,i,o,0,-10,10);_.set(0,0,0,ue);let n=y.translation(ue);t.device.queue.writeBuffer(e.data.uniformBuffer,0,n.buffer),t.device.queue.writeBuffer(e.data.uniformBuffer,64,a.buffer)}function ut(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var Y="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const pos=array(vec2(1.0,1.0),vec2(1.0,-1.0),vec2(-1.0,-1.0),vec2(1.0,1.0),vec2(-1.0,-1.0),vec2(-1.0,1.0),);const uv=array(vec2(1.0,0.0),vec2(1.0,1.0),vec2(0.0,1.0),vec2(1.0,0.0),vec2(0.0,1.0),vec2(0.0,0.0),);@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4(pos[VertexIndex],0.0,1.0);output.TexCoord=uv[VertexIndex];return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var pe={type:"fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return ft(t,e)},onRun:function(t,e,r){lt(t,e,r)},onDestroy:function(t,e){},onResize:function(t,e){pt(t,e)},onViewportPosition:function(t,e){}};async function ft(t,e){let{device:r}=t,i=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),o=r.createBindGroup({layout:i,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]}),a=r.createPipelineLayout({bindGroupLayouts:[i]}),n=r.createRenderPipeline({label:"fb-blit",vertex:{module:r.createShaderModule({code:Y}),entryPoint:"vs_main",buffers:[]},fragment:{module:r.createShaderModule({code:Y}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:a});return{bindGroupLayout:i,bindGroup:o,pipeline:n}}function lt(t,e,r){let{device:i}=t,o=r.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});o.setPipeline(e.data.pipeline),o.setBindGroup(0,e.data.bindGroup),o.draw(6,1,0,0),o.end()}function pt(t,e){let{device:r}=t;e.data.bindGroup=r.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]})}var de="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function F(t,e,r,i,o,a=1){let n=A.sub(i,r),f=A.normalize(n),s=mt(f),c=a/2,u=e.data.vertexCount*6;e.data.vertices[u+0]=r[0]+s[0]*c,e.data.vertices[u+1]=r[1]+s[1]*c,e.data.vertices[u+2]=o[0],e.data.vertices[u+3]=o[1],e.data.vertices[u+4]=o[2],e.data.vertices[u+5]=o[3],e.data.vertices[u+6]=r[0]-s[0]*c,e.data.vertices[u+7]=r[1]-s[1]*c,e.data.vertices[u+8]=o[0],e.data.vertices[u+9]=o[1],e.data.vertices[u+10]=o[2],e.data.vertices[u+11]=o[3],e.data.vertices[u+12]=i[0]+s[0]*c,e.data.vertices[u+13]=i[1]+s[1]*c,e.data.vertices[u+14]=o[0],e.data.vertices[u+15]=o[1],e.data.vertices[u+16]=o[2],e.data.vertices[u+17]=o[3],e.data.vertices[u+18]=r[0]-s[0]*c,e.data.vertices[u+19]=r[1]-s[1]*c,e.data.vertices[u+20]=o[0],e.data.vertices[u+21]=o[1],e.data.vertices[u+22]=o[2],e.data.vertices[u+23]=o[3],e.data.vertices[u+24]=i[0]+s[0]*c,e.data.vertices[u+25]=i[1]+s[1]*c,e.data.vertices[u+26]=o[0],e.data.vertices[u+27]=o[1],e.data.vertices[u+28]=o[2],e.data.vertices[u+29]=o[3],e.data.vertices[u+30]=i[0]-s[0]*c,e.data.vertices[u+31]=i[1]-s[1]*c,e.data.vertices[u+32]=o[0],e.data.vertices[u+33]=o[1],e.data.vertices[u+34]=o[2],e.data.vertices[u+35]=o[3],e.data.vertexCount+=6,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)}function mt(t){return[-t[1],t[0]]}var me={line:F,filledEllipse:function(t,e,r,i,o,a,n){let[f,s]=r,c=2*Math.PI/a;for(let u=0;u<a;u++){let p=u*c,m=(u+1)*c,v=f+i*Math.cos(p),l=s+o*Math.sin(p),g=f+i*Math.cos(m),T=s+o*Math.sin(m),d=e.data.vertexCount*6+u*18;e.data.vertices[d+0]=f,e.data.vertices[d+1]=s,e.data.vertices[d+2]=n[0],e.data.vertices[d+3]=n[1],e.data.vertices[d+4]=n[2],e.data.vertices[d+5]=n[3],e.data.vertices[d+6]=v,e.data.vertices[d+7]=l,e.data.vertices[d+8]=n[0],e.data.vertices[d+9]=n[1],e.data.vertices[d+10]=n[2],e.data.vertices[d+11]=n[3],e.data.vertices[d+12]=g,e.data.vertices[d+13]=T,e.data.vertices[d+14]=n[0],e.data.vertices[d+15]=n[1],e.data.vertices[d+16]=n[2],e.data.vertices[d+17]=n[3]}e.data.vertexCount+=3*a,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)},box:function(t,e,r,i,o,a,n=1){let[f,s]=r,c=i/2,u=o/2,p=[f-c,s-u],m=[f+c,s-u],v=[f-c,s+u],l=[f+c,s+u];F(t,e,p,m,a,n),F(t,e,v,l,a,n),F(t,e,p,v,a,n),F(t,e,m,l,a,n)},filledBox:function(t,e,r,i,o,a){let[n,f]=r,s=i/2,c=o/2,u={x:n-s,y:f-c},p={x:n+s,y:f-c},m={x:n-s,y:f+c},v={x:n+s,y:f+c},l=e.data.vertexCount*6;e.data.vertices[l+0]=u.x,e.data.vertices[l+1]=u.y,e.data.vertices[l+2]=a[0],e.data.vertices[l+3]=a[1],e.data.vertices[l+4]=a[2],e.data.vertices[l+5]=a[3],e.data.vertices[l+6]=m.x,e.data.vertices[l+7]=m.y,e.data.vertices[l+8]=a[0],e.data.vertices[l+9]=a[1],e.data.vertices[l+10]=a[2],e.data.vertices[l+11]=a[3],e.data.vertices[l+12]=p.x,e.data.vertices[l+13]=p.y,e.data.vertices[l+14]=a[0],e.data.vertices[l+15]=a[1],e.data.vertices[l+16]=a[2],e.data.vertices[l+17]=a[3],e.data.vertices[l+18]=m.x,e.data.vertices[l+19]=m.y,e.data.vertices[l+20]=a[0],e.data.vertices[l+21]=a[1],e.data.vertices[l+22]=a[2],e.data.vertices[l+23]=a[3],e.data.vertices[l+24]=v.x,e.data.vertices[l+25]=v.y,e.data.vertices[l+26]=a[0],e.data.vertices[l+27]=a[1],e.data.vertices[l+28]=a[2],e.data.vertices[l+29]=a[3],e.data.vertices[l+30]=p.x,e.data.vertices[l+31]=p.y,e.data.vertices[l+32]=a[0],e.data.vertices[l+33]=a[1],e.data.vertices[l+34]=a[2],e.data.vertices[l+35]=a[3],e.data.vertexCount+=6,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)},clear:function(t,e){e.data.vertexCount=0}};var ve=_.create(0,0,0),ge={type:"primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return vt(t,e)},onRun:function(t,e,r){xt(t,e,r)},onDestroy:function(t,e){gt(e)},onResize:function(t,e){xe(t,e)},onViewportPosition:function(t,e){xe(t,e)},customFunctions:me};async function vt(t,e){let{device:r}=t,i=new Float32Array(1e4),o=r.createBuffer({size:i.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),a=r.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),n=r.createShaderModule({code:de}),f=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),s=r.createPipelineLayout({bindGroupLayouts:[f]}),c=r.createBindGroup({layout:f,entries:[{binding:0,resource:{buffer:a}}]}),u=r.createRenderPipeline({layout:s,vertex:{module:n,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:n,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:a,vertexBuffer:o,pipeline:u,bindGroup:c,vertexCount:0,vertices:i}}function xt(t,e,r){if(e.data.vertexCount===0)return;let{device:i}=t,o=e.options.loadOp||"load",a=r.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]});a.setPipeline(e.data.pipeline),a.setBindGroup(0,e.data.bindGroup),a.setVertexBuffer(0,e.data.vertexBuffer),a.draw(e.data.vertexCount),a.end()}function gt(t){t.data.vertexBuffer.destroy(),t.data.vertexBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null}function xe(t,e){let{device:r}=t,i=t.viewport.width/t.viewport.zoom,o=t.viewport.height/t.viewport.zoom,a=y.ortho(0,i,o,0,-10,10);_.set(-t.viewport.position[0],-t.viewport.position[1],0,ve);let n=y.translation(ve);r.queue.writeBuffer(e.data.uniformBuffer,0,n.buffer),r.queue.writeBuffer(e.data.uniformBuffer,64,a.buffer)}function q(t){let e=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]),r=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,i={size:e.byteLength,usage:r,mappedAtCreation:!0},o=t.createBuffer(i);return new Float32Array(o.getMappedRange()).set(e),o.unmap(),{buffer:o,bufferLayout:{arrayStride:16,attributes:[{shaderLocation:0,format:"float32x2",offset:0},{shaderLocation:1,format:"float32x2",offset:8}]}}}var X="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec2<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var h=new Float32Array(8),ye={type:"tileAtlas",refs:[],onInit:async function(t,e={}){return yt(t,e)},onRun:function(t,e,r){},onDestroy:function(t,e){_t(data)},onResize:function(t,e){be(t,e)},onViewportPosition:function(t,e){be(t,e)}};async function yt(t,e){let{device:r}=t,i=q(r),o=await w(t,"tile atlas",e.options.textureUrl),a=r.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),n=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),f=r.createBindGroup({layout:n,entries:[{binding:0,resource:{buffer:a}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]}),s=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),c=r.createPipelineLayout({bindGroupLayouts:[s,n]});return{pipeline:r.createRenderPipeline({label:"tile",vertex:{module:r.createShaderModule({code:X}),entryPoint:"vs_main",buffers:[i.bufferLayout]},fragment:{module:r.createShaderModule({code:X}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:c}),uniformBuffer:a,atlasBindGroup:f,atlasMaterial:o,tileBindGroupLayout:s,quad:i,tileSize:e.options.tileSize,tileScale:e.options.tileScale}}function _t(t){t.atlasMaterial.texture.destroy(),t.atlasMaterial.texture=void 0}function be(t,e){h[0]=t.viewport.position[0],h[1]=t.viewport.position[1];let r=e.data,{tileScale:i,tileSize:o}=r,a=t.viewport.width/t.viewport.zoom,n=t.viewport.height/t.viewport.zoom;h[2]=a/i,h[3]=n/i,h[4]=1/r.atlasMaterial.texture.width,h[5]=1/r.atlasMaterial.texture.height,h[6]=o,h[7]=1/o,t.device.queue.writeBuffer(r.uniformBuffer,0,h,0,8)}function W(t){let r=Object.keys(t.frames).length,i=new Float32Array(r*30),o=[],a={},n=0;for(let f in t.frames){let s=t.frames[f];o.push(f),a[f]=s.sourceSize;let c=-.5+s.spriteSourceSize.x/s.sourceSize.w,u=-.5+s.spriteSourceSize.y/s.sourceSize.h,p=-.5+(s.spriteSourceSize.x+s.spriteSourceSize.w)/s.sourceSize.w,m=-.5+(s.spriteSourceSize.y+s.spriteSourceSize.h)/s.sourceSize.h,v=[c,u,0],l=[c,m,0],g=[p,m,0],T=[p,u,0],d=0+s.frame.x/t.meta.size.w,C=0+s.frame.y/t.meta.size.h,P=0+(s.frame.x+s.frame.w)/t.meta.size.w,M=0+(s.frame.y+s.frame.h)/t.meta.size.h,D=[d,C],z=[d,M],j=[P,M],Ce=[P,C];i.set(v,n),i.set(D,n+3),i.set(l,n+5),i.set(z,n+8),i.set(g,n+10),i.set(j,n+13),i.set(v,n+15),i.set(D,n+18),i.set(g,n+20),i.set(j,n+23),i.set(T,n+25),i.set(Ce,n+28),n+=30}return{spriteMeta:a,locations:o,vertices:i}}var H="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var _e=_.create(0,0,0),we={type:"spritesheet",refs:[],onInit:async function(t,e={}){return wt(t,e)},onRun:function(t,e,r){},onDestroy:function(t,e){Tt(e)},onResize:function(t,e){Se(t,e)},onViewportPosition:function(t,e){Se(t,e)}};async function wt(t,e){let{canvas:r,device:i}=t,o=await ht(e.options.spriteSheetJsonUrl);o=W(o);let a=V(i,o),[n,f]=await Promise.all([w(t,"sprite",e.options.colorTextureUrl,"rgba8unorm"),w(t,"emissive sprite",e.options.emissiveTextureUrl,"rgba8unorm")]);r.style.imageRendering="pixelated";let s=i.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),c=i.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),u=i.createPipelineLayout({bindGroupLayouts:[c]});return{pipeline:i.createRenderPipeline({label:"sprite",vertex:{module:i.createShaderModule({code:H}),entryPoint:"vs_main",buffers:[a.bufferLayout]},fragment:{module:i.createShaderModule({code:H}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:u}),uniformBuffer:s,quads:a,colorTexture:n,emissiveTexture:f,bindGroupLayout:c,spritesheet:o}}function Tt(t){t.data.quads.buffer.destroy(),t.data.colorTexture.buffer.destroy(),t.data.uniformBuffer.destroy(),t.data.emissiveTexture.texture.destroy()}async function ht(t){return(await fetch(t)).json()}function Se(t,e){let{device:r,viewport:i}=t,o=i.width/i.zoom,a=i.height/i.zoom,n=y.ortho(0,o,a,0,-10,10);_.set(-i.position[0],-i.position[1],0,_e);let f=y.translation(_e);r.queue.writeBuffer(e.data.uniformBuffer,0,f.buffer),r.queue.writeBuffer(e.data.uniformBuffer,64,n.buffer)}var Te={type:"fbTexture",refs:[],onInit:async function(t,e={}){return Ct(t,e)},onRun:function(t,e,r){},onDestroy:function(t,e){he(data)},onResize:function(t,e){Et(t,e)},onViewportPosition:function(t,e){}};async function Ct(t,e){let{device:r}=t,{label:i,mip_count:o,format:a,usage:n,viewportScale:f}=e.options;return b(r,i,t.viewport.width*f,t.viewport.height*f,o,a,n)}function he(t){t.data.texture.destroy()}function Et(t,e){let{device:r}=t;he(e);let{width:i,height:o}=t.viewport,{options:a}=e,n=e.options.viewportScale;e.data=b(r,a.label,i*n,o*n,a.mip_count,a.format,a.usage)}async function pi(t,e,r){let o=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),a=t.getContext("webgpu"),n=navigator.gpu.getPreferredCanvasFormat();return a.configure({device:o,format:n,alphaMode:"opaque"}),{nodeDefs:{tileAtlas:ye,spritesheet:we,fbTexture:Te,bloom:$,composite:ee,sprite:re,tile:ae,displacement:se,overlay:le,fbBlit:pe,primitives:ge},nodes:[],defaultTextureViewRefs:[],canvas:t,device:o,context:a,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:e,height:r,zoom:1,position:[0,0]}}}function di(t,e){if(!e?.type)throw new Error("Can't define a new node missing a type.");t.nodeDefs[e.type]=e}async function mi(t,e){let r=t.nodeDefs[e?.type];if(!r)throw new Error("Can't initialize a new node missing a type.");let i={type:e.type,refs:e.refs||{},options:e.options||{},data:{},enabled:!0};for(let a in i.refs)i.refs[a]==="FRAME_TEXTURE_VIEW"&&(t.defaultTextureViewRefs.push({node:i,refName:a}),i.refs[a]=t.context.getCurrentTexture().createView());i.data=await r.onInit(t,i);let o=r.customFunctions||{};for(let a in o)i[a]=function(...n){return o[a](t,i,...n)};return t.nodes.push(i),i}function vi(t){let{device:e,context:r}=t,i=e.createCommandEncoder(),o=t.context.getCurrentTexture().createView();for(let a of t.defaultTextureViewRefs)a.node.refs[a.refName]=o;for(let a of t.nodes){if(!a.enabled)continue;t.nodeDefs[a.type].onRun(t,a,i)}e.queue.submit([i.finish()])}function xi(t){for(let e of t.nodes)t.nodeDefs[e.type].onDestroy(t,e);t.nodes.length=0,t.defaultTextureViewRefs.length=0}function gi(t,e,r){t.viewport.width=e,t.viewport.height=r;for(let i of t.nodes)t.nodeDefs[i.type].onResize(t,i)}function bi(t,e){t.viewport.position[0]=e[0]-t.viewport.width/2/t.viewport.zoom,t.viewport.position[1]=e[1]-t.viewport.height/2/t.viewport.zoom;for(let r of t.nodes)t.nodeDefs[r.type].onViewportPosition(t,r)}export{b as createTexture,w as createTextureFromUrl,di as defineNode,vi as draw,pi as init,mi as initNode,xi as reset,gi as setViewportDimensions,bi as setViewportPosition};

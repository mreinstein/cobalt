var Tn=Object.defineProperty;var Ge=(o,n)=>{for(var v in n)Tn(o,v,{get:n[v],enumerable:!0})};function Ft(o,n,v,y,B,S,U){let A=o.createTexture({label:n,size:{width:v,height:y},format:S,usage:U,mipLevelCount:B,sampleCount:1,dimension:"2d"}),L=A.createView(),F=[];for(let W=0;W<B;W++)F.push(A.createView({label:n,format:S,dimension:"2d",aspect:"all",baseMipLevel:W,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let I=o.createSampler({label:`${n} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:v,height:y},texture:A,view:L,mip_view:F,sampler:I}}async function $t(o,n,v,y="rgba8unorm"){let S=await(await fetch(v)).blob(),U=await createImageBitmap(S),A=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,F=Ft(o.device,n,U.width,U.height,1,y,A);o.device.queue.copyExternalImageToTexture({source:U},{texture:F.texture},{width:U.width,height:U.height});let I={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return F.sampler=o.device.createSampler(I),F}function oe(o,n,v,y="rgba8unorm"){let B=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,U=Ft(o.device,n,v.width,v.height,1,y,B);o.device.queue.writeTexture({texture:U.texture},v.data,{bytesPerRow:4*v.width},{width:v.width,height:v.height});let A={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return U.sampler=o.device.createSampler(A),U}var Ue="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var qt=7,Pn=0,Ie=1,Bn=2,Le=3,Ee={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(o,n={}){return zn(o,n)},onRun:function(o,n,v){Gn(o,n.data,v)},onDestroy:function(o,n){Fe(n)},onResize:function(o,n){Un(o,n)},onViewportPosition:function(o,n){}};function zn(o,n){let{device:v}=o,y=o.viewport.width,B=o.viewport.height,S={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},U=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});S.bind_group_layout.push(U),S.bind_groups_textures.push(Ft(v,"bloom downsampler image 0",y/2,B/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),S.bind_groups_textures.push(Ft(v,"bloom downsampler image 1",y/2,B/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),S.bind_groups_textures.push(n.refs.bloom.data);let A=v.createPipelineLayout({bindGroupLayouts:S.bind_group_layout}),L=v.createComputePipeline({layout:A,compute:{module:v.createShaderModule({code:Ue}),entryPoint:"cs_main"}});return Ae(o,S,n),S.compute_pipeline=L,S}function Ae(o,n,v){let{refs:y}=v,{device:B}=o,S=v.options.bloom_threshold??.1,U=v.options.bloom_knee??.2,A=v.options.bloom_combine_constant??.68,L=new Float32Array([S,S-U,U*2,.25/U,A,0,0,0]),F=B.createBuffer({label:"bloom static parameters buffer",size:L.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(F.getMappedRange()).set(L),F.unmap(),n.bind_group.length=0,n.params_buf=F,n.bind_group.push(Jt(B,n,n.bind_groups_textures[0].mip_view[0],y.emissive.data.view,y.hdr.data.view,y.hdr.data.sampler,F,Pn<<16|0));for(let W=1;W<qt;W++)n.bind_group.push(Jt(B,n,n.bind_groups_textures[1].mip_view[W],n.bind_groups_textures[0].view,y.hdr.data.view,y.hdr.data.sampler,F,Ie<<16|W-1)),n.bind_group.push(Jt(B,n,n.bind_groups_textures[0].mip_view[W],n.bind_groups_textures[1].view,y.hdr.data.view,y.hdr.data.sampler,F,Ie<<16|W));n.bind_group.push(Jt(B,n,n.bind_groups_textures[2].mip_view[qt-1],n.bind_groups_textures[0].view,y.hdr.data.view,y.hdr.data.sampler,F,Bn<<16|qt-2));let I=!0;for(let W=qt-2;W>=0;W--)I?(n.bind_group.push(Jt(B,n,n.bind_groups_textures[1].mip_view[W],n.bind_groups_textures[0].view,n.bind_groups_textures[2].view,y.hdr.data.sampler,F,Le<<16|W)),I=!1):(n.bind_group.push(Jt(B,n,n.bind_groups_textures[2].mip_view[W],n.bind_groups_textures[0].view,n.bind_groups_textures[1].view,y.hdr.data.sampler,F,Le<<16|W)),I=!0)}function Jt(o,n,v,y,B,S,U,A){let L=new Uint32Array([A]),F=o.createBuffer({label:"bloom static mode_lod buffer",size:L.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(F.getMappedRange()).set(L),F.unmap(),o.createBindGroup({label:"bloom bind group layout",layout:n.bind_group_layout[0],entries:[{binding:0,resource:v},{binding:1,resource:y},{binding:2,resource:B},{binding:3,resource:S},{binding:4,resource:{buffer:U}},{binding:5,resource:{buffer:F}}]})}function Gn(o,n,v){let A=0,L=v.beginComputePass({label:"bloom Compute Pass"});L.setPipeline(n.compute_pipeline),L.setBindGroup(0,n.bind_group[A]),A+=1;let F=ae(0,n.bind_groups_textures[0]);L.dispatchWorkgroups(F.width/8+1,F.height/4+1,1);for(let I=1;I<qt;I++)F=ae(I,n.bind_groups_textures[0]),L.setBindGroup(0,n.bind_group[A]),A+=1,L.dispatchWorkgroups(F.width/8+1,F.height/4+1,1),L.setBindGroup(0,n.bind_group[A]),A+=1,L.dispatchWorkgroups(F.width/8+1,F.height/4+1,1);L.setBindGroup(0,n.bind_group[A]),A+=1,F=ae(qt-1,n.bind_groups_textures[2]),L.dispatchWorkgroups(F.width/8+1,F.height/4+1,1);for(let I=qt-2;I>=0;I--)F=ae(I,n.bind_groups_textures[2]),L.setBindGroup(0,n.bind_group[A]),A+=1,L.dispatchWorkgroups(F.width/8+1,F.height/4+1,1);L.end()}function ae(o,n){let v=n.size.width,y=n.size.height;for(let B=0;B<o;B++)v/=2,y/=2;return{width:v,height:y,depthOrArrayLayers:1}}function Un(o,n){let{device:v}=o,y=n.data;Fe(y),y.bind_groups_textures.push(Ft(v,"bloom downsampler image 0",o.viewport.width/2,o.viewport.height/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),y.bind_groups_textures.push(Ft(v,"bloom downsampler image 1",o.viewport.width/2,o.viewport.height/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),y.bind_groups_textures.push(n.refs.bloom.data),Ae(o,y,n)}function Fe(o){for(let n of o.bind_groups_textures)n.texture.destroy();o.bind_groups_textures.length=0}var ge="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Re={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(o,n={}){return Ln(o,n)},onRun:function(o,n,v){En(o,n,v)},onDestroy:function(o,n){},onResize:function(o,n){An(o,n)},onViewportPosition:function(o,n){}};function Ln(o,n){let{options:v,refs:y}=n,{device:B}=o,S=Oe(o),U=v.bloom_intensity??40,A=v.bloom_combine_constant??.68,L=new Float32Array([U,A]),F=B.createBuffer({label:"scene composite params buffer",size:L.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(F.getMappedRange()).set(L),F.unmap();let I=B.createRenderPipeline({layout:"auto",vertex:{module:B.createShaderModule({code:ge}),entryPoint:"vert_main"},fragment:{module:B.createShaderModule({code:ge}),entryPoint:"frag_main",targets:[{format:S}]},primitive:{topology:"triangle-list"}});return{bindGroup:B.createBindGroup({layout:I.getBindGroupLayout(0),entries:[{binding:0,resource:y.hdr.data.sampler},{binding:1,resource:y.hdr.data.view},{binding:2,resource:y.bloom.data.mip_view[0]},{binding:3,resource:{buffer:F}}]}),pipeline:I,params_buf:F}}function En(o,n,v){let y=v.beginRenderPass({colorAttachments:[{view:n.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:B,bindGroup:S}=n.data;y.setPipeline(B),y.setBindGroup(0,S),y.draw(3),y.end()}function An(o,n){let{pipeline:v,params_buf:y}=n.data,{device:B}=o;n.data.bindGroup=B.createBindGroup({layout:v.getBindGroupLayout(0),entries:[{binding:0,resource:n.refs.hdr.data.sampler},{binding:1,resource:n.refs.hdr.data.view},{binding:2,resource:n.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:y}}]})}var re={};Ge(re,{addSprite:()=>Rn,clear:()=>Vn,removeSprite:()=>On,setSprite:()=>Hn,setSpriteName:()=>qn,setSpriteOpacity:()=>Yn,setSpritePosition:()=>Nn,setSpriteRotation:()=>Xn,setSpriteTint:()=>$n});function xe(o,n,v){if(v.spriteCount===0)return 0;let y=0,B=v.spriteCount-1,S=o<<16&16711680|n&65535;for(;y<=B;){let U=v.spriteData[y*12+11];if(S<=U)return y;let A=v.spriteData[B*12+11];if(S>=A)return B+1;let L=Math.floor((y+B)/2),F=v.spriteData[L*12+11];if(S===F)return L+1;S>F?y=L+1:B=L-1}return y}function se(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function Rn(o,n,v,y,B,S,U,A,L){let F=n.refs.spritesheet.data.spritesheet;n=n.data;let I=F.locations.indexOf(v),W=xe(L,I,n),ot=(W+1)*12;n.spriteData.set(n.spriteData.subarray(W*12,n.spriteCount*12),ot),Ve(n,F,W,v,y,B,S,U,A,L);for(let[nt,X]of n.spriteIndices)X>=W&&n.spriteIndices.set(nt,X+1);let tt=se();return n.spriteIndices.set(tt,W),n.spriteCount++,n.dirty=!0,tt}function On(o,n,v){n=n.data;let y=n.spriteIndices.get(v);for(let[S,U]of n.spriteIndices)U>y&&n.spriteIndices.set(S,U-1);let B=y*12;n.spriteData.set(n.spriteData.subarray((y+1)*12,n.spriteCount*12),B),n.spriteIndices.delete(v),n.spriteCount--,n.dirty=!0}function Vn(o,n){n=n.data,n.spriteIndices.clear(),n.spriteCount=0,n.instancedDrawCallCount=0,n.dirty=!0}function qn(o,n,v,y,B){let S=n.refs.spritesheet.data.spritesheet;n=n.data;let U=S.locations.indexOf(y),A=S.spriteMeta[y].w,L=S.spriteMeta[y].h,I=n.spriteIndices.get(v)*12;n.spriteData[I+2]=A*B[0],n.spriteData[I+3]=L*B[1];let ot=(n.spriteData[I+11]>>16&255)<<16&16711680|U&65535;n.spriteData[I+11]=ot,n.dirty=!0}function Nn(o,n,v,y){n=n.data;let S=n.spriteIndices.get(v)*12;n.spriteData[S]=y[0],n.spriteData[S+1]=y[1],n.dirty=!0}function $n(o,n,v,y){n=n.data;let S=n.spriteIndices.get(v)*12;n.spriteData[S+4]=y[0],n.spriteData[S+5]=y[1],n.spriteData[S+6]=y[2],n.spriteData[S+7]=y[3],n.dirty=!0}function Yn(o,n,v,y){n=n.data;let S=n.spriteIndices.get(v)*12;n.spriteData[S+8]=y,n.dirty=!0}function Xn(o,n,v,y){n=n.data;let S=n.spriteIndices.get(v)*12;n.spriteData[S+9]=y,n.dirty=!0}function Hn(o,n,v,y,B,S,U,A,L,F){let I=n.refs.spritesheet.data.spritesheet;n=n.data;let W=n.spriteIndices.get(v);Ve(n,I,W,y,B,S,U,A,L,F),n.dirty=!0}function Ve(o,n,v,y,B,S,U,A,L,F){if(!n.spriteMeta[y])throw new Error(`Sprite name ${y} could not be found in the spritesheet metaData`);let I=v*12,W=n.spriteMeta[y].w,ot=n.spriteMeta[y].h,tt=n.locations.indexOf(y),nt=F<<16&16711680|tt&65535;o.spriteData[I]=B[0],o.spriteData[I+1]=B[1],o.spriteData[I+2]=W*S[0],o.spriteData[I+3]=ot*S[1],o.spriteData[I+4]=U[0],o.spriteData[I+5]=U[1],o.spriteData[I+6]=U[2],o.spriteData[I+7]=U[3],o.spriteData[I+8]=A,o.spriteData[I+9]=L,o.spriteData[I+11]=nt}var qe={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(o,n={}){return jn(o,n)},onRun:function(o,n,v){Wn(o,n,v)},onDestroy:function(o,n){Qn(n)},onResize:function(o,n){},onViewportPosition:function(o,n){},customFunctions:{...re}};async function jn(o,n){let{device:v}=o,y=16192,B=y,U=Float32Array.BYTES_PER_ELEMENT*2,L=Float32Array.BYTES_PER_ELEMENT*2,I=Float32Array.BYTES_PER_ELEMENT*4,ot=Float32Array.BYTES_PER_ELEMENT*4,tt=v.createBuffer({size:(U+L+I+ot)*B,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),nt=n.refs.spritesheet.data,X=v.createBindGroup({layout:n.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:nt.uniformBuffer}},{binding:1,resource:nt.colorTexture.view},{binding:2,resource:nt.colorTexture.sampler},{binding:3,resource:{buffer:tt}},{binding:4,resource:nt.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(y*2),instancedDrawCallCount:0,bindGroup:X,spriteBuffer:tt,spriteData:new Float32Array(y*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Wn(o,n,v){let{device:y}=o,B=n.options.loadOp||"load";n.data.dirty&&(Zn(n.data),n.data.dirty=!1),y.queue.writeBuffer(n.data.spriteBuffer,0,n.data.spriteData.buffer);let S=v.beginRenderPass({colorAttachments:[{view:n.refs.hdr.data.view,clearValue:o.clearValue,loadOp:B,storeOp:"store"},{view:n.refs.emissive.data.view,clearValue:o.clearValue,loadOp:"clear",storeOp:"store"}]});S.setPipeline(n.refs.spritesheet.data.pipeline),S.setBindGroup(0,n.data.bindGroup),S.setVertexBuffer(0,n.refs.spritesheet.data.quads.buffer);let U=6,A=0;for(let L=0;L<n.data.instancedDrawCallCount;L++){let F=n.data.instancedDrawCalls[L*2]*U,I=n.data.instancedDrawCalls[L*2+1];S.draw(U,I,F,A),A+=I}S.end()}function Zn(o){let n=-1,v=0;o.instancedDrawCallCount=0;for(let y=0;y<o.spriteCount;y++){let B=o.spriteData[y*12+11]&65535;B!==n&&(v>0&&(o.instancedDrawCalls[o.instancedDrawCallCount*2]=n,o.instancedDrawCalls[o.instancedDrawCallCount*2+1]=v,o.instancedDrawCallCount++),n=B,v=0),v++}v>0&&(o.instancedDrawCalls[o.instancedDrawCallCount*2]=n,o.instancedDrawCalls[o.instancedDrawCallCount*2+1]=v,o.instancedDrawCallCount++)}function Qn(o){o.data.instancedDrawCalls=null,o.data.bindGroup=null,o.data.spriteBuffer.destroy(),o.data.spriteBuffer=null,o.data.spriteData=null,o.data.spriteIndices.clear(),o.data.spriteIndices=null}var $e={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(o,n={}){return kn(o,n)},onRun:function(o,n,v){Kn(o,n,v)},onDestroy:function(o,n){Ne(n)},onResize:function(o,n){},onViewportPosition:function(o,n){},customFunctions:{setTexture:async function(o,n,v){let{device:y}=o;Ne(n),n.options.textureUrl=v;let B=await $t(o,"tile map",n.options.textureUrl),S=y.createBindGroup({layout:n.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:n.data.uniformBuffer}},{binding:1,resource:B.view},{binding:2,resource:B.sampler}]});n.data.bindGroup=S,n.data.material=B}}};async function kn(o,n){let{device:v}=o,y=await $t(o,"tile map",n.options.textureUrl),B=new Float32Array([n.options.scrollScale,n.options.scrollScale]),S=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,U={size:B.byteLength,usage:S,mappedAtCreation:!0},A=v.createBuffer(U);return new Float32Array(A.getMappedRange()).set(B),A.unmap(),{bindGroup:v.createBindGroup({layout:n.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:A}},{binding:1,resource:y.view},{binding:2,resource:y.sampler}]}),material:y,uniformBuffer:A,scrollScale:n.options.scrollScale}}function Kn(o,n,v){let{device:y}=o,B=n.options.loadOp||"load",S=v.beginRenderPass({colorAttachments:[{view:n.refs.hdr.data.view,clearValue:o.clearValue,loadOp:B,storeOp:"store"}]}),U=n.refs.tileAtlas.data;S.setPipeline(U.pipeline),S.setBindGroup(0,n.data.bindGroup),S.setBindGroup(1,U.atlasBindGroup),S.draw(3),S.end()}function Ne(o){o.data.material.texture.destroy(),o.data.material.texture=void 0}var ve="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct displacement_param{offset:vec2<f32>,scale:f32,noop:f32};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:displacement_param;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const sx:f32=1.0;const sy:f32=1.0;const sz:f32=1.0;const tx:f32=1.0;const ty:f32=1.0;const tz:f32=0;const rot:f32=0.0;const s=sin(rot);const c=cos(rot);const scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);const modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";function to(o,n){return class extends o{constructor(...v){super(...v),n(this)}}}var eo=to(Array,o=>o.fill(0)),it=1e-6;function no(o){function n(t=0,i=0){let e=new o(2);return t!==void 0&&(e[0]=t,i!==void 0&&(e[1]=i)),e}let v=n;function y(t,i,e){let s=e??new o(2);return s[0]=t,s[1]=i,s}function B(t,i){let e=i??new o(2);return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function S(t,i){let e=i??new o(2);return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function U(t,i){let e=i??new o(2);return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function A(t,i=0,e=1,s){let f=s??new o(2);return f[0]=Math.min(e,Math.max(i,t[0])),f[1]=Math.min(e,Math.max(i,t[1])),f}function L(t,i,e){let s=e??new o(2);return s[0]=t[0]+i[0],s[1]=t[1]+i[1],s}function F(t,i,e,s){let f=s??new o(2);return f[0]=t[0]+i[0]*e,f[1]=t[1]+i[1]*e,f}function I(t,i){let e=t[0],s=t[1],f=i[0],g=i[1],b=Math.sqrt(e*e+s*s),r=Math.sqrt(f*f+g*g),u=b*r,p=u&&Gt(t,i)/u;return Math.acos(p)}function W(t,i,e){let s=e??new o(2);return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s}let ot=W;function tt(t,i){return Math.abs(t[0]-i[0])<it&&Math.abs(t[1]-i[1])<it}function nt(t,i){return t[0]===i[0]&&t[1]===i[1]}function X(t,i,e,s){let f=s??new o(2);return f[0]=t[0]+e*(i[0]-t[0]),f[1]=t[1]+e*(i[1]-t[1]),f}function ft(t,i,e,s){let f=s??new o(2);return f[0]=t[0]+e[0]*(i[0]-t[0]),f[1]=t[1]+e[1]*(i[1]-t[1]),f}function st(t,i,e){let s=e??new o(2);return s[0]=Math.max(t[0],i[0]),s[1]=Math.max(t[1],i[1]),s}function lt(t,i,e){let s=e??new o(2);return s[0]=Math.min(t[0],i[0]),s[1]=Math.min(t[1],i[1]),s}function dt(t,i,e){let s=e??new o(2);return s[0]=t[0]*i,s[1]=t[1]*i,s}let Bt=dt;function Mt(t,i,e){let s=e??new o(2);return s[0]=t[0]/i,s[1]=t[1]/i,s}function Dt(t,i){let e=i??new o(2);return e[0]=1/t[0],e[1]=1/t[1],e}let zt=Dt;function Pt(t,i,e){let s=e??new o(3),f=t[0]*i[1]-t[1]*i[0];return s[0]=0,s[1]=0,s[2]=f,s}function Gt(t,i){return t[0]*i[0]+t[1]*i[1]}function pt(t){let i=t[0],e=t[1];return Math.sqrt(i*i+e*e)}let Et=pt;function J(t){let i=t[0],e=t[1];return i*i+e*e}let et=J;function Q(t,i){let e=t[0]-i[0],s=t[1]-i[1];return Math.sqrt(e*e+s*s)}let d=Q;function z(t,i){let e=t[0]-i[0],s=t[1]-i[1];return e*e+s*s}let m=z;function _(t,i){let e=i??new o(2),s=t[0],f=t[1],g=Math.sqrt(s*s+f*f);return g>1e-5?(e[0]=s/g,e[1]=f/g):(e[0]=0,e[1]=0),e}function V(t,i){let e=i??new o(2);return e[0]=-t[0],e[1]=-t[1],e}function E(t,i){let e=i??new o(2);return e[0]=t[0],e[1]=t[1],e}let H=E;function j(t,i,e){let s=e??new o(2);return s[0]=t[0]*i[0],s[1]=t[1]*i[1],s}let k=j;function N(t,i,e){let s=e??new o(2);return s[0]=t[0]/i[0],s[1]=t[1]/i[1],s}let $=N;function C(t=1,i){let e=i??new o(2),s=Math.random()*2*Math.PI;return e[0]=Math.cos(s)*t,e[1]=Math.sin(s)*t,e}function x(t){let i=t??new o(2);return i[0]=0,i[1]=0,i}function P(t,i,e){let s=e??new o(2),f=t[0],g=t[1];return s[0]=f*i[0]+g*i[4]+i[12],s[1]=f*i[1]+g*i[5]+i[13],s}function c(t,i,e){let s=e??new o(2),f=t[0],g=t[1];return s[0]=i[0]*f+i[4]*g+i[8],s[1]=i[1]*f+i[5]*g+i[9],s}function a(t,i,e,s){let f=s??new o(2),g=t[0]-i[0],b=t[1]-i[1],r=Math.sin(e),u=Math.cos(e);return f[0]=g*u-b*r+i[0],f[1]=g*r+b*u+i[1],f}function l(t,i,e){let s=e??new o(2);return _(t,s),dt(s,i,s)}function h(t,i,e){let s=e??new o(2);return pt(t)>i?l(t,i,s):E(t,s)}function G(t,i,e){let s=e??new o(2);return X(t,i,.5,s)}return{create:n,fromValues:v,set:y,ceil:B,floor:S,round:U,clamp:A,add:L,addScaled:F,angle:I,subtract:W,sub:ot,equalsApproximately:tt,equals:nt,lerp:X,lerpV:ft,max:st,min:lt,mulScalar:dt,scale:Bt,divScalar:Mt,inverse:Dt,invert:zt,cross:Pt,dot:Gt,length:pt,len:Et,lengthSq:J,lenSq:et,distance:Q,dist:d,distanceSq:z,distSq:m,normalize:_,negate:V,copy:E,clone:H,multiply:j,mul:k,divide:N,div:$,random:C,zero:x,transformMat4:P,transformMat3:c,rotate:a,setLength:l,truncate:h,midpoint:G}}var Ye=new Map;function Qe(o){let n=Ye.get(o);return n||(n=no(o),Ye.set(o,n)),n}function oo(o){let n=Qe(o);function v(d,z,m,_,V,E,H,j,k){let N=new o(12);return N[3]=0,N[7]=0,N[11]=0,d!==void 0&&(N[0]=d,z!==void 0&&(N[1]=z,m!==void 0&&(N[2]=m,_!==void 0&&(N[4]=_,V!==void 0&&(N[5]=V,E!==void 0&&(N[6]=E,H!==void 0&&(N[8]=H,j!==void 0&&(N[9]=j,k!==void 0&&(N[10]=k))))))))),N}function y(d,z,m,_,V,E,H,j,k,N){let $=N??new o(12);return $[0]=d,$[1]=z,$[2]=m,$[3]=0,$[4]=_,$[5]=V,$[6]=E,$[7]=0,$[8]=H,$[9]=j,$[10]=k,$[11]=0,$}function B(d,z){let m=z??new o(12);return m[0]=d[0],m[1]=d[1],m[2]=d[2],m[3]=0,m[4]=d[4],m[5]=d[5],m[6]=d[6],m[7]=0,m[8]=d[8],m[9]=d[9],m[10]=d[10],m[11]=0,m}function S(d,z){let m=z??new o(12),_=d[0],V=d[1],E=d[2],H=d[3],j=_+_,k=V+V,N=E+E,$=_*j,C=V*j,x=V*k,P=E*j,c=E*k,a=E*N,l=H*j,h=H*k,G=H*N;return m[0]=1-x-a,m[1]=C+G,m[2]=P-h,m[3]=0,m[4]=C-G,m[5]=1-$-a,m[6]=c+l,m[7]=0,m[8]=P+h,m[9]=c-l,m[10]=1-$-x,m[11]=0,m}function U(d,z){let m=z??new o(12);return m[0]=-d[0],m[1]=-d[1],m[2]=-d[2],m[4]=-d[4],m[5]=-d[5],m[6]=-d[6],m[8]=-d[8],m[9]=-d[9],m[10]=-d[10],m}function A(d,z){let m=z??new o(12);return m[0]=d[0],m[1]=d[1],m[2]=d[2],m[4]=d[4],m[5]=d[5],m[6]=d[6],m[8]=d[8],m[9]=d[9],m[10]=d[10],m}let L=A;function F(d,z){return Math.abs(d[0]-z[0])<it&&Math.abs(d[1]-z[1])<it&&Math.abs(d[2]-z[2])<it&&Math.abs(d[4]-z[4])<it&&Math.abs(d[5]-z[5])<it&&Math.abs(d[6]-z[6])<it&&Math.abs(d[8]-z[8])<it&&Math.abs(d[9]-z[9])<it&&Math.abs(d[10]-z[10])<it}function I(d,z){return d[0]===z[0]&&d[1]===z[1]&&d[2]===z[2]&&d[4]===z[4]&&d[5]===z[5]&&d[6]===z[6]&&d[8]===z[8]&&d[9]===z[9]&&d[10]===z[10]}function W(d){let z=d??new o(12);return z[0]=1,z[1]=0,z[2]=0,z[4]=0,z[5]=1,z[6]=0,z[8]=0,z[9]=0,z[10]=1,z}function ot(d,z){let m=z??new o(12);if(m===d){let x;return x=d[1],d[1]=d[4],d[4]=x,x=d[2],d[2]=d[8],d[8]=x,x=d[6],d[6]=d[9],d[9]=x,m}let _=d[0*4+0],V=d[0*4+1],E=d[0*4+2],H=d[1*4+0],j=d[1*4+1],k=d[1*4+2],N=d[2*4+0],$=d[2*4+1],C=d[2*4+2];return m[0]=_,m[1]=H,m[2]=N,m[4]=V,m[5]=j,m[6]=$,m[8]=E,m[9]=k,m[10]=C,m}function tt(d,z){let m=z??new o(12),_=d[0*4+0],V=d[0*4+1],E=d[0*4+2],H=d[1*4+0],j=d[1*4+1],k=d[1*4+2],N=d[2*4+0],$=d[2*4+1],C=d[2*4+2],x=C*j-k*$,P=-C*H+k*N,c=$*H-j*N,a=1/(_*x+V*P+E*c);return m[0]=x*a,m[1]=(-C*V+E*$)*a,m[2]=(k*V-E*j)*a,m[4]=P*a,m[5]=(C*_-E*N)*a,m[6]=(-k*_+E*H)*a,m[8]=c*a,m[9]=(-$*_+V*N)*a,m[10]=(j*_-V*H)*a,m}function nt(d){let z=d[0],m=d[0*4+1],_=d[0*4+2],V=d[1*4+0],E=d[1*4+1],H=d[1*4+2],j=d[2*4+0],k=d[2*4+1],N=d[2*4+2];return z*(E*N-k*H)-V*(m*N-k*_)+j*(m*H-E*_)}let X=tt;function ft(d,z,m){let _=m??new o(12),V=d[0],E=d[1],H=d[2],j=d[4],k=d[5],N=d[6],$=d[8],C=d[9],x=d[10],P=z[0],c=z[1],a=z[2],l=z[4],h=z[5],G=z[6],t=z[8],i=z[9],e=z[10];return _[0]=V*P+j*c+$*a,_[1]=E*P+k*c+C*a,_[2]=H*P+N*c+x*a,_[4]=V*l+j*h+$*G,_[5]=E*l+k*h+C*G,_[6]=H*l+N*h+x*G,_[8]=V*t+j*i+$*e,_[9]=E*t+k*i+C*e,_[10]=H*t+N*i+x*e,_}let st=ft;function lt(d,z,m){let _=m??W();return d!==_&&(_[0]=d[0],_[1]=d[1],_[2]=d[2],_[4]=d[4],_[5]=d[5],_[6]=d[6]),_[8]=z[0],_[9]=z[1],_[10]=1,_}function dt(d,z){let m=z??n.create();return m[0]=d[8],m[1]=d[9],m}function Bt(d,z,m){let _=m??n.create(),V=z*4;return _[0]=d[V+0],_[1]=d[V+1],_}function Mt(d,z,m,_){let V=_===d?d:A(d,_),E=m*4;return V[E+0]=z[0],V[E+1]=z[1],V}function Dt(d,z){let m=z??n.create(),_=d[0],V=d[1],E=d[4],H=d[5];return m[0]=Math.sqrt(_*_+V*V),m[1]=Math.sqrt(E*E+H*H),m}function zt(d,z){let m=z??new o(12);return m[0]=1,m[1]=0,m[2]=0,m[4]=0,m[5]=1,m[6]=0,m[8]=d[0],m[9]=d[1],m[10]=1,m}function Pt(d,z,m){let _=m??new o(12),V=z[0],E=z[1],H=d[0],j=d[1],k=d[2],N=d[1*4+0],$=d[1*4+1],C=d[1*4+2],x=d[2*4+0],P=d[2*4+1],c=d[2*4+2];return d!==_&&(_[0]=H,_[1]=j,_[2]=k,_[4]=N,_[5]=$,_[6]=C),_[8]=H*V+N*E+x,_[9]=j*V+$*E+P,_[10]=k*V+C*E+c,_}function Gt(d,z){let m=z??new o(12),_=Math.cos(d),V=Math.sin(d);return m[0]=_,m[1]=V,m[2]=0,m[4]=-V,m[5]=_,m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function pt(d,z,m){let _=m??new o(12),V=d[0*4+0],E=d[0*4+1],H=d[0*4+2],j=d[1*4+0],k=d[1*4+1],N=d[1*4+2],$=Math.cos(z),C=Math.sin(z);return _[0]=$*V+C*j,_[1]=$*E+C*k,_[2]=$*H+C*N,_[4]=$*j-C*V,_[5]=$*k-C*E,_[6]=$*N-C*H,d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}function Et(d,z){let m=z??new o(12);return m[0]=d[0],m[1]=0,m[2]=0,m[4]=0,m[5]=d[1],m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function J(d,z,m){let _=m??new o(12),V=z[0],E=z[1];return _[0]=V*d[0*4+0],_[1]=V*d[0*4+1],_[2]=V*d[0*4+2],_[4]=E*d[1*4+0],_[5]=E*d[1*4+1],_[6]=E*d[1*4+2],d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}function et(d,z){let m=z??new o(12);return m[0]=d,m[1]=0,m[2]=0,m[4]=0,m[5]=d,m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function Q(d,z,m){let _=m??new o(12);return _[0]=z*d[0*4+0],_[1]=z*d[0*4+1],_[2]=z*d[0*4+2],_[4]=z*d[1*4+0],_[5]=z*d[1*4+1],_[6]=z*d[1*4+2],d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}return{clone:L,create:v,set:y,fromMat4:B,fromQuat:S,negate:U,copy:A,equalsApproximately:F,equals:I,identity:W,transpose:ot,inverse:tt,invert:X,determinant:nt,mul:st,multiply:ft,setTranslation:lt,getTranslation:dt,getAxis:Bt,setAxis:Mt,getScaling:Dt,translation:zt,translate:Pt,rotation:Gt,rotate:pt,scaling:Et,scale:J,uniformScaling:et,uniformScale:Q}}var Xe=new Map;function so(o){let n=Xe.get(o);return n||(n=oo(o),Xe.set(o,n)),n}function ro(o){function n(r,u,p){let w=new o(3);return r!==void 0&&(w[0]=r,u!==void 0&&(w[1]=u,p!==void 0&&(w[2]=p))),w}let v=n;function y(r,u,p,w){let M=w??new o(3);return M[0]=r,M[1]=u,M[2]=p,M}function B(r,u){let p=u??new o(3);return p[0]=Math.ceil(r[0]),p[1]=Math.ceil(r[1]),p[2]=Math.ceil(r[2]),p}function S(r,u){let p=u??new o(3);return p[0]=Math.floor(r[0]),p[1]=Math.floor(r[1]),p[2]=Math.floor(r[2]),p}function U(r,u){let p=u??new o(3);return p[0]=Math.round(r[0]),p[1]=Math.round(r[1]),p[2]=Math.round(r[2]),p}function A(r,u=0,p=1,w){let M=w??new o(3);return M[0]=Math.min(p,Math.max(u,r[0])),M[1]=Math.min(p,Math.max(u,r[1])),M[2]=Math.min(p,Math.max(u,r[2])),M}function L(r,u,p){let w=p??new o(3);return w[0]=r[0]+u[0],w[1]=r[1]+u[1],w[2]=r[2]+u[2],w}function F(r,u,p,w){let M=w??new o(3);return M[0]=r[0]+u[0]*p,M[1]=r[1]+u[1]*p,M[2]=r[2]+u[2]*p,M}function I(r,u){let p=r[0],w=r[1],M=r[2],D=u[0],T=u[1],q=u[2],Y=Math.sqrt(p*p+w*w+M*M),R=Math.sqrt(D*D+T*T+q*q),O=Y*R,Z=O&&Gt(r,u)/O;return Math.acos(Z)}function W(r,u,p){let w=p??new o(3);return w[0]=r[0]-u[0],w[1]=r[1]-u[1],w[2]=r[2]-u[2],w}let ot=W;function tt(r,u){return Math.abs(r[0]-u[0])<it&&Math.abs(r[1]-u[1])<it&&Math.abs(r[2]-u[2])<it}function nt(r,u){return r[0]===u[0]&&r[1]===u[1]&&r[2]===u[2]}function X(r,u,p,w){let M=w??new o(3);return M[0]=r[0]+p*(u[0]-r[0]),M[1]=r[1]+p*(u[1]-r[1]),M[2]=r[2]+p*(u[2]-r[2]),M}function ft(r,u,p,w){let M=w??new o(3);return M[0]=r[0]+p[0]*(u[0]-r[0]),M[1]=r[1]+p[1]*(u[1]-r[1]),M[2]=r[2]+p[2]*(u[2]-r[2]),M}function st(r,u,p){let w=p??new o(3);return w[0]=Math.max(r[0],u[0]),w[1]=Math.max(r[1],u[1]),w[2]=Math.max(r[2],u[2]),w}function lt(r,u,p){let w=p??new o(3);return w[0]=Math.min(r[0],u[0]),w[1]=Math.min(r[1],u[1]),w[2]=Math.min(r[2],u[2]),w}function dt(r,u,p){let w=p??new o(3);return w[0]=r[0]*u,w[1]=r[1]*u,w[2]=r[2]*u,w}let Bt=dt;function Mt(r,u,p){let w=p??new o(3);return w[0]=r[0]/u,w[1]=r[1]/u,w[2]=r[2]/u,w}function Dt(r,u){let p=u??new o(3);return p[0]=1/r[0],p[1]=1/r[1],p[2]=1/r[2],p}let zt=Dt;function Pt(r,u,p){let w=p??new o(3),M=r[2]*u[0]-r[0]*u[2],D=r[0]*u[1]-r[1]*u[0];return w[0]=r[1]*u[2]-r[2]*u[1],w[1]=M,w[2]=D,w}function Gt(r,u){return r[0]*u[0]+r[1]*u[1]+r[2]*u[2]}function pt(r){let u=r[0],p=r[1],w=r[2];return Math.sqrt(u*u+p*p+w*w)}let Et=pt;function J(r){let u=r[0],p=r[1],w=r[2];return u*u+p*p+w*w}let et=J;function Q(r,u){let p=r[0]-u[0],w=r[1]-u[1],M=r[2]-u[2];return Math.sqrt(p*p+w*w+M*M)}let d=Q;function z(r,u){let p=r[0]-u[0],w=r[1]-u[1],M=r[2]-u[2];return p*p+w*w+M*M}let m=z;function _(r,u){let p=u??new o(3),w=r[0],M=r[1],D=r[2],T=Math.sqrt(w*w+M*M+D*D);return T>1e-5?(p[0]=w/T,p[1]=M/T,p[2]=D/T):(p[0]=0,p[1]=0,p[2]=0),p}function V(r,u){let p=u??new o(3);return p[0]=-r[0],p[1]=-r[1],p[2]=-r[2],p}function E(r,u){let p=u??new o(3);return p[0]=r[0],p[1]=r[1],p[2]=r[2],p}let H=E;function j(r,u,p){let w=p??new o(3);return w[0]=r[0]*u[0],w[1]=r[1]*u[1],w[2]=r[2]*u[2],w}let k=j;function N(r,u,p){let w=p??new o(3);return w[0]=r[0]/u[0],w[1]=r[1]/u[1],w[2]=r[2]/u[2],w}let $=N;function C(r=1,u){let p=u??new o(3),w=Math.random()*2*Math.PI,M=Math.random()*2-1,D=Math.sqrt(1-M*M)*r;return p[0]=Math.cos(w)*D,p[1]=Math.sin(w)*D,p[2]=M*r,p}function x(r){let u=r??new o(3);return u[0]=0,u[1]=0,u[2]=0,u}function P(r,u,p){let w=p??new o(3),M=r[0],D=r[1],T=r[2],q=u[3]*M+u[7]*D+u[11]*T+u[15]||1;return w[0]=(u[0]*M+u[4]*D+u[8]*T+u[12])/q,w[1]=(u[1]*M+u[5]*D+u[9]*T+u[13])/q,w[2]=(u[2]*M+u[6]*D+u[10]*T+u[14])/q,w}function c(r,u,p){let w=p??new o(3),M=r[0],D=r[1],T=r[2];return w[0]=M*u[0*4+0]+D*u[1*4+0]+T*u[2*4+0],w[1]=M*u[0*4+1]+D*u[1*4+1]+T*u[2*4+1],w[2]=M*u[0*4+2]+D*u[1*4+2]+T*u[2*4+2],w}function a(r,u,p){let w=p??new o(3),M=r[0],D=r[1],T=r[2];return w[0]=M*u[0]+D*u[4]+T*u[8],w[1]=M*u[1]+D*u[5]+T*u[9],w[2]=M*u[2]+D*u[6]+T*u[10],w}function l(r,u,p){let w=p??new o(3),M=u[0],D=u[1],T=u[2],q=u[3]*2,Y=r[0],R=r[1],O=r[2],Z=D*O-T*R,K=T*Y-M*O,rt=M*R-D*Y;return w[0]=Y+Z*q+(D*rt-T*K)*2,w[1]=R+K*q+(T*Z-M*rt)*2,w[2]=O+rt*q+(M*K-D*Z)*2,w}function h(r,u){let p=u??new o(3);return p[0]=r[12],p[1]=r[13],p[2]=r[14],p}function G(r,u,p){let w=p??new o(3),M=u*4;return w[0]=r[M+0],w[1]=r[M+1],w[2]=r[M+2],w}function t(r,u){let p=u??new o(3),w=r[0],M=r[1],D=r[2],T=r[4],q=r[5],Y=r[6],R=r[8],O=r[9],Z=r[10];return p[0]=Math.sqrt(w*w+M*M+D*D),p[1]=Math.sqrt(T*T+q*q+Y*Y),p[2]=Math.sqrt(R*R+O*O+Z*Z),p}function i(r,u,p,w){let M=w??new o(3),D=[],T=[];return D[0]=r[0]-u[0],D[1]=r[1]-u[1],D[2]=r[2]-u[2],T[0]=D[0],T[1]=D[1]*Math.cos(p)-D[2]*Math.sin(p),T[2]=D[1]*Math.sin(p)+D[2]*Math.cos(p),M[0]=T[0]+u[0],M[1]=T[1]+u[1],M[2]=T[2]+u[2],M}function e(r,u,p,w){let M=w??new o(3),D=[],T=[];return D[0]=r[0]-u[0],D[1]=r[1]-u[1],D[2]=r[2]-u[2],T[0]=D[2]*Math.sin(p)+D[0]*Math.cos(p),T[1]=D[1],T[2]=D[2]*Math.cos(p)-D[0]*Math.sin(p),M[0]=T[0]+u[0],M[1]=T[1]+u[1],M[2]=T[2]+u[2],M}function s(r,u,p,w){let M=w??new o(3),D=[],T=[];return D[0]=r[0]-u[0],D[1]=r[1]-u[1],D[2]=r[2]-u[2],T[0]=D[0]*Math.cos(p)-D[1]*Math.sin(p),T[1]=D[0]*Math.sin(p)+D[1]*Math.cos(p),T[2]=D[2],M[0]=T[0]+u[0],M[1]=T[1]+u[1],M[2]=T[2]+u[2],M}function f(r,u,p){let w=p??new o(3);return _(r,w),dt(w,u,w)}function g(r,u,p){let w=p??new o(3);return pt(r)>u?f(r,u,w):E(r,w)}function b(r,u,p){let w=p??new o(3);return X(r,u,.5,w)}return{create:n,fromValues:v,set:y,ceil:B,floor:S,round:U,clamp:A,add:L,addScaled:F,angle:I,subtract:W,sub:ot,equalsApproximately:tt,equals:nt,lerp:X,lerpV:ft,max:st,min:lt,mulScalar:dt,scale:Bt,divScalar:Mt,inverse:Dt,invert:zt,cross:Pt,dot:Gt,length:pt,len:Et,lengthSq:J,lenSq:et,distance:Q,dist:d,distanceSq:z,distSq:m,normalize:_,negate:V,copy:E,clone:H,multiply:j,mul:k,divide:N,div:$,random:C,zero:x,transformMat4:P,transformMat4Upper3x3:c,transformMat3:a,transformQuat:l,getTranslation:h,getAxis:G,getScaling:t,rotateX:i,rotateY:e,rotateZ:s,setLength:f,truncate:g,midpoint:b}}var He=new Map;function me(o){let n=He.get(o);return n||(n=ro(o),He.set(o,n)),n}function io(o){let n=me(o);function v(t,i,e,s,f,g,b,r,u,p,w,M,D,T,q,Y){let R=new o(16);return t!==void 0&&(R[0]=t,i!==void 0&&(R[1]=i,e!==void 0&&(R[2]=e,s!==void 0&&(R[3]=s,f!==void 0&&(R[4]=f,g!==void 0&&(R[5]=g,b!==void 0&&(R[6]=b,r!==void 0&&(R[7]=r,u!==void 0&&(R[8]=u,p!==void 0&&(R[9]=p,w!==void 0&&(R[10]=w,M!==void 0&&(R[11]=M,D!==void 0&&(R[12]=D,T!==void 0&&(R[13]=T,q!==void 0&&(R[14]=q,Y!==void 0&&(R[15]=Y)))))))))))))))),R}function y(t,i,e,s,f,g,b,r,u,p,w,M,D,T,q,Y,R){let O=R??new o(16);return O[0]=t,O[1]=i,O[2]=e,O[3]=s,O[4]=f,O[5]=g,O[6]=b,O[7]=r,O[8]=u,O[9]=p,O[10]=w,O[11]=M,O[12]=D,O[13]=T,O[14]=q,O[15]=Y,O}function B(t,i){let e=i??new o(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function S(t,i){let e=i??new o(16),s=t[0],f=t[1],g=t[2],b=t[3],r=s+s,u=f+f,p=g+g,w=s*r,M=f*r,D=f*u,T=g*r,q=g*u,Y=g*p,R=b*r,O=b*u,Z=b*p;return e[0]=1-D-Y,e[1]=M+Z,e[2]=T-O,e[3]=0,e[4]=M-Z,e[5]=1-w-Y,e[6]=q+R,e[7]=0,e[8]=T+O,e[9]=q-R,e[10]=1-w-D,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function U(t,i){let e=i??new o(16);return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function A(t,i){let e=i??new o(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}let L=A;function F(t,i){return Math.abs(t[0]-i[0])<it&&Math.abs(t[1]-i[1])<it&&Math.abs(t[2]-i[2])<it&&Math.abs(t[3]-i[3])<it&&Math.abs(t[4]-i[4])<it&&Math.abs(t[5]-i[5])<it&&Math.abs(t[6]-i[6])<it&&Math.abs(t[7]-i[7])<it&&Math.abs(t[8]-i[8])<it&&Math.abs(t[9]-i[9])<it&&Math.abs(t[10]-i[10])<it&&Math.abs(t[11]-i[11])<it&&Math.abs(t[12]-i[12])<it&&Math.abs(t[13]-i[13])<it&&Math.abs(t[14]-i[14])<it&&Math.abs(t[15]-i[15])<it}function I(t,i){return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]&&t[9]===i[9]&&t[10]===i[10]&&t[11]===i[11]&&t[12]===i[12]&&t[13]===i[13]&&t[14]===i[14]&&t[15]===i[15]}function W(t){let i=t??new o(16);return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function ot(t,i){let e=i??new o(16);if(e===t){let K;return K=t[1],t[1]=t[4],t[4]=K,K=t[2],t[2]=t[8],t[8]=K,K=t[3],t[3]=t[12],t[12]=K,K=t[6],t[6]=t[9],t[9]=K,K=t[7],t[7]=t[13],t[13]=K,K=t[11],t[11]=t[14],t[14]=K,e}let s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],b=t[0*4+3],r=t[1*4+0],u=t[1*4+1],p=t[1*4+2],w=t[1*4+3],M=t[2*4+0],D=t[2*4+1],T=t[2*4+2],q=t[2*4+3],Y=t[3*4+0],R=t[3*4+1],O=t[3*4+2],Z=t[3*4+3];return e[0]=s,e[1]=r,e[2]=M,e[3]=Y,e[4]=f,e[5]=u,e[6]=D,e[7]=R,e[8]=g,e[9]=p,e[10]=T,e[11]=O,e[12]=b,e[13]=w,e[14]=q,e[15]=Z,e}function tt(t,i){let e=i??new o(16),s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],b=t[0*4+3],r=t[1*4+0],u=t[1*4+1],p=t[1*4+2],w=t[1*4+3],M=t[2*4+0],D=t[2*4+1],T=t[2*4+2],q=t[2*4+3],Y=t[3*4+0],R=t[3*4+1],O=t[3*4+2],Z=t[3*4+3],K=T*Z,rt=O*q,at=p*Z,ut=O*w,wt=p*q,ht=T*w,gt=g*Z,xt=O*b,vt=g*q,mt=T*b,bt=g*w,St=p*b,Tt=M*R,_t=Y*D,Ut=r*R,It=Y*u,Lt=r*D,Yt=M*u,Xt=s*R,Ht=Y*f,jt=s*D,Wt=M*f,Zt=s*u,Qt=r*f,Ct=K*u+ut*D+wt*R-(rt*u+at*D+ht*R),te=rt*f+gt*D+mt*R-(K*f+xt*D+vt*R),ee=at*f+xt*u+bt*R-(ut*f+gt*u+St*R),ne=ht*f+vt*u+St*D-(wt*f+mt*u+bt*D),yt=1/(s*Ct+r*te+M*ee+Y*ne);return e[0]=yt*Ct,e[1]=yt*te,e[2]=yt*ee,e[3]=yt*ne,e[4]=yt*(rt*r+at*M+ht*Y-(K*r+ut*M+wt*Y)),e[5]=yt*(K*s+xt*M+vt*Y-(rt*s+gt*M+mt*Y)),e[6]=yt*(ut*s+gt*r+St*Y-(at*s+xt*r+bt*Y)),e[7]=yt*(wt*s+mt*r+bt*M-(ht*s+vt*r+St*M)),e[8]=yt*(Tt*w+It*q+Lt*Z-(_t*w+Ut*q+Yt*Z)),e[9]=yt*(_t*b+Xt*q+Wt*Z-(Tt*b+Ht*q+jt*Z)),e[10]=yt*(Ut*b+Ht*w+Zt*Z-(It*b+Xt*w+Qt*Z)),e[11]=yt*(Yt*b+jt*w+Qt*q-(Lt*b+Wt*w+Zt*q)),e[12]=yt*(Ut*T+Yt*O+_t*p-(Lt*O+Tt*p+It*T)),e[13]=yt*(jt*O+Tt*g+Ht*T-(Xt*T+Wt*O+_t*g)),e[14]=yt*(Xt*p+Qt*O+It*g-(Zt*O+Ut*g+Ht*p)),e[15]=yt*(Zt*T+Lt*g+Wt*p-(jt*p+Qt*T+Yt*g)),e}function nt(t){let i=t[0],e=t[0*4+1],s=t[0*4+2],f=t[0*4+3],g=t[1*4+0],b=t[1*4+1],r=t[1*4+2],u=t[1*4+3],p=t[2*4+0],w=t[2*4+1],M=t[2*4+2],D=t[2*4+3],T=t[3*4+0],q=t[3*4+1],Y=t[3*4+2],R=t[3*4+3],O=M*R,Z=Y*D,K=r*R,rt=Y*u,at=r*D,ut=M*u,wt=s*R,ht=Y*f,gt=s*D,xt=M*f,vt=s*u,mt=r*f,bt=O*b+rt*w+at*q-(Z*b+K*w+ut*q),St=Z*e+wt*w+xt*q-(O*e+ht*w+gt*q),Tt=K*e+ht*b+vt*q-(rt*e+wt*b+mt*q),_t=ut*e+gt*b+mt*w-(at*e+xt*b+vt*w);return i*bt+g*St+p*Tt+T*_t}let X=tt;function ft(t,i,e){let s=e??new o(16),f=t[0],g=t[1],b=t[2],r=t[3],u=t[4],p=t[5],w=t[6],M=t[7],D=t[8],T=t[9],q=t[10],Y=t[11],R=t[12],O=t[13],Z=t[14],K=t[15],rt=i[0],at=i[1],ut=i[2],wt=i[3],ht=i[4],gt=i[5],xt=i[6],vt=i[7],mt=i[8],bt=i[9],St=i[10],Tt=i[11],_t=i[12],Ut=i[13],It=i[14],Lt=i[15];return s[0]=f*rt+u*at+D*ut+R*wt,s[1]=g*rt+p*at+T*ut+O*wt,s[2]=b*rt+w*at+q*ut+Z*wt,s[3]=r*rt+M*at+Y*ut+K*wt,s[4]=f*ht+u*gt+D*xt+R*vt,s[5]=g*ht+p*gt+T*xt+O*vt,s[6]=b*ht+w*gt+q*xt+Z*vt,s[7]=r*ht+M*gt+Y*xt+K*vt,s[8]=f*mt+u*bt+D*St+R*Tt,s[9]=g*mt+p*bt+T*St+O*Tt,s[10]=b*mt+w*bt+q*St+Z*Tt,s[11]=r*mt+M*bt+Y*St+K*Tt,s[12]=f*_t+u*Ut+D*It+R*Lt,s[13]=g*_t+p*Ut+T*It+O*Lt,s[14]=b*_t+w*Ut+q*It+Z*Lt,s[15]=r*_t+M*Ut+Y*It+K*Lt,s}let st=ft;function lt(t,i,e){let s=e??W();return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11]),s[12]=i[0],s[13]=i[1],s[14]=i[2],s[15]=1,s}function dt(t,i){let e=i??n.create();return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Bt(t,i,e){let s=e??n.create(),f=i*4;return s[0]=t[f+0],s[1]=t[f+1],s[2]=t[f+2],s}function Mt(t,i,e,s){let f=s===t?s:A(t,s),g=e*4;return f[g+0]=i[0],f[g+1]=i[1],f[g+2]=i[2],f}function Dt(t,i){let e=i??n.create(),s=t[0],f=t[1],g=t[2],b=t[4],r=t[5],u=t[6],p=t[8],w=t[9],M=t[10];return e[0]=Math.sqrt(s*s+f*f+g*g),e[1]=Math.sqrt(b*b+r*r+u*u),e[2]=Math.sqrt(p*p+w*w+M*M),e}function zt(t,i,e,s,f){let g=f??new o(16),b=Math.tan(Math.PI*.5-.5*t);if(g[0]=b/i,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=b,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(s)){let r=1/(e-s);g[10]=s*r,g[14]=s*e*r}else g[10]=-1,g[14]=-e;return g}function Pt(t,i,e,s=1/0,f){let g=f??new o(16),b=1/Math.tan(t*.5);if(g[0]=b/i,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=b,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,s===1/0)g[10]=0,g[14]=e;else{let r=1/(s-e);g[10]=e*r,g[14]=s*e*r}return g}function Gt(t,i,e,s,f,g,b){let r=b??new o(16);return r[0]=2/(i-t),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(s-e),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1/(f-g),r[11]=0,r[12]=(i+t)/(t-i),r[13]=(s+e)/(e-s),r[14]=f/(f-g),r[15]=1,r}function pt(t,i,e,s,f,g,b){let r=b??new o(16),u=i-t,p=s-e,w=f-g;return r[0]=2*f/u,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2*f/p,r[6]=0,r[7]=0,r[8]=(t+i)/u,r[9]=(s+e)/p,r[10]=g/w,r[11]=-1,r[12]=0,r[13]=0,r[14]=f*g/w,r[15]=0,r}function Et(t,i,e,s,f,g=1/0,b){let r=b??new o(16),u=i-t,p=s-e;if(r[0]=2*f/u,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2*f/p,r[6]=0,r[7]=0,r[8]=(t+i)/u,r[9]=(s+e)/p,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,g===1/0)r[10]=0,r[14]=f;else{let w=1/(g-f);r[10]=f*w,r[14]=g*f*w}return r}let J=n.create(),et=n.create(),Q=n.create();function d(t,i,e,s){let f=s??new o(16);return n.normalize(n.subtract(i,t,Q),Q),n.normalize(n.cross(e,Q,J),J),n.normalize(n.cross(Q,J,et),et),f[0]=J[0],f[1]=J[1],f[2]=J[2],f[3]=0,f[4]=et[0],f[5]=et[1],f[6]=et[2],f[7]=0,f[8]=Q[0],f[9]=Q[1],f[10]=Q[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function z(t,i,e,s){let f=s??new o(16);return n.normalize(n.subtract(t,i,Q),Q),n.normalize(n.cross(e,Q,J),J),n.normalize(n.cross(Q,J,et),et),f[0]=J[0],f[1]=J[1],f[2]=J[2],f[3]=0,f[4]=et[0],f[5]=et[1],f[6]=et[2],f[7]=0,f[8]=Q[0],f[9]=Q[1],f[10]=Q[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function m(t,i,e,s){let f=s??new o(16);return n.normalize(n.subtract(t,i,Q),Q),n.normalize(n.cross(e,Q,J),J),n.normalize(n.cross(Q,J,et),et),f[0]=J[0],f[1]=et[0],f[2]=Q[0],f[3]=0,f[4]=J[1],f[5]=et[1],f[6]=Q[1],f[7]=0,f[8]=J[2],f[9]=et[2],f[10]=Q[2],f[11]=0,f[12]=-(J[0]*t[0]+J[1]*t[1]+J[2]*t[2]),f[13]=-(et[0]*t[0]+et[1]*t[1]+et[2]*t[2]),f[14]=-(Q[0]*t[0]+Q[1]*t[1]+Q[2]*t[2]),f[15]=1,f}function _(t,i){let e=i??new o(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function V(t,i,e){let s=e??new o(16),f=i[0],g=i[1],b=i[2],r=t[0],u=t[1],p=t[2],w=t[3],M=t[1*4+0],D=t[1*4+1],T=t[1*4+2],q=t[1*4+3],Y=t[2*4+0],R=t[2*4+1],O=t[2*4+2],Z=t[2*4+3],K=t[3*4+0],rt=t[3*4+1],at=t[3*4+2],ut=t[3*4+3];return t!==s&&(s[0]=r,s[1]=u,s[2]=p,s[3]=w,s[4]=M,s[5]=D,s[6]=T,s[7]=q,s[8]=Y,s[9]=R,s[10]=O,s[11]=Z),s[12]=r*f+M*g+Y*b+K,s[13]=u*f+D*g+R*b+rt,s[14]=p*f+T*g+O*b+at,s[15]=w*f+q*g+Z*b+ut,s}function E(t,i){let e=i??new o(16),s=Math.cos(t),f=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=f,e[7]=0,e[8]=0,e[9]=-f,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function H(t,i,e){let s=e??new o(16),f=t[4],g=t[5],b=t[6],r=t[7],u=t[8],p=t[9],w=t[10],M=t[11],D=Math.cos(i),T=Math.sin(i);return s[4]=D*f+T*u,s[5]=D*g+T*p,s[6]=D*b+T*w,s[7]=D*r+T*M,s[8]=D*u-T*f,s[9]=D*p-T*g,s[10]=D*w-T*b,s[11]=D*M-T*r,t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function j(t,i){let e=i??new o(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=0,e[2]=-f,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=f,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function k(t,i,e){let s=e??new o(16),f=t[0*4+0],g=t[0*4+1],b=t[0*4+2],r=t[0*4+3],u=t[2*4+0],p=t[2*4+1],w=t[2*4+2],M=t[2*4+3],D=Math.cos(i),T=Math.sin(i);return s[0]=D*f-T*u,s[1]=D*g-T*p,s[2]=D*b-T*w,s[3]=D*r-T*M,s[8]=D*u+T*f,s[9]=D*p+T*g,s[10]=D*w+T*b,s[11]=D*M+T*r,t!==s&&(s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function N(t,i){let e=i??new o(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=f,e[2]=0,e[3]=0,e[4]=-f,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function $(t,i,e){let s=e??new o(16),f=t[0*4+0],g=t[0*4+1],b=t[0*4+2],r=t[0*4+3],u=t[1*4+0],p=t[1*4+1],w=t[1*4+2],M=t[1*4+3],D=Math.cos(i),T=Math.sin(i);return s[0]=D*f+T*u,s[1]=D*g+T*p,s[2]=D*b+T*w,s[3]=D*r+T*M,s[4]=D*u-T*f,s[5]=D*p-T*g,s[6]=D*w-T*b,s[7]=D*M-T*r,t!==s&&(s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function C(t,i,e){let s=e??new o(16),f=t[0],g=t[1],b=t[2],r=Math.sqrt(f*f+g*g+b*b);f/=r,g/=r,b/=r;let u=f*f,p=g*g,w=b*b,M=Math.cos(i),D=Math.sin(i),T=1-M;return s[0]=u+(1-u)*M,s[1]=f*g*T+b*D,s[2]=f*b*T-g*D,s[3]=0,s[4]=f*g*T-b*D,s[5]=p+(1-p)*M,s[6]=g*b*T+f*D,s[7]=0,s[8]=f*b*T+g*D,s[9]=g*b*T-f*D,s[10]=w+(1-w)*M,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}let x=C;function P(t,i,e,s){let f=s??new o(16),g=i[0],b=i[1],r=i[2],u=Math.sqrt(g*g+b*b+r*r);g/=u,b/=u,r/=u;let p=g*g,w=b*b,M=r*r,D=Math.cos(e),T=Math.sin(e),q=1-D,Y=p+(1-p)*D,R=g*b*q+r*T,O=g*r*q-b*T,Z=g*b*q-r*T,K=w+(1-w)*D,rt=b*r*q+g*T,at=g*r*q+b*T,ut=b*r*q-g*T,wt=M+(1-M)*D,ht=t[0],gt=t[1],xt=t[2],vt=t[3],mt=t[4],bt=t[5],St=t[6],Tt=t[7],_t=t[8],Ut=t[9],It=t[10],Lt=t[11];return f[0]=Y*ht+R*mt+O*_t,f[1]=Y*gt+R*bt+O*Ut,f[2]=Y*xt+R*St+O*It,f[3]=Y*vt+R*Tt+O*Lt,f[4]=Z*ht+K*mt+rt*_t,f[5]=Z*gt+K*bt+rt*Ut,f[6]=Z*xt+K*St+rt*It,f[7]=Z*vt+K*Tt+rt*Lt,f[8]=at*ht+ut*mt+wt*_t,f[9]=at*gt+ut*bt+wt*Ut,f[10]=at*xt+ut*St+wt*It,f[11]=at*vt+ut*Tt+wt*Lt,t!==f&&(f[12]=t[12],f[13]=t[13],f[14]=t[14],f[15]=t[15]),f}let c=P;function a(t,i){let e=i??new o(16);return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function l(t,i,e){let s=e??new o(16),f=i[0],g=i[1],b=i[2];return s[0]=f*t[0*4+0],s[1]=f*t[0*4+1],s[2]=f*t[0*4+2],s[3]=f*t[0*4+3],s[4]=g*t[1*4+0],s[5]=g*t[1*4+1],s[6]=g*t[1*4+2],s[7]=g*t[1*4+3],s[8]=b*t[2*4+0],s[9]=b*t[2*4+1],s[10]=b*t[2*4+2],s[11]=b*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function h(t,i){let e=i??new o(16);return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function G(t,i,e){let s=e??new o(16);return s[0]=i*t[0*4+0],s[1]=i*t[0*4+1],s[2]=i*t[0*4+2],s[3]=i*t[0*4+3],s[4]=i*t[1*4+0],s[5]=i*t[1*4+1],s[6]=i*t[1*4+2],s[7]=i*t[1*4+3],s[8]=i*t[2*4+0],s[9]=i*t[2*4+1],s[10]=i*t[2*4+2],s[11]=i*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}return{create:v,set:y,fromMat3:B,fromQuat:S,negate:U,copy:A,clone:L,equalsApproximately:F,equals:I,identity:W,transpose:ot,inverse:tt,determinant:nt,invert:X,multiply:ft,mul:st,setTranslation:lt,getTranslation:dt,getAxis:Bt,setAxis:Mt,getScaling:Dt,perspective:zt,perspectiveReverseZ:Pt,ortho:Gt,frustum:pt,frustumReverseZ:Et,aim:d,cameraAim:z,lookAt:m,translation:_,translate:V,rotationX:E,rotateX:H,rotationY:j,rotateY:k,rotationZ:N,rotateZ:$,axisRotation:C,rotation:x,axisRotate:P,rotate:c,scaling:a,scale:l,uniformScaling:h,uniformScale:G}}var je=new Map;function co(o){let n=je.get(o);return n||(n=io(o),je.set(o,n)),n}function ao(o){let n=me(o);function v(x,P,c,a){let l=new o(4);return x!==void 0&&(l[0]=x,P!==void 0&&(l[1]=P,c!==void 0&&(l[2]=c,a!==void 0&&(l[3]=a)))),l}let y=v;function B(x,P,c,a,l){let h=l??new o(4);return h[0]=x,h[1]=P,h[2]=c,h[3]=a,h}function S(x,P,c){let a=c??new o(4),l=P*.5,h=Math.sin(l);return a[0]=h*x[0],a[1]=h*x[1],a[2]=h*x[2],a[3]=Math.cos(l),a}function U(x,P){let c=P??n.create(3),a=Math.acos(x[3])*2,l=Math.sin(a*.5);return l>it?(c[0]=x[0]/l,c[1]=x[1]/l,c[2]=x[2]/l):(c[0]=1,c[1]=0,c[2]=0),{angle:a,axis:c}}function A(x,P){let c=pt(x,P);return Math.acos(2*c*c-1)}function L(x,P,c){let a=c??new o(4),l=x[0],h=x[1],G=x[2],t=x[3],i=P[0],e=P[1],s=P[2],f=P[3];return a[0]=l*f+t*i+h*s-G*e,a[1]=h*f+t*e+G*i-l*s,a[2]=G*f+t*s+l*e-h*i,a[3]=t*f-l*i-h*e-G*s,a}let F=L;function I(x,P,c){let a=c??new o(4),l=P*.5,h=x[0],G=x[1],t=x[2],i=x[3],e=Math.sin(l),s=Math.cos(l);return a[0]=h*s+i*e,a[1]=G*s+t*e,a[2]=t*s-G*e,a[3]=i*s-h*e,a}function W(x,P,c){let a=c??new o(4),l=P*.5,h=x[0],G=x[1],t=x[2],i=x[3],e=Math.sin(l),s=Math.cos(l);return a[0]=h*s-t*e,a[1]=G*s+i*e,a[2]=t*s+h*e,a[3]=i*s-G*e,a}function ot(x,P,c){let a=c??new o(4),l=P*.5,h=x[0],G=x[1],t=x[2],i=x[3],e=Math.sin(l),s=Math.cos(l);return a[0]=h*s+G*e,a[1]=G*s-h*e,a[2]=t*s+i*e,a[3]=i*s-t*e,a}function tt(x,P,c,a){let l=a??new o(4),h=x[0],G=x[1],t=x[2],i=x[3],e=P[0],s=P[1],f=P[2],g=P[3],b=h*e+G*s+t*f+i*g;b<0&&(b=-b,e=-e,s=-s,f=-f,g=-g);let r,u;if(1-b>it){let p=Math.acos(b),w=Math.sin(p);r=Math.sin((1-c)*p)/w,u=Math.sin(c*p)/w}else r=1-c,u=c;return l[0]=r*h+u*e,l[1]=r*G+u*s,l[2]=r*t+u*f,l[3]=r*i+u*g,l}function nt(x,P){let c=P??new o(4),a=x[0],l=x[1],h=x[2],G=x[3],t=a*a+l*l+h*h+G*G,i=t?1/t:0;return c[0]=-a*i,c[1]=-l*i,c[2]=-h*i,c[3]=G*i,c}function X(x,P){let c=P??new o(4);return c[0]=-x[0],c[1]=-x[1],c[2]=-x[2],c[3]=x[3],c}function ft(x,P){let c=P??new o(4),a=x[0]+x[5]+x[10];if(a>0){let l=Math.sqrt(a+1);c[3]=.5*l;let h=.5/l;c[0]=(x[6]-x[9])*h,c[1]=(x[8]-x[2])*h,c[2]=(x[1]-x[4])*h}else{let l=0;x[5]>x[0]&&(l=1),x[10]>x[l*4+l]&&(l=2);let h=(l+1)%3,G=(l+2)%3,t=Math.sqrt(x[l*4+l]-x[h*4+h]-x[G*4+G]+1);c[l]=.5*t;let i=.5/t;c[3]=(x[h*4+G]-x[G*4+h])*i,c[h]=(x[h*4+l]+x[l*4+h])*i,c[G]=(x[G*4+l]+x[l*4+G])*i}return c}function st(x,P,c,a,l){let h=l??new o(4),G=x*.5,t=P*.5,i=c*.5,e=Math.sin(G),s=Math.cos(G),f=Math.sin(t),g=Math.cos(t),b=Math.sin(i),r=Math.cos(i);switch(a){case"xyz":h[0]=e*g*r+s*f*b,h[1]=s*f*r-e*g*b,h[2]=s*g*b+e*f*r,h[3]=s*g*r-e*f*b;break;case"xzy":h[0]=e*g*r-s*f*b,h[1]=s*f*r-e*g*b,h[2]=s*g*b+e*f*r,h[3]=s*g*r+e*f*b;break;case"yxz":h[0]=e*g*r+s*f*b,h[1]=s*f*r-e*g*b,h[2]=s*g*b-e*f*r,h[3]=s*g*r+e*f*b;break;case"yzx":h[0]=e*g*r+s*f*b,h[1]=s*f*r+e*g*b,h[2]=s*g*b-e*f*r,h[3]=s*g*r-e*f*b;break;case"zxy":h[0]=e*g*r-s*f*b,h[1]=s*f*r+e*g*b,h[2]=s*g*b+e*f*r,h[3]=s*g*r-e*f*b;break;case"zyx":h[0]=e*g*r-s*f*b,h[1]=s*f*r+e*g*b,h[2]=s*g*b-e*f*r,h[3]=s*g*r+e*f*b;break;default:throw new Error(`Unknown rotation order: ${a}`)}return h}function lt(x,P){let c=P??new o(4);return c[0]=x[0],c[1]=x[1],c[2]=x[2],c[3]=x[3],c}let dt=lt;function Bt(x,P,c){let a=c??new o(4);return a[0]=x[0]+P[0],a[1]=x[1]+P[1],a[2]=x[2]+P[2],a[3]=x[3]+P[3],a}function Mt(x,P,c){let a=c??new o(4);return a[0]=x[0]-P[0],a[1]=x[1]-P[1],a[2]=x[2]-P[2],a[3]=x[3]-P[3],a}let Dt=Mt;function zt(x,P,c){let a=c??new o(4);return a[0]=x[0]*P,a[1]=x[1]*P,a[2]=x[2]*P,a[3]=x[3]*P,a}let Pt=zt;function Gt(x,P,c){let a=c??new o(4);return a[0]=x[0]/P,a[1]=x[1]/P,a[2]=x[2]/P,a[3]=x[3]/P,a}function pt(x,P){return x[0]*P[0]+x[1]*P[1]+x[2]*P[2]+x[3]*P[3]}function Et(x,P,c,a){let l=a??new o(4);return l[0]=x[0]+c*(P[0]-x[0]),l[1]=x[1]+c*(P[1]-x[1]),l[2]=x[2]+c*(P[2]-x[2]),l[3]=x[3]+c*(P[3]-x[3]),l}function J(x){let P=x[0],c=x[1],a=x[2],l=x[3];return Math.sqrt(P*P+c*c+a*a+l*l)}let et=J;function Q(x){let P=x[0],c=x[1],a=x[2],l=x[3];return P*P+c*c+a*a+l*l}let d=Q;function z(x,P){let c=P??new o(4),a=x[0],l=x[1],h=x[2],G=x[3],t=Math.sqrt(a*a+l*l+h*h+G*G);return t>1e-5?(c[0]=a/t,c[1]=l/t,c[2]=h/t,c[3]=G/t):(c[0]=0,c[1]=0,c[2]=0,c[3]=1),c}function m(x,P){return Math.abs(x[0]-P[0])<it&&Math.abs(x[1]-P[1])<it&&Math.abs(x[2]-P[2])<it&&Math.abs(x[3]-P[3])<it}function _(x,P){return x[0]===P[0]&&x[1]===P[1]&&x[2]===P[2]&&x[3]===P[3]}function V(x){let P=x??new o(4);return P[0]=0,P[1]=0,P[2]=0,P[3]=1,P}let E=n.create(),H=n.create(),j=n.create();function k(x,P,c){let a=c??new o(4),l=n.dot(x,P);return l<-.999999?(n.cross(H,x,E),n.len(E)<1e-6&&n.cross(j,x,E),n.normalize(E,E),S(E,Math.PI,a),a):l>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(n.cross(x,P,E),a[0]=E[0],a[1]=E[1],a[2]=E[2],a[3]=1+l,z(a,a))}let N=new o(4),$=new o(4);function C(x,P,c,a,l,h){let G=h??new o(4);return tt(x,a,l,N),tt(P,c,l,$),tt(N,$,2*l*(1-l),G),G}return{create:v,fromValues:y,set:B,fromAxisAngle:S,toAxisAngle:U,angle:A,multiply:L,mul:F,rotateX:I,rotateY:W,rotateZ:ot,slerp:tt,inverse:nt,conjugate:X,fromMat:ft,fromEuler:st,copy:lt,clone:dt,add:Bt,subtract:Mt,sub:Dt,mulScalar:zt,scale:Pt,divScalar:Gt,dot:pt,lerp:Et,length:J,len:et,lengthSq:Q,lenSq:d,normalize:z,equalsApproximately:m,equals:_,identity:V,rotationTo:k,sqlerp:C}}var We=new Map;function uo(o){let n=We.get(o);return n||(n=ao(o),We.set(o,n)),n}function fo(o){function n(c,a,l,h){let G=new o(4);return c!==void 0&&(G[0]=c,a!==void 0&&(G[1]=a,l!==void 0&&(G[2]=l,h!==void 0&&(G[3]=h)))),G}let v=n;function y(c,a,l,h,G){let t=G??new o(4);return t[0]=c,t[1]=a,t[2]=l,t[3]=h,t}function B(c,a){let l=a??new o(4);return l[0]=Math.ceil(c[0]),l[1]=Math.ceil(c[1]),l[2]=Math.ceil(c[2]),l[3]=Math.ceil(c[3]),l}function S(c,a){let l=a??new o(4);return l[0]=Math.floor(c[0]),l[1]=Math.floor(c[1]),l[2]=Math.floor(c[2]),l[3]=Math.floor(c[3]),l}function U(c,a){let l=a??new o(4);return l[0]=Math.round(c[0]),l[1]=Math.round(c[1]),l[2]=Math.round(c[2]),l[3]=Math.round(c[3]),l}function A(c,a=0,l=1,h){let G=h??new o(4);return G[0]=Math.min(l,Math.max(a,c[0])),G[1]=Math.min(l,Math.max(a,c[1])),G[2]=Math.min(l,Math.max(a,c[2])),G[3]=Math.min(l,Math.max(a,c[3])),G}function L(c,a,l){let h=l??new o(4);return h[0]=c[0]+a[0],h[1]=c[1]+a[1],h[2]=c[2]+a[2],h[3]=c[3]+a[3],h}function F(c,a,l,h){let G=h??new o(4);return G[0]=c[0]+a[0]*l,G[1]=c[1]+a[1]*l,G[2]=c[2]+a[2]*l,G[3]=c[3]+a[3]*l,G}function I(c,a,l){let h=l??new o(4);return h[0]=c[0]-a[0],h[1]=c[1]-a[1],h[2]=c[2]-a[2],h[3]=c[3]-a[3],h}let W=I;function ot(c,a){return Math.abs(c[0]-a[0])<it&&Math.abs(c[1]-a[1])<it&&Math.abs(c[2]-a[2])<it&&Math.abs(c[3]-a[3])<it}function tt(c,a){return c[0]===a[0]&&c[1]===a[1]&&c[2]===a[2]&&c[3]===a[3]}function nt(c,a,l,h){let G=h??new o(4);return G[0]=c[0]+l*(a[0]-c[0]),G[1]=c[1]+l*(a[1]-c[1]),G[2]=c[2]+l*(a[2]-c[2]),G[3]=c[3]+l*(a[3]-c[3]),G}function X(c,a,l,h){let G=h??new o(4);return G[0]=c[0]+l[0]*(a[0]-c[0]),G[1]=c[1]+l[1]*(a[1]-c[1]),G[2]=c[2]+l[2]*(a[2]-c[2]),G[3]=c[3]+l[3]*(a[3]-c[3]),G}function ft(c,a,l){let h=l??new o(4);return h[0]=Math.max(c[0],a[0]),h[1]=Math.max(c[1],a[1]),h[2]=Math.max(c[2],a[2]),h[3]=Math.max(c[3],a[3]),h}function st(c,a,l){let h=l??new o(4);return h[0]=Math.min(c[0],a[0]),h[1]=Math.min(c[1],a[1]),h[2]=Math.min(c[2],a[2]),h[3]=Math.min(c[3],a[3]),h}function lt(c,a,l){let h=l??new o(4);return h[0]=c[0]*a,h[1]=c[1]*a,h[2]=c[2]*a,h[3]=c[3]*a,h}let dt=lt;function Bt(c,a,l){let h=l??new o(4);return h[0]=c[0]/a,h[1]=c[1]/a,h[2]=c[2]/a,h[3]=c[3]/a,h}function Mt(c,a){let l=a??new o(4);return l[0]=1/c[0],l[1]=1/c[1],l[2]=1/c[2],l[3]=1/c[3],l}let Dt=Mt;function zt(c,a){return c[0]*a[0]+c[1]*a[1]+c[2]*a[2]+c[3]*a[3]}function Pt(c){let a=c[0],l=c[1],h=c[2],G=c[3];return Math.sqrt(a*a+l*l+h*h+G*G)}let Gt=Pt;function pt(c){let a=c[0],l=c[1],h=c[2],G=c[3];return a*a+l*l+h*h+G*G}let Et=pt;function J(c,a){let l=c[0]-a[0],h=c[1]-a[1],G=c[2]-a[2],t=c[3]-a[3];return Math.sqrt(l*l+h*h+G*G+t*t)}let et=J;function Q(c,a){let l=c[0]-a[0],h=c[1]-a[1],G=c[2]-a[2],t=c[3]-a[3];return l*l+h*h+G*G+t*t}let d=Q;function z(c,a){let l=a??new o(4),h=c[0],G=c[1],t=c[2],i=c[3],e=Math.sqrt(h*h+G*G+t*t+i*i);return e>1e-5?(l[0]=h/e,l[1]=G/e,l[2]=t/e,l[3]=i/e):(l[0]=0,l[1]=0,l[2]=0,l[3]=0),l}function m(c,a){let l=a??new o(4);return l[0]=-c[0],l[1]=-c[1],l[2]=-c[2],l[3]=-c[3],l}function _(c,a){let l=a??new o(4);return l[0]=c[0],l[1]=c[1],l[2]=c[2],l[3]=c[3],l}let V=_;function E(c,a,l){let h=l??new o(4);return h[0]=c[0]*a[0],h[1]=c[1]*a[1],h[2]=c[2]*a[2],h[3]=c[3]*a[3],h}let H=E;function j(c,a,l){let h=l??new o(4);return h[0]=c[0]/a[0],h[1]=c[1]/a[1],h[2]=c[2]/a[2],h[3]=c[3]/a[3],h}let k=j;function N(c){let a=c??new o(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a}function $(c,a,l){let h=l??new o(4),G=c[0],t=c[1],i=c[2],e=c[3];return h[0]=a[0]*G+a[4]*t+a[8]*i+a[12]*e,h[1]=a[1]*G+a[5]*t+a[9]*i+a[13]*e,h[2]=a[2]*G+a[6]*t+a[10]*i+a[14]*e,h[3]=a[3]*G+a[7]*t+a[11]*i+a[15]*e,h}function C(c,a,l){let h=l??new o(4);return z(c,h),lt(h,a,h)}function x(c,a,l){let h=l??new o(4);return Pt(c)>a?C(c,a,h):_(c,h)}function P(c,a,l){let h=l??new o(4);return nt(c,a,.5,h)}return{create:n,fromValues:v,set:y,ceil:B,floor:S,round:U,clamp:A,add:L,addScaled:F,subtract:I,sub:W,equalsApproximately:ot,equals:tt,lerp:nt,lerpV:X,max:ft,min:st,mulScalar:lt,scale:dt,divScalar:Bt,inverse:Mt,invert:Dt,dot:zt,length:Pt,len:Gt,lengthSq:pt,lenSq:Et,distance:J,dist:et,distanceSq:Q,distSq:d,normalize:z,negate:m,copy:_,clone:V,multiply:E,mul:H,divide:j,div:k,zero:N,transformMat4:$,setLength:C,truncate:x,midpoint:P}}var Ze=new Map;function lo(o){let n=Ze.get(o);return n||(n=fo(o),Ze.set(o,n)),n}function ye(o,n,v,y,B,S){return{mat4:co(o),mat3:so(n),quat:uo(v),vec2:Qe(y),vec3:me(B),vec4:lo(S)}}var{mat4:Rt,mat3:Rs,quat:Os,vec2:ue,vec3:Ot,vec4:Me}=ye(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat4:Vs,mat3:qs,quat:Ns,vec2:$s,vec3:Ys,vec4:Xs}=ye(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat4:Hs,mat3:js,quat:Ws,vec2:Zs,vec3:Qs,vec4:ks}=ye(eo,Array,Array,Array,Array,Array);var ke=Ot.create(0,0,0),ie=6,Ke={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(o,n={}){return po(o,n)},onRun:function(o,n,v){wo(o,n,v)},onDestroy:function(o,n){ho(n)},onResize:function(o,n){go(o,n)},onViewportPosition:function(o,n){xo(o,n)},customFunctions:{addTriangle:function(o,n,v){let y=se(),B=n.data.spriteCount;n.data.spriteIndices.set(y,B);let S=B*ie;return n.data.spriteData[S]=v[0][0],n.data.spriteData[S+1]=v[0][1],n.data.spriteData[S+2]=v[1][0],n.data.spriteData[S+3]=v[1][1],n.data.spriteData[S+4]=v[2][0],n.data.spriteData[S+5]=v[2][1],n.data.spriteCount++,y},removeTriangle:function(o,n,v){n.data.spriteIndices.delete(v),n.data.spriteCount--},setPosition:function(o,n,v,y){let S=n.data.spriteIndices.get(v)*ie;n.data.spriteData[S]=y[0][0],n.data.spriteData[S+1]=y[0][1],n.data.spriteData[S+2]=y[1][0],n.data.spriteData[S+3]=y[1][1],n.data.spriteData[S+4]=y[2][0],n.data.spriteData[S+5]=y[2][1]}}};async function po(o,n){let{device:v}=o,y=new Float32Array([n.options.offseyX??0,n.options.offseyY??0,n.options.scale??20,0]),B=v.createBuffer({label:"displacement options buffer",size:y.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(B.getMappedRange()).set(y),B.unmap();let S=256,U=S,L=Float32Array.BYTES_PER_ELEMENT*2,I=Float32Array.BYTES_PER_ELEMENT*2,ot=Float32Array.BYTES_PER_ELEMENT*2,tt=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),nt=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),X=v.createPipelineLayout({bindGroupLayouts:[nt]}),ft="repeat",st="linear",lt=v.createSampler({label:"displacement ampler",addressModeU:ft,addressModeV:ft,addressModeW:ft,magFilter:st,minFilter:st,mipmapFilter:st}),dt=v.createBindGroup({layout:nt,entries:[{binding:0,resource:{buffer:tt}},{binding:1,resource:n.refs.color.data.view},{binding:2,resource:lt},{binding:3,resource:n.refs.map.view},{binding:4,resource:{buffer:B}}]}),Bt=v.createBuffer({size:S*ie,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),Mt={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},Dt=v.createRenderPipeline({label:"displacement",vertex:{module:v.createShaderModule({code:ve}),entryPoint:"vs_main",buffers:[Mt]},fragment:{module:v.createShaderModule({code:ve}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:X});return{bindGroup:dt,bindGroupLayout:nt,uniformBuffer:tt,sampler:lt,pipeline:Dt,params_buf:B,buffer:Bt,spriteData:new Float32Array(S*ie),spriteCount:0,spriteIndices:new Map}}function wo(o,n,v){if(n.data.spriteCount===0)return;let{device:y}=o,B=ie*n.data.spriteCount*Float32Array.BYTES_PER_ELEMENT;y.queue.writeBuffer(n.data.buffer,0,n.data.spriteData.buffer,0,B);let S=v.beginRenderPass({colorAttachments:[{view:n.refs.out,clearValue:o.clearValue,loadOp:"load",storeOp:"store"}]});S.setPipeline(n.data.pipeline),S.setBindGroup(0,n.data.bindGroup),S.setVertexBuffer(0,n.data.buffer);let U=n.data.spriteCount*3;S.draw(U,1,0,0),S.end()}function ho(o){o.data.bindGroup=null,o.data.buffer.destroy(),o.data.buffer=null,o.data.uniformBuffer.destroy(),o.data.uniformBuffer=null,o.data.spriteData=null,o.data.spriteIndices.clear(),o.data.spriteIndices=null,o.data.params_buf.destroy(),o.data.params_buf=null}function go(o,n){let{device:v}=o;n.data.bindGroup=v.createBindGroup({layout:n.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:n.data.uniformBuffer}},{binding:1,resource:n.refs.color.data.view},{binding:2,resource:n.data.sampler},{binding:3,resource:n.refs.map.view},{binding:4,resource:{buffer:n.data.params_buf}}]})}function xo(o,n){let{device:v}=o,y=o.viewport.width/o.viewport.zoom,B=o.viewport.height/o.viewport.zoom,S=Rt.ortho(0,y,B,0,-10,10);Ot.set(-o.viewport.position[0],-o.viewport.position[1],0,ke);let U=Rt.translation(ke);v.queue.writeBuffer(n.data.uniformBuffer,0,U.buffer),v.queue.writeBuffer(n.data.uniformBuffer,64,S.buffer)}function De(o,n){let v=n.vertices,y=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,B={size:v.byteLength,usage:y,mappedAtCreation:!0},S=o.createBuffer(B);return new Float32Array(S.getMappedRange()).set(v),S.unmap(),{buffer:S,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var be="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var br=Me.create(),Je=Ot.create(),en={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(o,n={}){return mo(o,n)},onRun:function(o,n,v){yo(o,n,v)},onDestroy:function(o,n){Do(n)},onResize:function(o,n){Ce(o,n)},onViewportPosition:function(o,n){Ce(o,n)},customFunctions:{...re}};async function mo(o,n){let{device:v}=o,y=16192,B=y,U=Float32Array.BYTES_PER_ELEMENT*2,L=Float32Array.BYTES_PER_ELEMENT*2,I=Float32Array.BYTES_PER_ELEMENT*4,ot=Float32Array.BYTES_PER_ELEMENT*4,tt=v.createBuffer({size:(U+L+I+ot)*B,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),nt=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),X=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),ft=v.createBindGroup({layout:X,entries:[{binding:0,resource:{buffer:nt}},{binding:1,resource:n.refs.spritesheet.data.colorTexture.view},{binding:2,resource:n.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:tt}}]}),st=v.createPipelineLayout({bindGroupLayouts:[X]}),lt=v.createRenderPipeline({label:"overlay",vertex:{module:v.createShaderModule({code:be}),entryPoint:"vs_main",buffers:[n.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:v.createShaderModule({code:be}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:st});return{instancedDrawCalls:new Uint32Array(y*2),instancedDrawCallCount:0,spriteBuffer:tt,uniformBuffer:nt,pipeline:lt,bindGroupLayout:X,bindGroup:ft,spriteData:new Float32Array(y*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function yo(o,n,v){let{device:y}=o,B=n.options.loadOp||"load";n.data.dirty&&(Mo(n.data),n.data.dirty=!1),y.queue.writeBuffer(n.data.spriteBuffer,0,n.data.spriteData.buffer);let S=v.beginRenderPass({colorAttachments:[{view:n.refs.color,clearValue:o.clearValue,loadOp:B,storeOp:"store"}]});S.setPipeline(n.data.pipeline),S.setBindGroup(0,n.data.bindGroup),S.setVertexBuffer(0,n.refs.spritesheet.data.quads.buffer);let U=6,A=0;for(let L=0;L<n.data.instancedDrawCallCount;L++){let F=n.data.instancedDrawCalls[L*2]*U,I=n.data.instancedDrawCalls[L*2+1];S.draw(U,I,F,A),A+=I}S.end()}function Mo(o){let n=-1,v=0;o.instancedDrawCallCount=0;for(let y=0;y<o.spriteCount;y++){let B=o.spriteData[y*12+11]&65535;B!==n&&(v>0&&(o.instancedDrawCalls[o.instancedDrawCallCount*2]=n,o.instancedDrawCalls[o.instancedDrawCallCount*2+1]=v,o.instancedDrawCallCount++),n=B,v=0),v++}v>0&&(o.instancedDrawCalls[o.instancedDrawCallCount*2]=n,o.instancedDrawCalls[o.instancedDrawCallCount*2+1]=v,o.instancedDrawCallCount++)}function Ce(o,n){let y=Math.round(o.viewport.width/1),B=Math.round(o.viewport.height/1),S=Rt.ortho(0,y,B,0,-10,10);Ot.set(0,0,0,Je);let U=Rt.translation(Je);o.device.queue.writeBuffer(n.data.uniformBuffer,0,U.buffer),o.device.queue.writeBuffer(n.data.uniformBuffer,64,S.buffer)}function Do(o){o.data.instancedDrawCalls=null,o.data.bindGroup=null,o.data.spriteBuffer.destroy(),o.data.spriteBuffer=null,o.data.uniformBuffer.destroy(),o.data.uniformBuffer=null,o.data.spriteData=null,o.data.spriteIndices.clear(),o.data.spriteIndices=null}var Se="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var nn={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(o,n={}){return So(o,n)},onRun:function(o,n,v){To(o,n,v)},onDestroy:function(o,n){},onResize:function(o,n){_o(o,n)},onViewportPosition:function(o,n){}};async function So(o,n){let{device:v}=o,y=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),B=v.createBindGroup({layout:y,entries:[{binding:0,resource:n.refs.in.data.view},{binding:1,resource:n.refs.in.data.sampler}]}),S=v.createPipelineLayout({bindGroupLayouts:[y]}),U=v.createRenderPipeline({label:"fb-blit",vertex:{module:v.createShaderModule({code:Se}),entryPoint:"vs_main",buffers:[]},fragment:{module:v.createShaderModule({code:Se}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:S});return{bindGroupLayout:y,bindGroup:B,pipeline:U}}function To(o,n,v){let{device:y}=o,B=v.beginRenderPass({colorAttachments:[{view:n.refs.out,clearValue:o.clearValue,loadOp:"load",storeOp:"store"}]});B.setPipeline(n.data.pipeline),B.setBindGroup(0,n.data.bindGroup),B.draw(3),B.end()}function _o(o,n){let{device:v}=o;n.data.bindGroup=v.createBindGroup({layout:n.data.bindGroupLayout,entries:[{binding:0,resource:n.refs.in.data.view},{binding:1,resource:n.refs.in.data.sampler}]})}var on="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function ce(o,n,v,y,B,S=1){let U=ue.sub(y,v),A=ue.normalize(U),L=Bo(A),F=S/2,I=n.data.vertexCount*6;n.data.vertices[I+0]=v[0]+L[0]*F,n.data.vertices[I+1]=v[1]+L[1]*F,n.data.vertices[I+2]=B[0],n.data.vertices[I+3]=B[1],n.data.vertices[I+4]=B[2],n.data.vertices[I+5]=B[3],n.data.vertices[I+6]=v[0]-L[0]*F,n.data.vertices[I+7]=v[1]-L[1]*F,n.data.vertices[I+8]=B[0],n.data.vertices[I+9]=B[1],n.data.vertices[I+10]=B[2],n.data.vertices[I+11]=B[3],n.data.vertices[I+12]=y[0]+L[0]*F,n.data.vertices[I+13]=y[1]+L[1]*F,n.data.vertices[I+14]=B[0],n.data.vertices[I+15]=B[1],n.data.vertices[I+16]=B[2],n.data.vertices[I+17]=B[3],n.data.vertices[I+18]=v[0]-L[0]*F,n.data.vertices[I+19]=v[1]-L[1]*F,n.data.vertices[I+20]=B[0],n.data.vertices[I+21]=B[1],n.data.vertices[I+22]=B[2],n.data.vertices[I+23]=B[3],n.data.vertices[I+24]=y[0]+L[0]*F,n.data.vertices[I+25]=y[1]+L[1]*F,n.data.vertices[I+26]=B[0],n.data.vertices[I+27]=B[1],n.data.vertices[I+28]=B[2],n.data.vertices[I+29]=B[3],n.data.vertices[I+30]=y[0]-L[0]*F,n.data.vertices[I+31]=y[1]-L[1]*F,n.data.vertices[I+32]=B[0],n.data.vertices[I+33]=B[1],n.data.vertices[I+34]=B[2],n.data.vertices[I+35]=B[3],n.data.vertexCount+=6,o.device.queue.writeBuffer(n.data.vertexBuffer,0,n.data.vertices.buffer)}function Bo(o){return[-o[1],o[0]]}var sn={line:ce,filledEllipse:function(o,n,v,y,B,S,U){let[A,L]=v,F=2*Math.PI/S;for(let I=0;I<S;I++){let W=I*F,ot=(I+1)*F,tt=A+y*Math.cos(W),nt=L+B*Math.sin(W),X=A+y*Math.cos(ot),ft=L+B*Math.sin(ot),st=n.data.vertexCount*6+I*18;n.data.vertices[st+0]=A,n.data.vertices[st+1]=L,n.data.vertices[st+2]=U[0],n.data.vertices[st+3]=U[1],n.data.vertices[st+4]=U[2],n.data.vertices[st+5]=U[3],n.data.vertices[st+6]=tt,n.data.vertices[st+7]=nt,n.data.vertices[st+8]=U[0],n.data.vertices[st+9]=U[1],n.data.vertices[st+10]=U[2],n.data.vertices[st+11]=U[3],n.data.vertices[st+12]=X,n.data.vertices[st+13]=ft,n.data.vertices[st+14]=U[0],n.data.vertices[st+15]=U[1],n.data.vertices[st+16]=U[2],n.data.vertices[st+17]=U[3]}n.data.vertexCount+=3*S,o.device.queue.writeBuffer(n.data.vertexBuffer,0,n.data.vertices.buffer)},box:function(o,n,v,y,B,S,U=0,A=1){let[L,F]=v,I=y/2,W=B/2,ot=[L-I,F-W],tt=[L+I,F-W],nt=[L-I,F+W],X=[L+I,F+W];U!==0&&(Kt(ot,v,U,ot),Kt(tt,v,U,tt),Kt(nt,v,U,nt),Kt(X,v,U,X)),ce(o,n,ot,tt,S,A),ce(o,n,nt,X,S,A),ce(o,n,ot,nt,S,A),ce(o,n,tt,X,S,A)},filledBox:function(o,n,v,y,B,S,U=0){let[A,L]=v,F=y/2,I=B/2,W=[A-F,L-I],ot=[A+F,L-I],tt=[A-F,L+I],nt=[A+F,L+I];U!==0&&(Kt(W,v,U,W),Kt(ot,v,U,ot),Kt(tt,v,U,tt),Kt(nt,v,U,nt));let X=n.data.vertexCount*6;n.data.vertices[X+0]=W[0],n.data.vertices[X+1]=W[1],n.data.vertices[X+2]=S[0],n.data.vertices[X+3]=S[1],n.data.vertices[X+4]=S[2],n.data.vertices[X+5]=S[3],n.data.vertices[X+6]=tt[0],n.data.vertices[X+7]=tt[1],n.data.vertices[X+8]=S[0],n.data.vertices[X+9]=S[1],n.data.vertices[X+10]=S[2],n.data.vertices[X+11]=S[3],n.data.vertices[X+12]=ot[0],n.data.vertices[X+13]=ot[1],n.data.vertices[X+14]=S[0],n.data.vertices[X+15]=S[1],n.data.vertices[X+16]=S[2],n.data.vertices[X+17]=S[3],n.data.vertices[X+18]=tt[0],n.data.vertices[X+19]=tt[1],n.data.vertices[X+20]=S[0],n.data.vertices[X+21]=S[1],n.data.vertices[X+22]=S[2],n.data.vertices[X+23]=S[3],n.data.vertices[X+24]=nt[0],n.data.vertices[X+25]=nt[1],n.data.vertices[X+26]=S[0],n.data.vertices[X+27]=S[1],n.data.vertices[X+28]=S[2],n.data.vertices[X+29]=S[3],n.data.vertices[X+30]=ot[0],n.data.vertices[X+31]=ot[1],n.data.vertices[X+32]=S[0],n.data.vertices[X+33]=S[1],n.data.vertices[X+34]=S[2],n.data.vertices[X+35]=S[3],n.data.vertexCount+=6,o.device.queue.writeBuffer(n.data.vertexBuffer,0,n.data.vertices.buffer)},clear:function(o,n){n.data.vertexCount=0}};function Kt(o,n,v,y){let B=o[0]-n[0],S=o[1]-n[1],U=Math.sin(v),A=Math.cos(v);return y[0]=B*A-S*U+n[0],y[1]=B*U+S*A+n[1],y}var rn=Ot.create(0,0,0),an={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(o,n={}){return zo(o,n)},onRun:function(o,n,v){Go(o,n,v)},onDestroy:function(o,n){Uo(n)},onResize:function(o,n){cn(o,n)},onViewportPosition:function(o,n){cn(o,n)},customFunctions:sn};async function zo(o,n){let{device:v}=o,y=new Float32Array(1e4),B=v.createBuffer({size:y.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),S=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),U=v.createShaderModule({code:on}),A=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),L=v.createPipelineLayout({bindGroupLayouts:[A]}),F=v.createBindGroup({layout:A,entries:[{binding:0,resource:{buffer:S}}]}),I=v.createRenderPipeline({layout:L,vertex:{module:U,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:U,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:S,vertexBuffer:B,pipeline:I,bindGroup:F,vertexCount:0,vertices:y}}function Go(o,n,v){if(n.data.vertexCount===0)return;let{device:y}=o,B=n.options.loadOp||"load",S=v.beginRenderPass({colorAttachments:[{view:n.refs.color,clearValue:o.clearValue,loadOp:B,storeOp:"store"}]});S.setPipeline(n.data.pipeline),S.setBindGroup(0,n.data.bindGroup),S.setVertexBuffer(0,n.data.vertexBuffer),S.draw(n.data.vertexCount),S.end()}function Uo(o){o.data.vertexBuffer.destroy(),o.data.vertexBuffer=null,o.data.uniformBuffer.destroy(),o.data.uniformBuffer=null}function cn(o,n){let{device:v}=o,y=o.viewport.width/o.viewport.zoom,B=o.viewport.height/o.viewport.zoom,S=Rt.ortho(0,y,B,0,-10,10);Ot.set(-o.viewport.position[0],-o.viewport.position[1],0,rn);let U=Rt.translation(rn);v.queue.writeBuffer(n.data.uniformBuffer,0,U.buffer),v.queue.writeBuffer(n.data.uniformBuffer,64,S.buffer)}var Te={};Ge(Te,{setAmbientLight:()=>Lo,setLights:()=>Io,setOccluders:()=>Eo});function Io(o,n,v){n.data.lights=v,n.data.lightsBufferNeedsUpdate=!0}function Lo(o,n,v){n.data.lightsRenderer.setAmbientLight(v)}function Eo(o,n,v){n.data.lightsRenderer.setObstacles(v),n.data.lightsTextureNeedsUpdate=!0}function Ao(o,n){return class extends o{constructor(...v){super(...v),n(this)}}}var Fo=Ao(Array,o=>o.fill(0)),ct=1e-6;function Ro(o){function n(t=0,i=0){let e=new o(2);return t!==void 0&&(e[0]=t,i!==void 0&&(e[1]=i)),e}let v=n;function y(t,i,e){let s=e??new o(2);return s[0]=t,s[1]=i,s}function B(t,i){let e=i??new o(2);return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function S(t,i){let e=i??new o(2);return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function U(t,i){let e=i??new o(2);return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function A(t,i=0,e=1,s){let f=s??new o(2);return f[0]=Math.min(e,Math.max(i,t[0])),f[1]=Math.min(e,Math.max(i,t[1])),f}function L(t,i,e){let s=e??new o(2);return s[0]=t[0]+i[0],s[1]=t[1]+i[1],s}function F(t,i,e,s){let f=s??new o(2);return f[0]=t[0]+i[0]*e,f[1]=t[1]+i[1]*e,f}function I(t,i){let e=t[0],s=t[1],f=i[0],g=i[1],b=Math.sqrt(e*e+s*s),r=Math.sqrt(f*f+g*g),u=b*r,p=u&&Gt(t,i)/u;return Math.acos(p)}function W(t,i,e){let s=e??new o(2);return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s}let ot=W;function tt(t,i){return Math.abs(t[0]-i[0])<ct&&Math.abs(t[1]-i[1])<ct}function nt(t,i){return t[0]===i[0]&&t[1]===i[1]}function X(t,i,e,s){let f=s??new o(2);return f[0]=t[0]+e*(i[0]-t[0]),f[1]=t[1]+e*(i[1]-t[1]),f}function ft(t,i,e,s){let f=s??new o(2);return f[0]=t[0]+e[0]*(i[0]-t[0]),f[1]=t[1]+e[1]*(i[1]-t[1]),f}function st(t,i,e){let s=e??new o(2);return s[0]=Math.max(t[0],i[0]),s[1]=Math.max(t[1],i[1]),s}function lt(t,i,e){let s=e??new o(2);return s[0]=Math.min(t[0],i[0]),s[1]=Math.min(t[1],i[1]),s}function dt(t,i,e){let s=e??new o(2);return s[0]=t[0]*i,s[1]=t[1]*i,s}let Bt=dt;function Mt(t,i,e){let s=e??new o(2);return s[0]=t[0]/i,s[1]=t[1]/i,s}function Dt(t,i){let e=i??new o(2);return e[0]=1/t[0],e[1]=1/t[1],e}let zt=Dt;function Pt(t,i,e){let s=e??new o(3),f=t[0]*i[1]-t[1]*i[0];return s[0]=0,s[1]=0,s[2]=f,s}function Gt(t,i){return t[0]*i[0]+t[1]*i[1]}function pt(t){let i=t[0],e=t[1];return Math.sqrt(i*i+e*e)}let Et=pt;function J(t){let i=t[0],e=t[1];return i*i+e*e}let et=J;function Q(t,i){let e=t[0]-i[0],s=t[1]-i[1];return Math.sqrt(e*e+s*s)}let d=Q;function z(t,i){let e=t[0]-i[0],s=t[1]-i[1];return e*e+s*s}let m=z;function _(t,i){let e=i??new o(2),s=t[0],f=t[1],g=Math.sqrt(s*s+f*f);return g>1e-5?(e[0]=s/g,e[1]=f/g):(e[0]=0,e[1]=0),e}function V(t,i){let e=i??new o(2);return e[0]=-t[0],e[1]=-t[1],e}function E(t,i){let e=i??new o(2);return e[0]=t[0],e[1]=t[1],e}let H=E;function j(t,i,e){let s=e??new o(2);return s[0]=t[0]*i[0],s[1]=t[1]*i[1],s}let k=j;function N(t,i,e){let s=e??new o(2);return s[0]=t[0]/i[0],s[1]=t[1]/i[1],s}let $=N;function C(t=1,i){let e=i??new o(2),s=Math.random()*2*Math.PI;return e[0]=Math.cos(s)*t,e[1]=Math.sin(s)*t,e}function x(t){let i=t??new o(2);return i[0]=0,i[1]=0,i}function P(t,i,e){let s=e??new o(2),f=t[0],g=t[1];return s[0]=f*i[0]+g*i[4]+i[12],s[1]=f*i[1]+g*i[5]+i[13],s}function c(t,i,e){let s=e??new o(2),f=t[0],g=t[1];return s[0]=i[0]*f+i[4]*g+i[8],s[1]=i[1]*f+i[5]*g+i[9],s}function a(t,i,e,s){let f=s??new o(2),g=t[0]-i[0],b=t[1]-i[1],r=Math.sin(e),u=Math.cos(e);return f[0]=g*u-b*r+i[0],f[1]=g*r+b*u+i[1],f}function l(t,i,e){let s=e??new o(2);return _(t,s),dt(s,i,s)}function h(t,i,e){let s=e??new o(2);return pt(t)>i?l(t,i,s):E(t,s)}function G(t,i,e){let s=e??new o(2);return X(t,i,.5,s)}return{create:n,fromValues:v,set:y,ceil:B,floor:S,round:U,clamp:A,add:L,addScaled:F,angle:I,subtract:W,sub:ot,equalsApproximately:tt,equals:nt,lerp:X,lerpV:ft,max:st,min:lt,mulScalar:dt,scale:Bt,divScalar:Mt,inverse:Dt,invert:zt,cross:Pt,dot:Gt,length:pt,len:Et,lengthSq:J,lenSq:et,distance:Q,dist:d,distanceSq:z,distSq:m,normalize:_,negate:V,copy:E,clone:H,multiply:j,mul:k,divide:N,div:$,random:C,zero:x,transformMat4:P,transformMat3:c,rotate:a,setLength:l,truncate:h,midpoint:G}}var un=new Map;function hn(o){let n=un.get(o);return n||(n=Ro(o),un.set(o,n)),n}function Oo(o){let n=hn(o);function v(d,z,m,_,V,E,H,j,k){let N=new o(12);return N[3]=0,N[7]=0,N[11]=0,d!==void 0&&(N[0]=d,z!==void 0&&(N[1]=z,m!==void 0&&(N[2]=m,_!==void 0&&(N[4]=_,V!==void 0&&(N[5]=V,E!==void 0&&(N[6]=E,H!==void 0&&(N[8]=H,j!==void 0&&(N[9]=j,k!==void 0&&(N[10]=k))))))))),N}function y(d,z,m,_,V,E,H,j,k,N){let $=N??new o(12);return $[0]=d,$[1]=z,$[2]=m,$[3]=0,$[4]=_,$[5]=V,$[6]=E,$[7]=0,$[8]=H,$[9]=j,$[10]=k,$[11]=0,$}function B(d,z){let m=z??new o(12);return m[0]=d[0],m[1]=d[1],m[2]=d[2],m[3]=0,m[4]=d[4],m[5]=d[5],m[6]=d[6],m[7]=0,m[8]=d[8],m[9]=d[9],m[10]=d[10],m[11]=0,m}function S(d,z){let m=z??new o(12),_=d[0],V=d[1],E=d[2],H=d[3],j=_+_,k=V+V,N=E+E,$=_*j,C=V*j,x=V*k,P=E*j,c=E*k,a=E*N,l=H*j,h=H*k,G=H*N;return m[0]=1-x-a,m[1]=C+G,m[2]=P-h,m[3]=0,m[4]=C-G,m[5]=1-$-a,m[6]=c+l,m[7]=0,m[8]=P+h,m[9]=c-l,m[10]=1-$-x,m[11]=0,m}function U(d,z){let m=z??new o(12);return m[0]=-d[0],m[1]=-d[1],m[2]=-d[2],m[4]=-d[4],m[5]=-d[5],m[6]=-d[6],m[8]=-d[8],m[9]=-d[9],m[10]=-d[10],m}function A(d,z){let m=z??new o(12);return m[0]=d[0],m[1]=d[1],m[2]=d[2],m[4]=d[4],m[5]=d[5],m[6]=d[6],m[8]=d[8],m[9]=d[9],m[10]=d[10],m}let L=A;function F(d,z){return Math.abs(d[0]-z[0])<ct&&Math.abs(d[1]-z[1])<ct&&Math.abs(d[2]-z[2])<ct&&Math.abs(d[4]-z[4])<ct&&Math.abs(d[5]-z[5])<ct&&Math.abs(d[6]-z[6])<ct&&Math.abs(d[8]-z[8])<ct&&Math.abs(d[9]-z[9])<ct&&Math.abs(d[10]-z[10])<ct}function I(d,z){return d[0]===z[0]&&d[1]===z[1]&&d[2]===z[2]&&d[4]===z[4]&&d[5]===z[5]&&d[6]===z[6]&&d[8]===z[8]&&d[9]===z[9]&&d[10]===z[10]}function W(d){let z=d??new o(12);return z[0]=1,z[1]=0,z[2]=0,z[4]=0,z[5]=1,z[6]=0,z[8]=0,z[9]=0,z[10]=1,z}function ot(d,z){let m=z??new o(12);if(m===d){let x;return x=d[1],d[1]=d[4],d[4]=x,x=d[2],d[2]=d[8],d[8]=x,x=d[6],d[6]=d[9],d[9]=x,m}let _=d[0*4+0],V=d[0*4+1],E=d[0*4+2],H=d[1*4+0],j=d[1*4+1],k=d[1*4+2],N=d[2*4+0],$=d[2*4+1],C=d[2*4+2];return m[0]=_,m[1]=H,m[2]=N,m[4]=V,m[5]=j,m[6]=$,m[8]=E,m[9]=k,m[10]=C,m}function tt(d,z){let m=z??new o(12),_=d[0*4+0],V=d[0*4+1],E=d[0*4+2],H=d[1*4+0],j=d[1*4+1],k=d[1*4+2],N=d[2*4+0],$=d[2*4+1],C=d[2*4+2],x=C*j-k*$,P=-C*H+k*N,c=$*H-j*N,a=1/(_*x+V*P+E*c);return m[0]=x*a,m[1]=(-C*V+E*$)*a,m[2]=(k*V-E*j)*a,m[4]=P*a,m[5]=(C*_-E*N)*a,m[6]=(-k*_+E*H)*a,m[8]=c*a,m[9]=(-$*_+V*N)*a,m[10]=(j*_-V*H)*a,m}function nt(d){let z=d[0],m=d[0*4+1],_=d[0*4+2],V=d[1*4+0],E=d[1*4+1],H=d[1*4+2],j=d[2*4+0],k=d[2*4+1],N=d[2*4+2];return z*(E*N-k*H)-V*(m*N-k*_)+j*(m*H-E*_)}let X=tt;function ft(d,z,m){let _=m??new o(12),V=d[0],E=d[1],H=d[2],j=d[4],k=d[5],N=d[6],$=d[8],C=d[9],x=d[10],P=z[0],c=z[1],a=z[2],l=z[4],h=z[5],G=z[6],t=z[8],i=z[9],e=z[10];return _[0]=V*P+j*c+$*a,_[1]=E*P+k*c+C*a,_[2]=H*P+N*c+x*a,_[4]=V*l+j*h+$*G,_[5]=E*l+k*h+C*G,_[6]=H*l+N*h+x*G,_[8]=V*t+j*i+$*e,_[9]=E*t+k*i+C*e,_[10]=H*t+N*i+x*e,_}let st=ft;function lt(d,z,m){let _=m??W();return d!==_&&(_[0]=d[0],_[1]=d[1],_[2]=d[2],_[4]=d[4],_[5]=d[5],_[6]=d[6]),_[8]=z[0],_[9]=z[1],_[10]=1,_}function dt(d,z){let m=z??n.create();return m[0]=d[8],m[1]=d[9],m}function Bt(d,z,m){let _=m??n.create(),V=z*4;return _[0]=d[V+0],_[1]=d[V+1],_}function Mt(d,z,m,_){let V=_===d?d:A(d,_),E=m*4;return V[E+0]=z[0],V[E+1]=z[1],V}function Dt(d,z){let m=z??n.create(),_=d[0],V=d[1],E=d[4],H=d[5];return m[0]=Math.sqrt(_*_+V*V),m[1]=Math.sqrt(E*E+H*H),m}function zt(d,z){let m=z??new o(12);return m[0]=1,m[1]=0,m[2]=0,m[4]=0,m[5]=1,m[6]=0,m[8]=d[0],m[9]=d[1],m[10]=1,m}function Pt(d,z,m){let _=m??new o(12),V=z[0],E=z[1],H=d[0],j=d[1],k=d[2],N=d[1*4+0],$=d[1*4+1],C=d[1*4+2],x=d[2*4+0],P=d[2*4+1],c=d[2*4+2];return d!==_&&(_[0]=H,_[1]=j,_[2]=k,_[4]=N,_[5]=$,_[6]=C),_[8]=H*V+N*E+x,_[9]=j*V+$*E+P,_[10]=k*V+C*E+c,_}function Gt(d,z){let m=z??new o(12),_=Math.cos(d),V=Math.sin(d);return m[0]=_,m[1]=V,m[2]=0,m[4]=-V,m[5]=_,m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function pt(d,z,m){let _=m??new o(12),V=d[0*4+0],E=d[0*4+1],H=d[0*4+2],j=d[1*4+0],k=d[1*4+1],N=d[1*4+2],$=Math.cos(z),C=Math.sin(z);return _[0]=$*V+C*j,_[1]=$*E+C*k,_[2]=$*H+C*N,_[4]=$*j-C*V,_[5]=$*k-C*E,_[6]=$*N-C*H,d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}function Et(d,z){let m=z??new o(12);return m[0]=d[0],m[1]=0,m[2]=0,m[4]=0,m[5]=d[1],m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function J(d,z,m){let _=m??new o(12),V=z[0],E=z[1];return _[0]=V*d[0*4+0],_[1]=V*d[0*4+1],_[2]=V*d[0*4+2],_[4]=E*d[1*4+0],_[5]=E*d[1*4+1],_[6]=E*d[1*4+2],d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}function et(d,z){let m=z??new o(12);return m[0]=d,m[1]=0,m[2]=0,m[4]=0,m[5]=d,m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function Q(d,z,m){let _=m??new o(12);return _[0]=z*d[0*4+0],_[1]=z*d[0*4+1],_[2]=z*d[0*4+2],_[4]=z*d[1*4+0],_[5]=z*d[1*4+1],_[6]=z*d[1*4+2],d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}return{clone:L,create:v,set:y,fromMat4:B,fromQuat:S,negate:U,copy:A,equalsApproximately:F,equals:I,identity:W,transpose:ot,inverse:tt,invert:X,determinant:nt,mul:st,multiply:ft,setTranslation:lt,getTranslation:dt,getAxis:Bt,setAxis:Mt,getScaling:Dt,translation:zt,translate:Pt,rotation:Gt,rotate:pt,scaling:Et,scale:J,uniformScaling:et,uniformScale:Q}}var fn=new Map;function Vo(o){let n=fn.get(o);return n||(n=Oo(o),fn.set(o,n)),n}function qo(o){function n(r,u,p){let w=new o(3);return r!==void 0&&(w[0]=r,u!==void 0&&(w[1]=u,p!==void 0&&(w[2]=p))),w}let v=n;function y(r,u,p,w){let M=w??new o(3);return M[0]=r,M[1]=u,M[2]=p,M}function B(r,u){let p=u??new o(3);return p[0]=Math.ceil(r[0]),p[1]=Math.ceil(r[1]),p[2]=Math.ceil(r[2]),p}function S(r,u){let p=u??new o(3);return p[0]=Math.floor(r[0]),p[1]=Math.floor(r[1]),p[2]=Math.floor(r[2]),p}function U(r,u){let p=u??new o(3);return p[0]=Math.round(r[0]),p[1]=Math.round(r[1]),p[2]=Math.round(r[2]),p}function A(r,u=0,p=1,w){let M=w??new o(3);return M[0]=Math.min(p,Math.max(u,r[0])),M[1]=Math.min(p,Math.max(u,r[1])),M[2]=Math.min(p,Math.max(u,r[2])),M}function L(r,u,p){let w=p??new o(3);return w[0]=r[0]+u[0],w[1]=r[1]+u[1],w[2]=r[2]+u[2],w}function F(r,u,p,w){let M=w??new o(3);return M[0]=r[0]+u[0]*p,M[1]=r[1]+u[1]*p,M[2]=r[2]+u[2]*p,M}function I(r,u){let p=r[0],w=r[1],M=r[2],D=u[0],T=u[1],q=u[2],Y=Math.sqrt(p*p+w*w+M*M),R=Math.sqrt(D*D+T*T+q*q),O=Y*R,Z=O&&Gt(r,u)/O;return Math.acos(Z)}function W(r,u,p){let w=p??new o(3);return w[0]=r[0]-u[0],w[1]=r[1]-u[1],w[2]=r[2]-u[2],w}let ot=W;function tt(r,u){return Math.abs(r[0]-u[0])<ct&&Math.abs(r[1]-u[1])<ct&&Math.abs(r[2]-u[2])<ct}function nt(r,u){return r[0]===u[0]&&r[1]===u[1]&&r[2]===u[2]}function X(r,u,p,w){let M=w??new o(3);return M[0]=r[0]+p*(u[0]-r[0]),M[1]=r[1]+p*(u[1]-r[1]),M[2]=r[2]+p*(u[2]-r[2]),M}function ft(r,u,p,w){let M=w??new o(3);return M[0]=r[0]+p[0]*(u[0]-r[0]),M[1]=r[1]+p[1]*(u[1]-r[1]),M[2]=r[2]+p[2]*(u[2]-r[2]),M}function st(r,u,p){let w=p??new o(3);return w[0]=Math.max(r[0],u[0]),w[1]=Math.max(r[1],u[1]),w[2]=Math.max(r[2],u[2]),w}function lt(r,u,p){let w=p??new o(3);return w[0]=Math.min(r[0],u[0]),w[1]=Math.min(r[1],u[1]),w[2]=Math.min(r[2],u[2]),w}function dt(r,u,p){let w=p??new o(3);return w[0]=r[0]*u,w[1]=r[1]*u,w[2]=r[2]*u,w}let Bt=dt;function Mt(r,u,p){let w=p??new o(3);return w[0]=r[0]/u,w[1]=r[1]/u,w[2]=r[2]/u,w}function Dt(r,u){let p=u??new o(3);return p[0]=1/r[0],p[1]=1/r[1],p[2]=1/r[2],p}let zt=Dt;function Pt(r,u,p){let w=p??new o(3),M=r[2]*u[0]-r[0]*u[2],D=r[0]*u[1]-r[1]*u[0];return w[0]=r[1]*u[2]-r[2]*u[1],w[1]=M,w[2]=D,w}function Gt(r,u){return r[0]*u[0]+r[1]*u[1]+r[2]*u[2]}function pt(r){let u=r[0],p=r[1],w=r[2];return Math.sqrt(u*u+p*p+w*w)}let Et=pt;function J(r){let u=r[0],p=r[1],w=r[2];return u*u+p*p+w*w}let et=J;function Q(r,u){let p=r[0]-u[0],w=r[1]-u[1],M=r[2]-u[2];return Math.sqrt(p*p+w*w+M*M)}let d=Q;function z(r,u){let p=r[0]-u[0],w=r[1]-u[1],M=r[2]-u[2];return p*p+w*w+M*M}let m=z;function _(r,u){let p=u??new o(3),w=r[0],M=r[1],D=r[2],T=Math.sqrt(w*w+M*M+D*D);return T>1e-5?(p[0]=w/T,p[1]=M/T,p[2]=D/T):(p[0]=0,p[1]=0,p[2]=0),p}function V(r,u){let p=u??new o(3);return p[0]=-r[0],p[1]=-r[1],p[2]=-r[2],p}function E(r,u){let p=u??new o(3);return p[0]=r[0],p[1]=r[1],p[2]=r[2],p}let H=E;function j(r,u,p){let w=p??new o(3);return w[0]=r[0]*u[0],w[1]=r[1]*u[1],w[2]=r[2]*u[2],w}let k=j;function N(r,u,p){let w=p??new o(3);return w[0]=r[0]/u[0],w[1]=r[1]/u[1],w[2]=r[2]/u[2],w}let $=N;function C(r=1,u){let p=u??new o(3),w=Math.random()*2*Math.PI,M=Math.random()*2-1,D=Math.sqrt(1-M*M)*r;return p[0]=Math.cos(w)*D,p[1]=Math.sin(w)*D,p[2]=M*r,p}function x(r){let u=r??new o(3);return u[0]=0,u[1]=0,u[2]=0,u}function P(r,u,p){let w=p??new o(3),M=r[0],D=r[1],T=r[2],q=u[3]*M+u[7]*D+u[11]*T+u[15]||1;return w[0]=(u[0]*M+u[4]*D+u[8]*T+u[12])/q,w[1]=(u[1]*M+u[5]*D+u[9]*T+u[13])/q,w[2]=(u[2]*M+u[6]*D+u[10]*T+u[14])/q,w}function c(r,u,p){let w=p??new o(3),M=r[0],D=r[1],T=r[2];return w[0]=M*u[0*4+0]+D*u[1*4+0]+T*u[2*4+0],w[1]=M*u[0*4+1]+D*u[1*4+1]+T*u[2*4+1],w[2]=M*u[0*4+2]+D*u[1*4+2]+T*u[2*4+2],w}function a(r,u,p){let w=p??new o(3),M=r[0],D=r[1],T=r[2];return w[0]=M*u[0]+D*u[4]+T*u[8],w[1]=M*u[1]+D*u[5]+T*u[9],w[2]=M*u[2]+D*u[6]+T*u[10],w}function l(r,u,p){let w=p??new o(3),M=u[0],D=u[1],T=u[2],q=u[3]*2,Y=r[0],R=r[1],O=r[2],Z=D*O-T*R,K=T*Y-M*O,rt=M*R-D*Y;return w[0]=Y+Z*q+(D*rt-T*K)*2,w[1]=R+K*q+(T*Z-M*rt)*2,w[2]=O+rt*q+(M*K-D*Z)*2,w}function h(r,u){let p=u??new o(3);return p[0]=r[12],p[1]=r[13],p[2]=r[14],p}function G(r,u,p){let w=p??new o(3),M=u*4;return w[0]=r[M+0],w[1]=r[M+1],w[2]=r[M+2],w}function t(r,u){let p=u??new o(3),w=r[0],M=r[1],D=r[2],T=r[4],q=r[5],Y=r[6],R=r[8],O=r[9],Z=r[10];return p[0]=Math.sqrt(w*w+M*M+D*D),p[1]=Math.sqrt(T*T+q*q+Y*Y),p[2]=Math.sqrt(R*R+O*O+Z*Z),p}function i(r,u,p,w){let M=w??new o(3),D=[],T=[];return D[0]=r[0]-u[0],D[1]=r[1]-u[1],D[2]=r[2]-u[2],T[0]=D[0],T[1]=D[1]*Math.cos(p)-D[2]*Math.sin(p),T[2]=D[1]*Math.sin(p)+D[2]*Math.cos(p),M[0]=T[0]+u[0],M[1]=T[1]+u[1],M[2]=T[2]+u[2],M}function e(r,u,p,w){let M=w??new o(3),D=[],T=[];return D[0]=r[0]-u[0],D[1]=r[1]-u[1],D[2]=r[2]-u[2],T[0]=D[2]*Math.sin(p)+D[0]*Math.cos(p),T[1]=D[1],T[2]=D[2]*Math.cos(p)-D[0]*Math.sin(p),M[0]=T[0]+u[0],M[1]=T[1]+u[1],M[2]=T[2]+u[2],M}function s(r,u,p,w){let M=w??new o(3),D=[],T=[];return D[0]=r[0]-u[0],D[1]=r[1]-u[1],D[2]=r[2]-u[2],T[0]=D[0]*Math.cos(p)-D[1]*Math.sin(p),T[1]=D[0]*Math.sin(p)+D[1]*Math.cos(p),T[2]=D[2],M[0]=T[0]+u[0],M[1]=T[1]+u[1],M[2]=T[2]+u[2],M}function f(r,u,p){let w=p??new o(3);return _(r,w),dt(w,u,w)}function g(r,u,p){let w=p??new o(3);return pt(r)>u?f(r,u,w):E(r,w)}function b(r,u,p){let w=p??new o(3);return X(r,u,.5,w)}return{create:n,fromValues:v,set:y,ceil:B,floor:S,round:U,clamp:A,add:L,addScaled:F,angle:I,subtract:W,sub:ot,equalsApproximately:tt,equals:nt,lerp:X,lerpV:ft,max:st,min:lt,mulScalar:dt,scale:Bt,divScalar:Mt,inverse:Dt,invert:zt,cross:Pt,dot:Gt,length:pt,len:Et,lengthSq:J,lenSq:et,distance:Q,dist:d,distanceSq:z,distSq:m,normalize:_,negate:V,copy:E,clone:H,multiply:j,mul:k,divide:N,div:$,random:C,zero:x,transformMat4:P,transformMat4Upper3x3:c,transformMat3:a,transformQuat:l,getTranslation:h,getAxis:G,getScaling:t,rotateX:i,rotateY:e,rotateZ:s,setLength:f,truncate:g,midpoint:b}}var ln=new Map;function _e(o){let n=ln.get(o);return n||(n=qo(o),ln.set(o,n)),n}function No(o){let n=_e(o);function v(t,i,e,s,f,g,b,r,u,p,w,M,D,T,q,Y){let R=new o(16);return t!==void 0&&(R[0]=t,i!==void 0&&(R[1]=i,e!==void 0&&(R[2]=e,s!==void 0&&(R[3]=s,f!==void 0&&(R[4]=f,g!==void 0&&(R[5]=g,b!==void 0&&(R[6]=b,r!==void 0&&(R[7]=r,u!==void 0&&(R[8]=u,p!==void 0&&(R[9]=p,w!==void 0&&(R[10]=w,M!==void 0&&(R[11]=M,D!==void 0&&(R[12]=D,T!==void 0&&(R[13]=T,q!==void 0&&(R[14]=q,Y!==void 0&&(R[15]=Y)))))))))))))))),R}function y(t,i,e,s,f,g,b,r,u,p,w,M,D,T,q,Y,R){let O=R??new o(16);return O[0]=t,O[1]=i,O[2]=e,O[3]=s,O[4]=f,O[5]=g,O[6]=b,O[7]=r,O[8]=u,O[9]=p,O[10]=w,O[11]=M,O[12]=D,O[13]=T,O[14]=q,O[15]=Y,O}function B(t,i){let e=i??new o(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function S(t,i){let e=i??new o(16),s=t[0],f=t[1],g=t[2],b=t[3],r=s+s,u=f+f,p=g+g,w=s*r,M=f*r,D=f*u,T=g*r,q=g*u,Y=g*p,R=b*r,O=b*u,Z=b*p;return e[0]=1-D-Y,e[1]=M+Z,e[2]=T-O,e[3]=0,e[4]=M-Z,e[5]=1-w-Y,e[6]=q+R,e[7]=0,e[8]=T+O,e[9]=q-R,e[10]=1-w-D,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function U(t,i){let e=i??new o(16);return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function A(t,i){let e=i??new o(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}let L=A;function F(t,i){return Math.abs(t[0]-i[0])<ct&&Math.abs(t[1]-i[1])<ct&&Math.abs(t[2]-i[2])<ct&&Math.abs(t[3]-i[3])<ct&&Math.abs(t[4]-i[4])<ct&&Math.abs(t[5]-i[5])<ct&&Math.abs(t[6]-i[6])<ct&&Math.abs(t[7]-i[7])<ct&&Math.abs(t[8]-i[8])<ct&&Math.abs(t[9]-i[9])<ct&&Math.abs(t[10]-i[10])<ct&&Math.abs(t[11]-i[11])<ct&&Math.abs(t[12]-i[12])<ct&&Math.abs(t[13]-i[13])<ct&&Math.abs(t[14]-i[14])<ct&&Math.abs(t[15]-i[15])<ct}function I(t,i){return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]&&t[9]===i[9]&&t[10]===i[10]&&t[11]===i[11]&&t[12]===i[12]&&t[13]===i[13]&&t[14]===i[14]&&t[15]===i[15]}function W(t){let i=t??new o(16);return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function ot(t,i){let e=i??new o(16);if(e===t){let K;return K=t[1],t[1]=t[4],t[4]=K,K=t[2],t[2]=t[8],t[8]=K,K=t[3],t[3]=t[12],t[12]=K,K=t[6],t[6]=t[9],t[9]=K,K=t[7],t[7]=t[13],t[13]=K,K=t[11],t[11]=t[14],t[14]=K,e}let s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],b=t[0*4+3],r=t[1*4+0],u=t[1*4+1],p=t[1*4+2],w=t[1*4+3],M=t[2*4+0],D=t[2*4+1],T=t[2*4+2],q=t[2*4+3],Y=t[3*4+0],R=t[3*4+1],O=t[3*4+2],Z=t[3*4+3];return e[0]=s,e[1]=r,e[2]=M,e[3]=Y,e[4]=f,e[5]=u,e[6]=D,e[7]=R,e[8]=g,e[9]=p,e[10]=T,e[11]=O,e[12]=b,e[13]=w,e[14]=q,e[15]=Z,e}function tt(t,i){let e=i??new o(16),s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],b=t[0*4+3],r=t[1*4+0],u=t[1*4+1],p=t[1*4+2],w=t[1*4+3],M=t[2*4+0],D=t[2*4+1],T=t[2*4+2],q=t[2*4+3],Y=t[3*4+0],R=t[3*4+1],O=t[3*4+2],Z=t[3*4+3],K=T*Z,rt=O*q,at=p*Z,ut=O*w,wt=p*q,ht=T*w,gt=g*Z,xt=O*b,vt=g*q,mt=T*b,bt=g*w,St=p*b,Tt=M*R,_t=Y*D,Ut=r*R,It=Y*u,Lt=r*D,Yt=M*u,Xt=s*R,Ht=Y*f,jt=s*D,Wt=M*f,Zt=s*u,Qt=r*f,Ct=K*u+ut*D+wt*R-(rt*u+at*D+ht*R),te=rt*f+gt*D+mt*R-(K*f+xt*D+vt*R),ee=at*f+xt*u+bt*R-(ut*f+gt*u+St*R),ne=ht*f+vt*u+St*D-(wt*f+mt*u+bt*D),yt=1/(s*Ct+r*te+M*ee+Y*ne);return e[0]=yt*Ct,e[1]=yt*te,e[2]=yt*ee,e[3]=yt*ne,e[4]=yt*(rt*r+at*M+ht*Y-(K*r+ut*M+wt*Y)),e[5]=yt*(K*s+xt*M+vt*Y-(rt*s+gt*M+mt*Y)),e[6]=yt*(ut*s+gt*r+St*Y-(at*s+xt*r+bt*Y)),e[7]=yt*(wt*s+mt*r+bt*M-(ht*s+vt*r+St*M)),e[8]=yt*(Tt*w+It*q+Lt*Z-(_t*w+Ut*q+Yt*Z)),e[9]=yt*(_t*b+Xt*q+Wt*Z-(Tt*b+Ht*q+jt*Z)),e[10]=yt*(Ut*b+Ht*w+Zt*Z-(It*b+Xt*w+Qt*Z)),e[11]=yt*(Yt*b+jt*w+Qt*q-(Lt*b+Wt*w+Zt*q)),e[12]=yt*(Ut*T+Yt*O+_t*p-(Lt*O+Tt*p+It*T)),e[13]=yt*(jt*O+Tt*g+Ht*T-(Xt*T+Wt*O+_t*g)),e[14]=yt*(Xt*p+Qt*O+It*g-(Zt*O+Ut*g+Ht*p)),e[15]=yt*(Zt*T+Lt*g+Wt*p-(jt*p+Qt*T+Yt*g)),e}function nt(t){let i=t[0],e=t[0*4+1],s=t[0*4+2],f=t[0*4+3],g=t[1*4+0],b=t[1*4+1],r=t[1*4+2],u=t[1*4+3],p=t[2*4+0],w=t[2*4+1],M=t[2*4+2],D=t[2*4+3],T=t[3*4+0],q=t[3*4+1],Y=t[3*4+2],R=t[3*4+3],O=M*R,Z=Y*D,K=r*R,rt=Y*u,at=r*D,ut=M*u,wt=s*R,ht=Y*f,gt=s*D,xt=M*f,vt=s*u,mt=r*f,bt=O*b+rt*w+at*q-(Z*b+K*w+ut*q),St=Z*e+wt*w+xt*q-(O*e+ht*w+gt*q),Tt=K*e+ht*b+vt*q-(rt*e+wt*b+mt*q),_t=ut*e+gt*b+mt*w-(at*e+xt*b+vt*w);return i*bt+g*St+p*Tt+T*_t}let X=tt;function ft(t,i,e){let s=e??new o(16),f=t[0],g=t[1],b=t[2],r=t[3],u=t[4],p=t[5],w=t[6],M=t[7],D=t[8],T=t[9],q=t[10],Y=t[11],R=t[12],O=t[13],Z=t[14],K=t[15],rt=i[0],at=i[1],ut=i[2],wt=i[3],ht=i[4],gt=i[5],xt=i[6],vt=i[7],mt=i[8],bt=i[9],St=i[10],Tt=i[11],_t=i[12],Ut=i[13],It=i[14],Lt=i[15];return s[0]=f*rt+u*at+D*ut+R*wt,s[1]=g*rt+p*at+T*ut+O*wt,s[2]=b*rt+w*at+q*ut+Z*wt,s[3]=r*rt+M*at+Y*ut+K*wt,s[4]=f*ht+u*gt+D*xt+R*vt,s[5]=g*ht+p*gt+T*xt+O*vt,s[6]=b*ht+w*gt+q*xt+Z*vt,s[7]=r*ht+M*gt+Y*xt+K*vt,s[8]=f*mt+u*bt+D*St+R*Tt,s[9]=g*mt+p*bt+T*St+O*Tt,s[10]=b*mt+w*bt+q*St+Z*Tt,s[11]=r*mt+M*bt+Y*St+K*Tt,s[12]=f*_t+u*Ut+D*It+R*Lt,s[13]=g*_t+p*Ut+T*It+O*Lt,s[14]=b*_t+w*Ut+q*It+Z*Lt,s[15]=r*_t+M*Ut+Y*It+K*Lt,s}let st=ft;function lt(t,i,e){let s=e??W();return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11]),s[12]=i[0],s[13]=i[1],s[14]=i[2],s[15]=1,s}function dt(t,i){let e=i??n.create();return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Bt(t,i,e){let s=e??n.create(),f=i*4;return s[0]=t[f+0],s[1]=t[f+1],s[2]=t[f+2],s}function Mt(t,i,e,s){let f=s===t?s:A(t,s),g=e*4;return f[g+0]=i[0],f[g+1]=i[1],f[g+2]=i[2],f}function Dt(t,i){let e=i??n.create(),s=t[0],f=t[1],g=t[2],b=t[4],r=t[5],u=t[6],p=t[8],w=t[9],M=t[10];return e[0]=Math.sqrt(s*s+f*f+g*g),e[1]=Math.sqrt(b*b+r*r+u*u),e[2]=Math.sqrt(p*p+w*w+M*M),e}function zt(t,i,e,s,f){let g=f??new o(16),b=Math.tan(Math.PI*.5-.5*t);if(g[0]=b/i,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=b,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(s)){let r=1/(e-s);g[10]=s*r,g[14]=s*e*r}else g[10]=-1,g[14]=-e;return g}function Pt(t,i,e,s=1/0,f){let g=f??new o(16),b=1/Math.tan(t*.5);if(g[0]=b/i,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=b,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,s===1/0)g[10]=0,g[14]=e;else{let r=1/(s-e);g[10]=e*r,g[14]=s*e*r}return g}function Gt(t,i,e,s,f,g,b){let r=b??new o(16);return r[0]=2/(i-t),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(s-e),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1/(f-g),r[11]=0,r[12]=(i+t)/(t-i),r[13]=(s+e)/(e-s),r[14]=f/(f-g),r[15]=1,r}function pt(t,i,e,s,f,g,b){let r=b??new o(16),u=i-t,p=s-e,w=f-g;return r[0]=2*f/u,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2*f/p,r[6]=0,r[7]=0,r[8]=(t+i)/u,r[9]=(s+e)/p,r[10]=g/w,r[11]=-1,r[12]=0,r[13]=0,r[14]=f*g/w,r[15]=0,r}function Et(t,i,e,s,f,g=1/0,b){let r=b??new o(16),u=i-t,p=s-e;if(r[0]=2*f/u,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2*f/p,r[6]=0,r[7]=0,r[8]=(t+i)/u,r[9]=(s+e)/p,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,g===1/0)r[10]=0,r[14]=f;else{let w=1/(g-f);r[10]=f*w,r[14]=g*f*w}return r}let J=n.create(),et=n.create(),Q=n.create();function d(t,i,e,s){let f=s??new o(16);return n.normalize(n.subtract(i,t,Q),Q),n.normalize(n.cross(e,Q,J),J),n.normalize(n.cross(Q,J,et),et),f[0]=J[0],f[1]=J[1],f[2]=J[2],f[3]=0,f[4]=et[0],f[5]=et[1],f[6]=et[2],f[7]=0,f[8]=Q[0],f[9]=Q[1],f[10]=Q[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function z(t,i,e,s){let f=s??new o(16);return n.normalize(n.subtract(t,i,Q),Q),n.normalize(n.cross(e,Q,J),J),n.normalize(n.cross(Q,J,et),et),f[0]=J[0],f[1]=J[1],f[2]=J[2],f[3]=0,f[4]=et[0],f[5]=et[1],f[6]=et[2],f[7]=0,f[8]=Q[0],f[9]=Q[1],f[10]=Q[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function m(t,i,e,s){let f=s??new o(16);return n.normalize(n.subtract(t,i,Q),Q),n.normalize(n.cross(e,Q,J),J),n.normalize(n.cross(Q,J,et),et),f[0]=J[0],f[1]=et[0],f[2]=Q[0],f[3]=0,f[4]=J[1],f[5]=et[1],f[6]=Q[1],f[7]=0,f[8]=J[2],f[9]=et[2],f[10]=Q[2],f[11]=0,f[12]=-(J[0]*t[0]+J[1]*t[1]+J[2]*t[2]),f[13]=-(et[0]*t[0]+et[1]*t[1]+et[2]*t[2]),f[14]=-(Q[0]*t[0]+Q[1]*t[1]+Q[2]*t[2]),f[15]=1,f}function _(t,i){let e=i??new o(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function V(t,i,e){let s=e??new o(16),f=i[0],g=i[1],b=i[2],r=t[0],u=t[1],p=t[2],w=t[3],M=t[1*4+0],D=t[1*4+1],T=t[1*4+2],q=t[1*4+3],Y=t[2*4+0],R=t[2*4+1],O=t[2*4+2],Z=t[2*4+3],K=t[3*4+0],rt=t[3*4+1],at=t[3*4+2],ut=t[3*4+3];return t!==s&&(s[0]=r,s[1]=u,s[2]=p,s[3]=w,s[4]=M,s[5]=D,s[6]=T,s[7]=q,s[8]=Y,s[9]=R,s[10]=O,s[11]=Z),s[12]=r*f+M*g+Y*b+K,s[13]=u*f+D*g+R*b+rt,s[14]=p*f+T*g+O*b+at,s[15]=w*f+q*g+Z*b+ut,s}function E(t,i){let e=i??new o(16),s=Math.cos(t),f=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=f,e[7]=0,e[8]=0,e[9]=-f,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function H(t,i,e){let s=e??new o(16),f=t[4],g=t[5],b=t[6],r=t[7],u=t[8],p=t[9],w=t[10],M=t[11],D=Math.cos(i),T=Math.sin(i);return s[4]=D*f+T*u,s[5]=D*g+T*p,s[6]=D*b+T*w,s[7]=D*r+T*M,s[8]=D*u-T*f,s[9]=D*p-T*g,s[10]=D*w-T*b,s[11]=D*M-T*r,t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function j(t,i){let e=i??new o(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=0,e[2]=-f,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=f,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function k(t,i,e){let s=e??new o(16),f=t[0*4+0],g=t[0*4+1],b=t[0*4+2],r=t[0*4+3],u=t[2*4+0],p=t[2*4+1],w=t[2*4+2],M=t[2*4+3],D=Math.cos(i),T=Math.sin(i);return s[0]=D*f-T*u,s[1]=D*g-T*p,s[2]=D*b-T*w,s[3]=D*r-T*M,s[8]=D*u+T*f,s[9]=D*p+T*g,s[10]=D*w+T*b,s[11]=D*M+T*r,t!==s&&(s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function N(t,i){let e=i??new o(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=f,e[2]=0,e[3]=0,e[4]=-f,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function $(t,i,e){let s=e??new o(16),f=t[0*4+0],g=t[0*4+1],b=t[0*4+2],r=t[0*4+3],u=t[1*4+0],p=t[1*4+1],w=t[1*4+2],M=t[1*4+3],D=Math.cos(i),T=Math.sin(i);return s[0]=D*f+T*u,s[1]=D*g+T*p,s[2]=D*b+T*w,s[3]=D*r+T*M,s[4]=D*u-T*f,s[5]=D*p-T*g,s[6]=D*w-T*b,s[7]=D*M-T*r,t!==s&&(s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function C(t,i,e){let s=e??new o(16),f=t[0],g=t[1],b=t[2],r=Math.sqrt(f*f+g*g+b*b);f/=r,g/=r,b/=r;let u=f*f,p=g*g,w=b*b,M=Math.cos(i),D=Math.sin(i),T=1-M;return s[0]=u+(1-u)*M,s[1]=f*g*T+b*D,s[2]=f*b*T-g*D,s[3]=0,s[4]=f*g*T-b*D,s[5]=p+(1-p)*M,s[6]=g*b*T+f*D,s[7]=0,s[8]=f*b*T+g*D,s[9]=g*b*T-f*D,s[10]=w+(1-w)*M,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}let x=C;function P(t,i,e,s){let f=s??new o(16),g=i[0],b=i[1],r=i[2],u=Math.sqrt(g*g+b*b+r*r);g/=u,b/=u,r/=u;let p=g*g,w=b*b,M=r*r,D=Math.cos(e),T=Math.sin(e),q=1-D,Y=p+(1-p)*D,R=g*b*q+r*T,O=g*r*q-b*T,Z=g*b*q-r*T,K=w+(1-w)*D,rt=b*r*q+g*T,at=g*r*q+b*T,ut=b*r*q-g*T,wt=M+(1-M)*D,ht=t[0],gt=t[1],xt=t[2],vt=t[3],mt=t[4],bt=t[5],St=t[6],Tt=t[7],_t=t[8],Ut=t[9],It=t[10],Lt=t[11];return f[0]=Y*ht+R*mt+O*_t,f[1]=Y*gt+R*bt+O*Ut,f[2]=Y*xt+R*St+O*It,f[3]=Y*vt+R*Tt+O*Lt,f[4]=Z*ht+K*mt+rt*_t,f[5]=Z*gt+K*bt+rt*Ut,f[6]=Z*xt+K*St+rt*It,f[7]=Z*vt+K*Tt+rt*Lt,f[8]=at*ht+ut*mt+wt*_t,f[9]=at*gt+ut*bt+wt*Ut,f[10]=at*xt+ut*St+wt*It,f[11]=at*vt+ut*Tt+wt*Lt,t!==f&&(f[12]=t[12],f[13]=t[13],f[14]=t[14],f[15]=t[15]),f}let c=P;function a(t,i){let e=i??new o(16);return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function l(t,i,e){let s=e??new o(16),f=i[0],g=i[1],b=i[2];return s[0]=f*t[0*4+0],s[1]=f*t[0*4+1],s[2]=f*t[0*4+2],s[3]=f*t[0*4+3],s[4]=g*t[1*4+0],s[5]=g*t[1*4+1],s[6]=g*t[1*4+2],s[7]=g*t[1*4+3],s[8]=b*t[2*4+0],s[9]=b*t[2*4+1],s[10]=b*t[2*4+2],s[11]=b*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function h(t,i){let e=i??new o(16);return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function G(t,i,e){let s=e??new o(16);return s[0]=i*t[0*4+0],s[1]=i*t[0*4+1],s[2]=i*t[0*4+2],s[3]=i*t[0*4+3],s[4]=i*t[1*4+0],s[5]=i*t[1*4+1],s[6]=i*t[1*4+2],s[7]=i*t[1*4+3],s[8]=i*t[2*4+0],s[9]=i*t[2*4+1],s[10]=i*t[2*4+2],s[11]=i*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}return{create:v,set:y,fromMat3:B,fromQuat:S,negate:U,copy:A,clone:L,equalsApproximately:F,equals:I,identity:W,transpose:ot,inverse:tt,determinant:nt,invert:X,multiply:ft,mul:st,setTranslation:lt,getTranslation:dt,getAxis:Bt,setAxis:Mt,getScaling:Dt,perspective:zt,perspectiveReverseZ:Pt,ortho:Gt,frustum:pt,frustumReverseZ:Et,aim:d,cameraAim:z,lookAt:m,translation:_,translate:V,rotationX:E,rotateX:H,rotationY:j,rotateY:k,rotationZ:N,rotateZ:$,axisRotation:C,rotation:x,axisRotate:P,rotate:c,scaling:a,scale:l,uniformScaling:h,uniformScale:G}}var dn=new Map;function $o(o){let n=dn.get(o);return n||(n=No(o),dn.set(o,n)),n}function Yo(o){let n=_e(o);function v(x,P,c,a){let l=new o(4);return x!==void 0&&(l[0]=x,P!==void 0&&(l[1]=P,c!==void 0&&(l[2]=c,a!==void 0&&(l[3]=a)))),l}let y=v;function B(x,P,c,a,l){let h=l??new o(4);return h[0]=x,h[1]=P,h[2]=c,h[3]=a,h}function S(x,P,c){let a=c??new o(4),l=P*.5,h=Math.sin(l);return a[0]=h*x[0],a[1]=h*x[1],a[2]=h*x[2],a[3]=Math.cos(l),a}function U(x,P){let c=P??n.create(3),a=Math.acos(x[3])*2,l=Math.sin(a*.5);return l>ct?(c[0]=x[0]/l,c[1]=x[1]/l,c[2]=x[2]/l):(c[0]=1,c[1]=0,c[2]=0),{angle:a,axis:c}}function A(x,P){let c=pt(x,P);return Math.acos(2*c*c-1)}function L(x,P,c){let a=c??new o(4),l=x[0],h=x[1],G=x[2],t=x[3],i=P[0],e=P[1],s=P[2],f=P[3];return a[0]=l*f+t*i+h*s-G*e,a[1]=h*f+t*e+G*i-l*s,a[2]=G*f+t*s+l*e-h*i,a[3]=t*f-l*i-h*e-G*s,a}let F=L;function I(x,P,c){let a=c??new o(4),l=P*.5,h=x[0],G=x[1],t=x[2],i=x[3],e=Math.sin(l),s=Math.cos(l);return a[0]=h*s+i*e,a[1]=G*s+t*e,a[2]=t*s-G*e,a[3]=i*s-h*e,a}function W(x,P,c){let a=c??new o(4),l=P*.5,h=x[0],G=x[1],t=x[2],i=x[3],e=Math.sin(l),s=Math.cos(l);return a[0]=h*s-t*e,a[1]=G*s+i*e,a[2]=t*s+h*e,a[3]=i*s-G*e,a}function ot(x,P,c){let a=c??new o(4),l=P*.5,h=x[0],G=x[1],t=x[2],i=x[3],e=Math.sin(l),s=Math.cos(l);return a[0]=h*s+G*e,a[1]=G*s-h*e,a[2]=t*s+i*e,a[3]=i*s-t*e,a}function tt(x,P,c,a){let l=a??new o(4),h=x[0],G=x[1],t=x[2],i=x[3],e=P[0],s=P[1],f=P[2],g=P[3],b=h*e+G*s+t*f+i*g;b<0&&(b=-b,e=-e,s=-s,f=-f,g=-g);let r,u;if(1-b>ct){let p=Math.acos(b),w=Math.sin(p);r=Math.sin((1-c)*p)/w,u=Math.sin(c*p)/w}else r=1-c,u=c;return l[0]=r*h+u*e,l[1]=r*G+u*s,l[2]=r*t+u*f,l[3]=r*i+u*g,l}function nt(x,P){let c=P??new o(4),a=x[0],l=x[1],h=x[2],G=x[3],t=a*a+l*l+h*h+G*G,i=t?1/t:0;return c[0]=-a*i,c[1]=-l*i,c[2]=-h*i,c[3]=G*i,c}function X(x,P){let c=P??new o(4);return c[0]=-x[0],c[1]=-x[1],c[2]=-x[2],c[3]=x[3],c}function ft(x,P){let c=P??new o(4),a=x[0]+x[5]+x[10];if(a>0){let l=Math.sqrt(a+1);c[3]=.5*l;let h=.5/l;c[0]=(x[6]-x[9])*h,c[1]=(x[8]-x[2])*h,c[2]=(x[1]-x[4])*h}else{let l=0;x[5]>x[0]&&(l=1),x[10]>x[l*4+l]&&(l=2);let h=(l+1)%3,G=(l+2)%3,t=Math.sqrt(x[l*4+l]-x[h*4+h]-x[G*4+G]+1);c[l]=.5*t;let i=.5/t;c[3]=(x[h*4+G]-x[G*4+h])*i,c[h]=(x[h*4+l]+x[l*4+h])*i,c[G]=(x[G*4+l]+x[l*4+G])*i}return c}function st(x,P,c,a,l){let h=l??new o(4),G=x*.5,t=P*.5,i=c*.5,e=Math.sin(G),s=Math.cos(G),f=Math.sin(t),g=Math.cos(t),b=Math.sin(i),r=Math.cos(i);switch(a){case"xyz":h[0]=e*g*r+s*f*b,h[1]=s*f*r-e*g*b,h[2]=s*g*b+e*f*r,h[3]=s*g*r-e*f*b;break;case"xzy":h[0]=e*g*r-s*f*b,h[1]=s*f*r-e*g*b,h[2]=s*g*b+e*f*r,h[3]=s*g*r+e*f*b;break;case"yxz":h[0]=e*g*r+s*f*b,h[1]=s*f*r-e*g*b,h[2]=s*g*b-e*f*r,h[3]=s*g*r+e*f*b;break;case"yzx":h[0]=e*g*r+s*f*b,h[1]=s*f*r+e*g*b,h[2]=s*g*b-e*f*r,h[3]=s*g*r-e*f*b;break;case"zxy":h[0]=e*g*r-s*f*b,h[1]=s*f*r+e*g*b,h[2]=s*g*b+e*f*r,h[3]=s*g*r-e*f*b;break;case"zyx":h[0]=e*g*r-s*f*b,h[1]=s*f*r+e*g*b,h[2]=s*g*b-e*f*r,h[3]=s*g*r+e*f*b;break;default:throw new Error(`Unknown rotation order: ${a}`)}return h}function lt(x,P){let c=P??new o(4);return c[0]=x[0],c[1]=x[1],c[2]=x[2],c[3]=x[3],c}let dt=lt;function Bt(x,P,c){let a=c??new o(4);return a[0]=x[0]+P[0],a[1]=x[1]+P[1],a[2]=x[2]+P[2],a[3]=x[3]+P[3],a}function Mt(x,P,c){let a=c??new o(4);return a[0]=x[0]-P[0],a[1]=x[1]-P[1],a[2]=x[2]-P[2],a[3]=x[3]-P[3],a}let Dt=Mt;function zt(x,P,c){let a=c??new o(4);return a[0]=x[0]*P,a[1]=x[1]*P,a[2]=x[2]*P,a[3]=x[3]*P,a}let Pt=zt;function Gt(x,P,c){let a=c??new o(4);return a[0]=x[0]/P,a[1]=x[1]/P,a[2]=x[2]/P,a[3]=x[3]/P,a}function pt(x,P){return x[0]*P[0]+x[1]*P[1]+x[2]*P[2]+x[3]*P[3]}function Et(x,P,c,a){let l=a??new o(4);return l[0]=x[0]+c*(P[0]-x[0]),l[1]=x[1]+c*(P[1]-x[1]),l[2]=x[2]+c*(P[2]-x[2]),l[3]=x[3]+c*(P[3]-x[3]),l}function J(x){let P=x[0],c=x[1],a=x[2],l=x[3];return Math.sqrt(P*P+c*c+a*a+l*l)}let et=J;function Q(x){let P=x[0],c=x[1],a=x[2],l=x[3];return P*P+c*c+a*a+l*l}let d=Q;function z(x,P){let c=P??new o(4),a=x[0],l=x[1],h=x[2],G=x[3],t=Math.sqrt(a*a+l*l+h*h+G*G);return t>1e-5?(c[0]=a/t,c[1]=l/t,c[2]=h/t,c[3]=G/t):(c[0]=0,c[1]=0,c[2]=0,c[3]=1),c}function m(x,P){return Math.abs(x[0]-P[0])<ct&&Math.abs(x[1]-P[1])<ct&&Math.abs(x[2]-P[2])<ct&&Math.abs(x[3]-P[3])<ct}function _(x,P){return x[0]===P[0]&&x[1]===P[1]&&x[2]===P[2]&&x[3]===P[3]}function V(x){let P=x??new o(4);return P[0]=0,P[1]=0,P[2]=0,P[3]=1,P}let E=n.create(),H=n.create(),j=n.create();function k(x,P,c){let a=c??new o(4),l=n.dot(x,P);return l<-.999999?(n.cross(H,x,E),n.len(E)<1e-6&&n.cross(j,x,E),n.normalize(E,E),S(E,Math.PI,a),a):l>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(n.cross(x,P,E),a[0]=E[0],a[1]=E[1],a[2]=E[2],a[3]=1+l,z(a,a))}let N=new o(4),$=new o(4);function C(x,P,c,a,l,h){let G=h??new o(4);return tt(x,a,l,N),tt(P,c,l,$),tt(N,$,2*l*(1-l),G),G}return{create:v,fromValues:y,set:B,fromAxisAngle:S,toAxisAngle:U,angle:A,multiply:L,mul:F,rotateX:I,rotateY:W,rotateZ:ot,slerp:tt,inverse:nt,conjugate:X,fromMat:ft,fromEuler:st,copy:lt,clone:dt,add:Bt,subtract:Mt,sub:Dt,mulScalar:zt,scale:Pt,divScalar:Gt,dot:pt,lerp:Et,length:J,len:et,lengthSq:Q,lenSq:d,normalize:z,equalsApproximately:m,equals:_,identity:V,rotationTo:k,sqlerp:C}}var pn=new Map;function Xo(o){let n=pn.get(o);return n||(n=Yo(o),pn.set(o,n)),n}function Ho(o){function n(c,a,l,h){let G=new o(4);return c!==void 0&&(G[0]=c,a!==void 0&&(G[1]=a,l!==void 0&&(G[2]=l,h!==void 0&&(G[3]=h)))),G}let v=n;function y(c,a,l,h,G){let t=G??new o(4);return t[0]=c,t[1]=a,t[2]=l,t[3]=h,t}function B(c,a){let l=a??new o(4);return l[0]=Math.ceil(c[0]),l[1]=Math.ceil(c[1]),l[2]=Math.ceil(c[2]),l[3]=Math.ceil(c[3]),l}function S(c,a){let l=a??new o(4);return l[0]=Math.floor(c[0]),l[1]=Math.floor(c[1]),l[2]=Math.floor(c[2]),l[3]=Math.floor(c[3]),l}function U(c,a){let l=a??new o(4);return l[0]=Math.round(c[0]),l[1]=Math.round(c[1]),l[2]=Math.round(c[2]),l[3]=Math.round(c[3]),l}function A(c,a=0,l=1,h){let G=h??new o(4);return G[0]=Math.min(l,Math.max(a,c[0])),G[1]=Math.min(l,Math.max(a,c[1])),G[2]=Math.min(l,Math.max(a,c[2])),G[3]=Math.min(l,Math.max(a,c[3])),G}function L(c,a,l){let h=l??new o(4);return h[0]=c[0]+a[0],h[1]=c[1]+a[1],h[2]=c[2]+a[2],h[3]=c[3]+a[3],h}function F(c,a,l,h){let G=h??new o(4);return G[0]=c[0]+a[0]*l,G[1]=c[1]+a[1]*l,G[2]=c[2]+a[2]*l,G[3]=c[3]+a[3]*l,G}function I(c,a,l){let h=l??new o(4);return h[0]=c[0]-a[0],h[1]=c[1]-a[1],h[2]=c[2]-a[2],h[3]=c[3]-a[3],h}let W=I;function ot(c,a){return Math.abs(c[0]-a[0])<ct&&Math.abs(c[1]-a[1])<ct&&Math.abs(c[2]-a[2])<ct&&Math.abs(c[3]-a[3])<ct}function tt(c,a){return c[0]===a[0]&&c[1]===a[1]&&c[2]===a[2]&&c[3]===a[3]}function nt(c,a,l,h){let G=h??new o(4);return G[0]=c[0]+l*(a[0]-c[0]),G[1]=c[1]+l*(a[1]-c[1]),G[2]=c[2]+l*(a[2]-c[2]),G[3]=c[3]+l*(a[3]-c[3]),G}function X(c,a,l,h){let G=h??new o(4);return G[0]=c[0]+l[0]*(a[0]-c[0]),G[1]=c[1]+l[1]*(a[1]-c[1]),G[2]=c[2]+l[2]*(a[2]-c[2]),G[3]=c[3]+l[3]*(a[3]-c[3]),G}function ft(c,a,l){let h=l??new o(4);return h[0]=Math.max(c[0],a[0]),h[1]=Math.max(c[1],a[1]),h[2]=Math.max(c[2],a[2]),h[3]=Math.max(c[3],a[3]),h}function st(c,a,l){let h=l??new o(4);return h[0]=Math.min(c[0],a[0]),h[1]=Math.min(c[1],a[1]),h[2]=Math.min(c[2],a[2]),h[3]=Math.min(c[3],a[3]),h}function lt(c,a,l){let h=l??new o(4);return h[0]=c[0]*a,h[1]=c[1]*a,h[2]=c[2]*a,h[3]=c[3]*a,h}let dt=lt;function Bt(c,a,l){let h=l??new o(4);return h[0]=c[0]/a,h[1]=c[1]/a,h[2]=c[2]/a,h[3]=c[3]/a,h}function Mt(c,a){let l=a??new o(4);return l[0]=1/c[0],l[1]=1/c[1],l[2]=1/c[2],l[3]=1/c[3],l}let Dt=Mt;function zt(c,a){return c[0]*a[0]+c[1]*a[1]+c[2]*a[2]+c[3]*a[3]}function Pt(c){let a=c[0],l=c[1],h=c[2],G=c[3];return Math.sqrt(a*a+l*l+h*h+G*G)}let Gt=Pt;function pt(c){let a=c[0],l=c[1],h=c[2],G=c[3];return a*a+l*l+h*h+G*G}let Et=pt;function J(c,a){let l=c[0]-a[0],h=c[1]-a[1],G=c[2]-a[2],t=c[3]-a[3];return Math.sqrt(l*l+h*h+G*G+t*t)}let et=J;function Q(c,a){let l=c[0]-a[0],h=c[1]-a[1],G=c[2]-a[2],t=c[3]-a[3];return l*l+h*h+G*G+t*t}let d=Q;function z(c,a){let l=a??new o(4),h=c[0],G=c[1],t=c[2],i=c[3],e=Math.sqrt(h*h+G*G+t*t+i*i);return e>1e-5?(l[0]=h/e,l[1]=G/e,l[2]=t/e,l[3]=i/e):(l[0]=0,l[1]=0,l[2]=0,l[3]=0),l}function m(c,a){let l=a??new o(4);return l[0]=-c[0],l[1]=-c[1],l[2]=-c[2],l[3]=-c[3],l}function _(c,a){let l=a??new o(4);return l[0]=c[0],l[1]=c[1],l[2]=c[2],l[3]=c[3],l}let V=_;function E(c,a,l){let h=l??new o(4);return h[0]=c[0]*a[0],h[1]=c[1]*a[1],h[2]=c[2]*a[2],h[3]=c[3]*a[3],h}let H=E;function j(c,a,l){let h=l??new o(4);return h[0]=c[0]/a[0],h[1]=c[1]/a[1],h[2]=c[2]/a[2],h[3]=c[3]/a[3],h}let k=j;function N(c){let a=c??new o(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a}function $(c,a,l){let h=l??new o(4),G=c[0],t=c[1],i=c[2],e=c[3];return h[0]=a[0]*G+a[4]*t+a[8]*i+a[12]*e,h[1]=a[1]*G+a[5]*t+a[9]*i+a[13]*e,h[2]=a[2]*G+a[6]*t+a[10]*i+a[14]*e,h[3]=a[3]*G+a[7]*t+a[11]*i+a[15]*e,h}function C(c,a,l){let h=l??new o(4);return z(c,h),lt(h,a,h)}function x(c,a,l){let h=l??new o(4);return Pt(c)>a?C(c,a,h):_(c,h)}function P(c,a,l){let h=l??new o(4);return nt(c,a,.5,h)}return{create:n,fromValues:v,set:y,ceil:B,floor:S,round:U,clamp:A,add:L,addScaled:F,subtract:I,sub:W,equalsApproximately:ot,equals:tt,lerp:nt,lerpV:X,max:ft,min:st,mulScalar:lt,scale:dt,divScalar:Bt,inverse:Mt,invert:Dt,dot:zt,length:Pt,len:Gt,lengthSq:pt,lenSq:Et,distance:J,dist:et,distanceSq:Q,distSq:d,normalize:z,negate:m,copy:_,clone:V,multiply:E,mul:H,divide:j,div:k,zero:N,transformMat4:$,setLength:C,truncate:x,midpoint:P}}var wn=new Map;function jo(o){let n=wn.get(o);return n||(n=Ho(o),wn.set(o,n)),n}function Pe(o,n,v,y,B,S){return{mat4:$o(o),mat3:Vo(n),quat:Xo(v),vec2:hn(y),vec3:_e(B),vec4:jo(S)}}var{mat4:Nt,mat3:Xr,quat:Hr,vec2:jr,vec3:Wr,vec4:Zr}=Pe(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat4:Qr,mat3:kr,quat:Kr,vec2:Jr,vec3:Cr,vec4:ti}=Pe(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat4:ei,mat3:ni,quat:oi,vec2:si,vec3:ri,vec4:ii}=Pe(Fo,Array,Array,Array,Array,Array);var fe=class{invViewProjectionMatrix=Nt.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(n){this.setViewportSize(n.viewportSize.width,n.viewportSize.height);let v=n.center??this.topLeft;this.setTopLeft(...v);let y=n.zoom??1;this.setZoom(y)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(n,v){this.viewportSize.width=n,this.viewportSize.height=v,this.updateMatrices()}setTopLeft(n,v){this.topLeft[0]=n,this.topLeft[1]=v,this.updateMatrices()}setZoom(n){this.zoom=n,this.updateMatrices()}updateMatrices(){Nt.identity(this.invViewProjectionMatrix),Nt.multiply(Nt.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var Vt=class o{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(n,v){this.device=n,this.maxLightsCount=v;let y=new ArrayBuffer(o.computeBufferBytesLength(v)),B=n.createBuffer({label:"LightsBuffer buffer",size:y.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:y,bufferGpu:B},this.setLights([])}setLights(n){if(n.length>this.maxLightsCount)throw new Error(`Too many lights "${n.length}", max is "${this.maxLightsCount}".`);let v=o.computeBufferBytesLength(n.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([n.length]),n.forEach((y,B)=>{new Float32Array(this.buffer.bufferCpu,o.structs.lightsBuffer.lights.offset+o.structs.lightsBuffer.lights.stride*B,9).set([...y.color,y.radius,...y.position,y.intensity,y.attenuationLinear,y.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,v),this.currentLightsCount=n.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(n){return o.structs.lightsBuffer.lights.offset+o.structs.lightsBuffer.lights.stride*n}};var le=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(n,v,y,B){this.lightsBuffer=v;let S=n.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${Vt.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${y.gridSize.x}, ${y.gridSize.y});
const cellsGridSizeF = vec2<f32>(${y.gridSize.x}, ${y.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${B}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=n.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:S,entryPoint:"main_vertex"},fragment:{module:S,entryPoint:"main_fragment",targets:[{format:y.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:y.sampleCount}}),this.bindgroup=n.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let U=n.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[y.format],sampleCount:y.sampleCount});U.setPipeline(this.renderPipeline),U.setBindGroup(0,this.bindgroup),U.draw(4),this.renderBundle=U.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var de=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(n,v,y,B){this.device=n,this.lightsBuffer=v;let S=!0,U=n.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${y.gridSize.x}, ${y.gridSize.y});
const cellsGridSizeF = vec2<f32>(${y.gridSize.x}, ${y.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${B});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=n.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:U,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:Vt.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:Vt.structs.light.position.offset,format:"float32x2"}],arrayStride:Vt.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:U,entryPoint:"main_fragment",targets:[{format:y.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:S?"none":"back",topology:"triangle-list"},multisample:{count:y.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:n.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[y.format],sampleCount:y.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(n){let v=[],y=[];for(let F of n){let I=v.length/3;v.push(...F[0],0,...F[1],0,...F[0],1,...F[1],1),y.push(I+0,I+1,I+3,I+0,I+3,I+2)}let B=!1,S=new Float32Array(v),U=this.obstacles?.positionsBufferGpu;(!U||U.size<S.byteLength)&&(U?.destroy(),U=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:S.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),B=!0),this.device.queue.writeBuffer(U,0,S);let A=new Uint16Array(y),L=this.obstacles?.indexBufferGpu;(!L||L.size<A.byteLength)&&(L?.destroy(),L=this.device.createBuffer({label:"LightsTextureMask index buffer",size:A.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),B=!0),this.device.queue.writeBuffer(L,0,A),this.obstacles={positionsBufferGpu:U,indexBufferGpu:L},this.setIndirectIndexCount(y.length),B&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(n){this.setIndirectInstanceCount(n)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(n){let v=new Uint32Array(this.indirectDrawing.bufferCpu);v[0]!==n&&(v[0]=n,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(n){let v=new Uint32Array(this.indirectDrawing.bufferCpu);v[1]!==n&&(v[1]=n,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let n=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(n.setPipeline(this.renderPipeline),n.setVertexBuffer(0,this.obstacles.positionsBufferGpu),n.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,Vt.structs.lightsBuffer.lights.offset),n.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),n.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),n.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var pe=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(n,v,y){this.lightsBuffer=v;let B=this.lightsBuffer.maxLightsCount/4,S={x:Math.ceil(Math.sqrt(B)),y:0};S.y=Math.ceil(B/S.x),this.gridSize=S;let U={width:S.x*y.resolutionPerLight,height:S.y*y.resolutionPerLight},A="rgba8unorm";this.texture=n.createTexture({label:"LightsTextureMask texture",size:[U.width,U.height],format:A,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),y.antialiased&&(this.textureMultisampled=n.createTexture({label:"LightsTextureMask texture multisampled",size:[U.width,U.height],format:A,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let F={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};y.antialiased&&(F.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[F]};let I={gridSize:S,format:A,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new le(n,v,I,y.maxLightSize),this.textureMask=new de(n,v,I,y.maxLightSize)}update(n){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let v=n.beginRenderPass(this.textureRenderpassDescriptor),[y,B]=[this.texture.width,this.texture.height];v.setViewport(0,0,y,B,0,1),v.setScissorRect(0,0,y,B),v.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),v.end()}setObstacles(n){this.textureMask.setObstacles(n)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var we=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(n){this.device=n.device,this.targetTexture=n.targetTexture,this.lightsBuffer=n.lightsBuffer,this.lightsTexture=new pe(n.device,n.lightsBuffer,n.lightsTextureProperties),this.uniformsBufferGpu=n.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let v=n.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${Vt.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/n.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${n.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=n.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:v,entryPoint:"main_vertex"},fragment:{module:v,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let y=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=n.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:y,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:n.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:n.lightsTextureProperties.filtering,minFilter:n.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(n.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(n){this.lightsTexture.update(n)}render(n,v){let y=new ArrayBuffer(80);new Float32Array(y,0,16).set(v),new Float32Array(y,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,y),n.executeBundles([this.renderBundle])}setAlbedo(n){this.bindgroup1=this.buildBindgroup1(n),this.renderBundle=this.buildRenderBundle()}setAmbientLight(n){this.ambientLight=[...n]}setObstacles(n){this.lightsTexture.setObstacles(n)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(n){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:n.view},{binding:1,resource:n.sampler}]})}buildRenderBundle(){let n=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return n.setPipeline(this.renderPipeline),n.setBindGroup(0,this.bindgroup0),n.setBindGroup(1,this.bindgroup1),n.draw(4),n.finish({label:"LightsRenderer renderbundle"})}};var gn={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(o,n={}){return Zo(o,n)},onRun:function(o,n,v){Qo(o,n,v)},onDestroy:function(o,n){ko(n)},onResize:function(o,n){Ko(o,n)},onViewportPosition:function(o,n){n.data.viewport.setTopLeft(...o.viewport.position)},customFunctions:{...Te}};async function Zo(o,n){let{device:v}=o,y=256,B=256,S=new Vt(v,y),U=new fe({viewportSize:{width:o.viewport.width,height:o.viewport.height},center:o.viewport.position,zoom:o.viewport.zoom}),A=new we({device:v,albedo:{view:n.refs.in.data.view,sampler:n.refs.in.data.sampler},targetTexture:n.refs.out.data.texture,lightsBuffer:S,lightsTextureProperties:{resolutionPerLight:B,maxLightSize:B,antialiased:!1,filtering:"nearest"}});return{lightsBuffer:S,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:A,viewport:U,lights:[]}}function Qo(o,n,v){n.data.lightsBufferNeedsUpdate&&(n.data.lightsBuffer.setLights(n.data.lights),n.data.lightsBufferNeedsUpdate=!1,n.data.lightsTextureNeedsUpdate=!0);let y=n.data.lightsRenderer;n.data.lightsTextureNeedsUpdate&&(y.computeLightsTexture(v),n.data.lightsTextureNeedsUpdate=!1);let B=v.beginRenderPass({colorAttachments:[{view:n.refs.out.data.view,clearValue:o.clearValue,loadOp:"load",storeOp:"store"}]});n.data.viewport.setZoom(o.viewport.zoom);let S=n.data.viewport.invertViewProjectionMatrix;y.render(B,S),B.end()}function ko(o){o.data.lightsBuffer.destroy(),o.data.lightsRenderer.destroy()}function Ko(o,n){n.data.lightsRenderer.setAlbedo({view:n.refs.in.data.view,sampler:n.refs.in.data.sampler}),n.data.viewport.setViewportSize(o.viewport.width,o.viewport.height)}var Be="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var kt=new Float32Array(8),vn={type:"cobalt:tileAtlas",refs:[],onInit:async function(o,n={}){return Co(o,n)},onRun:function(o,n,v){},onDestroy:function(o,n){ts(data)},onResize:function(o,n){xn(o,n)},onViewportPosition:function(o,n){xn(o,n)}};async function Co(o,n){let{device:v}=o,y=await $t(o,"tile atlas",n.options.textureUrl),B=v.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),S=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),U=v.createBindGroup({layout:S,entries:[{binding:0,resource:{buffer:B}},{binding:1,resource:y.view},{binding:2,resource:y.sampler}]}),A=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),L=v.createPipelineLayout({bindGroupLayouts:[A,S]});return{pipeline:v.createRenderPipeline({label:"tile",vertex:{module:v.createShaderModule({code:Be}),entryPoint:"vs_main",buffers:[]},fragment:{module:v.createShaderModule({code:Be}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:L}),uniformBuffer:B,atlasBindGroup:U,atlasMaterial:y,tileBindGroupLayout:A,tileSize:n.options.tileSize,tileScale:n.options.tileScale}}function ts(o){o.atlasMaterial.texture.destroy(),o.atlasMaterial.texture=void 0}function xn(o,n){kt[0]=o.viewport.position[0],kt[1]=o.viewport.position[1];let v=n.data,{tileScale:y,tileSize:B}=v,S=o.viewport.width/o.viewport.zoom,U=o.viewport.height/o.viewport.zoom;kt[2]=S/y,kt[3]=U/y,kt[4]=1/v.atlasMaterial.texture.width,kt[5]=1/v.atlasMaterial.texture.height,kt[6]=B,kt[7]=1/B,o.device.queue.writeBuffer(v.uniformBuffer,0,kt,0,8)}function he(o){let v=Object.keys(o.frames).length,y=new Float32Array(v*30),B=[],S={},U=0;for(let A in o.frames){let L=o.frames[A];B.push(A),S[A]=L.sourceSize;let F=-.5+L.spriteSourceSize.x/L.sourceSize.w,I=-.5+L.spriteSourceSize.y/L.sourceSize.h,W=-.5+(L.spriteSourceSize.x+L.spriteSourceSize.w)/L.sourceSize.w,ot=-.5+(L.spriteSourceSize.y+L.spriteSourceSize.h)/L.sourceSize.h,tt=[F,I,0],nt=[F,ot,0],X=[W,ot,0],ft=[W,I,0],st=0+L.frame.x/o.meta.size.w,lt=0+L.frame.y/o.meta.size.h,dt=0+(L.frame.x+L.frame.w)/o.meta.size.w,Bt=0+(L.frame.y+L.frame.h)/o.meta.size.h,Mt=[st,lt],Dt=[st,Bt],zt=[dt,Bt],Pt=[dt,lt];y.set(tt,U),y.set(Mt,U+3),y.set(nt,U+5),y.set(Dt,U+8),y.set(X,U+10),y.set(zt,U+13),y.set(tt,U+15),y.set(Mt,U+18),y.set(X,U+20),y.set(zt,U+23),y.set(ft,U+25),y.set(Pt,U+28),U+=30}return{spriteMeta:S,locations:B,vertices:y}}var ze="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var mn=Ot.create(0,0,0),Mn={type:"cobalt:spritesheet",refs:[],onInit:async function(o,n={}){return ns(o,n)},onRun:function(o,n,v){},onDestroy:function(o,n){os(n)},onResize:function(o,n){yn(o,n)},onViewportPosition:function(o,n){yn(o,n)}};async function ns(o,n){let{canvas:v,device:y}=o,B,S,U;v?(B=await ss(n.options.spriteSheetJsonUrl),B=he(B),S=await $t(o,"sprite",n.options.colorTextureUrl,"rgba8unorm"),U=await $t(o,"emissive sprite",n.options.emissiveTextureUrl,"rgba8unorm"),v.style.imageRendering="pixelated"):(B=he(n.options.spriteSheetJson),S=await oe(o,"sprite",n.options.colorTexture,"rgba8unorm"),U=await oe(o,"emissive sprite",n.options.emissiveTexture,"rgba8unorm"));let A=De(y,B),L=y.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),F=y.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),I=y.createPipelineLayout({bindGroupLayouts:[F]});return{pipeline:y.createRenderPipeline({label:"sprite",vertex:{module:y.createShaderModule({code:ze}),entryPoint:"vs_main",buffers:[A.bufferLayout]},fragment:{module:y.createShaderModule({code:ze}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:I}),uniformBuffer:L,quads:A,colorTexture:S,emissiveTexture:U,bindGroupLayout:F,spritesheet:B}}function os(o){o.data.quads.buffer.destroy(),o.data.colorTexture.buffer.destroy(),o.data.uniformBuffer.destroy(),o.data.emissiveTexture.texture.destroy()}async function ss(o){return(await fetch(o)).json()}function yn(o,n){let{device:v,viewport:y}=o,B=y.width/y.zoom,S=y.height/y.zoom,U=Rt.ortho(0,B,S,0,-10,10);Ot.set(-y.position[0],-y.position[1],0,mn);let A=Rt.translation(mn);v.queue.writeBuffer(n.data.uniformBuffer,0,A.buffer),v.queue.writeBuffer(n.data.uniformBuffer,64,U.buffer)}var Dn={type:"fbTexture",refs:[],onInit:async function(o,n={}){return rs(o,n)},onRun:function(o,n,v){},onDestroy:function(o,n){bn(data)},onResize:function(o,n){is(o,n)},onViewportPosition:function(o,n){}};async function rs(o,n){let{device:v}=o,{label:y,mip_count:B,format:S,usage:U,viewportScale:A}=n.options;return Ft(v,y,o.viewport.width*A,o.viewport.height*A,B,S,U)}function bn(o){o.data.texture.destroy()}function is(o,n){let{device:v}=o;bn(n);let{width:y,height:B}=o.viewport,{options:S}=n,U=n.options.viewportScale;n.data=Ft(v,S.label,y*U,B*U,S.mip_count,S.format,S.usage)}async function Ji(o,n,v){let y,B,S,U;return o.sdlWindow&&o.gpu?(B=o.gpu,y=await(await B.create(["verbose=1"]).requestAdapter()).requestDevice(),S=B.renderGPUDeviceToWindow({device:y,window:o.sdlWindow}),global.GPUBufferUsage=B.GPUBufferUsage,global.GPUShaderStage=B.GPUShaderStage,global.GPUTextureUsage=B.GPUTextureUsage):(U=o,y=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),B=navigator.gpu,S=U.getContext("webgpu"),S.configure({device:y,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":vn,"cobalt:spritesheet":Mn,"cobalt:fbTexture":Dn,"cobalt:bloom":Ee,"cobalt:composite":Re,"cobalt:sprite":qe,"cobalt:tile":$e,"cobalt:displacement":Ke,"cobalt:overlay":en,"cobalt:fbBlit":nn,"cobalt:primitives":an,"cobalt:light":gn},nodes:[],defaultTextureViewRefs:[],canvas:U,device:y,context:S,gpu:B,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:n,height:v,zoom:1,position:[0,0]}}}function Ci(o,n){if(!n?.type)throw new Error("Can't define a new node missing a type.");o.nodeDefs[n.type]=n}async function tc(o,n){let v=o.nodeDefs[n?.type];if(!v)throw new Error("Can't initialize a new node missing a type.");let y={type:n.type,refs:n.refs||{},options:n.options||{},data:{},enabled:!0};for(let S in y.refs)y.refs[S]==="FRAME_TEXTURE_VIEW"&&(o.defaultTextureViewRefs.push({node:y,refName:S}),y.refs[S]=Sn(o));y.data=await v.onInit(o,y);let B=v.customFunctions||{};for(let S in B)y[S]=function(...U){return B[S](o,y,...U)};return o.nodes.push(y),y}function ec(o){let{device:n,context:v}=o,y=n.createCommandEncoder(),B=Sn(o);for(let S of o.defaultTextureViewRefs)S.node.refs[S.refName]=B;for(let S of o.nodes){if(!S.enabled)continue;o.nodeDefs[S.type].onRun(o,S,y)}n.queue.submit([y.finish()]),o.canvas||o.context.swap()}function nc(o){for(let n of o.nodes)o.nodeDefs[n.type].onDestroy(o,n);o.nodes.length=0,o.defaultTextureViewRefs.length=0}function oc(o,n,v){o.viewport.width=n,o.viewport.height=v;for(let y of o.nodes)o.nodeDefs[y.type].onResize(o,y)}function sc(o,n){o.viewport.position[0]=n[0]-o.viewport.width/2/o.viewport.zoom,o.viewport.position[1]=n[1]-o.viewport.height/2/o.viewport.zoom;for(let v of o.nodes)o.nodeDefs[v.type].onViewportPosition(o,v)}function Oe(o){return o.canvas?navigator.gpu.getPreferredCanvasFormat():o.context.getPreferredFormat()}function Sn(o){return o.canvas?o.context.getCurrentTexture().createView():o.context.getCurrentTextureView()}export{Ft as createTexture,oe as createTextureFromBuffer,$t as createTextureFromUrl,Ci as defineNode,ec as draw,Sn as getCurrentTextureView,Oe as getPreferredFormat,Ji as init,tc as initNode,nc as reset,oc as setViewportDimensions,sc as setViewportPosition};

var Pn=Object.defineProperty;var Ue=(r,o)=>{for(var v in o)Pn(r,v,{get:o[v],enumerable:!0})};function Rt(r,o,v,m,P,T,_){let G=r.createTexture({label:o,size:{width:v,height:m},format:T,usage:_,mipLevelCount:P,sampleCount:1,dimension:"2d"}),z=G.createView(),U=[];for(let R=0;R<P;R++)U.push(G.createView({label:o,format:T,dimension:"2d",aspect:"all",baseMipLevel:R,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let B=r.createSampler({label:`${o} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:v,height:m},texture:G,view:z,mip_view:U,sampler:B}}async function Yt(r,o,v,m="rgba8unorm"){let T=await(await fetch(v)).blob(),_=await createImageBitmap(T),G=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,U=Rt(r.device,o,_.width,_.height,1,m,G);r.device.queue.copyExternalImageToTexture({source:_},{texture:U.texture},{width:_.width,height:_.height});let B={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return U.sampler=r.device.createSampler(B),U}function oe(r,o,v,m="rgba8unorm"){let P=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,_=Rt(r.device,o,v.width,v.height,1,m,P);r.device.queue.writeTexture({texture:_.texture},v.data,{bytesPerRow:4*v.width},{width:v.width,height:v.height});let G={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return _.sampler=r.device.createSampler(G),_}var Le="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var qt=7,Bn=0,Ee=1,zn=2,Ie=3,Ae={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(r,o={}){return Gn(r,o)},onRun:function(r,o,v){Un(r,o.data,v)},onDestroy:function(r,o){Re(o)},onResize:function(r,o){Ln(r,o)},onViewportPosition:function(r,o){}};function Gn(r,o){let{device:v}=r,m=r.viewport.width,P=r.viewport.height,T={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},_=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});T.bind_group_layout.push(_),T.bind_groups_textures.push(Rt(v,"bloom downsampler image 0",m/2,P/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),T.bind_groups_textures.push(Rt(v,"bloom downsampler image 1",m/2,P/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),T.bind_groups_textures.push(o.refs.bloom.data);let G=v.createPipelineLayout({bindGroupLayouts:T.bind_group_layout}),z=v.createComputePipeline({layout:G,compute:{module:v.createShaderModule({code:Le}),entryPoint:"cs_main"}});return Fe(r,T,o),T.compute_pipeline=z,T}function Fe(r,o,v){let{refs:m}=v,{device:P}=r,T=v.options.bloom_threshold??.1,_=v.options.bloom_knee??.2,G=v.options.bloom_combine_constant??.68,z=new Float32Array([T,T-_,_*2,.25/_,G,0,0,0]),U=P.createBuffer({label:"bloom static parameters buffer",size:z.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(U.getMappedRange()).set(z),U.unmap(),o.bind_group.length=0,o.params_buf=U,o.bind_group.push(Jt(P,o,o.bind_groups_textures[0].mip_view[0],m.emissive.data.view,m.hdr.data.view,m.hdr.data.sampler,U,Bn<<16|0));for(let R=1;R<qt;R++)o.bind_group.push(Jt(P,o,o.bind_groups_textures[1].mip_view[R],o.bind_groups_textures[0].view,m.hdr.data.view,m.hdr.data.sampler,U,Ee<<16|R-1)),o.bind_group.push(Jt(P,o,o.bind_groups_textures[0].mip_view[R],o.bind_groups_textures[1].view,m.hdr.data.view,m.hdr.data.sampler,U,Ee<<16|R));o.bind_group.push(Jt(P,o,o.bind_groups_textures[2].mip_view[qt-1],o.bind_groups_textures[0].view,m.hdr.data.view,m.hdr.data.sampler,U,zn<<16|qt-2));let B=!0;for(let R=qt-2;R>=0;R--)B?(o.bind_group.push(Jt(P,o,o.bind_groups_textures[1].mip_view[R],o.bind_groups_textures[0].view,o.bind_groups_textures[2].view,m.hdr.data.sampler,U,Ie<<16|R)),B=!1):(o.bind_group.push(Jt(P,o,o.bind_groups_textures[2].mip_view[R],o.bind_groups_textures[0].view,o.bind_groups_textures[1].view,m.hdr.data.sampler,U,Ie<<16|R)),B=!0)}function Jt(r,o,v,m,P,T,_,G){let z=new Uint32Array([G]),U=r.createBuffer({label:"bloom static mode_lod buffer",size:z.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(U.getMappedRange()).set(z),U.unmap(),r.createBindGroup({label:"bloom bind group layout",layout:o.bind_group_layout[0],entries:[{binding:0,resource:v},{binding:1,resource:m},{binding:2,resource:P},{binding:3,resource:T},{binding:4,resource:{buffer:_}},{binding:5,resource:{buffer:U}}]})}function Un(r,o,v){let G=0,z=v.beginComputePass({label:"bloom Compute Pass"});z.setPipeline(o.compute_pipeline),z.setBindGroup(0,o.bind_group[G]),G+=1;let U=ce(0,o.bind_groups_textures[0]);z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);for(let B=1;B<qt;B++)U=ce(B,o.bind_groups_textures[0]),z.setBindGroup(0,o.bind_group[G]),G+=1,z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1),z.setBindGroup(0,o.bind_group[G]),G+=1,z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);z.setBindGroup(0,o.bind_group[G]),G+=1,U=ce(qt-1,o.bind_groups_textures[2]),z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);for(let B=qt-2;B>=0;B--)U=ce(B,o.bind_groups_textures[2]),z.setBindGroup(0,o.bind_group[G]),G+=1,z.dispatchWorkgroups(U.width/8+1,U.height/4+1,1);z.end()}function ce(r,o){let v=o.size.width,m=o.size.height;for(let P=0;P<r;P++)v/=2,m/=2;return{width:v,height:m,depthOrArrayLayers:1}}function Ln(r,o){let{device:v}=r,m=o.data;Re(m),m.bind_groups_textures.push(Rt(v,"bloom downsampler image 0",r.viewport.width/2,r.viewport.height/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),m.bind_groups_textures.push(Rt(v,"bloom downsampler image 1",r.viewport.width/2,r.viewport.height/2,qt,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),m.bind_groups_textures.push(o.refs.bloom.data),Fe(r,m,o)}function Re(r){for(let o of r.bind_groups_textures)o.texture.destroy();r.bind_groups_textures.length=0}var me="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Oe={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(r,o={}){return In(r,o)},onRun:function(r,o,v){An(r,o,v)},onDestroy:function(r,o){},onResize:function(r,o){Fn(r,o)},onViewportPosition:function(r,o){}};function In(r,o){let{options:v,refs:m}=o,{device:P}=r,T=Ve(r),_=v.bloom_intensity??40,G=v.bloom_combine_constant??.68,z=new Float32Array([_,G]),U=P.createBuffer({label:"scene composite params buffer",size:z.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(U.getMappedRange()).set(z),U.unmap();let B=P.createRenderPipeline({layout:"auto",vertex:{module:P.createShaderModule({code:me}),entryPoint:"vert_main"},fragment:{module:P.createShaderModule({code:me}),entryPoint:"frag_main",targets:[{format:T}]},primitive:{topology:"triangle-list"}});return{bindGroup:P.createBindGroup({layout:B.getBindGroupLayout(0),entries:[{binding:0,resource:m.hdr.data.sampler},{binding:1,resource:m.hdr.data.view},{binding:2,resource:m.bloom.data.mip_view[0]},{binding:3,resource:{buffer:U}}]}),pipeline:B,params_buf:U}}function An(r,o,v){let m=v.beginRenderPass({colorAttachments:[{view:o.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:P,bindGroup:T}=o.data;m.setPipeline(P),m.setBindGroup(0,T),m.draw(3),m.end()}function Fn(r,o){let{pipeline:v,params_buf:m}=o.data,{device:P}=r;o.data.bindGroup=P.createBindGroup({layout:v.getBindGroupLayout(0),entries:[{binding:0,resource:o.refs.hdr.data.sampler},{binding:1,resource:o.refs.hdr.data.view},{binding:2,resource:o.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:m}}]})}var re={};Ue(re,{addSprite:()=>On,clear:()=>qn,removeSprite:()=>Vn,setSprite:()=>Wn,setSpriteName:()=>Nn,setSpriteOpacity:()=>Xn,setSpritePosition:()=>Yn,setSpriteRotation:()=>Hn,setSpriteTint:()=>$n});function ye(r,o,v){if(v.spriteCount===0)return 0;let m=0,P=v.spriteCount-1,T=r<<16&16711680|o&65535;for(;m<=P;){let _=v.spriteData[m*12+11];if(T<=_)return m;let G=v.spriteData[P*12+11];if(T>=G)return P+1;let z=Math.floor((m+P)/2),U=v.spriteData[z*12+11];if(T===U)return z+1;T>U?m=z+1:P=z-1}return m}function se(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function On(r,o,v,m,P,T,_,G,z){let U=o.refs.spritesheet.data.spritesheet;o=o.data;let B=U.locations.indexOf(v),R=ye(z,B,o),X=(R+1)*12;o.spriteData.set(o.spriteData.subarray(R*12,o.spriteCount*12),X),qe(o,U,R,v,m,P,T,_,G,z);for(let[H,F]of o.spriteIndices)F>=R&&o.spriteIndices.set(H,F+1);let Y=se();return o.spriteIndices.set(Y,R),o.spriteCount++,o.dirty=!0,Y}function Vn(r,o,v){o=o.data;let m=o.spriteIndices.get(v);for(let[T,_]of o.spriteIndices)_>m&&o.spriteIndices.set(T,_-1);let P=m*12;o.spriteData.set(o.spriteData.subarray((m+1)*12,o.spriteCount*12),P),o.spriteIndices.delete(v),o.spriteCount--,o.dirty=!0}function qn(r,o){o=o.data,o.spriteIndices.clear(),o.spriteCount=0,o.instancedDrawCallCount=0,o.dirty=!0}function Nn(r,o,v,m,P){let T=o.refs.spritesheet.data.spritesheet;o=o.data;let _=T.locations.indexOf(m),G=T.spriteMeta[m].w,z=T.spriteMeta[m].h,B=o.spriteIndices.get(v)*12;o.spriteData[B+2]=G*P[0],o.spriteData[B+3]=z*P[1];let X=(o.spriteData[B+11]>>16&255)<<16&16711680|_&65535;o.spriteData[B+11]=X,o.dirty=!0}function Yn(r,o,v,m){o=o.data;let T=o.spriteIndices.get(v)*12;o.spriteData[T]=m[0],o.spriteData[T+1]=m[1],o.dirty=!0}function $n(r,o,v,m){o=o.data;let T=o.spriteIndices.get(v)*12;o.spriteData[T+4]=m[0],o.spriteData[T+5]=m[1],o.spriteData[T+6]=m[2],o.spriteData[T+7]=m[3],o.dirty=!0}function Xn(r,o,v,m){o=o.data;let T=o.spriteIndices.get(v)*12;o.spriteData[T+8]=m,o.dirty=!0}function Hn(r,o,v,m){o=o.data;let T=o.spriteIndices.get(v)*12;o.spriteData[T+9]=m,o.dirty=!0}function Wn(r,o,v,m,P,T,_,G,z,U){let B=o.refs.spritesheet.data.spritesheet;o=o.data;let R=o.spriteIndices.get(v);qe(o,B,R,m,P,T,_,G,z,U),o.dirty=!0}function qe(r,o,v,m,P,T,_,G,z,U){if(!o.spriteMeta[m])throw new Error(`Sprite name ${m} could not be found in the spritesheet metaData`);let B=v*12,R=o.spriteMeta[m].w,X=o.spriteMeta[m].h,Y=o.locations.indexOf(m),H=U<<16&16711680|Y&65535;r.spriteData[B]=P[0],r.spriteData[B+1]=P[1],r.spriteData[B+2]=R*T[0],r.spriteData[B+3]=X*T[1],r.spriteData[B+4]=_[0],r.spriteData[B+5]=_[1],r.spriteData[B+6]=_[2],r.spriteData[B+7]=_[3],r.spriteData[B+8]=G,r.spriteData[B+9]=z,r.spriteData[B+11]=H}var Ne={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(r,o={}){return jn(r,o)},onRun:function(r,o,v){Zn(r,o,v)},onDestroy:function(r,o){kn(o)},onResize:function(r,o){},onViewportPosition:function(r,o){},customFunctions:{...re}};async function jn(r,o){let{device:v}=r,m=16192,P=m,_=Float32Array.BYTES_PER_ELEMENT*2,z=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*4,X=Float32Array.BYTES_PER_ELEMENT*4,Y=v.createBuffer({size:(_+z+B+X)*P,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),H=o.refs.spritesheet.data,F=v.createBindGroup({layout:o.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:H.uniformBuffer}},{binding:1,resource:H.colorTexture.view},{binding:2,resource:H.colorTexture.sampler},{binding:3,resource:{buffer:Y}},{binding:4,resource:H.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(m*2),instancedDrawCallCount:0,bindGroup:F,spriteBuffer:Y,spriteData:new Float32Array(m*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Zn(r,o,v){let{device:m}=r,P=o.options.loadOp||"load";o.data.dirty&&(Qn(o.data),o.data.dirty=!1),m.queue.writeBuffer(o.data.spriteBuffer,0,o.data.spriteData.buffer);let T=v.beginRenderPass({colorAttachments:[{view:o.refs.hdr.data.view,clearValue:r.clearValue,loadOp:P,storeOp:"store"},{view:o.refs.emissive.data.view,clearValue:r.clearValue,loadOp:"clear",storeOp:"store"}]});T.setPipeline(o.refs.spritesheet.data.pipeline),T.setBindGroup(0,o.data.bindGroup),T.setVertexBuffer(0,o.refs.spritesheet.data.quads.buffer);let _=6,G=0;for(let z=0;z<o.data.instancedDrawCallCount;z++){let U=o.data.instancedDrawCalls[z*2]*_,B=o.data.instancedDrawCalls[z*2+1];T.draw(_,B,U,G),G+=B}T.end()}function Qn(r){let o=-1,v=0;r.instancedDrawCallCount=0;for(let m=0;m<r.spriteCount;m++){let P=r.spriteData[m*12+11]&65535;P!==o&&(v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=o,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++),o=P,v=0),v++}v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=o,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++)}function kn(r){r.data.instancedDrawCalls=null,r.data.bindGroup=null,r.data.spriteBuffer.destroy(),r.data.spriteBuffer=null,r.data.spriteData=null,r.data.spriteIndices.clear(),r.data.spriteIndices=null}var $e={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(r,o={}){return Kn(r,o)},onRun:function(r,o,v){Jn(r,o,v)},onDestroy:function(r,o){Ye(o)},onResize:function(r,o){},onViewportPosition:function(r,o){},customFunctions:{setTexture:async function(r,o,v){let{device:m}=r;Ye(o),o.options.textureUrl=v;let P=await Yt(r,"tile map",o.options.textureUrl),T=m.createBindGroup({layout:o.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:o.data.uniformBuffer}},{binding:1,resource:P.view},{binding:2,resource:P.sampler}]});o.data.bindGroup=T,o.data.material=P}}};async function Kn(r,o){let{device:v}=r,m=await Yt(r,"tile map",o.options.textureUrl),P=new Float32Array([o.options.scrollScale,o.options.scrollScale]),T=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,_={size:P.byteLength,usage:T,mappedAtCreation:!0},G=v.createBuffer(_);return new Float32Array(G.getMappedRange()).set(P),G.unmap(),{bindGroup:v.createBindGroup({layout:o.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:G}},{binding:1,resource:m.view},{binding:2,resource:m.sampler}]}),material:m,uniformBuffer:G,scrollScale:o.options.scrollScale}}function Jn(r,o,v){let{device:m}=r,P=o.options.loadOp||"load",T=v.beginRenderPass({colorAttachments:[{view:o.refs.hdr.data.view,clearValue:r.clearValue,loadOp:P,storeOp:"store"}]}),_=o.refs.tileAtlas.data;T.setPipeline(_.pipeline),T.setBindGroup(0,o.data.bindGroup),T.setBindGroup(1,_.atlasBindGroup),T.draw(3),T.end()}function Ye(r){r.data.material.texture.destroy(),r.data.material.texture=void 0}var Me="struct TransformData{mvpMatrix:mat4x4<f32>,};struct DisplacementParameters{offset:vec2<f32>,scale:f32,noop:f32,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:DisplacementParameters;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.mvpMatrix*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";function eo(r,o){return class extends r{constructor(...v){super(...v),o(this)}}}var no=eo(Array,r=>r.fill(0)),Q=1e-6;function oo(r){function o(t=0,a=0){let e=new r(2);return t!==void 0&&(e[0]=t,a!==void 0&&(e[1]=a)),e}let v=o;function m(t,a,e){let s=e??new r(2);return s[0]=t,s[1]=a,s}function P(t,a){let e=a??new r(2);return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function T(t,a){let e=a??new r(2);return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function _(t,a){let e=a??new r(2);return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function G(t,a=0,e=1,s){let f=s??new r(2);return f[0]=Math.min(e,Math.max(a,t[0])),f[1]=Math.min(e,Math.max(a,t[1])),f}function z(t,a,e){let s=e??new r(2);return s[0]=t[0]+a[0],s[1]=t[1]+a[1],s}function U(t,a,e,s){let f=s??new r(2);return f[0]=t[0]+a[0]*e,f[1]=t[1]+a[1]*e,f}function B(t,a){let e=t[0],s=t[1],f=a[0],g=a[1],D=Math.sqrt(e*e+s*s),u=Math.sqrt(f*f+g*g),l=D*u,w=l&&bt(t,a)/l;return Math.acos(w)}function R(t,a,e){let s=e??new r(2);return s[0]=t[0]-a[0],s[1]=t[1]-a[1],s}let X=R;function Y(t,a){return Math.abs(t[0]-a[0])<Q&&Math.abs(t[1]-a[1])<Q}function H(t,a){return t[0]===a[0]&&t[1]===a[1]}function F(t,a,e,s){let f=s??new r(2);return f[0]=t[0]+e*(a[0]-t[0]),f[1]=t[1]+e*(a[1]-t[1]),f}function et(t,a,e,s){let f=s??new r(2);return f[0]=t[0]+e[0]*(a[0]-t[0]),f[1]=t[1]+e[1]*(a[1]-t[1]),f}function W(t,a,e){let s=e??new r(2);return s[0]=Math.max(t[0],a[0]),s[1]=Math.max(t[1],a[1]),s}function C(t,a,e){let s=e??new r(2);return s[0]=Math.min(t[0],a[0]),s[1]=Math.min(t[1],a[1]),s}function tt(t,a,e){let s=e??new r(2);return s[0]=t[0]*a,s[1]=t[1]*a,s}let Mt=tt;function ft(t,a,e){let s=e??new r(2);return s[0]=t[0]/a,s[1]=t[1]/a,s}function xt(t,a){let e=a??new r(2);return e[0]=1/t[0],e[1]=1/t[1],e}let Dt=xt;function vt(t,a,e){let s=e??new r(3),f=t[0]*a[1]-t[1]*a[0];return s[0]=0,s[1]=0,s[2]=f,s}function bt(t,a){return t[0]*a[0]+t[1]*a[1]}function nt(t){let a=t[0],e=t[1];return Math.sqrt(a*a+e*e)}let Bt=nt;function q(t){let a=t[0],e=t[1];return a*a+e*e}let $=q;function V(t,a){let e=t[0]-a[0],s=t[1]-a[1];return Math.sqrt(e*e+s*s)}let Gt=V;function lt(t,a){let e=t[0]-a[0],s=t[1]-a[1];return e*e+s*s}let Ut=lt;function dt(t,a){let e=a??new r(2),s=t[0],f=t[1],g=Math.sqrt(s*s+f*f);return g>1e-5?(e[0]=s/g,e[1]=f/g):(e[0]=0,e[1]=0),e}function Lt(t,a){let e=a??new r(2);return e[0]=-t[0],e[1]=-t[1],e}function j(t,a){let e=a??new r(2);return e[0]=t[0],e[1]=t[1],e}let Et=j;function mt(t,a,e){let s=e??new r(2);return s[0]=t[0]*a[0],s[1]=t[1]*a[1],s}let It=mt;function yt(t,a,e){let s=e??new r(2);return s[0]=t[0]/a[0],s[1]=t[1]/a[1],s}let zt=yt;function St(t=1,a){let e=a??new r(2),s=Math.random()*2*Math.PI;return e[0]=Math.cos(s)*t,e[1]=Math.sin(s)*t,e}function i(t){let a=t??new r(2);return a[0]=0,a[1]=0,a}function p(t,a,e){let s=e??new r(2),f=t[0],g=t[1];return s[0]=f*a[0]+g*a[4]+a[12],s[1]=f*a[1]+g*a[5]+a[13],s}function n(t,a,e){let s=e??new r(2),f=t[0],g=t[1];return s[0]=a[0]*f+a[4]*g+a[8],s[1]=a[1]*f+a[5]*g+a[9],s}function c(t,a,e,s){let f=s??new r(2),g=t[0]-a[0],D=t[1]-a[1],u=Math.sin(e),l=Math.cos(e);return f[0]=g*l-D*u+a[0],f[1]=g*u+D*l+a[1],f}function d(t,a,e){let s=e??new r(2);return dt(t,s),tt(s,a,s)}function h(t,a,e){let s=e??new r(2);return nt(t)>a?d(t,a,s):j(t,s)}function M(t,a,e){let s=e??new r(2);return F(t,a,.5,s)}return{create:o,fromValues:v,set:m,ceil:P,floor:T,round:_,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:X,equalsApproximately:Y,equals:H,lerp:F,lerpV:et,max:W,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:xt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:$,distance:V,dist:Gt,distanceSq:lt,distSq:Ut,normalize:dt,negate:Lt,copy:j,clone:Et,multiply:mt,mul:It,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat3:n,rotate:c,setLength:d,truncate:h,midpoint:M}}var Xe=new Map;function ke(r){let o=Xe.get(r);return o||(o=oo(r),Xe.set(r,o)),o}function so(r){function o(u,l,w){let x=new r(3);return u!==void 0&&(x[0]=u,l!==void 0&&(x[1]=l,w!==void 0&&(x[2]=w))),x}let v=o;function m(u,l,w,x){let y=x??new r(3);return y[0]=u,y[1]=l,y[2]=w,y}function P(u,l){let w=l??new r(3);return w[0]=Math.ceil(u[0]),w[1]=Math.ceil(u[1]),w[2]=Math.ceil(u[2]),w}function T(u,l){let w=l??new r(3);return w[0]=Math.floor(u[0]),w[1]=Math.floor(u[1]),w[2]=Math.floor(u[2]),w}function _(u,l){let w=l??new r(3);return w[0]=Math.round(u[0]),w[1]=Math.round(u[1]),w[2]=Math.round(u[2]),w}function G(u,l=0,w=1,x){let y=x??new r(3);return y[0]=Math.min(w,Math.max(l,u[0])),y[1]=Math.min(w,Math.max(l,u[1])),y[2]=Math.min(w,Math.max(l,u[2])),y}function z(u,l,w){let x=w??new r(3);return x[0]=u[0]+l[0],x[1]=u[1]+l[1],x[2]=u[2]+l[2],x}function U(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+l[0]*w,y[1]=u[1]+l[1]*w,y[2]=u[2]+l[2]*w,y}function B(u,l){let w=u[0],x=u[1],y=u[2],b=l[0],S=l[1],E=l[2],A=Math.sqrt(w*w+x*x+y*y),L=Math.sqrt(b*b+S*S+E*E),I=A*L,O=I&&bt(u,l)/I;return Math.acos(O)}function R(u,l,w){let x=w??new r(3);return x[0]=u[0]-l[0],x[1]=u[1]-l[1],x[2]=u[2]-l[2],x}let X=R;function Y(u,l){return Math.abs(u[0]-l[0])<Q&&Math.abs(u[1]-l[1])<Q&&Math.abs(u[2]-l[2])<Q}function H(u,l){return u[0]===l[0]&&u[1]===l[1]&&u[2]===l[2]}function F(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w*(l[0]-u[0]),y[1]=u[1]+w*(l[1]-u[1]),y[2]=u[2]+w*(l[2]-u[2]),y}function et(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w[0]*(l[0]-u[0]),y[1]=u[1]+w[1]*(l[1]-u[1]),y[2]=u[2]+w[2]*(l[2]-u[2]),y}function W(u,l,w){let x=w??new r(3);return x[0]=Math.max(u[0],l[0]),x[1]=Math.max(u[1],l[1]),x[2]=Math.max(u[2],l[2]),x}function C(u,l,w){let x=w??new r(3);return x[0]=Math.min(u[0],l[0]),x[1]=Math.min(u[1],l[1]),x[2]=Math.min(u[2],l[2]),x}function tt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l,x[1]=u[1]*l,x[2]=u[2]*l,x}let Mt=tt;function ft(u,l,w){let x=w??new r(3);return x[0]=u[0]/l,x[1]=u[1]/l,x[2]=u[2]/l,x}function xt(u,l){let w=l??new r(3);return w[0]=1/u[0],w[1]=1/u[1],w[2]=1/u[2],w}let Dt=xt;function vt(u,l,w){let x=w??new r(3),y=u[2]*l[0]-u[0]*l[2],b=u[0]*l[1]-u[1]*l[0];return x[0]=u[1]*l[2]-u[2]*l[1],x[1]=y,x[2]=b,x}function bt(u,l){return u[0]*l[0]+u[1]*l[1]+u[2]*l[2]}function nt(u){let l=u[0],w=u[1],x=u[2];return Math.sqrt(l*l+w*w+x*x)}let Bt=nt;function q(u){let l=u[0],w=u[1],x=u[2];return l*l+w*w+x*x}let $=q;function V(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return Math.sqrt(w*w+x*x+y*y)}let Gt=V;function lt(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return w*w+x*x+y*y}let Ut=lt;function dt(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=Math.sqrt(x*x+y*y+b*b);return S>1e-5?(w[0]=x/S,w[1]=y/S,w[2]=b/S):(w[0]=0,w[1]=0,w[2]=0),w}function Lt(u,l){let w=l??new r(3);return w[0]=-u[0],w[1]=-u[1],w[2]=-u[2],w}function j(u,l){let w=l??new r(3);return w[0]=u[0],w[1]=u[1],w[2]=u[2],w}let Et=j;function mt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l[0],x[1]=u[1]*l[1],x[2]=u[2]*l[2],x}let It=mt;function yt(u,l,w){let x=w??new r(3);return x[0]=u[0]/l[0],x[1]=u[1]/l[1],x[2]=u[2]/l[2],x}let zt=yt;function St(u=1,l){let w=l??new r(3),x=Math.random()*2*Math.PI,y=Math.random()*2-1,b=Math.sqrt(1-y*y)*u;return w[0]=Math.cos(x)*b,w[1]=Math.sin(x)*b,w[2]=y*u,w}function i(u){let l=u??new r(3);return l[0]=0,l[1]=0,l[2]=0,l}function p(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2],E=l[3]*y+l[7]*b+l[11]*S+l[15]||1;return x[0]=(l[0]*y+l[4]*b+l[8]*S+l[12])/E,x[1]=(l[1]*y+l[5]*b+l[9]*S+l[13])/E,x[2]=(l[2]*y+l[6]*b+l[10]*S+l[14])/E,x}function n(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0*4+0]+b*l[1*4+0]+S*l[2*4+0],x[1]=y*l[0*4+1]+b*l[1*4+1]+S*l[2*4+1],x[2]=y*l[0*4+2]+b*l[1*4+2]+S*l[2*4+2],x}function c(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0]+b*l[4]+S*l[8],x[1]=y*l[1]+b*l[5]+S*l[9],x[2]=y*l[2]+b*l[6]+S*l[10],x}function d(u,l,w){let x=w??new r(3),y=l[0],b=l[1],S=l[2],E=l[3]*2,A=u[0],L=u[1],I=u[2],O=b*I-S*L,N=S*A-y*I,Z=y*L-b*A;return x[0]=A+O*E+(b*Z-S*N)*2,x[1]=L+N*E+(S*O-y*Z)*2,x[2]=I+Z*E+(y*N-b*O)*2,x}function h(u,l){let w=l??new r(3);return w[0]=u[12],w[1]=u[13],w[2]=u[14],w}function M(u,l,w){let x=w??new r(3),y=l*4;return x[0]=u[y+0],x[1]=u[y+1],x[2]=u[y+2],x}function t(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=u[4],E=u[5],A=u[6],L=u[8],I=u[9],O=u[10];return w[0]=Math.sqrt(x*x+y*y+b*b),w[1]=Math.sqrt(S*S+E*E+A*A),w[2]=Math.sqrt(L*L+I*I+O*O),w}function a(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0],S[1]=b[1]*Math.cos(w)-b[2]*Math.sin(w),S[2]=b[1]*Math.sin(w)+b[2]*Math.cos(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function e(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[2]*Math.sin(w)+b[0]*Math.cos(w),S[1]=b[1],S[2]=b[2]*Math.cos(w)-b[0]*Math.sin(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function s(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0]*Math.cos(w)-b[1]*Math.sin(w),S[1]=b[0]*Math.sin(w)+b[1]*Math.cos(w),S[2]=b[2],y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function f(u,l,w){let x=w??new r(3);return dt(u,x),tt(x,l,x)}function g(u,l,w){let x=w??new r(3);return nt(u)>l?f(u,l,x):j(u,x)}function D(u,l,w){let x=w??new r(3);return F(u,l,.5,x)}return{create:o,fromValues:v,set:m,ceil:P,floor:T,round:_,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:X,equalsApproximately:Y,equals:H,lerp:F,lerpV:et,max:W,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:xt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:$,distance:V,dist:Gt,distanceSq:lt,distSq:Ut,normalize:dt,negate:Lt,copy:j,clone:Et,multiply:mt,mul:It,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat4Upper3x3:n,transformMat3:c,transformQuat:d,getTranslation:h,getAxis:M,getScaling:t,rotateX:a,rotateY:e,rotateZ:s,setLength:f,truncate:g,midpoint:D}}var He=new Map;function ae(r){let o=He.get(r);return o||(o=so(r),He.set(r,o)),o}function ro(r){let o=ke(r),v=ae(r);function m(i,p,n,c,d,h,M,t,a){let e=new r(12);return e[3]=0,e[7]=0,e[11]=0,i!==void 0&&(e[0]=i,p!==void 0&&(e[1]=p,n!==void 0&&(e[2]=n,c!==void 0&&(e[4]=c,d!==void 0&&(e[5]=d,h!==void 0&&(e[6]=h,M!==void 0&&(e[8]=M,t!==void 0&&(e[9]=t,a!==void 0&&(e[10]=a))))))))),e}function P(i,p,n,c,d,h,M,t,a,e){let s=e??new r(12);return s[0]=i,s[1]=p,s[2]=n,s[3]=0,s[4]=c,s[5]=d,s[6]=h,s[7]=0,s[8]=M,s[9]=t,s[10]=a,s[11]=0,s}function T(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=0,n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=0,n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=0,n}function _(i,p){let n=p??new r(12),c=i[0],d=i[1],h=i[2],M=i[3],t=c+c,a=d+d,e=h+h,s=c*t,f=d*t,g=d*a,D=h*t,u=h*a,l=h*e,w=M*t,x=M*a,y=M*e;return n[0]=1-g-l,n[1]=f+y,n[2]=D-x,n[3]=0,n[4]=f-y,n[5]=1-s-l,n[6]=u+w,n[7]=0,n[8]=D+x,n[9]=u-w,n[10]=1-s-g,n[11]=0,n}function G(i,p){let n=p??new r(12);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[4]=-i[4],n[5]=-i[5],n[6]=-i[6],n[8]=-i[8],n[9]=-i[9],n[10]=-i[10],n}function z(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[8]=i[8],n[9]=i[9],n[10]=i[10],n}let U=z;function B(i,p){return Math.abs(i[0]-p[0])<Q&&Math.abs(i[1]-p[1])<Q&&Math.abs(i[2]-p[2])<Q&&Math.abs(i[4]-p[4])<Q&&Math.abs(i[5]-p[5])<Q&&Math.abs(i[6]-p[6])<Q&&Math.abs(i[8]-p[8])<Q&&Math.abs(i[9]-p[9])<Q&&Math.abs(i[10]-p[10])<Q}function R(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[4]===p[4]&&i[5]===p[5]&&i[6]===p[6]&&i[8]===p[8]&&i[9]===p[9]&&i[10]===p[10]}function X(i){let p=i??new r(12);return p[0]=1,p[1]=0,p[2]=0,p[4]=0,p[5]=1,p[6]=0,p[8]=0,p[9]=0,p[10]=1,p}function Y(i,p){let n=p??new r(12);if(n===i){let g;return g=i[1],i[1]=i[4],i[4]=g,g=i[2],i[2]=i[8],i[8]=g,g=i[6],i[6]=i[9],i[9]=g,n}let c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],s=i[2*4+1],f=i[2*4+2];return n[0]=c,n[1]=M,n[2]=e,n[4]=d,n[5]=t,n[6]=s,n[8]=h,n[9]=a,n[10]=f,n}function H(i,p){let n=p??new r(12),c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],s=i[2*4+1],f=i[2*4+2],g=f*t-a*s,D=-f*M+a*e,u=s*M-t*e,l=1/(c*g+d*D+h*u);return n[0]=g*l,n[1]=(-f*d+h*s)*l,n[2]=(a*d-h*t)*l,n[4]=D*l,n[5]=(f*c-h*e)*l,n[6]=(-a*c+h*M)*l,n[8]=u*l,n[9]=(-s*c+d*e)*l,n[10]=(t*c-d*M)*l,n}function F(i){let p=i[0],n=i[0*4+1],c=i[0*4+2],d=i[1*4+0],h=i[1*4+1],M=i[1*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2];return p*(h*e-a*M)-d*(n*e-a*c)+t*(n*M-h*c)}let et=H;function W(i,p,n){let c=n??new r(12),d=i[0],h=i[1],M=i[2],t=i[4],a=i[5],e=i[6],s=i[8],f=i[9],g=i[10],D=p[0],u=p[1],l=p[2],w=p[4],x=p[5],y=p[6],b=p[8],S=p[9],E=p[10];return c[0]=d*D+t*u+s*l,c[1]=h*D+a*u+f*l,c[2]=M*D+e*u+g*l,c[4]=d*w+t*x+s*y,c[5]=h*w+a*x+f*y,c[6]=M*w+e*x+g*y,c[8]=d*b+t*S+s*E,c[9]=h*b+a*S+f*E,c[10]=M*b+e*S+g*E,c}let C=W;function tt(i,p,n){let c=n??X();return i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2],c[4]=i[4],c[5]=i[5],c[6]=i[6]),c[8]=p[0],c[9]=p[1],c[10]=1,c}function Mt(i,p){let n=p??o.create();return n[0]=i[8],n[1]=i[9],n}function ft(i,p,n){let c=n??o.create(),d=p*4;return c[0]=i[d+0],c[1]=i[d+1],c}function xt(i,p,n,c){let d=c===i?i:z(i,c),h=n*4;return d[h+0]=p[0],d[h+1]=p[1],d}function Dt(i,p){let n=p??o.create(),c=i[0],d=i[1],h=i[4],M=i[5];return n[0]=Math.sqrt(c*c+d*d),n[1]=Math.sqrt(h*h+M*M),n}function vt(i,p){let n=p??v.create(),c=i[0],d=i[1],h=i[2],M=i[4],t=i[5],a=i[6],e=i[8],s=i[9],f=i[10];return n[0]=Math.sqrt(c*c+d*d+h*h),n[1]=Math.sqrt(M*M+t*t+a*a),n[2]=Math.sqrt(e*e+s*s+f*f),n}function bt(i,p){let n=p??new r(12);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=1,n[6]=0,n[8]=i[0],n[9]=i[1],n[10]=1,n}function nt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=i[0],t=i[1],a=i[2],e=i[1*4+0],s=i[1*4+1],f=i[1*4+2],g=i[2*4+0],D=i[2*4+1],u=i[2*4+2];return i!==c&&(c[0]=M,c[1]=t,c[2]=a,c[4]=e,c[5]=s,c[6]=f),c[8]=M*d+e*h+g,c[9]=t*d+s*h+D,c[10]=a*d+f*h+u,c}function Bt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=d,n[2]=0,n[4]=-d,n[5]=c,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function q(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[1*4+0],a=i[1*4+1],e=i[1*4+2],s=Math.cos(p),f=Math.sin(p);return c[0]=s*d+f*t,c[1]=s*h+f*a,c[2]=s*M+f*e,c[4]=s*t-f*d,c[5]=s*a-f*h,c[6]=s*e-f*M,i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function $(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=c,n[6]=d,n[8]=0,n[9]=-d,n[10]=c,n}function V(i,p,n){let c=n??new r(12),d=i[4],h=i[5],M=i[6],t=i[8],a=i[9],e=i[10],s=Math.cos(p),f=Math.sin(p);return c[4]=s*d+f*t,c[5]=s*h+f*a,c[6]=s*M+f*e,c[8]=s*t-f*d,c[9]=s*a-f*h,c[10]=s*e-f*M,i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2]),c}function Gt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=0,n[2]=-d,n[4]=0,n[5]=1,n[6]=0,n[8]=d,n[9]=0,n[10]=c,n}function lt(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2],s=Math.cos(p),f=Math.sin(p);return c[0]=s*d-f*t,c[1]=s*h-f*a,c[2]=s*M-f*e,c[8]=s*t+f*d,c[9]=s*a+f*h,c[10]=s*e+f*M,i!==c&&(c[4]=i[4],c[5]=i[5],c[6]=i[6]),c}let Ut=Bt,dt=q;function Lt(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function j(i,p,n){let c=n??new r(12),d=p[0],h=p[1];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function Et(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=i[2],n}function mt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=p[2];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],c[8]=M*i[2*4+0],c[9]=M*i[2*4+1],c[10]=M*i[2*4+2],c}function It(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function yt(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function zt(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=i,n}function St(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],c[8]=p*i[2*4+0],c[9]=p*i[2*4+1],c[10]=p*i[2*4+2],c}return{clone:U,create:m,set:P,fromMat4:T,fromQuat:_,negate:G,copy:z,equalsApproximately:B,equals:R,identity:X,transpose:Y,inverse:H,invert:et,determinant:F,mul:C,multiply:W,setTranslation:tt,getTranslation:Mt,getAxis:ft,setAxis:xt,getScaling:Dt,get3DScaling:vt,translation:bt,translate:nt,rotation:Bt,rotate:q,rotationX:$,rotateX:V,rotationY:Gt,rotateY:lt,rotationZ:Ut,rotateZ:dt,scaling:Lt,scale:j,uniformScaling:It,uniformScale:yt,scaling3D:Et,scale3D:mt,uniformScaling3D:zt,uniformScale3D:St}}var We=new Map;function io(r){let o=We.get(r);return o||(o=ro(r),We.set(r,o)),o}function co(r){let o=ae(r);function v(t,a,e,s,f,g,D,u,l,w,x,y,b,S,E,A){let L=new r(16);return t!==void 0&&(L[0]=t,a!==void 0&&(L[1]=a,e!==void 0&&(L[2]=e,s!==void 0&&(L[3]=s,f!==void 0&&(L[4]=f,g!==void 0&&(L[5]=g,D!==void 0&&(L[6]=D,u!==void 0&&(L[7]=u,l!==void 0&&(L[8]=l,w!==void 0&&(L[9]=w,x!==void 0&&(L[10]=x,y!==void 0&&(L[11]=y,b!==void 0&&(L[12]=b,S!==void 0&&(L[13]=S,E!==void 0&&(L[14]=E,A!==void 0&&(L[15]=A)))))))))))))))),L}function m(t,a,e,s,f,g,D,u,l,w,x,y,b,S,E,A,L){let I=L??new r(16);return I[0]=t,I[1]=a,I[2]=e,I[3]=s,I[4]=f,I[5]=g,I[6]=D,I[7]=u,I[8]=l,I[9]=w,I[10]=x,I[11]=y,I[12]=b,I[13]=S,I[14]=E,I[15]=A,I}function P(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function T(t,a){let e=a??new r(16),s=t[0],f=t[1],g=t[2],D=t[3],u=s+s,l=f+f,w=g+g,x=s*u,y=f*u,b=f*l,S=g*u,E=g*l,A=g*w,L=D*u,I=D*l,O=D*w;return e[0]=1-b-A,e[1]=y+O,e[2]=S-I,e[3]=0,e[4]=y-O,e[5]=1-x-A,e[6]=E+L,e[7]=0,e[8]=S+I,e[9]=E-L,e[10]=1-x-b,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function _(t,a){let e=a??new r(16);return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function G(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}let z=G;function U(t,a){return Math.abs(t[0]-a[0])<Q&&Math.abs(t[1]-a[1])<Q&&Math.abs(t[2]-a[2])<Q&&Math.abs(t[3]-a[3])<Q&&Math.abs(t[4]-a[4])<Q&&Math.abs(t[5]-a[5])<Q&&Math.abs(t[6]-a[6])<Q&&Math.abs(t[7]-a[7])<Q&&Math.abs(t[8]-a[8])<Q&&Math.abs(t[9]-a[9])<Q&&Math.abs(t[10]-a[10])<Q&&Math.abs(t[11]-a[11])<Q&&Math.abs(t[12]-a[12])<Q&&Math.abs(t[13]-a[13])<Q&&Math.abs(t[14]-a[14])<Q&&Math.abs(t[15]-a[15])<Q}function B(t,a){return t[0]===a[0]&&t[1]===a[1]&&t[2]===a[2]&&t[3]===a[3]&&t[4]===a[4]&&t[5]===a[5]&&t[6]===a[6]&&t[7]===a[7]&&t[8]===a[8]&&t[9]===a[9]&&t[10]===a[10]&&t[11]===a[11]&&t[12]===a[12]&&t[13]===a[13]&&t[14]===a[14]&&t[15]===a[15]}function R(t){let a=t??new r(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function X(t,a){let e=a??new r(16);if(e===t){let N;return N=t[1],t[1]=t[4],t[4]=N,N=t[2],t[2]=t[8],t[8]=N,N=t[3],t[3]=t[12],t[12]=N,N=t[6],t[6]=t[9],t[9]=N,N=t[7],t[7]=t[13],t[13]=N,N=t[11],t[11]=t[14],t[14]=N,e}let s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],A=t[3*4+0],L=t[3*4+1],I=t[3*4+2],O=t[3*4+3];return e[0]=s,e[1]=u,e[2]=y,e[3]=A,e[4]=f,e[5]=l,e[6]=b,e[7]=L,e[8]=g,e[9]=w,e[10]=S,e[11]=I,e[12]=D,e[13]=x,e[14]=E,e[15]=O,e}function Y(t,a){let e=a??new r(16),s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],A=t[3*4+0],L=t[3*4+1],I=t[3*4+2],O=t[3*4+3],N=S*O,Z=I*E,K=w*O,J=I*x,ot=w*E,st=S*x,rt=g*O,it=I*D,ct=g*E,at=S*D,pt=g*x,ht=w*D,wt=y*L,gt=A*b,Tt=u*L,Pt=A*l,_t=u*b,$t=y*l,Xt=s*L,Ht=A*f,Wt=s*b,jt=y*f,Zt=s*l,Qt=u*f,Ct=N*l+J*b+ot*L-(Z*l+K*b+st*L),te=Z*f+rt*b+at*L-(N*f+it*b+ct*L),ee=K*f+it*l+pt*L-(J*f+rt*l+ht*L),ne=st*f+ct*l+ht*b-(ot*f+at*l+pt*b),ut=1/(s*Ct+u*te+y*ee+A*ne);return e[0]=ut*Ct,e[1]=ut*te,e[2]=ut*ee,e[3]=ut*ne,e[4]=ut*(Z*u+K*y+st*A-(N*u+J*y+ot*A)),e[5]=ut*(N*s+it*y+ct*A-(Z*s+rt*y+at*A)),e[6]=ut*(J*s+rt*u+ht*A-(K*s+it*u+pt*A)),e[7]=ut*(ot*s+at*u+pt*y-(st*s+ct*u+ht*y)),e[8]=ut*(wt*x+Pt*E+_t*O-(gt*x+Tt*E+$t*O)),e[9]=ut*(gt*D+Xt*E+jt*O-(wt*D+Ht*E+Wt*O)),e[10]=ut*(Tt*D+Ht*x+Zt*O-(Pt*D+Xt*x+Qt*O)),e[11]=ut*($t*D+Wt*x+Qt*E-(_t*D+jt*x+Zt*E)),e[12]=ut*(Tt*S+$t*I+gt*w-(_t*I+wt*w+Pt*S)),e[13]=ut*(Wt*I+wt*g+Ht*S-(Xt*S+jt*I+gt*g)),e[14]=ut*(Xt*w+Qt*I+Pt*g-(Zt*I+Tt*g+Ht*w)),e[15]=ut*(Zt*S+_t*g+jt*w-(Wt*w+Qt*S+$t*g)),e}function H(t){let a=t[0],e=t[0*4+1],s=t[0*4+2],f=t[0*4+3],g=t[1*4+0],D=t[1*4+1],u=t[1*4+2],l=t[1*4+3],w=t[2*4+0],x=t[2*4+1],y=t[2*4+2],b=t[2*4+3],S=t[3*4+0],E=t[3*4+1],A=t[3*4+2],L=t[3*4+3],I=y*L,O=A*b,N=u*L,Z=A*l,K=u*b,J=y*l,ot=s*L,st=A*f,rt=s*b,it=y*f,ct=s*l,at=u*f,pt=I*D+Z*x+K*E-(O*D+N*x+J*E),ht=O*e+ot*x+it*E-(I*e+st*x+rt*E),wt=N*e+st*D+ct*E-(Z*e+ot*D+at*E),gt=J*e+rt*D+at*x-(K*e+it*D+ct*x);return a*pt+g*ht+w*wt+S*gt}let F=Y;function et(t,a,e){let s=e??new r(16),f=t[0],g=t[1],D=t[2],u=t[3],l=t[4],w=t[5],x=t[6],y=t[7],b=t[8],S=t[9],E=t[10],A=t[11],L=t[12],I=t[13],O=t[14],N=t[15],Z=a[0],K=a[1],J=a[2],ot=a[3],st=a[4],rt=a[5],it=a[6],ct=a[7],at=a[8],pt=a[9],ht=a[10],wt=a[11],gt=a[12],Tt=a[13],Pt=a[14],_t=a[15];return s[0]=f*Z+l*K+b*J+L*ot,s[1]=g*Z+w*K+S*J+I*ot,s[2]=D*Z+x*K+E*J+O*ot,s[3]=u*Z+y*K+A*J+N*ot,s[4]=f*st+l*rt+b*it+L*ct,s[5]=g*st+w*rt+S*it+I*ct,s[6]=D*st+x*rt+E*it+O*ct,s[7]=u*st+y*rt+A*it+N*ct,s[8]=f*at+l*pt+b*ht+L*wt,s[9]=g*at+w*pt+S*ht+I*wt,s[10]=D*at+x*pt+E*ht+O*wt,s[11]=u*at+y*pt+A*ht+N*wt,s[12]=f*gt+l*Tt+b*Pt+L*_t,s[13]=g*gt+w*Tt+S*Pt+I*_t,s[14]=D*gt+x*Tt+E*Pt+O*_t,s[15]=u*gt+y*Tt+A*Pt+N*_t,s}let W=et;function C(t,a,e){let s=e??R();return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11]),s[12]=a[0],s[13]=a[1],s[14]=a[2],s[15]=1,s}function tt(t,a){let e=a??o.create();return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Mt(t,a,e){let s=e??o.create(),f=a*4;return s[0]=t[f+0],s[1]=t[f+1],s[2]=t[f+2],s}function ft(t,a,e,s){let f=s===t?s:G(t,s),g=e*4;return f[g+0]=a[0],f[g+1]=a[1],f[g+2]=a[2],f}function xt(t,a){let e=a??o.create(),s=t[0],f=t[1],g=t[2],D=t[4],u=t[5],l=t[6],w=t[8],x=t[9],y=t[10];return e[0]=Math.sqrt(s*s+f*f+g*g),e[1]=Math.sqrt(D*D+u*u+l*l),e[2]=Math.sqrt(w*w+x*x+y*y),e}function Dt(t,a,e,s,f){let g=f??new r(16),D=Math.tan(Math.PI*.5-.5*t);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(s)){let u=1/(e-s);g[10]=s*u,g[14]=s*e*u}else g[10]=-1,g[14]=-e;return g}function vt(t,a,e,s=1/0,f){let g=f??new r(16),D=1/Math.tan(t*.5);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,s===1/0)g[10]=0,g[14]=e;else{let u=1/(s-e);g[10]=e*u,g[14]=s*e*u}return g}function bt(t,a,e,s,f,g,D){let u=D??new r(16);return u[0]=2/(a-t),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(s-e),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1/(f-g),u[11]=0,u[12]=(a+t)/(t-a),u[13]=(s+e)/(e-s),u[14]=f/(f-g),u[15]=1,u}function nt(t,a,e,s,f,g,D){let u=D??new r(16),l=a-t,w=s-e,x=f-g;return u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(s+e)/w,u[10]=g/x,u[11]=-1,u[12]=0,u[13]=0,u[14]=f*g/x,u[15]=0,u}function Bt(t,a,e,s,f,g=1/0,D){let u=D??new r(16),l=a-t,w=s-e;if(u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(s+e)/w,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,g===1/0)u[10]=0,u[14]=f;else{let x=1/(g-f);u[10]=f*x,u[14]=g*f*x}return u}let q=o.create(),$=o.create(),V=o.create();function Gt(t,a,e,s){let f=s??new r(16);return o.normalize(o.subtract(a,t,V),V),o.normalize(o.cross(e,V,q),q),o.normalize(o.cross(V,q,$),$),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=$[0],f[5]=$[1],f[6]=$[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function lt(t,a,e,s){let f=s??new r(16);return o.normalize(o.subtract(t,a,V),V),o.normalize(o.cross(e,V,q),q),o.normalize(o.cross(V,q,$),$),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=$[0],f[5]=$[1],f[6]=$[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function Ut(t,a,e,s){let f=s??new r(16);return o.normalize(o.subtract(t,a,V),V),o.normalize(o.cross(e,V,q),q),o.normalize(o.cross(V,q,$),$),f[0]=q[0],f[1]=$[0],f[2]=V[0],f[3]=0,f[4]=q[1],f[5]=$[1],f[6]=V[1],f[7]=0,f[8]=q[2],f[9]=$[2],f[10]=V[2],f[11]=0,f[12]=-(q[0]*t[0]+q[1]*t[1]+q[2]*t[2]),f[13]=-($[0]*t[0]+$[1]*t[1]+$[2]*t[2]),f[14]=-(V[0]*t[0]+V[1]*t[1]+V[2]*t[2]),f[15]=1,f}function dt(t,a){let e=a??new r(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Lt(t,a,e){let s=e??new r(16),f=a[0],g=a[1],D=a[2],u=t[0],l=t[1],w=t[2],x=t[3],y=t[1*4+0],b=t[1*4+1],S=t[1*4+2],E=t[1*4+3],A=t[2*4+0],L=t[2*4+1],I=t[2*4+2],O=t[2*4+3],N=t[3*4+0],Z=t[3*4+1],K=t[3*4+2],J=t[3*4+3];return t!==s&&(s[0]=u,s[1]=l,s[2]=w,s[3]=x,s[4]=y,s[5]=b,s[6]=S,s[7]=E,s[8]=A,s[9]=L,s[10]=I,s[11]=O),s[12]=u*f+y*g+A*D+N,s[13]=l*f+b*g+L*D+Z,s[14]=w*f+S*g+I*D+K,s[15]=x*f+E*g+O*D+J,s}function j(t,a){let e=a??new r(16),s=Math.cos(t),f=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=f,e[7]=0,e[8]=0,e[9]=-f,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Et(t,a,e){let s=e??new r(16),f=t[4],g=t[5],D=t[6],u=t[7],l=t[8],w=t[9],x=t[10],y=t[11],b=Math.cos(a),S=Math.sin(a);return s[4]=b*f+S*l,s[5]=b*g+S*w,s[6]=b*D+S*x,s[7]=b*u+S*y,s[8]=b*l-S*f,s[9]=b*w-S*g,s[10]=b*x-S*D,s[11]=b*y-S*u,t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function mt(t,a){let e=a??new r(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=0,e[2]=-f,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=f,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function It(t,a,e){let s=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[2*4+0],w=t[2*4+1],x=t[2*4+2],y=t[2*4+3],b=Math.cos(a),S=Math.sin(a);return s[0]=b*f-S*l,s[1]=b*g-S*w,s[2]=b*D-S*x,s[3]=b*u-S*y,s[8]=b*l+S*f,s[9]=b*w+S*g,s[10]=b*x+S*D,s[11]=b*y+S*u,t!==s&&(s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function yt(t,a){let e=a??new r(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=f,e[2]=0,e[3]=0,e[4]=-f,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function zt(t,a,e){let s=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[1*4+0],w=t[1*4+1],x=t[1*4+2],y=t[1*4+3],b=Math.cos(a),S=Math.sin(a);return s[0]=b*f+S*l,s[1]=b*g+S*w,s[2]=b*D+S*x,s[3]=b*u+S*y,s[4]=b*l-S*f,s[5]=b*w-S*g,s[6]=b*x-S*D,s[7]=b*y-S*u,t!==s&&(s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function St(t,a,e){let s=e??new r(16),f=t[0],g=t[1],D=t[2],u=Math.sqrt(f*f+g*g+D*D);f/=u,g/=u,D/=u;let l=f*f,w=g*g,x=D*D,y=Math.cos(a),b=Math.sin(a),S=1-y;return s[0]=l+(1-l)*y,s[1]=f*g*S+D*b,s[2]=f*D*S-g*b,s[3]=0,s[4]=f*g*S-D*b,s[5]=w+(1-w)*y,s[6]=g*D*S+f*b,s[7]=0,s[8]=f*D*S+g*b,s[9]=g*D*S-f*b,s[10]=x+(1-x)*y,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}let i=St;function p(t,a,e,s){let f=s??new r(16),g=a[0],D=a[1],u=a[2],l=Math.sqrt(g*g+D*D+u*u);g/=l,D/=l,u/=l;let w=g*g,x=D*D,y=u*u,b=Math.cos(e),S=Math.sin(e),E=1-b,A=w+(1-w)*b,L=g*D*E+u*S,I=g*u*E-D*S,O=g*D*E-u*S,N=x+(1-x)*b,Z=D*u*E+g*S,K=g*u*E+D*S,J=D*u*E-g*S,ot=y+(1-y)*b,st=t[0],rt=t[1],it=t[2],ct=t[3],at=t[4],pt=t[5],ht=t[6],wt=t[7],gt=t[8],Tt=t[9],Pt=t[10],_t=t[11];return f[0]=A*st+L*at+I*gt,f[1]=A*rt+L*pt+I*Tt,f[2]=A*it+L*ht+I*Pt,f[3]=A*ct+L*wt+I*_t,f[4]=O*st+N*at+Z*gt,f[5]=O*rt+N*pt+Z*Tt,f[6]=O*it+N*ht+Z*Pt,f[7]=O*ct+N*wt+Z*_t,f[8]=K*st+J*at+ot*gt,f[9]=K*rt+J*pt+ot*Tt,f[10]=K*it+J*ht+ot*Pt,f[11]=K*ct+J*wt+ot*_t,t!==f&&(f[12]=t[12],f[13]=t[13],f[14]=t[14],f[15]=t[15]),f}let n=p;function c(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function d(t,a,e){let s=e??new r(16),f=a[0],g=a[1],D=a[2];return s[0]=f*t[0*4+0],s[1]=f*t[0*4+1],s[2]=f*t[0*4+2],s[3]=f*t[0*4+3],s[4]=g*t[1*4+0],s[5]=g*t[1*4+1],s[6]=g*t[1*4+2],s[7]=g*t[1*4+3],s[8]=D*t[2*4+0],s[9]=D*t[2*4+1],s[10]=D*t[2*4+2],s[11]=D*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function h(t,a){let e=a??new r(16);return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function M(t,a,e){let s=e??new r(16);return s[0]=a*t[0*4+0],s[1]=a*t[0*4+1],s[2]=a*t[0*4+2],s[3]=a*t[0*4+3],s[4]=a*t[1*4+0],s[5]=a*t[1*4+1],s[6]=a*t[1*4+2],s[7]=a*t[1*4+3],s[8]=a*t[2*4+0],s[9]=a*t[2*4+1],s[10]=a*t[2*4+2],s[11]=a*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}return{create:v,set:m,fromMat3:P,fromQuat:T,negate:_,copy:G,clone:z,equalsApproximately:U,equals:B,identity:R,transpose:X,inverse:Y,determinant:H,invert:F,multiply:et,mul:W,setTranslation:C,getTranslation:tt,getAxis:Mt,setAxis:ft,getScaling:xt,perspective:Dt,perspectiveReverseZ:vt,ortho:bt,frustum:nt,frustumReverseZ:Bt,aim:Gt,cameraAim:lt,lookAt:Ut,translation:dt,translate:Lt,rotationX:j,rotateX:Et,rotationY:mt,rotateY:It,rotationZ:yt,rotateZ:zt,axisRotation:St,rotation:i,axisRotate:p,rotate:n,scaling:c,scale:d,uniformScaling:h,uniformScale:M}}var je=new Map;function ao(r){let o=je.get(r);return o||(o=co(r),je.set(r,o)),o}function uo(r){let o=ae(r);function v(i,p,n,c){let d=new r(4);return i!==void 0&&(d[0]=i,p!==void 0&&(d[1]=p,n!==void 0&&(d[2]=n,c!==void 0&&(d[3]=c)))),d}let m=v;function P(i,p,n,c,d){let h=d??new r(4);return h[0]=i,h[1]=p,h[2]=n,h[3]=c,h}function T(i,p,n){let c=n??new r(4),d=p*.5,h=Math.sin(d);return c[0]=h*i[0],c[1]=h*i[1],c[2]=h*i[2],c[3]=Math.cos(d),c}function _(i,p){let n=p??o.create(3),c=Math.acos(i[3])*2,d=Math.sin(c*.5);return d>Q?(n[0]=i[0]/d,n[1]=i[1]/d,n[2]=i[2]/d):(n[0]=1,n[1]=0,n[2]=0),{angle:c,axis:n}}function G(i,p){let n=nt(i,p);return Math.acos(2*n*n-1)}function z(i,p,n){let c=n??new r(4),d=i[0],h=i[1],M=i[2],t=i[3],a=p[0],e=p[1],s=p[2],f=p[3];return c[0]=d*f+t*a+h*s-M*e,c[1]=h*f+t*e+M*a-d*s,c[2]=M*f+t*s+d*e-h*a,c[3]=t*f-d*a-h*e-M*s,c}let U=z;function B(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),s=Math.cos(d);return c[0]=h*s+a*e,c[1]=M*s+t*e,c[2]=t*s-M*e,c[3]=a*s-h*e,c}function R(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),s=Math.cos(d);return c[0]=h*s-t*e,c[1]=M*s+a*e,c[2]=t*s+h*e,c[3]=a*s-M*e,c}function X(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),s=Math.cos(d);return c[0]=h*s+M*e,c[1]=M*s-h*e,c[2]=t*s+a*e,c[3]=a*s-t*e,c}function Y(i,p,n,c){let d=c??new r(4),h=i[0],M=i[1],t=i[2],a=i[3],e=p[0],s=p[1],f=p[2],g=p[3],D=h*e+M*s+t*f+a*g;D<0&&(D=-D,e=-e,s=-s,f=-f,g=-g);let u,l;if(1-D>Q){let w=Math.acos(D),x=Math.sin(w);u=Math.sin((1-n)*w)/x,l=Math.sin(n*w)/x}else u=1-n,l=n;return d[0]=u*h+l*e,d[1]=u*M+l*s,d[2]=u*t+l*f,d[3]=u*a+l*g,d}function H(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=c*c+d*d+h*h+M*M,a=t?1/t:0;return n[0]=-c*a,n[1]=-d*a,n[2]=-h*a,n[3]=M*a,n}function F(i,p){let n=p??new r(4);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[3]=i[3],n}function et(i,p){let n=p??new r(4),c=i[0]+i[5]+i[10];if(c>0){let d=Math.sqrt(c+1);n[3]=.5*d;let h=.5/d;n[0]=(i[6]-i[9])*h,n[1]=(i[8]-i[2])*h,n[2]=(i[1]-i[4])*h}else{let d=0;i[5]>i[0]&&(d=1),i[10]>i[d*4+d]&&(d=2);let h=(d+1)%3,M=(d+2)%3,t=Math.sqrt(i[d*4+d]-i[h*4+h]-i[M*4+M]+1);n[d]=.5*t;let a=.5/t;n[3]=(i[h*4+M]-i[M*4+h])*a,n[h]=(i[h*4+d]+i[d*4+h])*a,n[M]=(i[M*4+d]+i[d*4+M])*a}return n}function W(i,p,n,c,d){let h=d??new r(4),M=i*.5,t=p*.5,a=n*.5,e=Math.sin(M),s=Math.cos(M),f=Math.sin(t),g=Math.cos(t),D=Math.sin(a),u=Math.cos(a);switch(c){case"xyz":h[0]=e*g*u+s*f*D,h[1]=s*f*u-e*g*D,h[2]=s*g*D+e*f*u,h[3]=s*g*u-e*f*D;break;case"xzy":h[0]=e*g*u-s*f*D,h[1]=s*f*u-e*g*D,h[2]=s*g*D+e*f*u,h[3]=s*g*u+e*f*D;break;case"yxz":h[0]=e*g*u+s*f*D,h[1]=s*f*u-e*g*D,h[2]=s*g*D-e*f*u,h[3]=s*g*u+e*f*D;break;case"yzx":h[0]=e*g*u+s*f*D,h[1]=s*f*u+e*g*D,h[2]=s*g*D-e*f*u,h[3]=s*g*u-e*f*D;break;case"zxy":h[0]=e*g*u-s*f*D,h[1]=s*f*u+e*g*D,h[2]=s*g*D+e*f*u,h[3]=s*g*u-e*f*D;break;case"zyx":h[0]=e*g*u-s*f*D,h[1]=s*f*u+e*g*D,h[2]=s*g*D-e*f*u,h[3]=s*g*u+e*f*D;break;default:throw new Error(`Unknown rotation order: ${c}`)}return h}function C(i,p){let n=p??new r(4);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n}let tt=C;function Mt(i,p,n){let c=n??new r(4);return c[0]=i[0]+p[0],c[1]=i[1]+p[1],c[2]=i[2]+p[2],c[3]=i[3]+p[3],c}function ft(i,p,n){let c=n??new r(4);return c[0]=i[0]-p[0],c[1]=i[1]-p[1],c[2]=i[2]-p[2],c[3]=i[3]-p[3],c}let xt=ft;function Dt(i,p,n){let c=n??new r(4);return c[0]=i[0]*p,c[1]=i[1]*p,c[2]=i[2]*p,c[3]=i[3]*p,c}let vt=Dt;function bt(i,p,n){let c=n??new r(4);return c[0]=i[0]/p,c[1]=i[1]/p,c[2]=i[2]/p,c[3]=i[3]/p,c}function nt(i,p){return i[0]*p[0]+i[1]*p[1]+i[2]*p[2]+i[3]*p[3]}function Bt(i,p,n,c){let d=c??new r(4);return d[0]=i[0]+n*(p[0]-i[0]),d[1]=i[1]+n*(p[1]-i[1]),d[2]=i[2]+n*(p[2]-i[2]),d[3]=i[3]+n*(p[3]-i[3]),d}function q(i){let p=i[0],n=i[1],c=i[2],d=i[3];return Math.sqrt(p*p+n*n+c*c+d*d)}let $=q;function V(i){let p=i[0],n=i[1],c=i[2],d=i[3];return p*p+n*n+c*c+d*d}let Gt=V;function lt(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=Math.sqrt(c*c+d*d+h*h+M*M);return t>1e-5?(n[0]=c/t,n[1]=d/t,n[2]=h/t,n[3]=M/t):(n[0]=0,n[1]=0,n[2]=0,n[3]=1),n}function Ut(i,p){return Math.abs(i[0]-p[0])<Q&&Math.abs(i[1]-p[1])<Q&&Math.abs(i[2]-p[2])<Q&&Math.abs(i[3]-p[3])<Q}function dt(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[3]===p[3]}function Lt(i){let p=i??new r(4);return p[0]=0,p[1]=0,p[2]=0,p[3]=1,p}let j=o.create(),Et=o.create(),mt=o.create();function It(i,p,n){let c=n??new r(4),d=o.dot(i,p);return d<-.999999?(o.cross(Et,i,j),o.len(j)<1e-6&&o.cross(mt,i,j),o.normalize(j,j),T(j,Math.PI,c),c):d>.999999?(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c):(o.cross(i,p,j),c[0]=j[0],c[1]=j[1],c[2]=j[2],c[3]=1+d,lt(c,c))}let yt=new r(4),zt=new r(4);function St(i,p,n,c,d,h){let M=h??new r(4);return Y(i,c,d,yt),Y(p,n,d,zt),Y(yt,zt,2*d*(1-d),M),M}return{create:v,fromValues:m,set:P,fromAxisAngle:T,toAxisAngle:_,angle:G,multiply:z,mul:U,rotateX:B,rotateY:R,rotateZ:X,slerp:Y,inverse:H,conjugate:F,fromMat:et,fromEuler:W,copy:C,clone:tt,add:Mt,subtract:ft,sub:xt,mulScalar:Dt,scale:vt,divScalar:bt,dot:nt,lerp:Bt,length:q,len:$,lengthSq:V,lenSq:Gt,normalize:lt,equalsApproximately:Ut,equals:dt,identity:Lt,rotationTo:It,sqlerp:St}}var Ze=new Map;function fo(r){let o=Ze.get(r);return o||(o=uo(r),Ze.set(r,o)),o}function lo(r){function o(n,c,d,h){let M=new r(4);return n!==void 0&&(M[0]=n,c!==void 0&&(M[1]=c,d!==void 0&&(M[2]=d,h!==void 0&&(M[3]=h)))),M}let v=o;function m(n,c,d,h,M){let t=M??new r(4);return t[0]=n,t[1]=c,t[2]=d,t[3]=h,t}function P(n,c){let d=c??new r(4);return d[0]=Math.ceil(n[0]),d[1]=Math.ceil(n[1]),d[2]=Math.ceil(n[2]),d[3]=Math.ceil(n[3]),d}function T(n,c){let d=c??new r(4);return d[0]=Math.floor(n[0]),d[1]=Math.floor(n[1]),d[2]=Math.floor(n[2]),d[3]=Math.floor(n[3]),d}function _(n,c){let d=c??new r(4);return d[0]=Math.round(n[0]),d[1]=Math.round(n[1]),d[2]=Math.round(n[2]),d[3]=Math.round(n[3]),d}function G(n,c=0,d=1,h){let M=h??new r(4);return M[0]=Math.min(d,Math.max(c,n[0])),M[1]=Math.min(d,Math.max(c,n[1])),M[2]=Math.min(d,Math.max(c,n[2])),M[3]=Math.min(d,Math.max(c,n[3])),M}function z(n,c,d){let h=d??new r(4);return h[0]=n[0]+c[0],h[1]=n[1]+c[1],h[2]=n[2]+c[2],h[3]=n[3]+c[3],h}function U(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+c[0]*d,M[1]=n[1]+c[1]*d,M[2]=n[2]+c[2]*d,M[3]=n[3]+c[3]*d,M}function B(n,c,d){let h=d??new r(4);return h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2],h[3]=n[3]-c[3],h}let R=B;function X(n,c){return Math.abs(n[0]-c[0])<Q&&Math.abs(n[1]-c[1])<Q&&Math.abs(n[2]-c[2])<Q&&Math.abs(n[3]-c[3])<Q}function Y(n,c){return n[0]===c[0]&&n[1]===c[1]&&n[2]===c[2]&&n[3]===c[3]}function H(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d*(c[0]-n[0]),M[1]=n[1]+d*(c[1]-n[1]),M[2]=n[2]+d*(c[2]-n[2]),M[3]=n[3]+d*(c[3]-n[3]),M}function F(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d[0]*(c[0]-n[0]),M[1]=n[1]+d[1]*(c[1]-n[1]),M[2]=n[2]+d[2]*(c[2]-n[2]),M[3]=n[3]+d[3]*(c[3]-n[3]),M}function et(n,c,d){let h=d??new r(4);return h[0]=Math.max(n[0],c[0]),h[1]=Math.max(n[1],c[1]),h[2]=Math.max(n[2],c[2]),h[3]=Math.max(n[3],c[3]),h}function W(n,c,d){let h=d??new r(4);return h[0]=Math.min(n[0],c[0]),h[1]=Math.min(n[1],c[1]),h[2]=Math.min(n[2],c[2]),h[3]=Math.min(n[3],c[3]),h}function C(n,c,d){let h=d??new r(4);return h[0]=n[0]*c,h[1]=n[1]*c,h[2]=n[2]*c,h[3]=n[3]*c,h}let tt=C;function Mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c,h[1]=n[1]/c,h[2]=n[2]/c,h[3]=n[3]/c,h}function ft(n,c){let d=c??new r(4);return d[0]=1/n[0],d[1]=1/n[1],d[2]=1/n[2],d[3]=1/n[3],d}let xt=ft;function Dt(n,c){return n[0]*c[0]+n[1]*c[1]+n[2]*c[2]+n[3]*c[3]}function vt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return Math.sqrt(c*c+d*d+h*h+M*M)}let bt=vt;function nt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return c*c+d*d+h*h+M*M}let Bt=nt;function q(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return Math.sqrt(d*d+h*h+M*M+t*t)}let $=q;function V(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return d*d+h*h+M*M+t*t}let Gt=V;function lt(n,c){let d=c??new r(4),h=n[0],M=n[1],t=n[2],a=n[3],e=Math.sqrt(h*h+M*M+t*t+a*a);return e>1e-5?(d[0]=h/e,d[1]=M/e,d[2]=t/e,d[3]=a/e):(d[0]=0,d[1]=0,d[2]=0,d[3]=0),d}function Ut(n,c){let d=c??new r(4);return d[0]=-n[0],d[1]=-n[1],d[2]=-n[2],d[3]=-n[3],d}function dt(n,c){let d=c??new r(4);return d[0]=n[0],d[1]=n[1],d[2]=n[2],d[3]=n[3],d}let Lt=dt;function j(n,c,d){let h=d??new r(4);return h[0]=n[0]*c[0],h[1]=n[1]*c[1],h[2]=n[2]*c[2],h[3]=n[3]*c[3],h}let Et=j;function mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c[0],h[1]=n[1]/c[1],h[2]=n[2]/c[2],h[3]=n[3]/c[3],h}let It=mt;function yt(n){let c=n??new r(4);return c[0]=0,c[1]=0,c[2]=0,c[3]=0,c}function zt(n,c,d){let h=d??new r(4),M=n[0],t=n[1],a=n[2],e=n[3];return h[0]=c[0]*M+c[4]*t+c[8]*a+c[12]*e,h[1]=c[1]*M+c[5]*t+c[9]*a+c[13]*e,h[2]=c[2]*M+c[6]*t+c[10]*a+c[14]*e,h[3]=c[3]*M+c[7]*t+c[11]*a+c[15]*e,h}function St(n,c,d){let h=d??new r(4);return lt(n,h),C(h,c,h)}function i(n,c,d){let h=d??new r(4);return vt(n)>c?St(n,c,h):dt(n,h)}function p(n,c,d){let h=d??new r(4);return H(n,c,.5,h)}return{create:o,fromValues:v,set:m,ceil:P,floor:T,round:_,clamp:G,add:z,addScaled:U,subtract:B,sub:R,equalsApproximately:X,equals:Y,lerp:H,lerpV:F,max:et,min:W,mulScalar:C,scale:tt,divScalar:Mt,inverse:ft,invert:xt,dot:Dt,length:vt,len:bt,lengthSq:nt,lenSq:Bt,distance:q,dist:$,distanceSq:V,distSq:Gt,normalize:lt,negate:Ut,copy:dt,clone:Lt,multiply:j,mul:Et,divide:mt,div:It,zero:yt,transformMat4:zt,setLength:St,truncate:i,midpoint:p}}var Qe=new Map;function po(r){let o=Qe.get(r);return o||(o=lo(r),Qe.set(r,o)),o}function De(r,o,v,m,P,T){return{mat3:io(r),mat4:ao(o),quat:fo(v),vec2:ke(m),vec3:ae(P),vec4:po(T)}}var{mat3:Os,mat4:At,quat:Vs,vec2:ue,vec3:Ot,vec4:be}=De(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:qs,mat4:Ns,quat:Ys,vec2:$s,vec3:Xs,vec4:Hs}=De(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:Ws,mat4:js,quat:Zs,vec2:Qs,vec3:ks,vec4:Ks}=De(no,Array,Array,Array,Array,Array);var fe=class{device;floatsPerSprite=6;bufferGpu;bufferNeedsUpdate=!1;sprites=new Map;get spriteCount(){return this.sprites.size}constructor(o){this.device=o.device,this.bufferGpu=this.device.createBuffer({size:o.maxSpriteCount*this.floatsPerSprite*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})}destroy(){this.bufferGpu.destroy}update(){if(this.bufferNeedsUpdate){let o=[];for(let m of this.sprites.values())o.push(...m);let v=new Float32Array(o);this.device.queue.writeBuffer(this.bufferGpu,0,v)}}addTriangle(o){let v=se();if(this.sprites.has(v))throw new Error(`Duplicate triangle "${v}".`);let m=this.buildTriangleData(o);return this.sprites.set(v,m),this.bufferNeedsUpdate=!0,v}removeTriangle(o){if(!this.sprites.has(o))throw new Error(`Unknown triangle "${o}".`);this.sprites.delete(o),this.bufferNeedsUpdate=!0}setTriangle(o,v){if(!this.sprites.has(o))throw new Error(`Unknown triangle "${o}".`);let m=this.buildTriangleData(v);this.sprites.set(o,m),this.bufferNeedsUpdate=!0}buildTriangleData(o){return[o[0][0],o[0][1],o[1][0],o[1][1],o[2][0],o[2][1]]}};var le=class{device;bufferGpu;needsUpdate=!0;constructor(o){this.device=o.device,this.bufferGpu=this.device.createBuffer({label:"DisplacementParametersBuffer buffer",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.setParameters(o.initialParameters)}setParameters(o){this.device.queue.writeBuffer(this.bufferGpu,0,new Float32Array([o.offsetX,o.offsetY,o.scale]))}destroy(){this.bufferGpu.destroy()}};var Ke=Ot.create(0,0,0),Je={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(r,o={}){return ho(r,o)},onRun:function(r,o,v){wo(r,o,v)},onDestroy:function(r,o){go(o)},onResize:function(r,o){xo(r,o)},onViewportPosition:function(r,o){vo(r,o)},customFunctions:{addTriangle:function(r,o,v){return o.data.trianglesBuffer.addTriangle(v)},removeTriangle:function(r,o,v){o.data.trianglesBuffer.removeTriangle(v)},setPosition:function(r,o,v,m){o.data.trianglesBuffer.setTriangle(v,m)}}};async function ho(r,o){let{device:v}=r,m=new le({device:v,initialParameters:{offsetX:o.options.offseyX??0,offsetY:o.options.offseyY??0,scale:o.options.scale??20}}),P=256,T=P,G=Float32Array.BYTES_PER_ELEMENT*2,U=Float32Array.BYTES_PER_ELEMENT*2,R=Float32Array.BYTES_PER_ELEMENT*2,X=v.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),H=v.createPipelineLayout({bindGroupLayouts:[Y]}),F="repeat",et="linear",W=v.createSampler({label:"displacement ampler",addressModeU:F,addressModeV:F,addressModeW:F,magFilter:et,minFilter:et,mipmapFilter:et}),C=v.createBindGroup({layout:Y,entries:[{binding:0,resource:{buffer:X}},{binding:1,resource:o.refs.color.data.view},{binding:2,resource:W},{binding:3,resource:o.refs.map.view},{binding:4,resource:{buffer:m.bufferGpu}}]}),tt={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},Mt=v.createRenderPipeline({label:"displacement",vertex:{module:v.createShaderModule({code:Me}),entryPoint:"vs_main",buffers:[tt]},fragment:{module:v.createShaderModule({code:Me}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:H}),ft=new fe({device:v,maxSpriteCount:P});return{bindGroup:C,bindGroupLayout:Y,uniformBuffer:X,sampler:W,pipeline:Mt,displacementParameters:m,trianglesBuffer:ft}}function wo(r,o,v){let m=o.data.trianglesBuffer.spriteCount;if(m===0)return;o.data.trianglesBuffer.update();let P=v.beginRenderPass({colorAttachments:[{view:o.refs.out,clearValue:r.clearValue,loadOp:"load",storeOp:"store"}]});P.setPipeline(o.data.pipeline),P.setBindGroup(0,o.data.bindGroup),P.setVertexBuffer(0,o.data.trianglesBuffer.bufferGpu),P.draw(3*m),P.end()}function go(r){r.data.bindGroup=null,r.data.trianglesBuffer.destroy(),r.data.trianglesBuffer=null,r.data.uniformBuffer.destroy(),r.data.uniformBuffer=null,r.data.displacementParameters.destroy(),r.data.displacementParameters=null}function xo(r,o){let{device:v}=r;o.data.bindGroup=v.createBindGroup({layout:o.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:o.data.uniformBuffer}},{binding:1,resource:o.refs.color.data.view},{binding:2,resource:o.data.sampler},{binding:3,resource:o.refs.map.view},{binding:4,resource:{buffer:o.data.displacementParameters.bufferGpu}}]})}function vo(r,o){let{device:v}=r,m=r.viewport.width/r.viewport.zoom,P=r.viewport.height/r.viewport.zoom,T=At.ortho(0,m,P,0,-10,10);Ot.set(-r.viewport.position[0],-r.viewport.position[1],0,Ke);let _=At.translation(Ke),G=[1,1,1],z=0,U=[1,1,0],B=At.identity();At.multiply(At.scaling(G),B,B),At.multiply(At.rotationZ(z),B,B),At.multiply(At.translation(U),B,B);let R=At.identity();At.multiply(_,B,R),At.multiply(T,R,R),v.queue.writeBuffer(o.data.uniformBuffer,0,R.buffer)}function Se(r,o){let v=o.vertices,m=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,P={size:v.byteLength,usage:m,mappedAtCreation:!0},T=r.createBuffer(P);return new Float32Array(T.getMappedRange()).set(v),T.unmap(),{buffer:T,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var Te="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var Tr=be.create(),Ce=Ot.create(),nn={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(r,o={}){return yo(r,o)},onRun:function(r,o,v){Mo(r,o,v)},onDestroy:function(r,o){bo(o)},onResize:function(r,o){tn(r,o)},onViewportPosition:function(r,o){tn(r,o)},customFunctions:{...re}};async function yo(r,o){let{device:v}=r,m=16192,P=m,_=Float32Array.BYTES_PER_ELEMENT*2,z=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*4,X=Float32Array.BYTES_PER_ELEMENT*4,Y=v.createBuffer({size:(_+z+B+X)*P,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),H=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),F=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),et=v.createBindGroup({layout:F,entries:[{binding:0,resource:{buffer:H}},{binding:1,resource:o.refs.spritesheet.data.colorTexture.view},{binding:2,resource:o.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:Y}}]}),W=v.createPipelineLayout({bindGroupLayouts:[F]}),C=v.createRenderPipeline({label:"overlay",vertex:{module:v.createShaderModule({code:Te}),entryPoint:"vs_main",buffers:[o.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:v.createShaderModule({code:Te}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:W});return{instancedDrawCalls:new Uint32Array(m*2),instancedDrawCallCount:0,spriteBuffer:Y,uniformBuffer:H,pipeline:C,bindGroupLayout:F,bindGroup:et,spriteData:new Float32Array(m*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Mo(r,o,v){let{device:m}=r,P=o.options.loadOp||"load";o.data.dirty&&(Do(o.data),o.data.dirty=!1),m.queue.writeBuffer(o.data.spriteBuffer,0,o.data.spriteData.buffer);let T=v.beginRenderPass({colorAttachments:[{view:o.refs.color,clearValue:r.clearValue,loadOp:P,storeOp:"store"}]});T.setPipeline(o.data.pipeline),T.setBindGroup(0,o.data.bindGroup),T.setVertexBuffer(0,o.refs.spritesheet.data.quads.buffer);let _=6,G=0;for(let z=0;z<o.data.instancedDrawCallCount;z++){let U=o.data.instancedDrawCalls[z*2]*_,B=o.data.instancedDrawCalls[z*2+1];T.draw(_,B,U,G),G+=B}T.end()}function Do(r){let o=-1,v=0;r.instancedDrawCallCount=0;for(let m=0;m<r.spriteCount;m++){let P=r.spriteData[m*12+11]&65535;P!==o&&(v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=o,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++),o=P,v=0),v++}v>0&&(r.instancedDrawCalls[r.instancedDrawCallCount*2]=o,r.instancedDrawCalls[r.instancedDrawCallCount*2+1]=v,r.instancedDrawCallCount++)}function tn(r,o){let m=Math.round(r.viewport.width/1),P=Math.round(r.viewport.height/1),T=At.ortho(0,m,P,0,-10,10);Ot.set(0,0,0,Ce);let _=At.translation(Ce);r.device.queue.writeBuffer(o.data.uniformBuffer,0,_.buffer),r.device.queue.writeBuffer(o.data.uniformBuffer,64,T.buffer)}function bo(r){r.data.instancedDrawCalls=null,r.data.bindGroup=null,r.data.spriteBuffer.destroy(),r.data.spriteBuffer=null,r.data.uniformBuffer.destroy(),r.data.uniformBuffer=null,r.data.spriteData=null,r.data.spriteIndices.clear(),r.data.spriteIndices=null}var Pe="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var on={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(r,o={}){return To(r,o)},onRun:function(r,o,v){Po(r,o,v)},onDestroy:function(r,o){},onResize:function(r,o){_o(r,o)},onViewportPosition:function(r,o){}};async function To(r,o){let{device:v}=r,m=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),P=v.createBindGroup({layout:m,entries:[{binding:0,resource:o.refs.in.data.view},{binding:1,resource:o.refs.in.data.sampler}]}),T=v.createPipelineLayout({bindGroupLayouts:[m]}),_=v.createRenderPipeline({label:"fb-blit",vertex:{module:v.createShaderModule({code:Pe}),entryPoint:"vs_main",buffers:[]},fragment:{module:v.createShaderModule({code:Pe}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:T});return{bindGroupLayout:m,bindGroup:P,pipeline:_}}function Po(r,o,v){let{device:m}=r,P=v.beginRenderPass({colorAttachments:[{view:o.refs.out,clearValue:r.clearValue,loadOp:"load",storeOp:"store"}]});P.setPipeline(o.data.pipeline),P.setBindGroup(0,o.data.bindGroup),P.draw(3),P.end()}function _o(r,o){let{device:v}=r;o.data.bindGroup=v.createBindGroup({layout:o.data.bindGroupLayout,entries:[{binding:0,resource:o.refs.in.data.view},{binding:1,resource:o.refs.in.data.sampler}]})}var sn="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function ie(r,o,v,m,P,T=1){let _=ue.sub(m,v),G=ue.normalize(_),z=zo(G),U=T/2,B=o.data.vertexCount*6;o.data.vertices[B+0]=v[0]+z[0]*U,o.data.vertices[B+1]=v[1]+z[1]*U,o.data.vertices[B+2]=P[0],o.data.vertices[B+3]=P[1],o.data.vertices[B+4]=P[2],o.data.vertices[B+5]=P[3],o.data.vertices[B+6]=v[0]-z[0]*U,o.data.vertices[B+7]=v[1]-z[1]*U,o.data.vertices[B+8]=P[0],o.data.vertices[B+9]=P[1],o.data.vertices[B+10]=P[2],o.data.vertices[B+11]=P[3],o.data.vertices[B+12]=m[0]+z[0]*U,o.data.vertices[B+13]=m[1]+z[1]*U,o.data.vertices[B+14]=P[0],o.data.vertices[B+15]=P[1],o.data.vertices[B+16]=P[2],o.data.vertices[B+17]=P[3],o.data.vertices[B+18]=v[0]-z[0]*U,o.data.vertices[B+19]=v[1]-z[1]*U,o.data.vertices[B+20]=P[0],o.data.vertices[B+21]=P[1],o.data.vertices[B+22]=P[2],o.data.vertices[B+23]=P[3],o.data.vertices[B+24]=m[0]+z[0]*U,o.data.vertices[B+25]=m[1]+z[1]*U,o.data.vertices[B+26]=P[0],o.data.vertices[B+27]=P[1],o.data.vertices[B+28]=P[2],o.data.vertices[B+29]=P[3],o.data.vertices[B+30]=m[0]-z[0]*U,o.data.vertices[B+31]=m[1]-z[1]*U,o.data.vertices[B+32]=P[0],o.data.vertices[B+33]=P[1],o.data.vertices[B+34]=P[2],o.data.vertices[B+35]=P[3],o.data.vertexCount+=6,r.device.queue.writeBuffer(o.data.vertexBuffer,0,o.data.vertices.buffer)}function zo(r){return[-r[1],r[0]]}var rn={line:ie,filledEllipse:function(r,o,v,m,P,T,_){let[G,z]=v,U=2*Math.PI/T;for(let B=0;B<T;B++){let R=B*U,X=(B+1)*U,Y=G+m*Math.cos(R),H=z+P*Math.sin(R),F=G+m*Math.cos(X),et=z+P*Math.sin(X),W=o.data.vertexCount*6+B*18;o.data.vertices[W+0]=G,o.data.vertices[W+1]=z,o.data.vertices[W+2]=_[0],o.data.vertices[W+3]=_[1],o.data.vertices[W+4]=_[2],o.data.vertices[W+5]=_[3],o.data.vertices[W+6]=Y,o.data.vertices[W+7]=H,o.data.vertices[W+8]=_[0],o.data.vertices[W+9]=_[1],o.data.vertices[W+10]=_[2],o.data.vertices[W+11]=_[3],o.data.vertices[W+12]=F,o.data.vertices[W+13]=et,o.data.vertices[W+14]=_[0],o.data.vertices[W+15]=_[1],o.data.vertices[W+16]=_[2],o.data.vertices[W+17]=_[3]}o.data.vertexCount+=3*T,r.device.queue.writeBuffer(o.data.vertexBuffer,0,o.data.vertices.buffer)},box:function(r,o,v,m,P,T,_=0,G=1){let[z,U]=v,B=m/2,R=P/2,X=[z-B,U-R],Y=[z+B,U-R],H=[z-B,U+R],F=[z+B,U+R];_!==0&&(Kt(X,v,_,X),Kt(Y,v,_,Y),Kt(H,v,_,H),Kt(F,v,_,F)),ie(r,o,X,Y,T,G),ie(r,o,H,F,T,G),ie(r,o,X,H,T,G),ie(r,o,Y,F,T,G)},filledBox:function(r,o,v,m,P,T,_=0){let[G,z]=v,U=m/2,B=P/2,R=[G-U,z-B],X=[G+U,z-B],Y=[G-U,z+B],H=[G+U,z+B];_!==0&&(Kt(R,v,_,R),Kt(X,v,_,X),Kt(Y,v,_,Y),Kt(H,v,_,H));let F=o.data.vertexCount*6;o.data.vertices[F+0]=R[0],o.data.vertices[F+1]=R[1],o.data.vertices[F+2]=T[0],o.data.vertices[F+3]=T[1],o.data.vertices[F+4]=T[2],o.data.vertices[F+5]=T[3],o.data.vertices[F+6]=Y[0],o.data.vertices[F+7]=Y[1],o.data.vertices[F+8]=T[0],o.data.vertices[F+9]=T[1],o.data.vertices[F+10]=T[2],o.data.vertices[F+11]=T[3],o.data.vertices[F+12]=X[0],o.data.vertices[F+13]=X[1],o.data.vertices[F+14]=T[0],o.data.vertices[F+15]=T[1],o.data.vertices[F+16]=T[2],o.data.vertices[F+17]=T[3],o.data.vertices[F+18]=Y[0],o.data.vertices[F+19]=Y[1],o.data.vertices[F+20]=T[0],o.data.vertices[F+21]=T[1],o.data.vertices[F+22]=T[2],o.data.vertices[F+23]=T[3],o.data.vertices[F+24]=H[0],o.data.vertices[F+25]=H[1],o.data.vertices[F+26]=T[0],o.data.vertices[F+27]=T[1],o.data.vertices[F+28]=T[2],o.data.vertices[F+29]=T[3],o.data.vertices[F+30]=X[0],o.data.vertices[F+31]=X[1],o.data.vertices[F+32]=T[0],o.data.vertices[F+33]=T[1],o.data.vertices[F+34]=T[2],o.data.vertices[F+35]=T[3],o.data.vertexCount+=6,r.device.queue.writeBuffer(o.data.vertexBuffer,0,o.data.vertices.buffer)},clear:function(r,o){o.data.vertexCount=0}};function Kt(r,o,v,m){let P=r[0]-o[0],T=r[1]-o[1],_=Math.sin(v),G=Math.cos(v);return m[0]=P*G-T*_+o[0],m[1]=P*_+T*G+o[1],m}var cn=Ot.create(0,0,0),un={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(r,o={}){return Go(r,o)},onRun:function(r,o,v){Uo(r,o,v)},onDestroy:function(r,o){Lo(o)},onResize:function(r,o){an(r,o)},onViewportPosition:function(r,o){an(r,o)},customFunctions:rn};async function Go(r,o){let{device:v}=r,m=new Float32Array(1e4),P=v.createBuffer({size:m.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),T=v.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),_=v.createShaderModule({code:sn}),G=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),z=v.createPipelineLayout({bindGroupLayouts:[G]}),U=v.createBindGroup({layout:G,entries:[{binding:0,resource:{buffer:T}}]}),B=v.createRenderPipeline({layout:z,vertex:{module:_,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:_,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:T,vertexBuffer:P,pipeline:B,bindGroup:U,vertexCount:0,vertices:m}}function Uo(r,o,v){if(o.data.vertexCount===0)return;let{device:m}=r,P=o.options.loadOp||"load",T=v.beginRenderPass({colorAttachments:[{view:o.refs.color,clearValue:r.clearValue,loadOp:P,storeOp:"store"}]});T.setPipeline(o.data.pipeline),T.setBindGroup(0,o.data.bindGroup),T.setVertexBuffer(0,o.data.vertexBuffer),T.draw(o.data.vertexCount),T.end()}function Lo(r){r.data.vertexBuffer.destroy(),r.data.vertexBuffer=null,r.data.uniformBuffer.destroy(),r.data.uniformBuffer=null}function an(r,o){let{device:v}=r,m=r.viewport.width/r.viewport.zoom,P=r.viewport.height/r.viewport.zoom,T=At.ortho(0,m,P,0,-10,10);Ot.set(-r.viewport.position[0],-r.viewport.position[1],0,cn);let _=At.translation(cn);v.queue.writeBuffer(o.data.uniformBuffer,0,_.buffer),v.queue.writeBuffer(o.data.uniformBuffer,64,T.buffer)}var _e={};Ue(_e,{setAmbientLight:()=>Io,setLights:()=>Eo,setOccluders:()=>Ao});function Eo(r,o,v){o.data.lights=v,o.data.lightsBufferNeedsUpdate=!0}function Io(r,o,v){o.data.lightsRenderer.setAmbientLight(v)}function Ao(r,o,v){o.data.lightsRenderer.setObstacles(v),o.data.lightsTextureNeedsUpdate=!0}function Fo(r,o){return class extends r{constructor(...v){super(...v),o(this)}}}var Ro=Fo(Array,r=>r.fill(0)),k=1e-6;function Oo(r){function o(t=0,a=0){let e=new r(2);return t!==void 0&&(e[0]=t,a!==void 0&&(e[1]=a)),e}let v=o;function m(t,a,e){let s=e??new r(2);return s[0]=t,s[1]=a,s}function P(t,a){let e=a??new r(2);return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function T(t,a){let e=a??new r(2);return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function _(t,a){let e=a??new r(2);return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function G(t,a=0,e=1,s){let f=s??new r(2);return f[0]=Math.min(e,Math.max(a,t[0])),f[1]=Math.min(e,Math.max(a,t[1])),f}function z(t,a,e){let s=e??new r(2);return s[0]=t[0]+a[0],s[1]=t[1]+a[1],s}function U(t,a,e,s){let f=s??new r(2);return f[0]=t[0]+a[0]*e,f[1]=t[1]+a[1]*e,f}function B(t,a){let e=t[0],s=t[1],f=a[0],g=a[1],D=Math.sqrt(e*e+s*s),u=Math.sqrt(f*f+g*g),l=D*u,w=l&&bt(t,a)/l;return Math.acos(w)}function R(t,a,e){let s=e??new r(2);return s[0]=t[0]-a[0],s[1]=t[1]-a[1],s}let X=R;function Y(t,a){return Math.abs(t[0]-a[0])<k&&Math.abs(t[1]-a[1])<k}function H(t,a){return t[0]===a[0]&&t[1]===a[1]}function F(t,a,e,s){let f=s??new r(2);return f[0]=t[0]+e*(a[0]-t[0]),f[1]=t[1]+e*(a[1]-t[1]),f}function et(t,a,e,s){let f=s??new r(2);return f[0]=t[0]+e[0]*(a[0]-t[0]),f[1]=t[1]+e[1]*(a[1]-t[1]),f}function W(t,a,e){let s=e??new r(2);return s[0]=Math.max(t[0],a[0]),s[1]=Math.max(t[1],a[1]),s}function C(t,a,e){let s=e??new r(2);return s[0]=Math.min(t[0],a[0]),s[1]=Math.min(t[1],a[1]),s}function tt(t,a,e){let s=e??new r(2);return s[0]=t[0]*a,s[1]=t[1]*a,s}let Mt=tt;function ft(t,a,e){let s=e??new r(2);return s[0]=t[0]/a,s[1]=t[1]/a,s}function xt(t,a){let e=a??new r(2);return e[0]=1/t[0],e[1]=1/t[1],e}let Dt=xt;function vt(t,a,e){let s=e??new r(3),f=t[0]*a[1]-t[1]*a[0];return s[0]=0,s[1]=0,s[2]=f,s}function bt(t,a){return t[0]*a[0]+t[1]*a[1]}function nt(t){let a=t[0],e=t[1];return Math.sqrt(a*a+e*e)}let Bt=nt;function q(t){let a=t[0],e=t[1];return a*a+e*e}let $=q;function V(t,a){let e=t[0]-a[0],s=t[1]-a[1];return Math.sqrt(e*e+s*s)}let Gt=V;function lt(t,a){let e=t[0]-a[0],s=t[1]-a[1];return e*e+s*s}let Ut=lt;function dt(t,a){let e=a??new r(2),s=t[0],f=t[1],g=Math.sqrt(s*s+f*f);return g>1e-5?(e[0]=s/g,e[1]=f/g):(e[0]=0,e[1]=0),e}function Lt(t,a){let e=a??new r(2);return e[0]=-t[0],e[1]=-t[1],e}function j(t,a){let e=a??new r(2);return e[0]=t[0],e[1]=t[1],e}let Et=j;function mt(t,a,e){let s=e??new r(2);return s[0]=t[0]*a[0],s[1]=t[1]*a[1],s}let It=mt;function yt(t,a,e){let s=e??new r(2);return s[0]=t[0]/a[0],s[1]=t[1]/a[1],s}let zt=yt;function St(t=1,a){let e=a??new r(2),s=Math.random()*2*Math.PI;return e[0]=Math.cos(s)*t,e[1]=Math.sin(s)*t,e}function i(t){let a=t??new r(2);return a[0]=0,a[1]=0,a}function p(t,a,e){let s=e??new r(2),f=t[0],g=t[1];return s[0]=f*a[0]+g*a[4]+a[12],s[1]=f*a[1]+g*a[5]+a[13],s}function n(t,a,e){let s=e??new r(2),f=t[0],g=t[1];return s[0]=a[0]*f+a[4]*g+a[8],s[1]=a[1]*f+a[5]*g+a[9],s}function c(t,a,e,s){let f=s??new r(2),g=t[0]-a[0],D=t[1]-a[1],u=Math.sin(e),l=Math.cos(e);return f[0]=g*l-D*u+a[0],f[1]=g*u+D*l+a[1],f}function d(t,a,e){let s=e??new r(2);return dt(t,s),tt(s,a,s)}function h(t,a,e){let s=e??new r(2);return nt(t)>a?d(t,a,s):j(t,s)}function M(t,a,e){let s=e??new r(2);return F(t,a,.5,s)}return{create:o,fromValues:v,set:m,ceil:P,floor:T,round:_,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:X,equalsApproximately:Y,equals:H,lerp:F,lerpV:et,max:W,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:xt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:$,distance:V,dist:Gt,distanceSq:lt,distSq:Ut,normalize:dt,negate:Lt,copy:j,clone:Et,multiply:mt,mul:It,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat3:n,rotate:c,setLength:d,truncate:h,midpoint:M}}var fn=new Map;function gn(r){let o=fn.get(r);return o||(o=Oo(r),fn.set(r,o)),o}function Vo(r){function o(u,l,w){let x=new r(3);return u!==void 0&&(x[0]=u,l!==void 0&&(x[1]=l,w!==void 0&&(x[2]=w))),x}let v=o;function m(u,l,w,x){let y=x??new r(3);return y[0]=u,y[1]=l,y[2]=w,y}function P(u,l){let w=l??new r(3);return w[0]=Math.ceil(u[0]),w[1]=Math.ceil(u[1]),w[2]=Math.ceil(u[2]),w}function T(u,l){let w=l??new r(3);return w[0]=Math.floor(u[0]),w[1]=Math.floor(u[1]),w[2]=Math.floor(u[2]),w}function _(u,l){let w=l??new r(3);return w[0]=Math.round(u[0]),w[1]=Math.round(u[1]),w[2]=Math.round(u[2]),w}function G(u,l=0,w=1,x){let y=x??new r(3);return y[0]=Math.min(w,Math.max(l,u[0])),y[1]=Math.min(w,Math.max(l,u[1])),y[2]=Math.min(w,Math.max(l,u[2])),y}function z(u,l,w){let x=w??new r(3);return x[0]=u[0]+l[0],x[1]=u[1]+l[1],x[2]=u[2]+l[2],x}function U(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+l[0]*w,y[1]=u[1]+l[1]*w,y[2]=u[2]+l[2]*w,y}function B(u,l){let w=u[0],x=u[1],y=u[2],b=l[0],S=l[1],E=l[2],A=Math.sqrt(w*w+x*x+y*y),L=Math.sqrt(b*b+S*S+E*E),I=A*L,O=I&&bt(u,l)/I;return Math.acos(O)}function R(u,l,w){let x=w??new r(3);return x[0]=u[0]-l[0],x[1]=u[1]-l[1],x[2]=u[2]-l[2],x}let X=R;function Y(u,l){return Math.abs(u[0]-l[0])<k&&Math.abs(u[1]-l[1])<k&&Math.abs(u[2]-l[2])<k}function H(u,l){return u[0]===l[0]&&u[1]===l[1]&&u[2]===l[2]}function F(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w*(l[0]-u[0]),y[1]=u[1]+w*(l[1]-u[1]),y[2]=u[2]+w*(l[2]-u[2]),y}function et(u,l,w,x){let y=x??new r(3);return y[0]=u[0]+w[0]*(l[0]-u[0]),y[1]=u[1]+w[1]*(l[1]-u[1]),y[2]=u[2]+w[2]*(l[2]-u[2]),y}function W(u,l,w){let x=w??new r(3);return x[0]=Math.max(u[0],l[0]),x[1]=Math.max(u[1],l[1]),x[2]=Math.max(u[2],l[2]),x}function C(u,l,w){let x=w??new r(3);return x[0]=Math.min(u[0],l[0]),x[1]=Math.min(u[1],l[1]),x[2]=Math.min(u[2],l[2]),x}function tt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l,x[1]=u[1]*l,x[2]=u[2]*l,x}let Mt=tt;function ft(u,l,w){let x=w??new r(3);return x[0]=u[0]/l,x[1]=u[1]/l,x[2]=u[2]/l,x}function xt(u,l){let w=l??new r(3);return w[0]=1/u[0],w[1]=1/u[1],w[2]=1/u[2],w}let Dt=xt;function vt(u,l,w){let x=w??new r(3),y=u[2]*l[0]-u[0]*l[2],b=u[0]*l[1]-u[1]*l[0];return x[0]=u[1]*l[2]-u[2]*l[1],x[1]=y,x[2]=b,x}function bt(u,l){return u[0]*l[0]+u[1]*l[1]+u[2]*l[2]}function nt(u){let l=u[0],w=u[1],x=u[2];return Math.sqrt(l*l+w*w+x*x)}let Bt=nt;function q(u){let l=u[0],w=u[1],x=u[2];return l*l+w*w+x*x}let $=q;function V(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return Math.sqrt(w*w+x*x+y*y)}let Gt=V;function lt(u,l){let w=u[0]-l[0],x=u[1]-l[1],y=u[2]-l[2];return w*w+x*x+y*y}let Ut=lt;function dt(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=Math.sqrt(x*x+y*y+b*b);return S>1e-5?(w[0]=x/S,w[1]=y/S,w[2]=b/S):(w[0]=0,w[1]=0,w[2]=0),w}function Lt(u,l){let w=l??new r(3);return w[0]=-u[0],w[1]=-u[1],w[2]=-u[2],w}function j(u,l){let w=l??new r(3);return w[0]=u[0],w[1]=u[1],w[2]=u[2],w}let Et=j;function mt(u,l,w){let x=w??new r(3);return x[0]=u[0]*l[0],x[1]=u[1]*l[1],x[2]=u[2]*l[2],x}let It=mt;function yt(u,l,w){let x=w??new r(3);return x[0]=u[0]/l[0],x[1]=u[1]/l[1],x[2]=u[2]/l[2],x}let zt=yt;function St(u=1,l){let w=l??new r(3),x=Math.random()*2*Math.PI,y=Math.random()*2-1,b=Math.sqrt(1-y*y)*u;return w[0]=Math.cos(x)*b,w[1]=Math.sin(x)*b,w[2]=y*u,w}function i(u){let l=u??new r(3);return l[0]=0,l[1]=0,l[2]=0,l}function p(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2],E=l[3]*y+l[7]*b+l[11]*S+l[15]||1;return x[0]=(l[0]*y+l[4]*b+l[8]*S+l[12])/E,x[1]=(l[1]*y+l[5]*b+l[9]*S+l[13])/E,x[2]=(l[2]*y+l[6]*b+l[10]*S+l[14])/E,x}function n(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0*4+0]+b*l[1*4+0]+S*l[2*4+0],x[1]=y*l[0*4+1]+b*l[1*4+1]+S*l[2*4+1],x[2]=y*l[0*4+2]+b*l[1*4+2]+S*l[2*4+2],x}function c(u,l,w){let x=w??new r(3),y=u[0],b=u[1],S=u[2];return x[0]=y*l[0]+b*l[4]+S*l[8],x[1]=y*l[1]+b*l[5]+S*l[9],x[2]=y*l[2]+b*l[6]+S*l[10],x}function d(u,l,w){let x=w??new r(3),y=l[0],b=l[1],S=l[2],E=l[3]*2,A=u[0],L=u[1],I=u[2],O=b*I-S*L,N=S*A-y*I,Z=y*L-b*A;return x[0]=A+O*E+(b*Z-S*N)*2,x[1]=L+N*E+(S*O-y*Z)*2,x[2]=I+Z*E+(y*N-b*O)*2,x}function h(u,l){let w=l??new r(3);return w[0]=u[12],w[1]=u[13],w[2]=u[14],w}function M(u,l,w){let x=w??new r(3),y=l*4;return x[0]=u[y+0],x[1]=u[y+1],x[2]=u[y+2],x}function t(u,l){let w=l??new r(3),x=u[0],y=u[1],b=u[2],S=u[4],E=u[5],A=u[6],L=u[8],I=u[9],O=u[10];return w[0]=Math.sqrt(x*x+y*y+b*b),w[1]=Math.sqrt(S*S+E*E+A*A),w[2]=Math.sqrt(L*L+I*I+O*O),w}function a(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0],S[1]=b[1]*Math.cos(w)-b[2]*Math.sin(w),S[2]=b[1]*Math.sin(w)+b[2]*Math.cos(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function e(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[2]*Math.sin(w)+b[0]*Math.cos(w),S[1]=b[1],S[2]=b[2]*Math.cos(w)-b[0]*Math.sin(w),y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function s(u,l,w,x){let y=x??new r(3),b=[],S=[];return b[0]=u[0]-l[0],b[1]=u[1]-l[1],b[2]=u[2]-l[2],S[0]=b[0]*Math.cos(w)-b[1]*Math.sin(w),S[1]=b[0]*Math.sin(w)+b[1]*Math.cos(w),S[2]=b[2],y[0]=S[0]+l[0],y[1]=S[1]+l[1],y[2]=S[2]+l[2],y}function f(u,l,w){let x=w??new r(3);return dt(u,x),tt(x,l,x)}function g(u,l,w){let x=w??new r(3);return nt(u)>l?f(u,l,x):j(u,x)}function D(u,l,w){let x=w??new r(3);return F(u,l,.5,x)}return{create:o,fromValues:v,set:m,ceil:P,floor:T,round:_,clamp:G,add:z,addScaled:U,angle:B,subtract:R,sub:X,equalsApproximately:Y,equals:H,lerp:F,lerpV:et,max:W,min:C,mulScalar:tt,scale:Mt,divScalar:ft,inverse:xt,invert:Dt,cross:vt,dot:bt,length:nt,len:Bt,lengthSq:q,lenSq:$,distance:V,dist:Gt,distanceSq:lt,distSq:Ut,normalize:dt,negate:Lt,copy:j,clone:Et,multiply:mt,mul:It,divide:yt,div:zt,random:St,zero:i,transformMat4:p,transformMat4Upper3x3:n,transformMat3:c,transformQuat:d,getTranslation:h,getAxis:M,getScaling:t,rotateX:a,rotateY:e,rotateZ:s,setLength:f,truncate:g,midpoint:D}}var ln=new Map;function de(r){let o=ln.get(r);return o||(o=Vo(r),ln.set(r,o)),o}function qo(r){let o=gn(r),v=de(r);function m(i,p,n,c,d,h,M,t,a){let e=new r(12);return e[3]=0,e[7]=0,e[11]=0,i!==void 0&&(e[0]=i,p!==void 0&&(e[1]=p,n!==void 0&&(e[2]=n,c!==void 0&&(e[4]=c,d!==void 0&&(e[5]=d,h!==void 0&&(e[6]=h,M!==void 0&&(e[8]=M,t!==void 0&&(e[9]=t,a!==void 0&&(e[10]=a))))))))),e}function P(i,p,n,c,d,h,M,t,a,e){let s=e??new r(12);return s[0]=i,s[1]=p,s[2]=n,s[3]=0,s[4]=c,s[5]=d,s[6]=h,s[7]=0,s[8]=M,s[9]=t,s[10]=a,s[11]=0,s}function T(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=0,n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=0,n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=0,n}function _(i,p){let n=p??new r(12),c=i[0],d=i[1],h=i[2],M=i[3],t=c+c,a=d+d,e=h+h,s=c*t,f=d*t,g=d*a,D=h*t,u=h*a,l=h*e,w=M*t,x=M*a,y=M*e;return n[0]=1-g-l,n[1]=f+y,n[2]=D-x,n[3]=0,n[4]=f-y,n[5]=1-s-l,n[6]=u+w,n[7]=0,n[8]=D+x,n[9]=u-w,n[10]=1-s-g,n[11]=0,n}function G(i,p){let n=p??new r(12);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[4]=-i[4],n[5]=-i[5],n[6]=-i[6],n[8]=-i[8],n[9]=-i[9],n[10]=-i[10],n}function z(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[8]=i[8],n[9]=i[9],n[10]=i[10],n}let U=z;function B(i,p){return Math.abs(i[0]-p[0])<k&&Math.abs(i[1]-p[1])<k&&Math.abs(i[2]-p[2])<k&&Math.abs(i[4]-p[4])<k&&Math.abs(i[5]-p[5])<k&&Math.abs(i[6]-p[6])<k&&Math.abs(i[8]-p[8])<k&&Math.abs(i[9]-p[9])<k&&Math.abs(i[10]-p[10])<k}function R(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[4]===p[4]&&i[5]===p[5]&&i[6]===p[6]&&i[8]===p[8]&&i[9]===p[9]&&i[10]===p[10]}function X(i){let p=i??new r(12);return p[0]=1,p[1]=0,p[2]=0,p[4]=0,p[5]=1,p[6]=0,p[8]=0,p[9]=0,p[10]=1,p}function Y(i,p){let n=p??new r(12);if(n===i){let g;return g=i[1],i[1]=i[4],i[4]=g,g=i[2],i[2]=i[8],i[8]=g,g=i[6],i[6]=i[9],i[9]=g,n}let c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],s=i[2*4+1],f=i[2*4+2];return n[0]=c,n[1]=M,n[2]=e,n[4]=d,n[5]=t,n[6]=s,n[8]=h,n[9]=a,n[10]=f,n}function H(i,p){let n=p??new r(12),c=i[0*4+0],d=i[0*4+1],h=i[0*4+2],M=i[1*4+0],t=i[1*4+1],a=i[1*4+2],e=i[2*4+0],s=i[2*4+1],f=i[2*4+2],g=f*t-a*s,D=-f*M+a*e,u=s*M-t*e,l=1/(c*g+d*D+h*u);return n[0]=g*l,n[1]=(-f*d+h*s)*l,n[2]=(a*d-h*t)*l,n[4]=D*l,n[5]=(f*c-h*e)*l,n[6]=(-a*c+h*M)*l,n[8]=u*l,n[9]=(-s*c+d*e)*l,n[10]=(t*c-d*M)*l,n}function F(i){let p=i[0],n=i[0*4+1],c=i[0*4+2],d=i[1*4+0],h=i[1*4+1],M=i[1*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2];return p*(h*e-a*M)-d*(n*e-a*c)+t*(n*M-h*c)}let et=H;function W(i,p,n){let c=n??new r(12),d=i[0],h=i[1],M=i[2],t=i[4],a=i[5],e=i[6],s=i[8],f=i[9],g=i[10],D=p[0],u=p[1],l=p[2],w=p[4],x=p[5],y=p[6],b=p[8],S=p[9],E=p[10];return c[0]=d*D+t*u+s*l,c[1]=h*D+a*u+f*l,c[2]=M*D+e*u+g*l,c[4]=d*w+t*x+s*y,c[5]=h*w+a*x+f*y,c[6]=M*w+e*x+g*y,c[8]=d*b+t*S+s*E,c[9]=h*b+a*S+f*E,c[10]=M*b+e*S+g*E,c}let C=W;function tt(i,p,n){let c=n??X();return i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2],c[4]=i[4],c[5]=i[5],c[6]=i[6]),c[8]=p[0],c[9]=p[1],c[10]=1,c}function Mt(i,p){let n=p??o.create();return n[0]=i[8],n[1]=i[9],n}function ft(i,p,n){let c=n??o.create(),d=p*4;return c[0]=i[d+0],c[1]=i[d+1],c}function xt(i,p,n,c){let d=c===i?i:z(i,c),h=n*4;return d[h+0]=p[0],d[h+1]=p[1],d}function Dt(i,p){let n=p??o.create(),c=i[0],d=i[1],h=i[4],M=i[5];return n[0]=Math.sqrt(c*c+d*d),n[1]=Math.sqrt(h*h+M*M),n}function vt(i,p){let n=p??v.create(),c=i[0],d=i[1],h=i[2],M=i[4],t=i[5],a=i[6],e=i[8],s=i[9],f=i[10];return n[0]=Math.sqrt(c*c+d*d+h*h),n[1]=Math.sqrt(M*M+t*t+a*a),n[2]=Math.sqrt(e*e+s*s+f*f),n}function bt(i,p){let n=p??new r(12);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=1,n[6]=0,n[8]=i[0],n[9]=i[1],n[10]=1,n}function nt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=i[0],t=i[1],a=i[2],e=i[1*4+0],s=i[1*4+1],f=i[1*4+2],g=i[2*4+0],D=i[2*4+1],u=i[2*4+2];return i!==c&&(c[0]=M,c[1]=t,c[2]=a,c[4]=e,c[5]=s,c[6]=f),c[8]=M*d+e*h+g,c[9]=t*d+s*h+D,c[10]=a*d+f*h+u,c}function Bt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=d,n[2]=0,n[4]=-d,n[5]=c,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function q(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[1*4+0],a=i[1*4+1],e=i[1*4+2],s=Math.cos(p),f=Math.sin(p);return c[0]=s*d+f*t,c[1]=s*h+f*a,c[2]=s*M+f*e,c[4]=s*t-f*d,c[5]=s*a-f*h,c[6]=s*e-f*M,i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function $(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=1,n[1]=0,n[2]=0,n[4]=0,n[5]=c,n[6]=d,n[8]=0,n[9]=-d,n[10]=c,n}function V(i,p,n){let c=n??new r(12),d=i[4],h=i[5],M=i[6],t=i[8],a=i[9],e=i[10],s=Math.cos(p),f=Math.sin(p);return c[4]=s*d+f*t,c[5]=s*h+f*a,c[6]=s*M+f*e,c[8]=s*t-f*d,c[9]=s*a-f*h,c[10]=s*e-f*M,i!==c&&(c[0]=i[0],c[1]=i[1],c[2]=i[2]),c}function Gt(i,p){let n=p??new r(12),c=Math.cos(i),d=Math.sin(i);return n[0]=c,n[1]=0,n[2]=-d,n[4]=0,n[5]=1,n[6]=0,n[8]=d,n[9]=0,n[10]=c,n}function lt(i,p,n){let c=n??new r(12),d=i[0*4+0],h=i[0*4+1],M=i[0*4+2],t=i[2*4+0],a=i[2*4+1],e=i[2*4+2],s=Math.cos(p),f=Math.sin(p);return c[0]=s*d-f*t,c[1]=s*h-f*a,c[2]=s*M-f*e,c[8]=s*t+f*d,c[9]=s*a+f*h,c[10]=s*e+f*M,i!==c&&(c[4]=i[4],c[5]=i[5],c[6]=i[6]),c}let Ut=Bt,dt=q;function Lt(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function j(i,p,n){let c=n??new r(12),d=p[0],h=p[1];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function Et(i,p){let n=p??new r(12);return n[0]=i[0],n[1]=0,n[2]=0,n[4]=0,n[5]=i[1],n[6]=0,n[8]=0,n[9]=0,n[10]=i[2],n}function mt(i,p,n){let c=n??new r(12),d=p[0],h=p[1],M=p[2];return c[0]=d*i[0*4+0],c[1]=d*i[0*4+1],c[2]=d*i[0*4+2],c[4]=h*i[1*4+0],c[5]=h*i[1*4+1],c[6]=h*i[1*4+2],c[8]=M*i[2*4+0],c[9]=M*i[2*4+1],c[10]=M*i[2*4+2],c}function It(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=1,n}function yt(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],i!==c&&(c[8]=i[8],c[9]=i[9],c[10]=i[10]),c}function zt(i,p){let n=p??new r(12);return n[0]=i,n[1]=0,n[2]=0,n[4]=0,n[5]=i,n[6]=0,n[8]=0,n[9]=0,n[10]=i,n}function St(i,p,n){let c=n??new r(12);return c[0]=p*i[0*4+0],c[1]=p*i[0*4+1],c[2]=p*i[0*4+2],c[4]=p*i[1*4+0],c[5]=p*i[1*4+1],c[6]=p*i[1*4+2],c[8]=p*i[2*4+0],c[9]=p*i[2*4+1],c[10]=p*i[2*4+2],c}return{clone:U,create:m,set:P,fromMat4:T,fromQuat:_,negate:G,copy:z,equalsApproximately:B,equals:R,identity:X,transpose:Y,inverse:H,invert:et,determinant:F,mul:C,multiply:W,setTranslation:tt,getTranslation:Mt,getAxis:ft,setAxis:xt,getScaling:Dt,get3DScaling:vt,translation:bt,translate:nt,rotation:Bt,rotate:q,rotationX:$,rotateX:V,rotationY:Gt,rotateY:lt,rotationZ:Ut,rotateZ:dt,scaling:Lt,scale:j,uniformScaling:It,uniformScale:yt,scaling3D:Et,scale3D:mt,uniformScaling3D:zt,uniformScale3D:St}}var dn=new Map;function No(r){let o=dn.get(r);return o||(o=qo(r),dn.set(r,o)),o}function Yo(r){let o=de(r);function v(t,a,e,s,f,g,D,u,l,w,x,y,b,S,E,A){let L=new r(16);return t!==void 0&&(L[0]=t,a!==void 0&&(L[1]=a,e!==void 0&&(L[2]=e,s!==void 0&&(L[3]=s,f!==void 0&&(L[4]=f,g!==void 0&&(L[5]=g,D!==void 0&&(L[6]=D,u!==void 0&&(L[7]=u,l!==void 0&&(L[8]=l,w!==void 0&&(L[9]=w,x!==void 0&&(L[10]=x,y!==void 0&&(L[11]=y,b!==void 0&&(L[12]=b,S!==void 0&&(L[13]=S,E!==void 0&&(L[14]=E,A!==void 0&&(L[15]=A)))))))))))))))),L}function m(t,a,e,s,f,g,D,u,l,w,x,y,b,S,E,A,L){let I=L??new r(16);return I[0]=t,I[1]=a,I[2]=e,I[3]=s,I[4]=f,I[5]=g,I[6]=D,I[7]=u,I[8]=l,I[9]=w,I[10]=x,I[11]=y,I[12]=b,I[13]=S,I[14]=E,I[15]=A,I}function P(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function T(t,a){let e=a??new r(16),s=t[0],f=t[1],g=t[2],D=t[3],u=s+s,l=f+f,w=g+g,x=s*u,y=f*u,b=f*l,S=g*u,E=g*l,A=g*w,L=D*u,I=D*l,O=D*w;return e[0]=1-b-A,e[1]=y+O,e[2]=S-I,e[3]=0,e[4]=y-O,e[5]=1-x-A,e[6]=E+L,e[7]=0,e[8]=S+I,e[9]=E-L,e[10]=1-x-b,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function _(t,a){let e=a??new r(16);return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function G(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}let z=G;function U(t,a){return Math.abs(t[0]-a[0])<k&&Math.abs(t[1]-a[1])<k&&Math.abs(t[2]-a[2])<k&&Math.abs(t[3]-a[3])<k&&Math.abs(t[4]-a[4])<k&&Math.abs(t[5]-a[5])<k&&Math.abs(t[6]-a[6])<k&&Math.abs(t[7]-a[7])<k&&Math.abs(t[8]-a[8])<k&&Math.abs(t[9]-a[9])<k&&Math.abs(t[10]-a[10])<k&&Math.abs(t[11]-a[11])<k&&Math.abs(t[12]-a[12])<k&&Math.abs(t[13]-a[13])<k&&Math.abs(t[14]-a[14])<k&&Math.abs(t[15]-a[15])<k}function B(t,a){return t[0]===a[0]&&t[1]===a[1]&&t[2]===a[2]&&t[3]===a[3]&&t[4]===a[4]&&t[5]===a[5]&&t[6]===a[6]&&t[7]===a[7]&&t[8]===a[8]&&t[9]===a[9]&&t[10]===a[10]&&t[11]===a[11]&&t[12]===a[12]&&t[13]===a[13]&&t[14]===a[14]&&t[15]===a[15]}function R(t){let a=t??new r(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function X(t,a){let e=a??new r(16);if(e===t){let N;return N=t[1],t[1]=t[4],t[4]=N,N=t[2],t[2]=t[8],t[8]=N,N=t[3],t[3]=t[12],t[12]=N,N=t[6],t[6]=t[9],t[9]=N,N=t[7],t[7]=t[13],t[13]=N,N=t[11],t[11]=t[14],t[14]=N,e}let s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],A=t[3*4+0],L=t[3*4+1],I=t[3*4+2],O=t[3*4+3];return e[0]=s,e[1]=u,e[2]=y,e[3]=A,e[4]=f,e[5]=l,e[6]=b,e[7]=L,e[8]=g,e[9]=w,e[10]=S,e[11]=I,e[12]=D,e[13]=x,e[14]=E,e[15]=O,e}function Y(t,a){let e=a??new r(16),s=t[0*4+0],f=t[0*4+1],g=t[0*4+2],D=t[0*4+3],u=t[1*4+0],l=t[1*4+1],w=t[1*4+2],x=t[1*4+3],y=t[2*4+0],b=t[2*4+1],S=t[2*4+2],E=t[2*4+3],A=t[3*4+0],L=t[3*4+1],I=t[3*4+2],O=t[3*4+3],N=S*O,Z=I*E,K=w*O,J=I*x,ot=w*E,st=S*x,rt=g*O,it=I*D,ct=g*E,at=S*D,pt=g*x,ht=w*D,wt=y*L,gt=A*b,Tt=u*L,Pt=A*l,_t=u*b,$t=y*l,Xt=s*L,Ht=A*f,Wt=s*b,jt=y*f,Zt=s*l,Qt=u*f,Ct=N*l+J*b+ot*L-(Z*l+K*b+st*L),te=Z*f+rt*b+at*L-(N*f+it*b+ct*L),ee=K*f+it*l+pt*L-(J*f+rt*l+ht*L),ne=st*f+ct*l+ht*b-(ot*f+at*l+pt*b),ut=1/(s*Ct+u*te+y*ee+A*ne);return e[0]=ut*Ct,e[1]=ut*te,e[2]=ut*ee,e[3]=ut*ne,e[4]=ut*(Z*u+K*y+st*A-(N*u+J*y+ot*A)),e[5]=ut*(N*s+it*y+ct*A-(Z*s+rt*y+at*A)),e[6]=ut*(J*s+rt*u+ht*A-(K*s+it*u+pt*A)),e[7]=ut*(ot*s+at*u+pt*y-(st*s+ct*u+ht*y)),e[8]=ut*(wt*x+Pt*E+_t*O-(gt*x+Tt*E+$t*O)),e[9]=ut*(gt*D+Xt*E+jt*O-(wt*D+Ht*E+Wt*O)),e[10]=ut*(Tt*D+Ht*x+Zt*O-(Pt*D+Xt*x+Qt*O)),e[11]=ut*($t*D+Wt*x+Qt*E-(_t*D+jt*x+Zt*E)),e[12]=ut*(Tt*S+$t*I+gt*w-(_t*I+wt*w+Pt*S)),e[13]=ut*(Wt*I+wt*g+Ht*S-(Xt*S+jt*I+gt*g)),e[14]=ut*(Xt*w+Qt*I+Pt*g-(Zt*I+Tt*g+Ht*w)),e[15]=ut*(Zt*S+_t*g+jt*w-(Wt*w+Qt*S+$t*g)),e}function H(t){let a=t[0],e=t[0*4+1],s=t[0*4+2],f=t[0*4+3],g=t[1*4+0],D=t[1*4+1],u=t[1*4+2],l=t[1*4+3],w=t[2*4+0],x=t[2*4+1],y=t[2*4+2],b=t[2*4+3],S=t[3*4+0],E=t[3*4+1],A=t[3*4+2],L=t[3*4+3],I=y*L,O=A*b,N=u*L,Z=A*l,K=u*b,J=y*l,ot=s*L,st=A*f,rt=s*b,it=y*f,ct=s*l,at=u*f,pt=I*D+Z*x+K*E-(O*D+N*x+J*E),ht=O*e+ot*x+it*E-(I*e+st*x+rt*E),wt=N*e+st*D+ct*E-(Z*e+ot*D+at*E),gt=J*e+rt*D+at*x-(K*e+it*D+ct*x);return a*pt+g*ht+w*wt+S*gt}let F=Y;function et(t,a,e){let s=e??new r(16),f=t[0],g=t[1],D=t[2],u=t[3],l=t[4],w=t[5],x=t[6],y=t[7],b=t[8],S=t[9],E=t[10],A=t[11],L=t[12],I=t[13],O=t[14],N=t[15],Z=a[0],K=a[1],J=a[2],ot=a[3],st=a[4],rt=a[5],it=a[6],ct=a[7],at=a[8],pt=a[9],ht=a[10],wt=a[11],gt=a[12],Tt=a[13],Pt=a[14],_t=a[15];return s[0]=f*Z+l*K+b*J+L*ot,s[1]=g*Z+w*K+S*J+I*ot,s[2]=D*Z+x*K+E*J+O*ot,s[3]=u*Z+y*K+A*J+N*ot,s[4]=f*st+l*rt+b*it+L*ct,s[5]=g*st+w*rt+S*it+I*ct,s[6]=D*st+x*rt+E*it+O*ct,s[7]=u*st+y*rt+A*it+N*ct,s[8]=f*at+l*pt+b*ht+L*wt,s[9]=g*at+w*pt+S*ht+I*wt,s[10]=D*at+x*pt+E*ht+O*wt,s[11]=u*at+y*pt+A*ht+N*wt,s[12]=f*gt+l*Tt+b*Pt+L*_t,s[13]=g*gt+w*Tt+S*Pt+I*_t,s[14]=D*gt+x*Tt+E*Pt+O*_t,s[15]=u*gt+y*Tt+A*Pt+N*_t,s}let W=et;function C(t,a,e){let s=e??R();return t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11]),s[12]=a[0],s[13]=a[1],s[14]=a[2],s[15]=1,s}function tt(t,a){let e=a??o.create();return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Mt(t,a,e){let s=e??o.create(),f=a*4;return s[0]=t[f+0],s[1]=t[f+1],s[2]=t[f+2],s}function ft(t,a,e,s){let f=s===t?s:G(t,s),g=e*4;return f[g+0]=a[0],f[g+1]=a[1],f[g+2]=a[2],f}function xt(t,a){let e=a??o.create(),s=t[0],f=t[1],g=t[2],D=t[4],u=t[5],l=t[6],w=t[8],x=t[9],y=t[10];return e[0]=Math.sqrt(s*s+f*f+g*g),e[1]=Math.sqrt(D*D+u*u+l*l),e[2]=Math.sqrt(w*w+x*x+y*y),e}function Dt(t,a,e,s,f){let g=f??new r(16),D=Math.tan(Math.PI*.5-.5*t);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,Number.isFinite(s)){let u=1/(e-s);g[10]=s*u,g[14]=s*e*u}else g[10]=-1,g[14]=-e;return g}function vt(t,a,e,s=1/0,f){let g=f??new r(16),D=1/Math.tan(t*.5);if(g[0]=D/a,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=D,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,s===1/0)g[10]=0,g[14]=e;else{let u=1/(s-e);g[10]=e*u,g[14]=s*e*u}return g}function bt(t,a,e,s,f,g,D){let u=D??new r(16);return u[0]=2/(a-t),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(s-e),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1/(f-g),u[11]=0,u[12]=(a+t)/(t-a),u[13]=(s+e)/(e-s),u[14]=f/(f-g),u[15]=1,u}function nt(t,a,e,s,f,g,D){let u=D??new r(16),l=a-t,w=s-e,x=f-g;return u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(s+e)/w,u[10]=g/x,u[11]=-1,u[12]=0,u[13]=0,u[14]=f*g/x,u[15]=0,u}function Bt(t,a,e,s,f,g=1/0,D){let u=D??new r(16),l=a-t,w=s-e;if(u[0]=2*f/l,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*f/w,u[6]=0,u[7]=0,u[8]=(t+a)/l,u[9]=(s+e)/w,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,g===1/0)u[10]=0,u[14]=f;else{let x=1/(g-f);u[10]=f*x,u[14]=g*f*x}return u}let q=o.create(),$=o.create(),V=o.create();function Gt(t,a,e,s){let f=s??new r(16);return o.normalize(o.subtract(a,t,V),V),o.normalize(o.cross(e,V,q),q),o.normalize(o.cross(V,q,$),$),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=$[0],f[5]=$[1],f[6]=$[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function lt(t,a,e,s){let f=s??new r(16);return o.normalize(o.subtract(t,a,V),V),o.normalize(o.cross(e,V,q),q),o.normalize(o.cross(V,q,$),$),f[0]=q[0],f[1]=q[1],f[2]=q[2],f[3]=0,f[4]=$[0],f[5]=$[1],f[6]=$[2],f[7]=0,f[8]=V[0],f[9]=V[1],f[10]=V[2],f[11]=0,f[12]=t[0],f[13]=t[1],f[14]=t[2],f[15]=1,f}function Ut(t,a,e,s){let f=s??new r(16);return o.normalize(o.subtract(t,a,V),V),o.normalize(o.cross(e,V,q),q),o.normalize(o.cross(V,q,$),$),f[0]=q[0],f[1]=$[0],f[2]=V[0],f[3]=0,f[4]=q[1],f[5]=$[1],f[6]=V[1],f[7]=0,f[8]=q[2],f[9]=$[2],f[10]=V[2],f[11]=0,f[12]=-(q[0]*t[0]+q[1]*t[1]+q[2]*t[2]),f[13]=-($[0]*t[0]+$[1]*t[1]+$[2]*t[2]),f[14]=-(V[0]*t[0]+V[1]*t[1]+V[2]*t[2]),f[15]=1,f}function dt(t,a){let e=a??new r(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Lt(t,a,e){let s=e??new r(16),f=a[0],g=a[1],D=a[2],u=t[0],l=t[1],w=t[2],x=t[3],y=t[1*4+0],b=t[1*4+1],S=t[1*4+2],E=t[1*4+3],A=t[2*4+0],L=t[2*4+1],I=t[2*4+2],O=t[2*4+3],N=t[3*4+0],Z=t[3*4+1],K=t[3*4+2],J=t[3*4+3];return t!==s&&(s[0]=u,s[1]=l,s[2]=w,s[3]=x,s[4]=y,s[5]=b,s[6]=S,s[7]=E,s[8]=A,s[9]=L,s[10]=I,s[11]=O),s[12]=u*f+y*g+A*D+N,s[13]=l*f+b*g+L*D+Z,s[14]=w*f+S*g+I*D+K,s[15]=x*f+E*g+O*D+J,s}function j(t,a){let e=a??new r(16),s=Math.cos(t),f=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=f,e[7]=0,e[8]=0,e[9]=-f,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Et(t,a,e){let s=e??new r(16),f=t[4],g=t[5],D=t[6],u=t[7],l=t[8],w=t[9],x=t[10],y=t[11],b=Math.cos(a),S=Math.sin(a);return s[4]=b*f+S*l,s[5]=b*g+S*w,s[6]=b*D+S*x,s[7]=b*u+S*y,s[8]=b*l-S*f,s[9]=b*w-S*g,s[10]=b*x-S*D,s[11]=b*y-S*u,t!==s&&(s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function mt(t,a){let e=a??new r(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=0,e[2]=-f,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=f,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function It(t,a,e){let s=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[2*4+0],w=t[2*4+1],x=t[2*4+2],y=t[2*4+3],b=Math.cos(a),S=Math.sin(a);return s[0]=b*f-S*l,s[1]=b*g-S*w,s[2]=b*D-S*x,s[3]=b*u-S*y,s[8]=b*l+S*f,s[9]=b*w+S*g,s[10]=b*x+S*D,s[11]=b*y+S*u,t!==s&&(s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function yt(t,a){let e=a??new r(16),s=Math.cos(t),f=Math.sin(t);return e[0]=s,e[1]=f,e[2]=0,e[3]=0,e[4]=-f,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function zt(t,a,e){let s=e??new r(16),f=t[0*4+0],g=t[0*4+1],D=t[0*4+2],u=t[0*4+3],l=t[1*4+0],w=t[1*4+1],x=t[1*4+2],y=t[1*4+3],b=Math.cos(a),S=Math.sin(a);return s[0]=b*f+S*l,s[1]=b*g+S*w,s[2]=b*D+S*x,s[3]=b*u+S*y,s[4]=b*l-S*f,s[5]=b*w-S*g,s[6]=b*x-S*D,s[7]=b*y-S*u,t!==s&&(s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function St(t,a,e){let s=e??new r(16),f=t[0],g=t[1],D=t[2],u=Math.sqrt(f*f+g*g+D*D);f/=u,g/=u,D/=u;let l=f*f,w=g*g,x=D*D,y=Math.cos(a),b=Math.sin(a),S=1-y;return s[0]=l+(1-l)*y,s[1]=f*g*S+D*b,s[2]=f*D*S-g*b,s[3]=0,s[4]=f*g*S-D*b,s[5]=w+(1-w)*y,s[6]=g*D*S+f*b,s[7]=0,s[8]=f*D*S+g*b,s[9]=g*D*S-f*b,s[10]=x+(1-x)*y,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}let i=St;function p(t,a,e,s){let f=s??new r(16),g=a[0],D=a[1],u=a[2],l=Math.sqrt(g*g+D*D+u*u);g/=l,D/=l,u/=l;let w=g*g,x=D*D,y=u*u,b=Math.cos(e),S=Math.sin(e),E=1-b,A=w+(1-w)*b,L=g*D*E+u*S,I=g*u*E-D*S,O=g*D*E-u*S,N=x+(1-x)*b,Z=D*u*E+g*S,K=g*u*E+D*S,J=D*u*E-g*S,ot=y+(1-y)*b,st=t[0],rt=t[1],it=t[2],ct=t[3],at=t[4],pt=t[5],ht=t[6],wt=t[7],gt=t[8],Tt=t[9],Pt=t[10],_t=t[11];return f[0]=A*st+L*at+I*gt,f[1]=A*rt+L*pt+I*Tt,f[2]=A*it+L*ht+I*Pt,f[3]=A*ct+L*wt+I*_t,f[4]=O*st+N*at+Z*gt,f[5]=O*rt+N*pt+Z*Tt,f[6]=O*it+N*ht+Z*Pt,f[7]=O*ct+N*wt+Z*_t,f[8]=K*st+J*at+ot*gt,f[9]=K*rt+J*pt+ot*Tt,f[10]=K*it+J*ht+ot*Pt,f[11]=K*ct+J*wt+ot*_t,t!==f&&(f[12]=t[12],f[13]=t[13],f[14]=t[14],f[15]=t[15]),f}let n=p;function c(t,a){let e=a??new r(16);return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function d(t,a,e){let s=e??new r(16),f=a[0],g=a[1],D=a[2];return s[0]=f*t[0*4+0],s[1]=f*t[0*4+1],s[2]=f*t[0*4+2],s[3]=f*t[0*4+3],s[4]=g*t[1*4+0],s[5]=g*t[1*4+1],s[6]=g*t[1*4+2],s[7]=g*t[1*4+3],s[8]=D*t[2*4+0],s[9]=D*t[2*4+1],s[10]=D*t[2*4+2],s[11]=D*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}function h(t,a){let e=a??new r(16);return e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function M(t,a,e){let s=e??new r(16);return s[0]=a*t[0*4+0],s[1]=a*t[0*4+1],s[2]=a*t[0*4+2],s[3]=a*t[0*4+3],s[4]=a*t[1*4+0],s[5]=a*t[1*4+1],s[6]=a*t[1*4+2],s[7]=a*t[1*4+3],s[8]=a*t[2*4+0],s[9]=a*t[2*4+1],s[10]=a*t[2*4+2],s[11]=a*t[2*4+3],t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s}return{create:v,set:m,fromMat3:P,fromQuat:T,negate:_,copy:G,clone:z,equalsApproximately:U,equals:B,identity:R,transpose:X,inverse:Y,determinant:H,invert:F,multiply:et,mul:W,setTranslation:C,getTranslation:tt,getAxis:Mt,setAxis:ft,getScaling:xt,perspective:Dt,perspectiveReverseZ:vt,ortho:bt,frustum:nt,frustumReverseZ:Bt,aim:Gt,cameraAim:lt,lookAt:Ut,translation:dt,translate:Lt,rotationX:j,rotateX:Et,rotationY:mt,rotateY:It,rotationZ:yt,rotateZ:zt,axisRotation:St,rotation:i,axisRotate:p,rotate:n,scaling:c,scale:d,uniformScaling:h,uniformScale:M}}var pn=new Map;function $o(r){let o=pn.get(r);return o||(o=Yo(r),pn.set(r,o)),o}function Xo(r){let o=de(r);function v(i,p,n,c){let d=new r(4);return i!==void 0&&(d[0]=i,p!==void 0&&(d[1]=p,n!==void 0&&(d[2]=n,c!==void 0&&(d[3]=c)))),d}let m=v;function P(i,p,n,c,d){let h=d??new r(4);return h[0]=i,h[1]=p,h[2]=n,h[3]=c,h}function T(i,p,n){let c=n??new r(4),d=p*.5,h=Math.sin(d);return c[0]=h*i[0],c[1]=h*i[1],c[2]=h*i[2],c[3]=Math.cos(d),c}function _(i,p){let n=p??o.create(3),c=Math.acos(i[3])*2,d=Math.sin(c*.5);return d>k?(n[0]=i[0]/d,n[1]=i[1]/d,n[2]=i[2]/d):(n[0]=1,n[1]=0,n[2]=0),{angle:c,axis:n}}function G(i,p){let n=nt(i,p);return Math.acos(2*n*n-1)}function z(i,p,n){let c=n??new r(4),d=i[0],h=i[1],M=i[2],t=i[3],a=p[0],e=p[1],s=p[2],f=p[3];return c[0]=d*f+t*a+h*s-M*e,c[1]=h*f+t*e+M*a-d*s,c[2]=M*f+t*s+d*e-h*a,c[3]=t*f-d*a-h*e-M*s,c}let U=z;function B(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),s=Math.cos(d);return c[0]=h*s+a*e,c[1]=M*s+t*e,c[2]=t*s-M*e,c[3]=a*s-h*e,c}function R(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),s=Math.cos(d);return c[0]=h*s-t*e,c[1]=M*s+a*e,c[2]=t*s+h*e,c[3]=a*s-M*e,c}function X(i,p,n){let c=n??new r(4),d=p*.5,h=i[0],M=i[1],t=i[2],a=i[3],e=Math.sin(d),s=Math.cos(d);return c[0]=h*s+M*e,c[1]=M*s-h*e,c[2]=t*s+a*e,c[3]=a*s-t*e,c}function Y(i,p,n,c){let d=c??new r(4),h=i[0],M=i[1],t=i[2],a=i[3],e=p[0],s=p[1],f=p[2],g=p[3],D=h*e+M*s+t*f+a*g;D<0&&(D=-D,e=-e,s=-s,f=-f,g=-g);let u,l;if(1-D>k){let w=Math.acos(D),x=Math.sin(w);u=Math.sin((1-n)*w)/x,l=Math.sin(n*w)/x}else u=1-n,l=n;return d[0]=u*h+l*e,d[1]=u*M+l*s,d[2]=u*t+l*f,d[3]=u*a+l*g,d}function H(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=c*c+d*d+h*h+M*M,a=t?1/t:0;return n[0]=-c*a,n[1]=-d*a,n[2]=-h*a,n[3]=M*a,n}function F(i,p){let n=p??new r(4);return n[0]=-i[0],n[1]=-i[1],n[2]=-i[2],n[3]=i[3],n}function et(i,p){let n=p??new r(4),c=i[0]+i[5]+i[10];if(c>0){let d=Math.sqrt(c+1);n[3]=.5*d;let h=.5/d;n[0]=(i[6]-i[9])*h,n[1]=(i[8]-i[2])*h,n[2]=(i[1]-i[4])*h}else{let d=0;i[5]>i[0]&&(d=1),i[10]>i[d*4+d]&&(d=2);let h=(d+1)%3,M=(d+2)%3,t=Math.sqrt(i[d*4+d]-i[h*4+h]-i[M*4+M]+1);n[d]=.5*t;let a=.5/t;n[3]=(i[h*4+M]-i[M*4+h])*a,n[h]=(i[h*4+d]+i[d*4+h])*a,n[M]=(i[M*4+d]+i[d*4+M])*a}return n}function W(i,p,n,c,d){let h=d??new r(4),M=i*.5,t=p*.5,a=n*.5,e=Math.sin(M),s=Math.cos(M),f=Math.sin(t),g=Math.cos(t),D=Math.sin(a),u=Math.cos(a);switch(c){case"xyz":h[0]=e*g*u+s*f*D,h[1]=s*f*u-e*g*D,h[2]=s*g*D+e*f*u,h[3]=s*g*u-e*f*D;break;case"xzy":h[0]=e*g*u-s*f*D,h[1]=s*f*u-e*g*D,h[2]=s*g*D+e*f*u,h[3]=s*g*u+e*f*D;break;case"yxz":h[0]=e*g*u+s*f*D,h[1]=s*f*u-e*g*D,h[2]=s*g*D-e*f*u,h[3]=s*g*u+e*f*D;break;case"yzx":h[0]=e*g*u+s*f*D,h[1]=s*f*u+e*g*D,h[2]=s*g*D-e*f*u,h[3]=s*g*u-e*f*D;break;case"zxy":h[0]=e*g*u-s*f*D,h[1]=s*f*u+e*g*D,h[2]=s*g*D+e*f*u,h[3]=s*g*u-e*f*D;break;case"zyx":h[0]=e*g*u-s*f*D,h[1]=s*f*u+e*g*D,h[2]=s*g*D-e*f*u,h[3]=s*g*u+e*f*D;break;default:throw new Error(`Unknown rotation order: ${c}`)}return h}function C(i,p){let n=p??new r(4);return n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n}let tt=C;function Mt(i,p,n){let c=n??new r(4);return c[0]=i[0]+p[0],c[1]=i[1]+p[1],c[2]=i[2]+p[2],c[3]=i[3]+p[3],c}function ft(i,p,n){let c=n??new r(4);return c[0]=i[0]-p[0],c[1]=i[1]-p[1],c[2]=i[2]-p[2],c[3]=i[3]-p[3],c}let xt=ft;function Dt(i,p,n){let c=n??new r(4);return c[0]=i[0]*p,c[1]=i[1]*p,c[2]=i[2]*p,c[3]=i[3]*p,c}let vt=Dt;function bt(i,p,n){let c=n??new r(4);return c[0]=i[0]/p,c[1]=i[1]/p,c[2]=i[2]/p,c[3]=i[3]/p,c}function nt(i,p){return i[0]*p[0]+i[1]*p[1]+i[2]*p[2]+i[3]*p[3]}function Bt(i,p,n,c){let d=c??new r(4);return d[0]=i[0]+n*(p[0]-i[0]),d[1]=i[1]+n*(p[1]-i[1]),d[2]=i[2]+n*(p[2]-i[2]),d[3]=i[3]+n*(p[3]-i[3]),d}function q(i){let p=i[0],n=i[1],c=i[2],d=i[3];return Math.sqrt(p*p+n*n+c*c+d*d)}let $=q;function V(i){let p=i[0],n=i[1],c=i[2],d=i[3];return p*p+n*n+c*c+d*d}let Gt=V;function lt(i,p){let n=p??new r(4),c=i[0],d=i[1],h=i[2],M=i[3],t=Math.sqrt(c*c+d*d+h*h+M*M);return t>1e-5?(n[0]=c/t,n[1]=d/t,n[2]=h/t,n[3]=M/t):(n[0]=0,n[1]=0,n[2]=0,n[3]=1),n}function Ut(i,p){return Math.abs(i[0]-p[0])<k&&Math.abs(i[1]-p[1])<k&&Math.abs(i[2]-p[2])<k&&Math.abs(i[3]-p[3])<k}function dt(i,p){return i[0]===p[0]&&i[1]===p[1]&&i[2]===p[2]&&i[3]===p[3]}function Lt(i){let p=i??new r(4);return p[0]=0,p[1]=0,p[2]=0,p[3]=1,p}let j=o.create(),Et=o.create(),mt=o.create();function It(i,p,n){let c=n??new r(4),d=o.dot(i,p);return d<-.999999?(o.cross(Et,i,j),o.len(j)<1e-6&&o.cross(mt,i,j),o.normalize(j,j),T(j,Math.PI,c),c):d>.999999?(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c):(o.cross(i,p,j),c[0]=j[0],c[1]=j[1],c[2]=j[2],c[3]=1+d,lt(c,c))}let yt=new r(4),zt=new r(4);function St(i,p,n,c,d,h){let M=h??new r(4);return Y(i,c,d,yt),Y(p,n,d,zt),Y(yt,zt,2*d*(1-d),M),M}return{create:v,fromValues:m,set:P,fromAxisAngle:T,toAxisAngle:_,angle:G,multiply:z,mul:U,rotateX:B,rotateY:R,rotateZ:X,slerp:Y,inverse:H,conjugate:F,fromMat:et,fromEuler:W,copy:C,clone:tt,add:Mt,subtract:ft,sub:xt,mulScalar:Dt,scale:vt,divScalar:bt,dot:nt,lerp:Bt,length:q,len:$,lengthSq:V,lenSq:Gt,normalize:lt,equalsApproximately:Ut,equals:dt,identity:Lt,rotationTo:It,sqlerp:St}}var hn=new Map;function Ho(r){let o=hn.get(r);return o||(o=Xo(r),hn.set(r,o)),o}function Wo(r){function o(n,c,d,h){let M=new r(4);return n!==void 0&&(M[0]=n,c!==void 0&&(M[1]=c,d!==void 0&&(M[2]=d,h!==void 0&&(M[3]=h)))),M}let v=o;function m(n,c,d,h,M){let t=M??new r(4);return t[0]=n,t[1]=c,t[2]=d,t[3]=h,t}function P(n,c){let d=c??new r(4);return d[0]=Math.ceil(n[0]),d[1]=Math.ceil(n[1]),d[2]=Math.ceil(n[2]),d[3]=Math.ceil(n[3]),d}function T(n,c){let d=c??new r(4);return d[0]=Math.floor(n[0]),d[1]=Math.floor(n[1]),d[2]=Math.floor(n[2]),d[3]=Math.floor(n[3]),d}function _(n,c){let d=c??new r(4);return d[0]=Math.round(n[0]),d[1]=Math.round(n[1]),d[2]=Math.round(n[2]),d[3]=Math.round(n[3]),d}function G(n,c=0,d=1,h){let M=h??new r(4);return M[0]=Math.min(d,Math.max(c,n[0])),M[1]=Math.min(d,Math.max(c,n[1])),M[2]=Math.min(d,Math.max(c,n[2])),M[3]=Math.min(d,Math.max(c,n[3])),M}function z(n,c,d){let h=d??new r(4);return h[0]=n[0]+c[0],h[1]=n[1]+c[1],h[2]=n[2]+c[2],h[3]=n[3]+c[3],h}function U(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+c[0]*d,M[1]=n[1]+c[1]*d,M[2]=n[2]+c[2]*d,M[3]=n[3]+c[3]*d,M}function B(n,c,d){let h=d??new r(4);return h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2],h[3]=n[3]-c[3],h}let R=B;function X(n,c){return Math.abs(n[0]-c[0])<k&&Math.abs(n[1]-c[1])<k&&Math.abs(n[2]-c[2])<k&&Math.abs(n[3]-c[3])<k}function Y(n,c){return n[0]===c[0]&&n[1]===c[1]&&n[2]===c[2]&&n[3]===c[3]}function H(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d*(c[0]-n[0]),M[1]=n[1]+d*(c[1]-n[1]),M[2]=n[2]+d*(c[2]-n[2]),M[3]=n[3]+d*(c[3]-n[3]),M}function F(n,c,d,h){let M=h??new r(4);return M[0]=n[0]+d[0]*(c[0]-n[0]),M[1]=n[1]+d[1]*(c[1]-n[1]),M[2]=n[2]+d[2]*(c[2]-n[2]),M[3]=n[3]+d[3]*(c[3]-n[3]),M}function et(n,c,d){let h=d??new r(4);return h[0]=Math.max(n[0],c[0]),h[1]=Math.max(n[1],c[1]),h[2]=Math.max(n[2],c[2]),h[3]=Math.max(n[3],c[3]),h}function W(n,c,d){let h=d??new r(4);return h[0]=Math.min(n[0],c[0]),h[1]=Math.min(n[1],c[1]),h[2]=Math.min(n[2],c[2]),h[3]=Math.min(n[3],c[3]),h}function C(n,c,d){let h=d??new r(4);return h[0]=n[0]*c,h[1]=n[1]*c,h[2]=n[2]*c,h[3]=n[3]*c,h}let tt=C;function Mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c,h[1]=n[1]/c,h[2]=n[2]/c,h[3]=n[3]/c,h}function ft(n,c){let d=c??new r(4);return d[0]=1/n[0],d[1]=1/n[1],d[2]=1/n[2],d[3]=1/n[3],d}let xt=ft;function Dt(n,c){return n[0]*c[0]+n[1]*c[1]+n[2]*c[2]+n[3]*c[3]}function vt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return Math.sqrt(c*c+d*d+h*h+M*M)}let bt=vt;function nt(n){let c=n[0],d=n[1],h=n[2],M=n[3];return c*c+d*d+h*h+M*M}let Bt=nt;function q(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return Math.sqrt(d*d+h*h+M*M+t*t)}let $=q;function V(n,c){let d=n[0]-c[0],h=n[1]-c[1],M=n[2]-c[2],t=n[3]-c[3];return d*d+h*h+M*M+t*t}let Gt=V;function lt(n,c){let d=c??new r(4),h=n[0],M=n[1],t=n[2],a=n[3],e=Math.sqrt(h*h+M*M+t*t+a*a);return e>1e-5?(d[0]=h/e,d[1]=M/e,d[2]=t/e,d[3]=a/e):(d[0]=0,d[1]=0,d[2]=0,d[3]=0),d}function Ut(n,c){let d=c??new r(4);return d[0]=-n[0],d[1]=-n[1],d[2]=-n[2],d[3]=-n[3],d}function dt(n,c){let d=c??new r(4);return d[0]=n[0],d[1]=n[1],d[2]=n[2],d[3]=n[3],d}let Lt=dt;function j(n,c,d){let h=d??new r(4);return h[0]=n[0]*c[0],h[1]=n[1]*c[1],h[2]=n[2]*c[2],h[3]=n[3]*c[3],h}let Et=j;function mt(n,c,d){let h=d??new r(4);return h[0]=n[0]/c[0],h[1]=n[1]/c[1],h[2]=n[2]/c[2],h[3]=n[3]/c[3],h}let It=mt;function yt(n){let c=n??new r(4);return c[0]=0,c[1]=0,c[2]=0,c[3]=0,c}function zt(n,c,d){let h=d??new r(4),M=n[0],t=n[1],a=n[2],e=n[3];return h[0]=c[0]*M+c[4]*t+c[8]*a+c[12]*e,h[1]=c[1]*M+c[5]*t+c[9]*a+c[13]*e,h[2]=c[2]*M+c[6]*t+c[10]*a+c[14]*e,h[3]=c[3]*M+c[7]*t+c[11]*a+c[15]*e,h}function St(n,c,d){let h=d??new r(4);return lt(n,h),C(h,c,h)}function i(n,c,d){let h=d??new r(4);return vt(n)>c?St(n,c,h):dt(n,h)}function p(n,c,d){let h=d??new r(4);return H(n,c,.5,h)}return{create:o,fromValues:v,set:m,ceil:P,floor:T,round:_,clamp:G,add:z,addScaled:U,subtract:B,sub:R,equalsApproximately:X,equals:Y,lerp:H,lerpV:F,max:et,min:W,mulScalar:C,scale:tt,divScalar:Mt,inverse:ft,invert:xt,dot:Dt,length:vt,len:bt,lengthSq:nt,lenSq:Bt,distance:q,dist:$,distanceSq:V,distSq:Gt,normalize:lt,negate:Ut,copy:dt,clone:Lt,multiply:j,mul:Et,divide:mt,div:It,zero:yt,transformMat4:zt,setLength:St,truncate:i,midpoint:p}}var wn=new Map;function jo(r){let o=wn.get(r);return o||(o=Wo(r),wn.set(r,o)),o}function Be(r,o,v,m,P,T){return{mat3:No(r),mat4:$o(o),quat:Ho(v),vec2:gn(m),vec3:de(P),vec4:jo(T)}}var{mat3:Wr,mat4:Nt,quat:jr,vec2:Zr,vec3:Qr,vec4:kr}=Be(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:Kr,mat4:Jr,quat:Cr,vec2:ti,vec3:ei,vec4:ni}=Be(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:oi,mat4:si,quat:ri,vec2:ii,vec3:ci,vec4:ai}=Be(Ro,Array,Array,Array,Array,Array);var pe=class{invViewProjectionMatrix=Nt.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(o){this.setViewportSize(o.viewportSize.width,o.viewportSize.height);let v=o.center??this.topLeft;this.setTopLeft(...v);let m=o.zoom??1;this.setZoom(m)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(o,v){this.viewportSize.width=o,this.viewportSize.height=v,this.updateMatrices()}setTopLeft(o,v){this.topLeft[0]=o,this.topLeft[1]=v,this.updateMatrices()}setZoom(o){this.zoom=o,this.updateMatrices()}updateMatrices(){Nt.identity(this.invViewProjectionMatrix),Nt.multiply(Nt.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),Nt.multiply(Nt.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var Vt=class r{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(o,v){this.device=o,this.maxLightsCount=v;let m=new ArrayBuffer(r.computeBufferBytesLength(v)),P=o.createBuffer({label:"LightsBuffer buffer",size:m.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:m,bufferGpu:P},this.setLights([])}setLights(o){if(o.length>this.maxLightsCount)throw new Error(`Too many lights "${o.length}", max is "${this.maxLightsCount}".`);let v=r.computeBufferBytesLength(o.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([o.length]),o.forEach((m,P)=>{new Float32Array(this.buffer.bufferCpu,r.structs.lightsBuffer.lights.offset+r.structs.lightsBuffer.lights.stride*P,9).set([...m.color,m.radius,...m.position,m.intensity,m.attenuationLinear,m.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,v),this.currentLightsCount=o.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(o){return r.structs.lightsBuffer.lights.offset+r.structs.lightsBuffer.lights.stride*o}};var he=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(o,v,m,P){this.lightsBuffer=v;let T=o.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${Vt.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${m.gridSize.x}, ${m.gridSize.y});
const cellsGridSizeF = vec2<f32>(${m.gridSize.x}, ${m.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${P}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=o.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:T,entryPoint:"main_vertex"},fragment:{module:T,entryPoint:"main_fragment",targets:[{format:m.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:m.sampleCount}}),this.bindgroup=o.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let _=o.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[m.format],sampleCount:m.sampleCount});_.setPipeline(this.renderPipeline),_.setBindGroup(0,this.bindgroup),_.draw(4),this.renderBundle=_.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var we=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(o,v,m,P){this.device=o,this.lightsBuffer=v;let T=!0,_=o.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${m.gridSize.x}, ${m.gridSize.y});
const cellsGridSizeF = vec2<f32>(${m.gridSize.x}, ${m.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${P});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=o.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:_,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:Vt.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:Vt.structs.light.position.offset,format:"float32x2"}],arrayStride:Vt.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:_,entryPoint:"main_fragment",targets:[{format:m.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:T?"none":"back",topology:"triangle-list"},multisample:{count:m.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:o.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[m.format],sampleCount:m.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(o){let v=[],m=[];for(let U of o){let B=v.length/3;v.push(...U[0],0,...U[1],0,...U[0],1,...U[1],1),m.push(B+0,B+1,B+3,B+0,B+3,B+2)}let P=!1,T=new Float32Array(v),_=this.obstacles?.positionsBufferGpu;(!_||_.size<T.byteLength)&&(_?.destroy(),_=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:T.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),P=!0),this.device.queue.writeBuffer(_,0,T);let G=new Uint16Array(m),z=this.obstacles?.indexBufferGpu;(!z||z.size<G.byteLength)&&(z?.destroy(),z=this.device.createBuffer({label:"LightsTextureMask index buffer",size:G.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),P=!0),this.device.queue.writeBuffer(z,0,G),this.obstacles={positionsBufferGpu:_,indexBufferGpu:z},this.setIndirectIndexCount(m.length),P&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(o){this.setIndirectInstanceCount(o)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(o){let v=new Uint32Array(this.indirectDrawing.bufferCpu);v[0]!==o&&(v[0]=o,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(o){let v=new Uint32Array(this.indirectDrawing.bufferCpu);v[1]!==o&&(v[1]=o,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let o=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(o.setPipeline(this.renderPipeline),o.setVertexBuffer(0,this.obstacles.positionsBufferGpu),o.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,Vt.structs.lightsBuffer.lights.offset),o.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),o.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),o.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var ge=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(o,v,m){this.lightsBuffer=v;let P=this.lightsBuffer.maxLightsCount/4,T={x:Math.ceil(Math.sqrt(P)),y:0};T.y=Math.ceil(P/T.x),this.gridSize=T;let _={width:T.x*m.resolutionPerLight,height:T.y*m.resolutionPerLight},G="rgba8unorm";this.texture=o.createTexture({label:"LightsTextureMask texture",size:[_.width,_.height],format:G,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),m.antialiased&&(this.textureMultisampled=o.createTexture({label:"LightsTextureMask texture multisampled",size:[_.width,_.height],format:G,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let U={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};m.antialiased&&(U.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[U]};let B={gridSize:T,format:G,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new he(o,v,B,m.maxLightSize),this.textureMask=new we(o,v,B,m.maxLightSize)}update(o){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let v=o.beginRenderPass(this.textureRenderpassDescriptor),[m,P]=[this.texture.width,this.texture.height];v.setViewport(0,0,m,P,0,1),v.setScissorRect(0,0,m,P),v.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),v.end()}setObstacles(o){this.textureMask.setObstacles(o)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var xe=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(o){this.device=o.device,this.targetTexture=o.targetTexture,this.lightsBuffer=o.lightsBuffer,this.lightsTexture=new ge(o.device,o.lightsBuffer,o.lightsTextureProperties),this.uniformsBufferGpu=o.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let v=o.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${Vt.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/o.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${o.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=o.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:v,entryPoint:"main_vertex"},fragment:{module:v,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let m=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=o.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:m,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:o.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:o.lightsTextureProperties.filtering,minFilter:o.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(o.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(o){this.lightsTexture.update(o)}render(o,v){let m=new ArrayBuffer(80);new Float32Array(m,0,16).set(v),new Float32Array(m,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,m),o.executeBundles([this.renderBundle])}setAlbedo(o){this.bindgroup1=this.buildBindgroup1(o),this.renderBundle=this.buildRenderBundle()}setAmbientLight(o){this.ambientLight=[...o]}setObstacles(o){this.lightsTexture.setObstacles(o)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(o){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:o.view},{binding:1,resource:o.sampler}]})}buildRenderBundle(){let o=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return o.setPipeline(this.renderPipeline),o.setBindGroup(0,this.bindgroup0),o.setBindGroup(1,this.bindgroup1),o.draw(4),o.finish({label:"LightsRenderer renderbundle"})}};var xn={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(r,o={}){return Qo(r,o)},onRun:function(r,o,v){ko(r,o,v)},onDestroy:function(r,o){Ko(o)},onResize:function(r,o){Jo(r,o)},onViewportPosition:function(r,o){o.data.viewport.setTopLeft(...r.viewport.position)},customFunctions:{..._e}};async function Qo(r,o){let{device:v}=r,m=256,P=256,T=new Vt(v,m),_=new pe({viewportSize:{width:r.viewport.width,height:r.viewport.height},center:r.viewport.position,zoom:r.viewport.zoom}),G=new xe({device:v,albedo:{view:o.refs.in.data.view,sampler:o.refs.in.data.sampler},targetTexture:o.refs.out.data.texture,lightsBuffer:T,lightsTextureProperties:{resolutionPerLight:P,maxLightSize:P,antialiased:!1,filtering:"nearest"}});return{lightsBuffer:T,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:G,viewport:_,lights:[]}}function ko(r,o,v){o.data.lightsBufferNeedsUpdate&&(o.data.lightsBuffer.setLights(o.data.lights),o.data.lightsBufferNeedsUpdate=!1,o.data.lightsTextureNeedsUpdate=!0);let m=o.data.lightsRenderer;o.data.lightsTextureNeedsUpdate&&(m.computeLightsTexture(v),o.data.lightsTextureNeedsUpdate=!1);let P=v.beginRenderPass({colorAttachments:[{view:o.refs.out.data.view,clearValue:r.clearValue,loadOp:"load",storeOp:"store"}]});o.data.viewport.setZoom(r.viewport.zoom);let T=o.data.viewport.invertViewProjectionMatrix;m.render(P,T),P.end()}function Ko(r){r.data.lightsBuffer.destroy(),r.data.lightsRenderer.destroy()}function Jo(r,o){o.data.lightsRenderer.setAlbedo({view:o.refs.in.data.view,sampler:o.refs.in.data.sampler}),o.data.viewport.setViewportSize(r.viewport.width,r.viewport.height)}var ze="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var kt=new Float32Array(8),mn={type:"cobalt:tileAtlas",refs:[],onInit:async function(r,o={}){return ts(r,o)},onRun:function(r,o,v){},onDestroy:function(r,o){es(data)},onResize:function(r,o){vn(r,o)},onViewportPosition:function(r,o){vn(r,o)}};async function ts(r,o){let{device:v}=r,m=await Yt(r,"tile atlas",o.options.textureUrl),P=v.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),T=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),_=v.createBindGroup({layout:T,entries:[{binding:0,resource:{buffer:P}},{binding:1,resource:m.view},{binding:2,resource:m.sampler}]}),G=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),z=v.createPipelineLayout({bindGroupLayouts:[G,T]});return{pipeline:v.createRenderPipeline({label:"tile",vertex:{module:v.createShaderModule({code:ze}),entryPoint:"vs_main",buffers:[]},fragment:{module:v.createShaderModule({code:ze}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:z}),uniformBuffer:P,atlasBindGroup:_,atlasMaterial:m,tileBindGroupLayout:G,tileSize:o.options.tileSize,tileScale:o.options.tileScale}}function es(r){r.atlasMaterial.texture.destroy(),r.atlasMaterial.texture=void 0}function vn(r,o){kt[0]=r.viewport.position[0],kt[1]=r.viewport.position[1];let v=o.data,{tileScale:m,tileSize:P}=v,T=r.viewport.width/r.viewport.zoom,_=r.viewport.height/r.viewport.zoom;kt[2]=T/m,kt[3]=_/m,kt[4]=1/v.atlasMaterial.texture.width,kt[5]=1/v.atlasMaterial.texture.height,kt[6]=P,kt[7]=1/P,r.device.queue.writeBuffer(v.uniformBuffer,0,kt,0,8)}function ve(r){let v=Object.keys(r.frames).length,m=new Float32Array(v*30),P=[],T={},_=0;for(let G in r.frames){let z=r.frames[G];P.push(G),T[G]=z.sourceSize;let U=-.5+z.spriteSourceSize.x/z.sourceSize.w,B=-.5+z.spriteSourceSize.y/z.sourceSize.h,R=-.5+(z.spriteSourceSize.x+z.spriteSourceSize.w)/z.sourceSize.w,X=-.5+(z.spriteSourceSize.y+z.spriteSourceSize.h)/z.sourceSize.h,Y=[U,B,0],H=[U,X,0],F=[R,X,0],et=[R,B,0],W=0+z.frame.x/r.meta.size.w,C=0+z.frame.y/r.meta.size.h,tt=0+(z.frame.x+z.frame.w)/r.meta.size.w,Mt=0+(z.frame.y+z.frame.h)/r.meta.size.h,ft=[W,C],xt=[W,Mt],Dt=[tt,Mt],vt=[tt,C];m.set(Y,_),m.set(ft,_+3),m.set(H,_+5),m.set(xt,_+8),m.set(F,_+10),m.set(Dt,_+13),m.set(Y,_+15),m.set(ft,_+18),m.set(F,_+20),m.set(Dt,_+23),m.set(et,_+25),m.set(vt,_+28),_+=30}return{spriteMeta:T,locations:P,vertices:m}}var Ge="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var yn=Ot.create(0,0,0),Dn={type:"cobalt:spritesheet",refs:[],onInit:async function(r,o={}){return os(r,o)},onRun:function(r,o,v){},onDestroy:function(r,o){ss(o)},onResize:function(r,o){Mn(r,o)},onViewportPosition:function(r,o){Mn(r,o)}};async function os(r,o){let{canvas:v,device:m}=r,P,T,_;v?(P=await rs(o.options.spriteSheetJsonUrl),P=ve(P),T=await Yt(r,"sprite",o.options.colorTextureUrl,"rgba8unorm"),_=await Yt(r,"emissive sprite",o.options.emissiveTextureUrl,"rgba8unorm"),v.style.imageRendering="pixelated"):(P=ve(o.options.spriteSheetJson),T=await oe(r,"sprite",o.options.colorTexture,"rgba8unorm"),_=await oe(r,"emissive sprite",o.options.emissiveTexture,"rgba8unorm"));let G=Se(m,P),z=m.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),U=m.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),B=m.createPipelineLayout({bindGroupLayouts:[U]});return{pipeline:m.createRenderPipeline({label:"sprite",vertex:{module:m.createShaderModule({code:Ge}),entryPoint:"vs_main",buffers:[G.bufferLayout]},fragment:{module:m.createShaderModule({code:Ge}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:B}),uniformBuffer:z,quads:G,colorTexture:T,emissiveTexture:_,bindGroupLayout:U,spritesheet:P}}function ss(r){r.data.quads.buffer.destroy(),r.data.colorTexture.buffer.destroy(),r.data.uniformBuffer.destroy(),r.data.emissiveTexture.texture.destroy()}async function rs(r){return(await fetch(r)).json()}function Mn(r,o){let{device:v,viewport:m}=r,P=m.width/m.zoom,T=m.height/m.zoom,_=At.ortho(0,P,T,0,-10,10);Ot.set(-m.position[0],-m.position[1],0,yn);let G=At.translation(yn);v.queue.writeBuffer(o.data.uniformBuffer,0,G.buffer),v.queue.writeBuffer(o.data.uniformBuffer,64,_.buffer)}var bn={type:"fbTexture",refs:[],onInit:async function(r,o={}){return is(r,o)},onRun:function(r,o,v){},onDestroy:function(r,o){Sn(data)},onResize:function(r,o){cs(r,o)},onViewportPosition:function(r,o){}};async function is(r,o){let{device:v}=r,{label:m,mip_count:P,format:T,usage:_,viewportScale:G}=o.options;return Rt(v,m,r.viewport.width*G,r.viewport.height*G,P,T,_)}function Sn(r){r.data.texture.destroy()}function cs(r,o){let{device:v}=r;Sn(o);let{width:m,height:P}=r.viewport,{options:T}=o,_=o.options.viewportScale;o.data=Rt(v,T.label,m*_,P*_,T.mip_count,T.format,T.usage)}async function tc(r,o,v){let m,P,T,_;return r.sdlWindow&&r.gpu?(P=r.gpu,m=await(await P.create(["verbose=1"]).requestAdapter()).requestDevice(),T=P.renderGPUDeviceToWindow({device:m,window:r.sdlWindow}),global.GPUBufferUsage=P.GPUBufferUsage,global.GPUShaderStage=P.GPUShaderStage,global.GPUTextureUsage=P.GPUTextureUsage):(_=r,m=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),P=navigator.gpu,T=_.getContext("webgpu"),T.configure({device:m,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":mn,"cobalt:spritesheet":Dn,"cobalt:fbTexture":bn,"cobalt:bloom":Ae,"cobalt:composite":Oe,"cobalt:sprite":Ne,"cobalt:tile":$e,"cobalt:displacement":Je,"cobalt:overlay":nn,"cobalt:fbBlit":on,"cobalt:primitives":un,"cobalt:light":xn},nodes:[],defaultTextureViewRefs:[],canvas:_,device:m,context:T,gpu:P,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:o,height:v,zoom:1,position:[0,0]}}}function ec(r,o){if(!o?.type)throw new Error("Can't define a new node missing a type.");r.nodeDefs[o.type]=o}async function nc(r,o){let v=r.nodeDefs[o?.type];if(!v)throw new Error("Can't initialize a new node missing a type.");let m={type:o.type,refs:o.refs||{},options:o.options||{},data:{},enabled:!0};for(let T in m.refs)m.refs[T]==="FRAME_TEXTURE_VIEW"&&(r.defaultTextureViewRefs.push({node:m,refName:T}),m.refs[T]=Tn(r));m.data=await v.onInit(r,m);let P=v.customFunctions||{};for(let T in P)m[T]=function(..._){return P[T](r,m,..._)};return r.nodes.push(m),m}function oc(r){let{device:o,context:v}=r,m=o.createCommandEncoder(),P=Tn(r);for(let T of r.defaultTextureViewRefs)T.node.refs[T.refName]=P;for(let T of r.nodes){if(!T.enabled)continue;r.nodeDefs[T.type].onRun(r,T,m)}o.queue.submit([m.finish()]),r.canvas||r.context.swap()}function sc(r){for(let o of r.nodes)r.nodeDefs[o.type].onDestroy(r,o);r.nodes.length=0,r.defaultTextureViewRefs.length=0}function rc(r,o,v){r.viewport.width=o,r.viewport.height=v;for(let m of r.nodes)r.nodeDefs[m.type].onResize(r,m)}function ic(r,o){r.viewport.position[0]=o[0]-r.viewport.width/2/r.viewport.zoom,r.viewport.position[1]=o[1]-r.viewport.height/2/r.viewport.zoom;for(let v of r.nodes)r.nodeDefs[v.type].onViewportPosition(r,v)}function Ve(r){return r.canvas?navigator.gpu.getPreferredCanvasFormat():r.context.getPreferredFormat()}function Tn(r){return r.canvas?r.context.getCurrentTexture().createView():r.context.getCurrentTextureView()}export{Rt as createTexture,oe as createTextureFromBuffer,Yt as createTextureFromUrl,ec as defineNode,oc as draw,Tn as getCurrentTextureView,Ve as getPreferredFormat,tc as init,nc as initNode,sc as reset,rc as setViewportDimensions,ic as setViewportPosition};

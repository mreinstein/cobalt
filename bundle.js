var vn=Object.defineProperty;var _t=(t,e)=>{for(var l in e)vn(t,l,{get:e[l],enumerable:!0})};function Se(t,e,l,f,v,g,T){let U=t.createTexture({label:e,size:{width:l,height:f},format:g,usage:T,mipLevelCount:v,sampleCount:1,dimension:"2d"}),S=U.createView(),z=[];for(let L=0;L<v;L++)z.push(U.createView({label:e,format:g,dimension:"2d",aspect:"all",baseMipLevel:L,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let B=t.createSampler({label:`${e} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:l,height:f},texture:U,view:S,mip_view:z,sampler:B}}async function Oe(t,e,l,f="rgba8unorm"){let g=await(await fetch(l)).blob(),T=await createImageBitmap(g),U=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,z=Se(t.device,e,T.width,T.height,1,f,U);t.device.queue.copyExternalImageToTexture({source:T},{texture:z.texture},{width:T.width,height:T.height});let B={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return z.sampler=t.device.createSampler(B),z}function $e(t,e,l,f="rgba8unorm"){let v=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,T=Se(t.device,e,l.width,l.height,1,f,v);t.device.queue.writeTexture({texture:T.texture},l.data,{bytesPerRow:4*l.width},{width:l.width,height:l.height});let U={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return T.sampler=t.device.createSampler(U),T}var Gt="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<u32(imgSize.x)&&global_invocation_id.y<u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var Ve=7,yn=0,Ut=1,bn=2,zt=3,Et={type:"cobalt:bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(t,e={}){return Tn(t,e)},onRun:function(t,e,l){Mn(t,e.data,l)},onDestroy:function(t,e){It(e)},onResize:function(t,e){Sn(t,e)},onViewportPosition:function(t,e){}};function Tn(t,e){let{device:l}=t,f=t.viewport.width,v=t.viewport.height,g={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},T=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});g.bind_group_layout.push(T),g.bind_groups_textures.push(Se(l,"bloom downsampler image 0",f/2,v/2,Ve,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),g.bind_groups_textures.push(Se(l,"bloom downsampler image 1",f/2,v/2,Ve,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),g.bind_groups_textures.push(e.refs.bloom.data);let U=l.createPipelineLayout({bindGroupLayouts:g.bind_group_layout}),S=l.createComputePipeline({layout:U,compute:{module:l.createShaderModule({code:Gt}),entryPoint:"cs_main"}});return Lt(t,g,e),g.compute_pipeline=S,g}function Lt(t,e,l){let{refs:f}=l,{device:v}=t,g=l.options.bloom_threshold??.1,T=l.options.bloom_knee??.2,U=l.options.bloom_combine_constant??.68,S=new Float32Array([g,g-T,T*2,.25/T,U,0,0,0]),z=v.createBuffer({label:"bloom static parameters buffer",size:S.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(z.getMappedRange()).set(S),z.unmap(),e.bind_group.length=0,e.params_buf=z,e.bind_group.push(Ye(v,e,e.bind_groups_textures[0].mip_view[0],f.emissive.data.view,f.hdr.data.view,f.hdr.data.sampler,z,yn<<16|0));for(let L=1;L<Ve;L++)e.bind_group.push(Ye(v,e,e.bind_groups_textures[1].mip_view[L],e.bind_groups_textures[0].view,f.hdr.data.view,f.hdr.data.sampler,z,Ut<<16|L-1)),e.bind_group.push(Ye(v,e,e.bind_groups_textures[0].mip_view[L],e.bind_groups_textures[1].view,f.hdr.data.view,f.hdr.data.sampler,z,Ut<<16|L));e.bind_group.push(Ye(v,e,e.bind_groups_textures[2].mip_view[Ve-1],e.bind_groups_textures[0].view,f.hdr.data.view,f.hdr.data.sampler,z,bn<<16|Ve-2));let B=!0;for(let L=Ve-2;L>=0;L--)B?(e.bind_group.push(Ye(v,e,e.bind_groups_textures[1].mip_view[L],e.bind_groups_textures[0].view,e.bind_groups_textures[2].view,f.hdr.data.sampler,z,zt<<16|L)),B=!1):(e.bind_group.push(Ye(v,e,e.bind_groups_textures[2].mip_view[L],e.bind_groups_textures[0].view,e.bind_groups_textures[1].view,f.hdr.data.sampler,z,zt<<16|L)),B=!0)}function Ye(t,e,l,f,v,g,T,U){let S=new Uint32Array([U]),z=t.createBuffer({label:"bloom static mode_lod buffer",size:S.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(z.getMappedRange()).set(S),z.unmap(),t.createBindGroup({label:"bloom bind group layout",layout:e.bind_group_layout[0],entries:[{binding:0,resource:l},{binding:1,resource:f},{binding:2,resource:v},{binding:3,resource:g},{binding:4,resource:{buffer:T}},{binding:5,resource:{buffer:z}}]})}function Mn(t,e,l){let U=0,S=l.beginComputePass({label:"bloom Compute Pass"});S.setPipeline(e.compute_pipeline),S.setBindGroup(0,e.bind_group[U]),U+=1;let z=tt(0,e.bind_groups_textures[0]);S.dispatchWorkgroups(z.width/8+1,z.height/4+1,1);for(let B=1;B<Ve;B++)z=tt(B,e.bind_groups_textures[0]),S.setBindGroup(0,e.bind_group[U]),U+=1,S.dispatchWorkgroups(z.width/8+1,z.height/4+1,1),S.setBindGroup(0,e.bind_group[U]),U+=1,S.dispatchWorkgroups(z.width/8+1,z.height/4+1,1);S.setBindGroup(0,e.bind_group[U]),U+=1,z=tt(Ve-1,e.bind_groups_textures[2]),S.dispatchWorkgroups(z.width/8+1,z.height/4+1,1);for(let B=Ve-2;B>=0;B--)z=tt(B,e.bind_groups_textures[2]),S.setBindGroup(0,e.bind_group[U]),U+=1,S.dispatchWorkgroups(z.width/8+1,z.height/4+1,1);S.end()}function tt(t,e){let l=e.size.width,f=e.size.height;for(let v=0;v<t;v++)l/=2,f/=2;return{width:l,height:f,depthOrArrayLayers:1}}function Sn(t,e){let{device:l}=t,f=e.data;It(f),f.bind_groups_textures.push(Se(l,"bloom downsampler image 0",t.viewport.width/2,t.viewport.height/2,Ve,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),f.bind_groups_textures.push(Se(l,"bloom downsampler image 1",t.viewport.width/2,t.viewport.height/2,Ve,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),f.bind_groups_textures.push(e.refs.bloom.data),Lt(t,f,e)}function It(t){for(let e of t.bind_groups_textures)e.texture.destroy();t.bind_groups_textures.length=0}var dt="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{var output:VertexOutput;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.fragUV=vec2<f32>(uvs[VertexIndex]);return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Ft={type:"cobalt:bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Bn(t,e)},onRun:function(t,e,l){Dn(t,e,l)},onDestroy:function(t,e){},onResize:function(t,e){_n(t,e)},onViewportPosition:function(t,e){}};function Bn(t,e){let{options:l,refs:f}=e,{device:v}=t,g=Rt(t),T=l.bloom_intensity??40,U=l.bloom_combine_constant??.68,S=new Float32Array([T,U]),z=v.createBuffer({label:"scene composite params buffer",size:S.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(z.getMappedRange()).set(S),z.unmap();let B=v.createRenderPipeline({layout:"auto",vertex:{module:v.createShaderModule({code:dt}),entryPoint:"vert_main"},fragment:{module:v.createShaderModule({code:dt}),entryPoint:"frag_main",targets:[{format:g}]},primitive:{topology:"triangle-list"}});return{bindGroup:v.createBindGroup({layout:B.getBindGroupLayout(0),entries:[{binding:0,resource:f.hdr.data.sampler},{binding:1,resource:f.hdr.data.view},{binding:2,resource:f.bloom.data.mip_view[0]},{binding:3,resource:{buffer:z}}]}),pipeline:B,params_buf:z}}function Dn(t,e,l){let f=l.beginRenderPass({colorAttachments:[{view:e.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:v,bindGroup:g}=e.data;f.setPipeline(v),f.setBindGroup(0,g),f.draw(3),f.end()}function _n(t,e){let{pipeline:l,params_buf:f}=e.data,{device:v}=t;e.data.bindGroup=v.createBindGroup({layout:l.getBindGroupLayout(0),entries:[{binding:0,resource:e.refs.hdr.data.sampler},{binding:1,resource:e.refs.hdr.data.view},{binding:2,resource:e.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:f}}]})}var He={};_t(He,{addSprite:()=>Un,clear:()=>En,removeSprite:()=>zn,setSprite:()=>On,setSpriteName:()=>Ln,setSpriteOpacity:()=>Rn,setSpritePosition:()=>In,setSpriteRotation:()=>An,setSpriteScale:()=>Vn,setSpriteTint:()=>Fn});function mt(t,e,l){if(l.spriteCount===0)return 0;let f=0,v=l.spriteCount-1,g=t<<16&16711680|e&65535;for(;f<=v;){let T=l.spriteData[f*12+11];if(g<=T)return f;let U=l.spriteData[v*12+11];if(g>=U)return v+1;let S=Math.floor((f+v)/2),z=l.spriteData[S*12+11];if(g===z)return S+1;g>z?f=S+1:v=S-1}return f}function We(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function Un(t,e,l,f,v,g,T,U,S){let z=e.refs.spritesheet.data.spritesheet;e=e.data;let B=z.locations.indexOf(l),L=mt(S,B,e),O=(L+1)*12;e.spriteData.set(e.spriteData.subarray(L*12,e.spriteCount*12),O),At(e,z,L,l,f,v,g,T,U,S);for(let[C,E]of e.spriteIndices)E>=L&&e.spriteIndices.set(C,E+1);let A=We();return e.spriteIndices.set(A,L),e.spriteCount++,e.dirty=!0,A}function zn(t,e,l){e=e.data;let f=e.spriteIndices.get(l);for(let[g,T]of e.spriteIndices)T>f&&e.spriteIndices.set(g,T-1);let v=f*12;e.spriteData.set(e.spriteData.subarray((f+1)*12,e.spriteCount*12),v),e.spriteIndices.delete(l),e.spriteCount--,e.dirty=!0}function En(t,e){e=e.data,e.spriteIndices.clear(),e.spriteCount=0,e.instancedDrawCallCount=0,e.dirty=!0}function Ln(t,e,l,f,v){let g=e.refs.spritesheet.data.spritesheet;e=e.data;let T=g.locations.indexOf(f),U=g.spriteMeta[f].w,S=g.spriteMeta[f].h,B=e.spriteIndices.get(l)*12;e.spriteData[B+2]=U*v[0],e.spriteData[B+3]=S*v[1];let O=(e.spriteData[B+11]>>16&255)<<16&16711680|T&65535;e.spriteData[B+11]=O,e.dirty=!0}function In(t,e,l,f){e=e.data;let g=e.spriteIndices.get(l)*12;e.spriteData[g]=f[0],e.spriteData[g+1]=f[1],e.dirty=!0}function Fn(t,e,l,f){e=e.data;let g=e.spriteIndices.get(l)*12;e.spriteData[g+4]=f[0],e.spriteData[g+5]=f[1],e.spriteData[g+6]=f[2],e.spriteData[g+7]=f[3],e.dirty=!0}function Rn(t,e,l,f){e=e.data;let g=e.spriteIndices.get(l)*12;e.spriteData[g+8]=f,e.dirty=!0}function An(t,e,l,f){e=e.data;let g=e.spriteIndices.get(l)*12;e.spriteData[g+9]=f,e.dirty=!0}function Vn(t,e,l,f,v){let g=e.refs.spritesheet.data.spritesheet;e=e.data;let U=e.spriteIndices.get(l)*12,S=g.spriteMeta[f].w,z=g.spriteMeta[f].h;e.spriteData[U+2]=S*v[0],e.spriteData[U+3]=z*v[1],e.dirty=!0}function On(t,e,l,f,v,g,T,U,S,z){let B=e.refs.spritesheet.data.spritesheet;e=e.data;let L=e.spriteIndices.get(l);At(e,B,L,f,v,g,T,U,S,z),e.dirty=!0}function At(t,e,l,f,v,g,T,U,S,z){if(!e.spriteMeta[f])throw new Error(`Sprite name ${f} could not be found in the spritesheet metaData`);let B=l*12,L=e.spriteMeta[f].w,O=e.spriteMeta[f].h,A=e.locations.indexOf(f),C=z<<16&16711680|A&65535;t.spriteData[B]=v[0],t.spriteData[B+1]=v[1],t.spriteData[B+2]=L*g[0],t.spriteData[B+3]=O*g[1],t.spriteData[B+4]=T[0],t.spriteData[B+5]=T[1],t.spriteData[B+6]=T[2],t.spriteData[B+7]=T[3],t.spriteData[B+8]=U,t.spriteData[B+9]=S,t.spriteData[B+11]=C}var Vt={type:"cobalt:sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return Cn(t,e)},onRun:function(t,e,l){Nn(t,e,l)},onDestroy:function(t,e){Yn(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{...He}};async function Cn(t,e){let{device:l}=t,f=16192,v=f,T=Float32Array.BYTES_PER_ELEMENT*2,S=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*4,O=Float32Array.BYTES_PER_ELEMENT*4,A=l.createBuffer({size:(T+S+B+O)*v,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),C=e.refs.spritesheet.data,E=l.createBindGroup({layout:e.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:C.uniformBuffer}},{binding:1,resource:C.colorTexture.view},{binding:2,resource:C.colorTexture.sampler},{binding:3,resource:{buffer:A}},{binding:4,resource:C.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(f*2),instancedDrawCallCount:0,bindGroup:E,spriteBuffer:A,spriteData:new Float32Array(f*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function Nn(t,e,l){let{device:f}=t,v=e.options.loadOp||"load";if(e.data.dirty&&(qn(e.data),e.data.dirty=!1),e.data.spriteCount>0){let S=e.data.spriteCount*12*Float32Array.BYTES_PER_ELEMENT;f.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer,0,S)}let g=l.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:v,storeOp:"store"},{view:e.refs.emissive.data.view,clearValue:t.clearValue,loadOp:"clear",storeOp:"store"}]});g.setPipeline(e.refs.spritesheet.data.pipeline),g.setBindGroup(0,e.data.bindGroup),g.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let T=6,U=0;for(let S=0;S<e.data.instancedDrawCallCount;S++){let z=e.data.instancedDrawCalls[S*2]*T,B=e.data.instancedDrawCalls[S*2+1];g.draw(T,B,z,U),U+=B}g.end()}function qn(t){let e=-1,l=0;t.instancedDrawCallCount=0;for(let f=0;f<t.spriteCount;f++){let v=t.spriteData[f*12+11]&65535;v!==e&&(l>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=l,t.instancedDrawCallCount++),e=v,l=0),l++}l>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=l,t.instancedDrawCallCount++)}function Yn(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var Ct={type:"cobalt:tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return Xn(t,e)},onRun:function(t,e,l){$n(t,e,l)},onDestroy:function(t,e){Ot(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{setTexture:async function(t,e,l){let{device:f}=t;Ot(e),e.options.textureUrl=l;let v=await Oe(t,"tile map",e.options.textureUrl),g=f.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:v.view},{binding:2,resource:v.sampler}]});e.data.bindGroup=g,e.data.material=v}}};async function Xn(t,e){let{device:l}=t,f=await Oe(t,"tile map",e.options.textureUrl),v=new Float32Array([e.options.scrollScale,e.options.scrollScale]),g=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,T={size:v.byteLength,usage:g,mappedAtCreation:!0},U=l.createBuffer(T);return new Float32Array(U.getMappedRange()).set(v),U.unmap(),{bindGroup:l.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:U}},{binding:1,resource:f.view},{binding:2,resource:f.sampler}]}),material:f,uniformBuffer:U,scrollScale:e.options.scrollScale}}function $n(t,e,l){let{device:f}=t,v=e.options.loadOp||"load",g=l.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:v,storeOp:"store"}]}),T=e.refs.tileAtlas.data;g.setPipeline(T.pipeline),g.setBindGroup(0,e.data.bindGroup),g.setBindGroup(1,T.atlasBindGroup),g.draw(3),g.end()}function Ot(t){t.data.material.texture.destroy(),t.data.material.texture=void 0}var nt=class{device;floatsPerSprite=6;bufferGpu;bufferNeedsUpdate=!1;sprites=new Map;get spriteCount(){return this.sprites.size}constructor(e){this.device=e.device,this.bufferGpu=this.device.createBuffer({size:e.maxSpriteCount*this.floatsPerSprite*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})}destroy(){this.bufferGpu.destroy}update(){if(this.bufferNeedsUpdate){let e=[];for(let f of this.sprites.values())e.push(...f);let l=new Float32Array(e);this.device.queue.writeBuffer(this.bufferGpu,0,l)}}addTriangle(e){let l=We();if(this.sprites.has(l))throw new Error(`Duplicate triangle "${l}".`);let f=this.buildTriangleData(e);return this.sprites.set(l,f),this.bufferNeedsUpdate=!0,l}removeTriangle(e){if(!this.sprites.has(e))throw new Error(`Unknown triangle "${e}".`);this.sprites.delete(e),this.bufferNeedsUpdate=!0}setTriangle(e,l){if(!this.sprites.has(e))throw new Error(`Unknown triangle "${e}".`);let f=this.buildTriangleData(l);this.sprites.set(e,f),this.bufferNeedsUpdate=!0}buildTriangleData(e){return[e[0][0],e[0][1],e[1][0],e[1][1],e[2][0],e[2][1]]}};var rt=class{device;bufferGpu;needsUpdate=!0;constructor(e){this.device=e.device,this.bufferGpu=this.device.createBuffer({label:"DisplacementParametersBuffer buffer",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.setParameters(e.initialParameters)}setParameters(e){this.device.queue.writeBuffer(this.bufferGpu,0,new Float32Array([e.offsetX,e.offsetY,e.scale]))}destroy(){this.bufferGpu.destroy()}};var Nt="struct DisplacementParameters{offset:vec2<f32>,scale:f32,};@group(0)@binding(0)var<uniform> uniforms:DisplacementParameters;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var colorSampler:sampler;@group(0)@binding(3)var noiseTexture:texture_2d<f32>;@group(0)@binding(4)var noiseSampler:sampler;@group(0)@binding(5)var displacementTexture:texture_2d<f32>;struct VertexIn{@builtin(vertex_index)vertexIndex:u32,};struct VertexOut{@builtin(position)position:vec4<f32>,@location(0)uv:vec2<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{const corners=array<vec2<f32>,4>(vec2<f32>(-1,-1),vec2<f32>(1,-1),vec2<f32>(-1,1),vec2<f32>(1,1),);let screenPosition=corners[in.vertexIndex];var out:VertexOut;out.position=vec4<f32>(screenPosition,0,1);out.uv=(0.5+0.5*screenPosition*vec2<f32>(1,-1));return out;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment(in:VertexOut)->FragmentOut{let noiseTextureDimensions=vec2<f32>(textureDimensions(noiseTexture,0));let noiseUv=in.uv+uniforms.offset/noiseTextureDimensions;var noise=textureSample(noiseTexture,noiseSampler,noiseUv).rg;noise-=0.5;noise*=uniforms.scale/noiseTextureDimensions;let displacement=textureSample(displacementTexture,colorSampler,in.uv).r;noise*=displacement;let colorUv=in.uv+noise;var out:FragmentOut;out.color=textureSample(colorTexture,colorSampler,colorUv);return out;}";var it=class{device;targetFormat;renderPipeline;colorSampler;noiseSampler;displacementParametersBuffer;renderBundle=null;colorTextureView;noiseMapTextureView;displacementTextureView;constructor(e){this.device=e.device,this.targetFormat=e.targetFormat,this.colorTextureView=e.colorTextureView,this.noiseMapTextureView=e.noiseMapTextureView,this.displacementTextureView=e.displacementTextureView,this.displacementParametersBuffer=e.displacementParametersBuffer;let l=this.device.createShaderModule({label:"DisplacementComposition shader module",code:Nt});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementComposition renderpipeline",layout:"auto",vertex:{module:l,entryPoint:"main_vertex"},fragment:{module:l,entryPoint:"main_fragment",targets:[{format:e.targetFormat}]},primitive:{cullMode:"none",topology:"triangle-strip"}}),this.noiseSampler=this.device.createSampler({label:"DisplacementComposition noisesampler",addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),this.colorSampler=this.device.createSampler({label:"DisplacementComposition colorSampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"})}getRenderBundle(){return this.renderBundle||(this.renderBundle=this.buildRenderBundle()),this.renderBundle}destroy(){}setColorTextureView(e){this.colorTextureView=e,this.renderBundle=null}setNoiseMapTextureView(e){this.noiseMapTextureView=e,this.renderBundle=null}setDisplacementTextureView(e){this.displacementTextureView=e,this.renderBundle=null}buildRenderBundle(){let e=this.device.createBindGroup({label:"DisplacementComposition bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.displacementParametersBuffer.bufferGpu}},{binding:1,resource:this.colorTextureView},{binding:2,resource:this.colorSampler},{binding:3,resource:this.noiseMapTextureView},{binding:4,resource:this.noiseSampler},{binding:5,resource:this.displacementTextureView}]}),l=this.device.createRenderBundleEncoder({label:"DisplacementComposition renderbundle encoder",colorFormats:[this.targetFormat]});return l.setPipeline(this.renderPipeline),l.setBindGroup(0,e),l.draw(4),l.finish({label:"DisplacementComposition renderbundle"})}};var qt="struct TransformData{mvpMatrix:mat4x4<f32>,};@group(0)@binding(0)var<uniform> transformUBO:TransformData;struct VertexIn{@location(0)position:vec2<f32>,};struct VertexOut{@builtin(position)position:vec4<f32>,};@vertex fn main_vertex(in:VertexIn)->VertexOut{var output:VertexOut;output.position=transformUBO.mvpMatrix*vec4<f32>(in.position,0.0,1.0);return output;}struct FragmentOut{@location(0)color:vec4<f32>,};@fragment fn main_fragment()->FragmentOut{var out:FragmentOut;out.color=vec4<f32>(1.0,1.0,1.0,1.0);return out;}";function jn(t,e){return class extends t{constructor(...l){super(...l),e(this)}}}var kn=jn(Array,t=>t.fill(0)),N=1e-6;function Zn(t){function e(n=0,c=0){let r=new t(2);return n!==void 0&&(r[0]=n,c!==void 0&&(r[1]=c)),r}let l=e;function f(n,c,r){let o=r??new t(2);return o[0]=n,o[1]=c,o}function v(n,c){let r=c??new t(2);return r[0]=Math.ceil(n[0]),r[1]=Math.ceil(n[1]),r}function g(n,c){let r=c??new t(2);return r[0]=Math.floor(n[0]),r[1]=Math.floor(n[1]),r}function T(n,c){let r=c??new t(2);return r[0]=Math.round(n[0]),r[1]=Math.round(n[1]),r}function U(n,c=0,r=1,o){let p=o??new t(2);return p[0]=Math.min(r,Math.max(c,n[0])),p[1]=Math.min(r,Math.max(c,n[1])),p}function S(n,c,r){let o=r??new t(2);return o[0]=n[0]+c[0],o[1]=n[1]+c[1],o}function z(n,c,r,o){let p=o??new t(2);return p[0]=n[0]+c[0]*r,p[1]=n[1]+c[1]*r,p}function B(n,c){let r=n[0],o=n[1],p=c[0],y=c[1],D=Math.sqrt(r*r+o*o),u=Math.sqrt(p*p+y*y),d=D*u,w=d&&Pe(n,c)/d;return Math.acos(w)}function L(n,c,r){let o=r??new t(2);return o[0]=n[0]-c[0],o[1]=n[1]-c[1],o}let O=L;function A(n,c){return Math.abs(n[0]-c[0])<N&&Math.abs(n[1]-c[1])<N}function C(n,c){return n[0]===c[0]&&n[1]===c[1]}function E(n,c,r,o){let p=o??new t(2);return p[0]=n[0]+r*(c[0]-n[0]),p[1]=n[1]+r*(c[1]-n[1]),p}function K(n,c,r,o){let p=o??new t(2);return p[0]=n[0]+r[0]*(c[0]-n[0]),p[1]=n[1]+r[1]*(c[1]-n[1]),p}function J(n,c,r){let o=r??new t(2);return o[0]=Math.max(n[0],c[0]),o[1]=Math.max(n[1],c[1]),o}function Y(n,c,r){let o=r??new t(2);return o[0]=Math.min(n[0],c[0]),o[1]=Math.min(n[1],c[1]),o}function ne(n,c,r){let o=r??new t(2);return o[0]=n[0]*c,o[1]=n[1]*c,o}let be=ne;function oe(n,c,r){let o=r??new t(2);return o[0]=n[0]/c,o[1]=n[1]/c,o}function pe(n,c){let r=c??new t(2);return r[0]=1/n[0],r[1]=1/n[1],r}let de=pe;function me(n,c,r){let o=r??new t(3),p=n[0]*c[1]-n[1]*c[0];return o[0]=0,o[1]=0,o[2]=p,o}function Pe(n,c){return n[0]*c[0]+n[1]*c[1]}function re(n){let c=n[0],r=n[1];return Math.sqrt(c*c+r*r)}let ze=re;function $(n){let c=n[0],r=n[1];return c*c+r*r}let j=$;function X(n,c){let r=n[0]-c[0],o=n[1]-c[1];return Math.sqrt(r*r+o*o)}let Le=X;function ge(n,c){let r=n[0]-c[0],o=n[1]-c[1];return r*r+o*o}let Ie=ge;function he(n,c){let r=c??new t(2),o=n[0],p=n[1],y=Math.sqrt(o*o+p*p);return y>1e-5?(r[0]=o/y,r[1]=p/y):(r[0]=0,r[1]=0),r}function Fe(n,c){let r=c??new t(2);return r[0]=-n[0],r[1]=-n[1],r}function k(n,c){let r=c??new t(2);return r[0]=n[0],r[1]=n[1],r}let Re=k;function Te(n,c,r){let o=r??new t(2);return o[0]=n[0]*c[0],o[1]=n[1]*c[1],o}let Ae=Te;function Me(n,c,r){let o=r??new t(2);return o[0]=n[0]/c[0],o[1]=n[1]/c[1],o}let Ee=Me;function Be(n=1,c){let r=c??new t(2),o=Math.random()*2*Math.PI;return r[0]=Math.cos(o)*n,r[1]=Math.sin(o)*n,r}function s(n){let c=n??new t(2);return c[0]=0,c[1]=0,c}function h(n,c,r){let o=r??new t(2),p=n[0],y=n[1];return o[0]=p*c[0]+y*c[4]+c[12],o[1]=p*c[1]+y*c[5]+c[13],o}function i(n,c,r){let o=r??new t(2),p=n[0],y=n[1];return o[0]=c[0]*p+c[4]*y+c[8],o[1]=c[1]*p+c[5]*y+c[9],o}function a(n,c,r,o){let p=o??new t(2),y=n[0]-c[0],D=n[1]-c[1],u=Math.sin(r),d=Math.cos(r);return p[0]=y*d-D*u+c[0],p[1]=y*u+D*d+c[1],p}function m(n,c,r){let o=r??new t(2);return he(n,o),ne(o,c,o)}function x(n,c,r){let o=r??new t(2);return re(n)>c?m(n,c,o):k(n,o)}function P(n,c,r){let o=r??new t(2);return E(n,c,.5,o)}return{create:e,fromValues:l,set:f,ceil:v,floor:g,round:T,clamp:U,add:S,addScaled:z,angle:B,subtract:L,sub:O,equalsApproximately:A,equals:C,lerp:E,lerpV:K,max:J,min:Y,mulScalar:ne,scale:be,divScalar:oe,inverse:pe,invert:de,cross:me,dot:Pe,length:re,len:ze,lengthSq:$,lenSq:j,distance:X,dist:Le,distanceSq:ge,distSq:Ie,normalize:he,negate:Fe,copy:k,clone:Re,multiply:Te,mul:Ae,divide:Me,div:Ee,random:Be,zero:s,transformMat4:h,transformMat3:i,rotate:a,setLength:m,truncate:x,midpoint:P}}var Yt=new Map;function kt(t){let e=Yt.get(t);return e||(e=Zn(t),Yt.set(t,e)),e}function Qn(t){function e(u,d,w){let b=new t(3);return u!==void 0&&(b[0]=u,d!==void 0&&(b[1]=d,w!==void 0&&(b[2]=w))),b}let l=e;function f(u,d,w,b){let M=b??new t(3);return M[0]=u,M[1]=d,M[2]=w,M}function v(u,d){let w=d??new t(3);return w[0]=Math.ceil(u[0]),w[1]=Math.ceil(u[1]),w[2]=Math.ceil(u[2]),w}function g(u,d){let w=d??new t(3);return w[0]=Math.floor(u[0]),w[1]=Math.floor(u[1]),w[2]=Math.floor(u[2]),w}function T(u,d){let w=d??new t(3);return w[0]=Math.round(u[0]),w[1]=Math.round(u[1]),w[2]=Math.round(u[2]),w}function U(u,d=0,w=1,b){let M=b??new t(3);return M[0]=Math.min(w,Math.max(d,u[0])),M[1]=Math.min(w,Math.max(d,u[1])),M[2]=Math.min(w,Math.max(d,u[2])),M}function S(u,d,w){let b=w??new t(3);return b[0]=u[0]+d[0],b[1]=u[1]+d[1],b[2]=u[2]+d[2],b}function z(u,d,w,b){let M=b??new t(3);return M[0]=u[0]+d[0]*w,M[1]=u[1]+d[1]*w,M[2]=u[2]+d[2]*w,M}function B(u,d){let w=u[0],b=u[1],M=u[2],_=d[0],G=d[1],F=d[2],V=Math.sqrt(w*w+b*b+M*M),I=Math.sqrt(_*_+G*G+F*F),R=V*I,q=R&&Pe(u,d)/R;return Math.acos(q)}function L(u,d,w){let b=w??new t(3);return b[0]=u[0]-d[0],b[1]=u[1]-d[1],b[2]=u[2]-d[2],b}let O=L;function A(u,d){return Math.abs(u[0]-d[0])<N&&Math.abs(u[1]-d[1])<N&&Math.abs(u[2]-d[2])<N}function C(u,d){return u[0]===d[0]&&u[1]===d[1]&&u[2]===d[2]}function E(u,d,w,b){let M=b??new t(3);return M[0]=u[0]+w*(d[0]-u[0]),M[1]=u[1]+w*(d[1]-u[1]),M[2]=u[2]+w*(d[2]-u[2]),M}function K(u,d,w,b){let M=b??new t(3);return M[0]=u[0]+w[0]*(d[0]-u[0]),M[1]=u[1]+w[1]*(d[1]-u[1]),M[2]=u[2]+w[2]*(d[2]-u[2]),M}function J(u,d,w){let b=w??new t(3);return b[0]=Math.max(u[0],d[0]),b[1]=Math.max(u[1],d[1]),b[2]=Math.max(u[2],d[2]),b}function Y(u,d,w){let b=w??new t(3);return b[0]=Math.min(u[0],d[0]),b[1]=Math.min(u[1],d[1]),b[2]=Math.min(u[2],d[2]),b}function ne(u,d,w){let b=w??new t(3);return b[0]=u[0]*d,b[1]=u[1]*d,b[2]=u[2]*d,b}let be=ne;function oe(u,d,w){let b=w??new t(3);return b[0]=u[0]/d,b[1]=u[1]/d,b[2]=u[2]/d,b}function pe(u,d){let w=d??new t(3);return w[0]=1/u[0],w[1]=1/u[1],w[2]=1/u[2],w}let de=pe;function me(u,d,w){let b=w??new t(3),M=u[2]*d[0]-u[0]*d[2],_=u[0]*d[1]-u[1]*d[0];return b[0]=u[1]*d[2]-u[2]*d[1],b[1]=M,b[2]=_,b}function Pe(u,d){return u[0]*d[0]+u[1]*d[1]+u[2]*d[2]}function re(u){let d=u[0],w=u[1],b=u[2];return Math.sqrt(d*d+w*w+b*b)}let ze=re;function $(u){let d=u[0],w=u[1],b=u[2];return d*d+w*w+b*b}let j=$;function X(u,d){let w=u[0]-d[0],b=u[1]-d[1],M=u[2]-d[2];return Math.sqrt(w*w+b*b+M*M)}let Le=X;function ge(u,d){let w=u[0]-d[0],b=u[1]-d[1],M=u[2]-d[2];return w*w+b*b+M*M}let Ie=ge;function he(u,d){let w=d??new t(3),b=u[0],M=u[1],_=u[2],G=Math.sqrt(b*b+M*M+_*_);return G>1e-5?(w[0]=b/G,w[1]=M/G,w[2]=_/G):(w[0]=0,w[1]=0,w[2]=0),w}function Fe(u,d){let w=d??new t(3);return w[0]=-u[0],w[1]=-u[1],w[2]=-u[2],w}function k(u,d){let w=d??new t(3);return w[0]=u[0],w[1]=u[1],w[2]=u[2],w}let Re=k;function Te(u,d,w){let b=w??new t(3);return b[0]=u[0]*d[0],b[1]=u[1]*d[1],b[2]=u[2]*d[2],b}let Ae=Te;function Me(u,d,w){let b=w??new t(3);return b[0]=u[0]/d[0],b[1]=u[1]/d[1],b[2]=u[2]/d[2],b}let Ee=Me;function Be(u=1,d){let w=d??new t(3),b=Math.random()*2*Math.PI,M=Math.random()*2-1,_=Math.sqrt(1-M*M)*u;return w[0]=Math.cos(b)*_,w[1]=Math.sin(b)*_,w[2]=M*u,w}function s(u){let d=u??new t(3);return d[0]=0,d[1]=0,d[2]=0,d}function h(u,d,w){let b=w??new t(3),M=u[0],_=u[1],G=u[2],F=d[3]*M+d[7]*_+d[11]*G+d[15]||1;return b[0]=(d[0]*M+d[4]*_+d[8]*G+d[12])/F,b[1]=(d[1]*M+d[5]*_+d[9]*G+d[13])/F,b[2]=(d[2]*M+d[6]*_+d[10]*G+d[14])/F,b}function i(u,d,w){let b=w??new t(3),M=u[0],_=u[1],G=u[2];return b[0]=M*d[0*4+0]+_*d[1*4+0]+G*d[2*4+0],b[1]=M*d[0*4+1]+_*d[1*4+1]+G*d[2*4+1],b[2]=M*d[0*4+2]+_*d[1*4+2]+G*d[2*4+2],b}function a(u,d,w){let b=w??new t(3),M=u[0],_=u[1],G=u[2];return b[0]=M*d[0]+_*d[4]+G*d[8],b[1]=M*d[1]+_*d[5]+G*d[9],b[2]=M*d[2]+_*d[6]+G*d[10],b}function m(u,d,w){let b=w??new t(3),M=d[0],_=d[1],G=d[2],F=d[3]*2,V=u[0],I=u[1],R=u[2],q=_*R-G*I,W=G*V-M*R,Z=M*I-_*V;return b[0]=V+q*F+(_*Z-G*W)*2,b[1]=I+W*F+(G*q-M*Z)*2,b[2]=R+Z*F+(M*W-_*q)*2,b}function x(u,d){let w=d??new t(3);return w[0]=u[12],w[1]=u[13],w[2]=u[14],w}function P(u,d,w){let b=w??new t(3),M=d*4;return b[0]=u[M+0],b[1]=u[M+1],b[2]=u[M+2],b}function n(u,d){let w=d??new t(3),b=u[0],M=u[1],_=u[2],G=u[4],F=u[5],V=u[6],I=u[8],R=u[9],q=u[10];return w[0]=Math.sqrt(b*b+M*M+_*_),w[1]=Math.sqrt(G*G+F*F+V*V),w[2]=Math.sqrt(I*I+R*R+q*q),w}function c(u,d,w,b){let M=b??new t(3),_=[],G=[];return _[0]=u[0]-d[0],_[1]=u[1]-d[1],_[2]=u[2]-d[2],G[0]=_[0],G[1]=_[1]*Math.cos(w)-_[2]*Math.sin(w),G[2]=_[1]*Math.sin(w)+_[2]*Math.cos(w),M[0]=G[0]+d[0],M[1]=G[1]+d[1],M[2]=G[2]+d[2],M}function r(u,d,w,b){let M=b??new t(3),_=[],G=[];return _[0]=u[0]-d[0],_[1]=u[1]-d[1],_[2]=u[2]-d[2],G[0]=_[2]*Math.sin(w)+_[0]*Math.cos(w),G[1]=_[1],G[2]=_[2]*Math.cos(w)-_[0]*Math.sin(w),M[0]=G[0]+d[0],M[1]=G[1]+d[1],M[2]=G[2]+d[2],M}function o(u,d,w,b){let M=b??new t(3),_=[],G=[];return _[0]=u[0]-d[0],_[1]=u[1]-d[1],_[2]=u[2]-d[2],G[0]=_[0]*Math.cos(w)-_[1]*Math.sin(w),G[1]=_[0]*Math.sin(w)+_[1]*Math.cos(w),G[2]=_[2],M[0]=G[0]+d[0],M[1]=G[1]+d[1],M[2]=G[2]+d[2],M}function p(u,d,w){let b=w??new t(3);return he(u,b),ne(b,d,b)}function y(u,d,w){let b=w??new t(3);return re(u)>d?p(u,d,b):k(u,b)}function D(u,d,w){let b=w??new t(3);return E(u,d,.5,b)}return{create:e,fromValues:l,set:f,ceil:v,floor:g,round:T,clamp:U,add:S,addScaled:z,angle:B,subtract:L,sub:O,equalsApproximately:A,equals:C,lerp:E,lerpV:K,max:J,min:Y,mulScalar:ne,scale:be,divScalar:oe,inverse:pe,invert:de,cross:me,dot:Pe,length:re,len:ze,lengthSq:$,lenSq:j,distance:X,dist:Le,distanceSq:ge,distSq:Ie,normalize:he,negate:Fe,copy:k,clone:Re,multiply:Te,mul:Ae,divide:Me,div:Ee,random:Be,zero:s,transformMat4:h,transformMat4Upper3x3:i,transformMat3:a,transformQuat:m,getTranslation:x,getAxis:P,getScaling:n,rotateX:c,rotateY:r,rotateZ:o,setLength:p,truncate:y,midpoint:D}}var Xt=new Map;function ot(t){let e=Xt.get(t);return e||(e=Qn(t),Xt.set(t,e)),e}function Kn(t){let e=kt(t),l=ot(t);function f(s,h,i,a,m,x,P,n,c){let r=new t(12);return r[3]=0,r[7]=0,r[11]=0,s!==void 0&&(r[0]=s,h!==void 0&&(r[1]=h,i!==void 0&&(r[2]=i,a!==void 0&&(r[4]=a,m!==void 0&&(r[5]=m,x!==void 0&&(r[6]=x,P!==void 0&&(r[8]=P,n!==void 0&&(r[9]=n,c!==void 0&&(r[10]=c))))))))),r}function v(s,h,i,a,m,x,P,n,c,r){let o=r??new t(12);return o[0]=s,o[1]=h,o[2]=i,o[3]=0,o[4]=a,o[5]=m,o[6]=x,o[7]=0,o[8]=P,o[9]=n,o[10]=c,o[11]=0,o}function g(s,h){let i=h??new t(12);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=0,i[4]=s[4],i[5]=s[5],i[6]=s[6],i[7]=0,i[8]=s[8],i[9]=s[9],i[10]=s[10],i[11]=0,i}function T(s,h){let i=h??new t(12),a=s[0],m=s[1],x=s[2],P=s[3],n=a+a,c=m+m,r=x+x,o=a*n,p=m*n,y=m*c,D=x*n,u=x*c,d=x*r,w=P*n,b=P*c,M=P*r;return i[0]=1-y-d,i[1]=p+M,i[2]=D-b,i[3]=0,i[4]=p-M,i[5]=1-o-d,i[6]=u+w,i[7]=0,i[8]=D+b,i[9]=u-w,i[10]=1-o-y,i[11]=0,i}function U(s,h){let i=h??new t(12);return i[0]=-s[0],i[1]=-s[1],i[2]=-s[2],i[4]=-s[4],i[5]=-s[5],i[6]=-s[6],i[8]=-s[8],i[9]=-s[9],i[10]=-s[10],i}function S(s,h){let i=h??new t(12);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[4]=s[4],i[5]=s[5],i[6]=s[6],i[8]=s[8],i[9]=s[9],i[10]=s[10],i}let z=S;function B(s,h){return Math.abs(s[0]-h[0])<N&&Math.abs(s[1]-h[1])<N&&Math.abs(s[2]-h[2])<N&&Math.abs(s[4]-h[4])<N&&Math.abs(s[5]-h[5])<N&&Math.abs(s[6]-h[6])<N&&Math.abs(s[8]-h[8])<N&&Math.abs(s[9]-h[9])<N&&Math.abs(s[10]-h[10])<N}function L(s,h){return s[0]===h[0]&&s[1]===h[1]&&s[2]===h[2]&&s[4]===h[4]&&s[5]===h[5]&&s[6]===h[6]&&s[8]===h[8]&&s[9]===h[9]&&s[10]===h[10]}function O(s){let h=s??new t(12);return h[0]=1,h[1]=0,h[2]=0,h[4]=0,h[5]=1,h[6]=0,h[8]=0,h[9]=0,h[10]=1,h}function A(s,h){let i=h??new t(12);if(i===s){let y;return y=s[1],s[1]=s[4],s[4]=y,y=s[2],s[2]=s[8],s[8]=y,y=s[6],s[6]=s[9],s[9]=y,i}let a=s[0*4+0],m=s[0*4+1],x=s[0*4+2],P=s[1*4+0],n=s[1*4+1],c=s[1*4+2],r=s[2*4+0],o=s[2*4+1],p=s[2*4+2];return i[0]=a,i[1]=P,i[2]=r,i[4]=m,i[5]=n,i[6]=o,i[8]=x,i[9]=c,i[10]=p,i}function C(s,h){let i=h??new t(12),a=s[0*4+0],m=s[0*4+1],x=s[0*4+2],P=s[1*4+0],n=s[1*4+1],c=s[1*4+2],r=s[2*4+0],o=s[2*4+1],p=s[2*4+2],y=p*n-c*o,D=-p*P+c*r,u=o*P-n*r,d=1/(a*y+m*D+x*u);return i[0]=y*d,i[1]=(-p*m+x*o)*d,i[2]=(c*m-x*n)*d,i[4]=D*d,i[5]=(p*a-x*r)*d,i[6]=(-c*a+x*P)*d,i[8]=u*d,i[9]=(-o*a+m*r)*d,i[10]=(n*a-m*P)*d,i}function E(s){let h=s[0],i=s[0*4+1],a=s[0*4+2],m=s[1*4+0],x=s[1*4+1],P=s[1*4+2],n=s[2*4+0],c=s[2*4+1],r=s[2*4+2];return h*(x*r-c*P)-m*(i*r-c*a)+n*(i*P-x*a)}let K=C;function J(s,h,i){let a=i??new t(12),m=s[0],x=s[1],P=s[2],n=s[4],c=s[5],r=s[6],o=s[8],p=s[9],y=s[10],D=h[0],u=h[1],d=h[2],w=h[4],b=h[5],M=h[6],_=h[8],G=h[9],F=h[10];return a[0]=m*D+n*u+o*d,a[1]=x*D+c*u+p*d,a[2]=P*D+r*u+y*d,a[4]=m*w+n*b+o*M,a[5]=x*w+c*b+p*M,a[6]=P*w+r*b+y*M,a[8]=m*_+n*G+o*F,a[9]=x*_+c*G+p*F,a[10]=P*_+r*G+y*F,a}let Y=J;function ne(s,h,i){let a=i??O();return s!==a&&(a[0]=s[0],a[1]=s[1],a[2]=s[2],a[4]=s[4],a[5]=s[5],a[6]=s[6]),a[8]=h[0],a[9]=h[1],a[10]=1,a}function be(s,h){let i=h??e.create();return i[0]=s[8],i[1]=s[9],i}function oe(s,h,i){let a=i??e.create(),m=h*4;return a[0]=s[m+0],a[1]=s[m+1],a}function pe(s,h,i,a){let m=a===s?s:S(s,a),x=i*4;return m[x+0]=h[0],m[x+1]=h[1],m}function de(s,h){let i=h??e.create(),a=s[0],m=s[1],x=s[4],P=s[5];return i[0]=Math.sqrt(a*a+m*m),i[1]=Math.sqrt(x*x+P*P),i}function me(s,h){let i=h??l.create(),a=s[0],m=s[1],x=s[2],P=s[4],n=s[5],c=s[6],r=s[8],o=s[9],p=s[10];return i[0]=Math.sqrt(a*a+m*m+x*x),i[1]=Math.sqrt(P*P+n*n+c*c),i[2]=Math.sqrt(r*r+o*o+p*p),i}function Pe(s,h){let i=h??new t(12);return i[0]=1,i[1]=0,i[2]=0,i[4]=0,i[5]=1,i[6]=0,i[8]=s[0],i[9]=s[1],i[10]=1,i}function re(s,h,i){let a=i??new t(12),m=h[0],x=h[1],P=s[0],n=s[1],c=s[2],r=s[1*4+0],o=s[1*4+1],p=s[1*4+2],y=s[2*4+0],D=s[2*4+1],u=s[2*4+2];return s!==a&&(a[0]=P,a[1]=n,a[2]=c,a[4]=r,a[5]=o,a[6]=p),a[8]=P*m+r*x+y,a[9]=n*m+o*x+D,a[10]=c*m+p*x+u,a}function ze(s,h){let i=h??new t(12),a=Math.cos(s),m=Math.sin(s);return i[0]=a,i[1]=m,i[2]=0,i[4]=-m,i[5]=a,i[6]=0,i[8]=0,i[9]=0,i[10]=1,i}function $(s,h,i){let a=i??new t(12),m=s[0*4+0],x=s[0*4+1],P=s[0*4+2],n=s[1*4+0],c=s[1*4+1],r=s[1*4+2],o=Math.cos(h),p=Math.sin(h);return a[0]=o*m+p*n,a[1]=o*x+p*c,a[2]=o*P+p*r,a[4]=o*n-p*m,a[5]=o*c-p*x,a[6]=o*r-p*P,s!==a&&(a[8]=s[8],a[9]=s[9],a[10]=s[10]),a}function j(s,h){let i=h??new t(12),a=Math.cos(s),m=Math.sin(s);return i[0]=1,i[1]=0,i[2]=0,i[4]=0,i[5]=a,i[6]=m,i[8]=0,i[9]=-m,i[10]=a,i}function X(s,h,i){let a=i??new t(12),m=s[4],x=s[5],P=s[6],n=s[8],c=s[9],r=s[10],o=Math.cos(h),p=Math.sin(h);return a[4]=o*m+p*n,a[5]=o*x+p*c,a[6]=o*P+p*r,a[8]=o*n-p*m,a[9]=o*c-p*x,a[10]=o*r-p*P,s!==a&&(a[0]=s[0],a[1]=s[1],a[2]=s[2]),a}function Le(s,h){let i=h??new t(12),a=Math.cos(s),m=Math.sin(s);return i[0]=a,i[1]=0,i[2]=-m,i[4]=0,i[5]=1,i[6]=0,i[8]=m,i[9]=0,i[10]=a,i}function ge(s,h,i){let a=i??new t(12),m=s[0*4+0],x=s[0*4+1],P=s[0*4+2],n=s[2*4+0],c=s[2*4+1],r=s[2*4+2],o=Math.cos(h),p=Math.sin(h);return a[0]=o*m-p*n,a[1]=o*x-p*c,a[2]=o*P-p*r,a[8]=o*n+p*m,a[9]=o*c+p*x,a[10]=o*r+p*P,s!==a&&(a[4]=s[4],a[5]=s[5],a[6]=s[6]),a}let Ie=ze,he=$;function Fe(s,h){let i=h??new t(12);return i[0]=s[0],i[1]=0,i[2]=0,i[4]=0,i[5]=s[1],i[6]=0,i[8]=0,i[9]=0,i[10]=1,i}function k(s,h,i){let a=i??new t(12),m=h[0],x=h[1];return a[0]=m*s[0*4+0],a[1]=m*s[0*4+1],a[2]=m*s[0*4+2],a[4]=x*s[1*4+0],a[5]=x*s[1*4+1],a[6]=x*s[1*4+2],s!==a&&(a[8]=s[8],a[9]=s[9],a[10]=s[10]),a}function Re(s,h){let i=h??new t(12);return i[0]=s[0],i[1]=0,i[2]=0,i[4]=0,i[5]=s[1],i[6]=0,i[8]=0,i[9]=0,i[10]=s[2],i}function Te(s,h,i){let a=i??new t(12),m=h[0],x=h[1],P=h[2];return a[0]=m*s[0*4+0],a[1]=m*s[0*4+1],a[2]=m*s[0*4+2],a[4]=x*s[1*4+0],a[5]=x*s[1*4+1],a[6]=x*s[1*4+2],a[8]=P*s[2*4+0],a[9]=P*s[2*4+1],a[10]=P*s[2*4+2],a}function Ae(s,h){let i=h??new t(12);return i[0]=s,i[1]=0,i[2]=0,i[4]=0,i[5]=s,i[6]=0,i[8]=0,i[9]=0,i[10]=1,i}function Me(s,h,i){let a=i??new t(12);return a[0]=h*s[0*4+0],a[1]=h*s[0*4+1],a[2]=h*s[0*4+2],a[4]=h*s[1*4+0],a[5]=h*s[1*4+1],a[6]=h*s[1*4+2],s!==a&&(a[8]=s[8],a[9]=s[9],a[10]=s[10]),a}function Ee(s,h){let i=h??new t(12);return i[0]=s,i[1]=0,i[2]=0,i[4]=0,i[5]=s,i[6]=0,i[8]=0,i[9]=0,i[10]=s,i}function Be(s,h,i){let a=i??new t(12);return a[0]=h*s[0*4+0],a[1]=h*s[0*4+1],a[2]=h*s[0*4+2],a[4]=h*s[1*4+0],a[5]=h*s[1*4+1],a[6]=h*s[1*4+2],a[8]=h*s[2*4+0],a[9]=h*s[2*4+1],a[10]=h*s[2*4+2],a}return{clone:z,create:f,set:v,fromMat4:g,fromQuat:T,negate:U,copy:S,equalsApproximately:B,equals:L,identity:O,transpose:A,inverse:C,invert:K,determinant:E,mul:Y,multiply:J,setTranslation:ne,getTranslation:be,getAxis:oe,setAxis:pe,getScaling:de,get3DScaling:me,translation:Pe,translate:re,rotation:ze,rotate:$,rotationX:j,rotateX:X,rotationY:Le,rotateY:ge,rotationZ:Ie,rotateZ:he,scaling:Fe,scale:k,uniformScaling:Ae,uniformScale:Me,scaling3D:Re,scale3D:Te,uniformScaling3D:Ee,uniformScale3D:Be}}var $t=new Map;function Jn(t){let e=$t.get(t);return e||(e=Kn(t),$t.set(t,e)),e}function er(t){let e=ot(t);function l(n,c,r,o,p,y,D,u,d,w,b,M,_,G,F,V){let I=new t(16);return n!==void 0&&(I[0]=n,c!==void 0&&(I[1]=c,r!==void 0&&(I[2]=r,o!==void 0&&(I[3]=o,p!==void 0&&(I[4]=p,y!==void 0&&(I[5]=y,D!==void 0&&(I[6]=D,u!==void 0&&(I[7]=u,d!==void 0&&(I[8]=d,w!==void 0&&(I[9]=w,b!==void 0&&(I[10]=b,M!==void 0&&(I[11]=M,_!==void 0&&(I[12]=_,G!==void 0&&(I[13]=G,F!==void 0&&(I[14]=F,V!==void 0&&(I[15]=V)))))))))))))))),I}function f(n,c,r,o,p,y,D,u,d,w,b,M,_,G,F,V,I){let R=I??new t(16);return R[0]=n,R[1]=c,R[2]=r,R[3]=o,R[4]=p,R[5]=y,R[6]=D,R[7]=u,R[8]=d,R[9]=w,R[10]=b,R[11]=M,R[12]=_,R[13]=G,R[14]=F,R[15]=V,R}function v(n,c){let r=c??new t(16);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=0,r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=0,r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function g(n,c){let r=c??new t(16),o=n[0],p=n[1],y=n[2],D=n[3],u=o+o,d=p+p,w=y+y,b=o*u,M=p*u,_=p*d,G=y*u,F=y*d,V=y*w,I=D*u,R=D*d,q=D*w;return r[0]=1-_-V,r[1]=M+q,r[2]=G-R,r[3]=0,r[4]=M-q,r[5]=1-b-V,r[6]=F+I,r[7]=0,r[8]=G+R,r[9]=F-I,r[10]=1-b-_,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function T(n,c){let r=c??new t(16);return r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r[4]=-n[4],r[5]=-n[5],r[6]=-n[6],r[7]=-n[7],r[8]=-n[8],r[9]=-n[9],r[10]=-n[10],r[11]=-n[11],r[12]=-n[12],r[13]=-n[13],r[14]=-n[14],r[15]=-n[15],r}function U(n,c){let r=c??new t(16);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r}let S=U;function z(n,c){return Math.abs(n[0]-c[0])<N&&Math.abs(n[1]-c[1])<N&&Math.abs(n[2]-c[2])<N&&Math.abs(n[3]-c[3])<N&&Math.abs(n[4]-c[4])<N&&Math.abs(n[5]-c[5])<N&&Math.abs(n[6]-c[6])<N&&Math.abs(n[7]-c[7])<N&&Math.abs(n[8]-c[8])<N&&Math.abs(n[9]-c[9])<N&&Math.abs(n[10]-c[10])<N&&Math.abs(n[11]-c[11])<N&&Math.abs(n[12]-c[12])<N&&Math.abs(n[13]-c[13])<N&&Math.abs(n[14]-c[14])<N&&Math.abs(n[15]-c[15])<N}function B(n,c){return n[0]===c[0]&&n[1]===c[1]&&n[2]===c[2]&&n[3]===c[3]&&n[4]===c[4]&&n[5]===c[5]&&n[6]===c[6]&&n[7]===c[7]&&n[8]===c[8]&&n[9]===c[9]&&n[10]===c[10]&&n[11]===c[11]&&n[12]===c[12]&&n[13]===c[13]&&n[14]===c[14]&&n[15]===c[15]}function L(n){let c=n??new t(16);return c[0]=1,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=1,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c}function O(n,c){let r=c??new t(16);if(r===n){let W;return W=n[1],n[1]=n[4],n[4]=W,W=n[2],n[2]=n[8],n[8]=W,W=n[3],n[3]=n[12],n[12]=W,W=n[6],n[6]=n[9],n[9]=W,W=n[7],n[7]=n[13],n[13]=W,W=n[11],n[11]=n[14],n[14]=W,r}let o=n[0*4+0],p=n[0*4+1],y=n[0*4+2],D=n[0*4+3],u=n[1*4+0],d=n[1*4+1],w=n[1*4+2],b=n[1*4+3],M=n[2*4+0],_=n[2*4+1],G=n[2*4+2],F=n[2*4+3],V=n[3*4+0],I=n[3*4+1],R=n[3*4+2],q=n[3*4+3];return r[0]=o,r[1]=u,r[2]=M,r[3]=V,r[4]=p,r[5]=d,r[6]=_,r[7]=I,r[8]=y,r[9]=w,r[10]=G,r[11]=R,r[12]=D,r[13]=b,r[14]=F,r[15]=q,r}function A(n,c){let r=c??new t(16),o=n[0*4+0],p=n[0*4+1],y=n[0*4+2],D=n[0*4+3],u=n[1*4+0],d=n[1*4+1],w=n[1*4+2],b=n[1*4+3],M=n[2*4+0],_=n[2*4+1],G=n[2*4+2],F=n[2*4+3],V=n[3*4+0],I=n[3*4+1],R=n[3*4+2],q=n[3*4+3],W=G*q,Z=R*F,ee=w*q,te=R*b,ie=w*F,se=G*b,ae=y*q,ce=R*D,ue=y*F,le=G*D,xe=y*b,ve=w*D,we=M*I,ye=V*_,De=u*I,_e=V*d,Ge=u*_,je=M*d,ke=o*I,Ze=V*p,Qe=o*_,Ke=M*p,Je=o*d,et=u*p,St=W*d+te*_+ie*I-(Z*d+ee*_+se*I),Pt=Z*p+ae*_+le*I-(W*p+ce*_+ue*I),Bt=ee*p+ce*d+xe*I-(te*p+ae*d+ve*I),Dt=se*p+ue*d+ve*_-(ie*p+le*d+xe*_),fe=1/(o*St+u*Pt+M*Bt+V*Dt);return r[0]=fe*St,r[1]=fe*Pt,r[2]=fe*Bt,r[3]=fe*Dt,r[4]=fe*(Z*u+ee*M+se*V-(W*u+te*M+ie*V)),r[5]=fe*(W*o+ce*M+ue*V-(Z*o+ae*M+le*V)),r[6]=fe*(te*o+ae*u+ve*V-(ee*o+ce*u+xe*V)),r[7]=fe*(ie*o+le*u+xe*M-(se*o+ue*u+ve*M)),r[8]=fe*(we*b+_e*F+Ge*q-(ye*b+De*F+je*q)),r[9]=fe*(ye*D+ke*F+Ke*q-(we*D+Ze*F+Qe*q)),r[10]=fe*(De*D+Ze*b+Je*q-(_e*D+ke*b+et*q)),r[11]=fe*(je*D+Qe*b+et*F-(Ge*D+Ke*b+Je*F)),r[12]=fe*(De*G+je*R+ye*w-(Ge*R+we*w+_e*G)),r[13]=fe*(Qe*R+we*y+Ze*G-(ke*G+Ke*R+ye*y)),r[14]=fe*(ke*w+et*R+_e*y-(Je*R+De*y+Ze*w)),r[15]=fe*(Je*G+Ge*y+Ke*w-(Qe*w+et*G+je*y)),r}function C(n){let c=n[0],r=n[0*4+1],o=n[0*4+2],p=n[0*4+3],y=n[1*4+0],D=n[1*4+1],u=n[1*4+2],d=n[1*4+3],w=n[2*4+0],b=n[2*4+1],M=n[2*4+2],_=n[2*4+3],G=n[3*4+0],F=n[3*4+1],V=n[3*4+2],I=n[3*4+3],R=M*I,q=V*_,W=u*I,Z=V*d,ee=u*_,te=M*d,ie=o*I,se=V*p,ae=o*_,ce=M*p,ue=o*d,le=u*p,xe=R*D+Z*b+ee*F-(q*D+W*b+te*F),ve=q*r+ie*b+ce*F-(R*r+se*b+ae*F),we=W*r+se*D+ue*F-(Z*r+ie*D+le*F),ye=te*r+ae*D+le*b-(ee*r+ce*D+ue*b);return c*xe+y*ve+w*we+G*ye}let E=A;function K(n,c,r){let o=r??new t(16),p=n[0],y=n[1],D=n[2],u=n[3],d=n[4],w=n[5],b=n[6],M=n[7],_=n[8],G=n[9],F=n[10],V=n[11],I=n[12],R=n[13],q=n[14],W=n[15],Z=c[0],ee=c[1],te=c[2],ie=c[3],se=c[4],ae=c[5],ce=c[6],ue=c[7],le=c[8],xe=c[9],ve=c[10],we=c[11],ye=c[12],De=c[13],_e=c[14],Ge=c[15];return o[0]=p*Z+d*ee+_*te+I*ie,o[1]=y*Z+w*ee+G*te+R*ie,o[2]=D*Z+b*ee+F*te+q*ie,o[3]=u*Z+M*ee+V*te+W*ie,o[4]=p*se+d*ae+_*ce+I*ue,o[5]=y*se+w*ae+G*ce+R*ue,o[6]=D*se+b*ae+F*ce+q*ue,o[7]=u*se+M*ae+V*ce+W*ue,o[8]=p*le+d*xe+_*ve+I*we,o[9]=y*le+w*xe+G*ve+R*we,o[10]=D*le+b*xe+F*ve+q*we,o[11]=u*le+M*xe+V*ve+W*we,o[12]=p*ye+d*De+_*_e+I*Ge,o[13]=y*ye+w*De+G*_e+R*Ge,o[14]=D*ye+b*De+F*_e+q*Ge,o[15]=u*ye+M*De+V*_e+W*Ge,o}let J=K;function Y(n,c,r){let o=r??L();return n!==o&&(o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],o[4]=n[4],o[5]=n[5],o[6]=n[6],o[7]=n[7],o[8]=n[8],o[9]=n[9],o[10]=n[10],o[11]=n[11]),o[12]=c[0],o[13]=c[1],o[14]=c[2],o[15]=1,o}function ne(n,c){let r=c??e.create();return r[0]=n[12],r[1]=n[13],r[2]=n[14],r}function be(n,c,r){let o=r??e.create(),p=c*4;return o[0]=n[p+0],o[1]=n[p+1],o[2]=n[p+2],o}function oe(n,c,r,o){let p=o===n?o:U(n,o),y=r*4;return p[y+0]=c[0],p[y+1]=c[1],p[y+2]=c[2],p}function pe(n,c){let r=c??e.create(),o=n[0],p=n[1],y=n[2],D=n[4],u=n[5],d=n[6],w=n[8],b=n[9],M=n[10];return r[0]=Math.sqrt(o*o+p*p+y*y),r[1]=Math.sqrt(D*D+u*u+d*d),r[2]=Math.sqrt(w*w+b*b+M*M),r}function de(n,c,r,o,p){let y=p??new t(16),D=Math.tan(Math.PI*.5-.5*n);if(y[0]=D/c,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=D,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,Number.isFinite(o)){let u=1/(r-o);y[10]=o*u,y[14]=o*r*u}else y[10]=-1,y[14]=-r;return y}function me(n,c,r,o=1/0,p){let y=p??new t(16),D=1/Math.tan(n*.5);if(y[0]=D/c,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=D,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,o===1/0)y[10]=0,y[14]=r;else{let u=1/(o-r);y[10]=r*u,y[14]=o*r*u}return y}function Pe(n,c,r,o,p,y,D){let u=D??new t(16);return u[0]=2/(c-n),u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2/(o-r),u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1/(p-y),u[11]=0,u[12]=(c+n)/(n-c),u[13]=(o+r)/(r-o),u[14]=p/(p-y),u[15]=1,u}function re(n,c,r,o,p,y,D){let u=D??new t(16),d=c-n,w=o-r,b=p-y;return u[0]=2*p/d,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*p/w,u[6]=0,u[7]=0,u[8]=(n+c)/d,u[9]=(o+r)/w,u[10]=y/b,u[11]=-1,u[12]=0,u[13]=0,u[14]=p*y/b,u[15]=0,u}function ze(n,c,r,o,p,y=1/0,D){let u=D??new t(16),d=c-n,w=o-r;if(u[0]=2*p/d,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*p/w,u[6]=0,u[7]=0,u[8]=(n+c)/d,u[9]=(o+r)/w,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,y===1/0)u[10]=0,u[14]=p;else{let b=1/(y-p);u[10]=p*b,u[14]=y*p*b}return u}let $=e.create(),j=e.create(),X=e.create();function Le(n,c,r,o){let p=o??new t(16);return e.normalize(e.subtract(c,n,X),X),e.normalize(e.cross(r,X,$),$),e.normalize(e.cross(X,$,j),j),p[0]=$[0],p[1]=$[1],p[2]=$[2],p[3]=0,p[4]=j[0],p[5]=j[1],p[6]=j[2],p[7]=0,p[8]=X[0],p[9]=X[1],p[10]=X[2],p[11]=0,p[12]=n[0],p[13]=n[1],p[14]=n[2],p[15]=1,p}function ge(n,c,r,o){let p=o??new t(16);return e.normalize(e.subtract(n,c,X),X),e.normalize(e.cross(r,X,$),$),e.normalize(e.cross(X,$,j),j),p[0]=$[0],p[1]=$[1],p[2]=$[2],p[3]=0,p[4]=j[0],p[5]=j[1],p[6]=j[2],p[7]=0,p[8]=X[0],p[9]=X[1],p[10]=X[2],p[11]=0,p[12]=n[0],p[13]=n[1],p[14]=n[2],p[15]=1,p}function Ie(n,c,r,o){let p=o??new t(16);return e.normalize(e.subtract(n,c,X),X),e.normalize(e.cross(r,X,$),$),e.normalize(e.cross(X,$,j),j),p[0]=$[0],p[1]=j[0],p[2]=X[0],p[3]=0,p[4]=$[1],p[5]=j[1],p[6]=X[1],p[7]=0,p[8]=$[2],p[9]=j[2],p[10]=X[2],p[11]=0,p[12]=-($[0]*n[0]+$[1]*n[1]+$[2]*n[2]),p[13]=-(j[0]*n[0]+j[1]*n[1]+j[2]*n[2]),p[14]=-(X[0]*n[0]+X[1]*n[1]+X[2]*n[2]),p[15]=1,p}function he(n,c){let r=c??new t(16);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function Fe(n,c,r){let o=r??new t(16),p=c[0],y=c[1],D=c[2],u=n[0],d=n[1],w=n[2],b=n[3],M=n[1*4+0],_=n[1*4+1],G=n[1*4+2],F=n[1*4+3],V=n[2*4+0],I=n[2*4+1],R=n[2*4+2],q=n[2*4+3],W=n[3*4+0],Z=n[3*4+1],ee=n[3*4+2],te=n[3*4+3];return n!==o&&(o[0]=u,o[1]=d,o[2]=w,o[3]=b,o[4]=M,o[5]=_,o[6]=G,o[7]=F,o[8]=V,o[9]=I,o[10]=R,o[11]=q),o[12]=u*p+M*y+V*D+W,o[13]=d*p+_*y+I*D+Z,o[14]=w*p+G*y+R*D+ee,o[15]=b*p+F*y+q*D+te,o}function k(n,c){let r=c??new t(16),o=Math.cos(n),p=Math.sin(n);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=o,r[6]=p,r[7]=0,r[8]=0,r[9]=-p,r[10]=o,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Re(n,c,r){let o=r??new t(16),p=n[4],y=n[5],D=n[6],u=n[7],d=n[8],w=n[9],b=n[10],M=n[11],_=Math.cos(c),G=Math.sin(c);return o[4]=_*p+G*d,o[5]=_*y+G*w,o[6]=_*D+G*b,o[7]=_*u+G*M,o[8]=_*d-G*p,o[9]=_*w-G*y,o[10]=_*b-G*D,o[11]=_*M-G*u,n!==o&&(o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function Te(n,c){let r=c??new t(16),o=Math.cos(n),p=Math.sin(n);return r[0]=o,r[1]=0,r[2]=-p,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=p,r[9]=0,r[10]=o,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ae(n,c,r){let o=r??new t(16),p=n[0*4+0],y=n[0*4+1],D=n[0*4+2],u=n[0*4+3],d=n[2*4+0],w=n[2*4+1],b=n[2*4+2],M=n[2*4+3],_=Math.cos(c),G=Math.sin(c);return o[0]=_*p-G*d,o[1]=_*y-G*w,o[2]=_*D-G*b,o[3]=_*u-G*M,o[8]=_*d+G*p,o[9]=_*w+G*y,o[10]=_*b+G*D,o[11]=_*M+G*u,n!==o&&(o[4]=n[4],o[5]=n[5],o[6]=n[6],o[7]=n[7],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function Me(n,c){let r=c??new t(16),o=Math.cos(n),p=Math.sin(n);return r[0]=o,r[1]=p,r[2]=0,r[3]=0,r[4]=-p,r[5]=o,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ee(n,c,r){let o=r??new t(16),p=n[0*4+0],y=n[0*4+1],D=n[0*4+2],u=n[0*4+3],d=n[1*4+0],w=n[1*4+1],b=n[1*4+2],M=n[1*4+3],_=Math.cos(c),G=Math.sin(c);return o[0]=_*p+G*d,o[1]=_*y+G*w,o[2]=_*D+G*b,o[3]=_*u+G*M,o[4]=_*d-G*p,o[5]=_*w-G*y,o[6]=_*b-G*D,o[7]=_*M-G*u,n!==o&&(o[8]=n[8],o[9]=n[9],o[10]=n[10],o[11]=n[11],o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function Be(n,c,r){let o=r??new t(16),p=n[0],y=n[1],D=n[2],u=Math.sqrt(p*p+y*y+D*D);p/=u,y/=u,D/=u;let d=p*p,w=y*y,b=D*D,M=Math.cos(c),_=Math.sin(c),G=1-M;return o[0]=d+(1-d)*M,o[1]=p*y*G+D*_,o[2]=p*D*G-y*_,o[3]=0,o[4]=p*y*G-D*_,o[5]=w+(1-w)*M,o[6]=y*D*G+p*_,o[7]=0,o[8]=p*D*G+y*_,o[9]=y*D*G-p*_,o[10]=b+(1-b)*M,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}let s=Be;function h(n,c,r,o){let p=o??new t(16),y=c[0],D=c[1],u=c[2],d=Math.sqrt(y*y+D*D+u*u);y/=d,D/=d,u/=d;let w=y*y,b=D*D,M=u*u,_=Math.cos(r),G=Math.sin(r),F=1-_,V=w+(1-w)*_,I=y*D*F+u*G,R=y*u*F-D*G,q=y*D*F-u*G,W=b+(1-b)*_,Z=D*u*F+y*G,ee=y*u*F+D*G,te=D*u*F-y*G,ie=M+(1-M)*_,se=n[0],ae=n[1],ce=n[2],ue=n[3],le=n[4],xe=n[5],ve=n[6],we=n[7],ye=n[8],De=n[9],_e=n[10],Ge=n[11];return p[0]=V*se+I*le+R*ye,p[1]=V*ae+I*xe+R*De,p[2]=V*ce+I*ve+R*_e,p[3]=V*ue+I*we+R*Ge,p[4]=q*se+W*le+Z*ye,p[5]=q*ae+W*xe+Z*De,p[6]=q*ce+W*ve+Z*_e,p[7]=q*ue+W*we+Z*Ge,p[8]=ee*se+te*le+ie*ye,p[9]=ee*ae+te*xe+ie*De,p[10]=ee*ce+te*ve+ie*_e,p[11]=ee*ue+te*we+ie*Ge,n!==p&&(p[12]=n[12],p[13]=n[13],p[14]=n[14],p[15]=n[15]),p}let i=h;function a(n,c){let r=c??new t(16);return r[0]=n[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function m(n,c,r){let o=r??new t(16),p=c[0],y=c[1],D=c[2];return o[0]=p*n[0*4+0],o[1]=p*n[0*4+1],o[2]=p*n[0*4+2],o[3]=p*n[0*4+3],o[4]=y*n[1*4+0],o[5]=y*n[1*4+1],o[6]=y*n[1*4+2],o[7]=y*n[1*4+3],o[8]=D*n[2*4+0],o[9]=D*n[2*4+1],o[10]=D*n[2*4+2],o[11]=D*n[2*4+3],n!==o&&(o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}function x(n,c){let r=c??new t(16);return r[0]=n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function P(n,c,r){let o=r??new t(16);return o[0]=c*n[0*4+0],o[1]=c*n[0*4+1],o[2]=c*n[0*4+2],o[3]=c*n[0*4+3],o[4]=c*n[1*4+0],o[5]=c*n[1*4+1],o[6]=c*n[1*4+2],o[7]=c*n[1*4+3],o[8]=c*n[2*4+0],o[9]=c*n[2*4+1],o[10]=c*n[2*4+2],o[11]=c*n[2*4+3],n!==o&&(o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]),o}return{create:l,set:f,fromMat3:v,fromQuat:g,negate:T,copy:U,clone:S,equalsApproximately:z,equals:B,identity:L,transpose:O,inverse:A,determinant:C,invert:E,multiply:K,mul:J,setTranslation:Y,getTranslation:ne,getAxis:be,setAxis:oe,getScaling:pe,perspective:de,perspectiveReverseZ:me,ortho:Pe,frustum:re,frustumReverseZ:ze,aim:Le,cameraAim:ge,lookAt:Ie,translation:he,translate:Fe,rotationX:k,rotateX:Re,rotationY:Te,rotateY:Ae,rotationZ:Me,rotateZ:Ee,axisRotation:Be,rotation:s,axisRotate:h,rotate:i,scaling:a,scale:m,uniformScaling:x,uniformScale:P}}var Wt=new Map;function tr(t){let e=Wt.get(t);return e||(e=er(t),Wt.set(t,e)),e}function nr(t){let e=ot(t);function l(s,h,i,a){let m=new t(4);return s!==void 0&&(m[0]=s,h!==void 0&&(m[1]=h,i!==void 0&&(m[2]=i,a!==void 0&&(m[3]=a)))),m}let f=l;function v(s,h,i,a,m){let x=m??new t(4);return x[0]=s,x[1]=h,x[2]=i,x[3]=a,x}function g(s,h,i){let a=i??new t(4),m=h*.5,x=Math.sin(m);return a[0]=x*s[0],a[1]=x*s[1],a[2]=x*s[2],a[3]=Math.cos(m),a}function T(s,h){let i=h??e.create(3),a=Math.acos(s[3])*2,m=Math.sin(a*.5);return m>N?(i[0]=s[0]/m,i[1]=s[1]/m,i[2]=s[2]/m):(i[0]=1,i[1]=0,i[2]=0),{angle:a,axis:i}}function U(s,h){let i=re(s,h);return Math.acos(2*i*i-1)}function S(s,h,i){let a=i??new t(4),m=s[0],x=s[1],P=s[2],n=s[3],c=h[0],r=h[1],o=h[2],p=h[3];return a[0]=m*p+n*c+x*o-P*r,a[1]=x*p+n*r+P*c-m*o,a[2]=P*p+n*o+m*r-x*c,a[3]=n*p-m*c-x*r-P*o,a}let z=S;function B(s,h,i){let a=i??new t(4),m=h*.5,x=s[0],P=s[1],n=s[2],c=s[3],r=Math.sin(m),o=Math.cos(m);return a[0]=x*o+c*r,a[1]=P*o+n*r,a[2]=n*o-P*r,a[3]=c*o-x*r,a}function L(s,h,i){let a=i??new t(4),m=h*.5,x=s[0],P=s[1],n=s[2],c=s[3],r=Math.sin(m),o=Math.cos(m);return a[0]=x*o-n*r,a[1]=P*o+c*r,a[2]=n*o+x*r,a[3]=c*o-P*r,a}function O(s,h,i){let a=i??new t(4),m=h*.5,x=s[0],P=s[1],n=s[2],c=s[3],r=Math.sin(m),o=Math.cos(m);return a[0]=x*o+P*r,a[1]=P*o-x*r,a[2]=n*o+c*r,a[3]=c*o-n*r,a}function A(s,h,i,a){let m=a??new t(4),x=s[0],P=s[1],n=s[2],c=s[3],r=h[0],o=h[1],p=h[2],y=h[3],D=x*r+P*o+n*p+c*y;D<0&&(D=-D,r=-r,o=-o,p=-p,y=-y);let u,d;if(1-D>N){let w=Math.acos(D),b=Math.sin(w);u=Math.sin((1-i)*w)/b,d=Math.sin(i*w)/b}else u=1-i,d=i;return m[0]=u*x+d*r,m[1]=u*P+d*o,m[2]=u*n+d*p,m[3]=u*c+d*y,m}function C(s,h){let i=h??new t(4),a=s[0],m=s[1],x=s[2],P=s[3],n=a*a+m*m+x*x+P*P,c=n?1/n:0;return i[0]=-a*c,i[1]=-m*c,i[2]=-x*c,i[3]=P*c,i}function E(s,h){let i=h??new t(4);return i[0]=-s[0],i[1]=-s[1],i[2]=-s[2],i[3]=s[3],i}function K(s,h){let i=h??new t(4),a=s[0]+s[5]+s[10];if(a>0){let m=Math.sqrt(a+1);i[3]=.5*m;let x=.5/m;i[0]=(s[6]-s[9])*x,i[1]=(s[8]-s[2])*x,i[2]=(s[1]-s[4])*x}else{let m=0;s[5]>s[0]&&(m=1),s[10]>s[m*4+m]&&(m=2);let x=(m+1)%3,P=(m+2)%3,n=Math.sqrt(s[m*4+m]-s[x*4+x]-s[P*4+P]+1);i[m]=.5*n;let c=.5/n;i[3]=(s[x*4+P]-s[P*4+x])*c,i[x]=(s[x*4+m]+s[m*4+x])*c,i[P]=(s[P*4+m]+s[m*4+P])*c}return i}function J(s,h,i,a,m){let x=m??new t(4),P=s*.5,n=h*.5,c=i*.5,r=Math.sin(P),o=Math.cos(P),p=Math.sin(n),y=Math.cos(n),D=Math.sin(c),u=Math.cos(c);switch(a){case"xyz":x[0]=r*y*u+o*p*D,x[1]=o*p*u-r*y*D,x[2]=o*y*D+r*p*u,x[3]=o*y*u-r*p*D;break;case"xzy":x[0]=r*y*u-o*p*D,x[1]=o*p*u-r*y*D,x[2]=o*y*D+r*p*u,x[3]=o*y*u+r*p*D;break;case"yxz":x[0]=r*y*u+o*p*D,x[1]=o*p*u-r*y*D,x[2]=o*y*D-r*p*u,x[3]=o*y*u+r*p*D;break;case"yzx":x[0]=r*y*u+o*p*D,x[1]=o*p*u+r*y*D,x[2]=o*y*D-r*p*u,x[3]=o*y*u-r*p*D;break;case"zxy":x[0]=r*y*u-o*p*D,x[1]=o*p*u+r*y*D,x[2]=o*y*D+r*p*u,x[3]=o*y*u-r*p*D;break;case"zyx":x[0]=r*y*u-o*p*D,x[1]=o*p*u+r*y*D,x[2]=o*y*D-r*p*u,x[3]=o*y*u+r*p*D;break;default:throw new Error(`Unknown rotation order: ${a}`)}return x}function Y(s,h){let i=h??new t(4);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],i}let ne=Y;function be(s,h,i){let a=i??new t(4);return a[0]=s[0]+h[0],a[1]=s[1]+h[1],a[2]=s[2]+h[2],a[3]=s[3]+h[3],a}function oe(s,h,i){let a=i??new t(4);return a[0]=s[0]-h[0],a[1]=s[1]-h[1],a[2]=s[2]-h[2],a[3]=s[3]-h[3],a}let pe=oe;function de(s,h,i){let a=i??new t(4);return a[0]=s[0]*h,a[1]=s[1]*h,a[2]=s[2]*h,a[3]=s[3]*h,a}let me=de;function Pe(s,h,i){let a=i??new t(4);return a[0]=s[0]/h,a[1]=s[1]/h,a[2]=s[2]/h,a[3]=s[3]/h,a}function re(s,h){return s[0]*h[0]+s[1]*h[1]+s[2]*h[2]+s[3]*h[3]}function ze(s,h,i,a){let m=a??new t(4);return m[0]=s[0]+i*(h[0]-s[0]),m[1]=s[1]+i*(h[1]-s[1]),m[2]=s[2]+i*(h[2]-s[2]),m[3]=s[3]+i*(h[3]-s[3]),m}function $(s){let h=s[0],i=s[1],a=s[2],m=s[3];return Math.sqrt(h*h+i*i+a*a+m*m)}let j=$;function X(s){let h=s[0],i=s[1],a=s[2],m=s[3];return h*h+i*i+a*a+m*m}let Le=X;function ge(s,h){let i=h??new t(4),a=s[0],m=s[1],x=s[2],P=s[3],n=Math.sqrt(a*a+m*m+x*x+P*P);return n>1e-5?(i[0]=a/n,i[1]=m/n,i[2]=x/n,i[3]=P/n):(i[0]=0,i[1]=0,i[2]=0,i[3]=1),i}function Ie(s,h){return Math.abs(s[0]-h[0])<N&&Math.abs(s[1]-h[1])<N&&Math.abs(s[2]-h[2])<N&&Math.abs(s[3]-h[3])<N}function he(s,h){return s[0]===h[0]&&s[1]===h[1]&&s[2]===h[2]&&s[3]===h[3]}function Fe(s){let h=s??new t(4);return h[0]=0,h[1]=0,h[2]=0,h[3]=1,h}let k=e.create(),Re=e.create(),Te=e.create();function Ae(s,h,i){let a=i??new t(4),m=e.dot(s,h);return m<-.999999?(e.cross(Re,s,k),e.len(k)<1e-6&&e.cross(Te,s,k),e.normalize(k,k),g(k,Math.PI,a),a):m>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(e.cross(s,h,k),a[0]=k[0],a[1]=k[1],a[2]=k[2],a[3]=1+m,ge(a,a))}let Me=new t(4),Ee=new t(4);function Be(s,h,i,a,m,x){let P=x??new t(4);return A(s,a,m,Me),A(h,i,m,Ee),A(Me,Ee,2*m*(1-m),P),P}return{create:l,fromValues:f,set:v,fromAxisAngle:g,toAxisAngle:T,angle:U,multiply:S,mul:z,rotateX:B,rotateY:L,rotateZ:O,slerp:A,inverse:C,conjugate:E,fromMat:K,fromEuler:J,copy:Y,clone:ne,add:be,subtract:oe,sub:pe,mulScalar:de,scale:me,divScalar:Pe,dot:re,lerp:ze,length:$,len:j,lengthSq:X,lenSq:Le,normalize:ge,equalsApproximately:Ie,equals:he,identity:Fe,rotationTo:Ae,sqlerp:Be}}var Ht=new Map;function rr(t){let e=Ht.get(t);return e||(e=nr(t),Ht.set(t,e)),e}function ir(t){function e(i,a,m,x){let P=new t(4);return i!==void 0&&(P[0]=i,a!==void 0&&(P[1]=a,m!==void 0&&(P[2]=m,x!==void 0&&(P[3]=x)))),P}let l=e;function f(i,a,m,x,P){let n=P??new t(4);return n[0]=i,n[1]=a,n[2]=m,n[3]=x,n}function v(i,a){let m=a??new t(4);return m[0]=Math.ceil(i[0]),m[1]=Math.ceil(i[1]),m[2]=Math.ceil(i[2]),m[3]=Math.ceil(i[3]),m}function g(i,a){let m=a??new t(4);return m[0]=Math.floor(i[0]),m[1]=Math.floor(i[1]),m[2]=Math.floor(i[2]),m[3]=Math.floor(i[3]),m}function T(i,a){let m=a??new t(4);return m[0]=Math.round(i[0]),m[1]=Math.round(i[1]),m[2]=Math.round(i[2]),m[3]=Math.round(i[3]),m}function U(i,a=0,m=1,x){let P=x??new t(4);return P[0]=Math.min(m,Math.max(a,i[0])),P[1]=Math.min(m,Math.max(a,i[1])),P[2]=Math.min(m,Math.max(a,i[2])),P[3]=Math.min(m,Math.max(a,i[3])),P}function S(i,a,m){let x=m??new t(4);return x[0]=i[0]+a[0],x[1]=i[1]+a[1],x[2]=i[2]+a[2],x[3]=i[3]+a[3],x}function z(i,a,m,x){let P=x??new t(4);return P[0]=i[0]+a[0]*m,P[1]=i[1]+a[1]*m,P[2]=i[2]+a[2]*m,P[3]=i[3]+a[3]*m,P}function B(i,a,m){let x=m??new t(4);return x[0]=i[0]-a[0],x[1]=i[1]-a[1],x[2]=i[2]-a[2],x[3]=i[3]-a[3],x}let L=B;function O(i,a){return Math.abs(i[0]-a[0])<N&&Math.abs(i[1]-a[1])<N&&Math.abs(i[2]-a[2])<N&&Math.abs(i[3]-a[3])<N}function A(i,a){return i[0]===a[0]&&i[1]===a[1]&&i[2]===a[2]&&i[3]===a[3]}function C(i,a,m,x){let P=x??new t(4);return P[0]=i[0]+m*(a[0]-i[0]),P[1]=i[1]+m*(a[1]-i[1]),P[2]=i[2]+m*(a[2]-i[2]),P[3]=i[3]+m*(a[3]-i[3]),P}function E(i,a,m,x){let P=x??new t(4);return P[0]=i[0]+m[0]*(a[0]-i[0]),P[1]=i[1]+m[1]*(a[1]-i[1]),P[2]=i[2]+m[2]*(a[2]-i[2]),P[3]=i[3]+m[3]*(a[3]-i[3]),P}function K(i,a,m){let x=m??new t(4);return x[0]=Math.max(i[0],a[0]),x[1]=Math.max(i[1],a[1]),x[2]=Math.max(i[2],a[2]),x[3]=Math.max(i[3],a[3]),x}function J(i,a,m){let x=m??new t(4);return x[0]=Math.min(i[0],a[0]),x[1]=Math.min(i[1],a[1]),x[2]=Math.min(i[2],a[2]),x[3]=Math.min(i[3],a[3]),x}function Y(i,a,m){let x=m??new t(4);return x[0]=i[0]*a,x[1]=i[1]*a,x[2]=i[2]*a,x[3]=i[3]*a,x}let ne=Y;function be(i,a,m){let x=m??new t(4);return x[0]=i[0]/a,x[1]=i[1]/a,x[2]=i[2]/a,x[3]=i[3]/a,x}function oe(i,a){let m=a??new t(4);return m[0]=1/i[0],m[1]=1/i[1],m[2]=1/i[2],m[3]=1/i[3],m}let pe=oe;function de(i,a){return i[0]*a[0]+i[1]*a[1]+i[2]*a[2]+i[3]*a[3]}function me(i){let a=i[0],m=i[1],x=i[2],P=i[3];return Math.sqrt(a*a+m*m+x*x+P*P)}let Pe=me;function re(i){let a=i[0],m=i[1],x=i[2],P=i[3];return a*a+m*m+x*x+P*P}let ze=re;function $(i,a){let m=i[0]-a[0],x=i[1]-a[1],P=i[2]-a[2],n=i[3]-a[3];return Math.sqrt(m*m+x*x+P*P+n*n)}let j=$;function X(i,a){let m=i[0]-a[0],x=i[1]-a[1],P=i[2]-a[2],n=i[3]-a[3];return m*m+x*x+P*P+n*n}let Le=X;function ge(i,a){let m=a??new t(4),x=i[0],P=i[1],n=i[2],c=i[3],r=Math.sqrt(x*x+P*P+n*n+c*c);return r>1e-5?(m[0]=x/r,m[1]=P/r,m[2]=n/r,m[3]=c/r):(m[0]=0,m[1]=0,m[2]=0,m[3]=0),m}function Ie(i,a){let m=a??new t(4);return m[0]=-i[0],m[1]=-i[1],m[2]=-i[2],m[3]=-i[3],m}function he(i,a){let m=a??new t(4);return m[0]=i[0],m[1]=i[1],m[2]=i[2],m[3]=i[3],m}let Fe=he;function k(i,a,m){let x=m??new t(4);return x[0]=i[0]*a[0],x[1]=i[1]*a[1],x[2]=i[2]*a[2],x[3]=i[3]*a[3],x}let Re=k;function Te(i,a,m){let x=m??new t(4);return x[0]=i[0]/a[0],x[1]=i[1]/a[1],x[2]=i[2]/a[2],x[3]=i[3]/a[3],x}let Ae=Te;function Me(i){let a=i??new t(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a}function Ee(i,a,m){let x=m??new t(4),P=i[0],n=i[1],c=i[2],r=i[3];return x[0]=a[0]*P+a[4]*n+a[8]*c+a[12]*r,x[1]=a[1]*P+a[5]*n+a[9]*c+a[13]*r,x[2]=a[2]*P+a[6]*n+a[10]*c+a[14]*r,x[3]=a[3]*P+a[7]*n+a[11]*c+a[15]*r,x}function Be(i,a,m){let x=m??new t(4);return ge(i,x),Y(x,a,x)}function s(i,a,m){let x=m??new t(4);return me(i)>a?Be(i,a,x):he(i,x)}function h(i,a,m){let x=m??new t(4);return C(i,a,.5,x)}return{create:e,fromValues:l,set:f,ceil:v,floor:g,round:T,clamp:U,add:S,addScaled:z,subtract:B,sub:L,equalsApproximately:O,equals:A,lerp:C,lerpV:E,max:K,min:J,mulScalar:Y,scale:ne,divScalar:be,inverse:oe,invert:pe,dot:de,length:me,len:Pe,lengthSq:re,lenSq:ze,distance:$,dist:j,distanceSq:X,distSq:Le,normalize:ge,negate:Ie,copy:he,clone:Fe,multiply:k,mul:Re,divide:Te,div:Ae,zero:Me,transformMat4:Ee,setLength:Be,truncate:s,midpoint:h}}var jt=new Map;function or(t){let e=jt.get(t);return e||(e=ir(t),jt.set(t,e)),e}function gt(t,e,l,f,v,g){return{mat3:Jn(t),mat4:tr(e),quat:rr(l),vec2:kt(f),vec3:ot(v),vec4:or(g)}}var{mat3:hi,mat4:H,quat:xi,vec2:ht,vec3:Ce,vec4:Zt}=gt(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array),{mat3:vi,mat4:wi,quat:yi,vec2:bi,vec3:Ti,vec4:Mi}=gt(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),{mat3:Si,mat4:Pi,quat:Bi,vec2:Di,vec3:_i,vec4:Gi}=gt(kn,Array,Array,Array,Array,Array);var st=class{device;format="r8unorm";downsizeFactor;multisample;textureSimple;textureMultisampled=null;renderPipeline;bindgroup;uniformsBuffer;trianglesBuffer;constructor(e){this.device=e.device,this.downsizeFactor=e.blurFactor,this.multisample=this.downsizeFactor>1?4:1,[this.textureSimple,this.textureMultisampled]=this.createTextures(e.width,e.height),this.trianglesBuffer=e.trianglesBuffer;let l=this.device.createShaderModule({label:"DisplacementTexture shader module",code:qt});this.renderPipeline=this.device.createRenderPipeline({label:"DisplacementTexture renderpipeline",layout:"auto",vertex:{module:l,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x2"}],arrayStride:2*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"}]},fragment:{module:l,entryPoint:"main_fragment",targets:[{format:this.format}]},primitive:{cullMode:"none",topology:"triangle-list"},multisample:{count:this.multisample}}),this.uniformsBuffer=this.device.createBuffer({label:"DisplacementTexture uniforms buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bindgroup=this.device.createBindGroup({label:"DisplacementTexture bindgroup",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformsBuffer}}]})}update(e){let l=this.textureMultisampled??this.textureSimple,f={view:l.view,clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"};this.textureMultisampled&&(f.resolveTarget=this.textureSimple.view);let v=e.beginRenderPass({label:"DisplacementTexture render to texture renderpass",colorAttachments:[f]}),[g,T]=[l.texture.width,l.texture.height];v.setViewport(0,0,g,T,0,1),v.setScissorRect(0,0,g,T),v.setPipeline(this.renderPipeline),v.setBindGroup(0,this.bindgroup),v.setVertexBuffer(0,this.trianglesBuffer.bufferGpu),v.draw(3*this.trianglesBuffer.spriteCount),v.end()}resize(e,l){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),[this.textureSimple,this.textureMultisampled]=this.createTextures(e,l)}setViewport(e){let l=[1,1,1],f=0,v=[1,1,0],g=H.identity();H.multiply(H.scaling(l),g,g),H.multiply(H.rotationZ(f),g,g),H.multiply(H.translation(v),g,g);let T=H.translation([-e.position[0],-e.position[1],0]),U=e.width/e.zoom,S=e.height/e.zoom,z=H.ortho(0,U,S,0,-10,10),B=H.identity();H.multiply(T,g,B),H.multiply(z,B,B),this.device.queue.writeBuffer(this.uniformsBuffer,0,B)}getView(){return this.textureSimple.view}destroy(){this.textureSimple.texture.destroy(),this.textureMultisampled?.texture.destroy(),this.uniformsBuffer.destroy()}createTextures(e,l){let f=this.device.createTexture({label:"DisplacementTexture texture",size:[Math.ceil(e/this.downsizeFactor),Math.ceil(l/this.downsizeFactor)],format:this.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),v={texture:f,view:f.createView({label:"DisplacementTexture texture view"})},g=null;if(this.multisample>1){let T=this.device.createTexture({label:"DisplacementTexture texture multisampled",size:[f.width,f.height],format:f.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.multisample});g={texture:T,view:T.createView({label:"DisplacementTexture texture multisampled view"})}}return[v,g]}};var Kt={type:"cobalt:displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return sr(t,e)},onRun:function(t,e,l){ar(t,e,l)},onDestroy:function(t,e){cr(e)},onResize:function(t,e){e.data.displacementTexture.resize(t.viewport.width,t.viewport.height),e.data.displacementComposition.setColorTextureView(e.refs.color.data.view),e.data.displacementComposition.setNoiseMapTextureView(e.refs.map.view),e.data.displacementComposition.setDisplacementTextureView(e.data.displacementTexture.getView())},onViewportPosition:function(t,e){e.data.displacementTexture.setViewport(t.viewport)},customFunctions:{addTriangle:function(t,e,l){return e.data.trianglesBuffer.addTriangle(l)},removeTriangle:function(t,e,l){e.data.trianglesBuffer.removeTriangle(l)},setPosition:function(t,e,l,f){e.data.trianglesBuffer.setTriangle(l,f)}}};async function sr(t,e){let{device:l}=t,f=new rt({device:l,initialParameters:{offsetX:e.options.offseyX??0,offsetY:e.options.offseyY??0,scale:e.options.scale??20}}),v=256,g=new nt({device:l,maxSpriteCount:v}),T=new st({device:l,width:t.viewport.width,height:t.viewport.height,blurFactor:8,trianglesBuffer:g}),U=new it({device:l,targetFormat:"bgra8unorm",colorTextureView:e.refs.color.data.view,noiseMapTextureView:e.refs.map.view,displacementTextureView:T.getView(),displacementParametersBuffer:f});return{displacementParameters:f,displacementTexture:T,displacementComposition:U,trianglesBuffer:g}}function ar(t,e,l){if(e.data.trianglesBuffer.spriteCount===0)return;e.data.trianglesBuffer.update(),e.data.displacementTexture.update(l);let v=l.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});v.executeBundles([e.data.displacementComposition.getRenderBundle()]),v.end()}function cr(t){t.data.trianglesBuffer.destroy(),t.data.trianglesBuffer=null,t.data.displacementParameters.destroy(),t.data.displacementParameters=null,t.data.displacementTexture.destroy(),t.data.displacementTexture=null,t.data.displacementComposition.destroy(),t.data.displacementComposition=null}function xt(t,e){let l=e.vertices,f=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,v={size:l.byteLength,usage:f,mappedAtCreation:!0},g=t.createBuffer(v);return new Float32Array(g.getMappedRange()).set(l),g.unmap(),{buffer:g,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var vt="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var Zi=Zt.create(),Jt=Ce.create(),tn={type:"cobalt:overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return lr(t,e)},onRun:function(t,e,l){fr(t,e,l)},onDestroy:function(t,e){dr(e)},onResize:function(t,e){en(t,e)},onViewportPosition:function(t,e){en(t,e)},customFunctions:{...He}};async function lr(t,e){let{device:l}=t,f=16192,v=f,T=Float32Array.BYTES_PER_ELEMENT*2,S=Float32Array.BYTES_PER_ELEMENT*2,B=Float32Array.BYTES_PER_ELEMENT*4,O=Float32Array.BYTES_PER_ELEMENT*4,A=l.createBuffer({size:(T+S+B+O)*v,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),C=l.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),E=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),K=l.createBindGroup({layout:E,entries:[{binding:0,resource:{buffer:C}},{binding:1,resource:e.refs.spritesheet.data.colorTexture.view},{binding:2,resource:e.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:A}}]}),J=l.createPipelineLayout({bindGroupLayouts:[E]}),Y=l.createRenderPipeline({label:"overlay",vertex:{module:l.createShaderModule({code:vt}),entryPoint:"vs_main",buffers:[e.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:l.createShaderModule({code:vt}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:J});return{instancedDrawCalls:new Uint32Array(f*2),instancedDrawCallCount:0,spriteBuffer:A,uniformBuffer:C,pipeline:Y,bindGroupLayout:E,bindGroup:K,spriteData:new Float32Array(f*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function fr(t,e,l){let{device:f}=t,v=e.options.loadOp||"load";if(e.data.dirty&&(pr(e.data),e.data.dirty=!1),e.data.spriteCount>0){let S=e.data.spriteCount*12*Float32Array.BYTES_PER_ELEMENT;f.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer,0,S)}let g=l.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:v,storeOp:"store"}]});g.setPipeline(e.data.pipeline),g.setBindGroup(0,e.data.bindGroup),g.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let T=6,U=0;for(let S=0;S<e.data.instancedDrawCallCount;S++){let z=e.data.instancedDrawCalls[S*2]*T,B=e.data.instancedDrawCalls[S*2+1];g.draw(T,B,z,U),U+=B}g.end()}function pr(t){let e=-1,l=0;t.instancedDrawCallCount=0;for(let f=0;f<t.spriteCount;f++){let v=t.spriteData[f*12+11]&65535;v!==e&&(l>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=l,t.instancedDrawCallCount++),e=v,l=0),l++}l>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=l,t.instancedDrawCallCount++)}function en(t,e){let f=Math.round(t.viewport.width/1),v=Math.round(t.viewport.height/1),g=H.ortho(0,f,v,0,-10,10);Ce.set(0,0,0,Jt);let T=H.translation(Jt);t.device.queue.writeBuffer(e.data.uniformBuffer,0,T.buffer),t.device.queue.writeBuffer(e.data.uniformBuffer,64,g.buffer)}function dr(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var yt="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4<f32>(positions[VertexIndex],0.0,1.0);output.TexCoord=vec2<f32>(uvs[VertexIndex]);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var nn={type:"cobalt:fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return gr(t,e)},onRun:function(t,e,l){hr(t,e,l)},onDestroy:function(t,e){},onResize:function(t,e){xr(t,e)},onViewportPosition:function(t,e){}};async function gr(t,e){let{device:l}=t,f=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),v=l.createBindGroup({layout:f,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]}),g=l.createPipelineLayout({bindGroupLayouts:[f]}),T=l.createRenderPipeline({label:"fb-blit",vertex:{module:l.createShaderModule({code:yt}),entryPoint:"vs_main",buffers:[]},fragment:{module:l.createShaderModule({code:yt}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:g});return{bindGroupLayout:f,bindGroup:v,pipeline:T}}function hr(t,e,l){let{device:f}=t,v=l.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});v.setPipeline(e.data.pipeline),v.setBindGroup(0,e.data.bindGroup),v.draw(3),v.end()}function xr(t,e){let{device:l}=t;e.data.bindGroup=l.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]})}var rn="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function Xe(t,e,l,f,v,g=1){let T=ht.sub(f,l),U=ht.normalize(T),S=wr(U),z=g/2,B=e.data.vertexCount*6;e.data.vertices[B+0]=l[0]+S[0]*z,e.data.vertices[B+1]=l[1]+S[1]*z,e.data.vertices[B+2]=v[0],e.data.vertices[B+3]=v[1],e.data.vertices[B+4]=v[2],e.data.vertices[B+5]=v[3],e.data.vertices[B+6]=l[0]-S[0]*z,e.data.vertices[B+7]=l[1]-S[1]*z,e.data.vertices[B+8]=v[0],e.data.vertices[B+9]=v[1],e.data.vertices[B+10]=v[2],e.data.vertices[B+11]=v[3],e.data.vertices[B+12]=f[0]+S[0]*z,e.data.vertices[B+13]=f[1]+S[1]*z,e.data.vertices[B+14]=v[0],e.data.vertices[B+15]=v[1],e.data.vertices[B+16]=v[2],e.data.vertices[B+17]=v[3],e.data.vertices[B+18]=l[0]-S[0]*z,e.data.vertices[B+19]=l[1]-S[1]*z,e.data.vertices[B+20]=v[0],e.data.vertices[B+21]=v[1],e.data.vertices[B+22]=v[2],e.data.vertices[B+23]=v[3],e.data.vertices[B+24]=f[0]+S[0]*z,e.data.vertices[B+25]=f[1]+S[1]*z,e.data.vertices[B+26]=v[0],e.data.vertices[B+27]=v[1],e.data.vertices[B+28]=v[2],e.data.vertices[B+29]=v[3],e.data.vertices[B+30]=f[0]-S[0]*z,e.data.vertices[B+31]=f[1]-S[1]*z,e.data.vertices[B+32]=v[0],e.data.vertices[B+33]=v[1],e.data.vertices[B+34]=v[2],e.data.vertices[B+35]=v[3],e.data.vertexCount+=6,e.data.dirty=!0}function wr(t){return[-t[1],t[0]]}var on={line:Xe,ellipse:function(t,e,l,f,v,g,T,U=1){let[S,z]=l,B=2*Math.PI/g;for(let L=0;L<g;L++){let O=L*B,A=(L+1)*B,C=S+f*Math.cos(O),E=z+v*Math.sin(O),K=S+f*Math.cos(A),J=z+v*Math.sin(A);Xe(t,e,[C,E],[K,J],T,U)}},filledEllipse:function(t,e,l,f,v,g,T){let[U,S]=l,z=2*Math.PI/g;for(let B=0;B<g;B++){let L=B*z,O=(B+1)*z,A=U+f*Math.cos(L),C=S+v*Math.sin(L),E=U+f*Math.cos(O),K=S+v*Math.sin(O),Y=e.data.vertexCount*6+B*18;e.data.vertices[Y+0]=U,e.data.vertices[Y+1]=S,e.data.vertices[Y+2]=T[0],e.data.vertices[Y+3]=T[1],e.data.vertices[Y+4]=T[2],e.data.vertices[Y+5]=T[3],e.data.vertices[Y+6]=A,e.data.vertices[Y+7]=C,e.data.vertices[Y+8]=T[0],e.data.vertices[Y+9]=T[1],e.data.vertices[Y+10]=T[2],e.data.vertices[Y+11]=T[3],e.data.vertices[Y+12]=E,e.data.vertices[Y+13]=K,e.data.vertices[Y+14]=T[0],e.data.vertices[Y+15]=T[1],e.data.vertices[Y+16]=T[2],e.data.vertices[Y+17]=T[3]}e.data.vertexCount+=3*g,e.data.dirty=!0},box:function(t,e,l,f,v,g,T=0,U=1){let[S,z]=l,B=f/2,L=v/2,O=[S-B,z-L],A=[S+B,z-L],C=[S-B,z+L],E=[S+B,z+L];T!==0&&(qe(O,l,T,O),qe(A,l,T,A),qe(C,l,T,C),qe(E,l,T,E)),Xe(t,e,O,A,g,U),Xe(t,e,C,E,g,U),Xe(t,e,O,C,g,U),Xe(t,e,A,E,g,U)},filledBox:function(t,e,l,f,v,g,T=0){let[U,S]=l,z=f/2,B=v/2,L=[U-z,S-B],O=[U+z,S-B],A=[U-z,S+B],C=[U+z,S+B];T!==0&&(qe(L,l,T,L),qe(O,l,T,O),qe(A,l,T,A),qe(C,l,T,C));let E=e.data.vertexCount*6;e.data.vertices[E+0]=L[0],e.data.vertices[E+1]=L[1],e.data.vertices[E+2]=g[0],e.data.vertices[E+3]=g[1],e.data.vertices[E+4]=g[2],e.data.vertices[E+5]=g[3],e.data.vertices[E+6]=A[0],e.data.vertices[E+7]=A[1],e.data.vertices[E+8]=g[0],e.data.vertices[E+9]=g[1],e.data.vertices[E+10]=g[2],e.data.vertices[E+11]=g[3],e.data.vertices[E+12]=O[0],e.data.vertices[E+13]=O[1],e.data.vertices[E+14]=g[0],e.data.vertices[E+15]=g[1],e.data.vertices[E+16]=g[2],e.data.vertices[E+17]=g[3],e.data.vertices[E+18]=A[0],e.data.vertices[E+19]=A[1],e.data.vertices[E+20]=g[0],e.data.vertices[E+21]=g[1],e.data.vertices[E+22]=g[2],e.data.vertices[E+23]=g[3],e.data.vertices[E+24]=C[0],e.data.vertices[E+25]=C[1],e.data.vertices[E+26]=g[0],e.data.vertices[E+27]=g[1],e.data.vertices[E+28]=g[2],e.data.vertices[E+29]=g[3],e.data.vertices[E+30]=O[0],e.data.vertices[E+31]=O[1],e.data.vertices[E+32]=g[0],e.data.vertices[E+33]=g[1],e.data.vertices[E+34]=g[2],e.data.vertices[E+35]=g[3],e.data.vertexCount+=6,e.data.dirty=!0},clear:function(t,e){e.data.vertexCount=0,e.data.dirty=!0}};function qe(t,e,l,f){let v=t[0]-e[0],g=t[1]-e[1],T=Math.sin(l),U=Math.cos(l);return f[0]=v*U-g*T+e[0],f[1]=v*T+g*U+e[1],f}var sn=Ce.create(0,0,0),cn={type:"cobalt:primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return yr(t,e)},onRun:function(t,e,l){br(t,e,l)},onDestroy:function(t,e){Tr(e)},onResize:function(t,e){an(t,e)},onViewportPosition:function(t,e){an(t,e)},customFunctions:on};async function yr(t,e){let{device:l}=t,f=new Float32Array(3e5),v=l.createBuffer({size:f.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),g=l.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),T=l.createShaderModule({code:rn}),U=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),S=l.createPipelineLayout({bindGroupLayouts:[U]}),z=l.createBindGroup({layout:U,entries:[{binding:0,resource:{buffer:g}}]}),B=l.createRenderPipeline({layout:S,vertex:{module:T,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:T,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:g,vertexBuffer:v,pipeline:B,bindGroup:z,vertexCount:0,dirty:!1,vertices:f}}function br(t,e,l){if(e.data.vertexCount===0)return;let{device:f}=t;if(e.data.dirty){e.data.dirty=!1;let T=6*Float32Array.BYTES_PER_ELEMENT,U=e.data.vertexCount*T;if(U>e.data.vertexBuffer.size){console.warn("too many primitives, bailing");return}t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer,0,U)}let v=e.options.loadOp||"load",g=l.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:v,storeOp:"store"}]});g.setPipeline(e.data.pipeline),g.setBindGroup(0,e.data.bindGroup),g.setVertexBuffer(0,e.data.vertexBuffer),g.draw(e.data.vertexCount),g.end()}function Tr(t){t.data.vertexBuffer.destroy(),t.data.vertexBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null}function an(t,e){let{device:l}=t,f=t.viewport.width/t.viewport.zoom,v=t.viewport.height/t.viewport.zoom,g=H.ortho(0,f,v,0,-10,10);Ce.set(-t.viewport.position[0],-t.viewport.position[1],0,sn);let T=H.translation(sn);l.queue.writeBuffer(e.data.uniformBuffer,0,T.buffer),l.queue.writeBuffer(e.data.uniformBuffer,64,g.buffer)}var bt={};_t(bt,{setAmbientLight:()=>Sr,setLights:()=>Mr,setOccluders:()=>Pr});function Mr(t,e,l){e.data.lights=l,e.data.lightsBufferNeedsUpdate=!0}function Sr(t,e,l){e.data.lightsRenderer.setAmbientLight(l)}function Pr(t,e,l){e.data.lightsRenderer.setObstacles(l),e.data.lightsTextureNeedsUpdate=!0}var at=class{invViewProjectionMatrix=H.identity();viewportSize={width:1,height:1};topLeft=[0,0];zoom=1;constructor(e){this.setViewportSize(e.viewportSize.width,e.viewportSize.height);let l=e.center??this.topLeft;this.setTopLeft(...l);let f=e.zoom??1;this.setZoom(f)}get invertViewProjectionMatrix(){return this.invViewProjectionMatrix}setViewportSize(e,l){this.viewportSize.width=e,this.viewportSize.height=l,this.updateMatrices()}setTopLeft(e,l){this.topLeft[0]=e,this.topLeft[1]=l,this.updateMatrices()}setZoom(e){this.zoom=e,this.updateMatrices()}updateMatrices(){H.identity(this.invViewProjectionMatrix),H.multiply(H.scaling([1,-1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),H.multiply(H.translation([1,1,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),H.multiply(H.scaling([.5*this.viewportSize.width/this.zoom,.5*this.viewportSize.height/this.zoom,0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix),H.multiply(H.translation([this.topLeft[0],this.topLeft[1],0]),this.invViewProjectionMatrix,this.invViewProjectionMatrix)}};var Ue=class t{static structs={definition:`
struct Light {                //             align(16) size(48)
    color: vec3<f32>,         // offset(0)   align(16) size(12)
    radius: f32,              // offset(12)  align(4)  size(4)
    position: vec2<f32>,      // offset(16)  align(8)  size(8)
    intensity: f32,           // offset(24)  align(4)  size(4)
    attenuationLinear: f32,   // offset(28)  align(4)  size(4)
    attenuationExp: f32,      // offset(32)  align(4)  size(4)
};

struct LightsBuffer {         //             align(16)
    count: u32,               // offset(0)   align(4)  size(4)
    // padding
    lights: array<Light>,     // offset(16)  align(16)
};
`,light:{radius:{offset:12},position:{offset:16}},lightsBuffer:{lights:{offset:16,stride:48}}};device;maxLightsCount;currentLightsCount=0;buffer;get gpuBuffer(){return this.buffer.bufferGpu}constructor(e,l){this.device=e,this.maxLightsCount=l;let f=new ArrayBuffer(t.computeBufferBytesLength(l)),v=e.createBuffer({label:"LightsBuffer buffer",size:f.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.VERTEX});this.buffer={bufferCpu:f,bufferGpu:v},this.setLights([])}setLights(e){if(e.length>this.maxLightsCount)throw new Error(`Too many lights "${e.length}", max is "${this.maxLightsCount}".`);let l=t.computeBufferBytesLength(e.length);new Uint32Array(this.buffer.bufferCpu,0,1).set([e.length]),e.forEach((f,v)=>{new Float32Array(this.buffer.bufferCpu,t.structs.lightsBuffer.lights.offset+t.structs.lightsBuffer.lights.stride*v,9).set([...f.color,f.radius,...f.position,f.intensity,f.attenuationLinear,f.attenuationExp])}),this.device.queue.writeBuffer(this.buffer.bufferGpu,0,this.buffer.bufferCpu,0,l),this.currentLightsCount=e.length}get lightsCount(){return this.currentLightsCount}destroy(){this.buffer.bufferGpu.destroy()}static computeBufferBytesLength(e){return t.structs.lightsBuffer.lights.offset+t.structs.lightsBuffer.lights.stride*e}};var ct=class{lightsBuffer;renderPipeline;bindgroup;renderBundle;constructor(e,l,f,v){this.lightsBuffer=l;let g=e.createShaderModule({label:"LightsTextureInitializer shader module",code:`
${Ue.structs.definition}

@group(0) @binding(0) var<storage,read> lightsBuffer: LightsBuffer;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${f.gridSize.x}, ${f.gridSize.y});
const cellsGridSizeF = vec2<f32>(${f.gridSize.x}, ${f.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.uv = (0.5 + 0.5 * screenPosition) * cellsGridSizeF;
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

struct LightProperties {
    radius: f32,
    intensity: f32,
    attenuationLinear: f32,
    attenuationExp: f32,
};

fn get_light_properties(lightId: u32) -> LightProperties {
    var lightProperties: LightProperties;
    if (lightId < lightsBuffer.count) {
        let light = lightsBuffer.lights[lightId];
        lightProperties.radius = light.radius;
        lightProperties.intensity = 1.0;
        lightProperties.attenuationLinear = light.attenuationLinear;
        lightProperties.attenuationExp = light.attenuationExp;
    } else {
        lightProperties.radius = 0.0;
        lightProperties.intensity = 0.0;
        lightProperties.attenuationLinear = 0.0;
        lightProperties.attenuationExp = 0.0;
    }
    return lightProperties;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let cellId = vec2<u32>(in.uv);

    let lightIdFrom = 4u * (cellId.x + cellId.y * cellsGridSizeU.x);
    let lightProperties = array<LightProperties, 4>(
        get_light_properties(lightIdFrom + 0u),
        get_light_properties(lightIdFrom + 1u),
        get_light_properties(lightIdFrom + 2u),
        get_light_properties(lightIdFrom + 3u),
    );

    let sizes = vec4<f32>(
        lightProperties[0].radius,
        lightProperties[1].radius,
        lightProperties[2].radius,
        lightProperties[3].radius,
    );

    let localUv = fract(in.uv);
    let fromCenter = 2.0 * localUv - 1.0;
    let uvDistanceFromCenter = distance(vec2<f32>(0,0), fromCenter);
    let distancesFromCenter = vec4<f32>(uvDistanceFromCenter / sizes * f32(${v}));

    let intensities = vec4<f32>(
        lightProperties[0].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[1].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[2].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
        lightProperties[3].intensity * (1.0 + 1.0 * step(uvDistanceFromCenter, 0.01)),
    );
    let attenuationsLinear = vec4<f32>(
        lightProperties[0].attenuationLinear,
        lightProperties[1].attenuationLinear,
        lightProperties[2].attenuationLinear,
        lightProperties[3].attenuationLinear,
    );
    let attenuationsExp = vec4<f32>(
        lightProperties[0].attenuationExp,
        lightProperties[1].attenuationExp,
        lightProperties[2].attenuationExp,
        lightProperties[3].attenuationExp,
    );

    var lightIntensities = intensities / (1.0 + distancesFromCenter * (attenuationsLinear + distancesFromCenter * attenuationsExp)); // base intensity equation
    lightIntensities *= cos(distancesFromCenter * ${Math.PI/2}); // soft limit;
    lightIntensities *= step(distancesFromCenter, vec4<f32>(1.0)); // hard limit

    var out: FragmentOut;
    out.color = lightIntensities;
    return out;
}
            `});this.renderPipeline=e.createRenderPipeline({label:"LightsTextureInitializer renderpipeline",layout:"auto",vertex:{module:g,entryPoint:"main_vertex"},fragment:{module:g,entryPoint:"main_fragment",targets:[{format:f.format}]},primitive:{cullMode:"none",topology:"triangle-strip"},multisample:{count:f.sampleCount}}),this.bindgroup=e.createBindGroup({label:"LightsTextureInitializer bindgroup 0",layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.lightsBuffer.gpuBuffer}}]});let T=e.createRenderBundleEncoder({label:"LightsTextureInitializer renderbundle encoder",colorFormats:[f.format],sampleCount:f.sampleCount});T.setPipeline(this.renderPipeline),T.setBindGroup(0,this.bindgroup),T.draw(4),this.renderBundle=T.finish({label:"LightsTextureInitializer renderbundle"})}getRenderBundle(){return this.renderBundle}destroy(){}};var ut=class{device;renderPipeline;renderBundleEncoderDescriptor;renderBundle;lightsBuffer;indirectDrawing;obstacles=null;constructor(e,l,f,v){this.device=e,this.lightsBuffer=l;let g=!0,T=e.createShaderModule({label:"LightsTextureMask shader module",code:`
struct VertexIn {
    @builtin(instance_index) lightIndex: u32,
    @location(0) position: vec3<f32>,
    @location(1) lightSize: f32,
    @location(2) lightPosition: vec2<f32>,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) localPosition: vec2<f32>,
};

const cellsGridSizeU = vec2<u32>(${f.gridSize.x}, ${f.gridSize.y});
const cellsGridSizeF = vec2<f32>(${f.gridSize.x}, ${f.gridSize.y});

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    let worldPosition = in.lightPosition + (in.position.xy - in.lightPosition) * (1.0 + 10000.0 * in.position.z);

    let scaling = f32(${v});

    let cellIndex = in.lightIndex / 4u;
    let indexInCell = in.lightIndex % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);

    var out: VertexOut;
    out.localPosition = (worldPosition - in.lightPosition) / scaling;
    out.position = vec4<f32>(
        (out.localPosition - (cellsGridSizeF - 1.0) + 2.0 * cellIdF) / cellsGridSizeF,
        0.0,
        1.0,
    );
    out.color = vec4<f32>(
        vec4<u32>(indexInCell) != vec4<u32>(0u, 1u, 2u, 3u),
    );
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    if (in.localPosition.x < -1.0 || in.localPosition.x > 1.0 || in.localPosition.y <= -1.0 || in.localPosition.y > 1.0) {
        discard;
    }
    var out: FragmentOut;
    out.color = in.color;
    return out;
}
            `});this.renderPipeline=e.createRenderPipeline({label:"LightsTextureMask renderpipeline",layout:"auto",vertex:{module:T,entryPoint:"main_vertex",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:3*Float32Array.BYTES_PER_ELEMENT,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:Ue.structs.light.radius.offset,format:"float32"},{shaderLocation:2,offset:Ue.structs.light.position.offset,format:"float32x2"}],arrayStride:Ue.structs.lightsBuffer.lights.stride,stepMode:"instance"}]},fragment:{module:T,entryPoint:"main_fragment",targets:[{format:f.format,blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{operation:"min",srcFactor:"one",dstFactor:"one"}}}]},primitive:{cullMode:g?"none":"back",topology:"triangle-list"},multisample:{count:f.sampleCount}}),this.indirectDrawing={bufferCpu:new ArrayBuffer(20),bufferGpu:e.createBuffer({label:"LightsTextureMask indirect buffer",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})},this.uploadIndirectDrawingBuffer(),this.renderBundleEncoderDescriptor={label:"LightsTextureMask renderbundle encoder",colorFormats:[f.format],sampleCount:f.sampleCount},this.renderBundle=this.buildRenderBundle()}getRenderBundle(){return this.renderBundle}setObstacles(e){let l=[],f=[];for(let z of e){let B=l.length/3;l.push(...z[0],0,...z[1],0,...z[0],1,...z[1],1),f.push(B+0,B+1,B+3,B+0,B+3,B+2)}let v=!1,g=new Float32Array(l),T=this.obstacles?.positionsBufferGpu;(!T||T.size<g.byteLength)&&(T?.destroy(),T=this.device.createBuffer({label:"LightsTextureMask positions buffer",size:g.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),v=!0),this.device.queue.writeBuffer(T,0,g);let U=new Uint16Array(f),S=this.obstacles?.indexBufferGpu;(!S||S.size<U.byteLength)&&(S?.destroy(),S=this.device.createBuffer({label:"LightsTextureMask index buffer",size:U.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),v=!0),this.device.queue.writeBuffer(S,0,U),this.obstacles={positionsBufferGpu:T,indexBufferGpu:S},this.setIndirectIndexCount(f.length),v&&(this.renderBundle=this.buildRenderBundle())}setLightsCount(e){this.setIndirectInstanceCount(e)}destroy(){this.indirectDrawing.bufferGpu.destroy(),this.obstacles?.positionsBufferGpu.destroy(),this.obstacles?.indexBufferGpu.destroy()}setIndirectIndexCount(e){let l=new Uint32Array(this.indirectDrawing.bufferCpu);l[0]!==e&&(l[0]=e,this.uploadIndirectDrawingBuffer())}setIndirectInstanceCount(e){let l=new Uint32Array(this.indirectDrawing.bufferCpu);l[1]!==e&&(l[1]=e,this.uploadIndirectDrawingBuffer())}buildRenderBundle(){let e=this.device.createRenderBundleEncoder(this.renderBundleEncoderDescriptor);return this.obstacles&&(e.setPipeline(this.renderPipeline),e.setVertexBuffer(0,this.obstacles.positionsBufferGpu),e.setVertexBuffer(1,this.lightsBuffer.gpuBuffer,Ue.structs.lightsBuffer.lights.offset),e.setIndexBuffer(this.obstacles.indexBufferGpu,"uint16"),e.drawIndexedIndirect(this.indirectDrawing.bufferGpu,0)),e.finish({label:"LightsTextureMask renderbundle"})}uploadIndirectDrawingBuffer(){this.device.queue.writeBuffer(this.indirectDrawing.bufferGpu,0,this.indirectDrawing.bufferCpu)}};var lt=class{lightsBuffer;texture;gridSize;textureMultisampled=null;textureRenderpassDescriptor;textureInitializer;textureMask;constructor(e,l,f){this.lightsBuffer=l;let v=this.lightsBuffer.maxLightsCount/4,g={x:Math.ceil(Math.sqrt(v)),y:0};g.y=Math.ceil(v/g.x),this.gridSize=g;let T={width:g.x*f.resolutionPerLight,height:g.y*f.resolutionPerLight},U="rgba8unorm";this.texture=e.createTexture({label:"LightsTextureMask texture",size:[T.width,T.height],format:U,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT}),f.antialiased&&(this.textureMultisampled=e.createTexture({label:"LightsTextureMask texture multisampled",size:[T.width,T.height],format:U,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:4}));let z={view:(this.textureMultisampled??this.texture).createView(),clearValue:[0,0,0,1],loadOp:"load",storeOp:"store"};f.antialiased&&(z.resolveTarget=this.texture.createView()),this.textureRenderpassDescriptor={label:"lights-renderer render to texture renderpass",colorAttachments:[z]};let B={gridSize:g,format:U,sampleCount:this.textureMultisampled?.sampleCount??1};this.textureInitializer=new ct(e,l,B,f.maxLightSize),this.textureMask=new ut(e,l,B,f.maxLightSize)}update(e){this.textureMask.setLightsCount(this.lightsBuffer.lightsCount);let l=e.beginRenderPass(this.textureRenderpassDescriptor),[f,v]=[this.texture.width,this.texture.height];l.setViewport(0,0,f,v,0,1),l.setScissorRect(0,0,f,v),l.executeBundles([this.textureInitializer.getRenderBundle(),this.textureMask.getRenderBundle()]),l.end()}setObstacles(e){this.textureMask.setObstacles(e)}destroy(){this.texture.destroy(),this.textureMultisampled?.destroy(),this.textureInitializer.destroy(),this.textureMask.destroy()}};var ft=class{device;ambientLight=[.2,.2,.2];targetTexture;renderPipeline;uniformsBufferGpu;bindgroup0;bindgroup1;renderBundle;lightsBuffer;lightsTexture;constructor(e){this.device=e.device,this.targetTexture=e.targetTexture,this.lightsBuffer=e.lightsBuffer,this.lightsTexture=new lt(e.device,e.lightsBuffer,e.lightsTextureProperties),this.uniformsBufferGpu=e.device.createBuffer({label:"LightsRenderer uniforms buffer",size:80,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let l=e.device.createShaderModule({label:"LightsRenderer shader module",code:`
struct Uniforms {                  //            align(16) size(80)
    invertViewMatrix: mat4x4<f32>, // offset(0)  align(16) size(64)
    ambientLight: vec3<f32>,       // offset(64) align(16) size(12)
};

${Ue.structs.definition}

@group(0) @binding(0) var<uniform> uniforms: Uniforms;
@group(0) @binding(1) var<storage,read> lightsBuffer: LightsBuffer;
@group(0) @binding(2) var lightsTexture: texture_2d<f32>;
@group(0) @binding(3) var lightsTextureSampler: sampler;

@group(1) @binding(0) var albedoTexture: texture_2d<f32>;
@group(1) @binding(1) var albedoSampler: sampler;

struct VertexIn {
    @builtin(vertex_index) vertexIndex: u32,
};

struct VertexOut {
    @builtin(position) position: vec4<f32>,
    @location(0) worldPosition: vec2<f32>,
    @location(1) uv: vec2<f32>,
};

@vertex
fn main_vertex(in: VertexIn) -> VertexOut {
    const corners = array<vec2<f32>, 4>(
        vec2<f32>(-1, -1),
        vec2<f32>(1, -1),
        vec2<f32>(-1, 1),
        vec2<f32>(1, 1),
    );
    let screenPosition = corners[in.vertexIndex];

    var out: VertexOut;
    out.position = vec4<f32>(screenPosition, 0.0, 1.0);
    out.worldPosition = (uniforms.invertViewMatrix * out.position).xy;
    out.uv = 0.5 + 0.5 * screenPosition * vec2<f32>(1.0, -1.0);
    return out;
}

struct FragmentOut {
    @location(0) color: vec4<f32>,
};

const cellsGridSizeU = vec2<u32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});
const cellsGridSizeF = vec2<f32>(${this.lightsTexture.gridSize.x}, ${this.lightsTexture.gridSize.y});

fn sampleLightBaseIntensity(lightId: u32, localUv: vec2<f32>) -> f32 {
    let cellIndex = lightId / 4u;
    let indexInCell = lightId % 4u;

    let cellIdU = vec2<u32>(
        cellIndex % cellsGridSizeU.x,
        cellIndex / cellsGridSizeU.x,
    );
    let cellIdF = vec2<f32>(cellIdU);
    let uv = (cellIdF + localUv) / cellsGridSizeF;
    let uvYInverted = vec2<f32>(uv.x, 1.0 - uv.y);
    let sample = textureSampleLevel(lightsTexture, lightsTextureSampler, uvYInverted, 0.0);
    let channel = vec4<f32>(
        vec4<u32>(indexInCell) == vec4<u32>(0u, 1u, 2u, 3u),
    );
    return dot(sample, channel);
}
    
fn compute_lights(worldPosition: vec2<f32>) -> vec3<f32> {
    var color = vec3<f32>(uniforms.ambientLight);

    const maxUvDistance = f32(${1-2/e.lightsTextureProperties.resolutionPerLight});

    let lightsCount = lightsBuffer.count;
    for (var iLight = 0u; iLight < lightsCount; iLight++) {
        let light = lightsBuffer.lights[iLight];
        let lightSize = f32(${e.lightsTextureProperties.resolutionPerLight});
        let relativePosition = (worldPosition - light.position) / lightSize;
        if (max(abs(relativePosition.x), abs(relativePosition.y)) < maxUvDistance) {
            let localUv = 0.5 + 0.5 * relativePosition;    
            let lightIntensity = light.intensity * sampleLightBaseIntensity(iLight, localUv);
            color += lightIntensity * light.color;
        }
    }

    return color;
}

@fragment
fn main_fragment(in: VertexOut) -> FragmentOut {
    let light = compute_lights(in.worldPosition);
    let albedo = textureSample(albedoTexture, albedoSampler, in.uv);
    let color = albedo.rgb * light;

    var out: FragmentOut;
    out.color = vec4<f32>(color, 1.0);
    return out;
}
            `});this.renderPipeline=e.device.createRenderPipeline({label:"LightsRenderer renderpipeline",layout:"auto",vertex:{module:l,entryPoint:"main_vertex"},fragment:{module:l,entryPoint:"main_fragment",targets:[{format:this.targetTexture.format}]},primitive:{cullMode:"none",topology:"triangle-strip"}});let f=this.renderPipeline.getBindGroupLayout(0);this.bindgroup0=e.device.createBindGroup({label:"LightsRenderer bindgroup 0",layout:f,entries:[{binding:0,resource:{buffer:this.uniformsBufferGpu}},{binding:1,resource:{buffer:this.lightsBuffer.gpuBuffer}},{binding:2,resource:this.lightsTexture.texture.createView({label:"LightsRenderer lightsTexture view"})},{binding:3,resource:e.device.createSampler({label:"LightsRenderer sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",magFilter:e.lightsTextureProperties.filtering,minFilter:e.lightsTextureProperties.filtering})}]}),this.bindgroup1=this.buildBindgroup1(e.albedo),this.renderBundle=this.buildRenderBundle()}computeLightsTexture(e){this.lightsTexture.update(e)}render(e,l){let f=new ArrayBuffer(80);new Float32Array(f,0,16).set(l),new Float32Array(f,64,3).set(this.ambientLight),this.device.queue.writeBuffer(this.uniformsBufferGpu,0,f),e.executeBundles([this.renderBundle])}setAlbedo(e){this.bindgroup1=this.buildBindgroup1(e),this.renderBundle=this.buildRenderBundle()}setAmbientLight(e){this.ambientLight=[...e]}setObstacles(e){this.lightsTexture.setObstacles(e)}destroy(){this.uniformsBufferGpu.destroy(),this.lightsTexture.destroy()}buildBindgroup1(e){return this.device.createBindGroup({label:"LightsRenderer bindgroup 1",layout:this.renderPipeline.getBindGroupLayout(1),entries:[{binding:0,resource:e.view},{binding:1,resource:e.sampler}]})}buildRenderBundle(){let e=this.device.createRenderBundleEncoder({label:"LightsRenderer renderbundle encoder",colorFormats:[this.targetTexture.format]});return e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindgroup0),e.setBindGroup(1,this.bindgroup1),e.draw(4),e.finish({label:"LightsRenderer renderbundle"})}};var un={type:"cobalt:light",refs:[{name:"in",type:"textureView",format:"rgba16float",access:"read"},{name:"out",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return Br(t,e)},onRun:function(t,e,l){Dr(t,e,l)},onDestroy:function(t,e){_r(e)},onResize:function(t,e){Gr(t,e)},onViewportPosition:function(t,e){e.data.viewport.setTopLeft(...t.viewport.position)},customFunctions:{...bt}};async function Br(t,e){let{device:l}=t,f=256,v=256,g=new Ue(l,f),T=new at({viewportSize:{width:t.viewport.width,height:t.viewport.height},center:t.viewport.position,zoom:t.viewport.zoom}),U=new ft({device:l,albedo:{view:e.refs.in.data.view,sampler:e.refs.in.data.sampler},targetTexture:e.refs.out.data.texture,lightsBuffer:g,lightsTextureProperties:{resolutionPerLight:v,maxLightSize:v,antialiased:!1,filtering:"nearest"}});return{lightsBuffer:g,lightsBufferNeedsUpdate:!0,lightsTextureNeedsUpdate:!0,lightsRenderer:U,viewport:T,lights:[]}}function Dr(t,e,l){e.data.lightsBufferNeedsUpdate&&(e.data.lightsBuffer.setLights(e.data.lights),e.data.lightsBufferNeedsUpdate=!1,e.data.lightsTextureNeedsUpdate=!0);let f=e.data.lightsRenderer;e.data.lightsTextureNeedsUpdate&&(f.computeLightsTexture(l),e.data.lightsTextureNeedsUpdate=!1);let v=l.beginRenderPass({colorAttachments:[{view:e.refs.out.data.view,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});e.data.viewport.setZoom(t.viewport.zoom);let g=e.data.viewport.invertViewProjectionMatrix;f.render(v,g),v.end()}function _r(t){t.data.lightsBuffer.destroy(),t.data.lightsRenderer.destroy()}function Gr(t,e){e.data.lightsRenderer.setAlbedo({view:e.refs.in.data.view,sampler:e.refs.in.data.sampler}),e.data.viewport.setViewportSize(t.viewport.width,t.viewport.height)}var Tt="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};const positions=array<vec2<f32>,3>(vec2<f32>(-1.0,-3.0),vec2<f32>(3.0,1.0),vec2<f32>(-1.0,1.0));const uvs=array<vec2<f32>,3>(vec2<f32>(0.0,2.0),vec2<f32>(2.0,0.0),vec2<f32>(0.0,0.0));@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@builtin(vertex_index)VertexIndex:u32)->Fragment{var vertexPosition=vec2<f32>(positions[VertexIndex]);var vertexTexCoord=vec2<f32>(uvs[VertexIndex]);var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var Ne=new Float32Array(8),fn={type:"cobalt:tileAtlas",refs:[],onInit:async function(t,e={}){return zr(t,e)},onRun:function(t,e,l){},onDestroy:function(t,e){Er(data)},onResize:function(t,e){ln(t,e)},onViewportPosition:function(t,e){ln(t,e)}};async function zr(t,e){let{device:l}=t,f=await Oe(t,"tile atlas",e.options.textureUrl),v=l.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),g=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),T=l.createBindGroup({layout:g,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:f.view},{binding:2,resource:f.sampler}]}),U=l.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),S=l.createPipelineLayout({bindGroupLayouts:[U,g]});return{pipeline:l.createRenderPipeline({label:"tile",vertex:{module:l.createShaderModule({code:Tt}),entryPoint:"vs_main",buffers:[]},fragment:{module:l.createShaderModule({code:Tt}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:S}),uniformBuffer:v,atlasBindGroup:T,atlasMaterial:f,tileBindGroupLayout:U,tileSize:e.options.tileSize,tileScale:e.options.tileScale}}function Er(t){t.atlasMaterial.texture.destroy(),t.atlasMaterial.texture=void 0}function ln(t,e){Ne[0]=t.viewport.position[0],Ne[1]=t.viewport.position[1];let l=e.data,{tileScale:f,tileSize:v}=l,g=t.viewport.width/t.viewport.zoom,T=t.viewport.height/t.viewport.zoom;Ne[2]=g/f,Ne[3]=T/f,Ne[4]=1/l.atlasMaterial.texture.width,Ne[5]=1/l.atlasMaterial.texture.height,Ne[6]=v,Ne[7]=1/v,t.device.queue.writeBuffer(l.uniformBuffer,0,Ne,0,8)}function pt(t){let l=Object.keys(t.frames).length,f=new Float32Array(l*30),v=[],g={},T=0;for(let U in t.frames){let S=t.frames[U];v.push(U),g[U]=S.sourceSize;let z=-.5+S.spriteSourceSize.x/S.sourceSize.w,B=-.5+S.spriteSourceSize.y/S.sourceSize.h,L=-.5+(S.spriteSourceSize.x+S.spriteSourceSize.w)/S.sourceSize.w,O=-.5+(S.spriteSourceSize.y+S.spriteSourceSize.h)/S.sourceSize.h,A=[z,B,0],C=[z,O,0],E=[L,O,0],K=[L,B,0],J=0+S.frame.x/t.meta.size.w,Y=0+S.frame.y/t.meta.size.h,ne=0+(S.frame.x+S.frame.w)/t.meta.size.w,be=0+(S.frame.y+S.frame.h)/t.meta.size.h,oe=[J,Y],pe=[J,be],de=[ne,be],me=[ne,Y];f.set(A,T),f.set(oe,T+3),f.set(C,T+5),f.set(pe,T+8),f.set(E,T+10),f.set(de,T+13),f.set(A,T+15),f.set(oe,T+18),f.set(E,T+20),f.set(de,T+23),f.set(K,T+25),f.set(me,T+28),T+=30}return{spriteMeta:g,locations:v,vertices:f}}var Mt="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var pn=Ce.create(0,0,0),mn={type:"cobalt:spritesheet",refs:[],onInit:async function(t,e={}){return Ir(t,e)},onRun:function(t,e,l){},onDestroy:function(t,e){Fr(e)},onResize:function(t,e){dn(t,e)},onViewportPosition:function(t,e){dn(t,e)}};async function Ir(t,e){let{canvas:l,device:f}=t,v,g,T;l?(v=await Rr(e.options.spriteSheetJsonUrl),v=pt(v),g=await Oe(t,"sprite",e.options.colorTextureUrl,"rgba8unorm"),T=await Oe(t,"emissive sprite",e.options.emissiveTextureUrl,"rgba8unorm"),l.style.imageRendering="pixelated"):(v=pt(e.options.spriteSheetJson),g=await $e(t,"sprite",e.options.colorTexture,"rgba8unorm"),T=await $e(t,"emissive sprite",e.options.emissiveTexture,"rgba8unorm"));let U=xt(f,v),S=f.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),z=f.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),B=f.createPipelineLayout({bindGroupLayouts:[z]});return{pipeline:f.createRenderPipeline({label:"sprite",vertex:{module:f.createShaderModule({code:Mt}),entryPoint:"vs_main",buffers:[U.bufferLayout]},fragment:{module:f.createShaderModule({code:Mt}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:B}),uniformBuffer:S,quads:U,colorTexture:g,emissiveTexture:T,bindGroupLayout:z,spritesheet:v}}function Fr(t){t.data.quads.buffer.destroy(),t.data.colorTexture.buffer.destroy(),t.data.uniformBuffer.destroy(),t.data.emissiveTexture.texture.destroy()}async function Rr(t){return(await fetch(t)).json()}function dn(t,e){let{device:l,viewport:f}=t,v=f.width/f.zoom,g=f.height/f.zoom,T=H.ortho(0,v,g,0,-10,10);Ce.set(-f.position[0],-f.position[1],0,pn);let U=H.translation(pn);l.queue.writeBuffer(e.data.uniformBuffer,0,U.buffer),l.queue.writeBuffer(e.data.uniformBuffer,64,T.buffer)}var gn={type:"fbTexture",refs:[],onInit:async function(t,e={}){return Ar(t,e)},onRun:function(t,e,l){},onDestroy:function(t,e){hn(data)},onResize:function(t,e){Vr(t,e)},onViewportPosition:function(t,e){}};async function Ar(t,e){let{device:l}=t,{label:f,mip_count:v,format:g,usage:T,viewportScale:U}=e.options;return Se(l,f,t.viewport.width*U,t.viewport.height*U,v,g,T)}function hn(t){t.data.texture.destroy()}function Vr(t,e){let{device:l}=t;hn(e);let{width:f,height:v}=t.viewport,{options:g}=e,T=e.options.viewportScale;e.data=Se(l,g.label,f*T,v*T,g.mip_count,g.format,g.usage)}async function ls(t,e,l){let f,v,g,T;return t.sdlWindow&&t.gpu?(v=t.gpu,f=await(await v.create(["verbose=1"]).requestAdapter()).requestDevice(),g=v.renderGPUDeviceToWindow({device:f,window:t.sdlWindow}),global.GPUBufferUsage=v.GPUBufferUsage,global.GPUShaderStage=v.GPUShaderStage,global.GPUTextureUsage=v.GPUTextureUsage):(T=t,f=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),v=navigator.gpu,g=T.getContext("webgpu"),g.configure({device:f,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{"cobalt:tileAtlas":fn,"cobalt:spritesheet":mn,"cobalt:fbTexture":gn,"cobalt:bloom":Et,"cobalt:composite":Ft,"cobalt:sprite":Vt,"cobalt:tile":Ct,"cobalt:displacement":Kt,"cobalt:overlay":tn,"cobalt:fbBlit":nn,"cobalt:primitives":cn,"cobalt:light":un},nodes:[],defaultTextureViewRefs:[],canvas:T,device:f,context:g,gpu:v,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:e,height:l,zoom:1,position:[0,0]}}}function fs(t,e){if(!e?.type)throw new Error("Can't define a new node missing a type.");t.nodeDefs[e.type]=e}async function ps(t,e){let l=t.nodeDefs[e?.type];if(!l)throw new Error("Can't initialize a new node missing a type.");let f={type:e.type,refs:e.refs||{},options:e.options||{},data:{},enabled:!0};for(let g in f.refs)f.refs[g]==="FRAME_TEXTURE_VIEW"&&(t.defaultTextureViewRefs.push({node:f,refName:g}),f.refs[g]=xn(t));f.data=await l.onInit(t,f);let v=l.customFunctions||{};for(let g in v)f[g]=function(...T){return v[g](t,f,...T)};return t.nodes.push(f),f}function ds(t){let{device:e,context:l}=t,f=e.createCommandEncoder(),v=xn(t);for(let g of t.defaultTextureViewRefs)g.node.refs[g.refName]=v;for(let g of t.nodes){if(!g.enabled)continue;t.nodeDefs[g.type].onRun(t,g,f)}e.queue.submit([f.finish()]),t.canvas||t.context.swap()}function ms(t){for(let e of t.nodes)t.nodeDefs[e.type].onDestroy(t,e);t.nodes.length=0,t.defaultTextureViewRefs.length=0}function gs(t,e,l){t.viewport.width=e,t.viewport.height=l;for(let f of t.nodes)t.nodeDefs[f.type].onResize(t,f)}function hs(t,e){t.viewport.position[0]=e[0]-t.viewport.width/2/t.viewport.zoom,t.viewport.position[1]=e[1]-t.viewport.height/2/t.viewport.zoom;for(let l of t.nodes)t.nodeDefs[l.type].onViewportPosition(t,l)}function Rt(t){return t.canvas?navigator.gpu.getPreferredCanvasFormat():t.context.getPreferredFormat()}function xn(t){return t.canvas?t.context.getCurrentTexture().createView():t.context.getCurrentTextureView()}export{Se as createTexture,$e as createTextureFromBuffer,Oe as createTextureFromUrl,fs as defineNode,ds as draw,xn as getCurrentTextureView,Rt as getPreferredFormat,ls as init,ps as initNode,ms as reset,gs as setViewportDimensions,hs as setViewportPosition};

var jt=Object.defineProperty;var Qt=(t,e)=>{for(var n in e)jt(t,n,{get:e[n],enumerable:!0})};function Q(t,e,n,r,o,i,a){let l=t.createTexture({label:e,size:{width:n,height:r},format:i,usage:a,mipLevelCount:o,sampleCount:1,dimension:"2d"}),c=l.createView(),f=[];for(let s=0;s<o;s++)f.push(l.createView({label:e,format:i,dimension:"2d",aspect:"all",baseMipLevel:s,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}));let u=t.createSampler({label:`${e} sampler`,addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"});return{size:{width:n,height:r},texture:l,view:c,mip_view:f,sampler:u}}async function K(t,e,n,r="rgba8unorm"){let i=await(await fetch(n)).blob(),a=await createImageBitmap(i),l=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,f=Q(t.device,e,a.width,a.height,1,r,l);t.device.queue.copyExternalImageToTexture({source:a},{texture:f.texture},{width:a.width,height:a.height});let u={addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1};return f.sampler=t.device.createSampler(u),f}var Fe="const BLOOM_MIP_COUNT:i32=7;const MODE_PREFILTER:u32=0u;const MODE_DOWNSAMPLE:u32=1u;const MODE_UPSAMPLE_FIRST:u32=2u;const MODE_UPSAMPLE:u32=3u;const EPSILON:f32=1.0e-4;struct bloom_param{parameters:vec4<f32>,combine_constant:f32,doop:u32,ferp:u32,}struct mode_lod_param{mode_lod:u32,}@group(0)@binding(0)var output_texture:texture_storage_2d<rgba16float,write>;@group(0)@binding(1)var input_texture:texture_2d<f32>;@group(0)@binding(2)var bloom_texture:texture_2d<f32>;@group(0)@binding(3)var samp:sampler;@group(0)@binding(4)var<uniform> param:bloom_param;@group(0)@binding(5)var<uniform> pc:mode_lod_param;fn QuadraticThreshold(color:vec4<f32>,threshold:f32,curve:vec3<f32>)->vec4<f32>{let brightness=max(max(color.r,color.g),color.b);var rq:f32=clamp(brightness-curve.x,0.0,curve.y);rq=curve.z*(rq*rq);let ret_color=color*max(rq,brightness-threshold)/max(brightness,EPSILON);return ret_color;}fn Prefilter(color:vec4<f32>,uv:vec2<f32>)->vec4<f32>{let clamp_value=20.0;var c=min(vec4<f32>(clamp_value),color);c=QuadraticThreshold(color,param.parameters.x,param.parameters.yzw);return c;}fn DownsampleBox13(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,tex_size:vec2<f32>)->vec3<f32>{let A=textureSampleLevel(tex,samp,uv,lod).rgb;let texel_size=tex_size*0.5;let B=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,-1.0),lod).rgb;let C=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-1.0,1.0),lod).rgb;let D=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,1.0),lod).rgb;let E=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(1.0,-1.0),lod).rgb;let F=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let G=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,0.0),lod).rgb;let H=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,2.0),lod).rgb;let I=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let J=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,2.0),lod).rgb;let K=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(2.0,0.0),lod).rgb;let L=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(-2.0,-2.0),lod).rgb;let M=textureSampleLevel(tex,samp,uv+texel_size*vec2<f32>(0.0,-2.0),lod).rgb;var result:vec3<f32>=vec3<f32>(0.0);result=result+(B+C+D+E)*0.5;result=result+(F+G+A+M)*0.125;result=result+(G+H+I+A)*0.125;result=result+(A+I+J+K)*0.125;result=result+(M+A+K+L)*0.125;result=result*0.25;return result;}fn UpsampleTent9(tex:texture_2d<f32>,lod:f32,uv:vec2<f32>,texel_size:vec2<f32>,radius:f32)->vec3<f32>{let offset=texel_size.xyxy*vec4<f32>(1.0,1.0,-1.0,0.0)*radius;var result:vec3<f32>=textureSampleLevel(tex,samp,uv,lod).rgb*4.0;result=result+textureSampleLevel(tex,samp,uv-offset.xy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv-offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv-offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.zw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xw,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.zy,lod).rgb;result=result+textureSampleLevel(tex,samp,uv+offset.wy,lod).rgb*2.0;result=result+textureSampleLevel(tex,samp,uv+offset.xy,lod).rgb;return result*(1.0/16.0);}fn combine(ex_color:vec3<f32>,color_to_add:vec3<f32>,combine_constant:f32)->vec3<f32>{let existing_color=ex_color+(-color_to_add);let blended_color=(combine_constant*existing_color)+color_to_add;return blended_color;}@compute @workgroup_size(8,4,1)fn cs_main(@builtin(global_invocation_id)global_invocation_id:vec3<u32>){let mode=pc.mode_lod>>16u;let lod=pc.mode_lod&65535u;let imgSize=textureDimensions(output_texture);if(global_invocation_id.x<=u32(imgSize.x)&&global_invocation_id.y<=u32(imgSize.y)){var texCoords:vec2<f32>=vec2<f32>(f32(global_invocation_id.x)/f32(imgSize.x),f32(global_invocation_id.y)/f32(imgSize.y));texCoords=texCoords+(1.0/vec2<f32>(imgSize))*0.5;let texSize=vec2<f32>(textureDimensions(input_texture,i32(lod)));var color:vec4<f32>=vec4<f32>(1.0);if(mode==MODE_PREFILTER){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);color=Prefilter(color,texCoords);}else if(mode==MODE_DOWNSAMPLE){color=vec4<f32>(DownsampleBox13(input_texture,f32(lod),texCoords,1.0/texSize),1.0);}else if(mode==MODE_UPSAMPLE_FIRST){let bloomTexSize=textureDimensions(input_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(input_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}else if(mode==MODE_UPSAMPLE){let bloomTexSize=textureDimensions(bloom_texture,i32(lod)+1);let sampleScale=1.0;let upsampledTexture=UpsampleTent9(bloom_texture,f32(lod)+1.0,texCoords,1.0/vec2<f32>(bloomTexSize),sampleScale);let existing=textureSampleLevel(input_texture,samp,texCoords,f32(lod)).rgb;color=vec4<f32>(combine(existing,upsampledTexture,param.combine_constant),1.0);}textureStore(output_texture,vec2<i32>(global_invocation_id.xy),color);}}";var Z=7,Kt=0,Pe=1,kt=2,De=3,Ae={type:"bloom",refs:[{name:"emissive",type:"textureView",format:"rgba16",access:"read"},{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"readwrite"}],onInit:async function(t,e={}){return Jt(t,e)},onRun:function(t,e,n){dt(t,e.data,n)},onDestroy:function(t,e){Ie(e)},onResize:function(t,e){en(t,e)},onViewportPosition:function(t,e){}};function Jt(t,e){let{device:n}=t,r=t.viewport.width,o=t.viewport.height,i={compute_pipeline:null,bind_group:[],bind_group_layout:[],bind_groups_textures:[]},a=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});i.bind_group_layout.push(a),i.bind_groups_textures.push(Q(n,"bloom downsampler image 0",r/2,o/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),i.bind_groups_textures.push(Q(n,"bloom downsampler image 1",r/2,o/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),i.bind_groups_textures.push(e.refs.bloom.data);let l=n.createPipelineLayout({bindGroupLayouts:i.bind_group_layout}),c=n.createComputePipeline({layout:l,compute:{module:n.createShaderModule({code:Fe}),entryPoint:"cs_main"}});return $e(t,i,e),i.compute_pipeline=c,i}function $e(t,e,n){let{refs:r}=n,{device:o}=t,i=n.options.bloom_threshold??.1,a=n.options.bloom_knee??.2,l=n.options.bloom_combine_constant??.68,c=new Float32Array([i,i-a,a*2,.25/a,l,0,0,0]),f=o.createBuffer({label:"bloom static parameters buffer",size:c.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(f.getMappedRange()).set(c),f.unmap(),e.bind_group.length=0,e.params_buf=f,e.bind_group.push(ee(o,e,e.bind_groups_textures[0].mip_view[0],r.emissive.data.view,r.hdr.data.view,r.hdr.data.sampler,f,Kt<<16|0));for(let s=1;s<Z;s++)e.bind_group.push(ee(o,e,e.bind_groups_textures[1].mip_view[s],e.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,f,Pe<<16|s-1)),e.bind_group.push(ee(o,e,e.bind_groups_textures[0].mip_view[s],e.bind_groups_textures[1].view,r.hdr.data.view,r.hdr.data.sampler,f,Pe<<16|s));e.bind_group.push(ee(o,e,e.bind_groups_textures[2].mip_view[Z-1],e.bind_groups_textures[0].view,r.hdr.data.view,r.hdr.data.sampler,f,kt<<16|Z-2));let u=!0;for(let s=Z-2;s>=0;s--)u?(e.bind_group.push(ee(o,e,e.bind_groups_textures[1].mip_view[s],e.bind_groups_textures[0].view,e.bind_groups_textures[2].view,r.hdr.data.sampler,f,De<<16|s)),u=!1):(e.bind_group.push(ee(o,e,e.bind_groups_textures[2].mip_view[s],e.bind_groups_textures[0].view,e.bind_groups_textures[1].view,r.hdr.data.sampler,f,De<<16|s)),u=!0)}function ee(t,e,n,r,o,i,a,l){let c=new Uint32Array([l]),f=t.createBuffer({label:"bloom static mode_lod buffer",size:c.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return new Uint32Array(f.getMappedRange()).set(c),f.unmap(),t.createBindGroup({label:"bloom bind group layout",layout:e.bind_group_layout[0],entries:[{binding:0,resource:n},{binding:1,resource:r},{binding:2,resource:o},{binding:3,resource:i},{binding:4,resource:{buffer:a}},{binding:5,resource:{buffer:f}}]})}function dt(t,e,n){let l=0,c=n.beginComputePass({label:"bloom Compute Pass"});c.setPipeline(e.compute_pipeline),c.setBindGroup(0,e.bind_group[l]),l+=1;let f=me(0,e.bind_groups_textures[0]);c.dispatchWorkgroups(f.width/8+1,f.height/4+1,1);for(let u=1;u<Z;u++)f=me(u,e.bind_groups_textures[0]),c.setBindGroup(0,e.bind_group[l]),l+=1,c.dispatchWorkgroups(f.width/8+1,f.height/4+1,1),c.setBindGroup(0,e.bind_group[l]),l+=1,c.dispatchWorkgroups(f.width/8+1,f.height/4+1,1);c.setBindGroup(0,e.bind_group[l]),l+=1,f=me(Z-1,e.bind_groups_textures[2]),c.dispatchWorkgroups(f.width/8+1,f.height/4+1,1);for(let u=Z-2;u>=0;u--)f=me(u,e.bind_groups_textures[2]),c.setBindGroup(0,e.bind_group[l]),l+=1,c.dispatchWorkgroups(f.width/8+1,f.height/4+1,1);c.end()}function me(t,e){let n=e.size.width,r=e.size.height;for(let o=0;o<t;o++)n/=2,r/=2;return{width:n,height:r,depthOrArrayLayers:1}}function en(t,e){let{device:n}=t,r=e.data;Ie(r),r.bind_groups_textures.push(Q(n,"bloom downsampler image 0",t.viewport.width/2,t.viewport.height/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(Q(n,"bloom downsampler image 1",t.viewport.width/2,t.viewport.height/2,Z,"rgba16float",GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING)),r.bind_groups_textures.push(e.refs.bloom.data),$e(t,r,e)}function Ie(t){for(let e of t.bind_groups_textures)e.texture.destroy();t.bind_groups_textures.length=0}var ve="struct BloomComposite{bloom_intensity:f32,bloom_combine_constant:f32,}@group(0)@binding(0)var mySampler:sampler;@group(0)@binding(1)var colorTexture:texture_2d<f32>;@group(0)@binding(2)var emissiveTexture:texture_2d<f32>;@group(0)@binding(3)var<uniform> composite_parameter:BloomComposite;struct VertexOutput{@builtin(position)Position:vec4<f32>,@location(0)fragUV:vec2<f32>,}@vertex fn vert_main(@builtin(vertex_index)VertexIndex:u32)->VertexOutput{const pos=array(vec2(1.0,1.0),vec2(1.0,-1.0),vec2(-1.0,-1.0),vec2(1.0,1.0),vec2(-1.0,-1.0),vec2(-1.0,1.0),);const uv=array(vec2(1.0,0.0),vec2(1.0,1.0),vec2(0.0,1.0),vec2(1.0,0.0),vec2(0.0,1.0),vec2(0.0,0.0),);var output:VertexOutput;output.Position=vec4(pos[VertexIndex],0.0,1.0);output.fragUV=uv[VertexIndex];return output;}fn GTTonemap_point(x:f32)->f32{let m:f32=0.22;let a:f32=1.0;let c:f32=1.33;let P:f32=1.0;let l:f32=0.4;let l0:f32=((P-m)*l)/a;let S0:f32=m+l0;let S1:f32=m+a*l0;let C2:f32=(a*P)/(P-S1);let L:f32=m+a*(x-m);let T:f32=m*pow(x/m,c);let S:f32=P-(P-S1)*exp(-C2*(x-S0)/P);let w0:f32=1.0-smoothstep(0.0,m,x);var w2:f32=1.0;if(x<m+l){w2=0.0;}let w1:f32=1.0-w0-w2;return f32(T*w0+L*w1+S*w2);}fn GTTonemap(x:vec3<f32>)->vec3<f32>{return vec3<f32>(GTTonemap_point(x.r),GTTonemap_point(x.g),GTTonemap_point(x.b));}fn aces(x:vec3<f32>)->vec3<f32>{let a:f32=2.51;let b:f32=0.03;let c:f32=2.43;let d:f32=0.59;let e:f32=0.14;return clamp((x*(a*x+b))/(x*(c*x+d)+e),vec3<f32>(0.0),vec3<f32>(1.0));}@fragment fn frag_main(@location(0)fragUV:vec2<f32>)->@location(0)vec4<f32>{let hdr_color=textureSample(colorTexture,mySampler,fragUV);let bloom_color=textureSample(emissiveTexture,mySampler,fragUV);let combined_color=((bloom_color*composite_parameter.bloom_intensity)*composite_parameter.bloom_combine_constant);let mapped_color=GTTonemap(combined_color.rgb);let gamma_corrected_color=pow(mapped_color,vec3<f32>(1.0/2.2));return vec4<f32>(gamma_corrected_color+hdr_color.rgb,1.0);}";var Re={type:"bloom",refs:[{name:"hdr",type:"textureView",format:"rgba16",access:"read"},{name:"bloom",type:"textureView",format:"rgba16",access:"read"},{name:"combined",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return nn(t,e)},onRun:function(t,e,n){rn(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){on(t,e)},onViewportPosition:function(t,e){}};function nn(t,e){let{options:n,refs:r}=e,{device:o}=t,i=Oe(t),a=n.bloom_intensity??40,l=n.bloom_combine_constant??.68,c=new Float32Array([a,l]),f=o.createBuffer({label:"scene composite params buffer",size:c.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(f.getMappedRange()).set(c),f.unmap();let u=o.createRenderPipeline({layout:"auto",vertex:{module:o.createShaderModule({code:ve}),entryPoint:"vert_main"},fragment:{module:o.createShaderModule({code:ve}),entryPoint:"frag_main",targets:[{format:i}]},primitive:{topology:"triangle-list"}});return{bindGroup:o.createBindGroup({layout:u.getBindGroupLayout(0),entries:[{binding:0,resource:r.hdr.data.sampler},{binding:1,resource:r.hdr.data.view},{binding:2,resource:r.bloom.data.mip_view[0]},{binding:3,resource:{buffer:f}}]}),pipeline:u,params_buf:f}}function rn(t,e,n){let r=n.beginRenderPass({colorAttachments:[{view:e.refs.combined.data.view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]}),{pipeline:o,bindGroup:i}=e.data;r.setPipeline(o),r.setBindGroup(0,i),r.draw(6,1,0,0),r.end()}function on(t,e){let{pipeline:n,params_buf:r}=e.data,{device:o}=t;e.data.bindGroup=o.createBindGroup({layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:e.refs.hdr.data.sampler},{binding:1,resource:e.refs.hdr.data.view},{binding:2,resource:e.refs.bloom.data.mip_view[0]},{binding:3,resource:{buffer:r}}]})}var ne={};Qt(ne,{addSprite:()=>cn,removeSprite:()=>un,setSprite:()=>xn,setSpriteName:()=>fn,setSpriteOpacity:()=>pn,setSpritePosition:()=>ln,setSpriteRotation:()=>mn,setSpriteTint:()=>sn});function ge(t,e,n){if(n.spriteCount===0)return 0;let r=0,o=n.spriteCount-1,i=t<<16&16711680|e&65535;for(;r<=o;){let a=n.spriteData[r*12+11];if(i<=a)return r;let l=n.spriteData[o*12+11];if(i>=l)return o+1;let c=Math.floor((r+o)/2),f=n.spriteData[c*12+11];if(i===f)return c+1;i>f?r=c+1:o=c-1}return r}function te(){return Math.ceil(Math.random()*(Number.MAX_SAFE_INTEGER-10))}function cn(t,e,n,r,o,i,a,l,c){let f=e.refs.spritesheet.data.spritesheet;e=e.data;let u=f.locations.indexOf(n),s=ge(c,u,e),p=(s+1)*12;e.spriteData.set(e.spriteData.subarray(s*12,e.spriteCount*12),p),Le(e,f,s,n,r,o,i,a,l,c);for(let[m,y]of e.spriteIndices)y>=s&&e.spriteIndices.set(m,y+1);let v=te();return e.spriteIndices.set(v,s),e.spriteCount++,e.dirty=!0,v}function un(t,e,n){e=e.data;let r=e.spriteIndices.get(n);for(let[i,a]of e.spriteIndices)a>r&&e.spriteIndices.set(i,a-1);let o=r*12;e.spriteData.set(e.spriteData.subarray((r+1)*12,e.spriteCount*12),o),e.spriteIndices.delete(n),e.spriteCount--,e.dirty=!0}function fn(t,e,n,r,o){let i=e.refs.spritesheet.data.spritesheet;e=e.data;let a=i.locations.indexOf(r),l=i.spriteMeta[r].w,c=i.spriteMeta[r].h,u=e.spriteIndices.get(n)*12;e.spriteData[u+2]=l*o[0],e.spriteData[u+3]=c*o[1];let p=(e.spriteData[u+11]>>16&255)<<16&16711680|a&65535;e.spriteData[u+11]=p,e.dirty=!0}function ln(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i]=r[0],e.spriteData[i+1]=r[1],e.dirty=!0}function sn(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i+4]=r[0],e.spriteData[i+5]=r[1],e.spriteData[i+6]=r[2],e.spriteData[i+7]=r[3],e.dirty=!0}function pn(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i+8]=r,e.dirty=!0}function mn(t,e,n,r){e=e.data;let i=e.spriteIndices.get(n)*12;e.spriteData[i+9]=r,e.dirty=!0}function xn(t,e,n,r,o,i,a,l,c,f){let u=e.refs.spritesheet.data.spritesheet;e=e.data;let s=e.spriteIndices.get(n);Le(e,u,s,r,o,i,a,l,c,f),e.dirty=!0}function Le(t,e,n,r,o,i,a,l,c,f){if(!e.spriteMeta[r])throw new Error(`Sprite name ${r} could not be found in the spritesheet metaData`);let u=n*12,s=e.spriteMeta[r].w,p=e.spriteMeta[r].h,v=e.locations.indexOf(r),m=f<<16&16711680|v&65535;t.spriteData[u]=o[0],t.spriteData[u+1]=o[1],t.spriteData[u+2]=s*i[0],t.spriteData[u+3]=p*i[1],t.spriteData[u+4]=a[0],t.spriteData[u+5]=a[1],t.spriteData[u+6]=a[2],t.spriteData[u+7]=a[3],t.spriteData[u+8]=l,t.spriteData[u+9]=c,t.spriteData[u+11]=m}var Ve={type:"sprite",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"hdr",type:"textureView",format:"rgba16float",access:"write"},{name:"emissive",type:"textureView",format:"rgba16float",access:"write"}],onInit:async function(t,e={}){return vn(t,e)},onRun:function(t,e,n){gn(t,e,n)},onDestroy:function(t,e){wn(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{...ne}};async function vn(t,e){let{device:n}=t,r=16192,o=r,a=Float32Array.BYTES_PER_ELEMENT*2,c=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*4,p=Float32Array.BYTES_PER_ELEMENT*4,v=n.createBuffer({size:(a+c+u+p)*o,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),m=e.refs.spritesheet.data,y=n.createBindGroup({layout:e.refs.spritesheet.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:m.uniformBuffer}},{binding:1,resource:m.colorTexture.view},{binding:2,resource:m.colorTexture.sampler},{binding:3,resource:{buffer:v}},{binding:4,resource:m.emissiveTexture.view}]});return{instancedDrawCalls:new Uint32Array(r*2),instancedDrawCallCount:0,bindGroup:y,spriteBuffer:v,spriteData:new Float32Array(r*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function gn(t,e,n){let{device:r}=t,o=e.options.loadOp||"load";e.data.dirty&&(yn(e.data),e.data.dirty=!1),r.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:o,storeOp:"store"},{view:e.refs.emissive.data.view,clearValue:t.clearValue,loadOp:"clear",storeOp:"store"}]});i.setPipeline(e.refs.spritesheet.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let a=6,l=0;for(let c=0;c<e.data.instancedDrawCallCount;c++){let f=e.data.instancedDrawCalls[c*2]*a,u=e.data.instancedDrawCalls[c*2+1];i.draw(a,u,f,l),l+=u}i.end()}function yn(t){let e=-1,n=0;t.instancedDrawCallCount=0;for(let r=0;r<t.spriteCount;r++){let o=t.spriteData[r*12+11]&65535;o!==e&&(n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++),e=o,n=0),n++}n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++)}function wn(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var Ne={type:"tile",refs:[{name:"tileAtlas",type:"textureView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return hn(t,e)},onRun:function(t,e,n){bn(t,e,n)},onDestroy:function(t,e){qe(e)},onResize:function(t,e){},onViewportPosition:function(t,e){},customFunctions:{setTexture:async function(t,e,n){let{device:r}=t;qe(e),e.options.textureUrl=n;let o=await K(t,"tile map",e.options.textureUrl),i=r.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]});e.data.bindGroup=i,e.data.material=o}}};async function hn(t,e){let{device:n}=t,r=await K(t,"tile map",e.options.textureUrl),o=new Float32Array([e.options.scrollScale,e.options.scrollScale]),i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,a={size:o.byteLength,usage:i,mappedAtCreation:!0},l=n.createBuffer(a);return new Float32Array(l.getMappedRange()).set(o),l.unmap(),{bindGroup:n.createBindGroup({layout:e.refs.tileAtlas.data.tileBindGroupLayout,entries:[{binding:0,resource:{buffer:l}},{binding:1,resource:r.view},{binding:2,resource:r.sampler}]}),material:r,uniformBuffer:l,scrollScale:e.options.scrollScale}}function bn(t,e,n){let{device:r}=t,o=e.options.loadOp||"load",i=n.beginRenderPass({colorAttachments:[{view:e.refs.hdr.data.view,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]}),a=e.refs.tileAtlas.data;i.setPipeline(a.pipeline),i.setVertexBuffer(0,a.quad.buffer),i.setBindGroup(0,e.data.bindGroup),i.setBindGroup(1,a.atlasBindGroup),i.draw(6,1,0,0),i.end()}function qe(t){t.data.material.texture.destroy(),t.data.material.texture=void 0}var ye="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct displacement_param{offset:vec2<f32>,scale:f32,noop:f32};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var mapTexture:texture_2d<f32>;@binding(4)@group(0)var<uniform> param:displacement_param;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const sx:f32=1.0;const sy:f32=1.0;const sz:f32=1.0;const tx:f32=1.0;const ty:f32=1.0;const tz:f32=0;const rot:f32=0.0;const s=sin(rot);const c=cos(rot);const scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);const modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>)->Fragment{var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.TexCoord=vec2<f32>((output.Position.xy+1.0)/2.0);output.TexCoord.y=1.0-output.TexCoord.y;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{let dims=vec2<f32>(textureDimensions(mapTexture,0));let inv=param.offset/dims;var map:vec4<f32>=textureSample(mapTexture,mySampler,TexCoord+inv);let scale=param.scale;map-=0.5;let invTexSize=1/dims;map.x=scale*invTexSize.x*map.x;map.y=scale*invTexSize.y*map.y;var clamped:vec2<f32>=vec2<f32>(TexCoord.x+map.x,TexCoord.y+map.y);clamped=clamp(clamped,vec2<f32>(0,0),vec2<f32>(1,1));let outColor:vec4<f32>=textureSample(myTexture,mySampler,clamped);return outColor;}";var T=1e-6;var M=Float32Array;function Mn(t){let e=M;return M=t,e}function Ye(t=0,e=0){let n=new M(2);return t!==void 0&&(n[0]=t,e!==void 0&&(n[1]=e)),n}var h=Float32Array;function Tn(t){let e=h;return h=t,e}function Y(t,e,n){let r=new h(3);return t!==void 0&&(r[0]=t,e!==void 0&&(r[1]=e,n!==void 0&&(r[2]=n))),r}var En=Ye;function zn(t,e,n){return n=n||new M(2),n[0]=t,n[1]=e,n}function Cn(t,e){return e=e||new M(2),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function Gn(t,e){return e=e||new M(2),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function Bn(t,e){return e=e||new M(2),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function Un(t,e=0,n=1,r){return r=r||new M(2),r[0]=Math.min(n,Math.max(e,t[0])),r[1]=Math.min(n,Math.max(e,t[1])),r}function Fn(t,e,n){return n=n||new M(2),n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function Pn(t,e,n,r){return r=r||new M(2),r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r}function Dn(t,e){let n=t[0],r=t[1],o=t[0],i=t[1],a=Math.sqrt(n*n+r*r),l=Math.sqrt(o*o+i*i),c=a*l,f=c&&je(t,e)/c;return Math.acos(f)}function Xe(t,e,n){return n=n||new M(2),n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}var An=Xe;function $n(t,e){return Math.abs(t[0]-e[0])<T&&Math.abs(t[1]-e[1])<T}function In(t,e){return t[0]===e[0]&&t[1]===e[1]}function Rn(t,e,n,r){return r=r||new M(2),r[0]=t[0]+n*(e[0]-t[0]),r[1]=t[1]+n*(e[1]-t[1]),r}function On(t,e,n,r){return r=r||new M(2),r[0]=t[0]+n[0]*(e[0]-t[0]),r[1]=t[1]+n[1]*(e[1]-t[1]),r}function Ln(t,e,n){return n=n||new M(2),n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n}function Vn(t,e,n){return n=n||new M(2),n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n}function We(t,e,n){return n=n||new M(2),n[0]=t[0]*e,n[1]=t[1]*e,n}var qn=We;function Nn(t,e,n){return n=n||new M(2),n[0]=t[0]/e,n[1]=t[1]/e,n}function He(t,e){return e=e||new M(2),e[0]=1/t[0],e[1]=1/t[1],e}var Yn=He;function Xn(t,e,n){n=n||new h(3);let r=t[0]*e[1]-t[1]*e[0];return n[0]=0,n[1]=0,n[2]=r,n}function je(t,e){return t[0]*e[0]+t[1]*e[1]}function Qe(t){let e=t[0],n=t[1];return Math.sqrt(e*e+n*n)}var Wn=Qe;function Ze(t){let e=t[0],n=t[1];return e*e+n*n}var Hn=Ze;function Ke(t,e){let n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)}var jn=Ke;function ke(t,e){let n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}var Qn=ke;function Zn(t,e){e=e||new M(2);let n=t[0],r=t[1],o=Math.sqrt(n*n+r*r);return o>1e-5?(e[0]=n/o,e[1]=r/o):(e[0]=0,e[1]=0),e}function Kn(t,e){return e=e||new M(2),e[0]=-t[0],e[1]=-t[1],e}function Je(t,e){return e=e||new M(2),e[0]=t[0],e[1]=t[1],e}var kn=Je;function de(t,e,n){return n=n||new M(2),n[0]=t[0]*e[0],n[1]=t[1]*e[1],n}var Jn=de;function et(t,e,n){return n=n||new M(2),n[0]=t[0]/e[0],n[1]=t[1]/e[1],n}var dn=et;function er(t=1,e){e=e||new M(2);let n=Math.random()*2*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e}function tr(t){return t=t||new M(2),t[0]=0,t[1]=0,t}function nr(t,e,n){n=n||new M(2);let r=t[0],o=t[1];return n[0]=r*e[0]+o*e[4]+e[12],n[1]=r*e[1]+o*e[5]+e[13],n}function rr(t,e,n){n=n||new M(2);let r=t[0],o=t[1];return n[0]=e[0]*r+e[4]*o+e[8],n[1]=e[1]*r+e[5]*o+e[9],n}var xe=Object.freeze({__proto__:null,create:Ye,setDefaultType:Mn,fromValues:En,set:zn,ceil:Cn,floor:Gn,round:Bn,clamp:Un,add:Fn,addScaled:Pn,angle:Dn,subtract:Xe,sub:An,equalsApproximately:$n,equals:In,lerp:Rn,lerpV:On,max:Ln,min:Vn,mulScalar:We,scale:qn,divScalar:Nn,inverse:He,invert:Yn,cross:Xn,dot:je,length:Qe,len:Wn,lengthSq:Ze,lenSq:Hn,distance:Ke,dist:jn,distanceSq:ke,distSq:Qn,normalize:Zn,negate:Kn,copy:Je,clone:kn,multiply:de,mul:Jn,divide:et,div:dn,random:er,zero:tr,transformMat4:nr,transformMat3:rr});var or=new Map([[Float32Array,()=>new Float32Array(12)],[Float64Array,()=>new Float64Array(12)],[Array,()=>new Array(12).fill(0)]]),ia=or.get(Float32Array);var ir=Y;function ar(t,e,n,r){return r=r||new h(3),r[0]=t,r[1]=e,r[2]=n,r}function cr(t,e){return e=e||new h(3),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function ur(t,e){return e=e||new h(3),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function fr(t,e){return e=e||new h(3),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function lr(t,e=0,n=1,r){return r=r||new h(3),r[0]=Math.min(n,Math.max(e,t[0])),r[1]=Math.min(n,Math.max(e,t[1])),r[2]=Math.min(n,Math.max(e,t[2])),r}function sr(t,e,n){return n=n||new h(3),n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function pr(t,e,n,r){return r=r||new h(3),r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r}function mr(t,e){let n=t[0],r=t[1],o=t[2],i=t[0],a=t[1],l=t[2],c=Math.sqrt(n*n+r*r+o*o),f=Math.sqrt(i*i+a*a+l*l),u=c*f,s=u&&rt(t,e)/u;return Math.acos(s)}function re(t,e,n){return n=n||new h(3),n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}var xr=re;function vr(t,e){return Math.abs(t[0]-e[0])<T&&Math.abs(t[1]-e[1])<T&&Math.abs(t[2]-e[2])<T}function gr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function yr(t,e,n,r){return r=r||new h(3),r[0]=t[0]+n*(e[0]-t[0]),r[1]=t[1]+n*(e[1]-t[1]),r[2]=t[2]+n*(e[2]-t[2]),r}function wr(t,e,n,r){return r=r||new h(3),r[0]=t[0]+n[0]*(e[0]-t[0]),r[1]=t[1]+n[1]*(e[1]-t[1]),r[2]=t[2]+n[2]*(e[2]-t[2]),r}function hr(t,e,n){return n=n||new h(3),n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n[2]=Math.max(t[2],e[2]),n}function br(t,e,n){return n=n||new h(3),n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n[2]=Math.min(t[2],e[2]),n}function tt(t,e,n){return n=n||new h(3),n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n}var _r=tt;function Sr(t,e,n){return n=n||new h(3),n[0]=t[0]/e,n[1]=t[1]/e,n[2]=t[2]/e,n}function nt(t,e){return e=e||new h(3),e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}var Mr=nt;function d(t,e,n){n=n||new h(3);let r=t[2]*e[0]-t[0]*e[2],o=t[0]*e[1]-t[1]*e[0];return n[0]=t[1]*e[2]-t[2]*e[1],n[1]=r,n[2]=o,n}function rt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ot(t){let e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}var Tr=ot;function it(t){let e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}var Er=it;function at(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2];return Math.sqrt(n*n+r*r+o*o)}var zr=at;function ct(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2];return n*n+r*r+o*o}var Cr=ct;function k(t,e){e=e||new h(3);let n=t[0],r=t[1],o=t[2],i=Math.sqrt(n*n+r*r+o*o);return i>1e-5?(e[0]=n/i,e[1]=r/i,e[2]=o/i):(e[0]=0,e[1]=0,e[2]=0),e}function Gr(t,e){return e=e||new h(3),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function ut(t,e){return e=e||new h(3),e[0]=t[0],e[1]=t[1],e[2]=t[2],e}var Br=ut;function ft(t,e,n){return n=n||new h(3),n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n}var Ur=ft;function lt(t,e,n){return n=n||new h(3),n[0]=t[0]/e[0],n[1]=t[1]/e[1],n[2]=t[2]/e[2],n}var Fr=lt;function Pr(t=1,e){e=e||new h(3);let n=Math.random()*2*Math.PI,r=Math.random()*2-1,o=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(n)*o,e[1]=Math.sin(n)*o,e[2]=r*t,e}function Dr(t){return t=t||new h(3),t[0]=0,t[1]=0,t[2]=0,t}function Ar(t,e,n){n=n||new h(3);let r=t[0],o=t[1],i=t[2],a=e[3]*r+e[7]*o+e[11]*i+e[15]||1;return n[0]=(e[0]*r+e[4]*o+e[8]*i+e[12])/a,n[1]=(e[1]*r+e[5]*o+e[9]*i+e[13])/a,n[2]=(e[2]*r+e[6]*o+e[10]*i+e[14])/a,n}function $r(t,e,n){n=n||new h(3);let r=t[0],o=t[1],i=t[2];return n[0]=r*e[0*4+0]+o*e[1*4+0]+i*e[2*4+0],n[1]=r*e[0*4+1]+o*e[1*4+1]+i*e[2*4+1],n[2]=r*e[0*4+2]+o*e[1*4+2]+i*e[2*4+2],n}function Ir(t,e,n){n=n||new h(3);let r=t[0],o=t[1],i=t[2];return n[0]=r*e[0]+o*e[4]+i*e[8],n[1]=r*e[1]+o*e[5]+i*e[9],n[2]=r*e[2]+o*e[6]+i*e[10],n}function Rr(t,e,n){n=n||new h(3);let r=e[0],o=e[1],i=e[2],a=e[3]*2,l=t[0],c=t[1],f=t[2],u=o*f-i*c,s=i*l-r*f,p=r*c-o*l;return n[0]=l+u*a+(o*p-i*s)*2,n[1]=c+s*a+(i*u-r*p)*2,n[2]=f+p*a+(r*s-o*u)*2,n}function Or(t,e){return e=e||new h(3),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Lr(t,e,n){n=n||new h(3);let r=e*4;return n[0]=t[r+0],n[1]=t[r+1],n[2]=t[r+2],n}function Vr(t,e){e=e||new h(3);let n=t[0],r=t[1],o=t[2],i=t[4],a=t[5],l=t[6],c=t[8],f=t[9],u=t[10];return e[0]=Math.sqrt(n*n+r*r+o*o),e[1]=Math.sqrt(i*i+a*a+l*l),e[2]=Math.sqrt(c*c+f*f+u*u),e}var H=Object.freeze({__proto__:null,create:Y,setDefaultType:Tn,fromValues:ir,set:ar,ceil:cr,floor:ur,round:fr,clamp:lr,add:sr,addScaled:pr,angle:mr,subtract:re,sub:xr,equalsApproximately:vr,equals:gr,lerp:yr,lerpV:wr,max:hr,min:br,mulScalar:tt,scale:_r,divScalar:Sr,inverse:nt,invert:Mr,cross:d,dot:rt,length:ot,len:Tr,lengthSq:it,lenSq:Er,distance:at,dist:zr,distanceSq:ct,distSq:Cr,normalize:k,negate:Gr,copy:ut,clone:Br,multiply:ft,mul:Ur,divide:lt,div:Fr,random:Pr,zero:Dr,transformMat4:Ar,transformMat4Upper3x3:$r,transformMat3:Ir,transformQuat:Rr,getTranslation:Or,getAxis:Lr,getScaling:Vr}),b=Float32Array;function qr(t){let e=b;return b=t,e}function Nr(t,e,n,r,o,i,a,l,c,f,u,s,p,v,m,y){let x=new b(16);return t!==void 0&&(x[0]=t,e!==void 0&&(x[1]=e,n!==void 0&&(x[2]=n,r!==void 0&&(x[3]=r,o!==void 0&&(x[4]=o,i!==void 0&&(x[5]=i,a!==void 0&&(x[6]=a,l!==void 0&&(x[7]=l,c!==void 0&&(x[8]=c,f!==void 0&&(x[9]=f,u!==void 0&&(x[10]=u,s!==void 0&&(x[11]=s,p!==void 0&&(x[12]=p,v!==void 0&&(x[13]=v,m!==void 0&&(x[14]=m,y!==void 0&&(x[15]=y)))))))))))))))),x}function Yr(t,e,n,r,o,i,a,l,c,f,u,s,p,v,m,y,x){return x=x||new b(16),x[0]=t,x[1]=e,x[2]=n,x[3]=r,x[4]=o,x[5]=i,x[6]=a,x[7]=l,x[8]=c,x[9]=f,x[10]=u,x[11]=s,x[12]=p,x[13]=v,x[14]=m,x[15]=y,x}function Xr(t,e){return e=e||new b(16),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Wr(t,e){e=e||new b(16);let n=t[0],r=t[1],o=t[2],i=t[3],a=n+n,l=r+r,c=o+o,f=n*a,u=r*a,s=r*l,p=o*a,v=o*l,m=o*c,y=i*a,x=i*l,g=i*c;return e[0]=1-s-m,e[1]=u+g,e[2]=p-x,e[3]=0,e[4]=u-g,e[5]=1-f-m,e[6]=v+y,e[7]=0,e[8]=p+x,e[9]=v-y,e[10]=1-f-s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Hr(t,e){return e=e||new b(16),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function we(t,e){return e=e||new b(16),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}var jr=we;function Qr(t,e){return Math.abs(t[0]-e[0])<T&&Math.abs(t[1]-e[1])<T&&Math.abs(t[2]-e[2])<T&&Math.abs(t[3]-e[3])<T&&Math.abs(t[4]-e[4])<T&&Math.abs(t[5]-e[5])<T&&Math.abs(t[6]-e[6])<T&&Math.abs(t[7]-e[7])<T&&Math.abs(t[8]-e[8])<T&&Math.abs(t[9]-e[9])<T&&Math.abs(t[10]-e[10])<T&&Math.abs(t[11]-e[11])<T&&Math.abs(t[12]-e[12])<T&&Math.abs(t[13]-e[13])<T&&Math.abs(t[14]-e[14])<T&&Math.abs(t[15]-e[15])<T}function Zr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function st(t){return t=t||new b(16),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Kr(t,e){if(e=e||new b(16),e===t){let w;return w=t[1],t[1]=t[4],t[4]=w,w=t[2],t[2]=t[8],t[8]=w,w=t[3],t[3]=t[12],t[12]=w,w=t[6],t[6]=t[9],t[9]=w,w=t[7],t[7]=t[13],t[13]=w,w=t[11],t[11]=t[14],t[14]=w,e}let n=t[0*4+0],r=t[0*4+1],o=t[0*4+2],i=t[0*4+3],a=t[1*4+0],l=t[1*4+1],c=t[1*4+2],f=t[1*4+3],u=t[2*4+0],s=t[2*4+1],p=t[2*4+2],v=t[2*4+3],m=t[3*4+0],y=t[3*4+1],x=t[3*4+2],g=t[3*4+3];return e[0]=n,e[1]=a,e[2]=u,e[3]=m,e[4]=r,e[5]=l,e[6]=s,e[7]=y,e[8]=o,e[9]=c,e[10]=p,e[11]=x,e[12]=i,e[13]=f,e[14]=v,e[15]=g,e}function pt(t,e){e=e||new b(16);let n=t[0*4+0],r=t[0*4+1],o=t[0*4+2],i=t[0*4+3],a=t[1*4+0],l=t[1*4+1],c=t[1*4+2],f=t[1*4+3],u=t[2*4+0],s=t[2*4+1],p=t[2*4+2],v=t[2*4+3],m=t[3*4+0],y=t[3*4+1],x=t[3*4+2],g=t[3*4+3],w=p*g,z=x*v,C=c*g,G=x*f,U=c*v,F=p*f,D=o*g,A=x*i,$=o*v,I=p*i,R=o*f,L=c*i,V=u*y,q=m*s,N=a*y,X=m*l,W=a*s,ae=u*l,ce=n*y,ue=m*r,fe=n*s,le=u*r,se=n*l,pe=a*r,Ce=w*l+G*s+U*y-(z*l+C*s+F*y),Ge=z*r+D*s+I*y-(w*r+A*s+$*y),Be=C*r+A*l+R*y-(G*r+D*l+L*y),Ue=F*r+$*l+L*s-(U*r+I*l+R*s),O=1/(n*Ce+a*Ge+u*Be+m*Ue);return e[0]=O*Ce,e[1]=O*Ge,e[2]=O*Be,e[3]=O*Ue,e[4]=O*(z*a+C*u+F*m-(w*a+G*u+U*m)),e[5]=O*(w*n+A*u+$*m-(z*n+D*u+I*m)),e[6]=O*(G*n+D*a+L*m-(C*n+A*a+R*m)),e[7]=O*(U*n+I*a+R*u-(F*n+$*a+L*u)),e[8]=O*(V*f+X*v+W*g-(q*f+N*v+ae*g)),e[9]=O*(q*i+ce*v+le*g-(V*i+ue*v+fe*g)),e[10]=O*(N*i+ue*f+se*g-(X*i+ce*f+pe*g)),e[11]=O*(ae*i+fe*f+pe*v-(W*i+le*f+se*v)),e[12]=O*(N*p+ae*x+q*c-(W*x+V*c+X*p)),e[13]=O*(fe*x+V*o+ue*p-(ce*p+le*x+q*o)),e[14]=O*(ce*c+pe*x+X*o-(se*x+N*o+ue*c)),e[15]=O*(se*p+W*o+le*c-(fe*c+pe*p+ae*o)),e}function kr(t){let e=t[0],n=t[0*4+1],r=t[0*4+2],o=t[0*4+3],i=t[1*4+0],a=t[1*4+1],l=t[1*4+2],c=t[1*4+3],f=t[2*4+0],u=t[2*4+1],s=t[2*4+2],p=t[2*4+3],v=t[3*4+0],m=t[3*4+1],y=t[3*4+2],x=t[3*4+3],g=s*x,w=y*p,z=l*x,C=y*c,G=l*p,U=s*c,F=r*x,D=y*o,A=r*p,$=s*o,I=r*c,R=l*o,L=g*a+C*u+G*m-(w*a+z*u+U*m),V=w*n+F*u+$*m-(g*n+D*u+A*m),q=z*n+D*a+I*m-(C*n+F*a+R*m),N=U*n+A*a+R*u-(G*n+$*a+I*u);return e*L+i*V+f*q+v*N}var Jr=pt;function mt(t,e,n){n=n||new b(16);let r=t[0],o=t[1],i=t[2],a=t[3],l=t[4],c=t[5],f=t[6],u=t[7],s=t[8],p=t[9],v=t[10],m=t[11],y=t[12],x=t[13],g=t[14],w=t[15],z=e[0],C=e[1],G=e[2],U=e[3],F=e[4],D=e[5],A=e[6],$=e[7],I=e[8],R=e[9],L=e[10],V=e[11],q=e[12],N=e[13],X=e[14],W=e[15];return n[0]=r*z+l*C+s*G+y*U,n[1]=o*z+c*C+p*G+x*U,n[2]=i*z+f*C+v*G+g*U,n[3]=a*z+u*C+m*G+w*U,n[4]=r*F+l*D+s*A+y*$,n[5]=o*F+c*D+p*A+x*$,n[6]=i*F+f*D+v*A+g*$,n[7]=a*F+u*D+m*A+w*$,n[8]=r*I+l*R+s*L+y*V,n[9]=o*I+c*R+p*L+x*V,n[10]=i*I+f*R+v*L+g*V,n[11]=a*I+u*R+m*L+w*V,n[12]=r*q+l*N+s*X+y*W,n[13]=o*q+c*N+p*X+x*W,n[14]=i*q+f*N+v*X+g*W,n[15]=a*q+u*N+m*X+w*W,n}var dr=mt;function eo(t,e,n){return n=n||st(),t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11]),n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function to(t,e){return e=e||Y(),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function no(t,e,n){n=n||Y();let r=e*4;return n[0]=t[r+0],n[1]=t[r+1],n[2]=t[r+2],n}function ro(t,e,n,r){r!==t&&(r=we(t,r));let o=n*4;return r[o+0]=e[0],r[o+1]=e[1],r[o+2]=e[2],r}function oo(t,e){e=e||Y();let n=t[0],r=t[1],o=t[2],i=t[4],a=t[5],l=t[6],c=t[8],f=t[9],u=t[10];return e[0]=Math.sqrt(n*n+r*r+o*o),e[1]=Math.sqrt(i*i+a*a+l*l),e[2]=Math.sqrt(c*c+f*f+u*u),e}function io(t,e,n,r,o){o=o||new b(16);let i=Math.tan(Math.PI*.5-.5*t);if(o[0]=i/e,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,r===1/0)o[10]=-1,o[14]=-n;else{let a=1/(n-r);o[10]=r*a,o[14]=r*n*a}return o}function ao(t,e,n,r,o,i,a){return a=a||new b(16),a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(r-n),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1/(o-i),a[11]=0,a[12]=(e+t)/(t-e),a[13]=(r+n)/(n-r),a[14]=o/(o-i),a[15]=1,a}function co(t,e,n,r,o,i,a){a=a||new b(16);let l=e-t,c=r-n,f=o-i;return a[0]=2*o/l,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o/c,a[6]=0,a[7]=0,a[8]=(t+e)/l,a[9]=(r+n)/c,a[10]=i/f,a[11]=-1,a[12]=0,a[13]=0,a[14]=o*i/f,a[15]=0,a}var S,B,_;function uo(t,e,n,r){return r=r||new b(16),S=S||Y(),B=B||Y(),_=_||Y(),k(re(e,t,_),_),k(d(n,_,S),S),k(d(_,S,B),B),r[0]=S[0],r[1]=S[1],r[2]=S[2],r[3]=0,r[4]=B[0],r[5]=B[1],r[6]=B[2],r[7]=0,r[8]=_[0],r[9]=_[1],r[10]=_[2],r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function fo(t,e,n,r){return r=r||new b(16),S=S||Y(),B=B||Y(),_=_||Y(),k(re(t,e,_),_),k(d(n,_,S),S),k(d(_,S,B),B),r[0]=S[0],r[1]=S[1],r[2]=S[2],r[3]=0,r[4]=B[0],r[5]=B[1],r[6]=B[2],r[7]=0,r[8]=_[0],r[9]=_[1],r[10]=_[2],r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function lo(t,e,n,r){return r=r||new b(16),S=S||Y(),B=B||Y(),_=_||Y(),k(re(t,e,_),_),k(d(n,_,S),S),k(d(_,S,B),B),r[0]=S[0],r[1]=B[0],r[2]=_[0],r[3]=0,r[4]=S[1],r[5]=B[1],r[6]=_[1],r[7]=0,r[8]=S[2],r[9]=B[2],r[10]=_[2],r[11]=0,r[12]=-(S[0]*t[0]+S[1]*t[1]+S[2]*t[2]),r[13]=-(B[0]*t[0]+B[1]*t[1]+B[2]*t[2]),r[14]=-(_[0]*t[0]+_[1]*t[1]+_[2]*t[2]),r[15]=1,r}function so(t,e){return e=e||new b(16),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function po(t,e,n){n=n||new b(16);let r=e[0],o=e[1],i=e[2],a=t[0],l=t[1],c=t[2],f=t[3],u=t[1*4+0],s=t[1*4+1],p=t[1*4+2],v=t[1*4+3],m=t[2*4+0],y=t[2*4+1],x=t[2*4+2],g=t[2*4+3],w=t[3*4+0],z=t[3*4+1],C=t[3*4+2],G=t[3*4+3];return t!==n&&(n[0]=a,n[1]=l,n[2]=c,n[3]=f,n[4]=u,n[5]=s,n[6]=p,n[7]=v,n[8]=m,n[9]=y,n[10]=x,n[11]=g),n[12]=a*r+u*o+m*i+w,n[13]=l*r+s*o+y*i+z,n[14]=c*r+p*o+x*i+C,n[15]=f*r+v*o+g*i+G,n}function mo(t,e){e=e||new b(16);let n=Math.cos(t),r=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function xo(t,e,n){n=n||new b(16);let r=t[4],o=t[5],i=t[6],a=t[7],l=t[8],c=t[9],f=t[10],u=t[11],s=Math.cos(e),p=Math.sin(e);return n[4]=s*r+p*l,n[5]=s*o+p*c,n[6]=s*i+p*f,n[7]=s*a+p*u,n[8]=s*l-p*r,n[9]=s*c-p*o,n[10]=s*f-p*i,n[11]=s*u-p*a,t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function vo(t,e){e=e||new b(16);let n=Math.cos(t),r=Math.sin(t);return e[0]=n,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function go(t,e,n){n=n||new b(16);let r=t[0*4+0],o=t[0*4+1],i=t[0*4+2],a=t[0*4+3],l=t[2*4+0],c=t[2*4+1],f=t[2*4+2],u=t[2*4+3],s=Math.cos(e),p=Math.sin(e);return n[0]=s*r-p*l,n[1]=s*o-p*c,n[2]=s*i-p*f,n[3]=s*a-p*u,n[8]=s*l+p*r,n[9]=s*c+p*o,n[10]=s*f+p*i,n[11]=s*u+p*a,t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function yo(t,e){e=e||new b(16);let n=Math.cos(t),r=Math.sin(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function wo(t,e,n){n=n||new b(16);let r=t[0*4+0],o=t[0*4+1],i=t[0*4+2],a=t[0*4+3],l=t[1*4+0],c=t[1*4+1],f=t[1*4+2],u=t[1*4+3],s=Math.cos(e),p=Math.sin(e);return n[0]=s*r+p*l,n[1]=s*o+p*c,n[2]=s*i+p*f,n[3]=s*a+p*u,n[4]=s*l-p*r,n[5]=s*c-p*o,n[6]=s*f-p*i,n[7]=s*u-p*a,t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function xt(t,e,n){n=n||new b(16);let r=t[0],o=t[1],i=t[2],a=Math.sqrt(r*r+o*o+i*i);r/=a,o/=a,i/=a;let l=r*r,c=o*o,f=i*i,u=Math.cos(e),s=Math.sin(e),p=1-u;return n[0]=l+(1-l)*u,n[1]=r*o*p+i*s,n[2]=r*i*p-o*s,n[3]=0,n[4]=r*o*p-i*s,n[5]=c+(1-c)*u,n[6]=o*i*p+r*s,n[7]=0,n[8]=r*i*p+o*s,n[9]=o*i*p-r*s,n[10]=f+(1-f)*u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}var ho=xt;function vt(t,e,n,r){r=r||new b(16);let o=e[0],i=e[1],a=e[2],l=Math.sqrt(o*o+i*i+a*a);o/=l,i/=l,a/=l;let c=o*o,f=i*i,u=a*a,s=Math.cos(n),p=Math.sin(n),v=1-s,m=c+(1-c)*s,y=o*i*v+a*p,x=o*a*v-i*p,g=o*i*v-a*p,w=f+(1-f)*s,z=i*a*v+o*p,C=o*a*v+i*p,G=i*a*v-o*p,U=u+(1-u)*s,F=t[0],D=t[1],A=t[2],$=t[3],I=t[4],R=t[5],L=t[6],V=t[7],q=t[8],N=t[9],X=t[10],W=t[11];return r[0]=m*F+y*I+x*q,r[1]=m*D+y*R+x*N,r[2]=m*A+y*L+x*X,r[3]=m*$+y*V+x*W,r[4]=g*F+w*I+z*q,r[5]=g*D+w*R+z*N,r[6]=g*A+w*L+z*X,r[7]=g*$+w*V+z*W,r[8]=C*F+G*I+U*q,r[9]=C*D+G*R+U*N,r[10]=C*A+G*L+U*X,r[11]=C*$+G*V+U*W,t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}var bo=vt;function _o(t,e){return e=e||new b(16),e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function So(t,e,n){n=n||new b(16);let r=e[0],o=e[1],i=e[2];return n[0]=r*t[0*4+0],n[1]=r*t[0*4+1],n[2]=r*t[0*4+2],n[3]=r*t[0*4+3],n[4]=o*t[1*4+0],n[5]=o*t[1*4+1],n[6]=o*t[1*4+2],n[7]=o*t[1*4+3],n[8]=i*t[2*4+0],n[9]=i*t[2*4+1],n[10]=i*t[2*4+2],n[11]=i*t[2*4+3],t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}function Mo(t,e){return e=e||new b(16),e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function To(t,e,n){return n=n||new b(16),n[0]=e*t[0*4+0],n[1]=e*t[0*4+1],n[2]=e*t[0*4+2],n[3]=e*t[0*4+3],n[4]=e*t[1*4+0],n[5]=e*t[1*4+1],n[6]=e*t[1*4+2],n[7]=e*t[1*4+3],n[8]=e*t[2*4+0],n[9]=e*t[2*4+1],n[10]=e*t[2*4+2],n[11]=e*t[2*4+3],t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}var j=Object.freeze({__proto__:null,setDefaultType:qr,create:Nr,set:Yr,fromMat3:Xr,fromQuat:Wr,negate:Hr,copy:we,clone:jr,equalsApproximately:Qr,equals:Zr,identity:st,transpose:Kr,inverse:pt,determinant:kr,invert:Jr,multiply:mt,mul:dr,setTranslation:eo,getTranslation:to,getAxis:no,setAxis:ro,getScaling:oo,perspective:io,ortho:ao,frustum:co,aim:uo,cameraAim:fo,lookAt:lo,translation:so,translate:po,rotationX:mo,rotateX:xo,rotationY:vo,rotateY:go,rotationZ:yo,rotateZ:wo,axisRotation:xt,rotation:ho,axisRotate:vt,rotate:bo,scaling:_o,scale:So,uniformScaling:Mo,uniformScale:To});var E=Float32Array;function Eo(t){let e=E;return E=t,e}function gt(t,e,n,r){let o=new E(4);return t!==void 0&&(o[0]=t,e!==void 0&&(o[1]=e,n!==void 0&&(o[2]=n,r!==void 0&&(o[3]=r)))),o}var zo=gt;function Co(t,e,n,r,o){return o=o||new E(4),o[0]=t,o[1]=e,o[2]=n,o[3]=r,o}function Go(t,e){return e=e||new E(4),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function Bo(t,e){return e=e||new E(4),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function Uo(t,e){return e=e||new E(4),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function Fo(t,e=0,n=1,r){return r=r||new E(4),r[0]=Math.min(n,Math.max(e,t[0])),r[1]=Math.min(n,Math.max(e,t[1])),r[2]=Math.min(n,Math.max(e,t[2])),r[3]=Math.min(n,Math.max(e,t[3])),r}function Po(t,e,n){return n=n||new E(4),n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n[3]=t[3]+e[3],n}function Do(t,e,n,r){return r=r||new E(4),r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r[3]=t[3]+e[3]*n,r}function yt(t,e,n){return n=n||new E(4),n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n[3]=t[3]-e[3],n}var Ao=yt;function $o(t,e){return Math.abs(t[0]-e[0])<T&&Math.abs(t[1]-e[1])<T&&Math.abs(t[2]-e[2])<T&&Math.abs(t[3]-e[3])<T}function Io(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Ro(t,e,n,r){return r=r||new E(4),r[0]=t[0]+n*(e[0]-t[0]),r[1]=t[1]+n*(e[1]-t[1]),r[2]=t[2]+n*(e[2]-t[2]),r[3]=t[3]+n*(e[3]-t[3]),r}function Oo(t,e,n,r){return r=r||new E(4),r[0]=t[0]+n[0]*(e[0]-t[0]),r[1]=t[1]+n[1]*(e[1]-t[1]),r[2]=t[2]+n[2]*(e[2]-t[2]),r[3]=t[3]+n[3]*(e[3]-t[3]),r}function Lo(t,e,n){return n=n||new E(4),n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n[2]=Math.max(t[2],e[2]),n[3]=Math.max(t[3],e[3]),n}function Vo(t,e,n){return n=n||new E(4),n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n[2]=Math.min(t[2],e[2]),n[3]=Math.min(t[3],e[3]),n}function wt(t,e,n){return n=n||new E(4),n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}var qo=wt;function No(t,e,n){return n=n||new E(4),n[0]=t[0]/e,n[1]=t[1]/e,n[2]=t[2]/e,n[3]=t[3]/e,n}function ht(t,e){return e=e||new E(4),e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}var Yo=ht;function Xo(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function bt(t){let e=t[0],n=t[1],r=t[2],o=t[3];return Math.sqrt(e*e+n*n+r*r+o*o)}var Wo=bt;function _t(t){let e=t[0],n=t[1],r=t[2],o=t[3];return e*e+n*n+r*r+o*o}var Ho=_t;function St(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2],i=t[3]-e[3];return Math.sqrt(n*n+r*r+o*o+i*i)}var jo=St;function Mt(t,e){let n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2],i=t[3]-e[3];return n*n+r*r+o*o+i*i}var Qo=Mt;function Zo(t,e){e=e||new E(4);let n=t[0],r=t[1],o=t[2],i=t[3],a=Math.sqrt(n*n+r*r+o*o+i*i);return a>1e-5?(e[0]=n/a,e[1]=r/a,e[2]=o/a,e[3]=i/a):(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function Ko(t,e){return e=e||new E(4),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function Tt(t,e){return e=e||new E(4),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}var ko=Tt;function Et(t,e,n){return n=n||new E(4),n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n[3]=t[3]*e[3],n}var Jo=Et;function zt(t,e,n){return n=n||new E(4),n[0]=t[0]/e[0],n[1]=t[1]/e[1],n[2]=t[2]/e[2],n[3]=t[3]/e[3],n}var ei=zt;function ti(t){return t=t||new E(4),t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function ni(t,e,n){n=n||new E(4);let r=t[0],o=t[1],i=t[2],a=t[3];return n[0]=e[0]*r+e[4]*o+e[8]*i+e[12]*a,n[1]=e[1]*r+e[5]*o+e[9]*i+e[13]*a,n[2]=e[2]*r+e[6]*o+e[10]*i+e[14]*a,n[3]=e[3]*r+e[7]*o+e[11]*i+e[15]*a,n}var he=Object.freeze({__proto__:null,create:gt,setDefaultType:Eo,fromValues:zo,set:Co,ceil:Go,floor:Bo,round:Uo,clamp:Fo,add:Po,addScaled:Do,subtract:yt,sub:Ao,equalsApproximately:$o,equals:Io,lerp:Ro,lerpV:Oo,max:Lo,min:Vo,mulScalar:wt,scale:qo,divScalar:No,inverse:ht,invert:Yo,dot:Xo,length:bt,len:Wo,lengthSq:_t,lenSq:Ho,distance:St,dist:jo,distanceSq:Mt,distSq:Qo,normalize:Zo,negate:Ko,copy:Tt,clone:ko,multiply:Et,mul:Jo,divide:zt,div:ei,zero:ti,transformMat4:ni});var Ct=H.create(0,0,0),oe=6,Gt={type:"displacement",refs:[{name:"color",type:"textureView",format:"bgra8unorm",access:"read"},{name:"map",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"textureView",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return ri(t,e)},onRun:function(t,e,n){oi(t,e,n)},onDestroy:function(t,e){ii(e)},onResize:function(t,e){ai(t,e)},onViewportPosition:function(t,e){ci(t,e)},customFunctions:{addTriangle:function(t,e,n){let r=te(),o=e.data.spriteCount;e.data.spriteIndices.set(r,o);let i=o*oe;return e.data.spriteData[i]=n[0][0],e.data.spriteData[i+1]=n[0][1],e.data.spriteData[i+2]=n[1][0],e.data.spriteData[i+3]=n[1][1],e.data.spriteData[i+4]=n[2][0],e.data.spriteData[i+5]=n[2][1],e.data.spriteCount++,r},removeTriangle:function(t,e,n){e.data.spriteIndices.delete(n),e.data.spriteCount--},setPosition:function(t,e,n,r){let i=e.data.spriteIndices.get(n)*oe;e.data.spriteData[i]=r[0][0],e.data.spriteData[i+1]=r[0][1],e.data.spriteData[i+2]=r[1][0],e.data.spriteData[i+3]=r[1][1],e.data.spriteData[i+4]=r[2][0],e.data.spriteData[i+5]=r[2][1]}}};async function ri(t,e){let{device:n}=t,r=new Float32Array([e.options.offseyX??0,e.options.offseyY??0,e.options.scale??20,0]),o=n.createBuffer({label:"displacement options buffer",size:r.byteLength,mappedAtCreation:!0,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});new Float32Array(o.getMappedRange()).set(r),o.unmap();let i=256,a=i,c=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*2,p=Float32Array.BYTES_PER_ELEMENT*2,v=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),m=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),y=n.createPipelineLayout({bindGroupLayouts:[m]}),x="repeat",g="linear",w=n.createSampler({label:"displacement ampler",addressModeU:x,addressModeV:x,addressModeW:x,magFilter:g,minFilter:g,mipmapFilter:g}),z=n.createBindGroup({layout:m,entries:[{binding:0,resource:{buffer:v}},{binding:1,resource:e.refs.color.data.view},{binding:2,resource:w},{binding:3,resource:e.refs.map.view},{binding:4,resource:{buffer:o}}]}),C=n.createBuffer({size:i*oe,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),G={arrayStride:8,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},U=n.createRenderPipeline({label:"displacement",vertex:{module:n.createShaderModule({code:ye}),entryPoint:"vs_main",buffers:[G]},fragment:{module:n.createShaderModule({code:ye}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:y});return{bindGroup:z,bindGroupLayout:m,uniformBuffer:v,sampler:w,pipeline:U,params_buf:o,buffer:C,spriteData:new Float32Array(i*oe),spriteCount:0,spriteIndices:new Map}}function oi(t,e,n){if(e.data.spriteCount===0)return;let{device:r}=t,o=oe*e.data.spriteCount*Float32Array.BYTES_PER_ELEMENT;r.queue.writeBuffer(e.data.buffer,0,e.data.spriteData.buffer,0,o);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.data.buffer);let a=e.data.spriteCount*3;i.draw(a,1,0,0),i.end()}function ii(t){t.data.bindGroup=null,t.data.buffer.destroy(),t.data.buffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null,t.data.params_buf.destroy(),t.data.params_buf=null}function ai(t,e){let{device:n}=t;e.data.bindGroup=n.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:{buffer:e.data.uniformBuffer}},{binding:1,resource:e.refs.color.data.view},{binding:2,resource:e.data.sampler},{binding:3,resource:e.refs.map.view},{binding:4,resource:{buffer:e.data.params_buf}}]})}function ci(t,e){let{device:n}=t,r=t.viewport.width/t.viewport.zoom,o=t.viewport.height/t.viewport.zoom,i=j.ortho(0,r,o,0,-10,10);H.set(-t.viewport.position[0],-t.viewport.position[1],0,Ct);let a=j.translation(Ct);n.queue.writeBuffer(e.data.uniformBuffer,0,a.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,i.buffer)}function be(t,e){let n=e.vertices,r=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,o={size:n.byteLength,usage:r,mappedAtCreation:!0},i=t.createBuffer(o);return new Float32Array(i.getMappedRange()).set(n),i.unmap(),{buffer:i,bufferLayout:{arrayStride:20,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var _e="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->@location(0)vec4<f32>{var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);var output=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);return output;}";var Fa=he.create(),Bt=H.create(),Pt={type:"overlay",refs:[{name:"spritesheet",type:"customResource",access:"read"},{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return fi(t,e)},onRun:function(t,e,n){li(t,e,n)},onDestroy:function(t,e){pi(e)},onResize:function(t,e){Ut(t,e)},onViewportPosition:function(t,e){Ut(t,e)},customFunctions:{...ne}};async function fi(t,e){let{device:n}=t,r=16192,o=r,a=Float32Array.BYTES_PER_ELEMENT*2,c=Float32Array.BYTES_PER_ELEMENT*2,u=Float32Array.BYTES_PER_ELEMENT*4,p=Float32Array.BYTES_PER_ELEMENT*4,v=n.createBuffer({size:(a+c+u+p)*o,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),m=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),y=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),x=n.createBindGroup({layout:y,entries:[{binding:0,resource:{buffer:m}},{binding:1,resource:e.refs.spritesheet.data.colorTexture.view},{binding:2,resource:e.refs.spritesheet.data.colorTexture.sampler},{binding:3,resource:{buffer:v}}]}),g=n.createPipelineLayout({bindGroupLayouts:[y]}),w=n.createRenderPipeline({label:"overlay",vertex:{module:n.createShaderModule({code:_e}),entryPoint:"vs_main",buffers:[e.refs.spritesheet.data.quads.bufferLayout]},fragment:{module:n.createShaderModule({code:_e}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:g});return{instancedDrawCalls:new Uint32Array(r*2),instancedDrawCallCount:0,spriteBuffer:v,uniformBuffer:m,pipeline:w,bindGroupLayout:y,bindGroup:x,spriteData:new Float32Array(r*12),spriteCount:0,spriteIndices:new Map,dirty:!1}}function li(t,e,n){let{device:r}=t,o=e.options.loadOp||"load";e.data.dirty&&(si(e.data),e.data.dirty=!1),r.queue.writeBuffer(e.data.spriteBuffer,0,e.data.spriteData.buffer);let i=n.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.refs.spritesheet.data.quads.buffer);let a=6,l=0;for(let c=0;c<e.data.instancedDrawCallCount;c++){let f=e.data.instancedDrawCalls[c*2]*a,u=e.data.instancedDrawCalls[c*2+1];i.draw(a,u,f,l),l+=u}i.end()}function si(t){let e=-1,n=0;t.instancedDrawCallCount=0;for(let r=0;r<t.spriteCount;r++){let o=t.spriteData[r*12+11]&65535;o!==e&&(n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++),e=o,n=0),n++}n>0&&(t.instancedDrawCalls[t.instancedDrawCallCount*2]=e,t.instancedDrawCalls[t.instancedDrawCallCount*2+1]=n,t.instancedDrawCallCount++)}function Ut(t,e){let r=Math.round(t.viewport.width/1),o=Math.round(t.viewport.height/1),i=j.ortho(0,r,o,0,-10,10);H.set(0,0,0,Bt);let a=j.translation(Bt);t.device.queue.writeBuffer(e.data.uniformBuffer,0,a.buffer),t.device.queue.writeBuffer(e.data.uniformBuffer,64,i.buffer)}function pi(t){t.data.instancedDrawCalls=null,t.data.bindGroup=null,t.data.spriteBuffer.destroy(),t.data.spriteBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null,t.data.spriteData=null,t.data.spriteIndices.clear(),t.data.spriteIndices=null}var Se="@binding(0)@group(0)var tileTexture:texture_2d<f32>;@binding(1)@group(0)var tileSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};const pos=array(vec2(1.0,1.0),vec2(1.0,-1.0),vec2(-1.0,-1.0),vec2(1.0,1.0),vec2(-1.0,-1.0),vec2(-1.0,1.0),);const uv=array(vec2(1.0,0.0),vec2(1.0,1.0),vec2(0.0,1.0),vec2(1.0,0.0),vec2(0.0,1.0),vec2(0.0,0.0),);@vertex fn vs_main(@builtin(vertex_index)VertexIndex:u32)->Fragment{var output:Fragment;output.Position=vec4(pos[VertexIndex],0.0,1.0);output.TexCoord=uv[VertexIndex];return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var col=textureSample(tileTexture,tileSampler,TexCoord);return vec4<f32>(col.rgb,1.0);}";var Dt={type:"fbBlit",refs:[{name:"in",type:"cobaltTexture",format:"bgra8unorm",access:"read"},{name:"out",type:"cobaltTexture",format:"bgra8unorm",access:"write"}],onInit:async function(t,e={}){return xi(t,e)},onRun:function(t,e,n){vi(t,e,n)},onDestroy:function(t,e){},onResize:function(t,e){gi(t,e)},onViewportPosition:function(t,e){}};async function xi(t,e){let{device:n}=t,r=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),o=n.createBindGroup({layout:r,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]}),i=n.createPipelineLayout({bindGroupLayouts:[r]}),a=n.createRenderPipeline({label:"fb-blit",vertex:{module:n.createShaderModule({code:Se}),entryPoint:"vs_main",buffers:[]},fragment:{module:n.createShaderModule({code:Se}),entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:i});return{bindGroupLayout:r,bindGroup:o,pipeline:a}}function vi(t,e,n){let{device:r}=t,o=n.beginRenderPass({colorAttachments:[{view:e.refs.out,clearValue:t.clearValue,loadOp:"load",storeOp:"store"}]});o.setPipeline(e.data.pipeline),o.setBindGroup(0,e.data.bindGroup),o.draw(6,1,0,0),o.end()}function gi(t,e){let{device:n}=t;e.data.bindGroup=n.createBindGroup({layout:e.data.bindGroupLayout,entries:[{binding:0,resource:e.refs.in.data.view},{binding:1,resource:e.refs.in.data.sampler}]})}var At="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};@binding(0)@group(0)var<uniform> transformUBO:TransformData;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)Color:vec4<f32>,};@vertex fn vs_main(@location(0)vertexPosition:vec2<f32>,@location(1)vertexColor:vec4<f32>)->Fragment{var sx:f32=1.0;var sy:f32=1.0;var sz:f32=1.0;var rot:f32=0.0;var tx:f32=1.0;var ty:f32=1.0;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;var output:Fragment;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,0.0,1.0);output.Color=vertexColor;return output;}@fragment fn fs_main(@location(0)Color:vec4<f32>)->@location(0)vec4<f32>{return Color;}";function ie(t,e,n,r,o,i=1){let a=xe.sub(r,n),l=xe.normalize(a),c=wi(l),f=i/2,u=e.data.vertexCount*6;e.data.vertices[u+0]=n[0]+c[0]*f,e.data.vertices[u+1]=n[1]+c[1]*f,e.data.vertices[u+2]=o[0],e.data.vertices[u+3]=o[1],e.data.vertices[u+4]=o[2],e.data.vertices[u+5]=o[3],e.data.vertices[u+6]=n[0]-c[0]*f,e.data.vertices[u+7]=n[1]-c[1]*f,e.data.vertices[u+8]=o[0],e.data.vertices[u+9]=o[1],e.data.vertices[u+10]=o[2],e.data.vertices[u+11]=o[3],e.data.vertices[u+12]=r[0]+c[0]*f,e.data.vertices[u+13]=r[1]+c[1]*f,e.data.vertices[u+14]=o[0],e.data.vertices[u+15]=o[1],e.data.vertices[u+16]=o[2],e.data.vertices[u+17]=o[3],e.data.vertices[u+18]=n[0]-c[0]*f,e.data.vertices[u+19]=n[1]-c[1]*f,e.data.vertices[u+20]=o[0],e.data.vertices[u+21]=o[1],e.data.vertices[u+22]=o[2],e.data.vertices[u+23]=o[3],e.data.vertices[u+24]=r[0]+c[0]*f,e.data.vertices[u+25]=r[1]+c[1]*f,e.data.vertices[u+26]=o[0],e.data.vertices[u+27]=o[1],e.data.vertices[u+28]=o[2],e.data.vertices[u+29]=o[3],e.data.vertices[u+30]=r[0]-c[0]*f,e.data.vertices[u+31]=r[1]-c[1]*f,e.data.vertices[u+32]=o[0],e.data.vertices[u+33]=o[1],e.data.vertices[u+34]=o[2],e.data.vertices[u+35]=o[3],e.data.vertexCount+=6,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)}function wi(t){return[-t[1],t[0]]}var $t={line:ie,filledEllipse:function(t,e,n,r,o,i,a){let[l,c]=n,f=2*Math.PI/i;for(let u=0;u<i;u++){let s=u*f,p=(u+1)*f,v=l+r*Math.cos(s),m=c+o*Math.sin(s),y=l+r*Math.cos(p),x=c+o*Math.sin(p),g=e.data.vertexCount*6+u*18;e.data.vertices[g+0]=l,e.data.vertices[g+1]=c,e.data.vertices[g+2]=a[0],e.data.vertices[g+3]=a[1],e.data.vertices[g+4]=a[2],e.data.vertices[g+5]=a[3],e.data.vertices[g+6]=v,e.data.vertices[g+7]=m,e.data.vertices[g+8]=a[0],e.data.vertices[g+9]=a[1],e.data.vertices[g+10]=a[2],e.data.vertices[g+11]=a[3],e.data.vertices[g+12]=y,e.data.vertices[g+13]=x,e.data.vertices[g+14]=a[0],e.data.vertices[g+15]=a[1],e.data.vertices[g+16]=a[2],e.data.vertices[g+17]=a[3]}e.data.vertexCount+=3*i,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)},box:function(t,e,n,r,o,i,a=1){let[l,c]=n,f=r/2,u=o/2,s=[l-f,c-u],p=[l+f,c-u],v=[l-f,c+u],m=[l+f,c+u];ie(t,e,s,p,i,a),ie(t,e,v,m,i,a),ie(t,e,s,v,i,a),ie(t,e,p,m,i,a)},filledBox:function(t,e,n,r,o,i){let[a,l]=n,c=r/2,f=o/2,u={x:a-c,y:l-f},s={x:a+c,y:l-f},p={x:a-c,y:l+f},v={x:a+c,y:l+f},m=e.data.vertexCount*6;e.data.vertices[m+0]=u.x,e.data.vertices[m+1]=u.y,e.data.vertices[m+2]=i[0],e.data.vertices[m+3]=i[1],e.data.vertices[m+4]=i[2],e.data.vertices[m+5]=i[3],e.data.vertices[m+6]=p.x,e.data.vertices[m+7]=p.y,e.data.vertices[m+8]=i[0],e.data.vertices[m+9]=i[1],e.data.vertices[m+10]=i[2],e.data.vertices[m+11]=i[3],e.data.vertices[m+12]=s.x,e.data.vertices[m+13]=s.y,e.data.vertices[m+14]=i[0],e.data.vertices[m+15]=i[1],e.data.vertices[m+16]=i[2],e.data.vertices[m+17]=i[3],e.data.vertices[m+18]=p.x,e.data.vertices[m+19]=p.y,e.data.vertices[m+20]=i[0],e.data.vertices[m+21]=i[1],e.data.vertices[m+22]=i[2],e.data.vertices[m+23]=i[3],e.data.vertices[m+24]=v.x,e.data.vertices[m+25]=v.y,e.data.vertices[m+26]=i[0],e.data.vertices[m+27]=i[1],e.data.vertices[m+28]=i[2],e.data.vertices[m+29]=i[3],e.data.vertices[m+30]=s.x,e.data.vertices[m+31]=s.y,e.data.vertices[m+32]=i[0],e.data.vertices[m+33]=i[1],e.data.vertices[m+34]=i[2],e.data.vertices[m+35]=i[3],e.data.vertexCount+=6,t.device.queue.writeBuffer(e.data.vertexBuffer,0,e.data.vertices.buffer)},clear:function(t,e){e.data.vertexCount=0}};var It=H.create(0,0,0),Ot={type:"primitives",refs:[{name:"color",type:"textView",format:"rgba8unorm",access:"write"}],onInit:async function(t,e={}){return hi(t,e)},onRun:function(t,e,n){bi(t,e,n)},onDestroy:function(t,e){_i(e)},onResize:function(t,e){Rt(t,e)},onViewportPosition:function(t,e){Rt(t,e)},customFunctions:$t};async function hi(t,e){let{device:n}=t,r=new Float32Array(1e4),o=n.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),i=n.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=n.createShaderModule({code:At}),l=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),c=n.createPipelineLayout({bindGroupLayouts:[l]}),f=n.createBindGroup({layout:l,entries:[{binding:0,resource:{buffer:i}}]}),u=n.createRenderPipeline({layout:c,vertex:{module:a,entryPoint:"vs_main",buffers:[{arrayStride:6*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,format:"float32x4",offset:8}]}]},fragment:{module:a,entryPoint:"fs_main",targets:[{format:"bgra8unorm",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"}});return{uniformBuffer:i,vertexBuffer:o,pipeline:u,bindGroup:f,vertexCount:0,vertices:r}}function bi(t,e,n){if(e.data.vertexCount===0)return;let{device:r}=t,o=e.options.loadOp||"load",i=n.beginRenderPass({colorAttachments:[{view:e.refs.color,clearValue:t.clearValue,loadOp:o,storeOp:"store"}]});i.setPipeline(e.data.pipeline),i.setBindGroup(0,e.data.bindGroup),i.setVertexBuffer(0,e.data.vertexBuffer),i.draw(e.data.vertexCount),i.end()}function _i(t){t.data.vertexBuffer.destroy(),t.data.vertexBuffer=null,t.data.uniformBuffer.destroy(),t.data.uniformBuffer=null}function Rt(t,e){let{device:n}=t,r=t.viewport.width/t.viewport.zoom,o=t.viewport.height/t.viewport.zoom,i=j.ortho(0,r,o,0,-10,10);H.set(-t.viewport.position[0],-t.viewport.position[1],0,It);let a=j.translation(It);n.queue.writeBuffer(e.data.uniformBuffer,0,a.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,i.buffer)}function Me(t){let e=new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,-1,0,1,1,1,1,0,-1,1,0,0]),n=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:e.byteLength,usage:n,mappedAtCreation:!0},o=t.createBuffer(r);return new Float32Array(o.getMappedRange()).set(e),o.unmap(),{buffer:o,bufferLayout:{arrayStride:16,attributes:[{shaderLocation:0,format:"float32x2",offset:0},{shaderLocation:1,format:"float32x2",offset:8}]}}}var Te="struct TransformData{viewOffset:vec2<f32>,viewportSize:vec2<f32>,inverseAtlasTextureSize:vec2<f32>,tileSize:f32,inverseTileSize:f32,};struct TileScroll{scrollScale:vec2<f32>};@binding(0)@group(0)var<uniform> myScroll:TileScroll;@binding(1)@group(0)var tileTexture:texture_2d<f32>;@binding(2)@group(0)var tileSampler:sampler;@binding(0)@group(1)var<uniform> transformUBO:TransformData;@binding(1)@group(1)var atlasTexture:texture_2d<f32>;@binding(2)@group(1)var atlasSampler:sampler;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>};@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec2<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;let inverseTileTextureSize=1/vec2<f32>(textureDimensions(tileTexture,0));var scrollScale=myScroll.scrollScale;var viewOffset:vec2<f32>=transformUBO.viewOffset*scrollScale;let PixelCoord=(vertexTexCoord*transformUBO.viewportSize)+viewOffset;output.TexCoord=PixelCoord/transformUBO.tileSize;output.Position=vec4<f32>(vertexPosition,0.0,1.0);return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>)->@location(0)vec4<f32>{var tilemapCoord=floor(TexCoord);var u_tilemapSize=vec2<f32>(textureDimensions(tileTexture,0));var tileFoo=fract((tilemapCoord+vec2<f32>(0.5,0.5))/u_tilemapSize);var tile=floor(textureSample(tileTexture,tileSampler,tileFoo)*255.0);if(tile.x==255&&tile.y==255){discard;}var u_tilesetSize=vec2<f32>(textureDimensions(atlasTexture,0))/transformUBO.tileSize;let u_tileUVMinBounds=vec2<f32>(0.5/transformUBO.tileSize,0.5/transformUBO.tileSize);let u_tileUVMaxBounds=vec2<f32>((transformUBO.tileSize-0.5)/transformUBO.tileSize,(transformUBO.tileSize-0.5)/transformUBO.tileSize);var texcoord=clamp(fract(TexCoord),u_tileUVMinBounds,u_tileUVMaxBounds);var tileCoord=(tile.xy+texcoord)/u_tilesetSize;var color=textureSample(atlasTexture,atlasSampler,tileCoord);if(color.a<=0.1){discard;}return color;}";var J=new Float32Array(8),Vt={type:"tileAtlas",refs:[],onInit:async function(t,e={}){return Mi(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){Ti(data)},onResize:function(t,e){Lt(t,e)},onViewportPosition:function(t,e){Lt(t,e)}};async function Mi(t,e){let{device:n}=t,r=Me(n),o=await K(t,"tile atlas",e.options.textureUrl),i=n.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),l=n.createBindGroup({layout:a,entries:[{binding:0,resource:{buffer:i}},{binding:1,resource:o.view},{binding:2,resource:o.sampler}]}),c=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),f=n.createPipelineLayout({bindGroupLayouts:[c,a]});return{pipeline:n.createRenderPipeline({label:"tile",vertex:{module:n.createShaderModule({code:Te}),entryPoint:"vs_main",buffers:[r.bufferLayout]},fragment:{module:n.createShaderModule({code:Te}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}}]},primitive:{topology:"triangle-list"},layout:f}),uniformBuffer:i,atlasBindGroup:l,atlasMaterial:o,tileBindGroupLayout:c,quad:r,tileSize:e.options.tileSize,tileScale:e.options.tileScale}}function Ti(t){t.atlasMaterial.texture.destroy(),t.atlasMaterial.texture=void 0}function Lt(t,e){J[0]=t.viewport.position[0],J[1]=t.viewport.position[1];let n=e.data,{tileScale:r,tileSize:o}=n,i=t.viewport.width/t.viewport.zoom,a=t.viewport.height/t.viewport.zoom;J[2]=i/r,J[3]=a/r,J[4]=1/n.atlasMaterial.texture.width,J[5]=1/n.atlasMaterial.texture.height,J[6]=o,J[7]=1/o,t.device.queue.writeBuffer(n.uniformBuffer,0,J,0,8)}function Ee(t){let n=Object.keys(t.frames).length,r=new Float32Array(n*30),o=[],i={},a=0;for(let l in t.frames){let c=t.frames[l];o.push(l),i[l]=c.sourceSize;let f=-.5+c.spriteSourceSize.x/c.sourceSize.w,u=-.5+c.spriteSourceSize.y/c.sourceSize.h,s=-.5+(c.spriteSourceSize.x+c.spriteSourceSize.w)/c.sourceSize.w,p=-.5+(c.spriteSourceSize.y+c.spriteSourceSize.h)/c.sourceSize.h,v=[f,u,0],m=[f,p,0],y=[s,p,0],x=[s,u,0],g=0+c.frame.x/t.meta.size.w,w=0+c.frame.y/t.meta.size.h,z=0+(c.frame.x+c.frame.w)/t.meta.size.w,C=0+(c.frame.y+c.frame.h)/t.meta.size.h,G=[g,w],U=[g,C],F=[z,C],D=[z,w];r.set(v,a),r.set(G,a+3),r.set(m,a+5),r.set(U,a+8),r.set(y,a+10),r.set(F,a+13),r.set(v,a+15),r.set(G,a+18),r.set(y,a+20),r.set(F,a+23),r.set(x,a+25),r.set(D,a+28),a+=30}return{spriteMeta:i,locations:o,vertices:r}}var ze="struct TransformData{view:mat4x4<f32>,projection:mat4x4<f32>};struct Sprite{translate:vec2<f32>,scale:vec2<f32>,tint:vec4<f32>,opacity:f32,rotation:f32,emissiveIntensity:f32,sortValue:f32,};struct SpritesBuffer{models:array<Sprite>,};@binding(0)@group(0)var<uniform> transformUBO:TransformData;@binding(1)@group(0)var myTexture:texture_2d<f32>;@binding(2)@group(0)var mySampler:sampler;@binding(3)@group(0)var<storage,read>sprites:SpritesBuffer;@binding(4)@group(0)var emissiveTexture:texture_2d<f32>;struct Fragment{@builtin(position)Position:vec4<f32>,@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32,};struct GBufferOutput{@location(0)color:vec4<f32>,@location(1)emissive:vec4<f32>,}@vertex fn vs_main(@builtin(instance_index)i_id:u32,@location(0)vertexPosition:vec3<f32>,@location(1)vertexTexCoord:vec2<f32>)->Fragment{var output:Fragment;var sx:f32=sprites.models[i_id].scale.x;var sy:f32=sprites.models[i_id].scale.y;var sz:f32=1.0;var rot:f32=sprites.models[i_id].rotation;var tx:f32=sprites.models[i_id].translate.x;var ty:f32=sprites.models[i_id].translate.y;var tz:f32=0;var s=sin(rot);var c=cos(rot);var scaleM:mat4x4<f32>=mat4x4<f32>(sx,0.0,0.0,0.0,0.0,sy,0.0,0.0,0.0,0.0,sz,0.0,0,0,0,1.0);var modelM:mat4x4<f32>=mat4x4<f32>(c,s,0.0,0.0,-s,c,0.0,0.0,0.0,0.0,1.0,0.0,tx,ty,tz,1.0)*scaleM;output.Position=transformUBO.projection*transformUBO.view*modelM*vec4<f32>(vertexPosition,1.0);output.TexCoord=vertexTexCoord;output.Tint=sprites.models[i_id].tint;output.Opacity=sprites.models[i_id].opacity;return output;}@fragment fn fs_main(@location(0)TexCoord:vec2<f32>,@location(1)Tint:vec4<f32>,@location(2)Opacity:f32)->GBufferOutput{var output:GBufferOutput;var outColor:vec4<f32>=textureSample(myTexture,mySampler,TexCoord);output.color=vec4<f32>(outColor.rgb*(1.0-Tint.a)+(Tint.rgb*Tint.a),outColor.a*Opacity);let emissive=textureSample(emissiveTexture,mySampler,TexCoord);output.emissive=vec4(emissive.rgb,1.0)*emissive.a;return output;}";var qt=H.create(0,0,0),Yt={type:"spritesheet",refs:[],onInit:async function(t,e={}){return zi(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){Ci(e)},onResize:function(t,e){Nt(t,e)},onViewportPosition:function(t,e){Nt(t,e)}};async function zi(t,e){let{canvas:n,device:r}=t,o=await Gi(e.options.spriteSheetJsonUrl);o=Ee(o);let i=be(r,o),[a,l]=await Promise.all([K(t,"sprite",e.options.colorTextureUrl,"rgba8unorm"),K(t,"emissive sprite",e.options.emissiveTextureUrl,"rgba8unorm")]);n&&(n.style.imageRendering="pixelated");let c=r.createBuffer({size:64*2,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),u=r.createPipelineLayout({bindGroupLayouts:[f]});return{pipeline:r.createRenderPipeline({label:"sprite",vertex:{module:r.createShaderModule({code:ze}),entryPoint:"vs_main",buffers:[i.bufferLayout]},fragment:{module:r.createShaderModule({code:ze}),entryPoint:"fs_main",targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"zero",dstFactor:"one"}}},{format:"rgba16float"}]},primitive:{topology:"triangle-list"},layout:u}),uniformBuffer:c,quads:i,colorTexture:a,emissiveTexture:l,bindGroupLayout:f,spritesheet:o}}function Ci(t){t.data.quads.buffer.destroy(),t.data.colorTexture.buffer.destroy(),t.data.uniformBuffer.destroy(),t.data.emissiveTexture.texture.destroy()}async function Gi(t){return(await fetch(t)).json()}function Nt(t,e){let{device:n,viewport:r}=t,o=r.width/r.zoom,i=r.height/r.zoom,a=j.ortho(0,o,i,0,-10,10);H.set(-r.position[0],-r.position[1],0,qt);let l=j.translation(qt);n.queue.writeBuffer(e.data.uniformBuffer,0,l.buffer),n.queue.writeBuffer(e.data.uniformBuffer,64,a.buffer)}var Xt={type:"fbTexture",refs:[],onInit:async function(t,e={}){return Bi(t,e)},onRun:function(t,e,n){},onDestroy:function(t,e){Wt(data)},onResize:function(t,e){Ui(t,e)},onViewportPosition:function(t,e){}};async function Bi(t,e){let{device:n}=t,{label:r,mip_count:o,format:i,usage:a,viewportScale:l}=e.options;return Q(n,r,t.viewport.width*l,t.viewport.height*l,o,i,a)}function Wt(t){t.data.texture.destroy()}function Ui(t,e){let{device:n}=t;Wt(e);let{width:r,height:o}=t.viewport,{options:i}=e,a=e.options.viewportScale;e.data=Q(n,i.label,r*a,o*a,i.mip_count,i.format,i.usage)}async function Sc(t,e,n){let r,o,i,a;return t.sdlWindow&&t.gpu?(o=t.gpu,r=await(await o.create(["verbose=1"]).requestAdapter()).requestDevice(),i=o.renderGPUDeviceToWindow({device:r,window:t.sdlWindow}),global.GPUBufferUsage=o.GPUBufferUsage,global.GPUShaderStage=o.GPUShaderStage,global.GPUTextureUsage=o.GPUTextureUsage):(a=t,r=await(await navigator.gpu?.requestAdapter({powerPreference:"high-performance"}))?.requestDevice(),o=navigator.gpu,i=a.getContext("webgpu"),i.configure({device:r,format:navigator.gpu?.getPreferredCanvasFormat(),alphaMode:"opaque"})),{nodeDefs:{tileAtlas:Vt,spritesheet:Yt,fbTexture:Xt,bloom:Ae,composite:Re,sprite:Ve,tile:Ne,displacement:Gt,overlay:Pt,fbBlit:Dt,primitives:Ot},nodes:[],defaultTextureViewRefs:[],canvas:a,device:r,context:i,gpu:o,clearValue:{r:0,g:0,b:0,a:1},viewport:{width:e,height:n,zoom:1,position:[0,0]}}}function Mc(t,e){if(!e?.type)throw new Error("Can't define a new node missing a type.");t.nodeDefs[e.type]=e}async function Tc(t,e){let n=t.nodeDefs[e?.type];if(!n)throw new Error("Can't initialize a new node missing a type.");let r={type:e.type,refs:e.refs||{},options:e.options||{},data:{},enabled:!0};for(let i in r.refs)r.refs[i]==="FRAME_TEXTURE_VIEW"&&(t.defaultTextureViewRefs.push({node:r,refName:i}),r.refs[i]=Ht(t));r.data=await n.onInit(t,r);let o=n.customFunctions||{};for(let i in o)r[i]=function(...a){return o[i](t,r,...a)};return t.nodes.push(r),r}function Ec(t){let{device:e,context:n}=t,r=e.createCommandEncoder(),o=Ht(t);for(let i of t.defaultTextureViewRefs)i.node.refs[i.refName]=o;for(let i of t.nodes){if(!i.enabled)continue;t.nodeDefs[i.type].onRun(t,i,r)}e.queue.submit([r.finish()]),t.canvas||t.context.swap()}function zc(t){for(let e of t.nodes)t.nodeDefs[e.type].onDestroy(t,e);t.nodes.length=0,t.defaultTextureViewRefs.length=0}function Cc(t,e,n){t.viewport.width=e,t.viewport.height=n;for(let r of t.nodes)t.nodeDefs[r.type].onResize(t,r)}function Gc(t,e){t.viewport.position[0]=e[0]-t.viewport.width/2/t.viewport.zoom,t.viewport.position[1]=e[1]-t.viewport.height/2/t.viewport.zoom;for(let n of t.nodes)t.nodeDefs[n.type].onViewportPosition(t,n)}function Oe(t){if(t.canvas)return navigator.gpu.getPreferredCanvasFormat();t.context.getPreferredFormat()}function Ht(t){return t.canvas?t.context.getCurrentTexture().createView():t.context.getCurrentTextureView()}export{Q as createTexture,K as createTextureFromUrl,Mc as defineNode,Ec as draw,Ht as getCurrentTextureView,Oe as getPreferredFormat,Sc as init,Tc as initNode,zc as reset,Cc as setViewportDimensions,Gc as setViewportPosition};
